define("namespace", function() {}), define("lib/EventBase", ["underscore", "backbone"], function(e, t) {
    var n = function() {
        this.initialize.apply(this, arguments)
    };
    return e.extend(n.prototype, {
        initialize: function() {
            this._attributes = {}
        },
        dispose: function() {},
        get: function(e) {
            return this._attributes[e]
        },
        set: function(e, t) {
            this._attributes[e] = t
        },
        has: function(t) {
            return e.has(this._attributes, t)
        }
    }), e.extend(n.prototype, t.Events), n.extend = t.View.extend, n
}), define("scenes/common/ab/Ripple", ["underscore", "jquery", "sprintf", "lib/EventBase", "lib/ab/ABNode", "lib/ab/ABLayer", "lib/ab/CommonAssetsManager", "lib/AnimationCut"], function(e, t, n, r, i, s, o, u) {
    var a = "ripple",
        f = {
            STAGE: "stage",
            LIB_RIPPLE: "lib_ripple"
        },
        l = {
            SHOW: "SHOW",
            TEST: "TEST"
        },
        c = r.extend({
            initialize: function() {
                this._isReady = !1, this._enabled = !0, this._disposed = !1, this._tid = void 0
            },
            dispose: function(e) {
                this._assetsManager && !e && this._assetsManager.destroyAllLayer(), this._assetsManager = void 0, this._layer = void 0, this._ab && this._ab.ripple && this._ab.ripple.deleteNode().process(), this._ab = void 0, this._autoFire && this.stopListening(), this._tid !== void 0 && (clearTimeout(this._tid), this._tid = void 0)
            },
            prepareDeferred: function(n, r, i) {
                var s = this,
                    u = t.Deferred();
                i = e.isNumber(i) ? i : 1e3;
                if (this._isReady) return u.resolve().promise();
                if (!n) return u.reject().promise();
                this._assetsManager = new o;
                var f = {};
                f[a] = n;
                var l = function() {
                    s._assetsManager.populateAssetsDeferred(f).then(function() {
                        s._initView(), r && s.setAutoFire(), u.resolve()
                    }, function() {
                        s._tid = setTimeout(function() {
                            s._tid = void 0, l()
                        }, i)
                    })
                };
                return l(), u.promise()
            },
            isReady: function() {
                return this._isReady
            },
            show: function(e, t) {
                if (!this._canShowRipple()) return;
                this._show(e, t)
            },
            _canShowRipple: function() {
                return this._isReady && this._enabled && !u.isDisabled()
            },
            setAutoFire: function() {
                var e = this;
                this._autoFire = !0, this.listenTo(FF.eventNotifier, "app:onTapScreen", function(t) {
                    var n = t.touches[t.touches.length - 1];
                    e.show(n.pageX, n.pageY)
                }), this.listenTo(FF.eventNotifier, "ab:onTapScreen", function(t) {
                    e.show(t.screenX, t.screenY)
                }), this.listenTo(FF.eventNotifier, "abnodebutton:onTouchBegan", function(t, n) {
                    e.show(t.screenX, t.screenY)
                })
            },
            setZOrder: function(e) {
                if (!this._layer) return;
                this._layer.setZOrder(e).process()
            },
            setEnabled: function(e) {
                this._enabled = e
            },
            _initView: function() {
                this._ab = {};
                var e = this._assetsManager.getAssetInfo(a);
                this._layer = new s({
                    layerName: e.layerName,
                    assetPath: e.assetPath
                }), this._layer.activate(), this._ab.stage = new i({
                    name: f.STAGE,
                    layer: this._layer.layerName
                }), this._ab.ripple = (new i({
                    name: n("ripple_dup"),
                    layer: this._layer.layerName,
                    duplicateFrom: f.LIB_RIPPLE,
                    duplicateFromOptions: {
                        visualParentLayer: this._layer.layerName,
                        visualParentNode: this._ab.stage.name
                    }
                })).setVisible(!1).process(), this._isReady = !0
            },
            _show: function(e, t) {
                if (!this._ab || !this._ab.ripple) return;
                this._ab.ripple.setPosition([e, t]).setVisible(!0).play(l.SHOW).process()
            }
        }, {
            canShowRippleByUserDevice: function() {
                return FF.env.isIOS() || FF.env.isAndroidVersionGreaterThanOrEqualTo(4, 0)
            }
        });
    return c
}), define("scenes/common/ab/consts/ABLayerDepths", [], function() {
    var e = {
        RIPPLE_ENABLED: 5e3,
        RIPPLE_DISABLED: -1e3,
        DUNGEON_WARP: 6e3
    };
    return e
}), define("scenes/common/views/ModalRetry", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalRetry"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-retry]": "onClickRetry",
            "anchorsbeforejump [data-app-modal-btn-reload]": "onClickReload"
        },
        overlayStayOnEnd: !0,
        render: function(e) {
            this.renderContent(i, {
                error: e
            })
        },
        onClickRetry: function() {
            this._triggerEvents("onClickRetry"), this.end(this.overlayStayOnEnd)
        },
        onClickReload: function() {
            FF.router.loading.show(), location.hash = "title", location.reload(), this.end()
        },
        onClickContact: function() {
            t.nativefn.call("mobageContact")
        }
    })
}), define("scenes/common/views/ModalError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk",
            "anchorsbeforejump [data-app-modal-btn-contact]": "onClickContact"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e
            })
        },
        onClickOk: function() {
            FF.router.loading.show(), location.hash = "title", location.reload(), this.end()
        },
        onClickContact: function() {
            t.nativefn.call("mobageContact")
        }
    })
}), define("scenes/common/views/ModalPaymentError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalPaymentError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e
            })
        },
        onClickOk: function() {
            FF.router.loading.show(), FF.redirect("/dff/login")
        }
    })
}), define("scenes/common/views/ModalForceUpdate", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalForceUpdate"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-update]": "onClickUpdate"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickUpdate: function() {
            var e, t = FF.Config.server.storeUrlMap,
                n = kickmotor.nativefn.getNativeOS();
            if (n === "ios") e = t.ios;
            else {
                if (n !== "android") throw new Error("Unrecognized OS");
                e = t.android
            }
            kickmotor.platform.openExternalURL(e)
        }
    })
}), define("ww/scenes/common/util/VCApi", ["jquery", "underscore", "lib/api"], function(e, t, n) {
    return t.extend({}, {
        getVCBundlesDeferred: function(e) {
            return e && e.handleRetry ? (e.callingFunction = "getVCBundlesDeferred", n.callDeferredWithRetry(this._getVCBundlesDeferred.bind(this), e)) : this._getVCBundlesDeferred()
        },
        _getVCBundlesDeferred: function(n) {
            var r = this,
                i = e.Deferred();
            return kickmotor.platform.getVCBundles(function(e) {
                if (i) {
                    if (e.success) {
                        if (FF.env.isAndroid()) {
                            var n = [];
                            t.each(e.vcBundles, function(e) {
                                e.title = e.detail, n.push(e)
                            }), e.vcBundles = n
                        }
                        i.resolve(e.vcBundles)
                    } else FF.logger.debug("Failed to get VC due to : " + e.reason), i.reject();
                    i = null
                }
            }), i.promise()
        },
        buyVCBundleDeferred: function(t) {
            var n = this,
                r = e.Deferred();
            return kickmotor.platform.buyVCBundle(t, function(e) {
                e.success ? r.resolve(e.wallet) : (FF.logger.debug("Failed to buy VC due to : " + e.reason), r.reject(e.reason))
            }), r.promise()
        }
    })
}), define("templates_ww/common/ModalVCList", [], function() {
    return function(a) {
        function print() {
            __p += __j.call(arguments, "")
        }
        a || (a = {});
        var b, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(a) __p += '<div class="scene-ww-modal-vc-list c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><span class="c-ttl-scene__inner">Buy Gems</span></h1>\n        <ul class="c-state-line">\n            ', _.each(vc_bundles, function(e) {
            __p += '\n                <li class="c-state-line__children box-cb pt-b pb-b">\n                    <div class="c-ww-vc-bundle-list">\n                        <div class="fw-b fs-b ta-c mb-b2">' + __e(e.title || e.sku) + '</div>\n                        <div class="c-ww-vc-bundle-list__inner fs-l ta-c">' + __e(e.value) + " " + __e(gem) + '</div>\n                    </div>\n                    <div data-app-buy-vc="' + __e(e.sku) + '" data-mbgaui-anchors data-app-sound="choose">\n                        <a class="c-btn is-main-lead" data-mbgaui-anchors="{ preventDefault: true }" data-app-link-account  data-app-sound="choose">\n                            ' + __e(e.displayPrice) + "\n                        </a>\n                    </div>\n                </li>\n            "
        }), __p += '\n        </ul>\n        <div class="mb-b2 mt-b ml-b2 mr-b2">\n            <span class="td-u" data-mbgaui-anchors="{ preventDefault: true }" data-app-gem>Tap here for more information on gems and Mythril.</span>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close>Close</a>\n        </div>\n    </div>\n</div>\n';
        return __p
    }
}), define("templates_ww/common/ModalMithrilAndGem", [], function() {
    return function(a) {
        a || (a = {});
        var b, __p = "",
            __e = _.escape;
        with(a) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">Gems and Mythril</div></h1>\n        <div class="ml-b2 mr-b2">\n            <p>You can use gems or Mythril to:</p>\n            <ul class="mb-b2 mt-b2">\n                <li>- Heal Your Party in a Dungeon</li>\n                <li>- Continue Battle</li>\n                <li>- Restore Stamina</li>\n                <li>- Get More Equipment Slots</li>\n                <li>- Get More Ability Slots</li>\n                <li>- Rare Relic Draws</li>\n            </ul>\n            <p>*See the help section for more details.<br>\n*Gems can only be purchased with real currency.</p>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-gemmodal-close><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>';
        return __p
    }
}), define("ww/scenes/common/views/ModalMithrilAndGem", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates_ww/common/ModalMithrilAndGem"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-gemmodal-close]": "onClickClose"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this)
        },
        render: function() {
            this.putContent(i({}))
        },
        onClickClose: function() {
            this.trigger("onClickClose"), this.close()
        }
    })
}), define("ww/scenes/common/views/ModalBuyVC", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/common/views/ModalRetry", "ww/scenes/common/util/VCApi", "templates_ww/common/ModalVCList", "ww/scenes/common/views/ModalMithrilAndGem", "lib/TextMaster"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-buy-vc]": "onClickVCBundle",
            "anchorsbeforejump [data-app-btn-back]": "onClickBack",
            "anchorsbeforejump [data-app-modal-close]": "onClickBack",
            "anchorsbeforejump [data-app-gem]": "onClickGem"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return s.getVCBundlesDeferred({
                handleRetry: !0,
                ModalRetry: i
            }).done(function(t) {
                e.data = t, e.vcBundles = t, n.resolve()
            }).fail(function() {
                n.reject()
            }), n.promise()
        },
        render: function() {
            FF.vcBundles = this.vcBundles;
            var e = this.vcBundles.slice(0, 5);
            template = o({
                vc_bundles: e,
                gem: a.getInstance().get("gem")
            }), this.putContent(template)
        },
        loadAndOpenDeferred: function() {
            var e = t.Deferred();
            FF.router.loading.lock();
            var n = this;
            return n.setupDeferred().done(function() {
                FF.router.overlay.registerChildren(n), n.render(), n.open(), FF.router.loading.unlock(), e.resolve()
            }).fail(function() {
                e.reject()
            }), e.promise()
        },
        openWithDeferredAsDeferred: function(e) {
            return this.d = e, this.loadAndOpenDeferred()
        },
        onClickVCBundle: function(e) {
            FF.router.loading.show();
            var n = t(e.target).closest("[data-app-buy-vc]"),
                r = n.attr("data-app-buy-vc"),
                i = this;
            s.buyVCBundleDeferred(r).done(function(e) {
                var t = i.resolve(e);
                t || FF.router.loading.hide(), i.end(t)
            }).fail(function(e) {
                FF.router.loading.hide(!0)
            })
        },
        resolve: function(e) {
            return this.d ? (this.d.resolve(e), !0) : !1
        },
        reject: function() {
            return this.d ? (this.d.reject({
                errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                isPurchasingCanceled: !0
            }), !0) : !1
        },
        onClickBack: function() {
            this.reject(), this.trigger("detailModalClose"), this.end()
        },
        onClickGem: function() {
            var e = this,
                t = new u;
            FF.router.overlay.registerChildren(t), t.render(), t.open(), this.listenToOnce(t, "onClickClose", function() {
                e.loadAndOpenDeferred()
            })
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("templates_ww/common/ModalBalanceError", [], function() {
    return function(a) {
        a || (a = {});
        var b, __p = "",
            __e = _.escape;
        with(a) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">Not Enough Gems</div></h1>\n        <div class="c-description-center">\n            <div class="w-full">\n                <span class="fc-warning">You don\'t have enough gems.</span><br>\n                Buy more from the shop?\n                <ul class="pt-b3 ta-c">\n                    <li class="pb-b">Current Gems: <span class="fc-warning">' + __e(balance) + "</span></li>\n                    <li>You need " + __e(price) + ' gem(s).</li>\n                </ul>\n            </div>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead c-btn-layout__left" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close><span class="c-btn__inner">Close</span></a>\n            <a class="c-btn is-main-lead c-btn-layout__right" data-mbgaui-anchors data-app-sound="decide" data-app-decide><span class="c-btn__inner">Buy Now</span></a>\n        </div>\n    </div>\n</div>';
        return __p
    }
}), define("ww/scenes/common/views/ModalBalanceError", ["underscore", "jquery", "backbone", "lib/ModalBase", "ww/scenes/common/views/ModalBuyVC", "lib/TextMaster", "templates_ww/common/ModalBalanceError"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide]": "onClickDecide"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        promptToBuyDeferred: function(e, n) {
            return this.d = t.Deferred(), this.render({
                balance: e,
                price: n,
                gem: s.getInstance().get("gem")
            }), FF.router.overlay.registerChildren(this), this.open(), FF.router.loading.unlock(), this.d.promise()
        },
        render: function(e) {
            var t = o(e);
            this.putContent(t)
        },
        onClickModalClose: function() {
            this.d && this.d.reject({
                errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                isPurchasingCanceled: !0
            }), this.end()
        },
        onClickDecide: function() {
            FF.router.loading.lock();
            var e = new i,
                t = this;
            this.d ? e.openWithDeferredAsDeferred(t.d).always(function() {}) : e.loadAndOpenDeferred().always(function() {})
        }
    })
}), define("templates_ww/common/ModalUseGemConfirm", [], function() {
    return function(a) {
        function print() {
            __p += __j.call(arguments, "")
        }
        a || (a = {});
        var b, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(a) {
            __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n\n        ';
            if (confirmType == CONST.CONFIRMATION_TYPES.POSSESSION) {
                __p += "\n            ";
                var c = FF.Config.server.itemPossessionLimit[config.possessionType];
                __p += '\n            <h1 class="c-ttl-scene">Use Gems to Buy Slots</h1>\n            <div class="mr-b ml-b fs-xs">\n                <p class="mb-b4 pt-b3 ta-c">\n                    You can use ' + __e(config.payCost) + " gems to increase the number of " + __e(config.possessionType === CONST.TYPE_EQUIPMENT ? "Equipment" : "Ability") + " slots by " + __e(c.increaseNum) + '.\n                </p>\n                <dl class="mod-status-lv box-cc mb-b4 pb-b3">\n                    <dt>' + __e(config.possessionType === CONST.TYPE_EQUIPMENT ? "Equipment" : "Abilitiy") + ' Slots: </dt>\n                    <dd class="ml-b">' + __e(config.itemPossessionLimitNum) + '<span class="ml-b mr-b"> → </span><span class="fc-up">' + __e(config.itemPossessionLimitNum + c.increaseNum) + "</span></dd>\n                </dl>\n        "
            }
            __p += "\n        ", confirmType == CONST.CONFIRMATION_TYPES.STRATEGY && (__p += '\n            <h1 class="c-ttl-scene">Use Gems to Heal</h1>\n            <div class="c-description-center mr-b ml-b">\n                <p class="mb-b4 pt-b3 ta-c">\n                    Use ' + __e(config.payCost) + " gems to heal.\n                </p>\n        "), __p += "\n        ", confirmType == CONST.CONFIRMATION_TYPES.GACHA && (__p += '\n            <h1 class="c-ttl-scene">Use Gems to Find Relics</h1>\n            <div class="mr-b ml-b">\n                <p class="mb-b4 pt-b3 ta-c">\n                    Use ' + __e(config.payCost) + " gems to find new relics.\n                </p>\n        "), __p += "\n        ", confirmType == CONST.CONFIRMATION_TYPES.STAMINA && (__p += '\n            <h1 class="c-ttl-scene">Use Gems to Recover Stamina</h1>\n            <div class="mr-b ml-b">\n                <p class="mb-b4 pt-b3 ta-c">\n                    Use ' + __e(config.payCost) + " gems to restore Stamina.\n                </p>\n        "), __p += '\n\n                <dl class="mod-status-lv box-cc">\n                    <dt class="c-label__img p-text-gem img-rep">所持ジェム</dt>\n                    <dd class="ml-b">' + __e(userGems) + '</dd>\n                </dl>\n            </div>\n\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead c-btn-layout__left" data-app-modal-close data-mbgaui-anchors data-app-sound="cancel" data-app-enable-back-key="true"><span class="c-btn__inner">Cancel</span></a>\n            <a class="c-btn is-main-lead c-btn-layout__right" data-app-decide data-mbgaui-anchors data-app-sound="decide"><span class="c-btn__inner">Yes</span></a>\n        </div>\n    </div>\n</div>'
        }
        return __p
    }
}), define("ww/scenes/common/views/ModalUseGemConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates_ww/common/ModalUseGemConfirm"], function(e, t, n, r, i) {
    var s = {
        TYPE_EQUIPMENT: "equipment",
        CONFIRMATION_TYPES: {
            POSSESSION: "possession",
            STRATEGY: "strategy",
            GACHA: "gacha",
            STAMINA: "stamina"
        }
    };
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickCancel"
        },
        initialize: function(t) {
            this.config = t, this.confirmType = this.config.confirmType;
            switch (this.confirmType) {
                case s.CONFIRMATION_TYPES.POSSESSION:
                    var n = e.find(FF.datastore.itemPossessionLimitCollection.models, function(e) {
                        return e.get("item_type_name") === t.possessionType
                    });
                    this.config.itemPossessionLimitNum = n.get("max_num");
                    break;
                default:
            }
            r.prototype.initialize.call(this)
        },
        render: function() {
            var e = i({
                userModel: FF.datastore.userModel,
                confirmType: this.confirmType,
                userGems: this.coinNum,
                config: this.config,
                CONST: s
            });
            this.putContent(e)
        },
        updateUserBalance: function(e) {
            this.coinNum = e
        },
        onClickDecide: function() {
            FF.router.loading.lock(), this.trigger("onClickDecide"), this.end(!0)
        },
        onClickCancel: function() {
            FF.router.loading.lock(), this.trigger("onClickCancel"), this.end()
        },
        dispose: function() {
            this.type = null, this.coinNum = null, this.itemPossessionLimitNum = null, r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/util/Api", ["jquery", "underscore", "lib/api", "scenes/common/views/ModalRetry", "scenes/common/views/ModalError", "scenes/common/views/ModalPaymentError", "scenes/common/views/ModalForceUpdate"], function(e, t, n, r, i, s, o) {
    var u = n.requestDeferred,
        a = n.purchaseItemDeferred,
        f = null,
        l = null;
    return t.extend({}, n, {
        originalRequestDeferred: u,
        originalPurchaseItemDeferred: a,
        getErrorHandleFuncByError: function(e) {
            var t = FF.CONST.SERVER.ERROR;
            return this.ERROR_HANDLE_FUNC_OF || (this.ERROR_HANDLE_FUNC_OF = {}, this.ERROR_HANDLE_FUNC_OF[t.RESTRICTED_USER] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.REQUIRE_LOGIN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.MAINTENANCE] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.FORCE_UPDATE] = this.handleForceUpdateError, this.ERROR_HANDLE_FUNC_OF[t.NEED_UPDATE_APP_JS] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.FORM_VALIDATION] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.INVALID_USER_SESSION] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EXPIRE_DUNGEON_TERM] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EVENT_WORLD_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EXCHANGE_SHOP_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.EXCHANGE_SHOP_PRIZE_NOT_OPEN] = this.handleExchangeShopPrizeNotOpenError, this.ERROR_HANDLE_FUNC_OF[t.APPLICATION_CAMPAIGN_NOT_OPEN] = this.handleUnexpectedError, this.ERROR_HANDLE_FUNC_OF[t.REAL_INCENTIVE_MISSION_NOT_OPEN] = this.handleUnexpectedError), this.ERROR_HANDLE_FUNC_OF[e]
        },
        requestDeferred: function(t, r, i) {
            var s = this,
                o = e.Deferred(),
                a = FF.CONST.SERVER.ERROR;
            i = i ? i : {}, i.headers = i.headers ? i.headers : {}, i.headers["App-Js-Version"] = FF.env.appJsVersion || "UNDEFINED_APP_JS_VERSION", this._showLoadingIfNeeded(i);
            var f = [t, r, i];
            return u.apply(n, f).then(function(e, t, n) {
                o.resolve(e, t, n)
            }, function(e, t, n) {
                FF.router.loading.hide();
                if (i.doNotHandleError) {
                    o.reject();
                    return
                }
                var r = s.getErrorHandleFuncByError(n.error);
                i.forceThrowError ? s.handleUnexpectedError(f, e, n) : t === "timeout" ? s.handleNetworkError(o, f) : e.status === 403 ? s.handleUnexpectedError(f, e, {
                    error: a.REQUIRE_LOGIN
                }) : e.status === 404 ? s.handleNetworkError(o, f) : t === "success" && r ? r.call(s, f, e, n) : t === "success" && n.error !== a.UNKNOWN ? s.handleExpectError(o, e, t, n) : s.handleUnexpectedError(f, e, n)
            }), o.promise()
        },
        _showLoadingIfNeeded: function(e) {
            e.useLoadingLock ? FF.router.loading.lock() : e.disableLoading || FF.router.loading.show()
        },
        requestWithCacheDeferred: function(e, t, n) {
            var r = this,
                i = n.expirationTime;
            delete n.expirationTime;
            var s = e + JSON.stringify(t);
            return FF.datastore.apiCache.cacheableDeferred(s, function() {
                return r.requestDeferred(e, t, n)
            }, i)
        },
        handleExpectError: function(e, t, n, r) {
            e.reject(r, n, t)
        },
        handleNetworkError: function(e, t) {
            var n = this,
                i = t[2],
                s = new r;
            FF.modalStack && FF.modalStack.setIsHidden(!0), FF.router.overlay.registerChildren(s), s.render(), s.open(), s.overlayStayOnEnd = !i.doNotStayRetryDialog, s.listenToOnce(s, "onClickRetry", function() {
                n._showLoadingIfNeeded(i), t[1] || (t[1] = {}), t[1].retry_count = (t[1].retry_count || 0) + 1, n.requestDeferred.apply(n, t).done(function(t, n, r) {
                    e.resolve(t, n, r)
                }).fail(function(t, n, r) {
                    e.reject(t, n, r)
                })
            })
        },
        handleUnexpectedError: function(e, t, n) {
            var r = "API Error : " + (e[0] || ""),
                s = "status : " + t.status + " : " + t.statusText + " : response : " + (t.responseText || "unknown"),
                o = new i;
            FF.router.overlay.registerChildren(o), o.render({
                message: r,
                error: s,
                errorCode: n.error,
                miscData: n.misc_data || {}
            }), o.open()
        },
        handleForceUpdateError: function(e, t) {
            var n = new o;
            FF.router.overlay.registerChildren(n), n.render(), n.open()
        },
        purchaseItemDeferred: function(t) {
            if (FF.env.isWWRegion()) return this.purchaseLcdItemDeferred(t);
            var n = e.Deferred();
            return this.originalPurchaseItemDeferred.apply(this, arguments).then(function(e) {
                n.resolve(e)
            }, function(e) {
                if (e.isPurchasingCanceled) return n.reject(e);
                var t = new s;
                FF.router.overlay.registerChildren(t), t.render(), t.open()
            }), n.promise()
        },
        updateUserSessionKeyDeferred: function() {
            return this.originalRequestDeferred("/dff/update_user_session", {}, {
                type: "POST"
            }).then(function(e) {
                FF.env.userSessionKey = e.user_session_key
            }, function(e, n, r) {
                var i = t.isObject(e) ? e.responseText || "undefined" : "undefined",
                    s = sprintf("failed_update_user_session. responseText:%s, textStatus:%s", i, n || "undefined");
                throw new Error(s)
            })
        },
        getGooglePlayAchievementsDeferred: function() {
            return this.requestDeferred("/dff/google_play_achievement/get_achievements")
        },
        userProfileDeferred: function() {
            return this.requestDeferred("/dff/user/profile", {}, {
                type: "POST"
            })
        },
        nicknameUpdateDeferred: function(e) {
            return this.requestDeferred("/dff/user/update_nickname", {
                nickname: e
            }, {
                type: "POST"
            })
        },
        configureProfileMessageDeferred: function(e) {
            return this.requestDeferred("/dff/user/configure_profile_message", {
                profile_message: e
            }, {
                type: "POST"
            })
        },
        reviewApplyDeferred: function(e) {
            return this.requestDeferred("/dff/review/apply", {
                review_id: e
            }, {
                type: "POST"
            })
        },
        getEventDataDeferred: function(e, t) {
            return this.requestDeferred(sprintf("/dff/event/%s/%s/get_data", t, e))
        },
        getOpenedExtremeWorldListDeferred: function() {
            return this.requestDeferred("/dff/extreme/get_opened_world_list")
        },
        followDeferred: function(e, t) {
            var n = {
                id: e
            };
            return t = t || {}, !t.isViaBattle || (n.via_battle = 1), !t.sceneId || (n.scene_id = t.sceneId), this.requestDeferred("/dff/relation/follow", n, {
                type: "POST"
            })
        },
        unfollowDeferred: function(e) {
            return this.requestDeferred("/dff/relation/unfollow", {
                id: e
            }, {
                type: "POST"
            })
        },
        finishFellowSessionDeferred: function(e) {
            return this.requestDeferred("/dff/relation/finish_fellow_session", {}, {
                type: "POST"
            })
        },
        detailedFellowListingDeferred: function(e) {
            e = e || {};
            var t = {};
            return t.dungeon_id = e.dungeonId, this.requestDeferred("/dff/relation/detailed_fellow_listing", t, {
                type: "POST"
            })
        },
        partyListDeferred: function() {
            return this.requestDeferred("/dff/party/list", {})
        },
        getRootDataDeferred: function() {
            return this.requestDeferred("/dff/get_root_data")
        },
        buddySaveSoulStrikeDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/buddy/save_soul_strike", {
                data: e,
                is_recommended: t
            }, {
                type: "POST"
            })
        },
        partyMemoryListDeferred: function() {
            return this.requestDeferred("/dff/party_memory/list")
        },
        partyMemorySaveDeferred: function(e) {
            return this.requestDeferred("/dff/party_memory/save", {
                party_memory_no: e
            }, {
                type: "POST"
            })
        },
        partyMemoryRemoveDeferred: function(e) {
            return this.requestDeferred("/dff/party_memory/remove", {
                party_memory_no: e
            }, {
                type: "POST"
            })
        },
        partyMemoryRenameDeferred: function(e, t) {
            return this.requestDeferred("/dff/party_memory/rename", {
                party_memory_no: e,
                party_name: t
            }, {
                type: "POST"
            })
        },
        purchaseLcdItemDeferred: function() {
            var t = e.Deferred(),
                n = this,
                r = arguments;
            FF.router.loading.lock(), n.confirmModal = null;
            var r = arguments[0],
                i = r.id.price || 1;
            n.confirmModalOptions = r.id.modalOptions, n.confirmModalOptions.payCost = i, r.id = r.id.entryPointId, r = new Array(r);
            var o = function(e) {
                    if (e && e.isPurchasingCanceled) return t.reject(e);
                    var n = new s;
                    FF.router.overlay.registerChildren(n), n.render(), n.open()
                },
                u = function() {
                    n.checkBalanceDeferred(i).then(function(e) {
                        return n.confirmWithUserDeferred.call(n, e)
                    }, function(e) {
                        o(e)
                    }).then(function() {
                        return n.originalPurchaseItemDeferred.apply(n, r)
                    }, function(e) {
                        o(e)
                    }).then(function(e) {
                        t.resolve(e)
                    }, function(e) {
                        o(e)
                    }).always(function() {
                        n.confirmModal = null
                    })
                };
            return f ? u() : require(["ww/scenes/common/views/ModalBalanceError", "ww/scenes/common/views/ModalUseGemConfirm"], function(e, t) {
                f = e, l = t, u()
            }), t.promise()
        },
        confirmWithUserDeferred: function(t) {
            var n = e.Deferred(),
                r = this,
                i = null;
            return l && (i = new l(r.confirmModalOptions)), i ? (i.updateUserBalance(t), i.listenToOnce(i, "onClickDecide", function() {
                i.stopListening(i, "onClickCancel"), n.resolve()
            }), i.listenToOnce(i, "onClickCancel", function() {
                i.stopListening(i, "onClickDecide"), n.reject({
                    errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                    isPurchasingCanceled: !0
                })
            }), i.render.apply(i), FF.router.overlay.registerChildren(i), i.open(), FF.router.loading.unlock(), n.promise()) : n.resolve().promise()
        },
        checkBalanceDeferred: function(t) {
            var n = e.Deferred(),
                r = this;
            return this.getBalanceDeferred({
                handleRetry: !0
            }).then(function(e) {
                e < t ? r.promptToBuyDeferred(e, t).then(function() {
                    r.checkBalanceDeferred(t).then(function(e) {
                        n.resolve(e)
                    }, function(e) {
                        n.reject(e)
                    })
                }, function(e) {
                    n.reject(e)
                }) : n.resolve(e)
            }, function(e) {
                n.reject(e)
            }), n.promise()
        },
        promptToBuyDeferred: function(t, n) {
            var r = e.Deferred(),
                i = this,
                s = new f;
            return s.promptToBuyDeferred(t, n).then(function() {
                s.end(!0), r.resolve()
            }, function() {
                r.reject({
                    errorCode: FF.CONST.CLIENT.PAYMENT_ERROR_CODE_OF.PURCHASING_COIN_CANCELED,
                    isPurchasingCanceled: !0
                })
            }), r.promise()
        },
        getBalanceDeferred: function(e) {
            return e = e || {}, FF.env.isWWRegion() && (e.ModalRetry = r), n.getBalanceDeferred(e)
        },
        getAssetsByPathsDeferred: function(e) {
            return this.requestDeferred("/dff/download/get_assets", {
                paths: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/views/Header", ["jquery", "backbone", "sprintf", "components/Timer"], function(e, t, n, r) {
    return t.View.extend({
        _userModel: undefined,
        _partyModel: undefined,
        _partyStatusModel: undefined,
        _currentStamina: undefined,
        _maxStamina: undefined,
        _buddyCollection: undefined,
        events: {},
        initialize: function() {
            this._userModel = FF.datastore.userModel, this._partyModel = FF.datastore.partyModel, this._partyStatusModel = FF.datastore.partyStatusModel, this._buddyCollection = FF.datastore.buddyCollection, this._addEventListener(), this._updateInitialUserDisplay(), this._defineNewView(), this._updatePartyView(), this._updatePartyStatusView(), FF.env.isUsingTodayWidget() && (this._recordCurrentStamina(), this._recordMaxStamina())
        },
        _defineNewView: function() {
            this._timer = new r({
                el: e("[data-app-recovery-time]"),
                remaining: this._userModel.get("stamina_recovery_remaining_time") * 1e3,
                displayType: "EACH",
                onEachMs: this._userModel.get("stamina_recovery_time") * 1e3,
                onEachFn: this._increaseStaminaValue.bind(this),
                onTimerEnd: this._increaseStaminaValue.bind(this)
            })
        },
        _addEventListener: function() {
            this.listenTo(this._userModel, "change:stamina", function() {
                this._updateInitialUserDisplay(), this._updateStaminaValue(), this._timer.disposeFunctionality(), this._currentStamina !== this._maxStamina && this._defineNewView()
            }.bind(this)), this.listenTo(this._userModel, "change:gil", this._updateUserView.bind(this)), this.listenTo(this._userModel, "change:soul_piece", this._updateUserView.bind(this)), this.listenTo(this._userModel, "change:residual_stamina_piece", this._updateUserView.bind(this)), this.listenTo(this._partyModel, "change", function() {
                this._updatePartyView()
            }.bind(this)), this.listenTo(this._buddyCollection, "change:image_path", function() {
                this._updatePartyView()
            }), this.listenTo(this._partyStatusModel, "change", function() {
                this._updatePartyStatusView()
            }.bind(this)), FF.env.isUsingTodayWidget() && (this.listenTo(this._userModel, "change:stamina", this._recordCurrentStamina.bind(this)), this.listenTo(this._userModel, "change:max_stamina", this._recordMaxStamina.bind(this)))
        },
        _updateInitialUserDisplay: function() {
            this._currentStamina = this._userModel.get("stamina"), this._maxStamina = this._userModel.get("max_stamina"), this._updateUserView(), this._updateStaminaGauge()
        },
        _updateUserView: function() {
            var t = this._userModel;
            e("[data-app-pocket-stone]").html(t.get("soul_piece")), e("[data-app-pocket-gil]").html(t.get("gil")), e("[data-app-user-stamina]").html(t.get("stamina")), e("[data-app-max-stamina]").html(t.get("max_stamina")), e("[data-app-stamina-piece]").each(function(n, r) {
                var i = n + 1;
                t.get("residual_stamina_piece") >= i ? e(r).addClass("p-stamina-piece img-rep") : e(r).removeClass("p-stamina-piece img-rep")
            }), this._currentStamina > this._maxStamina ? e("[data-app-user-stamina]").addClass("fc-up") : e("[data-app-user-stamina]").removeClass("fc-up")
        },
        _updatePartyView: function() {
            e("[data-app-header-slots] img").hide();
            var t = this._partyModel;
            _.each(t.getBuddyMap(), function(t, r) {
                e(n("[data-app-header-slot-%s] img", r)).attr("src", pUrl(t.get("image_path"))).show()
            })
        },
        _updatePartyStatusView: function(t) {
            t = t || {};
            var n = this._partyStatusModel;
            if (!n.hasAttributes()) {
                e(".c-user-chara__hp-gauge").hide(), e("[data-app-header-slots] li").removeClass("is-sortie").removeClass("with-effect-aura").find("[data-app-effect-aura]").hide();
                return
            }
            this._updatePartyStatusViewInDungeon(t)
        },
        _updatePartyStatusViewInDungeon: function(t) {
            var r = FF.datastore.dungeonSessionModel.isInDungeon(),
                i = r ? this._partyStatusModel : this._partyModel,
                s = t.statusBonusOpt || FF.datastore.dungeonSessionModel.getStatusBonusOpt(),
                o = this._partyModel.getBuddyMap();
            _.map(FF.CONST.SERVER.PARTY.SLOTS, function(u) {
                var a = r ? i.get(u) : i.get("slotToBuddyId")["" + u],
                    f = e(n("[data-app-header-slot-%s]", u));
                f.removeClass("is-sortie").removeClass("with-effect-aura"), f.find("[data-app-effect-aura]").hide(), f.find("[data-app-effect-role-aura]").hide(), e(".c-user-chara__hp-gauge", f).hide();
                if (!a) return;
                var l = o[u],
                    c = l.getStatusBonusOpt(s);
                c.hasSeriesBonus ? (f.addClass("with-effect-aura"), f.find("[data-app-effect-aura]").show()) : c.hasRoleBonus && (f.addClass("with-effect-aura"), f.find("[data-app-effect-role-aura]").show());
                if (t.isShowGauge) {
                    var h = l.getParamOf("hp", c),
                        p = Math.floor(a.hp / h * 100);
                    e(".c-user-chara__hp-gauge", f).show(), e(".c-user-chara__hp-gauge-inner", f).width(p + "%")
                } else r && f.addClass("is-sortie")
            })
        },
        updatePartyStatusView: function(e) {
            e = e || {}, this._updatePartyStatusView(e)
        },
        updatePartyStatusViewInDungeon: function(e) {
            e = e || {}, this._updatePartyStatusViewInDungeon(e)
        },
        _increaseStaminaValue: function() {
            this._currentStamina < this._maxStamina && this._currentStamina++, this._updateStaminaValue(), this._updateStaminaGauge()
        },
        _updateStaminaValue: function() {
            this._userModel.set("stamina", this._currentStamina, {
                silent: !0
            }), e("[data-app-user-stamina]").html(this._currentStamina)
        },
        _updateStaminaGauge: function() {
            var t = Math.floor(this._currentStamina / this._maxStamina * 100);
            100 < t && (t = 100), e("[data-app-stamina-gauge]").width(t + "%")
        },
        forceUpdate: function() {
            this._timer.forceUpdate(), this._updateStaminaGauge(), this._updateStaminaValue()
        },
        _recordCurrentStamina: function() {
            var e = this._userModel.get("stamina_recovery_remaining_time");
            if (!e && e !== 0) return;
            var t = Math.floor((new Date).getTime() / 1e3) + e;
            kickmotor.platform.saveInSharedMemory("staminaRecoveryTargetTime", t)
        },
        _recordMaxStamina: function() {
            var e = this._userModel.get("max_stamina");
            if (!e) return;
            kickmotor.platform.saveInSharedMemory("maxStamina", e)
        },
        dispose: function() {
            this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/common/models/User", ["backbone", "lib/Model", "util"], function(e, t, n) {
    var r = t.extend({
        isMaxStamina: function() {
            return this.get("stamina") === this.get("max_stamina")
        },
        isRequiredLogin: function() {
            var e = this.get("start_time_of_today"),
                t = this.get("last_logined_at");
            if (t < e) return !0;
            var r = e + 86400,
                i = n.getTimeAsSec();
            return i > r ? !0 : !1
        },
        isUpdateLastLoginedAt: function() {
            return this.get("is_update_last_logined_at") ? !0 : !1
        },
        hasProceededFuncTutorial: function(e) {
            var t = this.get("func_tutorial_flags");
            if (t[e] === undefined) throw new Error("invalid FUNC_TUTORIAL_KEY : " + e);
            return t[e] ? !0 : !1
        },
        hasUnlockedFellow: function() {
            return !0
        },
        isUpperLimitNextLvSsGauge: function() {
            return FF.CONST.SERVER.USER.MAX_SUPPORTER_SS_GAUGE < this.get("supporter_ss_gauge") + 1
        },
        isRequireShowFellowTutorial: function() {
            return !this.hasProceededFuncTutorial("FELLOW_PLUS") && !this.hasProceededFuncTutorial("FELLOW") && this.hasProceededFuncTutorial("SERIES")
        },
        isRequireShowFellowPlusTutorial: function() {
            return !this.hasProceededFuncTutorial("FELLOW_PLUS") && this.hasProceededFuncTutorial("FELLOW") && this.hasProceededFuncTutorial("SERIES")
        }
    });
    return r
}), define("scenes/common/models/Party", ["underscore", "lib/Model", "util", "sprintf"], function(e, t, n, r) {
    return t.extend({
        defaults: function() {
            this.set("slotToBuddyId", {})
        },
        update: function(e) {
            this.set("slotToBuddyId", e.slot_to_buddy_id)
        },
        getSlotToBuddyId: function() {
            var t = this.get("slotToBuddyId");
            return e.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                t[e] = t[e] || 0
            }), t
        },
        getSlotByBuddyModel: function(t) {
            var n = this.get("slotToBuddyId");
            return e.find(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                var r = n[e];
                return r ? r === t.get("id") : !1
            })
        },
        getBuddyModels: function() {
            var t = this.getSlotToBuddyId(),
                n = this.getDatastore().buddyCollection;
            return e.map(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                var r = t[e];
                if (!r) return null;
                var i = n.get(r);
                if (!i) throw new Error("missing " + i + " : " + r);
                return i
            })
        },
        getBuddyMap: function() {
            var t = this.getDatastore().buddyCollection,
                n = this.getSlotToBuddyId(),
                r = {};
            return e.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                var i = n[e];
                if (!i) return;
                var s = t.get(i);
                if (!s) throw new Error("missing buddy : " + i);
                r[e] = s
            }), r
        },
        getLeaderBuddyModel: function() {
            var t = this.getBuddyModels();
            return e.find(t, function(e) {
                return !!e
            })
        },
        isBuddyModelInParty: function(t) {
            var n = this,
                r = e.invert(n.get("slotToBuddyId"));
            return !!r[t.get("id")]
        },
        getBuddyModelsOutOfParty: function() {
            var t = {};
            return e.each(this.get("slotToBuddyId"), function(e, n) {
                e && (t[e + ""] = !0)
            }), FF.datastore.buddyCollection.models.filter(function(e) {
                return !t[e.get("id") + ""]
            })
        },
        _getOrder: function(t) {
            var n = this.getSlotToBuddyId(),
                r;
            return e.each(n, function(e, n) {
                e === t && (r = n)
            }), r
        },
        swapParty: function(e) {
            if (e.length !== 2) throw new Error("swapParty: Ids must be array of two ids.");
            var t = [this._getOrder(e[0]), this._getOrder(e[1])],
                n = this.getSlotToBuddyId(),
                i = this.getDatastore().buddyCollection,
                s = void 0;
            if (t[0] && t[1]) n[t[0]] = e[1], n[t[1]] = e[0];
            else if (t[0]) n[t[0]] = e[1];
            else {
                if (!t[1]) throw new Error(r("swapParty cant swap two they are not in the party ids: %s, %s", e[0], e[1]));
                n[t[1]] = e[0]
            }
        },
        changeOrderByTmpRow: function() {
            var t = this,
                n = e.compact(this.getBuddyModels()),
                r = e.filter(n, function(e) {
                    return e.isTmpRowFront()
                }),
                i = e.filter(n, function(e) {
                    return e.isTmpRowBack()
                }),
                s = {};
            e.each(n, function(e) {
                s[e.get("id")] = e.getTmpRow()
            });
            var o = {};
            e.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                var t = r.shift() || i.shift(),
                    n = t ? t.get("id") : 0;
                o[e] = n
            }), this.set("slotToBuddyId", o)
        },
        dismissParty: function(e) {
            var t = this._getOrder(e);
            t && (this.getSlotToBuddyId()[t] = null)
        },
        addParty: function(e) {
            this.getSlotToBuddyId()[e.order] = e.id
        },
        movePartyOntoEmptySlot: function(e) {
            var t = this.getSlotToBuddyId(),
                n = this._getOrder(e.id);
            t[n] = null, t[e.order] = e.id
        },
        doesExistOriginalAttributes: function() {
            return !!this.original
        },
        backupOriginalAttributes: function() {
            this.original = n.cloneDeep(this.attributes)
        },
        restoreOriginalAttributes: function() {
            this.set(n.cloneDeep(this.original)), this.original = null
        },
        clearOriginalAttributes: function() {
            this.original = null, this.trigger("change")
        },
        hasChanged: function() {
            var t = this.getSlotToBuddyId(),
                n = this.original;
            return e.some(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                var r = t[e];
                return r !== n[e] ? !0 : !1
            })
        },
        hasPartyBuddy: function() {
            var t = this.getSlotToBuddyId();
            return e.some(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                return !!t[e]
            })
        },
        getIsPartyEmpty: function() {
            var e = this.getBuddyModels(),
                t = e.length;
            for (; t--;)
                if (e[t]) return !1;
            return !0
        }
    })
}), define("scenes/common/models/PartyStatus", ["lib/Model", "util", "sprintf"], function(e, t, n) {
    return e.extend({
        isInDungeon: function() {
            return this.hasAttributes()
        },
        isFullRecovery: function() {
            var e = FF.datastore.buddyCollection,
                t = FF.datastore.dungeonSessionModel,
                n = t.get("series_id"),
                r = t.getStatusBonusOpt();
            return _.every(this.attributes, function(t) {
                if (!t || !t.user_buddy_id) return;
                var n = e.get(t.user_buddy_id);
                if (t.hp !== n.getParamOf("hp", r)) return !1;
                if (t.status_ailments.length) return !1;
                var i = n.abilities[0],
                    s = n.abilities[1];
                return i && +i.get("num") !== +t.ability_1_num ? !1 : s && +s.get("num") !== +t.ability_2_num ? !1 : !0
            }) && t.isFullSupporterSsGauge()
        },
        getIdToDataMap: function() {
            var e = {};
            return _.each(this.attributes, function(n) {
                if (!n || !n.user_buddy_id) return;
                e[n.user_buddy_id] = t.cloneDeep(n)
            }), e
        }
    })
}), define("scenes/common/models/ItemBase", ["lib/SeparatedModel"], function(e) {
    return e.extend({
        setSilent: function(e, t, n) {
            var r = _.defaults(n || {}, {
                silent: !0
            });
            this.set(e, t, r)
        },
        getSellNum: function() {
            return 1
        },
        isBuddy: function() {
            return !1
        },
        isEquipment: function() {
            return !1
        },
        isMaterial: function() {
            return !1
        },
        isAbility: function() {
            return !1
        },
        isMemoryCrystal: function() {
            return !1
        },
        isGrowEgg: function() {
            return !1
        },
        isRecordMateria: function() {
            return !1
        },
        isSoulStrike: function() {
            return !1
        },
        isEquipSpMaterial: function() {
            return !1
        }
    })
}), define("scenes/common/views/ModalExtremeWorldOutOfPeriod", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "scenes/common/util/Api", "templates/common/ModalExtremeWorldOutOfPeriod", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk"
        },
        setupDeferred: function() {
            var e = this;
            this.openedExtremeWorldList = [];
            var n = t.Deferred();
            return this.getOpenedExtremeWorldListDeferred().then(function() {
                n.resolve()
            }), n.promise()
        },
        getOpenedExtremeWorldListDeferred: function() {
            var n = this,
                r = t.Deferred();
            return a.isReleasedByKey("EXTREME_DUNGEONS_2ND") ? (o.getOpenedExtremeWorldListDeferred().then(function(t) {
                var i = e.sortBy(t.worlds, function(e) {
                    return e.id
                });
                n.openedExtremeWorldList = i, r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        render: function(e) {
            this.renderContent(u, {
                openedExtremeWorldList: this.openedExtremeWorldList
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll-for-modal]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar-for-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickOk: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/common/helper/ExtremeEventHelper", ["jquery", "underscore", "backbone", "scenes/common/views/ModalExtremeWorldOutOfPeriod"], function(e, t, n, r) {
    return {
        isExtremeWorldOpen: function() {
            return FF.datastore.worldCollection.isExtremeWorldOpen()
        }
    }
}), define("scenes/common/models/Mission", ["./ItemBase", "util", "components/TimeKeeper", "scenes/common/helper/ExtremeEventHelper"], function(e, t, n, r) {
    var i = {
            TO_DUNGEON: "mission_to_dungeon",
            TO_GACHA: "mission_to_gacha",
            TO_WORLD: "mission_to_world",
            TO_EVENT: "mission_to_event",
            TO_EXTREME: "mission_to_extreme",
            TO_EQUIPMENT: "mission_to_equipment",
            TO_EXCHANGE_SHOP: "mission_to_exchange_shop"
        },
        s = 3;
    return e.extend({
        isNew: function(e) {
            return this.get("opened_at") > e
        },
        isOpen: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        isClosed: function() {
            return this.get("is_closed")
        },
        isNotStarted: function() {
            return this.get("is_not_started")
        },
        isChallenging: function() {
            return this.get("is_challenging")
        },
        isAchieved: function() {
            return this.get("is_achieved")
        },
        isBeginner: function() {
            return this.get("is_beginner")
        },
        isNormal: function() {
            return this.get("is_normal")
        },
        isLimitedTime: function() {
            return this.get("is_limited_time")
        },
        isRealIncentive: function() {
            return this.get("is_real_incentive")
        },
        isRealIncentiveReadyToApply: function() {
            return this.get("is_real_incentive_ready_to_apply")
        },
        isRealIncentiveApplied: function() {
            return this.get("is_real_incentive_applied")
        },
        isRealIncentiveAppliedWithSNSShare: function() {
            return this.get("is_real_incentive_applied_with_sns_share")
        },
        isReceivedReward: function() {
            return this.get("is_received_reward")
        },
        hasProgressNum: function() {
            return this.get("max_achieve_count") !== 0
        },
        hasTerm: function() {
            return !0
        },
        getItemInfo: function() {
            return this.get("item")
        },
        canChallenge: function() {
            return this.isNotStarted() ? !0 : this.isChallenging() ? !0 : !1
        },
        isWaitingReceiveReward: function() {
            return this.isAchieved() && !this.isReceivedReward()
        },
        canReceiveReward: function() {
            return this.isWaitingReceiveReward() && !this.isLimitedPossession()
        },
        isLimitedPossession: function() {
            var e = this.get("item");
            if (e.type_name !== "EQUIPMENT" && e.type_name !== "ABILITY") return !1;
            if (e.type_name === "EQUIPMENT") {
                var t = FF.datastore.itemPossessionLimitCollection.findByTypeName("equipment");
                return t.isOverOrMaxLimit() ? !0 : !1
            }
            if (e.type_name === "ABILITY") {
                var n = FF.datastore.itemPossessionLimitCollection.findByTypeName("ability");
                return n.isOverOrMaxLimit() ? !0 : !1
            }
            return !1
        },
        getClosedAtString: function() {
            var e = new n({
                format: FF.env.isWWRegion() ? "%M/%D %H:%I" : "%M月%D日%H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            });
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + "まで"
        },
        getTargetWorldId: function() {
            return this.isAchieveTypeClearSpecificDungeon() ? this.get("achieve_cond_arg1") : null
        },
        getTargetDungeonId: function() {
            return this.isAchieveTypeClearSpecificDungeon() ? this.get("achieve_cond_arg2") : null
        },
        isTargetDungeonUnlocked: function() {
            return this.isAchieveTypeDungeon() ? this.isAchieveTypeClearDungeonByType() ? !0 : !!this.get("is_dungeon_unlocked") : !1
        },
        isAchieveTypeClearSpecificDungeon: function() {
            return this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_SPECIFIC_DUNGEON
        },
        isAchieveTypeClearDungeonByType: function() {
            return this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_DUNGEON_BY_TYPE
        },
        isAchieveTypeDungeon: function() {
            return this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_SPECIFIC_DUNGEON || this.get("achieve_cond_type") === FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_DUNGEON_BY_TYPE
        },
        canMoveTo: function() {
            return this._setupCanMoveToMap(), this.canChallenge() ? this._canMoveToMap[this.get("achieve_cond_type")]() : !1
        },
        _setupCanMoveToMap: function() {
            if (this._canMoveToMap) return;
            var e = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF,
                t = this._canMoveToMap = {};
            t[e.BUDDY_LEVEL] = function() {
                return !0
            }, t[e.PUSH_NOTIFICATION] = function() {
                return !1
            }, t[e.LOGIN] = function() {
                return !1
            }, t[e.CLEAR_SPECIFIC_DUNGEON] = function() {
                return !0
            }, t[e.GACHA] = function() {
                return !0
            }, t[e.CLEAR_DUNGEON_BY_TYPE] = function() {
                return !0
            }, t[e.ENHANCE] = function() {
                return !0
            }, t[e.EVOLVE] = function() {
                return !0
            }, t[e.ABILITY_GENERATE] = function() {
                return !0
            }, t[e.ABILITY_UPGRADE] = function() {
                return !0
            }, t[e.EXCHANGE_SHOP] = function() {
                return !0
            }
        },
        getFragment: function() {
            return this._setupGetFragmentMap(), this._getFragmentMap[this.get("achieve_cond_type")]()
        },
        _setupGetFragmentMap: function() {
            if (this._getFragmentMap) return;
            var e = this._getFragmentMap = {},
                t = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF;
            e[t.BUDDY_LEVEL] = function() {
                return "#world"
            }, e[t.PUSH_NOTIFICATION] = function() {
                return null
            }, e[t.LOGIN] = function() {
                return null
            }, e[t.CLEAR_SPECIFIC_DUNGEON] = function() {
                return null
            }, e[t.GACHA] = function() {
                return "#gacha"
            }, e[t.CLEAR_DUNGEON_BY_TYPE] = function() {
                var e = FF.CONST.SERVER.WORLD.TYPE_OF,
                    t = this.get("achieve_cond_arg1"),
                    n = this.get("achieve_cond_arg3");
                switch (t) {
                    case e.NORMAL:
                    default:
                        return "#world";
                    case e.EVENT:
                        return this._getEventFragment(n)
                }
            }.bind(this), e[t.ENHANCE] = function() {
                return "#party/enhancement_top"
            }, e[t.EVOLVE] = function() {
                return "#party/enhancement_top"
            }, e[t.ABILITY_GENERATE] = function() {
                return "#party/enhancement_top"
            }, e[t.ABILITY_UPGRADE] = function() {
                return "#party/enhancement_top"
            }, e[t.EXCHANGE_SHOP] = function() {
                return "#ritual_room/top"
            }
        },
        _getEventFragment: function(e) {
            var t = FF.CONST.SERVER.EVENT.TYPE_OF;
            switch (e) {
                case t.EXTREME:
                    return "#event/extreme/world_list";
                default:
                    return "#events"
            }
        },
        getMoveToLabel: function() {
            return this._setupGetMoveToLabelMap(), this._getMoveToLabelMap[this.get("achieve_cond_type")]()
        },
        _setupGetMoveToLabelMap: function() {
            if (this._getMoveToLabelMap) return;
            var e = this._getMoveToLabelMap = {},
                t = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF;
            e[t.BUDDY_LEVEL] = function() {
                return i.TO_WORLD
            }, e[t.PUSH_NOTIFICATION] = function() {
                return null
            }, e[t.LOGIN] = function() {
                return null
            }, e[t.CLEAR_SPECIFIC_DUNGEON] = function() {
                return i.TO_DUNGEON
            }, e[t.GACHA] = function() {
                return i.TO_GACHA
            }, e[t.CLEAR_DUNGEON_BY_TYPE] = function() {
                var e = FF.CONST.SERVER.WORLD.TYPE_OF,
                    t = this.get("achieve_cond_arg1"),
                    n = this.get("achieve_cond_arg3");
                switch (t) {
                    case e.NORMAL:
                    default:
                        return i.TO_WORLD;
                    case e.EVENT:
                        return this._getEventMoveToLabel(n)
                }
            }.bind(this), e[t.ENHANCE] = function() {
                return i.TO_EQUIPMENT
            }, e[t.EVOLVE] = function() {
                return i.TO_EQUIPMENT
            }, e[t.ABILITY_GENERATE] = function() {
                return i.TO_EQUIPMENT
            }, e[t.ABILITY_UPGRADE] = function() {
                return i.TO_EQUIPMENT
            }, e[t.EXCHANGE_SHOP] = function() {
                return i.TO_EXCHANGE_SHOP
            }
        },
        _getEventMoveToLabel: function(e) {
            var t = FF.CONST.SERVER.EVENT.TYPE_OF;
            switch (e) {
                case t.EXTREME:
                    return i.TO_EXTREME;
                default:
                    return i.TO_EVENT
            }
        },
        hasRemapGrowEgg: function() {
            var e = this.get("remap_item");
            if (!e) return !1;
            if (e.type_name !== "GROW_EGG") throw new Error("invalid remapItem id: %d, type: %s)", e.id, e.type_name);
            return !0
        },
        getRemapItem: function() {
            return this.get("remap_item")
        },
        isTargetExtreme: function() {
            return this.isAchieveTypeClearDungeonByType() && this.get("achieve_cond_arg1") === s
        },
        isExtremeWorldOpen: function() {
            return r.isExtremeWorldOpen()
        }
    })
}), define("scenes/common/models/Dungeon", ["backbone", "util", "lib/TextMaster", "lib/Model", "./Mission"], function(e, t, n, r, i) {
    var s = r.extend({
        isOpened: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        isClosed: function() {
            var e = t.getTimeAsSec();
            return this.get("closed_at") <= e
        },
        isForce: function() {
            return this.get("type") === FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE
        },
        getWorldModel: function() {
            return FF.datastore.worldCollection.get(+this.get("world_id"))
        },
        isAcquisitionByPrizeType: function(e) {
            return +e === +FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_MASTER ? this.get("is_master") : this.get("is_clear")
        },
        hasPrizeByTypeName: function(e) {
            if (!_.has(FF.CONST.SERVER.ITEM.TYPE_OF, e)) throw new Error("unknown item type name: " + e);
            var t = this.get("prizes");
            return t = _.flatten(_.values(t), !0), _.some(t, function(t) {
                return t.type_name === e
            })
        },
        hasBuddyPrize: function() {
            return this.hasPrizeByTypeName("BUDDY")
        },
        getDisplayAblePrizes: function() {
            var e = ["BUDDY", "MEMORY_CRYSTAL", "DRESS_RECORD"],
                t = FF.CONST.SERVER.ITEM.RITUAL_ROOM_ITEM_ID_OF,
                n = [t.BUDDY_SOUL, t.MEMORY_CRYSTAL_1, t.MEMORY_CRYSTAL_2],
                r = [],
                i = this.get("prizes");
            return i = _.flatten(_.values(i), !0), _.each(n, function(e) {
                _.each(i, function(t) {
                    t.id === e && r.push(t)
                })
            }), _.each(e, function(e) {
                _.each(i, function(t) {
                    t.type_name === e && r.push(t)
                })
            }), r
        },
        getSortedDungeonPrizes: function() {
            var e = this.get("prizes"),
                t = FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF;
            return _.map([t.CLEAR, t.FIRST_MASTER, t.FIRST_CLEAR], function(t) {
                var n = _.sortBy(e[t], function(e) {
                    return e.id
                });
                return {
                    type: t,
                    items: n
                }
            })
        },
        getFirstMasterPrizes: function() {
            var e = this.get("prizes")[FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_MASTER];
            return _.sortBy(e, function(e) {
                return e.id
            })
        },
        getFirstClearPrizes: function() {
            var e = this.get("prizes")[FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_CLEAR];
            return _.sortBy(e, function(e) {
                return e.id
            })
        },
        getClearPrizes: function() {
            var e = this.get("prizes")[FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.CLEAR];
            return _.sortBy(e, function(e) {
                return e.id
            })
        },
        hasPrologue: function() {
            return this.get("prologue") && this.getWorldModel().isNormalWorld() ? !0 : !1
        },
        getSmallProloguePath: function() {
            return this.get("prologue_image_path").replace(/\.png$/, "_240.png")
        },
        hasCaptures: function() {
            var e = this.get("captures");
            return e && e.length > 0
        },
        hasMultiCaptures: function() {
            var e = this.get("captures");
            return 1 < e.length
        },
        getCaptures: function() {
            return this.get("captures")
        },
        getOpenedMissionModels: function() {
            return _.map(this.get("missions"), function(e) {
                var t = FF.datastore.missionCollection.get(e.id);
                return t ? t : new i(e)
            }).filter(function(e) {
                return e.isOpen()
            })
        },
        getDisplayChallengeLevel: function() {
            return this.get("challenge_level") === 0 ? FF.TextMaster.get("unknown_dungeon_challenge_level") : this.get("challenge_level")
        },
        getUnlockConditionDungeonModels: function() {
            var e = this,
                t = {};
            return _.each(this.get("unlock_conditions"), function(n, r) {
                var i = e.collection.get(+r);
                if (!i) throw new Error("Missing unlock cond dungeon model " + r);
                t[r] = {
                    model: i,
                    type: n
                }
            }), t
        },
        getStatusBonusOpt: function() {
            return {
                seriesId: this.get("series_id"),
                abilityCategoryBonusMap: this.get("ability_category_bonus_map")
            }
        }
    });
    return s
}), define("scenes/common/models/DungeonSession", ["backbone", "util", "lib/Model"], function(e, t, n) {
    return n.extend({
        isInDungeon: function() {
            return this.hasAttributes()
        },
        isInEventDungeon: function() {
            return this.isInDungeon() && this.getWorldModel().isEventWorld()
        },
        isInEventDungeonExceptingExtremeDungeons: function() {
            return this.isInEventDungeon() && !this.isInExtremeDungeon()
        },
        isInExtremeDungeon: function() {
            if (!this.isInDungeon()) return !1;
            var e = this.getWorldModel().getEventModel();
            return e && e.isEventTypeExtreme()
        },
        isInNormalDungeon: function() {
            return this.isInDungeon() && this.getWorldModel().isNormalWorld()
        },
        isInBattle: function() {
            return this.get("is_in_battle")
        },
        getWorldModel: function() {
            if (!this.isInDungeon()) throw new Error("not in dungeon");
            return FF.datastore.worldCollection.get(this.get("world_id"))
        },
        isOpenedToClosedTerm: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        canBeginBattleTerm: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("kept_out_at") > e
        },
        isKeptOutToClosedTerm: function() {
            var e = t.getTimeAsSec();
            return this.get("kept_out_at") <= e && this.get("closed_at") > e
        },
        isFullSupporterSsGauge: function() {
            return this.get("supporter_ss_gauge") === this.get("max_supporter_ss_gauge")
        },
        isAcquisitionByPrizeType: function(e) {
            return +e === +FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF.FIRST_MASTER ? this.get("is_master") : this.get("is_clear")
        },
        getSortedDungeonPrizes: function() {
            var e = this.get("prizes"),
                t = FF.CONST.SERVER.DUNGEON.PRIZE_TYPE_OF;
            return _.map([t.CLEAR, t.FIRST_MASTER, t.FIRST_CLEAR], function(t) {
                var n = _.sortBy(e[t], function(e) {
                    return e.id
                });
                return {
                    type: t,
                    items: n
                }
            })
        },
        hasCaptures: function() {
            var e = this.get("captures");
            return e && e.length > 0
        },
        getCaptures: function() {
            return this.get("captures")
        },
        clearBattleSession: function() {
            this.set("session_key", null), this.set("is_in_battle", null), this.set("is_expired", null)
        },
        getUpdateProgressEffectFlag: function() {
            var e = this.get("should_show_progress_effect");
            return this.set("should_show_progress_effect", !1), e
        },
        getStatusBonusOpt: function() {
            return {
                seriesId: this.get("series_id"),
                abilityCategoryBonusMap: this.get("ability_category_bonus_map")
            }
        }
    })
}), define("scenes/common/models/Profile", ["jquery", "underscore", "util", "lib/Model"], function(e, t, n, r) {
    var i = {
        RESONATABLE_KEYS: ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp", "spd"]
    };
    return r.extend({
        idAttribute: "user_id",
        getUserId: function() {
            return this.get("user_id")
        },
        getNickname: function() {
            return this.get("nickname")
        },
        getProfileMessage: function() {
            return this.get("profile_message")
        },
        getLastLoggedInStr: function() {
            var r = n.getTimeAsSec(),
                i = this.get("last_logged_in_at") > 0 ? r - this.get("last_logged_in_at") : void 0,
                s = e("#profile-last-logged-in-template").text();
            return t.template(s, {
                diffTimeAsSec: i
            })
        },
        isNewRelation: function() {
            return this.get("is_new_relation")
        },
        getSupporterBuddyId: function() {
            return this.get("supporter_buddy_id")
        },
        getSupporterBuddyModel: function() {
            var e = this.getSupporterBuddyId();
            return FF.datastore.buddyCollection.findWhere({
                buddy_id: e
            })
        },
        getSupporterBuddyModelId: function() {
            return this.getSupporterBuddyModel().get("id")
        },
        getSupporterBuddyLevel: function() {
            return this.get("supporter_buddy_level")
        },
        getSupporterBuddyJobName: function() {
            return this.get("supporter_buddy_job_name")
        },
        getSpStatusNameOf: function(e) {
            return t.contains(i.RESONATABLE_KEYS, e) ? "supporter_buddy_sp_" + e : "supporter_buddy_" + e
        },
        getParamOf: function(e, t) {
            return this.isRisenByStatusBonus(e) ? this.get(this.getSpStatusNameOf(e)) : this.get("supporter_buddy_" + e)
        },
        getSupporterBuddyHp: function() {
            return this.get("supporter_buddy_hp")
        },
        getSupporterBuddySpd: function() {
            return this.get("supporter_buddy_spd")
        },
        getSupporterBuddyAtk: function() {
            return this.get("supporter_buddy_atk")
        },
        getSupporterBuddyDef: function() {
            return this.get("supporter_buddy_def")
        },
        getSupporterBuddyMatk: function() {
            return this.get("supporter_buddy_matk")
        },
        getSupporterBuddyMdef: function() {
            return this.get("supporter_buddy_mdef")
        },
        getSupporterBuddyMnd: function() {
            return this.get("supporter_buddy_mnd")
        },
        getSupporterBuddyAcc: function() {
            return this.get("supporter_buddy_acc")
        },
        getSupporterBuddyEva: function() {
            return this.get("supporter_buddy_eva")
        },
        hasSeriesBonusSupporterBuddy: function(e) {
            return this.isSameSeriesSupporterBuddy(e)
        },
        hasSeriesBonus: function(e) {
            return this.isSameSeriesSupporterBuddy(e)
        },
        isSameSeriesSupporterBuddy: function(e) {
            return this.get("supporter_buddy_series_id") === e
        },
        hasRoleBonus: function(e) {
            if (!e || t.isEmpty(e)) return !1;
            var n = this.get("supporter_buddy_ability_category");
            for (var r in e) {
                var i = n[r];
                if (!i) continue;
                var s = e[r];
                if (i.rarity >= s.rarity) return !0
            }
            return !1
        },
        getStatusBonusOpt: function(e) {
            var n = this.hasSeriesBonus(e.seriesId),
                r = this.hasRoleBonus(e.abilityCategoryBonusMap);
            return t.extend({
                hasSeriesBonus: n,
                hasRoleBonus: r
            }, e)
        },
        getLeadBuddySeriesId: function() {
            return this.get("lead_buddy_series_id")
        },
        getSupporterBuddySeriesId: function() {
            return this.get("supporter_buddy_series_id")
        },
        getSupporterBuddyEvolutionNum: function() {
            return this.get("supporter_buddy_evolution_num")
        },
        getSupporterBuddySeriesHp: function() {
            return this.get("supporter_buddy_sp_hp")
        },
        getSupporterBuddySeriesSpd: function() {
            return this.get("supporter_buddy_sp_spd")
        },
        getSupporterBuddySeriesAtk: function() {
            return this.get("supporter_buddy_sp_atk")
        },
        getSupporterBuddySeriesDef: function() {
            return this.get("supporter_buddy_sp_def")
        },
        getSupporterBuddySeriesMatk: function() {
            return this.get("supporter_buddy_sp_matk")
        },
        getSupporterBuddySeriesMdef: function() {
            return this.get("supporter_buddy_sp_mdef")
        },
        getSupporterBuddySeriesMnd: function() {
            return this.get("supporter_buddy_sp_mnd")
        },
        getSupporterBuddySeriesAcc: function() {
            return this.get("supporter_buddy_sp_acc")
        },
        getSupporterBuddySeriesEva: function() {
            return this.get("supporter_buddy_sp_eva")
        },
        getSupporterBuddyImagePath: function() {
            return this.get("supporter_buddy_image_path")
        },
        isRisenByStatusBonus: function(e) {
            return this.get(this.getSpStatusNameOf(e)) > this.get("supporter_buddy_" + e)
        },
        isRisenBySeriesBonus: function(e, t) {
            if (!t) return !1;
            var n = t.seriesId;
            return !n || n === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : this.isRisenByStatusBonus(e)
        },
        isRisenByRoleBonus: function(e, t) {
            return t ? t.hasRoleBonus ? this.isRisenByStatusBonus(e) : !1 : !1
        },
        isRisenHpBySeries: function() {
            return this.getSupporterBuddySeriesHp() > this.getSupporterBuddyHp()
        },
        isRisenSpdBySeries: function() {
            return this.getSupporterBuddySeriesSpd() > this.getSupporterBuddySpd()
        },
        isRisenAtkBySeries: function() {
            return this.getSupporterBuddySeriesAtk() > this.getSupporterBuddyAtk()
        },
        isRisenDefBySeries: function() {
            return this.getSupporterBuddySeriesDef() > this.getSupporterBuddyDef()
        },
        isRisenMatkBySeries: function() {
            return this.getSupporterBuddySeriesMatk() > this.getSupporterBuddyMatk()
        },
        isRisenMdefBySeries: function() {
            return this.getSupporterBuddySeriesMdef() > this.getSupporterBuddyMdef()
        },
        isRisenMndBySeries: function() {
            return this.getSupporterBuddySeriesMnd() > this.getSupporterBuddyMnd()
        },
        isRisenAccBySeries: function() {
            return this.getSupporterBuddySeriesAcc() > this.getSupporterBuddyAcc()
        },
        isRisenEvaBySeries: function() {
            return this.getSupporterBuddySeriesEva() > this.getSupporterBuddyEva()
        },
        isEquipWeapon: function() {
            return this.get("supporter_buddy_weapon_id") !== 0
        },
        getSupporterBuddyWeaponId: function() {
            return this.get("supporter_buddy_weapon_id")
        },
        getSupporterBuddyWeaponMaxLevel: function() {
            return this.get("supporter_buddy_weapon_max_level")
        },
        getSupporterBuddyWeaponLevel: function() {
            return this.get("supporter_buddy_weapon_level")
        },
        getSupporterBuddyWeaponName: function() {
            return this.get("supporter_buddy_weapon_name")
        },
        getSupporterBuddyWeaponHammeringNum: function() {
            return this.get("supporter_buddy_weapon_hammering_num")
        },
        getSupporterBuddyWeaponMaxHammeringNum: function() {
            return this.get("supporter_buddy_weapon_max_hammering_num")
        },
        isSameSeriesSupporterBuddyWeapon: function(e) {
            return this.get("supporter_buddy_weapon_series_id") === e || this.get("supporter_buddy_weapon_ex_series_id") === e
        },
        getSupporterBuddyWeaponImagePath: function() {
            return this.get("supporter_buddy_weapon_image_path")
        },
        isEquipArmor: function() {
            return this.get("supporter_buddy_armor_id") !== 0
        },
        getSupporterBuddyArmorId: function() {
            return this.get("supporter_buddy_armor_id")
        },
        getSupporterBuddyArmorMaxLevel: function() {
            return this.get("supporter_buddy_armor_max_level")
        },
        getSupporterBuddyArmorLevel: function() {
            return this.get("supporter_buddy_armor_level")
        },
        getSupporterBuddyArmorName: function() {
            return this.get("supporter_buddy_armor_name")
        },
        getSupporterBuddyArmorHammeringNum: function() {
            return this.get("supporter_buddy_armor_hammering_num")
        },
        getSupporterBuddyArmorMaxHammeringNum: function() {
            return this.get("supporter_buddy_armor_max_hammering_num")
        },
        isSameSeriesSupporterBuddyArmor: function(e) {
            return this.get("supporter_buddy_armor_series_id") === e || this.get("supporter_buddy_armor_ex_series_id") === e
        },
        getSupporterBuddyArmorImagePath: function() {
            return this.get("supporter_buddy_armor_image_path")
        },
        isEquipAccessory: function() {
            return this.get("supporter_buddy_accessory_id") !== 0
        },
        getSupporterBuddyAccessoryId: function() {
            return this.get("supporter_buddy_accessory_id")
        },
        getSupporterBuddyAccessoryMaxLevel: function() {
            return this.get("supporter_buddy_accessory_max_level")
        },
        getSupporterBuddyAccessoryLevel: function() {
            return this.get("supporter_buddy_accessory_level")
        },
        getSupporterBuddyAccessoryName: function() {
            return this.get("supporter_buddy_accessory_name")
        },
        isSameSeriesSupporterBuddyAccessory: function(e) {
            return this.get("supporter_buddy_accessory_series_id") === e || this.get("supporter_buddy_accessory_ex_series_id") === e
        },
        getSupporterBuddyAccessoryImagePath: function() {
            return this.get("supporter_buddy_accessory_image_path")
        },
        getSupporterBuddySoulStrikeId: function() {
            return this.get("supporter_buddy_soul_strike_id")
        },
        getSupporterBuddySoulStrikeName: function() {
            return this.get("supporter_buddy_soul_strike_name")
        },
        getSupporterBuddySoulStrikeDescription: function() {
            return this.get("supporter_buddy_soul_strike_description")
        },
        getSupporterBuddySoulStrikeImagePath: function() {
            return this.get("supporter_buddy_soul_strike_image_path")
        },
        getSupporterBuddySoulStrikeConsumeSSGauge: function() {
            return this.get("supporter_buddy_soul_strike_consume_ss_gauge")
        },
        getSupporterBuddyDefaultSoulStrikeId: function() {
            return this.getSupporterBuddyModel().get("default_soul_strike_id")
        },
        getSupporterBuddyEquipmentIds: function() {
            return t.compact([this.getSupporterBuddyWeaponId(), this.getSupporterBuddyArmorId(), this.getSupporterBuddyAccessoryId()])
        },
        getSupporterBuddyEquipmentModelsByIds: function(e) {
            return t.map(e, function(e) {
                FF.datastore.equipmentCollection.get(e)
            })
        },
        getSupporterBuddySoulStrikeModelsByEquipmentModels: function(e) {
            var n = t.compact(t.map(e, function(e) {
                return e.get("soul_strike_id")
            }));
            n.push(this.getSupporterBuddyDefaultSoulStrikeId()), n = t.uniq(n);
            var r = t.compact(t.map(n, function(e) {
                return FF.datastore.soulStrikeCollection.get(e)
            }));
            return r
        },
        getSupporterBuddySoulStrikeModels: function() {
            var e = this.getSupporterBuddyEquipmentIds(),
                t = this.getSupporterBuddyEquipmentModelsByIds(e);
            return this.getSupporterBuddySoulStrikeModelsByEquipmentModels(t)
        },
        isSupporterBuddySsTypeDefault: function() {
            var e = this.get("supporter_buddy_soul_strike_type");
            return FF.CONST.SERVER.SOUL_STRIKE.TYPE.standard === e
        },
        isSupporterBuddySsTypeShared: function() {
            var e = this.get("supporter_buddy_soul_strike_type");
            return FF.CONST.SERVER.SOUL_STRIKE.TYPE.shared === e
        },
        isSupporterBuddySsTypeSomeones: function() {
            var e = this.get("supporter_buddy_soul_strike_type");
            return FF.CONST.SERVER.SOUL_STRIKE.TYPE.someones === e
        },
        getSupporterBuddyRecordMateriaId: function() {
            return this.get("supporter_buddy_record_materia_id")
        },
        getSupporterBuddyRecordMateriaName: function() {
            return this.get("supporter_buddy_record_materia_name")
        },
        getSupporterBuddyRecordMateriaDescription: function() {
            return this.get("supporter_buddy_record_materia_description")
        },
        isFollower: function() {
            return this.isBeforeLoad() ? this.getPreloadedAttribute("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWER : this.get("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWER
        },
        isFollowee: function() {
            return this.isBeforeLoad() ? this.getPreloadedAttribute("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWEE : this.get("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWEE
        },
        isFriend: function() {
            return this.isBeforeLoad() ? this.getPreloadedAttribute("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FRIEND : this.get("relation_status") === FF.CONST.SERVER.RELATION.STATUS_OF.FRIEND
        },
        resetIsNewRelation: function() {
            return this.set("is_new_relation", !1)
        },
        isViaBattle: function() {
            return this.get("via_battle")
        },
        isBeforeLoad: function() {
            return !!this._preloadedAttributes
        },
        getPreloadedAttribute: function(e) {
            return this._preloadedAttributes[e]
        },
        getPreloadedAttributes: function() {
            return this._preloadedAttributes
        },
        setPreloadedAttributes: function(e) {
            this._preloadedAttributes = e
        },
        setWithMergePreloadedAttributes: function(e) {
            this.set(t.extend(e, this.getPreloadedAttributes())), this._preloadedAttributes = void 0
        }
    })
}), define("scenes/common/models/FellowSession", ["backbone", "util", "lib/Model", "./Profile"], function(e, t, n, r) {
    return n.extend({
        hasFellow: function() {
            return !!this.get("has_fellow")
        },
        canRemakeFellowList: function() {
            return !!this.get("can_remake_fellow_list")
        },
        canFollow: function() {
            return !!this.get("can_follow")
        },
        isStatusOf: function(e) {
            return this.get("status") === FF.CONST.SERVER.FELLOW_SESSION.STATUS_OF[e]
        },
        isFinishable: function() {
            return this.isStatusOf("STAMINA_USED")
        },
        createFellowProfileModel: function() {
            if (!this.hasFellow()) return void 0;
            var e = new r;
            return e.set(this.get("fellow_profile")), e
        }
    })
}), define("scenes/common/Constant", [], function() {
    return {
        EQUIPMENT: {
            TYPE_NAME_OF: {
                WEAPON: "weapon",
                ARMOR: "armor",
                ACCESSORY: "accessory",
                HAMMERING: "hammering"
            },
            PARAM_OPTION_CALC_BOOST_STATUS: {
                calcBoostStatus: !0
            }
        },
        DATA_APP_OF: {
            BTN_BACK: "data-app-btn-back"
        },
        CSS_VALUE: {
            SCROLL_FACE_HEIGHT: 31
        },
        COOKIE_KEYS: {
            ORDER_BY_PAGE_KEY: {
                ABILITY: "order_type_of_ability",
                ABILITY_UPGRADE: "order_type_of_ability_upgrade",
                ABILITY_GENERATION: "order_type_of_ability_generation",
                ABILITY_CHANGE_DETAIL: "order_type_of_ability_change_detail",
                ABILITY_DECOMPOSE: "order_type_of_ability_decompose",
                BUDDY_EVOLUTION: "order_type_of_buddy_evolution",
                EVOLUTION: "order_type_of_evolution",
                ENHANCEMENT: "order_type_of_enhancement",
                ENHANCEMENT_SELECTED: "order_type_of_enhancement_selected",
                EQUIPMENT: "order_type_of_equipment",
                EQUIPMENT_CHANGE_DETAIL_WEAPON: "order_type_of_equipment_change_detail_weapon",
                EQUIPMENT_CHANGE_DETAIL_ARMOR: "order_type_of_equipment_change_detail_armor",
                EQUIPMENT_CHANGE_DETAIL_ACCESSORY: "order_type_of_equipment_change_detail_accessory",
                INVENTORY_EQUIPMENT: "order_type_of_inventory_equipment",
                INVENTORY_ABILITY: "order_type_of_inventory_ability",
                INVENTORY_MATERIAL: "order_type_of_inventory_material",
                INVENTORY_GROW_EGG: "order_type_of_inventory_grow_egg",
                PARTY: "order_type_of_buddy_on_the_bench",
                PARTY_EDIT: "order_type_of_equipment_party_edit",
                RECORD_MATERIA: "order_type_of_record_materia",
                RECORD_MATERIA_CHANGE_DETAIL: "order_type_of_record_materia_change_detail",
                RECORD_MATERIA_LIST: "order_type_of_record_materia_list",
                USER_SUPPORTER_BUDDY_EDIT: "order_type_of_user_supporter_buddy_edit",
                USER_SUPPORTER_BUDDY_EQUIPMENT_CHANGE_DETAIL_WEAPON: "order_type_of_equipment_change_detail_weapon",
                USER_SUPPORTER_BUDDY_EQUIPMENT_CHANGE_DETAIL_ARMOR: "order_type_of_equipment_change_detail_armor",
                USER_SUPPORTER_BUDDY_EQUIPMENT_CHANGE_DETAIL_ACCESSORY: "order_type_of_equipment_change_detail_accessory"
            },
            EVENT_QUEST_LAST_VIEWED_AT: "event_quest_last_viewed_at",
            REAL_QUEST_LAST_VIEWED_AT: "real_quest_last_viewed_at",
            DESIGN_TYPE_OF: {
                PARTY: "design_type_of_party"
            },
            SORT_MODULE: {
                SORT_PREFIX: "sort_module:sort_of_",
                ORDER_PREFIX: "sort_module:order_of_",
                PRIOR_SERIES_PREFIX: "sort_module:prior_series_of_",
                CHARA_ROLE_PREFIX: "sort_module:chara_role_of_",
                ABILITY_TYPE_PREFIX: "sort_module:ability_type_of_",
                RESONANCE_PREFIX: "sort_module:resonance_of_",
                LAST_TAB: "sort_module:last_tab"
            },
            LEAD_TO_SECOND_DUNGEON: "lead_to_second_dungeon"
        },
        OVERSCROLL_NUMS: {
            TILE: 40,
            BUDDY_TILE: 50,
            PROFILE_TILE: 5,
            RECORD_MATERIA_TILE: 10,
            BUTTON: 20,
            EQUIP_TILE: 27,
            PARTY_EDIT_TILE: 42,
            BUDDY_WIDE_LIST: 20,
            INFINIT: 99999
        },
        REVIEW_ID_OF: {
            BANNER: 999999
        },
        PAYMENT_ERROR_CODE_OF: {
            PURCHASING_COIN_FAILED: 10002,
            PURCHASING_COIN_CANCELED: 10003
        },
        FOLLOW_SCENE_ID_OF: {
            AFTER_DUNGEON: 1,
            INVITE_ID_SEARCH: 2,
            FOLLOWER_LIST: 3
        },
        PARTY_TOP_SUB_CATEGORY: {
            EQUIPMENT: 1,
            SOULSTRIKE: 2,
            ABILITY: 3,
            RECORD_MATERIA: 4
        },
        BUDDY_LIST_DESIGN_TYPE_OF: {
            ICON: 1,
            WIDE: 2
        },
        FF_PORTAL_URL: {
            IOS: {
                LAUNCH_URL: "com.square-enix.ffportal://open",
                STORE_URL: "itms-apps://itunes.apple.com/app/id933144512?mt=8"
            },
            ANDROID: {
                LAUNCH_URL: "com.square-enix.ffportal.googleplay://open",
                STORE_URL: "market://details?id=com.square_enix.ffportal.googleplay"
            }
        },
        GENERAL_ORDER_TYPE_OF: {
            DESC: "desc",
            ASC: "asc"
        },
        SORT_MODULE: {
            ORDER_DESC_TYPE_OF: {
                NONE: "none",
                VALUE_TYPE: "valueType",
                DATE_TYPE: "dateType"
            },
            SUB_SORT_TYPE_OF: {
                NONE: "none",
                ASC_OR_DESC: "ascOrDesc",
                SERIES_ID: "seriesId",
                CHARA_ROLE: "charaRole",
                ABILITY: "ability"
            }
        },
        EVENT_ID_OF: {},
        WORLD_ID_OF: {},
        SERVER_MOVIE_PATH: "video/%s.m4v"
    }
}), define("scenes/common/models/Buddy/Equipment", [], function() {
    return {
        initializeEquipment: function() {
            this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ACCESSORY, this.get("accessory_id")), this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ARMOR, this.get("armor_id")), this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.WEAPON, this.get("weapon_id")), this._setTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.HAMMERING, 0), this.equipmentTypeNameToId = _.clone(this.tmpEquipmentTypeNameToId), this.equipmentModelMap = this.getEquipmentModelMap()
        },
        canEquipCategory: function(e) {
            return this.get("equipment_category")[e] ? !0 : !1
        },
        setTmpAccessoryId: function(e) {
            this.setTmpEquipmentId(_.extend(e, {
                typeName: this.TYPE_NAME_OF.ACCESSORY
            }))
        },
        setTmpArmorId: function(e) {
            this.setTmpEquipmentId(_.extend(e, {
                typeName: this.TYPE_NAME_OF.ARMOR
            }))
        },
        setTmpWeaponId: function(e) {
            this.setTmpEquipmentId(_.extend(e, {
                typeName: this.TYPE_NAME_OF.WEAPON
            }))
        },
        setTmpEquipmentId: function(e) {
            var t = e.typeName,
                n = e.equipmentId || 0,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().equipmentCollection.get(n) : null,
                o = void 0;
            this.clearTmpInUseBy({
                typeName: t,
                dryrun: r
            });
            var u = s ? s.get(this.getTmpInUseByName()) : null;
            if (u) {
                var a = u.buddyId,
                    f = u.typeName;
                o = this.getDatastore().buddyCollection.get(a), r || (o._setTmpEquipmentIdByTypeName(f, 0), o._takeOffSoulStrikeIfNeed(s.get("soul_strike_id")))
            }
            return r || this._setTmpEquipmentIdByTypeName(t, n), !r && s && this.setTmpInUseBy({
                equipmentModel: s,
                typeName: t
            }), this.isSetTmpEquipmentByRecommend = i ? !0 : !1, {
                equippingBuddy: o
            }
        },
        getAccessoryId: function() {
            return this.getEquipmentIdByTypeName(this.TYPE_NAME_OF.ACCESSORY)
        },
        getArmorId: function() {
            return this.getEquipmentIdByTypeName(this.TYPE_NAME_OF.ARMOR)
        },
        getWeaponId: function() {
            return this.getEquipmentIdByTypeName(this.TYPE_NAME_OF.WEAPON)
        },
        getEquipmentIdByTypeName: function(e) {
            return this.equipmentTypeNameToId[e]
        },
        getEquipmentModelByTypeName: function(e) {
            var t = this.getEquipmentIdByTypeName(e),
                n = t ? this.getDatastore().equipmentCollection.get(t) : null;
            return n
        },
        getTmpAccessoryId: function() {
            return this.getTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ACCESSORY)
        },
        getTmpArmorId: function() {
            return this.getTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.ARMOR)
        },
        getTmpWeaponId: function() {
            return this.getTmpEquipmentIdByTypeName(this.TYPE_NAME_OF.WEAPON)
        },
        getTmpEquipmentIdByTypeName: function(e) {
            return this.tmpEquipmentTypeNameToId[e]
        },
        getRecommendedAccessoryId: function(e) {
            return FF.datastore.equipmentCollection.getRecommendedAccessoryId(this, e)
        },
        getRecommendedArmorId: function(e) {
            return FF.datastore.equipmentCollection.getRecommendedArmorId(this, e)
        },
        getRecommendedWeaponId: function(e) {
            return FF.datastore.equipmentCollection.getRecommendedWeaponId(this, e)
        },
        getRecommendedAccessoryModel: function(e) {
            var t = this.getRecommendedAccessoryId(e);
            return t ? FF.datastore.equipmentCollection.get(t) : null
        },
        getRecommendedArmorModel: function(e) {
            var t = this.getRecommendedArmorId(e);
            return t ? FF.datastore.equipmentCollection.get(t) : null
        },
        getRecommendedWeaponModel: function(e) {
            var t = this.getRecommendedWeaponId(e);
            return t ? FF.datastore.equipmentCollection.get(t) : null
        },
        _setTmpEquipmentIdByTypeName: function(e, t) {
            var n = this.getTmpEquipmentModelByTypeName(e),
                r = n ? n.getSoulStrikeModel() : null,
                i = r ? this.getTmpSlotBySoulStrikeId(r.get("id")) : null,
                s = !1;
            if (r) {
                var o = r.get("id");
                s = this._hasSameSoulStrikeIdInTmpEquip(o)
            }
            if (i && !r.isMastered() && !s) {
                var u = this.getTmpSoulStrikeModels(),
                    a = _.compact(u).length === 1,
                    f = a ? this.getDefaultSoulStrikeModel().get("id") : 0;
                this.setTmpSoulStrikeId({
                    slot: i,
                    soulStrikeId: f
                }), this.sortTmpSoulStrikeIds()
            }
            this.tmpEquipmentTypeNameToId[e] = t
        },
        _hasSameSoulStrikeIdInTmpEquip: function(e) {
            var t = this.getTmpEquipmentModelMap();
            return _.filter(t, function(t) {
                if (t) {
                    var n = t.getSoulStrikeModel();
                    if (n) return n.get("id") === e
                }
            }).length > 1
        },
        getTmpEquipmentModelByTypeName: function(e) {
            var t = this.getTmpEquipmentIdByTypeName(e),
                n = t ? this.getDatastore().equipmentCollection.get(t) : null;
            return n
        },
        fixTmpEquipments: function() {
            var e = this;
            if (!this.hasChangedEquipmentId()) return;
            this.equipmentTypeNameToId = _.clone(this.tmpEquipmentTypeNameToId), this.equipmentModelMap = this.getEquipmentModelMap(), _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                var n = e.tmpEquipmentTypeNameToId[t];
                e.set(t + "_id", n)
            })
        },
        resetTmpEquipments: function() {
            if (!this.hasChangedEquipmentId()) return;
            this.tmpEquipmentTypeNameToId = _.clone(this.equipmentTypeNameToId), this.isSetTmpEquipmentByRecommend = !1, this.resetTmpSoulStrikes()
        },
        getEquipmentModelMap: function() {
            return this.getEquipmentModelMapByTypeNameToId(this.equipmentTypeNameToId)
        },
        getTmpEquipmentModelMap: function() {
            return this.getEquipmentModelMapByTypeNameToId(this.tmpEquipmentTypeNameToId)
        },
        getEquipmentModelMapByTypeNameToId: function(e) {
            var t = this,
                n = this.getDatastore().equipmentCollection,
                r = {};
            return _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                var i = e[t],
                    s = i ? n.get(i) : null;
                r[t] = s
            }), r
        },
        hasChangedEquipmentId: function() {
            return this.getWeaponId() !== this.getTmpWeaponId() ? !0 : this.getArmorId() !== this.getTmpArmorId() ? !0 : this.getAccessoryId() !== this.getTmpAccessoryId() ? !0 : !1
        },
        takeOffAllEquipments: function() {
            this.takeOffAccessory(), this.takeOffArmor(), this.takeOffWeapon()
        },
        takeOffAccessory: function() {
            this.setTmpAccessoryId({
                equipmentId: 0
            })
        },
        takeOffArmor: function() {
            this.setTmpArmorId({
                equipmentId: 0
            })
        },
        takeOffWeapon: function() {
            this.setTmpWeaponId({
                equipmentId: 0
            })
        }
    }
}), define("scenes/common/models/Buddy/Ability", [], function() {
    return {
        initializeAbility: function() {
            this.setTmpAbilityIdBySlot(1, this.get("ability_1_id")), this.setTmpAbilityIdBySlot(2, this.get("ability_2_id")), this.abilitySlotToId = _.clone(this.tmpAbilitySlotToId), this.abilities = this.getAbilityModels()
        },
        setTmpAbilityId: function(e) {
            var t = e.slot,
                n = e.abilityId,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().abilityCollection.get(n) : null,
                o = void 0,
                u = this.getTmpAbilityBySlot(t);
            !r && u && u.clearTmpInUseBy();
            var a = s ? s.get("tmpInUseBy") : null;
            if (a) {
                var f = a.buddyId,
                    l = a.slot;
                o = this.getDatastore().buddyCollection.get(f), r || o.setTmpAbilityIdBySlot(l, 0)
            }
            return r || this.setTmpAbilityIdBySlot(t, n), !r && s && s.setTmpInUseBy({
                buddyId: this.get("id"),
                slot: t
            }), this.isSetTmpAbilityByRecommend = i ? !0 : !1, {
                equippingBuddy: o
            }
        },
        getAbilityIdBySlot: function(e) {
            return this.abilitySlotToId["slot" + e]
        },
        getAbilityBySlot: function(e) {
            var t = this.getAbilityIdBySlot(e),
                n = t ? this.getDatastore().abilityCollection.get(t) : null;
            return n
        },
        getTmpAbilityIdBySlot: function(e) {
            return this.tmpAbilitySlotToId["slot" + e]
        },
        setTmpAbilityIdBySlot: function(e, t) {
            this.tmpAbilitySlotToId["slot" + e] = t
        },
        getTmpAbilityBySlot: function(e) {
            var t = this.getTmpAbilityIdBySlot(e),
                n = t ? this.getDatastore().abilityCollection.get(t) : null;
            return n
        },
        getTmpAbilitySlotToId: function() {
            return this.tmpAbilitySlotToId
        },
        fixTmpAbilities: function() {
            if (!this.hasChangedAbilityId()) return;
            this.abilitySlotToId = _.clone(this.tmpAbilitySlotToId), this.abilities = this.getAbilityModels(), this._setAbilityIdAttributes(this.abilitySlotToId)
        },
        _setAbilityIdAttributes: function(e) {
            var t = this;
            _.each(FF.CONST.SERVER.ABILITY.SLOTS, function(n) {
                var r = e["slot" + n],
                    i = "ability_" + n + "_id";
                t.set(i, r)
            })
        },
        resetTmpAbilities: function() {
            if (!this.hasChangedAbilityId()) return;
            this.tmpAbilitySlotToId = _.clone(this.abilitySlotToId), this.isSetTmpAbilityByRecommend = !1
        },
        getAbilityModels: function() {
            return this._getAbilityModelsBySlotToId(this.abilitySlotToId)
        },
        getTmpAbilityModels: function() {
            return this._getAbilityModelsBySlotToId(this.tmpAbilitySlotToId)
        },
        _getAbilityModelsBySlotToId: function(e) {
            var t = this,
                n = this.getDatastore().abilityCollection,
                r = [];
            return _.each(FF.CONST.SERVER.ABILITY.SLOTS, function(t) {
                var i = e["slot" + t],
                    s = i ? n.get(i) : null;
                r.push(s)
            }), r
        },
        canEquipAbility: function(e) {
            var t = e.get("category_id"),
                n = this.get("ability_category")[t];
            return n ? n.rarity < e.get("rarity") ? !1 : !0 : !1
        },
        hasChangedAbilityId: function() {
            return this.getAbilityIdBySlot(1) !== this.getTmpAbilityIdBySlot(1) ? !0 : this.getAbilityIdBySlot(2) !== this.getTmpAbilityIdBySlot(2) ? !0 : !1
        },
        takeOffAllAbilities: function() {
            this.setTmpAbilityId({
                slot: 1,
                abilityId: 0
            }), this.setTmpAbilityId({
                slot: 2,
                abilityId: 0
            })
        }
    }
}), define("scenes/common/models/Buddy/SoulStrike", [], function() {
    return {
        initializeSoulStrike: function() {
            this.initializeSoulStrikeSlots(), this.soulStrikeSlotToId = _.clone(this.tmpSoulStrikeSlotToId), this.soulStrikes = this.getSoulStrikeModels(), this.isSetTmpSoulStrikeByRecommend = !1
        },
        initializeSoulStrikeSlots: function() {
            var e = this;
            _.each(this.getSoulStrikeSlots(), function(t) {
                var n = sprintf("soul_strike_%d_id", t);
                e.setTmpSoulStrikeIdBySlot(t, e.get(n))
            })
        },
        getSoulStrikeSlots: function() {
            return FF.CONST.SERVER.SOUL_STRIKE.SLOTS
        },
        getSoulStrikeIdBySlot: function(e) {
            return +this.soulStrikeSlotToId["slot" + e]
        },
        getSoulStrikeBySlot: function(e) {
            var t = this.getSoulStrikeIdBySlot(e),
                n = t ? this.getDatastore().soulStrikeCollection.get(t) : null;
            return n
        },
        isTmpSoulStrikeSlotFull: function() {
            return _.compact(this.getTmpSoulStrikeModels()).length === FF.CONST.SERVER.SOUL_STRIKE.SLOTS.length
        },
        getTmpSoulStrikeIdBySlot: function(e) {
            return +this.tmpSoulStrikeSlotToId["slot" + e]
        },
        setTmpSoulStrikeIdBySlot: function(e, t) {
            this.tmpSoulStrikeSlotToId["slot" + e] = t
        },
        getTmpSoulStrikeBySlot: function(e) {
            var t = this.getTmpSoulStrikeIdBySlot(e),
                n = t ? this.getDatastore().soulStrikeCollection.get(t) : null;
            return n
        },
        getSoulStrikeModels: function() {
            return this._getSoulStrikeModelsBySlotToId(this.soulStrikeSlotToId)
        },
        getTmpSoulStrikeModels: function() {
            return this._getSoulStrikeModelsBySlotToId(this.tmpSoulStrikeSlotToId)
        },
        getTmpSoulStrikeIds: function() {
            var e = this,
                t = [];
            return _.each(this.getSoulStrikeSlots(), function(n) {
                var r = e.getTmpSoulStrikeIdBySlot(n);
                t.push(r)
            }), t
        },
        sortTmpSoulStrikeIds: function() {
            var e = this,
                t = _.compact(this.getTmpSoulStrikeIds());
            while (t.length < FF.CONST.SERVER.SOUL_STRIKE.SLOTS.length) t.push(0);
            _.each(t, function(t, n) {
                e.setTmpSoulStrikeIdBySlot(n + 1, t)
            })
        },
        _getSoulStrikeModelsBySlotToId: function(e) {
            if (!e) return;
            var t = this,
                n = this.getDatastore().soulStrikeCollection,
                r = [];
            return _.each(this.getSoulStrikeSlots(), function(t) {
                var i = e["slot" + t],
                    s = i ? n.get(i) : null;
                r.push(s)
            }), r
        },
        setTmpSoulStrikeId: function(e) {
            var t = e.slot,
                n = e.soulStrikeId,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().soulStrikeCollection.get(n) : null;
            return r || this.setTmpSoulStrikeIdBySlot(t, n), this.isSetTmpSoulStrikeByRecommend = i ? !0 : !1, {}
        },
        takeOffUnmasteredSoulStrikes: function() {
            var e = this,
                t = this.getMasteredSoulStrikeIds();
            t.push(this.get("default_soul_strike_id"));
            var n = _.compact(this.getTmpSoulStrikeIds()),
                r = _.difference(n, t);
            _.each(r, function(t) {
                var n = e.getTmpSlotBySoulStrikeId(t);
                e.setTmpSoulStrikeId({
                    slot: n,
                    soulStrikeId: 0
                })
            }), e.setDefaultSoulStrikeIfNeed(), this.sortTmpSoulStrikeIds()
        },
        takeOffSoulStrike: function() {
            var e = this;
            _.each(this.getSoulStrikeSlots(), function(t) {
                e.setTmpSoulStrikeId({
                    slot: t,
                    soulStrikeId: 0
                })
            }), e.setDefaultSoulStrikeIfNeed()
        },
        fixTmpSoulStrikes: function() {
            this.soulStrikeSlotToId = _.clone(this.tmpSoulStrikeSlotToId), this.soulStrikes = this.getSoulStrikeModels()
        },
        resetTmpSoulStrikes: function() {
            if (!this.hasChangedSoulStrikeId()) return;
            this.tmpSoulStrikeSlotToId = _.clone(this.soulStrikeSlotToId), this.isSetTmpSoulStrikeByRecommend = !1
        },
        hasChangedSoulStrikeId: function() {
            var e = this;
            return _.some(this.getSoulStrikeSlots(), function(t) {
                return e.getSoulStrikeIdBySlot(t) !== e.getTmpSoulStrikeIdBySlot(t)
            })
        },
        getOwnSoulStrikeModels: function() {
            var e = this.get("buddy_id"),
                t = this.get("default_soul_strike_id"),
                n = FF.datastore.soulStrikeCollection;
            return n.filter(function(n) {
                return n.isOwnByBuddyId(e) && !n.isDefaultSoulStrike(t)
            })
        },
        getCommonSoulStrikeModels: function() {
            var e = this.get("buddy_id"),
                t = this.getSelectableSoulStrikeModels();
            return _.filter(t, function(t) {
                return !t.isOwnByBuddyId(e)
            })
        },
        getMasteredSoulStrikeIds: function() {
            var e = this,
                t = FF.datastore.soulStrikeCollection,
                n = _.map(this.get("soul_strike_exp_map"), function(e, n) {
                    var r = t.get(+n);
                    if (r.isMastered()) return +n
                });
            return _.compact(n)
        },
        getMasterdSoulStrikeModels: function() {
            var e = this.getMasteredSoulStrikeIds();
            return _.map(e, function(e) {
                return FF.datastore.soulStrikeCollection.get(+e)
            })
        },
        getLearningSoulStrikeModels: function() {
            var e = this.get("default_soul_strike_id"),
                t = this.get("soul_strike_exp_map"),
                n = FF.datastore.soulStrikeCollection.where({
                    allowed_buddy_id: this.get("buddy_id")
                });
            return _.filter(n, function(n) {
                if (e === n.get("id")) return !1;
                var r = +t[n.get("id")];
                return n.get("required_exp") !== r
            })
        },
        getSoulStrikeIdsByEquipment: function(e) {
            var t = this.get("buddy_id"),
                n = _.map(e, function(e) {
                    if (!e) return;
                    var n = e.getSoulStrikeModel();
                    if (n && n.canEquipByBuddyId(t)) return +n.get("id")
                });
            return _.compact(n)
        },
        canEquipSoulStrike: function(e) {
            return e.isMastered() ? !0 : e.canEquipByBuddyId(this.get("buddy_id"))
        },
        canSelectSoulStrikeId: function(e) {
            return _.contains(this.getSelectableSoulStrikeIds(), e)
        },
        getSelectableSoulStrikeIds: function() {
            var e = [];
            e.push(+this.get("default_soul_strike_id")), e.push(this.getMasteredSoulStrikeIds());
            var t = this.hasChangedEquipmentId() ? this.getTmpEquipmentModelMap() : this.getEquipmentModelMap();
            return e.push(this.getSoulStrikeIdsByEquipment(_.values(t))), e = _.chain(e).flatten().uniq().compact().value(), e
        },
        getSelectableSoulStrikeModels: function() {
            return _.map(this.getSelectableSoulStrikeIds(), function(e) {
                return FF.datastore.soulStrikeCollection.get(+e)
            })
        },
        canSelectSoulStrike: function() {
            return this.getSelectableSoulStrikeIds().length > 1
        },
        getDefaultSoulStrikeModel: function() {
            var e = this.get("default_soul_strike_id");
            return FF.datastore.soulStrikeCollection.get(e)
        },
        getRecommendedSoulStrikeModels: function() {
            var e = this.getSelectableSoulStrikeModels(),
                t = e.sort(this.recommendSoulStrikeCompareFunc);
            return t.splice(0, this.getSoulStrikeSlots().length)
        },
        getRecommendedSoulStrikeIds: function() {
            var e = this.getRecommendedSoulStrikeModels();
            return _.map(this.getSoulStrikeSlots(), function(t) {
                return e[t - 1] ? e[t - 1].get("id") : 0
            })
        },
        setTmpRecommendedSoulStrikeIds: function() {
            var e = this,
                t = this.getSoulStrikeSlots(),
                n = this.getRecommendedSoulStrikeModels();
            _.each(t, function(t) {
                var r = n.shift();
                e.setTmpSoulStrikeIdBySlot(t, r ? r.get("id") : 0)
            })
        },
        recommendSoulStrikeCompareFunc: function(e, t) {
            return e.get("recommend_priority") > t.get("recommend_priority") ? -1 : e.get("recommend_priority") < t.get("recommend_priority") ? 1 : 0
        },
        getTmpSlotBySoulStrikeId: function(e) {
            for (var t in this.getSoulStrikeSlots())
                if (this.getTmpSoulStrikeIdBySlot(+t + 1) === +e) return +t + 1
        },
        setDefaultSoulStrikeIfNeed: function() {
            _.any(_.values(this.tmpSoulStrikeSlotToId)) || this.setTmpSoulStrikeIdBySlot(this.getSoulStrikeSlots()[0], this.get("default_soul_strike_id"))
        },
        _takeOffSoulStrikeIfNeed: function(e) {
            var t = this,
                n = this.getTmpSoulStrikeIdBySlot(e),
                r = FF.datastore.soulStrikeCollection.get(+e);
            if (!n) return;
            if (r.isMastered()) return;
            this.setTmpSoulStrikeIdBySlot(n, 0), this.setDefaultSoulStrikeIfNeed()
        }
    }
}), define("scenes/common/models/Buddy/RecordMateria", [], function() {
    return {
        initializeRecordMateria: function() {
            this.setTmpRecordMateriaIdBySlot(1, this.get("record_materia_1_id")), this.recordMateriaSlotToId = _.clone(this.tmpRecordMateriaSlotToId), this.recordMaterias = this.getRecordMateriaModels(), this.isSetTmpRecordMateriaByRecommend = !1
        },
        setTmpRecordMateriaId: function(e) {
            var t = e.slot,
                n = e.recordMateriaId,
                r = e.dryrun,
                i = e.isSetByRecommend,
                s = n ? this.getDatastore().recordMateriaCollection.get(n) : null,
                o = void 0,
                u = this.getTmpRecordMateriaBySlot(t);
            !r && u && u.clearTmpInUseBy();
            var a = s ? s.get("tmpInUseBy") : null;
            if (a) {
                var f = a.buddyId,
                    l = a.slot;
                o = this.getDatastore().buddyCollection.get(f), r || o.setTmpRecordMateriaIdBySlot(l, 0)
            }
            return r || this.setTmpRecordMateriaIdBySlot(t, n), !r && s && s.setTmpInUseBy({
                buddyId: this.get("id"),
                slot: t
            }), this.isSetTmpRecordMateriaByRecommend = i ? !0 : !1, {
                equippingBuddy: o
            }
        },
        takeOffRecordMateria: function() {
            var e = this;
            _.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                e.setTmpRecordMateriaId({
                    slot: t,
                    recordMateriaId: 0
                })
            })
        },
        getRecordMateriaIdBySlot: function(e) {
            return this.recordMateriaSlotToId["slot" + e]
        },
        getRecordMateriaBySlot: function(e) {
            var t = this.getRecordMateriaIdBySlot(e),
                n = t ? this.getDatastore().recordMateriaCollection.get(t) : null;
            return n
        },
        getTmpRecordMateriaIdBySlot: function(e) {
            return this.tmpRecordMateriaSlotToId["slot" + e]
        },
        setTmpRecordMateriaIdBySlot: function(e, t) {
            this.tmpRecordMateriaSlotToId["slot" + e] = t
        },
        getTmpRecordMateriaBySlot: function(e) {
            var t = this.getTmpRecordMateriaIdBySlot(e),
                n = t ? this.getDatastore().recordMateriaCollection.get(t) : null;
            return n
        },
        fixTmpRecordMaterias: function() {
            if (!this.hasChangedRecordMateriaId()) return;
            this.recordMateriaSlotToId = _.clone(this.tmpRecordMateriaSlotToId), this.recordMaterias = this.getRecordMateriaModels(), this._setRecordMateriaIdAttributes(this.recordMateriaSlotToId)
        },
        _setRecordMateriaIdAttributes: function(e) {
            var t = this;
            _.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(n) {
                var r = e["slot" + n],
                    i = "record_materia_" + n + "_id";
                t.set(i, r)
            })
        },
        resetTmpRecordMaterias: function() {
            if (!this.hasChangedRecordMateriaId()) return;
            this.tmpRecordMateriaSlotToId = _.clone(this.recordMateriaSlotToId), this.isSetTmpRecordMateriaByRecommend = !1
        },
        getRecordMateriaModels: function() {
            return this._getRecordMateriaModelsBySlotToId(this.recordMateriaSlotToId)
        },
        getTmpRecordMateriaModels: function() {
            return this._getRecordMateriaModelsBySlotToId(this.tmpRecordMateriaSlotToId)
        },
        _getRecordMateriaModelsBySlotToId: function(e) {
            var t = this,
                n = this.getDatastore().recordMateriaCollection,
                r = [];
            return _.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                var i = e["slot" + t],
                    s = i ? n.get(i) : null;
                r.push(s)
            }), r
        },
        hasRecordMateria: function() {
            var e = this.getRecordMateriaModels();
            return _.compact(e).length > 0
        },
        hasTmpRecordMateria: function() {
            var e = this.getTmpRecordMateriaModels();
            return _.compact(e).length > 0
        },
        hasChangedRecordMateriaId: function() {
            var e = this;
            return _.any(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                return e.getRecordMateriaIdBySlot(t) !== e.getTmpRecordMateriaIdBySlot(t)
            })
        },
        canSetRecordMateria: function() {
            return this.isEvolved()
        }
    }
}), define("scenes/common/models/Buddy/DressRecord", [], function() {
    return {
        initializeDressRecord: function() {
            this._setTmpDressRecordId(this.get("dress_record_id")), this.dressRecordId = this.tmpDressRecordId, this.dressRecord = this.getDressRecordModel(), this.isSetTmpDressRecordByRecommend = !1
        },
        setTmpDressRecordId: function(e) {
            var t = e.dressRecordId,
                n = e.dryrun,
                r = e.isSetByRecommend,
                i = t ? this.getDatastore().dressRecordCollection.get(t) : null,
                s = void 0,
                o = this.getTmpDressRecord();
            return !n && o && (e.forSupporter ? o.clearTmpInUseBySupporter() : o.clearTmpInUseBy()), n || this._setTmpDressRecordId(t), !n && i && (e.forSupporter ? i.setTmpInUseBySupporter({
                buddyId: this.get("id")
            }) : i.setTmpInUseBy({
                buddyId: this.get("id")
            })), this.isSetTmpDressRecordByRecommend = r ? !0 : !1, {
                equippingBuddy: s
            }
        },
        setTmpDressRecordIdDirectly: function(e) {
            this.tmpDressRecordId = e
        },
        takeOffDressRecord: function() {
            this.tmpDressRecordId = FF.CONST.SERVER.DRESS_RECORD.DEFAULT_DRESS_RECORD_ID
        },
        getDressRecordId: function() {
            return this.dressRecordId
        },
        getDressRecord: function() {
            var e = this.getDressRecordId(),
                t = e ? this.getDatastore().dressRecordCollection.get(e) : null;
            return t
        },
        getTmpDressRecordId: function() {
            return this.tmpDressRecordId
        },
        _setTmpDressRecordId: function(e) {
            this.tmpDressRecordId = e
        },
        getTmpDressRecord: function() {
            var e = this.getTmpDressRecordId(),
                t = e ? this.getDatastore().dressRecordCollection.get(e) : null;
            return t
        },
        getDressRecordModel: function() {
            var e = this.getDatastore().dressRecordCollection,
                t = this.dressRecordId,
                n = t ? e.get(t) : null;
            return n
        },
        getTmpDressRecordModel: function() {
            var e = this.getDatastore().dressRecordCollection,
                t = this.tmpDressRecordId,
                n = t ? e.get(t) : null;
            return n
        },
        fixTmpDressRecord: function() {
            this.dressRecordId = this.tmpDressRecordId, this.dressRecord = this.getDressRecord(), this._setDressRecordIdAttributes(this.dressRecordId), this.getDatastore().dressRecordCollection.fixTmpInUseBy()
        },
        _setDressRecordIdAttributes: function(e) {
            var t = "dress_record_id";
            this.set(t, e)
        },
        resetTmpDressRecord: function() {
            this.tmpDressRecordId = this.dressRecordId, this.getDatastore().dressRecordCollection.resetTmpInUseBy(), this.isSetTmpDressRecordByRecommend = !1
        },
        hasDressRecord: function() {
            return this.getDressRecordModel() ? !0 : !1
        },
        hasEquipableDressRecord: function() {
            var e = this.getDatastore().dressRecordCollection;
            return e.hasDressRecordByBuddyId(this.get("buddy_id"))
        },
        hasTmpDressRecord: function() {
            return this.getTmpDressRecordModel() ? !0 : !1
        },
        hasChangedDressRecordId: function() {
            return this.getDressRecordId() !== this.getTmpDressRecordId() ? !0 : !1
        },
        canEquipDressRecord: function(e) {
            return this.get("buddy_id") === e
        }
    }
}), define("scenes/battle/Conf", [], function() {
    return FF.ns.battle.Conf = {
        RECOMPILE: {
            VER: 10
        },
        ANIMATION_TYPE: {
            NORMAL: 1,
            BARRAGE: 3,
            DROP_ITEM: 5,
            DAMAGE: 7,
            DEAD: 8,
            DEFORM: 9,
            APPEARANCE: 11,
            TRANSITION: 12,
            JUMP_OUT: 13,
            JUMP_IN: 14,
            DEFORM_ATTACK: 15,
            ENEMY_JUMP: 16,
            INVALIDITY: 17,
            DEFORM_BARRAGE: 18,
            RERAISE_RISE: 19
        },
        WEAPON_EQUIP_TYPE: {
            RIGHT: 1,
            LEFT: 2,
            BOTH: 3,
            FREE: 4
        },
        ABILITY_LAUNCH_TYPE: {
            NORMAL: 1,
            BUDDY_ONLY: 2,
            ONCE: 3,
            NONE: 99
        },
        ABILITY_SHOT_TYPE: {
            NORMAL: 1,
            ATTRACT: 2,
            BACKWARD: 3,
            FORWARD: 4,
            NORMAL_ONCE: 11,
            ATTRACT_ONCE: 21,
            BACKWARD_ONCE: 31,
            FORWARD_ONCE: 41,
            NONE: 99
        },
        ABILITY_HIT_TYPE: {
            NORMAL: 1,
            MULTI_HIT: 2,
            MULTI_HIT_FAST: 3
        },
        ABILITY_RETURN_TYPE: {
            NORMAL: 1,
            ATTRACT: 2,
            BACKWARD: 3,
            FORWARD: 4,
            NONE: 99
        },
        DROP_ITEM_TYPE: {
            GIL: 11,
            POTION: 21,
            HI_POTION: 22,
            X_POTION: 23,
            ETHER: 31,
            TURBO_ETHER: 32,
            TREASURE: 41,
            ORB: 51,
            EVENT_ITEM: 61
        },
        SCORE_TYPE: {
            ACTION_NUM: 1001,
            DAMAGED_RATE: 1002,
            DROP_NUM: 1003,
            DEFEAT_NUM: 1004,
            ENEMY_ABILITY: 2003,
            ENEMY_ABILITY_TIMING: 2004,
            NOT_ENEMY_ABILITY: 2006,
            NOT_ENEMY_ABILITY_TIMING: 2007,
            DAMAGE_REDUCED: 2009,
            WITHOUT_SPECIAL_EQUIPMENT: 2019,
            DEFEAT_BEFORE_ABILITY: 2021,
            DEFEAT_BEFORE_LOOKING: 2022,
            SUCCESS_ENEMY_ABILITY: 2023,
            SUCCESS_ENEMY_ABILITY_TIMING: 2024,
            SUCCESS_STATUS_AILMENTS: 2025,
            SUCCESS_STATUS_AILMENTS_TIMING: 2026,
            SUCCESS_ENEMY_EXERCISE: 2027,
            SUCCESS_ENEMY_EXERCISE_TIMING: 2028,
            NOT_ENEMY_EXERCISE: 2029,
            NOT_ENEMY_EXERCISE_TIMING: 2030,
            NOT_DEFEAT: 2031,
            SUCCESS_ENEMY_DAMAGED_BY_ENEMY: 2032,
            SUCCESS_ENEMY_ABILITY_BY_ENEMY: 2033,
            SUCCESS_STATUS_AILMENTS_BY_ENEMY: 2034,
            HAS_BUDDY: 2035,
            NOT_DEFEAT_IN_ROUND: 2036,
            SUCCESS_ENEMY_JUMP_TIMING: 2037,
            DEFEAT_ENEMY_NUM: 2038,
            DEFEAT_ENEMY_ORDER: 2039,
            SUCCESS_ENEMY_CUSTOM_PARAM_DECREASE_TIMING: 2040
        },
        ACTOR_LOOKING_DEFAULT: 1,
        STATUS_AILMENTS_TYPE: {
            POISON: 200,
            SILENCE: 201,
            PARALYSIS: 202,
            CONFUSION: 203,
            HASTE: 204,
            SLOW: 205,
            STOP: 206,
            PROTECT: 207,
            SHELL: 208,
            REFLECTION: 209,
            BLINDED: 210,
            SLEEP: 211,
            PETRIFACTION: 212,
            DOOM: 213,
            INSTANT_DEATH: 214,
            BERSERKER: 215,
            REGEN: 216,
            LEVITATE: 218,
            WEAKENED: 219,
            ZOMBIE: 220,
            MINIMUM: 221,
            TOAD: 222,
            CURSE: 223,
            GRADUAL_PETRIFACTION: 224,
            BLINK: 225,
            WATER_IMP: 226,
            VANISH: 227,
            PORKY: 228,
            SAP: 229,
            PYRAMID: 231,
            PRISON_CAGE: 232,
            WATER_BALL: 233,
            POSSESSION: 234,
            STOCK_BREAK: 235,
            DOOM_30: 236,
            DOOM_45: 237,
            DOOM_90: 238,
            DOOM_120: 239,
            TRIPLE: 240,
            SWALLOWED: 241,
            STAN: 242,
            REGEN_STRONG: 243,
            ARM_CATCH: 244,
            REFLECTION_FULL_TIME: 245,
            MAGICAL_MINE: 246,
            REGEN_MIDDLE: 247,
            CHANGE_CAST_TIME: 248,
            RERAISE_40: 249,
            RERAISE_60: 250,
            RERAISE_80: 251,
            RERAISE_100: 252,
            RERAISE_DEATH: 253,
            MATK_BOOSTER: 501,
            PROVOKE: 502,
            CHARGE: 503,
            INVISIBLE: 505,
            DEFENSE: 506,
            DISABLE: 507,
            COUNTER_AIMING: 508,
            RUNIC: 509,
            AIRFORCE_SPECK: 510,
            FORCE_ESCAPE: 511,
            BASIC_MAGIC_BREAKER: 512,
            RAID: 513,
            LOCK_ON: 514,
            OVER_DRIVE: 515,
            ROAR: 516,
            MAGIC_SEAL: 517,
            MIRAGE_1: 518,
            MIRAGE_2: 519,
            MIRAGE_3: 520,
            NON_DAMAGE: 521,
            CHARM: 522,
            MIGHTY_GUARD_1: 523,
            SUCTION: 524,
            FURY: 525,
            INDOMITABLENESS: 526,
            MAGIC_CHARM: 527,
            CUSTOM_MATK_20_MDEF_50: 528,
            RAGE: 529,
            GRAND_CROSS: 531,
            TRANCE: 532,
            FLIGHT_SEAL: 533,
            EYE_POWER_CHARM: 534,
            CUSTOM_MATK: 601,
            CUSTOM_MND: 602,
            CUSTOM_ATK: 603,
            CUSTOM_DEF: 604,
            CUSTOM_ATK_ACC: 605,
            CUSTOM_EVA: 606,
            CUSTOM_MDEF: 607,
            CUSTOM_DEF_MDEF: 608,
            CUSTOM_ATK_MATK_DEF_MDEF: 609,
            CUSTOM_ATK_MATK: 610,
            CUSTOM_ATK_DEF: 611,
            CUSTOM_ATK_MATK_DEF_MDEF_SPD_ACC_MND: 612,
            CUSTOM_SPD: 613,
            INVINCIBLE: 701,
            NULL_PHYSICAL: 702,
            NULL_MAGIC: 703,
            FARAWAY: 704,
            NULL_BASIC_MAGIC: 705,
            ATTACH_ELEMENT_LIGHTNING_WEAK: 801,
            ATTACH_ELEMENT_LIGHTNING_MIDDLE: 802,
            ATTACH_ELEMENT_LIGHTNING_STRONG: 803,
            ATTACH_ELEMENT_FIRE_WEAK: 804,
            ATTACH_ELEMENT_FIRE_MIDDLE: 805,
            ATTACH_ELEMENT_FIRE_STRONG: 806,
            IGNORE_INCONTROLLABLE: 901,
            DEATH: 999
        },
        STATUS_AILMENTS_EXCLUSIVE: {
            TOGETHER: 1,
            BLOCK: 2,
            EXTRUDE: 3
        },
        ACTION_ID_OF: {
            DEFORM: 9001,
            POISON: 9002,
            REGEN: 9003,
            DO_NOTHING: 9004,
            DEFORM_MULTI: 9005,
            DEFENSE: 911,
            HEAL_DEATH: 9006,
            SELF_CUSTOM_PARAM: 9007,
            INCREASE_MP: 9008,
            BUILTIN_INFLICT_SA: 9009,
            RERAISE_RISE: 9010,
            DO_NOTHING_STRICTLY: 9011,
            HEAL_HP_BY_DAMAGE_SUM: 9012
        },
        ABILITY_ID_OF: {
            DEFORM: 900101,
            POISON: 900201,
            REGEN: 900301,
            DO_NOTHING: 900401,
            DEFORM_MULTI: 900501,
            DEFENSE: 390001,
            ATTACK: 30151001,
            HEAL_DEATH: 900601,
            SELF_CUSTOM_PARAM: 900701,
            INCREASE_MP: 900801,
            BUILTIN_INFLICT_SA: 900901,
            RERAISE_RISE: 901001,
            DO_NOTHING_STRICTLY: 901101,
            HEAL_HP_BY_DAMAGE_SUM: 901201
        },
        MATERIA_NOTIFY_TYPE: {
            SETUP_ROUND: 1,
            RESET_FOR_CONTINUE: 2,
            DAMAGE_HOOK: 3,
            ABILITY_PANEL: 4,
            ACTION_EXIT: 5,
            RECIEVE_DAMAGE_HOOK: 6
        },
        ELEMENT_TYPE: {
            NONE: 0,
            FIRE: 100,
            ICE: 101,
            LIGHTNING: 102,
            EARTH: 103,
            WIND: 104,
            WATER: 105,
            HOLY: 106,
            DARK: 107,
            POISON: 108,
            NOTHING: 199
        },
        ADVANTAGE: {
            NONE: 0,
            WEAK: 1,
            HALF: 2,
            VOID: 3,
            ABSORPTION: 4
        },
        TARGET_RANGE: {
            SINGLE: 1,
            ALL: 2,
            SELF: 3
        },
        TARGET_SEGMENT: {
            OPPONENT: 1,
            COLLEAGUE: 2,
            BOTH: 3,
            BOTH_EXCEPT_MYSELF: 4,
            COLLEAGUE_EXCEPT_MYSELF: 5,
            AI_NO_1: 201
        },
        TARGET_DEATH: {
            EXCLUDE: 1,
            INCLUDE: 2,
            EXCLUDE_PURE_DEATH: 3
        },
        TARGET_METHOD: {
            HP_RATIO_DESC: 1,
            HP_RATIO_ASC: 2,
            SA_RANDOM: 3,
            DIS_SA_RANDOM: 4,
            RANDOM: 5,
            NOTHING: 6,
            HP_DESC: 7,
            HP_ASC: 8,
            ESNA: 9,
            DISPEL: 10,
            MP_RANDOM: 11,
            MARAISE: 12,
            BUDDY_SMART: 101,
            AI_SMART: 201,
            AI_SMART_IGNORE_REFRECTION: 202
        },
        ACTIVE_TARGET_METHOD: {
            BOTH_DISABLE: 1,
            OPPONENT_DISABLE: 2,
            COLLEGUE_DISABLE: 3,
            BOTH_ENABLE: 4
        },
        ROW_TYPE: {
            FRONT: 1,
            BACK: 2
        },
        ATK_TYPE: {
            DIRECT: 1,
            INDIRECT: 2
        },
        MESSAGE_TYPE: {
            ACTOR_APPEARED: 1,
            ACTOR_DEAD: 2,
            ACTOR_ABILITY: 3,
            ACTOR_HP_DECREASED: 4,
            ACTOR_LOOKING_CHANGED: 5,
            MESSAGE: 6,
            PROGRAM: 7
        },
        MESSAGE_DISPLAY_TYPE: {
            ONCE: 1,
            REPEAT: 2
        },
        EXERCISE_TYPE: {
            PHYSICAL: 1,
            WHITE_MAGIC: 3,
            BLACK_MAGIC: 4,
            BLUE_MAGIC: 5,
            SUMMON: 6,
            INBORN: 7,
            NINJA: 8,
            NO_CLASSIFIED: 9
        },
        JUDGE: {
            VICTORY: 1,
            LOSE: 2,
            FORCE_ESCAPE: 3
        },
        PANEL_TYPE: {
            COMMAND: 1,
            SUPPORT: 2,
            DEFENSE: 3
        },
        BACKGROUND_CHANGE_TYPE: {
            NONE: 0,
            WALK: 1,
            STOP: 2
        },
        TRANSITION_TYPE: {
            SCROLL: 1,
            NONE: 2
        },
        CONTINUE_TYPE: {
            SOUL_PIECE: 101,
            COIN: 201
        },
        CONTINUE_TXN_STAT: {
            STARTED: 1,
            CURED: 2,
            DONE: 3,
            CANCELED: 4,
            SELECTED: 5
        },
        CONTINUE_BONUS: {
            ATTACK: 11,
            DEFENSE: 12,
            ABILITY: 13,
            HP: 14
        },
        MATERIA_CONDTION_TYPE: {
            ALL: 1,
            ELEMENT: 2,
            EXERCISE: 3,
            ABILITY_ID: 4,
            FLIGHT: 5,
            ABILITY_CATEGORY_ID: 6
        },
        COUNTER_CONDTION_TYPE: {
            ALL: 1,
            ELEMENT: 2,
            EXERCISE: 3,
            CUSTOM: 4
        },
        COUNTER_CONDTION_CUSTOM_TYPE: {
            BLACK_AND_WHITE_MAGIC_ATTACK: 1,
            SKIP_IN_REFLECTION: 2,
            COUNTER_AIMING: 3
        },
        RECEPTOR: {
            PANEL_ATTACK: 11,
            PANEL_FLEXIBLE_1: 12,
            PANEL_FLEXIBLE_2: 13,
            PANEL_DEFENSE: 14,
            SOUL_STRIKE: 21,
            SOUL_STRIKE_FLEXIBLE_1: 22,
            SOUL_STRIKE_FLEXIBLE_2: 23,
            SOUL_STRIKE_FLEXIBLE_3: 24,
            SOUL_STRIKE_FLEXIBLE_4: 25,
            SKIP: 31,
            SUPPORTER_SOUL_STRIKE: 41,
            POSITIVE_INCONTROLLABLE: 51,
            SPARE_PANEL_TRANCE_CLOUD_1: 10011,
            SPARE_PANEL_TRANCE_CLOUD_2: 10012,
            SPARE_PANEL_TRANCE_TINA_1: 10021,
            SPARE_PANEL_TRANCE_TINA_2: 10022
        },
        PANEL_TARGET_RECEPTABLE: {
            ENABLE: 1,
            DISABLE: 2,
            ANY: 3
        },
        PANEL_TARGET_REMAIN_NUM: {
            EXISTS: 1,
            EMPTY: 2,
            ANY: 3
        },
        PANEL_TARGET_USED_NUM: {
            USED: 1,
            NOT_USED: 2,
            ANY: 3
        },
        CALC_TYPE: {
            ATTACK: 1,
            MAGIC: 2,
            FRACTION: 3,
            HEAL: 4,
            HEAL_SA: 5,
            HEAL_DEATH: 6,
            POISON: 7,
            REGEN: 8,
            HP_BARTER: 9,
            STATUS_AILMENTS: 10,
            SELF_DESTRUCTION: 11,
            ENTRUSTING_SS_POINT: 12,
            ABILITY_PANEL: 13,
            DAMAGED_HP: 14,
            FIXED_DAMAGE: 15,
            PHYSICAL_STATUS_AILMENTS: 16,
            FRACTION_HEAL: 17,
            HEAL_HP_BY_DAMAGE_SUM: 18
        },
        CALC_HOOK: {
            REFRECTOR: 101,
            COUNTER_ENABLE: 102,
            MATERIA: 103,
            RECEIVER_SA: 104,
            BRK_DEF: 105,
            FLIGHT_ATTACK: 106,
            UNDEAD_CURE: 201,
            UNDEAD_RAISE: 202,
            SEALING: 203,
            PYRAMID: 204,
            FARAWAY: 205,
            WATER_BALL: 206,
            NON_DAMAGE: 207,
            SWALLOWED: 208,
            FURY: 209,
            INDOMITABLENESS: 210,
            IGNORE_GENERAL_DAMAGED_RATE_SCORE: 211,
            INVINCIBLE: 212
        },
        PARAM_CONVERT_TYPE: {
            NONE: 0,
            DEF_CONVERT_ATK: 1,
            SPD_CONVERT_ATK: 2,
            VALIANT_ATTACK: 3
        },
        BREED_ID: {
            UNDEAD: 1
        },
        STATUS_AILMENTS_BUNDLE: {
            LOT: 1,
            ESNA: 2,
            DISPEL: 3,
            DEBARIA: 4,
            POISON_AND_PARALYSIS: 5,
            PHOTON_WING: 6,
            POISON_AND_BLINDED: 7,
            SILENCE_AND_STAN: 8,
            SERAPHIC_RAY: 9,
            BLINDED_AND_SILENCE: 10,
            CONFUSION_AND_SLEEP: 11,
            POISON_AND_SILENCE_AND_BLINDED_AND_SLOW: 12,
            PROTECT_AND_SHELL_AND_HASTE: 13,
            SLOW_AND_SLEEP: 14,
            SLOW_AND_BLINDED_AND_POISON: 15,
            POISON_AND_SLOW: 16,
            CONFUSION_AND_SLEEP_AND_BLINDED: 17,
            PARALYSIS_AND_SILENCE: 18
        },
        STATUS_BONUS_PARTS: {
            BUDDY: "buddy",
            WEAPON: "weapon",
            ARMOR: "armor",
            ACCESSORY: "accessory"
        },
        BGM_NAME: {
            VICTORY: "bgm_05_008",
            REQUIEM: "bgm_05_009"
        },
        SYSTEM_WINDOW: {
            NETWORK: 101,
            ERROR: 102,
            LOGIN: 103,
            BATTLE_RESULT: 104,
            EXPIRE: 105,
            CONFIRM_CONTINUE: 106,
            MAINTENANCE: 107,
            ESCAPE_ALERT: 108,
            OAUTH_TOKEN_REVOKED: 109,
            PAYMENT_NETWORK: 110
        },
        DEAD_ANIMATE_TYPE: {
            DEAD: 1,
            BOSS: 2,
            APPARENT_DEAD: 3,
            ESCAPE: 4
        },
        STATUS_BONUS_TYPE: {
            SERIES: 1,
            ROLE: 2
        },
        BRK_DEF_TYPE: {
            ATK: 401,
            DEF: 402,
            MATK: 403,
            MDEF: 404,
            MND: 405,
            SPD: 406
        },
        BUDDY_ID: {
            DESHI: 10000200,
            WARRIOR: 10000300,
            KNIGHT: 10000400,
            RED_MAGE: 10000900,
            BLACK_MAGE: 10001100,
            WHITE_MAGE: 10001400,
            SUMMONER: 10001700,
            MAGIC_KNIGHT: 10002100,
            RANGER: 10002600,
            THIEF: 10002700,
            BARD: 10002800,
            NINJA: 10003e3,
            GLADIATOR: 10003300,
            WOL: 10100100,
            FRIONIEL: 10200100,
            MARIA: 10200200,
            LEON: 10200400,
            GORDON: 10200600,
            RICHARD: 10200800,
            JOSEF: 10200900,
            LUNETH: 10300100,
            ARC: 10300200,
            REFIA: 10300300,
            DARK_CECIL: 10400100,
            PALADIN_CECIL: 10400200,
            CAIN: 10400300,
            RYDIA: 10400400,
            ROSA: 10400600,
            TELLAH: 10401100,
            EDGE: 10401200,
            FUSOYA: 10401300,
            GOLBEZ: 10401400,
            BUTS: 10500800,
            LENNA: 10500200,
            GALUF: 10500500,
            GILGAMESH: 10500700,
            FARIS: 10500900,
            KRILE: 10501200,
            FREELANCER_BUTS: 10500800,
            EXDEATH: 10501100,
            FREELANCER_KRILE: 10501200,
            TINA: 10600100,
            LOCK: 10600300,
            CELES: 10600400,
            EDGAR: 10600600,
            MASH: 10600700,
            CAYENNE: 10600900,
            GAU: 10601e3,
            STRAGUS: 10601200,
            KEFKA: 10601600,
            CLOUD: 10700100,
            TIFA: 10700300,
            AERITH: 10700400,
            RED_XIII: 10700500,
            SEPHIROTH: 10701e3,
            ZACK: 10700900,
            RENO: 10701200,
            SQUALL: 10800100,
            RINOA: 10800200,
            QUISTIS: 10800300,
            ZELL: 10800400,
            SELPHIE: 10800500,
            IRVINE: 10800600,
            SEIFER: 10800700,
            LAGUNA: 10800900,
            GARNET: 10900200,
            VIVI: 10900300,
            STEINER: 10900400,
            AMARANT: 10900800,
            BEATRIX: 10900900,
            TIDUS: 11000100,
            YUNA: 11000200,
            WAKKA: 11000300,
            LULU: 11000400,
            KIMAHRI: 11000500,
            RIKKU: 11000600,
            AURON: 11000700,
            JECHT: 11001e3,
            VAAN: 11200100,
            BALFLEAR: 11200200,
            FRAN: 11200300,
            BASCH: 11200400,
            ASHE: 11200500,
            LIGHTNING: 11300100,
            SNOW: 11300200,
            VANILLE: 11300300,
            SAZH: 11300400,
            HOPE: 11300500,
            FANG: 11300600,
            RAMZA: 15000100,
            AGRIAS: 15000200
        },
        SPECIAL_AURA_TYPE: {
            NONE: 0,
            NORMAL: 1,
            HAS_PARAM_BOOSTER: 2
        },
        SERIES_ID: {
            FF1: 101001,
            FF2: 102001,
            FF3: 103001,
            FF4: 104001,
            FF5: 105001,
            FF6: 106001,
            FF7: 107001,
            FF8: 108001,
            FF9: 109001,
            FF10: 110001,
            FF11: 111001,
            FF12: 112001,
            FF13: 113001,
            FF14: 114001,
            FFT: 150001
        },
        ENEMY_TARGETING: {
            SET_SA: 1,
            UNSET_SA: 2,
            HEAL_HP: 3
        },
        CAST_TIME_TYPE: {
            NORMAL_1: 101,
            SLOW_1: 201,
            TEN_MINS: 999
        },
        PARAM_ID_OF: {
            ATK: 1,
            DEF: 2,
            MATK: 3,
            MDEF: 4,
            MND: 5,
            SPD: 6
        },
        INVALIDITY_TYPE: {
            DO_ABILITY: 1,
            MAGIC: 2,
            FIGHT_ATTACK: 3
        },
        BOOST_TYPE: {
            STATUS: 1,
            RESULT: 2
        },
        ATTENUATION_CURVE: {
            LN: 1,
            LOG: 2
        }
    }, FF.ns.battle.Conf
}), define("scenes/common/models/Buddy", ["./ItemBase", "./Buddy/Equipment", "./Buddy/Ability", "./Buddy/SoulStrike", "./Buddy/RecordMateria", "./Buddy/DressRecord", "../../battle/Conf"], function(e, t, n, r, i, s, o) {
    var u = {
        EQUIPMENT_PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        DEFAULT_DRESS_RECORD_ID: 0,
        RESONATABLE_KEYS: ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp", "spd"]
    };
    return e.extend(_.extend(t, n, r, i, s, {
        attributeSchema: {
            id: void 0,
            weapon_id: void 0,
            armor_id: void 0,
            accessory_id: void 0,
            ability_1_id: void 0,
            ability_2_id: void 0,
            record_materia_1_id: void 0,
            row: void 0,
            soul_strike_1_id: void 0,
            soul_strike_2_id: void 0,
            soul_strike_3_id: void 0,
            soul_strike_4_id: void 0,
            dress_record_id: void 0,
            image_path: void 0
        },
        initialize: function(e) {
            this.CONST = u, this.TYPE_NAME_OF = FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF, this.tmpEquipmentTypeNameToId = {}, this.equipmentTypeNameToId = void 0, this.equipmentModelMap = void 0, this.isSetTmpEquipmentByRecommend = !1, this.initializeEquipment(), this.tmpAbilitySlotToId = {}, this.abilitySlotToId = void 0, this.abilities = void 0, this.isSetTmpAbilityByRecommend = !1, this.initializeAbility(), this.tmpRecordMateriaSlotToId = {}, this.recordMateriaSlotToId = void 0, this.recordMaterias = void 0, this.isSetTmpRecordMateriaByRecommend = !1, this.initializeRecordMateria(), this.tmpSoulStrikeSlotToId = {}, this.soulStrikeSlotToId = void 0, this.soulstrikes = void 0, this.isSetTmpSoulStrikeByRecommend = !1, this.initializeSoulStrike(), this.tmpDressRecordId = void 0, this.dressRecordId = void 0, this.dressRecord = void 0, this.isSetTmpDressRecordByRecommend = !1, this.initializeDressRecord(), this.tmpRow = this.get("row")
        },
        applyEquipmentParameter: function(e) {
            return this._applyEquipmentParameter(e, {
                useTmpEquipment: !1
            })
        },
        applySeriesEquipmentParameter: function(e, t) {
            return this._applyEquipmentParameter(e, {
                seriesId: t,
                useTmpEquipment: !1
            })
        },
        getParamOf: function(e, t) {
            return this._applyEquipmentParameter(e, t)
        },
        getSpStatusNameOf: function(e) {
            return _.contains(u.RESONATABLE_KEYS, e) ? "sp_" + e : e
        },
        _applyEquipmentParameter: function(e, t) {
            var n = this;
            t = t || {};
            var r = t.seriesId,
                i;
            t.hasOwnProperty("hasSeriesBonus") ? i = t.hasSeriesBonus : t.hasOwnProperty("seriesId") ? i = this.hasSeriesBonus(r) : i = !1;
            var s;
            if (t.hasOwnProperty("hasRoleBonus")) s = t.hasRoleBonus;
            else if (t.hasOwnProperty("abilityCategoryBonusMap")) {
                var o = t.abilityCategoryBonusMap;
                s = this.hasRoleBonus(o)
            } else s = !1;
            var u = t.useTmpEquipment,
                a = s || i ? this.get(this.getSpStatusNameOf(e)) : this.get(e);
            if (e === "spd" || e === "level") return a < 1 && (a = 1), a;
            if (this.isStaticParameter(e)) throw new Error("invalid parameter: " + e);
            var f = {
                seriesId: r,
                hasRoleBonus: s,
                calcBoostStatus: !0
            };
            return _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                var r = u ? n.getTmpEquipmentModelByTypeName(t) : n.getEquipmentModelByTypeName(t);
                if (!r) return;
                var i = r.getParamOf(e, f);
                if (i === 0) return;
                var s = r.get("category_id"),
                    o = n.get("equipment_category")[s].factor;
                i > 0 ? a += Math.floor(i * (o / 100)) : a += Math.floor(i / (o / 100))
            }), a < 1 && (a = 1), a
        },
        isStaticParameter: function(e) {
            return !_.contains(u.EQUIPMENT_PARAMETERS, e)
        },
        hp: function() {
            return this.applyEquipmentParameter("hp")
        },
        atk: function() {
            return this.applyEquipmentParameter("atk")
        },
        def: function() {
            return this.applyEquipmentParameter("def")
        },
        matk: function() {
            return this.applyEquipmentParameter("matk")
        },
        mdef: function() {
            return this.applyEquipmentParameter("mdef")
        },
        mnd: function() {
            return this.applyEquipmentParameter("mnd")
        },
        acc: function() {
            return this.applyEquipmentParameter("acc")
        },
        eva: function() {
            return this.applyEquipmentParameter("eva")
        },
        spd: function() {
            return this.get("spd")
        },
        hasRoleBonus: function(e) {
            if (!e || _.isEmpty(e)) return !1;
            var t = this.get("ability_category");
            for (var n in e) {
                var r = t[n];
                if (!r) continue;
                var i = e[n];
                if (r.rarity >= i.rarity) return !0
            }
            return !1
        },
        hasSeriesBonus: function(e) {
            return this.isSameSeries(e)
        },
        getStatusBonusOpt: function(e) {
            var t = this.hasSeriesBonus(e.seriesId),
                n = this.hasRoleBonus(e.abilityCategoryBonusMap);
            return _.extend({
                hasSeriesBonus: t,
                hasRoleBonus: n
            }, e)
        },
        seriesLv: function(e) {
            return this.isSameSeries(e) ? this.get("sp_level") : this.get("level")
        },
        seriesAtkWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("atk", e)
        },
        seriesDefWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("def", e)
        },
        seriesMatkWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("matk", e)
        },
        seriesMdefWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("mdef", e)
        },
        seriesMndWithoutEquipmentParameter: function(e) {
            return this._seriesParamWithoutEquipmentParameter("mnd", e)
        },
        _seriesParamWithoutEquipmentParameter: function(e, t) {
            var n = this,
                r = e;
            return n.isSameSeries(t) && (r = "sp_" + r), n.get(r)
        },
        isRisenByStatusBonus: function(e) {
            return this.get(this.getSpStatusNameOf(e)) > this.get(e)
        },
        isRisenBySeriesBonus: function(e, t) {
            var n = this;
            if (name === "spd" || name === "level") return !1;
            if (!t) return !1;
            var r = t.seriesId;
            if (!r || r === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID) return !1;
            if (this.hasSeriesBonus(r) && this.isRisenByStatusBonus(e)) return !0;
            var i = t.useTmpEquipment,
                s = _.find(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                    var s = i ? n.getTmpEquipmentModelByTypeName(t) : n.getEquipmentModelByTypeName(t);
                    return s ? s.hasSeriesBonus(r) ? s.isRisenByStatusBonus(e) : !1 : !1
                });
            return !!s
        },
        isRisenByRoleBonus: function(e, t) {
            var n = this;
            if (name === "spd" || name === "level") return !1;
            if (!t) return !1;
            if (!t.hasRoleBonus) return !1;
            if (this.isRisenByStatusBonus(e)) return !0;
            var r = t.useTmpEquipment,
                i = _.find(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                    var i = r ? n.getTmpEquipmentModelByTypeName(t) : n.getEquipmentModelByTypeName(t);
                    return i ? i.isRisenByStatusBonus(e) : !1
                });
            return !!i
        },
        estimateBuddyParamsWithEquipment: function(e, t, n) {
            var r = this;
            n = n || {};
            var i = this.getStatusBonusOpt(n),
                s = i.hasSeriesBonus || i.hasRoleBonus ? this.get(this.getSpStatusNameOf(e)) : this.get(e),
                o = s,
                u = _.extend({}, FF.CONST.CLIENT.EQUIPMENT.PARAM_OPTION_CALC_BOOST_STATUS, i);
            return _.each(t, function(t) {
                if (t) {
                    var n = t.getParamOf(e, u),
                        i = r.get("equipment_category")[t.get("category_id")].factor;
                    n > 0 ? o += Math.floor(n * (i / 100)) : o += Math.floor(n / (i / 100)), o < 1 && (o = 1)
                }
            }), o
        },
        clearTmpInUseBy: function(e) {
            var t = this.getTmpEquipmentModelByTypeName(e.typeName);
            !e.dryrun && t && t.clearTmpInUseBy()
        },
        setTmpInUseBy: function(e) {
            e.equipmentModel.setTmpInUseBy({
                buddyId: this.get("id"),
                typeName: e.typeName
            })
        },
        getTmpInUseByName: function() {
            return "tmpInUseBy"
        },
        getRow: function() {
            return this.get("row")
        },
        setRow: function(e) {
            this.set("row", e)
        },
        getTmpRow: function() {
            return this.tmpRow
        },
        setTmpRow: function(e) {
            this.tmpRow = e
        },
        resetTmpRow: function(e) {
            this.setTmpRow(this.getRow())
        },
        fixTmpRow: function() {
            this.setRow(this.getTmpRow())
        },
        getImagePath: function(e) {
            if (!e) throw new Error("not image_type");
            var t;
            if (this.isDressRecordEquipped()) {
                t = this.get("dress_record_id") + ".png";
                if (e === "name") return this.getDefaultImagePath(e)
            } else t = this.get("buddy_id") + ".png";
            var n = e + ".png";
            return this.get("image_path").replace(t, n)
        },
        setImagePath: function(e) {
            this.set("image_path", e)
        },
        setImagePathByDressRecordId: function(e) {
            var t = this.get("default_image_path");
            if (e === u.DEFAULT_DRESS_RECORD_ID) this.setImagePath(t);
            else {
                var n = this.get("buddy_id") + ".png",
                    r = sprintf("%s/%s.png", e, e),
                    i = t.replace(n, r);
                this.setImagePath(i)
            }
        },
        getCurrentAilmentsImagePath: function() {
            var e = this.getDatastore().partyStatusModel.getIdToDataMap(),
                t = e[this.get("id")].status_ailments;
            if (e[this.get("id")].hp === 0) return this.getImagePath("base_dead");
            var n = {};
            n[o.STATUS_AILMENTS_TYPE.PETRIFACTION] = "stone", n[o.STATUS_AILMENTS_TYPE.BLINDED] = "glass_idle";
            var r = _.find(t, function(e) {
                return n[e]
            });
            if (r) {
                var i = n[r];
                return this.getImagePath(i)
            }
            return this.getImagePath("base_idle")
        },
        getDefaultImagePath: function(e) {
            var t = this.get("buddy_id") + ".png",
                n = e + ".png";
            return this.get("default_image_path").replace(t, n)
        },
        isPoison: function() {
            return this.hasAilmentType(o.STATUS_AILMENTS_TYPE.POISON)
        },
        isSilence: function() {
            return this.hasAilmentType(o.STATUS_AILMENTS_TYPE.SILENCE)
        },
        isDarkness: function() {
            return this.hasAilmentType(o.STATUS_AILMENTS_TYPE.BLINDED)
        },
        isPetrifaction: function() {
            return this.hasAilmentType(o.STATUS_AILMENTS_TYPE.PETRIFACTION)
        },
        getAllAilmentClassNames: function() {
            var e = [];
            return this.isPoison() && e.push("is-poison"), this.isSilence() && e.push("is-silence"), this.isDarkness() && e.push("is-darkness"), e
        },
        getAllAilmentClassNamesFormattedBySpace: function() {
            var e = this.getAllAilmentClassNames();
            return e.join(" ")
        },
        hasAilmentType: function(e) {
            if (!this.getDatastore().partyStatusModel.isInDungeon()) return !1;
            if (!this.isInParty()) return !1;
            var t = this.getDatastore().partyStatusModel.getIdToDataMap(),
                n = t[this.get("id")].status_ailments;
            return _.contains(n, e.toString())
        },
        isInParty: function() {
            var e = this.getDatastore().partyModel;
            return _.values(e.get("slotToBuddyId")).indexOf(this.get("id")) >= 0
        },
        isRowFront: function() {
            return this.getRow() === FF.CONST.SERVER.BUDDY.ROW_OF.FRONT ? !0 : !1
        },
        isTmpRowFront: function() {
            return this.getTmpRow() === FF.CONST.SERVER.BUDDY.ROW_OF.FRONT ? !0 : !1
        },
        isTmpRowBack: function() {
            return this.getTmpRow() === FF.CONST.SERVER.BUDDY.ROW_OF.BACK ? !0 : !1
        },
        setTmpRowAsFront: function() {
            this.setTmpRow(FF.CONST.SERVER.BUDDY.ROW_OF.FRONT)
        },
        setTmpRowAsBack: function() {
            this.setTmpRow(FF.CONST.SERVER.BUDDY.ROW_OF.BACK)
        },
        isBuddy: function() {
            return !0
        },
        isMaxLv: function() {
            return this.get("level") === this.get("level_max")
        },
        isEvolved: function() {
            return this.get("evolution_num") > 0
        },
        isDressRecordEquipped: function() {
            return this.get("dress_record_id") !== u.DEFAULT_DRESS_RECORD_ID
        },
        canEvolveByRecipes: function(e) {
            if (!e) return !1;
            var t = this,
                n = !0;
            return _.each(e, function(e) {
                var t = FF.datastore.memoryCrystalCollection.findWhere({
                    memory_crystal_id: e.memory_crystal_id
                });
                t || (n = !1)
            }), n
        },
        changeRowByRecommend: function() {
            var e = this.getTmpEquipmentModelByTypeName(this.TYPE_NAME_OF.WEAPON),
                t = FF.CONST.SERVER.BUDDY.EQUIP_CATEGORY_IDS_TO_SET_RECOMMEND_ROW_AS_BACK;
            e && _.contains(t, e.get("category_id")) ? this.setTmpRowAsBack() : this.setTmpRowAsFront()
        },
        isSameSeries: function(e) {
            return e ? e === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : this.get("series_id") === e : !1
        },
        isInDungeon: function() {
            var e = this.getDatastore();
            return e.partyStatusModel.isInDungeon() && e.partyModel.isBuddyModelInParty(this)
        },
        isSelectedForSupporterBuddy: function() {
            return this.get("id") === FF.datastore.userSupporterBuddyModel.get("id")
        },
        isDeshi: function() {
            return this.get("buddy_id") === FF.CONST.SERVER.USER.USER_BUDDY_ID
        },
        detachAllItems: function(e) {
            e.detachEquipments && (this.takeOffUnmasteredSoulStrikes(), this.takeOffAllEquipments()), e.detachAbilities && this.takeOffAllAbilities(), e.detachRecordMaterias && this.takeOffRecordMateria()
        },
        hasChangedTmpAttr: function() {
            return this.hasChangedEquipmentId() || this.hasChangedAbilityId() || this.hasChangedSoulStrikeId() || this.hasChangedRecordMateriaId()
        },
        dispose: function() {
            this.equipmentModelMap = null, this.abilities = null, this.recordMaterias = null, this.dressRecord = null, e.prototype.dispose.apply(this)
        }
    }))
}), define("scenes/common/models/UserSupporterBuddy", ["jquery", "underscore", "util", "scenes/common/Constant", "./Buddy"], function(e, t, n, r, i) {
    var s = {
        SOUL_STRIKE_SLOT: 1
    };
    return i.extend({
        hasData: !1,
        idAttribute: "user_id",
        attributeSchema: {
            user_id: void 0,
            weapon_id: void 0,
            armor_id: void 0,
            accessory_id: void 0,
            soul_strike_id: void 0,
            dress_record_id: void 0
        },
        initialize: function() {},
        addData: function(e) {
            this.set(e), this.hasData = !0, this.initializeByProfileAttributeMap()
        },
        initializeByProfileAttributeMap: function() {
            i.prototype.initialize.apply(this), this.CONST = t.extend(this.CONST, r)
        },
        isTmpSoulStrikeSlotFull: function() {
            return t.compact(this.getTmpSoulStrikeModels()).length === s.SOUL_STRIKE_SLOT
        },
        getSoulStrikeSlots: function() {
            return [s.SOUL_STRIKE_SLOT]
        },
        getSoulStrikeId: function() {
            return this.getSoulStrikeIdBySlot(s.SOUL_STRIKE_SLOT)
        },
        getTmpSoulStrikeId: function() {
            return this.getTmpSoulStrikeIdBySlot(s.SOUL_STRIKE_SLOT)
        },
        getSoulStrikeModel: function() {
            return this.getSoulStrikeBySlot(s.SOUL_STRIKE_SLOT)
        },
        getDressRecordModel: function() {
            return this.getDressRecord()
        },
        clearTmpInUseBy: function(e) {
            var t = this.getTmpEquipmentModelByTypeName(e.typeName);
            !e.dryrun && t && t.clearTmpInUseBySupporter()
        },
        setTmpInUseBy: function(e) {
            e.equipmentModel.setTmpInUseBySupporter({
                buddyId: this.get("id"),
                typeName: e.typeName
            })
        },
        getTmpInUseByName: function() {
            return "tmpInUseBySupporter"
        },
        getChangedEquipmentInfo: function() {
            var e = this,
                n = {},
                r = FF.datastore.equipmentCollection,
                i = t.some(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                    var n = e.getEquipmentIdByTypeName(t),
                        r = e.getTmpEquipmentIdByTypeName(t);
                    return n !== r ? !0 : e.getTmpSoulStrikeId() !== e.getSoulStrikeId() ? !0 : !1
                });
            return i && (t.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                n[t + "Id"] = e.getTmpEquipmentIdByTypeName(t) || 0
            }), n.userBuddyId = this.get("id"), n.soulStrikeId = this.getTmpSoulStrikeId(), n.dressRecordId = this.getDressRecordId()), n
        },
        getEquipModelBySoulStrikeId: function() {
            var e = this.get("soul_strike_id");
            return t.find(this.equipmentModelMap, function(t, n) {
                if (!t) return;
                return e === t.get("soul_strike_id")
            })
        }
    })
}), define("scenes/common/models/AbilityDisplayCategory", ["backbone", "util", "lib/Model"], function(e, t, n) {
    return n.extend({
        getLargeCategoryMap: function() {
            return this.get("tab1_map")
        },
        getLargeCategoryById: function(e) {
            return this.getLargeCategoryMap()[e]
        },
        getMiddleCategoryMapByLargeCategoryId: function(e) {
            if (!this.getLargeCategoryById(e)) return;
            return this.getLargeCategoryById(e).tab2_map
        },
        getSmallCategoryListByIds: function(e, t) {
            var n = this.getMiddleCategoryMapByLargeCategoryId(e);
            if (!n) return;
            var r = n[t];
            if (!r) return;
            return r.display_category_list
        }
    })
}), define("scenes/common/collections/ItemBase", ["lib/Collection"], function(e) {
    return e.extend({
        hasAllData: !1,
        addAllData: function(e) {
            this.reset(e, {
                silent: !0,
                sort: !1
            }), this.hasAllData = !0
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/common/helper/BuddyRecommendScore", ["jquery", "underscore"], function(e, t) {
    var n = {
            MAX: 1,
            AVERAGE: 2
        },
        r = [{
            weight: .015,
            calc: n.MAX,
            keys: ["hp"]
        }, {
            weight: .465,
            calc: n.MAX,
            keys: ["atk", "matk", "mnd"]
        }, {
            weight: .22,
            calc: n.AVERAGE,
            keys: ["matk", "mnd"]
        }, {
            weight: .2,
            calc: n.AVERAGE,
            keys: ["def", "mdef"]
        }, {
            weight: .1,
            calc: n.AVERAGE,
            keys: ["acc", "eva", "spd"]
        }];
    return {
        getStrengthScore: function(e, n) {
            var i = this;
            return t.reduce(r, function(t, r) {
                var s = i._calcPartOfScore(e, n, r);
                return t + s * r.weight
            }, 0)
        },
        _calcPartOfScore: function(e, r, i) {
            var s = function(t) {
                var n = e.isSameSeries(r) ? e.getSpStatusNameOf(t) : t;
                return e.get(n)
            };
            if (i.calc === n.MAX) return t.max(t.map(i.keys, s));
            if (i.calc === n.AVERAGE) {
                var o = t.reduce(i.keys, function(e, t) {
                    return e + s(t)
                }, 0);
                return o / i.keys.length
            }
            return 0
        }
    }
}), define("scenes/common/helper/SortAdviser", ["underscore", "lib/ClassBase"], function(e, t) {
    return t.extend({
        _defaultOptions: {
            defaultComparator: function(e, t) {
                return 0
            },
            paramGetter: function(e, t, n) {
                return e.get(t)
            },
            seriesIdKey: "series_id",
            roleTypeKey: "role_type"
        },
        initialize: function(t) {
            this._options = e.defaults(t || {}, this._defaultOptions)
        },
        setOptions: function(t) {
            this._options = e.extend(this._options, t)
        },
        getComparator: function(e, t, n) {
            var r = e.orderType,
                i = e.priorSeriesId,
                s = e.charaRoleType,
                o = e.resonanceSeriesId,
                u = e.hasRoleBonus || !1,
                a = this,
                f = r === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC;
            return function(e, r) {
                var l;
                l = a._prefetchSeriesId(e, r, i);
                if (l !== 0) return l;
                l = a._prefetchRoleType(e, r, s);
                if (l !== 0) return l;
                l = a._compareKeys(e, r, t, f, o, u);
                if (l !== 0) return l;
                if (!n) return a._options.defaultComparator(e, r)
            }
        },
        getBasicComparator: function(e, t, n) {
            var r = this,
                i = e.orderType,
                s = i === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC;
            return function(e, i) {
                var o = r._compareKeys(e, i, t, s, void 0);
                if (o !== 0) return o;
                if (!n) return r._options.defaultComparator(e, i)
            }
        },
        _prefetchSeriesId: function(e, t, n) {
            if (!n) return 0;
            var r = this._options.seriesIdKey;
            return e.get(r) === n && t.get(r) !== n ? -1 : e.get(r) !== n && t.get(r) === n ? 1 : 0
        },
        _prefetchRoleType: function(e, t, n) {
            if (!n) return 0;
            var r = this._options.roleTypeKey;
            return e.get(r) === n && t.get(r) !== n ? -1 : e.get(r) !== n && t.get(r) === n ? 1 : 0
        },
        _compareKeys: function(t, n, r, i, s, o) {
            if (!r) return 0;
            e.isArray(r) || (r = [r]);
            for (var u = 0; u < r.length; ++u) {
                var a = r[u],
                    f = this._options.paramGetter(t, a, s, o),
                    l = this._options.paramGetter(n, a, s, o);
                if (i) {
                    if (f < l) return -1;
                    if (f > l) return 1
                } else {
                    if (f > l) return -1;
                    if (f < l) return 1
                }
            }
            return 0
        }
    })
}), define("scenes/common/collections/Buddy", ["underscore", "./ItemBase", "../models/Buddy", "scenes/common/helper/BuddyRecommendScore", "scenes/common/helper/SortAdviser"], function(e, t, n, r, i) {
    return t.extend({
        model: n,
        initialize: function() {
            this.SORT_TYPE_OF = {
                CREATED_AT: "created_at",
                BUDDY_ID: "buddy_id",
                CHARA_ROLE: "chara_role",
                SERIES_ID: "series_id",
                LV: "lv",
                HP: "hp",
                ATK: "atk",
                DEF: "def",
                MATK: "matk",
                MDEF: "mdef",
                MND: "mnd",
                CAN_EVOLVE: "can_evolve",
                IS_ACQUIRED: "acquired",
                IS_NOT_ACQUIRED: "not_acquired"
            }, this._initSortAdviser()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new i({
                defaultComparator: this._defaultComparator.bind(this),
                paramGetter: this._getParamForSort.bind(this)
            })
        },
        _getParamForSort: function(e, t, n) {
            return e.isStaticParameter(t) ? e.get(t) : e.applySeriesEquipmentParameter(t, n)
        },
        _defaultComparator: function(e, t) {
            return e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : e.get("buddy_id") < t.get("buddy_id") ? -1 : e.get("buddy_id") > t.get("buddy_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.CREATED_AT:
                    n("created_at");
                    break;
                case r.BUDDY_ID:
                    n("buddy_id");
                    break;
                case r.LV:
                    n("level");
                    break;
                case r.HP:
                    n("hp");
                    break;
                case r.ATK:
                    n("atk");
                    break;
                case r.DEF:
                    n("def");
                    break;
                case r.MATK:
                    n("matk");
                    break;
                case r.MDEF:
                    n("mdef");
                    break;
                case r.MND:
                    n("mnd");
                    break;
                case r.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("series_id");
                    break;
                case r.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("role_type");
                    break;
                case r.CAN_EVOLVE:
                    this._setCanEvolveComparator();
                    break;
                default:
                    n(void 0)
            }
        },
        _setCanEvolveComparator: function() {
            var e = this;
            this.comparator = function(t, n) {
                var r = t.get("buddy_id"),
                    i = n.get("buddy_id"),
                    s = t.get("evolution_num") + 1,
                    o = n.get("evolution_num") + 1,
                    u = FF.datastore.stash.buddyEvolutionRecipesMap[r][s],
                    a = FF.datastore.stash.buddyEvolutionRecipesMap[i][o],
                    f = t.isMaxLv() && t.canEvolveByRecipes(u),
                    l = n.isMaxLv() && n.canEvolveByRecipes(a);
                return f && !l ? -1 : !f && l ? 1 : e._defaultComparator(t, n)
            }
        },
        _memoizeForRecommend: function() {
            this._getStrengthScoreMemoized = e.memoize(r.getStrengthScore.bind(r), function(e, t) {
                return e.get("id")
            })
        },
        getRecommendCompareFunc: function(e) {
            var t = this;
            return function(n, r) {
                var i = t._getStrengthScoreMemoized(n, e),
                    s = t._getStrengthScoreMemoized(r, e);
                return i > s ? -1 : i < s ? 1 : n.get("buddy_id") > r.get("buddy_id") ? -1 : n.get("buddy_id") < r.get("buddy_id") ? 1 : 0
            }
        },
        getBuddiesSortedByRecommend: function(e) {
            e = e || {};
            var t = e.seriesId;
            return this._memoizeForRecommend(), this.models.sort(this.getRecommendCompareFunc(t))
        },
        getChangedAbilityInfo: function() {
            var e = {};
            return this.each(function(t) {
                if (t.getAbilityIdBySlot(1) !== t.getTmpAbilityIdBySlot(1) || t.getAbilityIdBySlot(2) !== t.getTmpAbilityIdBySlot(2)) e[t.get("id")] = {
                    ability_1_id: t.getTmpAbilityIdBySlot(1) || 0,
                    ability_2_id: t.getTmpAbilityIdBySlot(2) || 0
                }
            }), e
        },
        hasAnyChanged: function() {
            var t = FF.datastore.partyModel,
                n = FF.datastore.buddyCollection.getChangedEquipmentInfo(),
                r = FF.datastore.buddyCollection.getChangedSoulStrikeInfo(),
                i = FF.datastore.buddyCollection.getChangedAbilityInfo(),
                s = FF.datastore.buddyCollection.getChangedRowInfo({
                    partyModel: t
                }),
                o = FF.datastore.buddyCollection.getChangedRecordMateriaInfo(),
                u = FF.datastore.buddyCollection.getChangedDressRecordInfo(),
                a = !e.isEqual(n, {}) || !e.isEqual(r, {}) || !e.isEqual(i, {}) || !e.isEqual(s, {}) || !e.isEqual(o, {}) || !e.isEqual(u, {});
            return a
        },
        getChangedEquipmentAndSoulStrikeInfo: function() {
            var e = this.getChangedEquipmentInfo(),
                t = this.getChangedSoulStrikeInfo();
            return {
                equipment: e,
                soulStrike: t
            }
        },
        getChangedSoulStrikeInfo: function() {
            var t = {},
                n = this.getDatastore().equipmentCollection;
            return this.each(function(n) {
                if (!n.hasChangedSoulStrikeId()) return;
                var r = n.get("id");
                t[r] = {}, e.each(FF.CONST.SERVER.SOUL_STRIKE.SLOTS, function(e) {
                    t[r]["soul_strike_" + e + "_id"] = n.getTmpSoulStrikeIdBySlot(e) || 0
                })
            }), t
        },
        getChangedEquipmentInfo: function() {
            var t = {};
            return this.each(function(n) {
                if (!n.hasChangedEquipmentId()) return;
                var r = n.get("id");
                t[r] = {}, e.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                    var i = n.getEquipmentIdByTypeName(e),
                        s = n.getTmpEquipmentIdByTypeName(e);
                    t[r][e + "_id"] = n.getTmpEquipmentIdByTypeName(e) || 0
                })
            }), t
        },
        getChangedRecordMateriaInfo: function() {
            var e = {};
            return this.each(function(t) {
                t.getRecordMateriaIdBySlot(1) !== t.getTmpRecordMateriaIdBySlot(1) && (e[t.get("id")] = {
                    record_materia_1_id: t.getTmpRecordMateriaIdBySlot(1) || 0
                })
            }), e
        },
        getChangedRowInfo: function() {
            var e = {};
            return this.each(function(t) {
                var n = t.getRow(),
                    r = t.getTmpRow();
                n !== r && (e[t.get("id")] = r)
            }), e
        },
        getChangedDressRecordInfo: function() {
            var e = {};
            return this.each(function(t) {
                t.getDressRecordId() !== t.getTmpDressRecordId() && (e[t.get("id")] = {
                    dress_record_id: t.getTmpDressRecordId() || 0
                })
            }), e
        },
        fixTmpEquipments: function() {
            this.each(function(e) {
                e.fixTmpEquipments()
            })
        },
        resetTmpEquipments: function() {
            this.each(function(e) {
                e.resetTmpEquipments()
            })
        },
        fixTmpAbilities: function() {
            this.each(function(e) {
                e.fixTmpAbilities()
            })
        },
        resetTmpAbilities: function() {
            this.each(function(e) {
                e.resetTmpAbilities()
            })
        },
        fixTmpRecordMaterias: function() {
            this.each(function(e) {
                e.fixTmpRecordMaterias()
            })
        },
        resetTmpRecordMaterias: function() {
            this.each(function(e) {
                e.resetTmpRecordMaterias()
            })
        },
        fixTmpDressRecords: function() {
            this.each(function(e) {
                e.fixTmpDressRecord()
            })
        },
        resetTmpDressRecords: function() {
            this.each(function(e) {
                e.resetTmpDressRecord()
            })
        },
        fixTmpSoulStrikes: function() {
            this.each(function(e) {
                e.fixTmpSoulStrikes()
            })
        },
        resetTmpSoulStrikes: function() {
            this.each(function(e) {
                e.resetTmpSoulStrikes()
            })
        },
        fixTmpRow: function() {
            this.each(function(e) {
                e.fixTmpRow()
            })
        },
        resetTmpRow: function() {
            this.each(function(e) {
                e.resetTmpRow()
            })
        }
    })
}), define("scenes/common/models/Ability", ["./ItemBase"], function(e) {
    var t = {
        IS_USED_BY_BUDDY_CLASS_NAME: "is-in-equip"
    };
    return e.extend({
        attributeSchema: {
            id: void 0,
            inUseBy: void 0,
            tmpInUseBy: void 0
        },
        isAbility: function() {
            return !0
        },
        setTmpInUseBy: function(e) {
            var t = e.slot,
                n = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: n,
                slot: t
            })
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.slot,
                    n = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: n,
                    slot: t
                })
            } else this.clearInUseBy()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        isUsedByBuddy: function() {
            return !!this.get("inUseBy")
        },
        isUsedBySupporter: function() {
            return !1
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        getPanelName: function() {
            return this.get("panel_name").replace("{n}", "<br>")
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getIsUsedByBuddyClassNameIfUsed: function() {
            return this.isUsedByBuddy() ? t.IS_USED_BY_BUDDY_CLASS_NAME : ""
        },
        generateRequiredMaterialsData: function(e) {
            var t = {},
                n = this.getDatastore().materialCollection;
            return _.each(e, function(e, r) {
                var i = _.findWhere(n.models, {
                    id: +r
                });
                t[r] = {
                    id: +r,
                    required_num: e,
                    num: i.get("num"),
                    image_path: i.get("image_path")
                }
            }), t
        },
        canUpgradeByRecipes: function(e) {
            var t = this,
                n = this.get("next_grade");
            if (!n) return !1;
            var r = this.get("ability_id"),
                i = e[r];
            if (!i) return !1;
            var s = i[n],
                o = s.material_id_2_num;
            return this.canUpgradeByMaterialsById2Num(o)
        },
        canUpgradeByMaterials: function(e) {
            return _.every(e, function(e) {
                return e.num >= e.required_num
            })
        },
        canUpgradeByMaterialsById2Num: function(e) {
            var t = this.getDatastore().materialCollection,
                n = _.keys(e);
            for (var r = 0; r < n.length; ++r) {
                var i = n[r],
                    s = e[i],
                    o = _.findWhere(t.models, {
                        id: +i
                    });
                if (!o) return !1;
                var u = o.get("num");
                if (u < s) return !1
            }
            return !0
        },
        isMaxGrade: function(e) {
            var t = this,
                n = _.find(e, function(e, n) {
                    return t.get("ability_id") === +n
                }),
                r = _.keys(n).length;
            return this.get("grade") === r
        }
    })
}), define("scenes/common/helper/AbilityRecommend", ["underscore"], function(e) {
    var t = .85,
        n = 1 / t,
        r = {
            1: 110,
            2: 150,
            3: 205,
            4: 300,
            5: 430,
            6: 560
        },
        i = {
            1: 1,
            2: 1.6,
            3: 1.9,
            4: 2.2,
            5: 2.4
        };
    return {
        CATEGORY_TYPES: void 0,
        getAdvantageScore: function(e) {
            var t = r[e.get("rarity")],
                n = i[e.get("grade")];
            return t * n
        },
        getCategoryTypeInfo: function(t, n) {
            this.CATEGORY_TYPES || (this.CATEGORY_TYPES = this._getCategoryTypes());
            var r = this._getCategoryKeysByBuddyParams(t, n),
                i = this;
            return e.map(r, function(e) {
                return {
                    doneSearch: !1,
                    categoryTypes: i.CATEGORY_TYPES[e]
                }
            })
        },
        _getCategoryTypes: function() {
            if (!FF.CONST.SERVER.ABILITY) throw new Error("Server constants not initialized");
            var e = FF.CONST.SERVER.ABILITY.CATEGORY_TYPE_OF;
            return {
                atk: [e.PHYSICAL, e.OTHER],
                matk: [e.SUMMON, e.BLACK_MAGIC],
                mnd: [e.WHITE_MAGIC, e.SUMMON],
                matk_and_mnd: [e.SUMMON, e.BLACK_MAGIC, e.WHITE_MAGIC],
                atk_and_matk: [e.PHYSICAL, e.SUMMON, e.BLACK_MAGIC, e.OTHER],
                atk_and_mnd: [e.PHYSICAL, e.WHITE_MAGIC, e.OTHER]
            }
        },
        _getCategoryKeysByBuddyParams: function(t, n) {
            var r = ["atk", "matk", "mnd"],
                i = ["matk_and_mnd", "atk"],
                s = ["atk_and_matk", "mnd"],
                o = ["atk_and_mnd", "matk"],
                u = {
                    atk: this._getParamOf(t, "atk", n),
                    matk: this._getParamOf(t, "matk", n),
                    mnd: this._getParamOf(t, "mnd", n)
                },
                a = this,
                f = e.sortBy(r, function(e) {
                    return -u[e]
                });
            if (this._cannotDecideTop2(f, u) && this._isAllarounder(u)) return s;
            var l = e.partial(this._isMultitalented, u, f).bind(this);
            return l("matk", "mnd") ? i : l("atk", "matk") ? s : l("atk", "mnd") ? o : f
        },
        _cannotDecideTop2: function(e, t) {
            if (e.length !== 3) throw new Error("length of sortedParamKeys is expected to 3 at this time...");
            var n = t[e[1]],
                r = t[e[2]];
            return n === r
        },
        _isAllarounder: function(e) {
            var t = e.atk,
                n = e.matk,
                r = e.mnd;
            return this._isAlmostEqual(t, n) && this._isAlmostEqual(n, r) && this._isAlmostEqual(r, t)
        },
        _isMultitalented: function(e, t, n, r) {
            if (!this._isTop2(t, n, r)) return !1;
            var i = e[n],
                s = e[r];
            return this._isAlmostEqual(i, s)
        },
        _isTop2: function(e, t, n) {
            return e[0] === t && e[1] === n ? !0 : e[0] === n && e[1] === t ? !0 : !1
        },
        _isAlmostEqual: function(e, r) {
            var i = e / r;
            return t <= i && i <= n
        },
        _getParamOf: function(e, t, n) {
            if (n.useBuddyBaseParam) return e.get(t);
            if (n.useBuddyEquippedParam) return e.getParamOf(t, {
                useTmpEquipment: !0
            });
            throw new Error("Valid option not found")
        }
    }
}), define("scenes/common/collections/Ability", ["underscore", "./ItemBase", "../models/Ability", "scenes/common/helper/AbilityRecommend", "scenes/common/helper/SortAdviser"], function(e, t, n, r, i) {
    return t.extend({
        model: n,
        initialize: function() {
            this.SORT_TYPE_OF = {
                CAN_UPGRADE: "can_upgrade",
                CREATED_AT: "created_at",
                ABILITY_ID: "ability_id",
                CATEGORY: "category",
                RARITY: "rariry",
                GRADE: "grade"
            }, this._initSortAdviser(), this.changeComparator()
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        getOrderTypeOf: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF
        },
        getListForChangeDetail: function(e) {
            var t = this.filter(function(t) {
                return e.canEquipAbility(t) ? !0 : !1
            });
            return t
        },
        setRecommendedAbilities: function(t, n) {
            var r = this;
            n = n || {}, r.getDatastore().resetTmpAbilities();
            var i = this._getBuddyIdToAbilityCategoryTypeInfoList(t, n),
                s = function() {
                    return e.every(Object.keys(i), function(t) {
                        return e.every(i[t], function(e) {
                            return e.doneSearch
                        })
                    })
                },
                o = function() {
                    e.each(t, function(t) {
                        var n = i[t.get("id")],
                            s = void 0,
                            o = e.find(n, function(e, t) {
                                return s = t, !e.doneSearch
                            });
                        if (!o) return;
                        var u = e.find(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                            return !t.getTmpAbilityIdBySlot(e)
                        });
                        if (!u) {
                            i[t.get("id")][s].doneSearch = !0;
                            return
                        }
                        var a = r.getRecommendedAbilityModels(t, {
                                stayOwnAbilities: !0,
                                categoryTypes: o.categoryTypes
                            }),
                            f = a[0] ? a[0].get("id") : null;
                        f ? t.setTmpAbilityId({
                            slot: u,
                            abilityId: f,
                            isSetByRecommend: !0
                        }) : i[t.get("id")][s].doneSearch = !0
                    })
                };
            while (!s()) o()
        },
        _getBuddyIdToAbilityCategoryTypeInfoList: function(t, n) {
            n = n || {};
            var i = {};
            return e.each(t, function(e) {
                i[e.get("id")] = r.getCategoryTypeInfo(e, n)
            }), i
        },
        getRecommendedAbilityModels: function(t, n) {
            n = n || {};
            var r = n.stayOwnAbilities || !1,
                i = this.filter(function(i) {
                    if (!t.canEquipAbility(i)) return !1;
                    var s = i.get("tmpInUseBy");
                    if (r) {
                        if (s) return !1
                    } else if (s && s.buddyId !== t.get("id")) return !1;
                    return n.categoryTypes && !e.contains(n.categoryTypes, i.get("category_type")) ? !1 : !0
                }),
                s = i.sort(this._getRecommendCompareFunc(n.categoryTypes));
            return s
        },
        _getRecommendCompareFunc: function(e) {
            return function(t, n) {
                var i = r.getAdvantageScore(t),
                    s = r.getAdvantageScore(n);
                if (i > s) return -1;
                if (i < s) return 1;
                if (e) {
                    var o = e.indexOf(t.get("category_type")),
                        u = e.indexOf(n.get("category_type"));
                    if (o !== -1 && u !== -1) {
                        if (o < u) return -1;
                        if (o > u) return 1
                    }
                }
                return t.get("ability_id") < n.get("ability_id") ? -1 : t.get("ability_id") > n.get("ability_id") ? 1 : 0
            }
        },
        _initSortAdviser: function() {
            this._sortAdviser = new i({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("ability_id") < t.get("ability_id") ? -1 : e.get("ability_id") > t.get("ability_id") ? 1 : e.get("created_at") < t.get("created_at") ? -1 : e.get("created_at") > t.get("created_at") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            t || (t = {});
            var n = t.upgradeRecipeMap,
                r = t.categoryType,
                i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getBasicComparator(e, t, n)
                },
                o = this.SORT_TYPE_OF,
                u = e.sortType;
            switch (u) {
                case o.CAN_UPGRADE:
                    this.comparator = function(e, t) {
                        var r = e.canUpgradeByRecipes(n),
                            s = t.canUpgradeByRecipes(n);
                        return r && !s ? -1 : !r && s ? 1 : i._defaultComparator(e, t)
                    };
                    break;
                case o.CREATED_AT:
                    s(["created_at", "ability_id"], !0);
                    break;
                case o.ABILITY_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("ability_id");
                    break;
                case o.CATEGORY:
                    this._setCategoryComparator(e);
                    break;
                case o.RARITY:
                    s("rarity");
                    break;
                case o.GRADE:
                    s("grade");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _setCategoryComparator: function(e) {
            var t = this;
            this.comparator = function(n, r) {
                var i = e.abilityType;
                return n.get("category_type") === i && r.get("category_type") !== i ? -1 : n.get("category_type") !== i && r.get("category_type") === i ? 1 : t._defaultComparator(n, r)
            }
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBy");
                e.setInUseBy(t)
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        generateRequiredMaterialsData: function(t) {
            e.each(this.models, function(e) {
                e.generateRequiredMaterialsData(t)
            })
        },
        updateTmpInUseBy: function() {
            var t = this,
                n = {};
            this.getDatastore().buddyCollection.each(function(t) {
                var r = t.get("id");
                e.each(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                    var i = t.getTmpAbilityIdBySlot(e);
                    i && (n[+i] = {
                        buddyId: r,
                        slot: e
                    })
                })
            }), this.each(function(e) {
                var t = e.get("id");
                e.clearTmpInUseBy(), n[t] && e.setTmpInUseBy(n[t])
            })
        },
        dispose: function() {}
    })
}), define("scenes/common/models/Equipment", ["./ItemBase"], function(e) {
    var t = {
        IS_USED_BY_BUDDY_CLASS_NAME: "is-in-equip",
        IS_USED_BY_SUPPORTER_CLASS_NAME: "is-in-equip-by-supporter",
        HAS_HAMMERING_NUM_CLASS_NAME: "has-hammering-num",
        RESONATABLE_KEYS: ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp"]
    };
    return e.extend({
        attributeSchema: {
            id: void 0,
            inUseBy: void 0,
            inUseBySupporter: void 0,
            tmpInUseBy: void 0,
            tmpInUseBySupporter: void 0
        },
        seriesAtk: function(e) {
            return this.getParamOf("atk", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesDef: function(e) {
            return this.getParamOf("def", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesMatk: function(e) {
            return this.getParamOf("matk", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesMdef: function(e) {
            return this.getParamOf("mdef", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        seriesMnd: function(e) {
            return this.getParamOf("mnd", {
                seriesId: e,
                calcBoostStatus: !0
            })
        },
        isRisenAtkBySeries: function(e) {
            return this.getParamOf("atk", {
                seriesId: e
            }) > this.getParamOf("atk")
        },
        isRisenDefBySeries: function(e) {
            return this.getParamOf("def", {
                seriesId: e
            }) > this.getParamOf("def")
        },
        isRisenMatkBySeries: function(e) {
            return this.getParamOf("matk", {
                seriesId: e
            }) > this.getParamOf("matk")
        },
        isRisenMdefBySeries: function(e) {
            return this.getParamOf("mdef", {
                seriesId: e
            }) > this.getParamOf("mdef")
        },
        isRisenMndBySeries: function(e) {
            return this.getParamOf("mnd", {
                seriesId: e
            }) > this.getParamOf("mnd")
        },
        isRisenAccBySeries: function(e) {
            return this.getParamOf("acc", {
                seriesId: e
            }) > this.getParamOf("acc")
        },
        isRisenEvaBySeries: function(e) {
            return this.getParamOf("eva", {
                seriesId: e
            }) > this.getParamOf("eva")
        },
        isRisenAtkByHammering: function() {
            return this.get("hammering_affect_param_key") === "atk"
        },
        isRisenDefByHammering: function() {
            return this.get("hammering_affect_param_key") === "def"
        },
        isRisenMatkByHammering: function() {
            return this.get("hammering_affect_param_key") === "matk"
        },
        isRisenMdefByHammering: function() {
            return this.get("hammering_affect_param_key") === "mdef"
        },
        isRisenMndByHammering: function() {
            return this.get("hammering_affect_param_key") === "mnd"
        },
        getParamOf: function(e, t) {
            var n = t ? t.calcBoostStatus : !1,
                r = this._getResonanceBasedKey(e, t),
                i = this.get(r);
            return n && e === this.get("hammering_affect_param_key") && (i += this.getHammeringNum(t)), i
        },
        getResonantParamOf: function(e) {
            var t = FF.resonator ? FF.resonator.getResonantSeriesId() : 0;
            return this.getParamOf(e, {
                seriesId: t,
                calcBoostStatus: !0
            })
        },
        hasStatusBonus: function(e) {
            return e ? e.hasRoleBonus ? !0 : this.hasSeriesBonus(e.seriesId) : !1
        },
        hasSeriesBonus: function(e) {
            return this.isSameSeries(e)
        },
        hasRoleBonus: function(e) {
            var t = this.getEquippedBuddy();
            return t && e ? t.hasRoleBonus(e) : !1
        },
        getStatusBonusOpt: function(e) {
            var t = this.hasSeriesBonus(e.seriesId),
                n = this.hasRoleBonus(e.abilityCategoryBonusMap);
            return _.extend({
                hasSeriesBonus: t,
                hasRoleBonus: n
            }, e)
        },
        _getResonanceBasedKey: function(e, t) {
            t = t || {};
            if (!this.hasStatusBonus(t)) return e;
            var n = ["atk", "def", "matk", "mdef", "mnd", "acc", "eva", "hp"];
            return _.contains(n, e) ? "sp_" + e : e
        },
        getSpStatusNameOf: function(e) {
            return _.contains(t.RESONATABLE_KEYS, e) ? "sp_" + e : e
        },
        isRisenByStatusBonus: function(e) {
            return this.get(this.getSpStatusNameOf(e)) > this.get(e)
        },
        isRisenBySeriesBonus: function(e, t) {
            if (!t) return !1;
            var n = t.seriesId;
            return !n || n === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : this.hasSeriesBonus(n) && this.isRisenByStatusBonus(e)
        },
        isRisenByRoleBonus: function(e, t) {
            return t ? t.hasRoleBonus ? this.isRisenByStatusBonus(e) : !1 : !1
        },
        getHammeringNum: function(e) {
            var t = this.get("hammering_num");
            return this.hasStatusBonus(e) && (t = Math.ceil(t * FF.CONST.SERVER.EQUIPMENT.STATUS_BONUS_HAMMERING_FACTOR)), t
        },
        isEquipment: function() {
            return !0
        },
        isWeaponSpEnhancementMaterial: function() {
            return this.get("is_sp_enhancement_material") && this.get("is_weapon")
        },
        isArmorSpEnhancementMaterial: function() {
            return this.get("is_sp_enhancement_material") && this.get("is_armor")
        },
        isHammeringSpEnhancementMaterial: function() {
            return this.get("is_sp_enhancement_material") && this.get("is_hammering_item")
        },
        isMaxLv: function() {
            return this.get("level") === this.get("level_max")
        },
        isMaxHammeringNum: function() {
            return this.get("hammering_num") === this.get("max_hammering_num")
        },
        getFontColorClass: function(e) {
            return e ? e > 0 ? "fc-up" : "" : ""
        },
        getDisplayStatusValue: function(e) {
            return e ? e > 0 ? e : "- " + e * -1 : "--"
        },
        getDisplayHammeringStatusValue: function(e) {
            return e > 0 ? e : ""
        },
        getTypeName: function() {
            var e = this.get("equipment_type"),
                t = FF.CONST.SERVER.EQUIPMENT.TYPE_TO_NAME[e];
            return t.toLowerCase()
        },
        isAccessory: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ACCESSORY
        },
        _removeSoulStrikeModelIfNeed: function() {
            var e = this.get("soul_strike_id");
            if (!e) return;
            var t = this.collection.findWhere({
                soul_strike_id: e
            });
            if (t) return;
            var n = FF.datastore.buddyCollection.find(function(t) {
                var n = t.get("soul_strike_exp_map");
                return n && n[e] ? !0 : !1
            });
            if (n) return;
            FF.datastore.soulStrikeCollection.remove(e)
        },
        getSoulStrikeModel: function() {
            var e = this.get("soul_strike_id");
            return e ? FF.datastore.soulStrikeCollection.get(e) : null
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getEquippedUserSupporterBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBySupporter");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getExp: function(e, t) {
            return this.calcExp(e, t)
        },
        calcExp: function(e, t) {
            var n = this.get("level"),
                r = this.get("base_rarity"),
                i = FF.CONST.SERVER.EQUIPMENT.FUSION,
                s, o, u;
            return e === this.get("category_id") ? (s = i.ENHANCE_BASE_EXP_OF_BASE_RARITY_FOR_GENERAL[r], o = i.ENHANCE_BONUS_FACTOR_OF.SAME_CATEGORY, u = 1 + n * i.ENHANCE_LV_BONUS_FACTOR) : (s = i.ENHANCE_BASE_EXP_OF_BASE_RARITY_FOR_GENERAL[r], o = i.ENHANCE_BONUS_FACTOR_OF.DEFAULT, u = 1 + n * i.ENHANCE_LV_BONUS_FACTOR), Math.floor(s * u * o)
        },
        getExpToLvN: function(e) {
            return this.getTotalExpToLvN(e) - this.getTotalExpToLvN(e - 1)
        },
        getTotalExpToLvN: function(e) {
            var t = this.get("base_rarity"),
                n = this.get("max_evolution_num"),
                r = this.get("evol_max_level_of_base_rarity"),
                i = r[t][n],
                s = FF.CONST.SERVER.EQUIPMENT.FUSION.MAX_EXP_OF_BASE_RARITY[t],
                o = 0,
                u = Math.ceil(o + (s - o) * Math.pow((e - 1) / (i - 1), FF.CONST.SERVER.EQUIPMENT.EXP_GROW_COEFF));
            return u
        },
        getTotalExpToCurrentMaxLv: function() {
            var e = this.get("level_max");
            return this.getTotalExpToLvN(e)
        },
        getExpPerNextLvExp: function() {
            var e = this.get("level"),
                t = this.getExpToLvN(e + 1),
                n = this.get("exp"),
                r = n - this.getTotalExpToLvN(e);
            return Math.floor(r / t * 100)
        },
        setTmpInUseBy: function(e) {
            var t = e.typeName,
                n = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: n,
                typeName: t
            })
        },
        setTmpInUseBySupporter: function(e) {
            var t = e.typeName,
                n = e.buddyId;
            this.set("tmpInUseBySupporter", {
                buddyId: n,
                typeName: t
            })
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        clearTmpInUseBySupporter: function() {
            this.set("tmpInUseBySupporter", null)
        },
        fixTmpInUseBy: function() {
            var e = this.get("tmpInUseBy");
            this.setInUseBy(e)
        },
        fixTmpInUseBySupporter: function() {
            var e = this.get("tmpInUseBySupporter");
            this.setInUseBySupporter(e)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        resetTmpInUseBySupporter: function() {
            var e = this.get("inUseBySupporter");
            e ? this.setTmpInUseBySupporter(e) : this.clearTmpInUseBySupporter()
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.typeName,
                    n = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: n,
                    typeName: t
                })
            } else this.clearInUseBy()
        },
        setInUseBySupporter: function(e) {
            if (e) {
                var t = e.typeName,
                    n = e.buddyId;
                this.set("inUseBySupporter", {
                    buddyId: n,
                    typeName: t
                })
            } else this.clearInUseBySupporter()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        clearInUseBySupporter: function() {
            this.set("inUseBySupporter", null)
        },
        isUsedByBuddy: function() {
            return !!this.get("inUseBy")
        },
        isUsedBySupporter: function() {
            return !!this.get("inUseBySupporter")
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        hasHammeringNum: function() {
            return this.get("hammering_num") > 0
        },
        getIsUsedByBuddyClassNameIfUsed: function() {
            return this.isUsedByBuddy() ? t.IS_USED_BY_BUDDY_CLASS_NAME : ""
        },
        getIsUsedBySupporterClassNameIfUsed: function() {
            return this.isUsedBySupporter() ? t.IS_USED_BY_SUPPORTER_CLASS_NAME : ""
        },
        getHasHammeringNumClassNameIfHad: function() {
            return this.hasHammeringNum() ? t.HAS_HAMMERING_NUM_CLASS_NAME : ""
        },
        getGrowthRate: function(e, t) {
            var n = this.getExpToLvN(e),
                r = this.getTotalExpToLvN(e - 1),
                i = t - r;
            return Math.floor(i / n * 100)
        },
        isSameSeries: function(e) {
            return e ? e === +FF.CONST.SERVER.SERIES.EMPTY_SERIES_ID ? !1 : this.get("series_id") === e || this.get("ex_series_id") === e : !1
        },
        getSeriesIdForIcon: function() {
            var e = this.get("series_id"),
                t = this.get("ex_series_id");
            if (t) {
                var n = FF.datastore.worldCollection.getWorldModelsCanBeBegunBattleBySeriesId(t);
                if (n && n.length > 0) return t
            }
            return e
        },
        isHammeringMaterial: function() {
            return this.get("category_id") === 97
        },
        getDispName: function() {
            return this.get("description").replace(/{n}/g, "<br>")
        },
        getPlusRemovedName: function() {
            return this.get("name").replace(/＋+$/, "")
        }
    })
}), define("scenes/common/collections/Equipment", ["./ItemBase", "../models/Equipment", "util", "scenes/common/Constant", "scenes/common/helper/SortAdviser"], function(e, t, n, r, i) {
    return e.extend({
        model: t,
        initialize: function() {
            var e = this,
                t = this.TYPE_NAME_OF = FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF;
            this.SORT_TYPE_OF = {
                SERIES_ID: "series_id",
                EQUIPMENT_ID: "equipment_id",
                IN_USE: "in_use",
                CAN_EVOLVE_NOW: "can_evolve_now",
                CREATED_AT: "created_at",
                LV: "lv",
                RARITY: "rarity",
                ATK: "atk",
                DEF: "def",
                MATK: "matk",
                MDEF: "mdef",
                MND: "mnd",
                HAMMERING_NUM: "hammering_num"
            }, this._initSortAdviser(), this.changeComparator(), this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF = {}, this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.WEAPON] = {
                atk: ["atk", "matk", "mnd"],
                matk: ["atk", "matk", "mnd"],
                mnd: ["atk", "matk", "mnd"]
            }, this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ARMOR] = {
                def: ["def", "mdef"],
                mdef: ["def", "mdef"]
            }, this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ACCESSORY] = {
                atk: ["atk", "def"],
                matk: ["matk", "mdef"],
                mnd: ["mnd", "mdef"]
            }, this.BUDDY_COMPARING_PARAMS_OF = {}, this.BUDDY_COMPARING_PARAMS_OF[t.WEAPON] = _.keys(this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.WEAPON]), this.BUDDY_COMPARING_PARAMS_OF[t.ARMOR] = _.keys(this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ARMOR]), this.BUDDY_COMPARING_PARAMS_OF[t.ACCESSORY] = _.keys(this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t.ACCESSORY]), this.BUDDY_HIGHEST_PARAM_TO_ACCESSORY_COMPARE_FUNC = {
                atk: function(t) {
                    return e.getRecommendCompareFuncForAtkAccessory(t)
                },
                matk: function(t) {
                    return e.getRecommendCompareFuncForMatkAccessory(t)
                },
                mnd: function(t) {
                    return e.getRecommendCompareFuncForMndAccessory(t)
                }
            }, this.BUDDY_PARAM_WITH_SERIES_FUNC = {
                atk: function(e, t) {
                    return e.seriesAtkWithoutEquipmentParameter(t)
                },
                def: function(e, t) {
                    return e.seriesDefWithoutEquipmentParameter(t)
                },
                matk: function(e, t) {
                    return e.seriesMatkWithoutEquipmentParameter(t)
                },
                mdef: function(e, t) {
                    return e.seriesMdefWithoutEquipmentParameter(t)
                },
                mnd: function(e, t) {
                    return e.seriesMndWithoutEquipmentParameter(t)
                }
            }, this.EQUIPMENT_PARAM_WITH_SERIES_FUNC = {
                atk: function(e, t) {
                    return e.seriesAtk(t)
                },
                def: function(e, t) {
                    return e.seriesDef(t)
                },
                matk: function(e, t) {
                    return e.seriesMatk(t)
                },
                mdef: function(e, t) {
                    return e.seriesMdef(t)
                },
                mnd: function(e, t) {
                    return e.seriesMnd(t)
                }
            }, this.RECOMMEND_RARITY_THRESHOLD = 5
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        initializeInUseBySupporter: function() {
            if (!this.getDatastore().userSupporterBuddyModel) throw new Error("missing userSupporterBuddyModel");
            this.updateTmpInUseBySupporter(), this.fixTmpInUseBySupporter()
        },
        getListForChangeDetail: function(e, t, n) {
            n = n ? _.pick(n, "forSupporter") : {};
            var r = n.forSupporter ? "tmpInUseBySupporter" : "tmpInUseBy",
                i = FF.CONST.SERVER.EQUIPMENT.TYPE_OF[t.toUpperCase()],
                s = this.filter(function(t) {
                    var n = t.get(r);
                    return t.get("equipment_type") !== +i ? !1 : e.canEquipCategory(t.get("category_id")) ? n && n.buddyId === e.get("id") ? !1 : !0 : !1
                });
            return s
        },
        setRecommendedWeaponAndArmor: function(e, t) {
            var n = this;
            t = t ? _.pick(t, "seriesId") : {}, _.each(e, function(e) {
                e.takeOffWeapon(), e.takeOffArmor()
            });
            var r = [n.TYPE_NAME_OF.WEAPON, n.TYPE_NAME_OF.ARMOR],
                i = {};
            _.each(r, function(e) {
                i[e] = []
            }), _.each(r, function(t) {
                _.each(e, function(e) {
                    var r = n.getRecommendedId(e, t, {
                        unmasteredSoulStrikeFirst: !0
                    });
                    if (!r) {
                        i[t].push(e);
                        return
                    }
                    e.setTmpEquipmentId({
                        typeName: t,
                        equipmentId: r,
                        isSetByRecommend: !0
                    })
                })
            }), _.each(r, function(e) {
                _.each(i[e], function(r) {
                    var i = n.getRecommendedId(r, e, _.extend({
                        useHighestParamFilter: !0
                    }, t));
                    if (!i) return;
                    r.setTmpEquipmentId({
                        typeName: e,
                        equipmentId: i,
                        isSetByRecommend: !0
                    })
                })
            }), _.each(r, function(e) {
                _.each(i[e], function(r) {
                    var i = n.getRecommendedId(r, e, t);
                    if (!i) return;
                    r.setTmpEquipmentId({
                        typeName: e,
                        equipmentId: i,
                        isSetByRecommend: !0
                    })
                })
            })
        },
        setRecommendedAccessory: function(e, t) {
            var n = this;
            t = t ? _.pick(t, "seriesId") : {}, _.each(e, function(e) {
                e.takeOffAccessory()
            });
            var r = [];
            _.each(e, function(e) {
                var t = n.getRecommendedId(e, n.TYPE_NAME_OF.ACCESSORY, {
                    soulStrikeFirst: !0
                });
                if (!t) {
                    r.push(e);
                    return
                }
                e.setTmpEquipmentId({
                    typeName: n.TYPE_NAME_OF.ACCESSORY,
                    equipmentId: t,
                    isSetByRecommend: !0
                })
            }), _.each(e, function(e) {
                var r = n.getRecommendFilterParamsForAccessory(e, t.seriesId),
                    i = n.getRecommendedId(e, n.TYPE_NAME_OF.ACCESSORY, _.extend({
                        highestParamsToFilter: r
                    }, t));
                if (!i) return;
                e.setTmpEquipmentId({
                    typeName: n.TYPE_NAME_OF.ACCESSORY,
                    equipmentId: i,
                    isSetByRecommend: !0
                })
            }), _.each(e, function(e) {
                var r = n.getRecommendedId(e, n.TYPE_NAME_OF.ACCESSORY, t);
                if (!r) return;
                e.setTmpEquipmentId({
                    typeName: n.TYPE_NAME_OF.ACCESSORY,
                    equipmentId: r,
                    isSetByRecommend: !0
                })
            })
        },
        getRecommendedAccessoryId: function(e, t) {
            return this._getRecommendedIdForOneBuddy(e, this.TYPE_NAME_OF.ACCESSORY, {
                soulStrikeFirst: !0
            }, t)
        },
        getRecommendedArmorId: function(e, t) {
            return this._getRecommendedIdForOneBuddy(e, this.TYPE_NAME_OF.ARMOR, {
                unmasteredSoulStrikeFirst: !0
            }, t)
        },
        getRecommendedWeaponId: function(e, t) {
            return this._getRecommendedIdForOneBuddy(e, this.TYPE_NAME_OF.WEAPON, {
                unmasteredSoulStrikeFirst: !0
            }, t)
        },
        _getRecommendedIdForOneBuddy: function(e, t, n, r) {
            var i = r ? {
                    seriesId: r.seriesId
                } : {},
                s = _.extend(n, i);
            return this.getRecommendedId(e, t, s) || this.getRecommendedId(e, t, i) || this.getRecommendedId(e, t)
        },
        getRecommendedId: function(e, t, n) {
            n = n || {};
            var r = n.seriesId,
                i = this._getRecommendedSelectableModels(e, t, n),
                s = this.getRecommendCompareFunc(e, t, r),
                o = i.sort(s);
            return o[0] ? o[0].get("id") : 0
        },
        _getRecommendedSelectableModels: function(e, t, n) {
            return n.unmasteredSoulStrikeFirst ? this.getRecommendedRareModelsWithMasterableSoulStrike(e, t) : n.soulStrikeFirst ? this.getRecommendedRareModelsWithAvailableSoulStrike(e, t) : n.useHighestParamFilter || n.highestParamsToFilter ? this.getModelsMatchedHighestParam(e, t, n) : this.getWearableModels(e, t)
        },
        getRecommendedRareModelsWithMasterableSoulStrike: function(e, t) {
            var n = this.getWearableModels(e, t),
                r = this.RECOMMEND_RARITY_THRESHOLD,
                i = _.filter(n, function(t) {
                    if (t.get("rarity") < r) return !1;
                    var n = t.getSoulStrikeModel();
                    return n ? n.isOwnByBuddyId(e.get("buddy_id")) ? n.isMastered() ? !1 : !0 : !1 : !1
                });
            return i
        },
        getRecommendedRareModelsWithAvailableSoulStrike: function(e, t) {
            var n = this,
                r = this.getWearableModels(e, t),
                i = n.RECOMMEND_RARITY_THRESHOLD,
                s = _.filter(r, function(t) {
                    if (t.get("rarity") < i) return !1;
                    var n = t.getSoulStrikeModel();
                    return n ? n.isOwnByBuddyId(e.get("buddy_id")) : !1
                });
            return s.length > 0 ? s : _.filter(r, function(t) {
                if (t.get("rarity") < i) return !1;
                var n = t.getSoulStrikeModel();
                return n ? n.canEquipByBuddyId(e.get("buddy_id")) : !1
            })
        },
        getWearableModels: function(e, t) {
            var n = FF.CONST.SERVER.EQUIPMENT.TYPE_OF[t.toUpperCase()],
                r = this.filter(function(t) {
                    if (t.get("equipment_type") !== +n) return !1;
                    if (!e.canEquipCategory(t.get("category_id"))) return !1;
                    var r = t.get("tmpInUseBy");
                    return r && r.buddyId !== e.get("id") ? !1 : !0
                });
            return r
        },
        getModelsMatchedHighestParam: function(e, t, n) {
            var r = this;
            n = n || {};
            var i = n.seriesId,
                s = this.BUDDY_COMPARING_PARAMS_OF[t],
                o = _.max(s, function(t) {
                    return r.BUDDY_PARAM_WITH_SERIES_FUNC[t](e, i)
                }),
                u = n.highestParamsToFilter || [o],
                a = this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[t][o],
                f = this.getWearableModels(e, t);
            return _.filter(f, function(e) {
                var t = _.max(a, function(t) {
                    return r.EQUIPMENT_PARAM_WITH_SERIES_FUNC[t](e, i)
                });
                return e.get(t) === 0 ? !1 : _.contains(u, t)
            })
        },
        getRecommendCompareFunc: function(e, t, n) {
            if (t === this.TYPE_NAME_OF.WEAPON) return this.getRecommendCompareFuncForWeapon(e, n);
            if (t === this.TYPE_NAME_OF.ARMOR) return this.getRecommendCompareFuncForArmor(e, n);
            if (t === this.TYPE_NAME_OF.ACCESSORY) return this.getRecommendCompareFuncForAccessory(e, n);
            throw new Error("invalid typeName:" + t)
        },
        getRecommendCompareFuncForWeapon: function(e, t) {
            var n = this,
                r = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.WEAPON],
                i = _.max(r, function(r) {
                    return n.BUDDY_PARAM_WITH_SERIES_FUNC[r](e, t)
                }),
                s = n.EQUIPMENT_PARAM_WITH_SERIES_FUNC[i];
            return function(e, n) {
                return s(e, t) > s(n, t) ? -1 : s(e, t) < s(n, t) ? 1 : e.get("rarity") > n.get("rarity") ? -1 : e.get("rarity") < n.get("rarity") ? 1 : e.get("level") > n.get("level") ? -1 : e.get("level") < n.get("level") ? 1 : e.get("equipment_id") > n.get("equipment_id") ? -1 : e.get("equipment_id") < n.get("equipment_id") ? 1 : 0
            }
        },
        getRecommendCompareFuncForArmor: function(e, t) {
            var n = this,
                r = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ARMOR],
                i = _.max(r, function(r) {
                    return n.BUDDY_PARAM_WITH_SERIES_FUNC[r](e, t)
                }),
                s = n.EQUIPMENT_PARAM_WITH_SERIES_FUNC[i];
            return function(e, n) {
                return s(e, t) > s(n, t) ? -1 : s(e, t) < s(n, t) ? 1 : e.get("rarity") > n.get("rarity") ? -1 : e.get("rarity") < n.get("rarity") ? 1 : e.get("level") > n.get("level") ? -1 : e.get("level") < n.get("level") ? 1 : e.get("equipment_id") > n.get("equipment_id") ? -1 : e.get("equipment_id") < n.get("equipment_id") ? 1 : 0
            }
        },
        getRecommendCompareFuncForAccessory: function(e, t) {
            var n = this,
                r = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ACCESSORY],
                i = _.max(r, function(r) {
                    return n.BUDDY_PARAM_WITH_SERIES_FUNC[r](e, t)
                });
            return this.BUDDY_HIGHEST_PARAM_TO_ACCESSORY_COMPARE_FUNC[i](t)
        },
        getRecommendCompareFuncForAtkAccessory: function(e) {
            var t = this;
            return function(n, r) {
                return n.seriesAtk(e) > r.seriesAtk(e) ? -1 : n.seriesAtk(e) < r.seriesAtk(e) ? 1 : n.seriesDef(e) > r.seriesDef(e) ? -1 : n.seriesDef(e) < r.seriesDef(e) ? 1 : t.getRecommendCompareDefaultFuncForAccessory(n, r)
            }
        },
        getRecommendCompareFuncForMatkAccessory: function(e) {
            var t = this;
            return function(n, r) {
                return n.seriesMatk(e) > r.seriesMatk(e) ? -1 : n.seriesMatk(e) < r.seriesMatk(e) ? 1 : n.seriesMdef(e) > r.seriesMdef(e) ? -1 : n.seriesMdef(e) < r.seriesMdef(e) ? 1 : t.getRecommendCompareDefaultFuncForAccessory(n, r)
            }
        },
        getRecommendCompareFuncForMndAccessory: function(e) {
            var t = this;
            return function(n, r) {
                return n.seriesMnd(e) > r.seriesMnd(e) ? -1 : n.seriesMnd(e) < r.seriesMnd(e) ? 1 : n.seriesMdef(e) > r.seriesMdef(e) ? -1 : n.seriesMdef(e) < r.seriesMdef(e) ? 1 : t.getRecommendCompareDefaultFuncForAccessory(n, r)
            }
        },
        getRecommendCompareDefaultFuncForAccessory: function(e, t) {
            return e.get("rarity") > t.get("rarity") ? -1 : e.get("rarity") < t.get("rarity") ? 1 : e.get("equipment_id") > t.get("equipment_id") ? -1 : e.get("equipment_id") < t.get("equipment_id") ? 1 : 0
        },
        getRecommendFilterParamsForAccessory: function(e, t) {
            var n = this,
                r = this.BUDDY_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ACCESSORY],
                i = _.max(r, function(r) {
                    return n.BUDDY_PARAM_WITH_SERIES_FUNC[r](e, t)
                }),
                s = this.BUDDY_HIGHEST_PARAM_TO_EQUIPMENT_COMPARING_PARAMS_OF[this.TYPE_NAME_OF.ACCESSORY][i];
            return s
        },
        _initSortAdviser: function() {
            this._sortAdviser = new i({
                defaultComparator: this._defaultComparator.bind(this),
                paramGetter: this._getParamForSort.bind(this)
            })
        },
        _getParamForSort: function(e, t, n, r) {
            var i = {
                seriesId: n,
                hasRoleBonus: r,
                calcBoostStatus: !0
            };
            return e.getParamOf(t, i)
        },
        _defaultComparator: function(e, t) {
            return e.get("equipment_id") < t.get("equipment_id") ? -1 : e.get("equipment_id") > t.get("equipment_id") ? 1 : e.get("created_at") < t.get("created_at") ? -1 : e.get("created_at") > t.get("created_at") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("series_id");
                    break;
                case r.EQUIPMENT_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("equipment_id");
                    break;
                case r.IN_USE:
                    n("inUseBy");
                    break;
                case r.CAN_EVOLVE_NOW:
                    n("can_evolve_now");
                    break;
                case r.LV:
                    n("level");
                    break;
                case r.RARITY:
                    n("rarity");
                    break;
                case r.ATK:
                    n("atk");
                    break;
                case r.DEF:
                    n("def");
                    break;
                case r.MATK:
                    n("matk");
                    break;
                case r.MDEF:
                    n("mdef");
                    break;
                case r.MND:
                    n("mnd");
                    break;
                case r.CREATED_AT:
                    n(["created_at", "equipment_id", "id"], !0);
                    break;
                case r.HAMMERING_NUM:
                    this._setHammeringNumComparator(e);
                    break;
                default:
                    n(void 0)
            }
        },
        _setHammeringNumComparator: function(e) {
            var t = e.orderType === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC,
                n = this;
            this.comparator = function(e, r) {
                if (!e.isWeaponSpEnhancementMaterial() && r.isWeaponSpEnhancementMaterial()) return -1;
                if (e.isWeaponSpEnhancementMaterial() && !r.isWeaponSpEnhancementMaterial()) return 1;
                if (!e.isArmorSpEnhancementMaterial() && r.isArmorSpEnhancementMaterial()) return -1;
                if (e.isArmorSpEnhancementMaterial() && !r.isArmorSpEnhancementMaterial()) return 1;
                var i = e.getTypeName() === n.TYPE_NAME_OF.ACCESSORY,
                    s = r.getTypeName() === n.TYPE_NAME_OF.ACCESSORY;
                if (!i && s) return -1;
                if (i && !s) return 1;
                var o = e.get("hammering_num"),
                    u = r.get("hammering_num");
                if (t) {
                    if (o < u) return -1;
                    if (o > u) return 1
                } else {
                    if (o > u) return -1;
                    if (o < u) return 1
                }
                return n._defaultComparator(e, r)
            }
        },
        getModels: function(e) {
            var t = this;
            return _.map(e, function(e) {
                return t.find(function(t) {
                    return t.get("id") === e
                })
            })
        },
        getEnhancementSrcModels: function() {
            return this.filter(function(e) {
                return e.get("is_usable_as_enhancement_src")
            })
        },
        getEnhancementSrcWeaponModels: function() {
            return this.getEnhancementSrcModels().filter(function(e) {
                return e.get("is_weapon")
            })
        },
        getEnhancementSrcArmorModels: function() {
            return this.getEnhancementSrcModels().filter(function(e) {
                return e.get("is_armor")
            })
        },
        getEnhancementMaterialModels: function() {
            return this.filter(function(e) {
                return e.get("is_usable_as_enhancement_material")
            })
        },
        getEvolutionSrcModels: function() {
            var e = this,
                t = this.countBy(function(e) {
                    return e.get("equipment_id")
                }),
                n = this.filter(function(e) {
                    return e.get("can_evolve_potentially") ? t[e.get("equipment_id")] >= 2 : !1
                });
            return n
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                e.fixTmpInUseBy()
            })
        },
        fixTmpInUseBySupporter: function() {
            this.each(function(e) {
                e.fixTmpInUseBySupporter()
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        resetTmpInUseBySupporter: function() {
            this.each(function(e) {
                e.resetTmpInUseBySupporter()
            })
        },
        updateTmpInUseBy: function() {
            var e = this,
                t = {};
            this.getDatastore().buddyCollection.each(function(e) {
                var n = e.get("id");
                _.each(FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF, function(r) {
                    var i = e.getTmpEquipmentIdByTypeName(r);
                    i && (t[+i] = {
                        buddyId: n,
                        typeName: r
                    })
                })
            }), this.each(function(e) {
                var n = e.get("id");
                e.clearTmpInUseBy(), t[n] && e.setTmpInUseBy(t[n])
            })
        },
        updateTmpInUseBySupporter: function() {
            var e = this,
                t = this.getDatastore().userSupporterBuddyModel;
            this.each(function(e) {
                var n = e.getTypeName(),
                    r = e.get("id");
                e.clearTmpInUseBySupporter(), r === t.getTmpEquipmentIdByTypeName(n) && e.setTmpInUseBySupporter({
                    buddyId: t.get("id"),
                    typeName: n
                })
            })
        },
        removeSoulStrikeIfRemoved: function(e) {
            var t = this;
            this.each(function(e) {
                e.listenTo(e, "remove", e._removeSoulStrikeModelIfNeed)
            })
        }
    })
}), define("scenes/common/models/RecordMateria", ["./ItemBase"], function(e) {
    var t = {
        DISP_TYPE_CLASS_NAME_MAP: {
            1: "icon-record-materia-attack",
            2: "icon-record-materia-defense",
            3: "icon-record-materia-hp",
            4: "icon-record-materia-magic",
            5: "icon-record-materia-status",
            6: "icon-record-materia-other"
        }
    };
    return e.extend({
        idAttribute: "record_materia_id",
        attributeSchema: {
            record_materia_id: void 0,
            inUseBy: void 0,
            tmpInUseBy: void 0
        },
        isRecordMateria: function() {
            return !0
        },
        setTmpInUseBy: function(e) {
            var t = e.slot,
                n = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: n,
                slot: t
            })
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.slot,
                    n = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: n,
                    slot: t
                })
            } else this.clearInUseBy()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getBuddy: function() {
            var e = FF.datastore.buddyCollection;
            return e.findWhere({
                buddy_id: this.get("buddy_id")
            })
        },
        isAcquired: function() {
            return !!this.get("created_at")
        },
        isFavorite: function() {
            return this.get("is_favorite")
        },
        getDispTypeClassName: function() {
            var e = t.DISP_TYPE_CLASS_NAME_MAP[this.get("disp_type")];
            if (!e) throw new Error("invalid disp_type: " + e + "");
            return e
        }
    })
}), define("scenes/common/collections/RecordMateria", ["underscore", "./ItemBase", "../models/RecordMateria", "scenes/common/helper/SortAdviser"], function(e, t, n, r) {
    return t.extend({
        model: n,
        initialize: function() {
            this.SORT_TYPE_OF = {
                RECORD_MATERIA_ID: "record_materia_id",
                IS_ACQUIRED: "acquired",
                IS_FAVORITE: "is_favorite",
                IS_NOT_ACQUIRED: "not_acquired",
                CREATED_AT: "created_at",
                CHARA_ROLE: "chara_role",
                BUDDY_SERIES_ID: "buddy_series_id"
            }, this._initSortAdviser(), this.changeComparator()
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        getModelsThatExcludesModels: function(t) {
            return this.reject(function(n) {
                return e.some(t, function(t) {
                    return e.isEqual(n, t)
                })
            })
        },
        getListForChangeDetail: function(e) {
            var t = this.filter(function(t) {
                return t.id === e.getTmpRecordMateriaIdBySlot(1) ? !1 : !0
            });
            return t
        },
        getRelatedListByBuddyModel: function(e) {
            return this.filter(function(t) {
                return t.get("buddy_id") === e.get("buddy_id")
            })
        },
        getRemainingList: function() {
            var e = this.filter(function(e) {
                var t = e.get("inUseBy"),
                    n = e.get("tmpInUseBy");
                return t || n ? !1 : !0
            });
            return e
        },
        _initSortAdviser: function() {
            this._sortAdviser = new r({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            if (e.get("buddy_series_id")) {
                if (e.get("buddy_series_id") < t.get("buddy_series_id")) return -1;
                if (e.get("buddy_series_id") > t.get("buddy_series_id")) return 1
            }
            return e.get("record_materia_id") < t.get("record_materia_id") ? -1 : e.get("record_materia_id") > t.get("record_materia_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this.SORT_TYPE_OF,
                n = e.sortType;
            n === t.BUDDY_SERIES_ID && this._appendSeriesId(FF.datastore.buddyCollection);
            var r = this,
                i = function(t, n) {
                    r.comparator = r._sortAdviser.getComparator(e, t, n)
                };
            switch (n) {
                case t.RECORD_MATERIA_ID:
                    this.comparator = this._defaultComparator;
                    break;
                case t.CREATED_AT:
                    i("created_at");
                    break;
                case t.BUDDY_SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, this._sortAdviser.setOptions({
                        seriesIdKey: "series_id"
                    }), i("series_id");
                    break;
                case t.IS_FAVORITE:
                    this.comparator = function(e, t) {
                        var n = e.isFavorite() ? 1 : 0,
                            i = t.isFavorite() ? 1 : 0;
                        return n < i ? 1 : n > i ? -1 : r._defaultComparator(e, t)
                    };
                    break;
                case t.IS_ACQUIRED:
                    this.comparator = function(e, t) {
                        var n = e.isAcquired() ? 1 : 0,
                            i = t.isAcquired() ? 1 : 0;
                        return n < i ? -1 : n > i ? 1 : r._defaultComparator(e, t)
                    };
                    break;
                case t.IS_NOT_ACQUIRED:
                    this.comparator = function(e, t) {
                        var n = e.isAcquired() ? 1 : 0,
                            i = t.isAcquired() ? 1 : 0;
                        return n > i ? -1 : n < i ? 1 : r._defaultComparator(e, t)
                    };
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        changeComparatorForAchievementRoom: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            (r === n.IS_ACQUIRED || r === n.IS_NOT_ACQUIRED) && this._appendIsAchieved(t);
            var i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getComparator(e, t, n)
                };
            switch (r) {
                case n.IS_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC, s("is_achieved");
                    break;
                case n.IS_NOT_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("is_achieved");
                    break;
                case n.CREATED_AT:
                    s("created_at");
                    break;
                case n.BUDDY_SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, this._sortAdviser.setOptions({
                        seriesIdKey: "buddy_series_id"
                    }), s("buddy_series_id");
                    break;
                case n.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, this._sortAdviser.setOptions({
                        roleTypeKey: "buddy_role_type"
                    }), s("buddy_role_type");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _appendIsAchieved: function(e) {
            if (!e) return;
            this.each(function(t) {
                var n = t.get("record_materia_id"),
                    r = e[n] ? 1 : 0;
                t.set("is_achieved", r)
            })
        },
        getRecommendComparatorFunc: function() {
            var e = this;
            return function(t, n) {
                return t.get("step") > n.get("step") ? -1 : t.get("step") < n.get("step") ? 1 : e._defaultComparator(t, n)
            }
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBy");
                e.setInUseBy(t)
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        updateTmpInUseBy: function() {
            var t = this,
                n = {};
            this.getDatastore().buddyCollection.each(function(t) {
                var r = t.get("id");
                e.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(e) {
                    var i = t.getTmpRecordMateriaIdBySlot(e);
                    i && (n[+i] = {
                        buddyId: r,
                        slot: e
                    })
                })
            }), this.each(function(e) {
                var t = e.get("record_materia_id");
                e.clearTmpInUseBy(), n[t] && e.setTmpInUseBy(n[t])
            })
        },
        setRecommended: function(t) {
            var n = this,
                r = e.filter(t, function(e) {
                    return e.canSetRecordMateria()
                });
            e.each(r, function(t) {
                var r = n.getRelatedListByBuddyModel(t).filter(function(e) {
                        return !e.get("inUseBy") && !e.get("tmpInUseBy")
                    }),
                    i = r.sort(n.getRecommendComparatorFunc());
                e.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(e) {
                    var n = t.getRecordMateriaBySlot(e) || i.shift();
                    if (!n) return;
                    t.setTmpRecordMateriaId({
                        slot: e,
                        recordMateriaId: n.get("record_materia_id"),
                        isSetByRecommend: !0
                    })
                })
            });
            var i = n.getRemainingList(),
                s = i.sort(n.getRecommendComparatorFunc());
            e.each(r, function(t) {
                e.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(e) {
                    if (t.getTmpRecordMateriaBySlot(e)) return;
                    var n = t.getRecordMateriaBySlot(e) || i.shift();
                    if (!n) return;
                    t.setTmpRecordMateriaId({
                        slot: e,
                        recordMateriaId: n.get("record_materia_id"),
                        isSetByRecommend: !0
                    })
                })
            })
        },
        dispose: function() {}
    })
}), define("scenes/common/models/Material", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        getSellNum: function() {
            return this.get("num")
        },
        isMaterial: function() {
            return !0
        },
        getConvertRate: function(e) {
            var t = this.get("rarity") - e.get("rarity");
            return t < 0 && (t = 0), Math.floor(Math.pow(10, t))
        },
        isConvertible: function() {
            var e = FF.CONST.SERVER.ABILITY_MATERIAL.CONVERTIBLE_MAX_RARITY;
            return this.get("num") > 0 && this.get("rarity") <= e
        },
        isConvertibleAndSameTypeWithoutSameId: function(e) {
            var t = e.get("id"),
                n = e.get("type"),
                r = FF.CONST.SERVER.ABILITY_MATERIAL.CONVERTIBLE_MAX_RARITY;
            return this.get("type") === n && this.get("rarity") <= r && this.get("id") !== t
        },
        isAvailableForSale: function() {
            return this.get("type") === FF.CONST.SERVER.ABILITY_MATERIAL.TYPE_OF.MEMORY ? !1 : !0
        }
    })
}), define("scenes/common/collections/Material", ["./ItemBase", "../models/Material", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                ID: "id",
                RARITY: "rarity"
            }, this._initSortAdviser()
        },
        getRarityTypeSortedList: function(e) {
            var t = this,
                n = _.map(e, function(e) {
                    return t.get(e)
                }),
                r = n.sort(this.rarityTypeCompareFunc);
            return r
        },
        rarityTypeCompareFunc: function(e, t) {
            return e.get("rarity") > t.get("rarity") ? -1 : e.get("rarity") < t.get("rarity") ? 1 : e.get("type") < t.get("type") ? -1 : e.get("type") > t.get("type") ? 1 : 0
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("type") < t.get("type") ? -1 : e.get("type") > t.get("type") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            switch (r) {
                case n.ID:
                    this.comparator = this._defaultComparator;
                    break;
                case n.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        getBlockSellData: function(e) {
            var t = {},
                n = _.indexBy(this.models, "id");
            return _.each(e, function(e) {
                t[e] = n[e].get("num")
            }), t
        },
        getAvailableModels: function() {
            return this.filter(function(e) {
                return 0 < e.get("num")
            })
        },
        getConvertibleModels: function() {
            return this.filter(function(e) {
                return e.isConvertible()
            })
        },
        getAvailableLength: function() {
            return this.getAvailableModels().length
        },
        getConvertibleAndSameTypeWithoutSameIdModels: function(e) {
            return this.filter(function(t) {
                return t.isConvertibleAndSameTypeWithoutSameId(e)
            })
        },
        getModelsFromIdMap: function(e) {
            return this.filter(function(t) {
                return e.hasOwnProperty(t.get("id"))
            })
        }
    })
}), define("scenes/common/models/MemoryCrystal", ["./ItemBase"], function(e) {
    return e.extend({
        idAttribute: "memory_crystal_id",
        attributeSchema: {
            memory_crystal_id: void 0
        },
        isMemoryCrystal: function() {
            return !0
        },
        getBuddy: function() {
            var e = FF.datastore.buddyCollection;
            return e.findWhere({
                buddy_id: this.get("buddy_id")
            })
        }
    })
}), define("scenes/common/collections/MemoryCrystal", ["./ItemBase", "../models/MemoryCrystal", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                IS_ACQUIRED: "acquired",
                IS_NOT_ACQUIRED: "not_acquired",
                CREATED_AT: "created_at",
                CHARA_ROLE: "chara_role",
                SERIES_ID: "series_id"
            }, this._initSortAdviser(), this.changeComparator()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this),
                roleTypeKey: "buddy_role_type"
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : e.get("memory_crystal_id") < t.get("memory_crystal_id") ? -1 : e.get("memory_crystal_id") > t.get("memory_crystal_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.CREATED_AT:
                    n("created_at");
                    break;
                case r.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("series_id");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        changeComparatorForAchievementRoom: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            (r === n.IS_ACQUIRED || r === n.IS_NOT_ACQUIRED) && this._appendIsAchieved(t);
            var i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getComparator(e, t, n)
                };
            switch (r) {
                case n.IS_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC, s("is_achieved");
                    break;
                case n.IS_NOT_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("is_achieved");
                    break;
                case n.CREATED_AT:
                    s("created_at");
                    break;
                case n.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("series_id");
                    break;
                case n.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("buddy_role_type");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _appendIsAchieved: function(e) {
            if (!e) return;
            this.each(function(t) {
                var n = t.get("memory_crystal_id"),
                    r = e[n] ? 1 : 0;
                t.set("is_achieved", r)
            })
        },
        getModels: function(e) {
            return _.map(e, function(e) {
                return this.get(e)
            }.bind(this))
        }
    })
}), define("scenes/common/models/GrowEgg", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        getSellNum: function() {
            return this.get("num")
        },
        isGrowEgg: function() {
            return !0
        }
    })
}), define("scenes/common/collections/GrowEgg", ["./ItemBase", "../models/GrowEgg", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SELL_IDS_KEY_NAME = "grow_egg_id_to_num", this.SORT_TYPE_OF = {
                RARITY: "rarity"
            }, this._initSortAdviser()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this,
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        getSellData: function(e, t) {
            var n = {};
            return n[this.SELL_IDS_KEY_NAME] = {}, n[this.SELL_IDS_KEY_NAME][e] = t, n
        },
        getBlockSellData: function(e) {
            var t = this,
                n = {};
            n[this.SELL_IDS_KEY_NAME] = {};
            var r = _.indexBy(this.models, "id");
            return _.each(e, function(e) {
                n[t.SELL_IDS_KEY_NAME][e] = r[e].get("num")
            }), n
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/common/models/SoulStrike", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0
        },
        getSoulStrikeGaugeClassName: function() {
            var e = this.get("consume_ss_gauge");
            switch (e) {
                case 1:
                    return "is-gauge1";
                case 2:
                    return "is-gauge2";
                case 3:
                    return "is-gauge3";
                default:
                    throw new Error("invalid consume_ss_gauge: " + e + "")
            }
        },
        getExtensiveDescription: function() {
            return this.get("extensive_description") || this.get("description")
        },
        canEquipByBuddyId: function(e) {
            var t = this.get("allowed_buddy_id");
            return t ? t === e : !0
        },
        isEquippedByBuddy: function(e) {
            var t = this.get("id"),
                n = e.getTmpSoulStrikeIds();
            return _.indexOf(n, t) >= 0
        },
        isSomeones: function() {
            return !!this.get("allowed_buddy_id")
        },
        isOwnByBuddyId: function(e) {
            return this.get("allowed_buddy_id") === e
        },
        isMastered: function() {
            return this.getExpRate() === 100
        },
        isDefaultSoulStrike: function(e) {
            return this.get("id") === e
        },
        isCommon: function() {
            return this.get("allowed_buddy_id") === 0
        },
        getExpRate: function() {
            var e = +this.get("allowed_buddy_id");
            if (!e) return 0;
            var t = FF.datastore.buddyCollection.findWhere({
                buddy_id: e
            });
            if (!t) return 0;
            var n = t.get("soul_strike_exp_map")[String(this.get("id"))];
            return n ? _.min([100, Math.floor(n / this.get("required_exp") * 100)]) : 0
        },
        getDispName: function() {
            return this.get("disp_name").replace("{n}", "<br>")
        }
    })
}), define("scenes/common/collections/SoulStrike", ["lib/Collection", "../models/SoulStrike"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/common/models/DressRecord", ["./ItemBase"], function(e) {
    var t = {};
    return e.extend({
        idAttribute: "dress_record_id",
        attributeSchema: {
            dress_record_id: void 0,
            inUseBy: void 0,
            inUseBySupporter: void 0,
            tmpInUseBy: void 0,
            tmpInUseBySupporter: void 0
        },
        isDressRecord: function() {
            return !0
        },
        setTmpInUseBy: function(e) {
            var t = e.buddyId;
            this.setSilent("tmpInUseBy", {
                buddyId: t
            })
        },
        setTmpInUseBySupporter: function(e) {
            var t = e.buddyId;
            this.setSilent("tmpInUseBySupporter", {
                buddyId: t
            })
        },
        setInUseBy: function(e) {
            if (e) {
                var t = e.buddyId;
                this.setSilent("inUseBy", {
                    buddyId: t
                })
            } else this.clearInUseBy()
        },
        setInUseBySupporter: function(e) {
            if (e) {
                var t = e.buddyId;
                this.setSilent("inUseBySupporter", {
                    buddyId: t
                })
            } else this.clearInUseBy()
        },
        clearInUseBy: function() {
            this.setSilent("inUseBy", null)
        },
        clearTmpInUseBy: function() {
            this.setSilent("tmpInUseBy", null)
        },
        clearTmpInUseBySupporter: function() {
            this.setSilent("tmpInUseBySupporter", null)
        },
        clearInUseBySupporter: function() {
            this.setSilent("inUseBySupporter", null)
        },
        resetTmpInUseBy: function() {
            var e = this.get("inUseBy");
            e ? this.setTmpInUseBy(e) : this.clearTmpInUseBy()
        },
        resetTmpInUseBySupporter: function() {
            var e = this.get("inUseBySupporter");
            e ? this.setTmpInUseBySupporter(e) : this.clearTmpInUseBySupporter()
        },
        isUsedByParty: function() {
            var e = this.get("inUseBy");
            if (!e) return !1;
            var t = e.buddyId,
                n = this.getDatastore().buddyCollection.get(t);
            return n.isInParty()
        },
        getEquippedBuddy: function() {
            var e = FF.datastore.buddyCollection,
                t = this.get("inUseBy");
            if (!t) return null;
            var n = t.buddyId;
            return e.get(n)
        },
        getBuddy: function() {
            var e = FF.datastore.buddyCollection;
            return e.findWhere({
                buddy_id: this.get("buddy_id")
            })
        },
        getImagePath: function(e) {
            if (!e) throw new Error("not image_type");
            var t;
            this.get("dress_record_id") === FF.CONST.SERVER.DRESS_RECORD.DEFAULT_DRESS_RECORD_ID ? t = this.get("buddy_id") + ".png" : t = this.get("dress_record_id") + ".png";
            var n = e + ".png";
            return this.get("image_path").replace(t, n)
        },
        getDispName: function() {
            return this.get("disp_name").replace("{n}", "<br>")
        }
    })
}), define("scenes/common/collections/DressRecord", ["./ItemBase", "../models/DressRecord", "scenes/common/helper/SortAdviser", "lib/TextMaster"], function(e, t, n, r) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                IS_ACQUIRED: "acquired",
                IS_NOT_ACQUIRED: "not_acquired",
                CREATED_AT: "created_at",
                CHARA_ROLE: "chara_role",
                SERIES_ID: "series_id"
            }, this._initSortAdviser(), this.changeComparator()
        },
        initializeInUseBy: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBy(), this.fixTmpInUseBy()
        },
        initializeInUseBySupporter: function() {
            if (!this.getDatastore().buddyCollection) throw new Error("missing buddyCollection");
            this.updateTmpInUseBySupporter(), this.fixTmpInUseBySupporter()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this),
                roleTypeKey: "buddy_role_type"
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("dress_record_id") < t.get("dress_record_id") ? -1 : e.get("dress_record_id") > t.get("dress_record_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = function(n, r) {
                    t.comparator = t._sortAdviser.getComparator(e, n, r)
                },
                r = this.SORT_TYPE_OF,
                i = e.sortType;
            switch (i) {
                case r.CREATED_AT:
                    n("created_at");
                    break;
                case r.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, n("series_id");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        updateTmpInUseBy: function() {
            var e = {};
            this.getDatastore().buddyCollection.each(function(t) {
                var n = t.get("id"),
                    r = t.getTmpDressRecordId();
                r && (e[+r] = {
                    buddyId: n
                })
            }), this.each(function(t) {
                var n = t.get("dress_record_id");
                t.clearTmpInUseBy(), e[n] && t.setTmpInUseBy(e[n])
            })
        },
        updateTmpInUseBySupporter: function() {
            var e = this.getDatastore().userSupporterBuddyModel;
            this.each(function(t) {
                t.clearTmpInUseBySupporter();
                var n = t.get("dress_record_id");
                n === e.getTmpDressRecordId() && t.setTmpInUseBySupporter({
                    buddyId: e.get("id")
                })
            })
        },
        fixTmpInUseBy: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBy");
                e.setInUseBy(t)
            })
        },
        fixTmpInUseBySupporter: function() {
            this.each(function(e) {
                var t = e.get("tmpInUseBySupporter");
                e.setInUseBySupporter(t)
            })
        },
        resetTmpInUseBy: function() {
            this.each(function(e) {
                e.resetTmpInUseBy()
            })
        },
        resetTmpInUseBySupporter: function() {
            this.each(function(e) {
                e.resetTmpInUseBySupporter()
            })
        },
        clearSupporterTmpDressRecords: function() {
            this.each(function(e) {
                e.clearTmpInUseBySupporter()
            })
        },
        getListForChangeDetail: function(e, t) {
            t = t ? _.pick(t, "forSupporter") : {};
            var n = t.forSupporter ? "tmpInUseBySupporter" : "tmpInUseBy",
                r = this.filter(function(t) {
                    var r = t.get(n);
                    return e.canEquipDressRecord(t.get("buddy_id")) ? !0 : !1
                });
            return r.unshift(this.getDefaultDressRecordModel(e)), r
        },
        getDefaultDressRecordModel: function(e) {
            var n = FF.CONST.SERVER.DRESS_RECORD.DEFAULT_DRESS_RECORD_ID;
            return new t({
                buddy_id: e.get("buddy_id"),
                dress_record_id: n,
                image_path: e.get("default_image_path"),
                name: e.get("dress_record_name"),
                disp_name: e.get("dress_record_name")
            })
        },
        getModels: function(e) {
            return _.map(e, function(e) {
                return this.get(e)
            }.bind(this))
        },
        hasDressRecord: function() {
            return this.models.length > 0
        },
        hasDressRecordByBuddyId: function(e) {
            return this.some(function(t) {
                return t.get("buddy_id") === e
            }, e)
        }
    })
}), define("scenes/common/models/ItemPossessionLimit", ["lib/Model"], function(e) {
    return e.extend({
        isOverLimit: function() {
            return this.get("current_num") > this.get("max_num")
        },
        isOverOrMaxLimit: function() {
            return this.get("current_num") >= this.get("max_num")
        },
        isItemPossessionLimitMax: function() {
            var e = this.get("max_num"),
                t = this.get("item_type_name"),
                n = FF.Config.server.itemPossessionLimit[t];
            if (!n) throw new Error("invalid type: " + t);
            return e >= n.expandableLimit
        }
    })
}), define("scenes/common/collections/ItemPossessionLimit", ["./ItemBase", "../models/ItemPossessionLimit"], function(e, t) {
    return e.extend({
        model: t,
        isOverLimit: function() {
            return _.some(this.models, function(e) {
                return e.isOverLimit()
            })
        },
        findByTypeName: function(e) {
            return this.findWhere({
                item_type_name: e
            })
        },
        update: function(e) {
            _.each(e, function(e) {
                var t = this.findByTypeName(e.item_type_name);
                if (!t) throw new Error("invalid item_type : " + e.item_type_name);
                t.set(e)
            }.bind(this))
        }
    })
}), define("scenes/common/models/AbilityGenerationRecipe", ["lib/Model"], function(e) {
    return e.extend({
        isEquipment: function() {
            return !1
        },
        isAbility: function() {
            return !0
        },
        setHasNum: function(e) {
            var t = e.where({
                ability_id: this.get("id")
            }).length;
            this.set("has_num", t)
        },
        canGenerate: function() {
            var e = this.getDatastore().materialCollection,
                t = 0,
                n = this.get("material_id_2_num"),
                r = _.keys(n).length;
            return _.each(n, function(n, r) {
                var i = _.findWhere(e.models, {
                    id: +r
                });
                i.get("num") >= n.required_num && t++
            }), r === t
        },
        generateRequiredMaterialsData: function(e) {
            var t = this.get("material_id_2_num");
            _.each(t, function(n, r) {
                var i = e.get(+r);
                if (_.isObject(n)) {
                    t[r].num = i.get("num");
                    return
                }
                t[r] = {
                    id: +r,
                    required_num: n,
                    num: i.get("num"),
                    image_path: i.get("image_path")
                }
            })
        },
        updateRequiredMaterialsNum: function(e) {
            var t = this.get("material_id_2_num");
            _.each(t, function(n, r) {
                var i = _.findWhere(e.models, {
                    id: +r
                });
                t[r].num = i.get("num")
            })
        },
        hasSameRequiredMaterialIds: function(e) {
            var t = _.keys(this.get("material_id_2_num"));
            return _.intersection(t, e).length > 0
        },
        getPanelName: function() {
            return this.get("panel_name").replace("{n}", "<br>")
        }
    })
}), define("scenes/common/collections/AbilityGenerationRecipe", ["./ItemBase", "../models/AbilityGenerationRecipe", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                CAN_GENERATE: "can_generate",
                ABILITY_ID: "ability_id",
                RARITY: "rariry"
            }, this._initSortAdviser()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        getOrderTypeOf: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF
        },
        setHasNum: function() {
            var e = this.getDatastore().abilityCollection;
            _.each(this.models, function(t) {
                t.setHasNum(e)
            })
        },
        generateRequiredMaterialsData: function(e) {
            _.each(this.models, function(t) {
                t.generateRequiredMaterialsData(e)
            })
        },
        updateRequiredMaterialsNum: function(e, t) {
            _.each(this.models, function(n) {
                if (!n.hasSameRequiredMaterialIds(t)) return;
                n.updateRequiredMaterialsNum(e)
            })
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("ability_id") < t.get("ability_id") ? -1 : e.get("ability_id") > t.get("ability_id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = this.SORT_TYPE_OF,
                r = e.sortType;
            switch (r) {
                case n.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                case n.ABILITY_ID:
                    this.comparator = this._defaultComparator;
                    break;
                case n.CAN_GENERATE:
                    this.comparator = function(e, n) {
                        return e.canGenerate() && !n.canGenerate() ? -1 : !e.canGenerate() && n.canGenerate() ? 1 : t._defaultComparator(e, n)
                    };
                    break;
                default:
                    this.comparator = function(e, n) {
                        return e.canGenerate() && !n.canGenerate() ? -1 : !e.canGenerate() && n.canGenerate() ? 1 : t._defaultComparator(e, n)
                    }
            }
        }
    })
}), define("event/EventBase", ["backbone", "lib/Model", "sprintf", "util"], function(e, t, n, r) {
    return t.extend({
        isTypeWday: function() {
            return this.get("type_name") === "wday"
        },
        isTypeChallenge: function() {
            return this.get("type_name") === "challenge"
        },
        isTypeSpecial: function() {
            return this.get("type_name") === "special"
        },
        isTypeColiseum: function() {
            return this.get("type_name") === "coliseum"
        },
        isTypeExtreme: function() {
            return this.get("type_name") === "extreme"
        },
        isTypeSelectPrize: function() {
            return this.get("type_name") === "select_prize"
        },
        getApiOptions: function() {
            return {
                eventId: this.get("id"),
                eventType: this.get("type_name")
            }
        },
        getIntroFragment: function() {
            return n("#event/%s/intro", this.get("id"))
        },
        getDungeonListFragment: function(e) {
            e = e || {};
            var t = e.isForce ? FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE : FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL;
            return n("#event/%s/%s/dungeon/list/%d", this.get("type_name"), this.get("world_id"), t)
        },
        getDungeonDetailFragment: function(e, t) {
            return n("#event/%s/%s/dungeon/%s/%s", this.get("type_name"), this.get("world_id"), t, e)
        },
        getBattleListFragment: function(e) {
            return n("#event/%s/%s/battles/%s", this.get("type_name"), this.get("world_id"), e)
        },
        getKeptOutFragment: function() {
            return this.isTypeSpecial() ? n("#event/%s/%s/prize_exchange", this.get("type_name"), this.get("world_id")) : this.get("id") === FF.CONST.CLIENT.EVENT_ID_OF.FES_3.CHALLENGE ? "#event/challenge_fes3/prize_room" : "#events"
        }
    })
}), define("scenes/common/models/Event", ["underscore", "backbone", "lib/Model", "event/EventBase", "sprintf", "util"], function(e, t, n, r, i, s) {
    return r.extend({
        getHelper: function() {
            return FF.Events[this.get("type_name")].app.helper
        },
        getWorldModel: function() {
            if (this.worldModel) return this.worldModel;
            var e = FF.datastore.worldCollection.get(this.get("world_id"));
            if (!e) throw new Error("missing worldModel : " + this.get("world_id"));
            return this.worldModel = e, e
        },
        getTermText: function() {
            return this.getHelper().getTermText(this)
        },
        canShowEventList: function() {
            return this.getHelper().canShowEventList(this)
        },
        getImagePath: function() {
            return this.getHelper().getImagePath(this)
        },
        getBackgroundImagePath: function() {
            return this.getHelper().getBackgroundImagePath(this)
        },
        isBattleListBgTypeEvent: function() {
            var e = FF.CONST.SERVER.EVENT.BATTLE_LIST_BG_TYPE_OF;
            return this.get("battle_list_bg_type") === e.EVENT
        },
        isBattleListBgTypeEachBattle: function() {
            var e = FF.CONST.SERVER.EVENT.BATTLE_LIST_BG_TYPE_OF;
            return this.get("battle_list_bg_type") === e.EACH_BATTLE
        },
        getEventKeptOutAt: function() {
            return this.getWorldModel().get("kept_out_at")
        },
        getEventClosedAt: function() {
            return this.getWorldModel().get("closed_at")
        },
        isEventTypeExtreme: function() {
            return +this.get("type") === +FF.CONST.SERVER.EVENT.TYPE_OF.EXTREME
        },
        getExtremeDungeonListFragment: function(e) {
            e = e || {};
            var t = this.get("world_id"),
                n = FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL,
                r = FF.datastore.stash.hasShownFirstTimeEventIntroPage[this.get("id")];
            return i("#event/extreme/%s/dungeon/list/%s/%s/%s", t, n, void 0, r)
        },
        isExOpened: function() {
            var e = this.get("ex_opened_at");
            return e > 0 ? s.getTimeAsSec() >= e : !1
        }
    })
}), define("scenes/common/collections/Event", ["lib/Collection", "../models/Event"], function(e, t) {
    return e.extend({
        model: t,
        comparator: function(e, t) {
            return e.get("order_weight") < t.get("order_weight") ? 1 : e.get("order_weight") > t.get("order_weight") ? -1 : e.get("id") < t.get("id") ? 1 : e.get("id") > t.get("id") ? -1 : 0
        },
        getByWorldId: function(e) {
            return this.findWhere({
                world_id: +e
            })
        },
        getEventModelsByType: function(e) {
            return this.filter(function(t) {
                return t.get("type") == +e
            })
        },
        getEventModelsForTop: function() {
            return this.sort(), this.filter(function(e) {
                return e.getWorldModel().isOpenedToClosedTerm()
            })
        }
    })
}), define("scenes/common/models/World", ["backbone", "lib/Model", "sprintf", "util", "components/TimeKeeper"], function(e, t, n, r, i) {
    return t.extend({
        isNormalWorld: function() {
            return this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.NORMAL
        },
        isEventWorld: function() {
            return this.get("type") === FF.CONST.SERVER.WORLD.TYPE_OF.EVENT
        },
        isUnlocked: function() {
            return this.get("is_unlocked")
        },
        isLocked: function() {
            return !this.isUnlocked()
        },
        isOpenedToClosedTerm: function() {
            var e = r.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        canBeginBattleTerm: function() {
            var e = r.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("kept_out_at") > e
        },
        isKeptOutToClosedTerm: function() {
            var e = r.getTimeAsSec();
            return this.get("kept_out_at") <= e && this.get("closed_at") > e
        },
        unlocked: function() {
            this.set("is_unlocked", !0)
        },
        getEventModel: function() {
            if (!this.isEventWorld()) return null;
            if (this.eventModel) return this.eventModel;
            var e = FF.datastore.eventCollection.getByWorldId(this.get("id"));
            if (!e) throw new Error("missing eventModel : " + this.get("id"));
            return this.eventModel = e, this.eventModel
        },
        getEventId: function() {
            return this.isEventWorld() ? this.getEventModel().get("id") : null
        },
        getApiOptions: function() {
            return this.isEventWorld() ? this.getEventModel().getApiOptions() : {}
        },
        getWorldListFragment: function() {
            return this.isEventWorld() ? "#events" : n("#world/%s", this.get("id"))
        },
        getDungeonListFragment: function(e) {
            e = e || {};
            if (this.isEventWorld()) return this.getEventModel().getDungeonListFragment(e);
            var t = e.isForce ? FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE : FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL;
            return n("#world/%s/dungeon/list/%d", this.get("id"), t)
        },
        getDungeonDetailFragment: function(e, t, r) {
            return r = r || {}, this.isEventWorld() ? this.getEventModel().getDungeonDetailFragment(e, t, r) : n("#world/%s/dungeon/%s/%s", this.get("id"), t, e)
        },
        getBattleListFragment: function(e) {
            return this.isEventWorld() ? this.getEventModel().getBattleListFragment(e) : n("#world/battles/%s", e)
        },
        getKeptOutFragment: function() {
            return this.isEventWorld() ? this.getEventModel().getKeptOutFragment() : "#world"
        },
        getOpenedToClosedTermText: function(e) {
            return this._getTermText(e, "opened_at", "closed_at")
        },
        getOpenedToKeptOutTermText: function(e) {
            return this._getTermText(e, "opened_at", "kept_out_at")
        },
        getKeptOutToClosedTermText: function(e) {
            return this._getTermText(e, "kept_out_at", "closed_at")
        },
        _getTermText: function(e, t, n) {
            return e = e || this.getTimeKeeper(), FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get(n)).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get(n)).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get(t)).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "〜" + e.setUnixTime(this.get(n)).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            })
        },
        getTimeKeeper: function() {
            return new i({
                format: "%M/%D %H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            })
        },
        dispose: function() {
            this.eventModel = null, t.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/collections/World", ["lib/Collection", "../models/World"], function(e, t) {
    return e.extend({
        model: t,
        comparator: function(e) {
            return e.get("id")
        },
        getNormalWorldModels: function() {
            return this.filter(function(e) {
                return e.isNormalWorld()
            })
        },
        getEventWorldModels: function() {
            return this.filter(function(e) {
                return e.isEventWorld()
            })
        },
        getExtremeWorldModels: function() {
            return this.filter(function(e) {
                var t = e.getEventModel();
                return e.isEventWorld() && t.isTypeExtreme()
            })
        },
        getWorldModelsForTop: function() {
            return this.filter(function(e) {
                return e.isNormalWorld() && e.isUnlocked() && e.canBeginBattleTerm()
            })
        },
        getByEventId: function(e) {
            var t = this.getEventWorldModels();
            return _.find(t, function(t) {
                return t.getEventModel().get("id") === +e
            })
        },
        getWorldModelsBySeriesId: function(e) {
            return this.filter(function(t) {
                return t.get("series_id") === +e
            })
        },
        getWorldModelsCanBeBegunBattleBySeriesId: function(e) {
            var t = this.getWorldModelsBySeriesId(e);
            return _.filter(t, function(e) {
                return e.canBeginBattleTerm()
            })
        },
        getDuringWdayEventWorldModel: function() {
            var e = this.getEventWorldModels();
            return _.find(e, function(e) {
                var t = e.getEventModel();
                return e.canBeginBattleTerm() && t.isTypeWday()
            })
        },
        isExtremeWorldOpen: function() {
            var e = this.getExtremeWorldModels();
            return _.any(e, function(e) {
                return e.canBeginBattleTerm()
            })
        }
    })
}), define("scenes/common/collections/Dungeon", ["lib/Collection", "../models/Dungeon"], function(e, t) {
    var n = e.extend({
        model: t,
        initialize: function(t) {
            e.prototype.initialize.call(this, t), this._cachedMap = {}
        },
        comparator: function(e, t) {
            return e.get("order_no") > t.get("order_no") ? -1 : e.get("order_no") < t.get("order_no") ? 1 : e.get("id") > t.get("id") ? 1 : e.get("id") < t.get("id") ? -1 : 0
        },
        addByWorldId: function(e, t) {
            this.add(t, {
                merge: !0
            }), this._cachedMap[e] = !0
        },
        isAddedByWorldId: function(e) {
            return this._cachedMap[e] ? !0 : !1
        },
        hasAnyBuddyPrizeDungeon: function(e) {
            var t = this.where({
                world_id: e
            });
            return _.any(t, function(e) {
                return e.hasBuddyPrize()
            })
        },
        getDungeonModelByType: function(e) {
            return this.filter(function(t) {
                return +t.get("type") === +e
            })
        }
    });
    return n
}), define("scenes/common/models/Battle", ["backbone", "lib/Model"], function(e, t) {
    return t.extend({})
}), define("scenes/common/collections/Battle", ["lib/Collection", "../models/Battle"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/notification/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        notificationGetDataDeferred: function() {
            return this.requestDeferred("/dff/notification/get_data", {})
        },
        notificationCheckDeferred: function() {
            return this.requestDeferred("/dff/notification/check", {}, {
                type: "POST",
                disableLoading: !0
            })
        },
        notificationMarkPopupedDeferred: function(e) {
            return this.requestDeferred("/dff/notification/mark_popuped", {
                id: e.get("id")
            }, {
                type: "POST",
                disableLoading: !0
            })
        }
    })
}), define("scenes/common/models/Notification", ["backbone", "lib/Model", "components/TimeKeeper", "scenes/notification/Api"], function(e, t, n, r) {
    return t.extend({
        getOpenedAtString: function() {
            var e = new n({
                    format: this._getDefaultFormat(),
                    months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
                }),
                t = e.setUnixTime(this.get("opened_at")),
                r = FF.env.regionTimeZoneOffset(),
                i = t.getString({
                    timeZoneOffset: r
                });
            return FF.env.isDevelop() ? i + " (ID: " + this.get("id") + ")" : i
        },
        _getDefaultFormat: function() {
            return FF.env.isWWRegion() ? "%Y-%M-%D %H:%I" : "%Y年%M月%D日 %H:%I"
        },
        getContentWithProxyImageUrl: function() {
            var e = this.get("content"),
                t = e.match(/<img(.*?)>/g),
                n, r, i = 0;
            if (t === null) return e;
            for (r = t.length; i < r; i++) n = t[i].match(/<img.*?src="(.*?)".*?>/), n && n.length > 0 && (e = e.replace(n[1], pUrl(n[1])));
            return e
        },
        isAlwaysPopupNotification: function() {
            return this.get("popup_place_type").length >= 1 && this.get("popup_timing_type") === 0
        }
    })
}), define("scenes/common/collections/Notification", ["lib/Collection", "../models/Notification"], function(e, t) {
    var n = function(e, t) {
        return e.get("priority") > t.get("priority") ? -1 : e.get("priority") < t.get("priority") ? 1 : e.get("opened_at") > t.get("opened_at") ? -1 : e.get("opened_at") < t.get("opened_at") ? 1 : e.get("id") > t.get("id") ? -1 : e.get("id") < t.get("id") ? 1 : 0
    };
    return e.extend({
        model: t,
        initialize: function() {
            this.comparator = n
        },
        uncheckedNum: function() {
            return this.where({
                is_checked: !1,
                is_show_on_list: !0
            }).length
        },
        checked: function() {
            this.each(function(e) {
                if (e.get("is_checked")) return;
                e.set("is_checked", !0)
            })
        },
        forcePopupNotificationsByPlaceTypeAndPlaceValue: function(e, t) {
            return this.where({
                popup_place_type: e,
                popup_place_value: t,
                is_now_popup: !0
            })
        }
    })
}), define("scenes/common/collections/CacheableBase", ["jquery", "underscore", "lib/Collection", "lib/MemoryCache"], function(e, t, n, r) {
    var i = "reset";
    return n.extend({
        initialize: function(e) {
            this._cache = new r, this._expirationTime = e
        },
        hasCache: function() {
            return !t.isNull(this._cache.get(i))
        },
        clearCache: function() {
            this._cache = new r
        },
        resetWithSettingCache: function(e) {
            this._cache.set(i, e, this._expirationTime), this.reset(e)
        },
        resetWithCacheableDeferred: function(t) {
            var n = this;
            return n._cache.cacheableDeferred(i, t, n._expirationTime).then(function(t) {
                return n.reset(t), e.Deferred().resolve(n).promise()
            })
        }
    })
}), define("scenes/common/collections/Profile", ["underscore", "../collections/CacheableBase", "../models/Profile"], function(e, t, n) {
    return t.extend({
        model: n,
        initialize: function(e) {
            var n = this;
            this.comparator = function(e, t) {
                return n.defaultComparatorFunc(e, t)
            }, t.prototype.initialize.call(this, e)
        },
        defaultComparatorFunc: function(e, t) {
            return 0
        },
        relationStatusComparator: function(e, t) {
            return e.get("relation_status") > t.get("relation_status") ? -1 : e.get("relation_status") < t.get("relation_status") ? 1 : 0
        },
        setRelationStatusComparator: function() {
            var e = this;
            this.comparator = function(t, n) {
                return e.relationStatusComparator(t, n)
            }
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        },
        getUserIds: function() {
            return this.map(function(e) {
                return e.get("user_id")
            })
        },
        resetIsNewRelation: function() {
            this.each(function(e) {
                e.resetIsNewRelation()
            })
        },
        addWithPreloadedUserRelations: function(t) {
            var n = this;
            e.each(t, function(e) {
                n.addWithPreloadedAttributes(e.target_user_id, {
                    relation_status: e.relation_status,
                    relation_updated_at: e.relation_updated_at,
                    is_new_relation: e.is_new_relation
                })
            })
        },
        addWithPreloadedAttributes: function(e, t) {
            var r = new n({
                user_id: e
            });
            r.setPreloadedAttributes(t), this.add(r)
        }
    })
}), define("scenes/common/collections/FolloweeProfile", ["../collections/Profile"], function(e) {
    var t = 300;
    return e.extend({
        initialize: function() {
            e.prototype.initialize.call(this, t)
        },
        defaultComparatorFunc: function(e, t) {
            var n = e.isBeforeLoad() ? e.getPreloadedAttribute("relation_updated_at") : e.get("relation_updated_at"),
                r = t.isBeforeLoad() ? t.getPreloadedAttribute("relation_updated_at") : t.get("relation_updated_at");
            return n > r ? -1 : n < r ? 1 : 0
        }
    })
}), define("scenes/common/collections/FollowerProfile", ["../collections/Profile"], function(e) {
    var t = 300;
    return e.extend({
        initialize: function() {
            e.prototype.initialize.call(this, t)
        },
        defaultComparatorFunc: function(e, t) {
            var n = e.isBeforeLoad() ? e.getPreloadedAttribute("relation_updated_at") : e.get("relation_updated_at"),
                r = t.isBeforeLoad() ? t.getPreloadedAttribute("relation_updated_at") : t.get("relation_updated_at");
            return n > r ? -1 : n < r ? 1 : 0
        }
    })
}), define("scenes/common/models/TipDownload", ["lib/Model"], function(e) {
    return e.extend({})
}), define("scenes/common/collections/TipDownload", ["lib/Collection", "../models/TipDownload"], function(e, t) {
    return e.extend({
        model: t,
        currentIndex: null,
        initialize: function() {
            e.prototype.initialize.apply(arguments), this.setCurrentIndex(0)
        },
        setCurrentIndex: function(e) {
            e < 0 && (e = this.length - 1), e >= this.length && (e = 0), this.currentIndex = e
        },
        next: function() {
            return this.setCurrentIndex(this.currentIndex + 1), this.at(this.currentIndex)
        },
        current: function() {
            return this.at(this.currentIndex)
        },
        prev: function() {
            return this.setCurrentIndex(this.currentIndex - 1), this.at(this.currentIndex)
        }
    })
}), define("scenes/common/models/CharacterProfile", ["lib/Model"], function(e) {
    return e.extend({
        idAttribute: "buddy_id"
    })
}), define("scenes/common/collections/CharacterProfile", ["lib/Collection", "../models/CharacterProfile"], function(e, t) {
    return e.extend({
        model: t,
        getSeriesList: function() {
            return _.map(this.groupBy("series_id"), function(e, t) {
                return {
                    id: ~~t,
                    name: e[0].get("series_name")
                }
            }).sort(function(e, t) {
                return e.id < t.id ? -1 : e.id > t.id ? 1 : 0
            })
        },
        getCharacterList: function(e) {
            return _.map(this.groupBy("series_id")[e], function(e) {
                return e.toJSON()
            }).sort(function(e, t) {
                return e.buddy_id < t.buddy_id ? -1 : e.buddy_id > t.buddy_id ? 1 : 0
            })
        }
    })
}), define("scenes/common/models/Banner", ["lib/Model", "util"], function(e, t) {
    return e.extend({
        isOpened: function() {
            var e = t.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        }
    })
}), define("scenes/common/collections/Banner", ["lib/Collection", "../models/Banner"], function(e, t) {
    var n = 600025,
        r = 600060;
    return e.extend({
        model: t,
        initialize: function() {
            e.prototype.initialize.apply(arguments)
        },
        comparator: function(e, t) {
            return e.get("order_no") < t.get("order_no") ? 1 : e.get("order_no") > t.get("order_no") ? -1 : e.get("id") < t.get("id") ? 1 : e.get("id") > t.get("id") ? -1 : 0
        },
        getOpened: function() {
            this.sort();
            var e = FF.datastore.userModel.get("can_review"),
                t = this;
            return this.filter(function(n) {
                if (t._hasReceivedMemberUpgradeBonus(n.get("id"))) return !1;
                if (n.get("id") === r && FF.datastore.missionCollection.isAllBeginnerMissionCleared()) return !1;
                if (!e) {
                    var i = n.get("link_type") === FF.CONST.SERVER.BANNER.LINK_TYPE_OF.REVIEW;
                    return n.isOpened() && !i
                }
                return n.isOpened()
            })
        },
        _hasReceivedMemberUpgradeBonus: function(e) {
            return e === n && FF.datastore.stash.user_grade > FF.CONST.SERVER.USER.USER_GRADE_OF.KANTAN && !FF.datastore.stash.canReceiveMemberUpgradeBonus ? !0 : !1
        }
    })
}), define("scenes/common/models/LimitedTimeService", ["lib/Model", "util"], function(e, t) {
    return e.extend({
        initialize: function() {
            this.initializedEpoch = t.getTimeAsSec()
        },
        isOpening: function() {
            var e = t.getTimeAsSec() - this.initializedEpoch;
            return e >= this.get("wait_sec_to_open") && e < this.get("wait_sec_to_close")
        }
    })
}), define("scenes/common/collections/LimitedTimeService", ["lib/Collection", "../models/LimitedTimeService"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {
            this.TYPE_OF = FF.CONST.SERVER.LIMITED_TIME_SERVICE.TYPE_OF
        },
        getWorldListBackgroundClass: function() {
            var e = this.findWhere({
                type: this.TYPE_OF.WORLD_LIST_BACKGROUND_IMG
            });
            return e ? e.isOpening() ? e.get("html_class") : null : null
        },
        getDungeonListBackgroundClass: function() {
            var e = this.findWhere({
                type: this.TYPE_OF.DUNGEON_LIST_BACKGROUND_IMG
            });
            return e ? e.isOpening() ? e.get("html_class") : null : null
        },
        getWorldListBgm: function() {
            var e = this.findWhere({
                type: this.TYPE_OF.WORLD_LIST_BGM
            });
            return e ? e.isOpening() ? e.get("bgm") : null : null
        },
        getGachaPageBgm: function() {
            var e = this.findWhere({
                type: this.TYPE_OF.GACHA_PAGE_BGM
            });
            return e ? e.isOpening() ? e.get("bgm") : null : null
        },
        getLoginBonusMogImg: function() {
            var e = this.findWhere({
                type: this.TYPE_OF.LOGIN_BONUS_MOG_IMG
            });
            return e ? e.isOpening() ? e.get("img") : null : null
        },
        getHtmlSceneBgmByName: function(e) {
            var t = this.findWhere({
                name: e,
                type: this.TYPE_OF.HTML_SCENE_BGM
            });
            return t ? t.isOpening() ? t.get("bgm") : null : null
        }
    })
}), define("scenes/common/models/XpromoCustomEvent", ["lib/Model"], function(e) {
    return e.extend({
        idAttribute: "custom_event_name"
    })
}), define("scenes/common/collections/XpromoCustomEvent", ["lib/Collection", "../models/XpromoCustomEvent"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/common/models/Quest", ["./ItemBase", "components/TimeKeeper"], function(e, t) {
    return e.extend({
        isNew: function() {
            return this.get("is_new")
        },
        isChallenging: function() {
            return this.get("is_challenging")
        },
        isAchieved: function() {
            return this.get("is_achieved")
        },
        isCompleted: function() {
            return this.get("is_completed")
        },
        getOpenedToClosedTermText: function(e) {
            return e = e || this._getTimeKeeper(), FF.env.isWWRegion() && this._getClosedTermTextForWW(e), e.setUnixTime(this.get("opened_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "-" + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            })
        },
        getClosedTermText: function(e) {
            return e = e || this._getTimeKeeper(), FF.env.isWWRegion() ? this._getClosedTermTextForWW(e) : e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "まで"
        },
        _getClosedTermTextForWW: function(e) {
            return e = e || this._getTimeKeeper(), '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            })
        },
        _getTimeKeeper: function() {
            return new t({
                preset: {
                    language: "en",
                    format: "YYYY/MM/DD_HH:II"
                }
            })
        },
        isEvent: function() {
            return this.get("is_event")
        },
        getTargetDungeonId: function() {
            return this.get("achieve_type_name") !== "CLEAR_DUNGEON" ? null : this.get("achieve_cond_arg2")
        }
    })
}), define("scenes/common/collections/Quest", ["./ItemBase", "../models/Quest", "util"], function(e, t, n) {
    var r = {
        DESCENDING_ORDER_MAP: {
            ABILITY_GENERATE: 4,
            ABILITY_UPGRADE: 6,
            BUDDY_LEVEL: 2,
            CLEAR_DUNGEON: 1,
            ENHANCE: 3,
            EVOLVE: 5,
            FRIEND_INVITE: 9,
            GACHA: 8,
            GET_ITEM: 7
        }
    };
    return e.extend({
        model: t,
        initialize: function() {
            var e = this;
            this.comparator = function(t, n) {
                return e.defaultComparatorFunc(t, n)
            }
        },
        defaultComparatorFunc: function(e, t) {
            var n = r.DESCENDING_ORDER_MAP[e.get("achieve_type_name")],
                i = r.DESCENDING_ORDER_MAP[t.get("achieve_type_name")];
            return n < i ? -1 : n > i ? 1 : e.get("disp_number") < t.get("disp_number") ? -1 : e.get("disp_number") > t.get("disp_number") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        getNewNormalQuestNum: function() {
            return this.where({
                is_new: !0,
                is_normal: !0
            }).length
        },
        hasNewNormalQuest: function() {
            return this.getNewNormalQuestNum() > 0
        },
        getNewSpecialQuestNum: function() {
            return this.where({
                is_new: !0,
                is_special: !0
            }).length
        },
        hasNewSpecialQuest: function() {
            return this.getNewSpecialQuestNum() > 0
        },
        getNewEventQuestNum: function() {
            return this.where({
                is_new: !0,
                is_event: !0
            }).length
        },
        hasNewEventQuest: function() {
            return this.getNewEventQuestNum() > 0
        },
        getNewSteadyQuestNum: function() {
            return this.filter(function(e) {
                return e.get("is_new") && (e.get("is_normal") || e.get("is_special"))
            }).length
        },
        hasNewSteadyQuest: function() {
            return this.getNewSteadyQuestNum() > 0
        },
        hasNewRealQuest: function() {
            return this.where({
                is_new: !0,
                is_real_type_group: !0
            }).length > 0
        },
        getAchievedQuest: function(e) {
            var t = this,
                n = [];
            return e = e || {}, e.achieveTypeNames = e.achieveTypeNames || [], _.each(e.achieveTypeNames, function(e) {
                t.each(function(t) {
                    t.get("achieve_type_name") === e && t.get("is_achieved") && n.push(t)
                })
            }), n
        },
        hasAchievedQuest: function(e) {
            return this.getAchievedQuest(e).length > 0
        },
        getChallengingQuest: function() {
            return this.where({
                is_challenging: !0
            })
        },
        getChallengingQuestNum: function() {
            return this.getChallengingQuest().length
        },
        hasCompletedQuest: function() {
            return this.getCompletedQuest().length > 0
        },
        getCompletedQuest: function() {
            return this.where({
                is_completed: !0
            })
        },
        getCompletedQuestNum: function() {
            return this.getCompletedQuest().length
        },
        getNormalQuest: function() {
            return this.where({
                is_normal: !0,
                is_achieved: !1,
                is_completed: !1
            })
        },
        getSpecialQuest: function() {
            return this.where({
                is_special: !0,
                is_achieved: !1,
                is_completed: !1
            })
        },
        getEventQuest: function() {
            return this.where({
                is_event: !0,
                is_achieved: !1,
                is_completed: !1
            })
        },
        getTargetDungeonIdMap: function() {
            var e = this.where({
                achieve_type_name: "CLEAR_DUNGEON"
            });
            return _.indexBy(e, function(e) {
                return e.getTargetDungeonId()
            })
        },
        getAllRealQuest: function() {
            return this.where({
                is_real_type_group: !0
            })
        }
    })
}), define("scenes/common/collections/Mission", ["underscore", "./ItemBase", "../models/Mission"], function(e, t, n) {
    return t.extend({
        model: n,
        initialize: function() {
            this.comparator = this.defaultComparatorFunc
        },
        defaultComparatorFunc: function(e, t) {
            return this.models
        },
        getByType: function(e) {
            return this.where({
                type: e
            })
        },
        getByTypeWithSorted: function(e) {
            return this.where({
                type: e
            }).sort(function(e, t) {
                return !e.isRealIncentiveReadyToApply() && t.isRealIncentiveReadyToApply() ? 1 : e.isRealIncentiveReadyToApply() && !t.isRealIncentiveReadyToApply() ? -1 : !e.isRealIncentiveApplied() && t.isRealIncentiveApplied() ? 1 : e.isRealIncentiveApplied() && !t.isRealIncentiveApplied() ? -1 : !e.isRealIncentiveAppliedWithSNSShare() && t.isRealIncentiveAppliedWithSNSShare() ? -1 : e.isRealIncentiveAppliedWithSNSShare() && !t.isRealIncentiveAppliedWithSNSShare() ? 1 : !e.isWaitingReceiveReward() && t.isWaitingReceiveReward() ? 1 : e.isWaitingReceiveReward() && !t.isWaitingReceiveReward() ? -1 : !e.isNew() && t.isNew() ? 1 : e.isNew() && !t.isNew() ? -1 : !e.isReceivedReward() && t.isReceivedReward() ? -1 : e.isReceivedReward() && !t.isReceivedReward() ? 1 : e.get("disp_number") < t.get("disp_number") ? -1 : e.get("disp_number") > t.get("disp_number") ? 1 : 0
            })
        },
        getLatestMission: function(e) {
            return this.reduce(function(t, n) {
                return e && n.get("type") !== +e ? t : t && t.get("opened_at") > n.get("opened_at") ? t : n
            }, null)
        },
        getRewardReceivableMissions: function(e) {
            e = e || {};
            var t = e.type;
            return this.filter(function(e) {
                return t && e.get("type") !== +t ? !1 : e.isWaitingReceiveReward()
            })
        },
        canReceiveAnyRewardByType: function(e) {
            return this.any(function(t) {
                return t.canReceiveReward() && t.get("type") === +e
            })
        },
        getModels: function(t) {
            return e.map(t, function(e) {
                return this.get(e)
            }.bind(this))
        },
        getDungeonIdMissionMap: function(t) {
            t = e.extend(t || {}, {
                achieve_cond_type: FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF.CLEAR_SPECIFIC_DUNGEON
            });
            var n = this.where(t);
            return e.indexBy(n, function(e) {
                return e.getTargetDungeonId()
            })
        },
        isAllBeginnerMissionCleared: function() {
            var t = this.getByType(FF.CONST.SERVER.MISSION.TYPE_OF.BEGINNER);
            return e.every(t, function(e) {
                return e.isAchieved()
            })
        }
    })
}), define("scenes/common/models/PartyMemory", ["lib/Model"], function(e) {
    var t = e.extend({
        defaults: {
            has_memory: !1,
            party_memory_no: 0,
            party_memory_no_disp: "00",
            party_name: "",
            party: void 0,
            buddies: void 0
        },
        initialize: function(e) {
            e && e.party && this.set("has_memory", !0)
        },
        hasMemory: function() {
            return this.get("has_memory")
        },
        getMemoryNumber: function() {
            return this.get("party_memory_no")
        },
        getMemoryNumberForDisplay: function() {
            return this.get("party_memory_no_disp")
        },
        getMemoryName: function() {
            return this.get("party_name")
        },
        getSlotToBuddyId: function() {
            var e = this.get("party");
            return e ? this.get("party").slot_to_buddy_id : void 0
        },
        getBuddyById: function(e) {
            var t = this.getDatastore().buddyCollection,
                n = t.get(e);
            if (!n) return void 0;
            var r = this._makeBuddyAppliedMemory(n);
            return r
        },
        getBuddyBySlot: function(e) {
            var t = this.get("party");
            if (!t || !t.slot_to_buddy_id) return void 0;
            var n = t.slot_to_buddy_id[e];
            return this.getBuddyById(n)
        },
        getBuddyModels: function() {
            var e = this;
            return _.map(FF.CONST.SERVER.PARTY.SLOTS, function(t) {
                return e.getBuddyBySlot(t)
            })
        },
        isSoulStrikeIdAvailable: function(e, t) {
            if (t === e.get("default_soul_strike_id")) return !0;
            var n = _.compact([e.get("weapon_id"), e.get("armor_id"), e.get("accessory_id")]),
                r = this.getDatastore().equipmentCollection,
                i = _.map(n, function(e) {
                    var t = r.get(e);
                    return t ? t.get("soul_strike_id") : 0
                });
            return _.contains(i, t)
        },
        _getBuddyMemoryById: function(e) {
            var t = this.get("buddies");
            return t ? _.findWhere(t, {
                id: e
            }) : void 0
        },
        _makeBuddyAppliedMemory: function(e) {
            var t = e.clone(),
                n = this._getBuddyMemoryById(e.get("id"));
            return n ? (t = this._applyEquipmentMemory(t, n), t = this._applySoulStrikeMemory(t, n), t = this._applyAbilityMemory(t, n), t = this._applyRecordMateriaMemory(t, n), t = this._applyDressRecordMemory(t, n), t = this._applyRow(t, n), t.isPartyMemoryBuddy = !0, t) : (FF.logger.error("Buddy memory not found:", e), t)
        },
        _applyEquipmentMemory: function(e, t) {
            var n = FF.CONST.CLIENT.EQUIPMENT.TYPE_NAME_OF;
            return e.tmpEquipmentTypeNameToId[n.WEAPON] = t.weapon_id, e.tmpEquipmentTypeNameToId[n.ARMOR] = t.armor_id, e.tmpEquipmentTypeNameToId[n.ACCESSORY] = t.accessory_id, e.fixTmpEquipments(), e
        },
        _applySoulStrikeMemory: function(e, t) {
            return e.setTmpSoulStrikeIdBySlot(1, t.soul_strike_1_id), e.setTmpSoulStrikeIdBySlot(2, t.soul_strike_2_id), e.setTmpSoulStrikeIdBySlot(3, t.soul_strike_3_id), e.setTmpSoulStrikeIdBySlot(4, t.soul_strike_4_id), e.fixTmpSoulStrikes(), e
        },
        _applyAbilityMemory: function(e, t) {
            return e.setTmpAbilityIdBySlot(1, t.ability_1_id), e.setTmpAbilityIdBySlot(2, t.ability_2_id), e.fixTmpAbilities(), e
        },
        _applyRecordMateriaMemory: function(e, t) {
            return e.setTmpRecordMateriaIdBySlot(1, t.record_materia_1_id), e.fixTmpRecordMaterias(), e
        },
        _applyDressRecordMemory: function(e, t) {
            return e.setTmpDressRecordIdDirectly(t.dress_record_id), e.fixTmpDressRecord(), e.setImagePathByDressRecordId(t.dress_record_id), e
        },
        _applyRow: function(e, t) {
            var n = t.row;
            return e.set("row", n), e.isRowFront = function() {
                return n === FF.CONST.SERVER.BUDDY.ROW_OF.FRONT
            }, e
        }
    });
    return t = _.extend(t, {
        makeDummyModelFromCurrentParty: function() {
            var e = FF.datastore.partyModel,
                n = this._makeBuddyAttributes(e),
                r = new t({
                    party: {
                        slot_to_buddy_id: e.getSlotToBuddyId()
                    },
                    buddies: n
                });
            return r
        },
        _makeBuddyAttributes: function(e) {
            var t = e.getBuddyModels(),
                n = _.map(t, function(e) {
                    return e ? e.attributes : void 0
                });
            return _.compact(n)
        }
    }), t
}), define("scenes/common/collections/PartyMemory", ["underscore", "sprintf", "./ItemBase", "../models/PartyMemory"], function(e, t, n, r) {
    return n.extend({
        model: r,
        refresh: function(e) {
            this.hasAllData = !1, this.addAllData(e), this._attachFileNumber()
        },
        _attachFileNumber: function() {
            e.each(this.models, function(e, n) {
                var r = t("%02d", n + 1);
                e.set("party_memory_no_disp", r)
            })
        }
    })
}), define("scenes/common/models/EquipmentSpMaterial", ["./ItemBase"], function(e) {
    return e.extend({
        attributeSchema: {
            id: void 0,
            num: void 0
        },
        getActualExp: function(e) {
            var t = this.get("exp"),
                n = FF.CONST.SERVER.EQUIPMENT.FUSION,
                r = e.get("equipment_type"),
                i = r === this.get("equipment_type") ? n.ENHANCE_BONUS_FACTOR_OF.SAME_EQUIP_TYPE_WITH_SP_MATERIAL : 1;
            return Math.floor(t * i)
        },
        getSellNum: function() {
            return this.get("num")
        },
        isEquipSpMaterial: function() {
            return !0
        },
        isWeaponMaterial: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON
        },
        isArmorMaterial: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR
        },
        isHammeringMaterial: function() {
            return this.get("equipment_type") === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.HAMMERING
        }
    })
}), define("scenes/common/collections/EquipmentSpMaterial", ["./ItemBase", "../models/EquipmentSpMaterial", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = {
                ID: "id",
                RARITY: "rarity",
                FOR_WEAPON: "for_weapon",
                FOR_ARMOR: "for_armor"
            }, this._initSortAdviser()
        },
        getSortTypeOf: function() {
            return this.SORT_TYPE_OF
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        changeComparator: function(e) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var t = this,
                n = this.SORT_TYPE_OF,
                r = e.sortType;
            switch (r) {
                case n.ID:
                    this.comparator = this._defaultComparator;
                    break;
                case n.RARITY:
                    this.comparator = this._sortAdviser.getBasicComparator(e, "rarity");
                    break;
                case n.FOR_WEAPON:
                    this.comparator = this._comparatorForWeaponMaterial;
                    break;
                case n.FOR_ARMOR:
                    this.comparator = this._comparatorForArmorMaterial;
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _comparatorForWeaponMaterial: function(e, t) {
            return e.isWeaponMaterial() && !t.isWeaponMaterial() ? -1 : !e.isWeaponMaterial() && t.isWeaponMaterial() ? 1 : e.isArmorMaterial() && !t.isArmorMaterial() ? -1 : !e.isArmorMaterial() && t.isArmorMaterial() ? 1 : this._defaultComparator(e, t)
        },
        _comparatorForArmorMaterial: function(e, t) {
            return e.isArmorMaterial() && !t.isArmorMaterial() ? -1 : !e.isArmorMaterial() && t.isArmorMaterial() ? 1 : e.isWeaponMaterial() && !t.isWeaponMaterial() ? -1 : !e.isWeaponMaterial() && t.isWeaponMaterial() ? 1 : this._defaultComparator(e, t)
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/common/models/BattleListSpEnemyAdjustment", ["underscore", "jquery", "backbone", "lib/Model"], function(e, t, n, r) {
    var i = {
            NONE: 0,
            AB: 1
        },
        s = r.extend({
            initialize: function(e, t) {},
            getEnemyId: function() {
                return this.get("enemy_id")
            },
            getScale: function() {
                return this.get("scale")
            },
            getInitTag: function() {
                return this.get("init_tag")
            },
            getAlterType: function() {
                return this.get("alter_type")
            },
            getAlterABAssetId: function() {
                return this.get("alter_asset_key")
            },
            getArrangeType: function() {
                return this.get("arrange_type")
            },
            getOffsets: function() {
                return {
                    x: this.get("offset_x"),
                    y: this.get("offset_y")
                }
            },
            isHiddenChild: function(t) {
                var n = this.get("hidden_children");
                return e.indexOf(n, t) >= 0
            },
            fromJsonObj: function(t) {
                if (!t) return;
                this.set("arrange_type", Number(t.arrange_type)), this.set("enemy_id", Number(t.enemy_id)), this.set("init_tag", String(t.init_tag)), this.set("alter_type", Number(t.alter_type)), this.set("alter_asset_key", String(t.alter_asset_key)), this.set("scale", Number(t.scale)), this.set("offset_x", Number(t.offset_x)), this.set("offset_y", Number(t.offset_y));
                var n = t.hidden_children || [];
                n = e.map(n, function(e) {
                    return String(e)
                }), this.set("hidden_children", n)
            },
            toJsonObj: function() {
                var e = {};
                return e.arrange_type = this.get("arrange_type") || "", e.enemy_id = this.get("enemy_id") || "", e.init_tag = this.get("init_tag") || "", e.alter_type = this.get("alter_type") || "", e.alter_asset_key = this.get("alter_asset_key") || "", e.scale = this.get("scale") || 1, e.offset_x = this.get("offset_x") || 0, e.offset_y = this.get("offset_y") || 0, e.hidden_children = this.get("hidden_children"), e
            }
        }, {
            ENEMY_ID_KEY: "enemy_id",
            ENEMY_ALTER_TYPES: i
        });
    return s
}), define("scenes/common/models/BattleListSpEnemyStructure", ["underscore", "jquery", "backbone", "lib/Model", "lib/Collection"], function(e, t, n, r, i) {
    var s = {
            ANIMATION_INFO_KEY: "_animationInfo_",
            ASSET_ID_KEY: "_asset_id_"
        },
        o = r.extend({}),
        u = i.extend({
            model: o
        }),
        a = r.extend({
            initialize: function(t, n) {
                var r = [];
                e.each(this.get("params"), function(e) {
                    r.push(e.animation_info)
                }), this.set(s.ANIMATION_INFO_KEY, new u(r)), this.set(s.ASSET_ID_KEY, "boss-" + this._getAnimationInfoParam("path"))
            },
            _getAnimationInfo: function() {
                return this.get(s.ANIMATION_INFO_KEY).at(0)
            },
            _getAnimationInfoParam: function(e) {
                return this._getAnimationInfo().get(e)
            },
            getAssetId: function() {
                return this.get(s.ASSET_ID_KEY)
            },
            getScale: function() {
                return parseFloat(this._getAnimationInfoParam("scale"))
            },
            getChildPosId: function() {
                return this.get("child_pos_id")
            },
            dispose: function() {
                this.get(s.ANIMATION_INFO_KEY).reset(), r.prototype.dispose.apply(this)
            }
        }, {
            ASSET_ID_KEY: s.ASSET_ID_KEY
        });
    return a
}), define("scenes/common/collections/BattleListSpEnemyStructure", ["lib/Collection", "../models/BattleListSpEnemyStructure"], function(e, t) {
    return e.extend({
        model: t,
        comparator: t.ASSET_ID_KEY
    })
}), define("scenes/common/models/BattleListSpEnemy", ["underscore", "jquery", "backbone", "lib/Model", "./BattleListSpEnemyAdjustment", "../collections/BattleListSpEnemyStructure"], function(e, t, n, r, i, s) {
    var o = r.extend({
        initialize: function(t, n) {
            var r = [];
            e.each(this.get("children"), function(e, t) {
                r.push(e)
            }), this._structureCollection = new s(r), this._structureCollection.sort(), this._adjustmentModel = new i(this.get("battle_list_adjustment"))
        },
        getEnemyId: function() {
            return this.get("id")
        },
        getAssetIdList: function() {
            var e = [],
                t = this._adjustmentModel,
                n = t.getAlterType();
            return n === i.ENEMY_ALTER_TYPES.AB ? e.push(t.getAlterABAssetId()) : this._structureCollection.models.forEach(function(t, n) {
                var r = t.getAssetId();
                e.indexOf(r) === -1 && e.push(r)
            }), e
        },
        getStructures: function() {
            var e = [];
            return this._structureCollection.models.forEach(function(t) {
                e.push(t)
            }), e
        },
        getSpEnemyAdjustmentes: function() {
            return this._adjustmentModel
        },
        isRandomPlayDeformTag: function(t) {
            var n = this.get("deform_animation_info"),
                r = e.find(n, function(e) {
                    return e.deform_tag === t
                });
            return r ? r.is_random : !1
        },
        dispose: function() {
            this._adjustmentModel.dispose(), this._adjustmentModel = void 0, this._structureCollection.models.forEach(function(e) {
                e.dispose()
            }), this._structureCollection = null, r.prototype.dispose.apply(this)
        }
    });
    return o
}), define("scenes/common/collections/BattleListSpEnemy", ["lib/Collection", "../models/BattleListSpEnemy"], function(e, t) {
    return e.extend({
        model: t,
        initialize: function() {
            this.listenTo(this, "reset", _.bind(this._disposeModels, this))
        },
        _disposeModels: function(e, t) {
            t.previousModels.forEach(function(e) {
                e.dispose()
            })
        }
    })
}), define("scenes/common/helper/MovieHelper", ["sprintf"], function(e) {
    return {
        getServerMoviePath: function() {
            return FF.env.isWWRegion() ? e("ww/compile/%s/%s", FF.env.getLanguage(), FF.CONST.CLIENT.SERVER_MOVIE_PATH) : FF.CONST.CLIENT.SERVER_MOVIE_PATH
        },
        getEventMovieName: function(e) {
            var t = "event_intro/" + e;
            return this.getServerMovieName(t)
        },
        getOpeningMovieName: function(e) {
            var t = "opening" + e;
            return this.getBundleMovieName(t)
        },
        getFuncTutorialMovieName: function(e, t) {
            var n = e + t;
            return this.getServerMovieName(n)
        },
        getServerMovieName: function(t) {
            var n = FF.env.isWWRegion() ? e("../ww/compile/%s/video/", FF.env.getLanguage()) : "";
            return n + t
        },
        getBundleMovieName: function(e) {
            var t = FF.env.isWWRegion() ? "_" + FF.env.getLanguage() : "";
            return e + t
        }
    }
}), define("scenes/common/models/MovieReplay", ["util", "lib/SeparatedModel", "scenes/common/helper/MovieHelper"], function(e, t, n) {
    return t.extend({
        attributeSchema: {
            id: void 0
        },
        getMovieName: function() {
            return this.get("is_bundled") ? n.getBundleMovieName(this.get("path")) : n.getServerMovieName(this.get("path"))
        },
        getServerPath: function() {
            var e = sprintf(FF.CONST.CLIENT.SERVER_MOVIE_PATH, this.get("path"));
            return FF.env.isWWRegion() ? sprintf("ww/compile/%s/%s", FF.env.getLanguage(), e) : e
        }
    })
}), define("scenes/common/collections/MovieReplay", ["lib/Collection", "../models/MovieReplay"], function(e, t) {
    return e.extend({
        model: t,
        comparator: function(e, t) {
            return e.get("disp_order") < t.get("disp_order") ? -1 : e.get("disp_order") > t.get("disp_order") ? 1 : e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : 0
        },
        getListByType: function(e) {
            return this.where({
                type: e
            })
        }
    })
}), define("scenes/common/Datastore", ["underscore", "jquery", "backbone", "lib/ClassBase", "lib/Collection", "lib/MemoryCache", "scenes/common/models/User", "scenes/common/models/Party", "scenes/common/models/PartyStatus", "scenes/common/models/Dungeon", "scenes/common/models/DungeonSession", "scenes/common/models/FellowSession", "scenes/common/models/UserSupporterBuddy", "scenes/common/models/AbilityDisplayCategory", "scenes/common/collections/Buddy", "scenes/common/collections/Ability", "scenes/common/collections/Equipment", "scenes/common/collections/RecordMateria", "scenes/common/collections/Material", "scenes/common/collections/MemoryCrystal", "scenes/common/collections/GrowEgg", "scenes/common/collections/SoulStrike", "scenes/common/collections/DressRecord", "scenes/common/collections/ItemPossessionLimit", "scenes/common/collections/AbilityGenerationRecipe", "scenes/common/collections/Event", "scenes/common/collections/World", "scenes/common/collections/Dungeon", "scenes/common/collections/Battle", "scenes/common/collections/Notification", "scenes/common/collections/FolloweeProfile", "scenes/common/collections/FollowerProfile", "scenes/common/collections/TipDownload", "scenes/common/collections/CharacterProfile", "scenes/common/collections/Banner", "scenes/common/collections/LimitedTimeService", "scenes/common/collections/XpromoCustomEvent", "scenes/common/collections/Quest", "scenes/common/collections/Mission", "scenes/common/collections/PartyMemory", "scenes/common/collections/EquipmentSpMaterial", "scenes/common/collections/BattleListSpEnemy", "scenes/common/collections/MovieReplay"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O, M, _, D, P, H, B, j, F, I, q, R, U) {
    return r.extend({
        initialize: function() {
            this.stash = {}, this.apiCache = new s, this.eventMap = {}, this.userModel = new o, this.partyModel = new u, this.partyStatusModel = new a, this.dungeonSessionModel = new l, this.currentDungeonModel = new f, this.fellowSessionModel = new c, this.userSupporterBuddyModel = new h, this.abilityDisplayCategoryModel = new p, this.buddyCollection = new d, this.abilityCollection = new v, this.equipmentCollection = new m, this.recordMateriaCollection = new g, this.soulStrikeCollection = new E, this.dressRecordCollection = new S, this.materialCollection = new y, this.memoryCrystalCollection = new b, this.growEggCollection = new w, this.itemPossessionLimitCollection = new x, this.abilityGenerationRecipeCollection = new T, this.eventCollection = new N, this.worldCollection = new C, this.dungeonCollection = new k, this.battleCollection = new L, this.notificationCollection = new A, this.followeeProfileCollection = new O, this.followerProfileCollection = new M, this.tipDownloadCollection = new _, this.characterProfileCollection = new D, this.bannerCollection = new P, this.limitedTimeServiceCollection = new H, this.xpromoCustomEventCollection = new B, this.questCollection = new j, this.missionCollection = new F, this.equipmentCategoryCollection = new i, this.equipmentCategoryCollection.comparator = "id", this.abilityCategoryCollection = new i, this.abilityCategoryCollection.comparator = "id", this.partyMemoryCollection = new I, this.battleListSpEnemyCollection = new R, this.equipmentSpMaterialCollection = new q, this.movieReplayCollection = new U
        },
        setDungeonSession: function(e) {
            this.userModel.set(e.user), this.battleCollection.reset(e.battles), this.dungeonSessionModel.set(e.dungeon_session), this.currentDungeonModel.set(e.user_dungeon), this.partyStatusModel.set(e.dungeon_session.party_status), this.dungeonCollection.add(e.user_dungeon), this.fellowSessionModel.set(e.fellow_session), this.battleListSpEnemyCollection.reset(e.sp_enemies), this.dungeonSessionAssets = e.assets
        },
        clearDungeonSession: function() {
            this.partyStatusModel.clear(), this.dungeonSessionModel.clear(), this.currentDungeonModel.clear(), this.battleCollection.reset(), this.battleListSpEnemyCollection.reset(), this.stash.dungeon_session && delete this.stash.dungeon_session, this.stash.battle_session && delete this.stash.battle_session, this.dungeonSessionAssets = void 0
        },
        hasDungeonSession: function() {
            return this.partyStatusModel.hasAttributes() && this.dungeonSessionModel.hasAttributes() && this.battleCollection.hasData() && this.battleListSpEnemyCollection.hasData()
        },
        hasPartyAllData: function() {
            return this.buddyCollection.hasAllData && this.abilityCollection.hasAllData && this.equipmentCollection.hasAllData && this.recordMateriaCollection && this.materialCollection.hasAllData && this.memoryCrystalCollection.hasAllData && this.growEggCollection.hasAllData && this.userSupporterBuddyModel.hasData
        },
        addPartyAllData: function(e) {
            this.abilityCollection.addAllData(e.abilities), this.equipmentCollection.addAllData(e.equipments), this.recordMateriaCollection.addAllData(e.record_materias), this.dressRecordCollection.addAllData(e.dress_records), this.buddyCollection.addAllData(e.buddies), this.materialCollection.addAllData(e.materials), this.memoryCrystalCollection.addAllData(e.memory_crystals), this.growEggCollection.addAllData(e.grow_eggs), this.soulStrikeCollection.reset(e.soul_strikes), this.itemPossessionLimitCollection.reset(e.item_possession_limits), this.userModel.set(e.user), this.userSupporterBuddyModel.addData(e.user_supporter_buddy), this.equipmentSpMaterialCollection.reset(e.equipment_sp_materials), this.abilityCollection.initializeInUseBy(), this.equipmentCollection.initializeInUseBy(), this.recordMateriaCollection.initializeInUseBy(), this.dressRecordCollection.initializeInUseBy(), this.equipmentCollection.initializeInUseBySupporter(), this.equipmentCollection.removeSoulStrikeIfRemoved()
        },
        clearHasPartyAllData: function() {
            this.buddyCollection.hasAllData = !1, this.abilityCollection.hasAllData = !1, this.equipmentCollection.hasAllData = !1, this.recordMateriaCollection.hasAllData = !1, this.dressRecordCollection.hasAllData = !1, this.materialCollection.hasAllData = !1, this.memoryCrystalCollection.hasAllData = !1, this.growEggCollection.hasAllData = !1, this.userSupporterBuddyModel.hasData = !1
        },
        updatePartyAssets: function(e) {
            e.party_assets && (this.stash.partyAssets = e.party_assets)
        },
        addUserSupporterBuddyAllData: function(e) {
            this.equipmentCollection.addAllData(e.equipments), this.buddyCollection.addAllData(e.buddies), this.soulStrikeCollection.reset(e.soul_strikes), this.dressRecordCollection.reset(e.dress_records), this.userSupporterBuddyModel.addData(e.user_supporter_buddy), this.equipmentCollection.initializeInUseBy(), this.equipmentCollection.initializeInUseBySupporter(), this.dressRecordCollection.initializeInUseBySupporter()
        },
        fixTmpEquipments: function() {
            this.buddyCollection.fixTmpEquipments(), this.equipmentCollection.fixTmpInUseBy()
        },
        resetTmpEquipments: function() {
            this.buddyCollection.resetTmpEquipments(), this.equipmentCollection.resetTmpInUseBy()
        },
        fixSupporterTmpEquipments: function() {
            this.userSupporterBuddyModel.fixTmpEquipments(), this.equipmentCollection.fixTmpInUseBySupporter()
        },
        resetSupporterTmpEquipments: function() {
            this.userSupporterBuddyModel.resetTmpEquipments(), this.equipmentCollection.resetTmpInUseBySupporter()
        },
        fixSupporterTmpDressRecords: function() {
            this.userSupporterBuddyModel.fixTmpDressRecord(), this.dressRecordCollection.fixTmpInUseBySupporter()
        },
        clearSupporterTmpDressRecords: function() {
            this.dressRecordCollection.clearSupporterTmpDressRecords()
        },
        resetSupporterTmpDressRecords: function() {
            this.dressRecordCollection.resetTmpInUseBySupporter()
        },
        fixTmpAbilities: function() {
            this.buddyCollection.fixTmpAbilities(), this.abilityCollection.fixTmpInUseBy()
        },
        resetTmpAbilities: function() {
            this.buddyCollection.resetTmpAbilities(), this.abilityCollection.resetTmpInUseBy()
        },
        fixTmpRecordMaterias: function() {
            this.buddyCollection.fixTmpRecordMaterias(), this.recordMateriaCollection.fixTmpInUseBy()
        },
        resetTmpRecordMaterias: function() {
            this.buddyCollection.resetTmpRecordMaterias(), this.recordMateriaCollection.resetTmpInUseBy()
        },
        fixTmpDressRecords: function() {
            this.buddyCollection.fixTmpDressRecords(), this.dressRecordCollection.fixTmpInUseBy()
        },
        resetTmpDressRecords: function() {
            this.buddyCollection.resetTmpDressRecords(), this.dressRecordCollection.resetTmpInUseBy()
        },
        fixTmpSoulStrikes: function() {
            this.buddyCollection.fixTmpSoulStrikes()
        },
        resetTmpSoulStrikes: function() {
            this.buddyCollection.resetTmpSoulStrikes()
        },
        fixSupporterTmpSoulStrikes: function() {
            this.userSupporterBuddyModel.fixTmpSoulStrikes()
        },
        resetSupporterTmpSoulStrikes: function() {
            this.userSupporterBuddyModel.resetTmpSoulStrikes()
        },
        getEventData: function(e) {
            return this.eventMap[e + ""]
        },
        setEventData: function(e, t) {
            return this.eventMap[e + ""] = t, this.eventMap[e + ""]
        }
    })
}), define("scenes/common/config/FriendInvite", ["lib/TextMaster"], function(e) {
    return {
        postingTextOf: {
            copy: "【FINAL FANTASY Record Keeper】",
            facebook: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            fb_messenger: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            twitter: function() {
                return e.getInstance().get("friend_invite_text_short")
            },
            mail: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            line: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            googleplus: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            whatsapp: function() {
                return e.getInstance().get("friend_invite_text_long")
            },
            other: function() {
                return e.getInstance().get("friend_invite_text_short")
            }
        }
    }
}), define("scenes/common/config/GoogleAnalytics", [], function() {
    var e = {
        BattleAnimationStart: "BattleAnimationStart",
        BattleAnimationResult: "BattleAnimationResult",
        EquipEnhancementAnimation: "EquipEnhancementAnimation",
        EquipEvolutionAnimation: "EquipEvolutionAnimation",
        AbilityGenerateAnimation: "AbilityGenerateAnimation",
        AbilityUpgradeAnimation: "AbilityUpgradeAnimation"
    };
    return {
        DIRECT_CALL_SCREEN_NAME_OF: e,
        screenNameToUrlRegex: {
            WorldTop: /^#?world$/,
            GameTop: /^#?title$/,
            DungeonsSelect: /^#?world\/dungeons\/[^\/]+$/,
            BattlesSelect: /^#?world\/battles\/[^\/]+$/,
            EventsTop: /^#?events$/,
            EventsDungeonsSelect: /^#?event\/[^\/]+\/[^\/]+\/dungeons$/,
            EventsBattleSelect: /^#?event\/[^\/]+\/[^\/]+\/battles\/[^\/]+$/,
            EventsPrizes: /^#?event\/[^\/]+\/[^\/]+\/prizes$/,
            PartyTop: /^#?party$/,
            EquipChangeEdit: /^#?party\/equipment_change\/[^\/]+$/,
            GachaLineUp: /^#?gacha$/,
            GachaTop: /^#?gacha\/top\/[^\/]+$/,
            GachaAnimation: /^#?gacha\/anim\/(free|item|coin)\/$/,
            GachaResult: /^#?gacha\/result\/$/,
            BattleLose: /^#?battle\/fail\/[^\/]+\/lose\/$/,
            DungeonsClear: /^#?world\/battles\/[^\/]+\/clear$/,
            EquipTop: /^#?party\/equipment_top$/,
            EquipLimitExpand: /^#?party\/possession_limit_expand\/equipment$/,
            EquipChangeTop: /^#?party\/equipment$/,
            GiftBox: /^#?gift_box$/,
            EquipEnhancement: /^#?party\/enhancement$/,
            EquipEnhancementSelect: /^#?party\/enhancement_selected\/[^\/]+$/,
            AbilityChangeEdit: /^#?party\/ability_change\/[^\/]+$/,
            AbilityTop: /^#?party\/ability_top$/,
            AbilityLimitExpand: /^#?party\/possession_limit_expand\/ability$/,
            EquipChangeEditWeapon: /^#?party\/equipment_change_detail\/[^\/]+\/weapon$/,
            EquipChangeEditArmor: /^#?party\/equipment_change_detail\/[^\/]+\/armor$/,
            AbilityChange: /^#?party\/ability$/,
            AbilityGenerate: /^#?party\/ability_generate$/,
            PartyEditTop: /^#?party\/party_edit$/,
            BattleOpeTop: /^#?battle\/operations$/,
            AbilityChangeEditSlot1: /^#?party\/ability_change_detail\/[^\/]+\/1$/,
            EquipChangeEditAccessory: /^#?party\/equipment_change_detail\/[^\/]+\/accessory$/,
            AbilityChangeEditSlot2: /^#?party\/ability_change_detail\/[^\/]+\/2$/,
            EquipEvolution: /^#?party\/evolution$/,
            AbilityUpgrade: /^#?party\/ability_upgrade$/,
            BattleLeave: /^#?battle\/fail\/[^\/]+\/leave\/$/,
            EquipEvolutionSelect: /^#?party\/evolution_selected\/[^\/]+$/,
            EventsIntro: /^#?event\/[^\/]+\/intro$/,
            Quest: /^#?quest$/
        }
    }
}), define("scenes/common/config/PartialTemplate", [], function() {
    return {
        paths: ["templates/achievement_room/views/AchivementInfoCondition", "templates/party/views/AbilityGenerationList", "templates/party/views/AbilityUpgradeList"]
    }
}), define("scenes/common/Config", ["./config/FriendInvite", "./config/GoogleAnalytics", "./config/PartialTemplate"], function(e, t, n) {
    return {
        friendInvite: e,
        googleAnalytics: t,
        partialTemplate: n
    }
}), define("scenes/common/GoogleAnalytics", ["scenes/common/Config", "kickmotor"], function(e, t) {
    var n = {
        init: function() {
            if (!(FF && FF.env && FF.env.isWWRegion())) return;
            this.loadGA(), this.startGA(), this.hasBeenInit = !0
        },
        loadGA: function() {
            (function(e, t, n, r, i, s, o) {
                e.GoogleAnalyticsObject = i, e[i] = e[i] || function() {
                    (e[i].q = e[i].q || []).push(arguments)
                }, e[i].l = 1 * new Date, s = t.createElement(n), o = t.getElementsByTagName(n)[0], s.async = 1, s.src = r, o.parentNode.insertBefore(s, o)
            })(window, document, "script", "//www.google-analytics.com/analytics.js", "ga")
        },
        startGA: function() {
            ga("create", "UA-38428036-10", {
                sampleRate: 10
            }), ga("send", "pageview")
        },
        sendScreenNameIfNeed: function() {
            var n = Object.keys(e.googleAnalytics.screenNameToUrlRegex),
                r = _.find(n, function(t) {
                    var n = e.googleAnalytics.screenNameToUrlRegex[t];
                    return location.hash.match(n)
                });
            FF && FF.env && FF.env.isWWRegion() ? (this.hasBeenInit || this.init(), ga("send", "pageview", r)) : r && t.googleanalytics.sendScreenName(r)
        }
    };
    return n.init(), n
}), define("scenes/common/util/ErrorHandler", ["jquery", "underscore", "backbone", "lib/EventBase", "lib/api", "scenes/common/views/ModalError"], function(e, t, n, r, i, s) {
    return r.extend({
        setup: function() {
            var t = this.handler;
            e(window).off("error"), e(window).on("error", t.bind(this))
        },
        handler: function(t) {
            var n = t.originalEvent,
                r = n.message,
                i = new s;
            FF.router.overlay.registerChildren(i), i.render(n), i.open(), e(window).off("error"), this.sendErrorInfo(n)
        },
        sendErrorInfo: function(e) {
            var t = {
                filename: e.filename,
                lineno: e.lineno || 0,
                colno: e.colno || 0,
                message: e.message || "",
                error: e.error || "",
                hash: location.hash || "",
                ua: window.navigator.userAgent,
                version: this._getJsVersionInfo() || ""
            };
            i.errorDeferred(JSON.stringify(t))
        },
        _getJsVersionInfo: function() {
            var e = FF.env.versionInfo || {};
            return e["static/js/"]
        }
    })
}), define("scenes/common/views/ModalMobageLogin", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalMobageLogin"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickClose: function() {
            kickmotor.platform.mobageLogin("#title"), this.end()
        }
    })
}), define("scenes/common/helper/MobageLogin", ["jquery", "underscore", "scenes/common/views/ModalMobageLogin"], function(e, t, n) {
    return {
        showModalIfNeedDeferred: function() {
            var t = e.Deferred();
            return FF.env.checkMobageLoginDeferred().then(function(e) {
                if (!e) {
                    var r = new n;
                    FF.router.overlay.registerChildren(r), r.render(), r.open(), t.reject({
                        rejectedByMobageLoginHelper: !0
                    })
                } else t.resolve()
            }), t.promise()
        }
    }
}), define("scenes/dungeon/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        dungeonListDeferred: function(e, t) {
            t = t || {};
            var n = t.eventId ? sprintf("/dff/event/%s/%s/dungeons", t.eventType, t.eventId) : "/dff/world/dungeons";
            return this.requestDeferred(n, {
                world_id: e
            })
        },
        dungeonEnterDeferred: function(e, t) {
            t = t || {};
            var n = t.eventId ? sprintf("/dff/event/%s/%s/enter_dungeon", t.eventType, t.eventId) : "/dff/world/enter_dungeon",
                r = t.fellowUserId;
            return this.requestDeferred(n, {
                dungeon_id: e,
                fellow_user_id: r
            }, {
                type: "POST"
            })
        },
        dungeonLeaveDeferred: function(e, t) {
            t = t || {};
            var n = t.eventId ? sprintf("/dff/event/%s/%s/leave_dungeon", t.eventType, t.eventId) : "/dff/world/leave_dungeon";
            return this.requestDeferred(n, {
                dungeon_id: e
            }, {
                type: "POST"
            })
        },
        dungeonInfoDeferred: function(e, t) {
            return t = t || {}, this.requestDeferred("/dff/world/dungeon_info", {
                dungeon_id: e
            })
        }
    })
}), define("scenes/common/views/ModalTermCheck", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "lib/ModalBase", "templates/common/ModalTermCheck"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            this.worldModel = e.worldModel, this.dungeonSessionModel = e.dungeonSessionModel, this.isRequiredToExecDungeonLeave = e.isRequiredToExecDungeonLeave ? !0 : !1
        },
        render: function() {
            this.renderContent(s, {
                worldModel: this.worldModel
            })
        },
        onClickClose: function() {
            this.isRequiredToExecDungeonLeave ? this.execDungeonLeave() : (n.history.navigate("#home", {
                trigger: !0
            }), this.end())
        },
        execDungeonLeave: function() {
            var e = this;
            this.hasEventSpecificLeaveFunc() ? this.worldModel.getEventModel().getHelper().execDungeonLeaveDeferred().done(function() {
                e.end()
            }) : this.execNormalDungeonLeave()
        },
        hasEventSpecificLeaveFunc: function() {
            if (!this.worldModel || this.worldModel.isNormalWorld()) return !1;
            var e = this.worldModel.getEventModel().getHelper();
            return e.execDungeonLeaveDeferred ? !0 : !1
        },
        execNormalDungeonLeave: function() {
            var e = this,
                t = this.worldModel ? this.worldModel.getApiOptions() : {},
                i = this.dungeonSessionModel.get("dungeon_id");
            r.dungeonLeaveDeferred(i, t).done(function(t) {
                FF.datastore.userModel.set(t.user), FF.datastore.clearDungeonSession(), n.history.navigate("#home", {
                    trigger: !0
                }), e.end()
            })
        }
    })
}), define("scenes/common/helper/TermCheck", ["jquery", "underscore", "scenes/common/views/ModalTermCheck"], function(e, t, n) {
    var r = function(e) {
        var t = new n(e);
        FF.router.overlay.registerChildren(t), t.render(), t.open()
    };
    return {
        showModalIfExpireDeferred: function(t) {
            var n = e.Deferred();
            return t && t.canBeginBattleTerm() ? n.resolve().promise() : (r({
                worldModel: t
            }), n.reject({
                rejectedByTermCheckHelper: !0
            }).promise())
        },
        showModalIfClosedDeferred: function() {
            var t = e.Deferred(),
                n = FF.datastore.dungeonSessionModel;
            if (!n.isInDungeon()) return t.resolve().promise();
            var i = function() {
                r({
                    worldModel: n.getWorldModel() || null,
                    dungeonSessionModel: n,
                    isRequiredToExecDungeonLeave: !0
                })
            };
            return n.isOpenedToClosedTerm() ? n.isKeptOutToClosedTerm() && !n.isInBattle() ? (i(), t.reject({
                rejectedByTermCheckHelper: !0
            })) : t.resolve() : (i(), t.reject({
                rejectedByTermCheckHelper: !0
            })), t.promise()
        },
        openModal: r
    }
}), define("scenes/common/views/ModalGoToTitle", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalGoToTitle"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickClose: function() {
            FF.redirect("/dff/login")
        }
    })
}), define("scenes/tutorial/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        proceedTutorialDeferred: function(e, t) {
            return t = t ? t : {}, t.type = "POST", this.requestDeferred("/dff/tutorial/proceed", {
                step: e
            }, t)
        },
        beginTutorialBattleSessionDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/begin_battle_session", {
                step: e
            }, {
                type: "POST"
            })
        },
        getTutorialGachaListDeferred: function() {
            return this.requestDeferred("/dff/tutorial/gacha_list")
        },
        executeTutorialGachaDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/execute_gacha", {
                step: e
            }, {
                type: "POST"
            })
        },
        updateTutorialRecommendPartyDeferred: function(e, t, n) {
            return this.requestDeferred("/dff/tutorial/update_recommend_party", {
                step: e,
                slot_to_buddy_id: t,
                changed_row_info: n
            }, {
                type: "POST"
            })
        },
        updateTutorialHeroEquipmentDeferred: function(e, t) {
            return this.requestDeferred("/dff/tutorial/update_hero_equipment", {
                step: e,
                equipment_id: t
            }, {
                type: "POST"
            })
        },
        nicknameInputDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/create_nickname", {
                nickname: e
            }, {
                type: "POST"
            })
        },
        getTutorialBattlesDeferred: function(e) {
            return this.requestDeferred("/dff/tutorial/battles", {
                step: e
            }, {
                type: "POST"
            })
        },
        giveAndSetAbilityDeferred: function() {
            return this.requestDeferred("/dff/tutorial/give_and_set_ability", {}, {
                type: "POST"
            })
        },
        proceedFuncTutorialDeferred: function(e) {
            return this.requestDeferred("/dff/user/proceed_func_tutorial", {
                key: e.key,
                dryrun: e.dryrun ? 1 : 0
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/tutorial/common/ModalIllust", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/tutorial/ModalIllust"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickIllust"
        },
        initialize: function(e) {
            this.srcs = e.reverse(), r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.renderContent(s, {
                srcs: this.srcs
            })
        },
        onClickIllust: function() {
            t("[data-app-tutorial-illustration]").last().remove();
            if (t("[data-app-tutorial-illustration]").length > 0) return;
            this.onClickClose()
        },
        onClickClose: function() {
            this.end()
        }
    })
}), define("scenes/tutorial/common/ModalIllustForOverlay", ["./ModalIllust"], function(e) {
    return e.extend({
        onClickClose: function() {
            this.end(!0), this.trigger("ModalIllustForOverlayClose")
        }
    })
}), define("scenes/tutorial/common/NavigationCharacter", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "util", "./ModalIllust", "./ModalIllustForOverlay", "templates/tutorial/NavigationCharacter"], function(e, t, n, r, i, s, o, u) {
    var a = {
        SHOW_ILLUST_TRIGGER_KEY: "SHOW_ILLUST",
        SHOW_ILLUST_DOUBLE_TRIGGER_KEY: "SHOW_ILLUST_DOUBLE",
        GUIDE_CHARACTER_DATA_NAME: "data-app-character",
        TALK_WINDOW_DATA_NAME: "[data-app-talk-window]",
        TALK_WINDOW_TEXT_DATA_NAME: "[data-app-talk-window-text]",
        VISIBLE_CLASS_NAME: "pop",
        VISIBLE_NEXT_CLASS: "next",
        DISABLE_CLASS_NAME: "is-disable",
        CHARACTER_IMAGE_CLASS_NAME: "pic",
        DESHI_FACE_NORMAL: "is-normal",
        DESHI_FACE_LAUGH: "is-laugh",
        DESHI_FACE_SAD: "is-sad",
        DESHI_FACE_SURPRISE: "is-surprise"
    };
    return n.View.extend({
        initialize: function(e) {
            if (!e.talks) throw new Error("data.talks not found");
            this.talks = i.cloneDeep(e.talks), this.talkNumber = 0, this.illustNumber = 0
        },
        render: function(e) {
            e = e || {}, e.isPoppedWindow = e.isPoppedWindow === undefined ? !0 : e.isPoppedWindow, this.renderNavigationCharacter(), this.container = t("#overlayNavigation"), this.talkWindow = t(a.TALK_WINDOW_DATA_NAME), this.talkWindowText = t(a.TALK_WINDOW_TEXT_DATA_NAME), e.isPoppedWindow && this.popTalkWindow(), this.setupTalk()
        },
        renderNavigationCharacter: function() {
            this.$el.append(u())
        },
        popTalkWindow: function() {
            this.talkWindow.addClass(a.VISIBLE_CLASS_NAME)
        },
        setupTalk: function() {
            this.talkObj = this.talks.shift();
            if (!this.talkObj) {
                this.trigger("talkEnd");
                return
            }
            this.talkNumber = this.talkNumber + 1, this.talkWindowText.text(""), this.talkWindow.removeClass(a.VISIBLE_NEXT_CLASS);
            var e = this.talkObj.action_trigger_key;
            e === "" && (e = "talkStart"), FF.logger.debug(e), this.trigger(e), e !== a.SHOW_ILLUST_TRIGGER_KEY && e !== a.SHOW_ILLUST_DOUBLE_TRIGGER_KEY && (this.popNavigationCharacter(), this.popTalkWindow(), this.renderTalk()), this.forceUpdateContainer()
        },
        popNavigationCharacter: function() {
            var n = this.talkObj.speaker,
                r = t("[" + a.GUIDE_CHARACTER_DATA_NAME + "]");
            e.each(r, function(e) {
                var n = t(e).hasClass(a.DISABLE_CLASS_NAME);
                n || t(e).addClass("is-colorless")
            });
            switch (n) {
                case "moogle":
                    this.visibleSpeakerElembyName("moogle");
                    break;
                case "cid":
                    this.visibleSpeakerElembyName("cid");
                    break;
                case "deshi":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_NORMAL);
                    break;
                case "deshi_laugh":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_LAUGH);
                    break;
                case "deshi_sad":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_SAD);
                    break;
                case "deshi_surprise":
                    this.visibleSpeakerElembyName("deshi"), this.replaceDeshiFaceImg(a.DESHI_FACE_SURPRISE);
                    break;
                case "god":
                    break;
                default:
                    throw new Error("invalid speaker value: " + n)
            }
        },
        visibleSpeakerElembyName: function(e) {
            t("[" + a.GUIDE_CHARACTER_DATA_NAME + "=" + e + "]").removeClass(a.DISABLE_CLASS_NAME).removeClass("is-colorless")
        },
        replaceDeshiFaceImg: function(e) {
            t("[" + a.GUIDE_CHARACTER_DATA_NAME + '="deshi"]').find("." + a.CHARACTER_IMAGE_CLASS_NAME).removeClass().addClass(a.CHARACTER_IMAGE_CLASS_NAME + " " + e)
        },
        renderTalk: function() {
            var e = this.replaceSpecialCharacter(this.talkObj.content);
            this.talkWindowText.append(e), this.renderNextButton()
        },
        renderNextButton: function() {
            this.trigger("talkEnd"), this.talkWindow.addClass(a.VISIBLE_NEXT_CLASS)
        },
        forceUpdateContainer: function() {
            var e = this.talkWindow;
            e.fastCss("opacity", .99), window.setTimeout(function() {
                e.fastCss("opacity", 1)
            }, 0)
        },
        getTalkNumber: function() {
            return this.talkNumber
        },
        replaceSpecialCharacter: function(t) {
            return t = t.replace(/\{DESI\}/g, e.escape(FF.datastore.userModel.get("name"))), t = t.replace(/\{MOBACOIN\}/g, FF.TextMaster.getMobacoinUnit()), t = t.replace(/\{n\}/g, "<br>"), t
        },
        showTutorialIllust: function(e) {
            var t = this;
            this.container.addClass("is-disable").css("z-index", 1);
            var n = new s(e);
            n.render(), FF.router.overlay.registerChildren(n), n.openAfterImageLoad(), this.listenToOnce(n, "closeNotify", function() {
                t.container.removeClass("is-disable").css("z-index", ""), t.trigger("closeNotify")
            })
        },
        showTutorialIllustForOverlay: function(e) {
            var t = this;
            e = e ? e : [], this.container.addClass("is-disable").css("z-index", 1);
            var n = new o(e);
            n.render(), FF.router.overlay.registerChildren(n), n.openAfterImageLoad(), this.listenToOnce(n, "ModalIllustForOverlayClose", function() {
                t.container.removeClass("is-disable").css("z-index", ""), t.trigger("ModalIllustForOverlayClose")
            })
        },
        dispose: function() {
            this.container.addClass("is-disable"), this.$el.empty(), this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/common/views/OverlayNavigation", ["underscore", "jquery", "backbone", "scenes/tutorial/common/NavigationCharacter"], function(e, t, n, r) {
    var i = {
        THIS_EL_DATA_NAME: "#overlayNavigation",
        MODAL_DATA_NAME: "[data-app-modal]",
        TALK_CLOSE_WAIT_MSEC: 600
    };
    return n.View.extend({
        el: t(i.THIS_EL_DATA_NAME),
        events: {
            anchorsbeforejump: "onClickContainer"
        },
        initialize: function(e) {
            this.talks = e.talks, this.isFiredTalkEnd = !1, this.isShowingIllust = !1, n.View.prototype.initialize.call(this)
        },
        render: function(e) {
            t(i.THIS_EL_DATA_NAME).removeClass("is-disable"), this.setupComponents(), t(i.MODAL_DATA_NAME).hide(), this.navigationCharacter.render(), n.View.prototype.render.call(this)
        },
        open: function() {
            this.listenTo(this.navigationCharacter, "talkEnd", this.fireTalkEnd), this.trigger("openNotify")
        },
        setupComponents: function() {
            this.navigationCharacter = new r({
                el: t(i.THIS_EL_DATA_NAME),
                talks: this.talks
            })
        },
        fireTalkEnd: function() {
            var e = this;
            if (this.isShowingIllust) return;
            var n = this.navigationCharacter.getTalkNumber();
            if (n === this.talks.length) {
                if (this.isFiredTalkEnd) return;
                setTimeout(function() {
                    t(i.THIS_EL_DATA_NAME).one("anchorsbeforejump", function() {
                        e.closeNavigation()
                    })
                }, i.TALK_CLOSE_WAIT_MSEC), this.isFiredTalkEnd = !0
            }
        },
        showTutorialIllust: function(e) {
            var n = this;
            this.isShowingIllust = !0, this.navigationCharacter.showTutorialIllustForOverlay(e), t(i.MODAL_DATA_NAME).show(), this.listenToOnce(this.navigationCharacter, "ModalIllustForOverlayClose", function() {
                n.isShowingIllust = !1, n.fireTalkEnd(), t(i.MODAL_DATA_NAME).hide(), n.navigationCharacter.renderTalk()
            })
        },
        closeNavigation: function() {
            this.trigger("closeNotify"), this.dispose()
        },
        onClickContainer: function() {
            FF.SoundMgr.playChooseEffect(), this.navigationCharacter.setupTalk()
        },
        getNavigationCharacter: function() {
            return this.navigationCharacter
        },
        dispose: function() {
            t(i.MODAL_DATA_NAME).show(), this.navigationCharacter && this.navigationCharacter.dispose(), this.stopListening(), this.undelegateEvents()
        }
    }, {
        isOverlayNavigationOpening: function() {
            return t("#overlayNavigation").hasClass("is-disable") === !1
        }
    })
}), define("scenes/common/helper/DailyLogin", ["jquery", "underscore", "scenes/common/views/ModalGoToTitle", "scenes/common/views/OverlayNavigation"], function(e, t, n, r) {
    var i = function() {
            var e = new n;
            FF.router.overlay.registerChildren(e), e.render(), e.open()
        },
        s = function() {
            return !r.isOverlayNavigationOpening()
        };
    return {
        showModalIfNeedDeferred: function() {
            var t = e.Deferred();
            if (location.hash === "#title") return t.resolve().promise();
            if (!s()) return t.resolve().promise();
            var n = FF.datastore.userModel;
            return n.isRequiredLogin() || n.isUpdateLastLoginedAt() ? (i(), t.reject({
                rejectedByDailyLoginHelper: !0
            })) : t.resolve(), t.promise()
        }
    }
}), define("scenes/external_user_auth/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        createHashDeferred: function(e, t) {
            return this.requestDeferred("/dff/external_user_auth/create_hash", {
                guest_id: e,
                callback_url: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/ExternalUserAuth", ["jquery", "underscore", "lib/ModalBase", "lib/ExternalUserAuth", "scenes/external_user_auth/Api", "scenes/common/views/OverlayNavigation"], function(e, t, n, r, i, s) {
    return t.extend({}, r, {
        _callCreateHashApiDeferred: function(t) {
            var r = e.Deferred(),
                o = t.guestId,
                u = t.callbackUrl;
            if (!o || !u) return r.reject().promise();
            var a = n.isModalOpening() || s.isOverlayNavigationOpening();
            return i.createHashDeferred(o, u).done(function(e) {
                FF.router.loading.hide(a), t.inviteId = e.invite_id, t.hash = e.hash, r.resolve(t)
            }).fail(function() {
                FF.router.loading.hide(a), r.reject()
            }), r.promise()
        }
    })
}), define("scenes/common/helper/RootData", ["jquery", "underscore", "scenes/common/util/Api", "util"], function(e, t, n, r) {
    var i = 60;
    return {
        updateRootDataIfNeedDeferred: function(t) {
            var r = this;
            t = t || {};
            var i = e.Deferred(),
                s = function() {
                    return t.force ? !0 : r.shouldUpdate(t)
                }();
            return s ? (n.getRootDataDeferred().then(function(t) {
                FF.datastore.stash.giftBoxNum = t.gift_box_num, FF.datastore.notificationCollection.add(t.notification), FF.datastore.stash.gotUnixTimeOfRootData = t.current_time, FF.datastore.stash.newRelationNum = t.new_relation_num || 0, e(document).trigger("updateBadge"), i.resolve({
                    shouldUpdate: !0
                })
            }), i.promise()) : i.resolve({
                shouldUpdate: !1
            }).promise()
        },
        shouldUpdate: function(e) {
            e = e || {};
            var t = e.cacheValidSec || i,
                n = FF.datastore.stash.gotUnixTimeOfRootData;
            if (!n) return !0;
            var s = r.getTimeAsSec() - n;
            return s > t ? !0 : !1
        }
    }
}), define("scenes/common/helper/Resonator", ["lib/ClassBase"], function(e) {
    return e.extend({
        initialize: function() {
            this.resetSimulation(), this.resetUserContext()
        },
        simulateResonance: function(e) {
            this._resonantSeriesId = +e
        },
        resetSimulation: function() {
            this._resonantSeriesId = void 0
        },
        setUserContext: function(e) {
            this._userContext = e
        },
        resetUserContext: function() {
            this._userContext = void 0
        },
        getResonantSeriesId: function() {
            return this._getCtxBasedResonantSeriesId() || this._resonantSeriesId
        },
        _getCtxBasedResonantSeriesId: function() {
            if (this._userContext) {
                var e = this._userContext.getSeriesId();
                if (e) return e
            }
            var t = FF.datastore.dungeonSessionModel.get("series_id");
            return t ? t : void 0
        },
        getResonantAbilityCategoryBonusMap: function() {
            if (this._userContext) {
                var e = this._userContext.getAbilityCategoryBonusMap();
                if (e) return e
            }
            var t = FF.datastore.dungeonSessionModel.get("ability_category_bonus_map");
            return t ? t : void 0
        },
        getResonantStatusBonusOpt: function() {
            return {
                seriesId: this.getResonantSeriesId(),
                abilityCategoryBonusMap: this.getResonantAbilityCategoryBonusMap()
            }
        },
        isResonant: function() {
            return !!this.getResonantSeriesId()
        },
        isResonantRegardlessOfSimulation: function() {
            return !!this._getCtxBasedResonantSeriesId()
        },
        isSimulating: function() {
            return !!this._resonantSeriesId
        }
    })
}), define("scenes/common/helper/LeadToSecondDungeon", ["jquery", "underscore", "backbone", "scenes/common/Constant", "components/CookieMania"], function(e, t, n, r, i) {
    return {
        isLeadToSecondDungeon: function() {
            if (FF.datastore.stash.leadToSecondDungeonInfo.is_cleared) return !1;
            var e = new i,
                t = e.get(r.COOKIE_KEYS.LEAD_TO_SECOND_DUNGEON);
            return t ? !0 : !1
        },
        setLeadToSecondDungeon: function() {
            var e = new i;
            e.set(r.COOKIE_KEYS.LEAD_TO_SECOND_DUNGEON, 1)
        },
        clearLeadToSecondDungeon: function() {
            var e = new i;
            e.unset(r.COOKIE_KEYS.LEAD_TO_SECOND_DUNGEON)
        },
        goDungeonListScene: function() {
            var e = FF.datastore.stash.leadToSecondDungeonInfo.world_id,
                t = FF.datastore.worldCollection.get(e),
                r = t.getDungeonListFragment();
            return n.history.navigate(r, {
                trigger: !0
            })
        },
        shouldShowSecondDungeonTutorial: function(e) {
            var t = FF.datastore.stash.leadToSecondDungeonInfo.world_id;
            return e === t && this.isLeadToSecondDungeon() ? !0 : !1
        }
    }
}), define("scenes/common/helper/FirstAnniversaryTutorial", ["lib/ReleaseControl", "./LeadToSecondDungeon"], function(e, t) {
    return {
        canProceed: function() {
            var e = $.Deferred(),
                n = FF.datastore.userModel;
            return this.isOpen() ? n.hasProceededFuncTutorial("FIRST_ANNIVERSARY") ? !1 : t.isLeadToSecondDungeon() ? !1 : !0 : !1
        },
        isOpen: function() {
            return e.isReleasedByKey("FIRST_ANNIVERSARY_MOVIE_OPEN") && !e.isReleasedByKey("FIRST_ANNIVERSARY_MOVIE_CLOSE")
        },
        navigate: function() {
            Backbone.history.navigate("#func_tutorial/first_anniversary", {
                trigger: !0
            })
        }
    }
}), define("scenes/common/helper/TenMillionDownloadTutorial", ["lib/ReleaseControl", "./LeadToSecondDungeon"], function(e, t) {
    return {
        canProceed: function() {
            var e = $.Deferred(),
                n = FF.datastore.userModel;
            return this.isOpen() ? n.hasProceededFuncTutorial("TEN_MILLION_DOWNLOAD_MOVIE") ? !1 : t.isLeadToSecondDungeon() ? !1 : !0 : !1
        },
        isOpen: function() {
            return e.isOpen("TEN_MILLION_DOWNLOAD_OPEN", "TEN_MILLION_DOWNLOAD_CLOSE")
        },
        navigate: function() {
            Backbone.history.navigate("#func_tutorial/ten_million_download_movie", {
                trigger: !0
            })
        }
    }
}), define("scenes/common/helper/MissionBaseHelper", ["underscore", "jquery", "backbone", "lib/Storage"], function(e, t, n, r) {
    var i = {
        MISSION_STORAGE_DATA_KEY: "MISSION_STORAGE"
    };
    return {
        _storageData: null,
        _initializeStorageData: function() {
            this._storageData.achievedMissions = this._storageData.achievedMissions || []
        },
        _loadStorageDataDeferred: function() {
            var e = t.Deferred();
            return this._storageData ? e.resolve().promise() : (r.initDeferred().then(function(e) {
                return r.getItemDeferred(i.MISSION_STORAGE_DATA_KEY)
            }).then(function(t) {
                this._storageData = t.result ? JSON.parse(t.value) : {}, this._initializeStorageData(), e.resolve()
            }.bind(this)), e.promise())
        },
        _saveStorageDataDeferred: function() {
            var e = t.Deferred();
            return r.initDeferred().then(function(e) {
                return r.setItemDeferred(i.MISSION_STORAGE_DATA_KEY, JSON.stringify(this._storageData))
            }.bind(this)).then(function(t) {
                e.resolve()
            }), e.promise()
        },
        saveAchievedMissionsDeferred: function(e, n) {
            var r = t.Deferred();
            return n = n || {}, !e || e.length === 0 ? r.resolve().promise() : (n.isBattle || FF.datastore.missionCollection.add(e, {
                merge: !0
            }), this._loadStorageDataDeferred().then(function() {
                return this._storageData.achievedMissions = this._storageData.achievedMissions.concat(e), this._saveStorageDataDeferred()
            }.bind(this)).then(function() {
                r.resolve()
            }), r.promise())
        }
    }
}), define("scenes/common/views/ModalMissionClear", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalMissionClear", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-move-to-mission]": "onClickMoveToMission",
            "anchorsbeforejump [data-app-move-to-real-incentive-mission]": "onClickMoveToRealIncentiveMission",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(t) {
            this.missions = t.missions, FF.SoundMgr.playEffect("se_battle_common_101053"), this.isRealIncentiveMission = e.find(this.missions, function(e) {
                return e.is_real_incentive
            }) ? !0 : !1, this.renderContent(i, {
                missions: this.missions,
                isRealIncentiveMission: this.isRealIncentiveMission
            }), this.setupComponents()
        },
        onClickMoveToMission: function() {
            var e = "#mission/list";
            e === location.hash ? this.onClickModalClose() : n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickMoveToRealIncentiveMission: function() {
            var e = "#real_incentive_mission/list";
            e === location.hash ? this.onClickModalClose() : n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        setupComponents: function() {
            this.missions.length > 1 && (this.freescroll = new s({
                el: t("[data-ui-freescroll-for-rewards]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar-for-rewards]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }))
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/MissionHelper", ["underscore", "jquery", "backbone", "./MissionBaseHelper", "scenes/common/views/ModalMissionClear"], function(e, t, n, r, i) {
    return e.extend({}, r, {
        _initializeStorageData: function() {
            r._initializeStorageData.call(this);
            var e = this._storageData;
            e.currentCategory = e.currentCategory || FF.CONST.SERVER.MISSION.TYPE_OF.BEGINNER
        },
        loadDataDeferred: function() {
            return this._loadStorageDataDeferred()
        },
        hasNewMission: function(e) {
            e = e || {};
            var t = FF.datastore.stash,
                n = e.type;
            if (n) {
                if (!t.hasOwnProperty("missionTabConfirmedAtMap")) return !1;
                if (!t.missionTabConfirmedAtMap.hasOwnProperty(n)) return !1;
                var r = FF.datastore.missionCollection.getLatestMission(n);
                if (!r) return !1;
                var i = t.missionTabConfirmedAtMap[n];
                return Number(r.get("opened_at")) > i
            }
            return t.hasNewMission
        },
        shouldShowModalMissionClear: function() {
            if (!this._storageData.achievedMissions) return !1;
            if (this._storageData.achievedMissions.length === 0) return !1;
            var t = [],
                n = FF.datastore.missionCollection;
            return e.each(this._storageData.achievedMissions, function(e) {
                var r = n.get({
                    id: e.id
                });
                if (r && r.isReceivedReward()) return;
                t.push(e)
            }), this._storageData.achievedMissions = t, t.length > 0
        },
        openModalMissionClearIfNeedDeferred: function() {
            var e = t.Deferred();
            return this._loadStorageDataDeferred().then(this._openModalMissionClearDeferred.bind(this)).then(function() {
                e.resolve()
            }), e.promise()
        },
        _openModalMissionClearDeferred: function() {
            var e = t.Deferred();
            if (!this.shouldShowModalMissionClear()) return e.resolve().promise();
            var n = this._getSortedAchievedMissions();
            return this._storageData.achievedMissions = [], this._saveStorageDataDeferred().then(function() {
                FF.modalStack.push(i, {
                    renderer: function(e) {
                        e.render({
                            missions: n
                        })
                    },
                    onPop: function(t) {
                        e.resolve()
                    }
                })
            }), e.promise()
        },
        _getSortedAchievedMissions: function() {
            return this._storageData.achievedMissions.sort(function(e, t) {
                return e.is_beginner && !t.is_beginner ? -1 : !e.is_beginner && t.is_beginner ? 1 : e.is_normal && !t.is_normal ? -1 : !e.is_normal && t.is_normal ? 1 : e.disp_number < t.disp_number ? -1 : e.disp_number > t.disp_number ? 1 : 0
            })
        },
        getMissionListCurrentCategory: function() {
            return this._storageData.currentCategory
        },
        saveMissionListCurrentCategoryDeferred: function(e) {
            return this._storageData.currentCategory === e ? t.Deferred().resolve().promise() : (this._storageData.currentCategory = e, this._saveStorageDataDeferred())
        }
    })
}), define("scenes/battle_list/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        dungeonSessionDeferred: function() {
            return this.requestDeferred("/dff/world/battles")
        },
        battleBeginSessionDeferred: function(e, t, n) {
            n = n || {};
            var r = n.eventId ? sprintf("/dff/event/%s/%s/begin_battle_session", n.eventType, n.eventId) : "/dff/battle/begin_session";
            return this.requestDeferred(r, {
                battle_id: e,
                begin_token: t
            }, {
                type: "POST"
            })
        },
        battleBeginBattleDeferred: function(e, t, n) {
            n = n || {};
            var r = n.eventId ? sprintf("/dff/event/%s/%s/begin_battle", n.eventType, n.eventId) : "/dff/battle/begin_battle";
            return this.requestDeferred(r, {
                battle_id: e,
                session_key: t
            }, {
                type: "POST"
            })
        },
        battleQuitDeferred: function() {
            return this.requestDeferred("/dff/battle/quit", {}, {
                type: "POST"
            })
        },
        recoverStaminaDeferred: function(e) {
            return this.requestDeferred("/dff/world/recover_stamina", {}, {
                type: "POST",
                forceThrowError: !0
            })
        },
        useTentDeferred: function(e) {
            return this.requestDeferred("/dff/world/use_tent", {}, {
                type: "POST",
                forceThrowError: !0
            })
        },
        battleFailDeferred: function(e, t, n) {
            return this.requestDeferred("/dff/world/fail", {
                dungeon_id: e,
                tip_id: n,
                kind: t
            })
        },
        battleEpilogueDeferred: function(e) {
            return this.requestDeferred("/dff/world/epilogue", {
                dungeon_id: e
            })
        }
    })
}), define("scenes/common/views/ModalBattleResume", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase", "scenes/battle_list/Api", "templates/common/ModalBattleResume"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-quit]": "onClickQuit",
            "anchorsbeforejump [data-app-modal-resume]": "onClickResume"
        },
        render: function() {
            this.renderContent(o, {})
        },
        onClickQuit: function() {
            var e = this;
            s.battleQuitDeferred().done(function() {
                var t = FF.datastore.dungeonSessionModel;
                t.clearBattleSession();
                var r = t.getWorldModel(),
                    i = t.get("dungeon_id"),
                    s = r.getBattleListFragment(i);
                e.end(), n.history.navigate(s, {
                    trigger: !0
                })
            })
        },
        onClickResume: function() {
            var e = FF.datastore.dungeonSessionModel.get("battle_id");
            FF.redirect("/dff/battle/", {
                battle_id: e,
                is_resume: 1
            })
        }
    })
}), define("scenes/title/views/ModalExitApplicationConfirm", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/ModalBase", "templates/title/ModalExitApplicationConfirm"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide]": "onClickDecide"
        },
        initialize: function() {
            i.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(s, {})
        },
        onClickModalClose: function() {
            this.close()
        },
        onClickDecide: function() {
            FF.router.loading.lock(), kickmotor.util.finishApplication(!1)
        }
    })
}), define("scenes/common/views/ModalPaymentFallback", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalPaymentFallback"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        render: function(e) {
            this.renderContent(i, e)
        },
        onClickClose: function() {
            this.end()
        }
    })
}), define("templates_ww/migration_info/MigrationInfo", [], function() {
    return function(a) {
        function print() {
            __p += __j.call(arguments, "")
        }
        a || (a = {});
        var b, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(a) {
            __p += "<!-- TODO:↓WWでも使用するかどうか -->\n";
            var c = +FF.datastore.stash.user_grade > 1 ? !0 : !1;
            __p += '\n<div class="c-modal-window scene-ww-migration-info">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><span class="c-ttl-scene__inner">Manage Account</span></h1>\n        <div class="c-freescroll-wrap is-add-cover">\n            <div class="c-freescroll" data-ui-freescroll="migrationInfo">\n                <div data-ui-freescroll-content>\n                    <div class="c-paper-container">\n                        <section class="c-paper-container__inner">\n                            <section class="mb-b4 ml-b2 mr-b2">\n                                <h1 class="c-ttl-section mb-b2">\n                                    CAUTION\n                                </h1>\n                                <ul class="c-text-indent is-list-style">\n                                    <li class="c-text-indent__inner mb-b2">\n                                        If you make an account link by mistake, the game account on your current and linked devices will be overwritten and your progress may be lost.\n                                    </li>\n                                    <li class="c-text-indent__inner mb-b2">\n                                        Lost game accounts cannot be recovered, so please read the instructions carefully before overwriting an account.\n                                    </li>\n                                    <li class="c-text-indent__inner">\n                                        One Time Code is only valid for 5 minutes from the time of issuance, and it is not intended for permanently preventing data loss\n                                    </li>\n                                    <li class="c-text-indent__inner">\n                                        Android users: The game account is automatically linked to your Google account. If you try to manually link to this account, a message will be displayed informing you that the account is already linked.\n                                    </li>\n                                    <li class="c-text-indent__inner">\n                                        If you have linked two devices to the same account data, overwriting the account data on one device <span class="fc-warning">may cause it to be also overwritten on the other device as well.</span>\n                                    </li>\n                                    <li class="c-text-indent__inner">\n                                        Note that Gems purchased on iOS can only be used on iOS devices. Gems purchased on Android can only be used on Android devices.\n                                    </li>\n                                    <li class="c-text-indent__inner">\n                                        Creating a backup of your device data on your PC will not save your game account. It is necessary to make an account link to prevent data loss.\n                                    </li>\n                                    <li class="c-text-indent__inner fc-warning">\n                                        Never give the One Time Code or your social account login details to anyone else. \n                                    </li>\n                                    <li class="c-text-indent__inner">\n                                        Linked social accounts can never be unlinked or linked to another game account.\n                                    </li>\n                                </ul>\n                            </section>\n                            <section class="mb-b4 ml-b2 mr-b2">\n                                <h1 class="c-ttl-section mb-b2">\n                                    Account Management\n                                </h1>\n                                <p class="mb-b3">You can make an account link to other services to prevent data loss.<br>Please read these points before you start.</p>\n                                <dl class="mb-b2">\n                                    <dt class="fc-warning mb-b">STEP 1    Make Account Link</dt>\n                                    <dd>Tap the "Make Account Link" button below. This will link your game account to a social account and will allow this account data to be used on another device. (NOTE: For Android users, the game account is automatically linked to your current Google Account.)</dd>\n                                </dl>\n                                <div class="box-cc mb-b3">\n                                    <a class="c-btn is-sub-lead" data-mbgaui-anchors="{ preventDefault: true }" data-app-link-account  data-app-sound="choose"><span class="c-btn__inner">Make Account Link</span></a>\n                                </div>\n                                <dl class="mb-b2">\n                                    <dt class="fc-warning mb-b">STEP 2    Overwrite Account</dt>\n                                    <dd>Tap the "Overwrite Account" button below then select the service linked with the game account you previously linked above in STEP1. This will <span class="fc-warning">OVERWRITE ALL</span> of your game account information on this AND linked devices. These changes will only take effect once the app has been reset.</dd>\n                                </dl>\n                                <div class="box-cc">\n                                    <a class="c-btn is-sub-lead" data-mbgaui-anchors="{ preventDefault: true }" data-app-load-account  data-app-sound="choose"><span class="c-btn__inner">Overwrite Account</span></a>\n                                </div>\n                            </section>\n                        </section>\n                    </div>\n                </div>\n                <div class="c-freescroll__scrollbar" data-ui-scrollbar="migrationInfo"><div class="c-freescroll__scrollbar-inner" data-ui-scrollbar-face></div></div>\n            </div>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors="{ preventDefault: true }" data-app-sound="choose" data-app-modal-back data-app-enable-back-key="true"><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>'
        }
        return __p
    }
}), define("ww/scenes/migration_info/views/ModalMigrationInfo", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "templates_ww/migration_info/MigrationInfo"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickClose",
            "anchorsbeforejump [data-app-link-account]": "linkAccount",
            "anchorsbeforejump [data-app-load-account]": "loadAccount"
        },
        render: function(e) {
            this.putContent(o())
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t('[data-ui-freescroll="migrationInfo"]')
            }), this.scrollbar = new s({
                el: t('[data-ui-scrollbar="migrationInfo"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        open: function() {
            this.listenToOnce(this, "openAnimationEnd", this.setupComponents), r.prototype.open.apply(this, arguments)
        },
        linkAccount: function() {
            kickmotor.platform.linkAccount(function(e) {
                e.success ? FF.logger.debug("successfully linked account") : FF.logger.debug("failed to link account")
            })
        },
        loadAccount: function() {
            kickmotor.platform.loadAccount(function(e) {
                e.success ? FF.logger.debug("successfully loaded account") : FF.logger.debug("failed to load account")
            })
        },
        onClickClose: function() {
            this.end(), this.trigger("onClickClose")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/title/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/GooglePlayGameService", "scenes/common/util/Api", "./ModalExitApplicationConfirm", "templates/title/Title", "scenes/common/views/ModalPaymentFallback", "ww/scenes/migration_info/views/ModalMigrationInfo", "util"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-title-button]": "onTouchScreen",
            "anchorsbeforejump [data-app-gp-login]": "onTouchLoginButton",
            "anchorsbeforejump [data-app-gp-achieve]": "onTouchAchievementButton",
            "anchorsbeforejump [data-app-gp-logout]": "onTouchLogoutButton",
            "anchorsbeforejump [data-app-open-migration-info]": "openModalMigrationInfo",
            "anchorsbeforejump [data-app-eula]": "onTouchEulaButton",
            "anchorsbeforejump [data-app-pp]": "onTouchPPButton"
        },
        initialize: function(e) {
            this.enableBackKey = !1, r.prototype.initialize.call(this)
        },
        render: function() {
            var e = this,
                t = {
                    isAndroid: FF.env.isAndroid(),
                    util: l,
                    isWWLayout: FF.env.isWWRegion()
                };
            r.prototype.render.call(this, u, t), this.setHeightIfItCan(), this.googlePlayDeferred().then(function() {
                e.processAfterRender()
            }), this.registerGameCenterAchievements()
        },
        setHeightIfItCan: function() {
            var e = t("#content").innerHeight();
            e === 0 && t("#content").css("height", t("body").innerHeight() + "px")
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), this.enableBackKey = !0, this.showModalIfPaymentFallback()
        },
        googlePlayDeferred: function() {
            var e = this,
                n = t.Deferred();
            return i.loginCheckDeferred().done(function() {
                t(".plus_login").css("display", "none"), t(".plus_logout").css("display", ""), s.getGooglePlayAchievementsDeferred().done(function(e) {
                    i.sendAchievement(l.camelizeDeep(e).achievements), n.resolve()
                })
            }).fail(function() {
                t(".plus_login").css("display", ""), t(".plus_logout").css("display", "none"), n.resolve()
            }), n.promise()
        },
        registerGameCenterAchievements: function() {
            FF.env.isWWRegion() && FF.env.isIOS() && s.getGooglePlayAchievementsDeferred().done(function(t) {
                var n = l.camelizeDeep(t).achievements;
                e.each(n, function(e) {
                    kickmotor.iosgamecenter.unlockAchievement(e.achievementId)
                })
            })
        },
        onTouchLoginButton: function() {
            i.loginDeferred().done(function() {
                t(".plus_login").css("display", "none"), t(".plus_logout").css("display", ""), s.getGooglePlayAchievementsDeferred().done(function(e) {
                    i.sendAchievement(l.camelizeDeep(e).achievements), FF.router.loading.hide()
                })
            }).fail(function() {
                FF.router.loading.hide()
            })
        },
        onTouchLogoutButton: function() {
            i.logout(), i.loginCheckDeferred().done(function() {
                t(".plus_login").css("display", "none"), t(".plus_logout").css("display", ""), FF.router.loading.hide()
            }).fail(function() {
                t(".plus_login").css("display", ""), t(".plus_logout").css("display", "none"), FF.router.loading.hide()
            })
        },
        onTouchAchievementButton: function() {
            var e = this;
            i.loginCheckDeferred().done(function() {
                i.openAchievement()
            }).fail(function() {
                i.loginDeferred().done(function() {
                    FF.router.loading.hide()
                })
            })
        },
        openModalMigrationInfo: function() {
            if (FF.env.isWWRegion()) {
                var e = new f({});
                FF.router.overlay.registerChildren(e), e.render(), e.open(), this.listenToOnce(e, "onClickClose", function() {
                    e.close()
                })
            }
        },
        onTouchEulaButton: function() {
            FF.env.isWWRegion() && (this.lockScreenBeforeGoExternalLink(), this.openUrl("https://dena.com/legal/EULA.html"))
        },
        onTouchPPButton: function() {
            FF.env.isWWRegion() && (this.lockScreenBeforeGoExternalLink(), this.openUrl("https://dena.com/legal/PP.html"))
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onTouchScreen: function() {
            FF.router.loading.lock(), FF.SoundMgr.playDecideEffect(), this.trigger("onTouchScreen")
        },
        onClickBack: function() {
            if (!this.enableBackKey) return;
            this.modalExitApplicationConfirm || (this.modalExitApplicationConfirm = new o({}), FF.router.overlay.registerChildren(this.modalExitApplicationConfirm)), this.modalExitApplicationConfirm.render(), this.modalExitApplicationConfirm.open()
        },
        showModalIfPaymentFallback: function() {
            var e = FF.datastore.stash.paymentFallback;
            if (!e) return;
            delete FF.datastore.stash.paymentFallback;
            var t = new a;
            FF.router.overlay.registerChildren(t), t.render(e), t.open()
        }
    })
}), define("scenes/title/views/ModalTitleError", ["underscore", "jquery", "backbone", "scenes/common/views/ModalError", "templates/title/ModalRestrictedUser"], function(e, t, n, r, i) {
    return r.extend({
        render: function(e) {
            e.error_type === "RESTRICTED_USER" ? this.renderContent(i, {}) : r.prototype.render.apply(this, e)
        }
    })
}), define("scenes/title/TitleScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "./views/ModalTitleError", "lib/Download", "scenes/common/helper/LeadToSecondDungeon", "scenes/common/helper/ExternalUserAuth"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        start: function() {
            var e = this;
            FF.SoundMgr.playDefaultBgm(), FF.datastore.userModel.set("is_update_last_logined_at", !1);
            if (u.isLeadToSecondDungeon()) {
                this.goNextScene();
                return
            }
            kickmotor.animation.clearUnusedJsonCache(), this.layoutView = new i, this.layoutView.render(), a.checkExternalUserAuthCallDeferred().always(function() {
                e.listenToOnce(e.layoutView, "onTouchScreen", e.goNextScene)
            })
        },
        goNextScene: function() {
            FF.datastore.stash.isRestrictedUser ? this.showErrorModal({
                error_type: "RESTRICTED_USER"
            }) : o.hasFileNeededToDownloadDeferred(FF.datastore.stash.assetsRequiredOnLaunch, {
                url: null,
                isBootstrapTransition: !0
            }).then(function(e) {
                e.needDownload ? n.history.navigate("download", {
                    trigger: !0
                }) : FF.router.goBootstrapNextScene()
            })
        },
        showErrorModal: function(e) {
            var t = new s;
            FF.router.overlay.registerChildren(t), t.render(e), t.open()
        }
    })
}), define("scenes/tutorial/common/ModalIllustMulti", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/tutorial/ModalIllustMulti"], function(e, t, n, r, i, s) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump #modalNextBtn": "onClickNextBtn",
            "anchorsbeforejump [data-app-modal-back]": "onClickBackBtn",
            "anchorsbeforejump #modalCloseBtn": "onClickCloseBtn"
        },
        initialize: function(e, t, n) {
            this.srcs = e, this.speakerClassName = n;
            if (t < 2) throw new Error("If you want to view the illust only one, use ModalIllust. maxNum: " + t);
            this.maxNum = t, this.currentNum = 1, r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.renderContent(s, {
                srcs: this.srcs,
                maxNum: this.maxNum,
                speakerClassName: this.speakerClassName
            })
        },
        onClickNextBtn: function() {
            if (this.currentNum >= this.maxNum) return;
            this._hideIllust(), this.currentNum = this.currentNum + 1, this._showIllust(), this._isShowingSecondIllust() && this._showBackBtn(), this._isShowingLastIllust() && (this._hideNextBtn(), this._showCloseBtn())
        },
        onClickBackBtn: function() {
            if (this._isShowingFirstIllust()) return;
            if (this.currentNum <= 1) return;
            FF.SoundMgr.playChooseEffect(), this._hideIllust(), this._isShowingLastIllust() && this._showNextBtn(), this.currentNum = this.currentNum - 1, this._showIllust(), this._isShowingFirstIllust() && this._hideBackBtn()
        },
        onClickCloseBtn: function() {
            this.end()
        },
        _isShowingFirstIllust: function() {
            return this.currentNum === 1
        },
        _isShowingSecondIllust: function() {
            return this.currentNum === 2
        },
        _isShowingLastIllust: function() {
            return this.currentNum === this.maxNum
        },
        _showCloseBtn: function() {
            t("#modalCloseBtn").removeClass("di-n")
        },
        _showNextBtn: function() {
            t("#modalNextBtn").removeClass("is-disable")
        },
        _hideNextBtn: function() {
            t("#modalNextBtn").addClass("is-disable")
        },
        _showBackBtn: function() {
            t("[data-app-modal-back]").removeClass("is-disable")
        },
        _hideBackBtn: function() {
            t("[data-app-modal-back]").addClass("is-disable")
        },
        _showIllust: function() {
            t("[data-app-illusts=" + this.currentNum + "]").removeClass("vi-h"), t('[data-app-modal-indicator="' + this.currentNum + '"]').addClass("is-active")
        },
        _hideIllust: function() {
            t("[data-app-illusts=" + this.currentNum + "]").addClass("vi-h"), t('[data-app-modal-indicator="' + this.currentNum + '"]').removeClass("is-active")
        }
    })
}), define("scenes/common/views/ModalSortieLimitation", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/common/ModalSortieLimitation"], function(e, t, n, r, i, s) {
    var o = {
        THIS_EL_DATA_NAME: "#overlayNavigation",
        MODAL_DATA_NAME: "[data-app-modal]",
        TALK_WINDOW_DATA_NAME: "[data-app-talk-window]",
        VISIBLE_CLASS_NAME: "pop",
        TALK_CLOSE_WAIT_MSEC: 600
    };
    return r.extend({
        el: t(o.THIS_EL_DATA_NAME),
        isNeverShowAgain: !1,
        events: {
            "anchorsbeforejump [data-app-overlay]": "onClickContainer",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-modal-btn-never-show]": "onClickNeverShow"
        },
        render: function() {
            if (t(o.MODAL_DATA_NAME).hasClass("open")) return;
            this.$el.removeClass("is-disable"), this.renderContent(s, {}), t(o.TALK_WINDOW_DATA_NAME).addClass(o.VISIBLE_CLASS_NAME)
        },
        onClickNeverShow: function(e) {
            t(e.currentTarget).toggleClass("is-checked"), this.isNeverShowAgain = this.isNeverShowAgain ? !1 : !0
        },
        onClickClose: function() {
            if (!this.isNeverShowAgain) {
                this.doClose();
                return
            }
            var e = this;
            FF.router.loading.show(), i.proceedFuncTutorialDeferred({
                key: "SORTIE_LIMITATION"
            }).done(function(t) {
                FF.datastore.userModel.set(t.user), FF.router.loading.hide(), e.doClose()
            })
        },
        doClose: function() {
            this.end(), t(o.MODAL_DATA_NAME).show(), this.$el.addClass("is-disable")
        },
        onClickContact: function() {
            t.nativefn.call("mobageContact")
        },
        onClickContainer: function() {}
    })
}), define("scenes/common/views/ModalSsLimitation", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/tutorial/Api", "templates/common/ModalSsLimitation"], function(e, t, n, r, i, s) {
    var o = {
        THIS_EL_DATA_NAME: "#overlayNavigation",
        MODAL_DATA_NAME: "[data-app-modal]",
        TALK_WINDOW_DATA_NAME: "[data-app-talk-window]",
        VISIBLE_CLASS_NAME: "pop",
        TALK_CLOSE_WAIT_MSEC: 600
    };
    return r.extend({
        el: t(o.THIS_EL_DATA_NAME),
        isNeverShowAgain: !1,
        events: {
            "anchorsbeforejump [data-app-overlay]": "onClickContainer",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-modal-btn-never-show]": "onClickNeverShow"
        },
        render: function() {
            if (t(o.MODAL_DATA_NAME).hasClass("open")) return;
            this.$el.removeClass("is-disable"), this.renderContent(s, {}), t(o.TALK_WINDOW_DATA_NAME).addClass(o.VISIBLE_CLASS_NAME)
        },
        onClickNeverShow: function(e) {
            t(e.currentTarget).toggleClass("is-checked"), this.isNeverShowAgain = this.isNeverShowAgain ? !1 : !0
        },
        onClickClose: function() {
            if (!this.isNeverShowAgain) {
                this.doClose();
                return
            }
            var e = this;
            FF.router.loading.show(), i.proceedFuncTutorialDeferred({
                key: "SS_LIMITATION"
            }).done(function(t) {
                FF.datastore.userModel.set(t.user), FF.router.loading.hide(), e.doClose()
            })
        },
        doClose: function() {
            this.end(), t(o.MODAL_DATA_NAME).show(), this.$el.addClass("is-disable"), this.trigger("modalViewClose")
        },
        onClickContainer: function() {}
    })
}), define("scenes/common/helper/FuncTutorial", ["jquery", "underscore", "backbone", "scenes/tutorial/Api", "scenes/tutorial/common/ModalIllust", "scenes/tutorial/common/ModalIllustMulti", "lib/Events", "scenes/common/views/ModalSortieLimitation", "scenes/common/views/ModalSsLimitation", "scenes/common/views/OverlayNavigation"], function(e, t, n, r, i, s, o, u, a, f) {
    return t.extend({
        hasSeen: function(e) {
            return FF.datastore.userModel.hasProceededFuncTutorial(e)
        },
        showNavigationDeferred: function(t) {
            var n = this,
                i = e.Deferred(),
                s = t.key,
                o = t.maxNum,
                u = t.speakerClassName;
            return FF.datastore.userModel.hasProceededFuncTutorial(s) ? i.resolve().promise() : (FF.router.loading.show(), r.proceedFuncTutorialDeferred({
                key: s
            }).done(function(e) {
                FF.datastore.userModel.set(e.user), t.isTutorialIllustOnly ? n.renderModalIllustViewDeferred(s).done(function() {
                    i.resolve()
                }) : t.isTutorialIllustMultiOnly ? n.renderModalIllustMultiViewDeferred(s, o, u).done(function() {
                    i.resolve()
                }) : t.isTutorialBattleList ? n.renderTutorialIllustForBattleList(e, s).done(function() {
                    i.resolve()
                }) : n.renderNavigationViewDeferred(e).done(function() {
                    i.resolve()
                })
            }), i.promise())
        },
        renderNavigationViewDeferred: function(t) {
            var n = this,
                r = e.Deferred(),
                i = new f({
                    talks: t.tutorial_talks
                });
            return FF.router.overlay.registerChildren(i), FF.router.loading.hide(), i.render(), i.open(), this.listenToOnce(i, "closeNotify", function() {
                n.stopListening(), FF.router.overlay.unregisterChildren(i), r.resolve()
            }), r.promise()
        },
        renderModalIllustViewDeferred: function(t) {
            var n = this,
                r = e.Deferred(),
                s = [n.getIllustImagePathByKey(t.toLowerCase())],
                o = new i(s);
            return o.render(), FF.router.overlay.registerChildren(o), o.openAfterImageLoad(), this.listenToOnce(o, "closeNotify", function() {
                n.stopListening(o), FF.router.overlay.unregisterChildren(o), r.resolve()
            }), r.promise()
        },
        renderModalIllustMultiViewDeferred: function(t, n, r) {
            var i = this,
                o = e.Deferred(),
                u = i.getIllustsImagePathByKey(t.toLowerCase(), n),
                a = new s(u, n, r);
            return a.render(), FF.router.overlay.registerChildren(a), a.openAfterImageLoad(), this.listenToOnce(a, "closeNotify", function() {
                i.stopListening(a), FF.router.overlay.unregisterChildren(a), o.resolve()
            }), o.promise()
        },
        renderTutorialIllustForBattleList: function(t, n) {
            var r = this,
                i = e.Deferred(),
                s = new f({
                    talks: t.tutorial_talks
                });
            return FF.router.overlay.registerChildren(s), FF.router.loading.hide(), s.render(), s.open(), this.listenToOnce(s.getNavigationCharacter(), "SHOW_ILLUST", function() {
                var e = [r.getIllustImagePathByKey(n.toLowerCase())];
                s.showTutorialIllust(e)
            }), this.listenToOnce(s, "closeNotify", function() {
                r.stopListening(), FF.router.overlay.unregisterChildren(s), i.resolve()
            }), i.promise()
        },
        showSortieLimitationDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (FF.datastore.userModel.hasProceededFuncTutorial("SORTIE_LIMITATION")) return n.resolve().promise();
            var r = new u;
            return FF.router.overlay.registerChildren(r), r.render(), r.open(), n.promise()
        },
        showSsLimitationDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (FF.datastore.userModel.hasProceededFuncTutorial("SS_LIMITATION")) return n.resolve().promise();
            var r = new a;
            return FF.router.overlay.registerChildren(r), r.render(), r.open(), this.listenToOnce(r, "modalViewClose", function() {
                return n.resolve()
            }), n.promise()
        },
        getIllustImagePathByKey: function(e) {
            return pUrl(sprintf("/dff/static/img/category/tutorial/func/%s/pic_1.png", e))
        },
        getIllustsImagePathByKey: function(e, t) {
            var n = [];
            for (var r = 1; r <= t; r++) n.push(sprintf("/dff/static/img/category/tutorial/func/%s/pic_" + r + ".png", e));
            return n
        }
    }, o)
}), define("scenes/common/views/ModalFriendInvitePrize", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase", "templates/common/ModalFriendInvitePrize", "templates/common/ModalFriendInvitePrizeEmpty"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: e.extend({}, i.prototype.events, {
            "anchorsbeforejump [data-app-present-box]": "onClickPresentBox"
        }),
        initialize: function(t) {
            t = t || {}, this.type = t.type, this.invitedNum = t.invitedNum;
            var n = this._getPrizeListFromItemPackages(t.prizeItemPackages),
                r = [];
            e.each(n, function(e) {
                r.push(e.item_id)
            }), this.prizeType = r.sort().join("_"), this.prizes = n
        },
        _getPrizeListFromItemPackages: function(t) {
            var n = this,
                i = [],
                s = {};
            return e.each(t, function(t) {
                e.each(t.items, function(e) {
                    var t;
                    s.hasOwnProperty(e.item_id) ? t = s[e.item_id] : (t = {
                        item_id: e.item_id,
                        num: 0,
                        label: n._getLabel(e.item_id)
                    }, s[e.item_id] = t, i.push(t)), t.num += e.num
                })
            }), e.each(i, function(e) {
                e.label = r(e.label, e.num)
            }), i
        },
        render: function() {
            var e = this.prizes && this.prizes.length ? s : o;
            this.putContent(e({
                type: this.type,
                invitedNum: this.invitedNum,
                prizes: this.prizes,
                prizeType: this.prizeType
            }))
        },
        onClickPresentBox: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        _getLabel: function(e) {
            switch (e) {
                case 91e6:
                    return FF.TextMaster.get("mithril_unit");
                case 92e6:
                    return FF.TextMaster.get("gil_unit");
                default:
                    return "%d"
            }
        }
    })
}), define("scenes/friend_invite/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        friendInviteGetDataDeferred: function() {
            return this.requestDeferred("/dff/friend_invite/", {})
        },
        friendInvitePostUrlDeferred: function(e, t, n) {
            return this.requestDeferred("/dff/friend_invite/post_url", {
                campaign_id: e,
                media: t,
                invite_id: n
            }, {
                type: "POST"
            })
        },
        friendInviteRegisterDeferred: function(e, t, n, r, i, s) {
            return this.requestDeferred("/dff/friend_invite/register", {
                guest_id: e,
                campaign_id: t,
                invite_id: n,
                t: r,
                media: i,
                hash: s
            }, {
                type: "POST"
            })
        },
        receivePrizeDeferred: function() {
            return this.requestDeferred("/dff/friend_invite/receive_prize", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/FriendInvitePrize", ["jquery", "underscore", "backbone", "scenes/common/views/ModalFriendInvitePrize", "scenes/friend_invite/Api"], function(e, t, n, r, i) {
    return {
        canReceive: function() {
            return FF.datastore.stash.canReceiveInviterPrize
        },
        canRegister: function() {
            return FF.datastore.stash.canRegisterFriendInvitation
        },
        registerAndOpenModalIfNeededDeferred: function(t) {
            var n = this,
                r = e.Deferred();
            return this.canRegister() ? (this._openExternalInviteSiteDeferred().then(this._fetchExternalInviteIdDeferred.bind(this)).then(this._registerDeferred).done(function(e) {
                if (!e && !t) {
                    r.resolve();
                    return
                }
                n._openModalDeferred({
                    type: "invitee",
                    inviteNum: 0,
                    prizeItemPackages: e
                }).done(function() {
                    r.resolve()
                })
            }), r.promise()) : t ? (n._openModalDeferred({
                type: "invitee",
                inviteNum: 0,
                prizeItemPackages: null
            }).done(function() {
                r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        _openExternalInviteSiteDeferred: function() {
            var r = e.Deferred(),
                i = {};
            t.extend(i, n.Events), i.listenToOnce(FF.router, "onApplicationForeground", function() {
                r.resolve()
            });
            var s = FF.Config.server.baseUrl + FF.Config.server.invitePathMap.register;
            return s += "?u=" + FF.datastore.userModel.id, s += "&h=" + FF.datastore.stash.userHash, kickmotor.platform.openExternalURL(s), r.promise()
        },
        _fetchExternalInviteIdDeferred: function() {
            var t = this,
                n = e.Deferred();
            return kickmotor.nativefn.getUrlSchemeLog(function(e) {
                var r = t._parseInviteQuery(e);
                n.resolve(r)
            }), n.promise()
        },
        _registerDeferred: function(t) {
            var n = e.Deferred(),
                r = !0;
            return FF.env.isWWRegion() && (r = kickmotor.nativefn.getAppVersion() >= 406), !t || !r ? n.resolve().promise() : (i.friendInviteRegisterDeferred(t.guestId, t.campaignId, t.inviteId, t.t, t.media, t.hash).done(function(e) {
                FF.datastore.stash.canRegisterFriendInvitation = !1;
                var t = e ? e.invite_prizes : null;
                n.resolve(t)
            }).fail(function(e, t, r) {
                n.resolve()
            }), n.promise())
        },
        _parseInviteQuery: function(e) {
            if (!e || !e.hasOwnProperty("query")) return null;
            var t = e.query,
                n = FF.Config.server.inviteSite,
                r = t[n.cookieCampaign],
                i = t[n.cookieMedia],
                s = t[n.cookieCode];
            if (s) {
                var o = s.split("-");
                if (o.length === 4) {
                    var u = o[0],
                        a = o[1],
                        f = o[2],
                        l = o[3];
                    return {
                        guestId: u,
                        campaignId: r,
                        inviteId: a,
                        t: f,
                        media: i,
                        hash: l
                    }
                }
            }
            return null
        },
        checkAndOpenModalIfNeededDeferred: function() {
            var t = this,
                n = e.Deferred(),
                r = e("[data-app-modal]").hasClass("open");
            return r || !this.canReceive() ? n.resolve().promise() : (i.receivePrizeDeferred().done(function(e) {
                FF.datastore.stash.canReceiveInviterPrize = !1;
                if (!e || !e.invited_num) {
                    FF.router.loading.hide(), n.resolve();
                    return
                }
                t._openModalDeferred({
                    type: "inviter",
                    invitedNum: e.invited_num,
                    prizeItemPackages: e.invite_prizes
                }).done(function() {
                    n.resolve()
                })
            }).fail(function() {
                FF.router.loading.hide(), n.resolve()
            }), n.promise())
        },
        _openModalDeferred: function(i) {
            var s = e.Deferred(),
                o = i.type,
                u = i.invitedNum,
                a = i.prizeItemPackages;
            this.modalView = new r({
                type: o,
                invitedNum: u,
                prizeItemPackages: a
            }), this.modalView.render(), FF.router.overlay.registerChildren(this.modalView), this.modalView.open(!0);
            var f = {};
            return t.extend(f, n.Events), f.listenToOnce(this.modalView, "closeAnimationEnd", function() {
                s.resolve()
            }), s.promise()
        }
    }
}), define("scenes/common/views/ModalExternalCollaboPrize", ["underscore", "jquery", "backbone", "sprintf", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: e.extend({}, i.prototype.events, {
            "anchorsbeforejump [data-app-external-bonus-received]": "onExternalBonusReceivedClick"
        }),
        initialize: function(e) {
            e = e || {}, this.id = e.campaignId, this.internalPrizes = e.internalPrizes
        },
        render: function() {
            var e = this;
            require(["templates/common/external_collabo/" + e.id + "_list"], function(t) {
                var n = t;
                e.putContent(n({
                    internalPrizes: e.internalPrizes
                }))
            })
        },
        onExternalBonusReceivedClick: function() {
            this.end()
        }
    })
}), define("scenes/external_collabo/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        receivePrizeDeferred: function(e, t) {
            return this.requestDeferred("/dff/external_collabo/receive_prize", {
                campaign_id: e,
                str: t
            }, {
                type: "POST"
            })
        },
        showPrizeListDeferred: function(e) {
            return this.requestDeferred("/dff/external_collabo/show_prize_list", {
                id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/ExternalCollaboPrize", ["jquery", "underscore", "backbone", "scenes/common/views/ModalExternalCollaboPrize", "scenes/external_collabo/Api"], function(e, t, n, r, i) {
    return {
        canReceived: function() {
            return FF.datastore.stash.canReceiveExternalCollaboPrize
        },
        receiveAndOpenModalIfNeededDeferred: function() {
            var t = this,
                n = e.Deferred();
            return this._fetchExternalInviteIdDeferred().then(this._receivePrizeDeferred).done(function(e) {
                t._openModalDeferred(e).done(function() {
                    n.resolve()
                })
            }), n.promise()
        },
        _fetchExternalInviteIdDeferred: function() {
            var t = this,
                n = e.Deferred();
            return kickmotor.nativefn.getUrlSchemeLog(function(e) {
                var r = t._parseExternalQuery(e);
                n.resolve(r)
            }), n.promise()
        },
        _receivePrizeDeferred: function(t) {
            var n = e.Deferred();
            return t ? (i.receivePrizeDeferred(t.campaignId, t.str).done(function(e) {
                FF.router.loading.hide(), n.resolve(e)
            }).fail(function() {
                FF.router.loading.hide(), n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        _parseExternalQuery: function(e) {
            if (!e || !e.hasOwnProperty("query")) return null;
            var t = e.query;
            return t.str && t.campaign_id ? {
                str: t.str,
                campaignId: t.campaign_id
            } : null
        },
        _openModalDeferred: function(i) {
            var s = this,
                o = e.Deferred();
            if (!i) return o.resolve().promise();
            if (!i.received) return o.resolve().promise();
            var u = i.campaign_id,
                a = i.internal_prizes,
                f = Object.keys(a).length;
            FF.datastore.stash.giftBoxNum += f, FF.datastore.stash.canReceiveExternalCollaboPrize = !1, this.modalView = new r({
                internalPrizes: a,
                campaignId: u
            }), this.modalView.render(), FF.router.overlay.registerChildren(this.modalView), this.modalView.open(!0);
            var l = {};
            return t.extend(l, n.Events), l.listenToOnce(this.modalView, "closeAnimationEnd", function() {
                o.resolve()
            }), o.promise()
        }
    }
}), define("scenes/notification/views/ModalNotificationDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/ImageWatcher", "components/Scrollbar", "components/TimeKeeper", "templates/notification/ModalNotificationDetail"], function(e, t, n, r, i, s, o, u, a) {
    var f = "ontouchend" in window,
        l = {
            st: f ? "touchstart" : "mousedown",
            mv: f ? "touchmove" : "mousemove",
            ed: f ? "touchend" : "mouseup",
            cc: f ? "touchcancel" : undefined,
            ck: "click"
        };
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-modal-back]": "onClickBack",
            "tap [data-app-external-url]": "onTapExternalLink",
            "tap [data-app-internal-url]": "onTapInternalLink"
        },
        linkElms: null,
        initialize: function(e) {
            this.notificationModel = e.notificationModel, this.isPopup = e.isPopup || !1, this.linkElms = [], r.prototype.initialize.call(this)
        },
        render: function() {
            var e = this;
            this.renderContent(a, {
                notificationModel: this.notificationModel,
                isPopup: this.isPopup
            }), this.setupImageWatcher(), this.listenToOnce(this.imageaWatcher, "allImagesAreCompleted someImagesAreCompleted", function() {
                e.setupComponents(), e.initializeTouchVariables(), e.setLinkElms(["[data-app-internal-url]", "[data-app-external-url]"]), e.addTouchBehavior(), e.notificationModel.set("is_new", !1)
            })
        },
        setupImageWatcher: function() {
            this.imageaWatcher = new s({
                isCrawlImgTag: !0
            })
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new i({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenTo(this.freescroll, "scrollchange", function() {
                e.initializeTouchVariables()
            })
        },
        setLinkElms: function(n) {
            var r = this;
            e.each(n, function(e) {
                var n = t(e);
                n.size() > 0 && r.linkElms.push(n)
            })
        },
        addTouchBehavior: function(n) {
            var r = this;
            if (this.linkElms.length === 0) return;
            this._isNativeScroll ? e.each(this.linkElms, function(e) {
                e.on(l.ck, function(e) {
                    t(this).trigger("tap", e)
                })
            }) : e.each(this.linkElms, function(e) {
                e.on(l.st, function(e) {
                    r.st(e)
                }).on(l.mv, function(e) {
                    r.mv(e)
                }).on(l.ed, function(e) {
                    r.ed(e)
                }), l.cc && e.on(l.cc, function(e) {
                    r.ed(e)
                })
            })
        },
        initializeTouchVariables: function() {
            this._isMoved = !1, this._isStarted = !1, this._startX = undefined, this._startY = undefined, this._diffX = 0, this._diffY = 0, this._validDistance = 10, this._isNativeScroll || (this._isNativeScroll = this.freescroll.getIsNativeScrollAvailable())
        },
        st: function(e) {
            var n = this.getAxis(e);
            this._isMoved = !1, this._isStarted = !0, this._startX = n.x, this._startY = n.y, t(e.target).on(l.ck, function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        mv: function(e) {
            if (this._isStarted) {
                var t = this.getAxis(e),
                    n = t.x,
                    r = t.y;
                if (this._validDistance < Math.abs(this._diffX) || this._validDistance < Math.abs(this._diffY)) this._isMoved = !0;
                this._diffX = n - this._startX, this._diffY = r - this._startY, e.preventDefault()
            }
        },
        ed: function(e) {
            var n = t(e.target);
            n.off(l.ck), this._isMoved || n.trigger("tap", e), this.initializeTouchVariables()
        },
        getAxis: function(e) {
            return {
                x: e.clientX || e.originalEvent.touches[0].clientX || undefined,
                y: e.clientY || e.originalEvent.touches[0].clientY || undefined
            }
        },
        _isInSameEventDungeon: function(e) {
            var t = FF.datastore.dungeonSessionModel.isInDungeon();
            if (!t) return !1;
            var n = new RegExp("#event/[0-9]+/"),
                r = n.test(e);
            if (!r) return !1;
            var i = FF.datastore.dungeonSessionModel.getWorldModel(),
                s = i.getEventId(),
                o = e.split("/"),
                u = +o[1];
            return s === u
        },
        _getBattleListFragment: function() {
            var e = FF.datastore.dungeonSessionModel.getWorldModel(),
                t = e.getEventId();
            return e.getBattleListFragment(t)
        },
        onTapExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            FF.SoundMgr.playChooseEffect(), this.openUrl(n)
        },
        onTapInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            this.end(), FF.SoundMgr.playChooseEffect(), r = this._isInSameEventDungeon(r) ? this._getBattleListFragment() : r, n.history.navigate(r, {
                trigger: !0
            })
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            this.end(!0), this.trigger("modalNotificationDetailBack")
        },
        onClickClose: function() {
            this.end(), this.trigger("modalNotificationDetailClose")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), e.each(this.linkElms, function(e) {
                e.off([l.st, l.mv, l.ed, l.cc, l.ck].join(" "))
            }), this.linkElms = null, r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/PopupNotification", ["jquery", "underscore", "backbone", "scenes/notification/views/ModalNotificationDetail", "scenes/notification/Api"], function(e, t, n, r, i) {
    return {
        showModalIfNeedPopupNotificationDeferred: function(t, s) {
            var o = e.Deferred(),
                u = FF.datastore.notificationCollection.forcePopupNotificationsByPlaceTypeAndPlaceValue(t, s);
            if (u.length >= 1) {
                var a = u[0],
                    f = new r({
                        notificationModel: a,
                        isPopup: !0
                    });
                f.render(), FF.router.overlay.registerChildren(f), n.Events.listenToOnce(f, "modalNotificationDetailBack", function() {
                    o.resolve(), f.end()
                }), n.Events.listenToOnce(f, "modalNotificationDetailClose", function() {
                    o.resolve()
                }), f.open(), a.isAlwaysPopupNotification() === !1 && (a.set("is_now_popup", !1), i.notificationMarkPopupedDeferred(a))
            } else o.resolve();
            return o.promise()
        }
    }
}), define("templates_ww/common/ModalContact", [], function() {
    return function(a) {
        a || (a = {});
        var b, __p = "",
            __e = _.escape;
        with(a) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">Customer Support</div></h1>\n        <div class="ml-b2 mr-b2 mb-b3 mt-b2">\n            <p class="mb-b2">Tap the "In-Game Purchases" and "Other Support" buttons below to contact customer support.<br>\nIf you need tips on playing the game, tap the "Game Help" button to view detailed information on various game features.</p>\n            <p>*Before contacting customer service, please have an email account set up on your mobile device. If you do not have an email account on your mobile device, customer service will not be able to assist you.</p>\n        </div>\n\n        <div class="box-c mb-b2">\n            <a class="c-btn is-main-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-modal-contact-help><span class="c-btn__inner">Game Help</span></a>\n        </div>\n        <div class="box-cb mb-b2">\n            <a class="c-btn is-sub-lead ml-b3" data-mbgaui-anchors data-app-sound="choose" data-app-modal-contact-money><span class="c-btn__inner">In-Game<br>Purchases</span></a>\n            <a class="c-btn is-sub-lead mr-b3" data-mbgaui-anchors data-app-modal-contact-general data-app-sound="choose"><span class="c-btn__inner">Other Support</span></a>\n        </div>\n        \n\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>\n';
        return __p
    }
}), define("ww/scenes/common/views/ModalContact", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "lib/TextMaster", "templates_ww/common/ModalContact"], function(e, t, n, r, i, s, o) {
    var u = {
        FR: "ffrk-fr-support@dena.com",
        ES: "ffrk-es-support@dena.com",
        EN: "ffrk-en-support@dena.com"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-contact-money]": "openContactMoney",
            "anchorsbeforejump [data-app-modal-contact-general]": "openContactGeneral",
            "anchorsbeforejump [data-app-modal-contact-help]": "openHelpBox",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this)
        },
        render: function() {
            this.putContent(o({}))
        },
        openContactMoney: function() {
            kickmotor.platform.launchMailer(s.getInstance().get("CSWW10000"), s.getInstance().get("CSWW10001"), this.getCSEmailAddress())
        },
        openContactGeneral: function() {
            kickmotor.platform.launchMailer(s.getInstance().get("CSWW10010"), s.getInstance().get("CSWW10011"), this.getCSEmailAddress())
        },
        getCSEmailAddress: function() {
            var e = FF.env.getLanguage();
            return e == "fr" ? u.FR : e == "es" ? u.ES : u.EN
        },
        openHelpBox: function() {
            n.history.navigate("#help/normal", {
                trigger: !0
            })
        },
        onClickClose: function() {
            this.close()
        }
    })
}), define("scenes/common/views/ModalReviewOffer", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "ww/scenes/common/views/ModalContact", "templates/common/ModalReviewOffer"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-open-mobage-feedback]": "openMobageFeedback",
            "anchorsbeforejump [data-app-modal-review]": "onClickReview",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            this.reviewId = e.reviewId, i.prototype.initialize.call(this)
        },
        render: function() {
            this.putContent(o({
                offersReward: !FF.env.isWWRegion()
            }))
        },
        onClickReview: function() {
            FF.router.loading.lock();
            var e = this,
                t = FF.Config.server.reviewUrlMap;
            r.reviewApplyDeferred(this.reviewId).done(function(n) {
                FF.datastore.userModel.set("can_review", !1);
                var r = void 0,
                    i = kickmotor.nativefn.getNativeOS();
                if (i === "ios") {
                    var s = kickmotor.nativefn.getSystemVersion();
                    s >= 7 ? r = t.ios7 : r = t.ios
                } else {
                    if (i !== "android") throw new Error("Unrecognized OS");
                    r = t.android
                }
                e.trigger("REVIEW_DONE"), e.close(), kickmotor.platform.openExternalURL(r)
            }).fail(function(t) {
                e.close()
            })
        },
        openMobageFeedback: function() {
            if (FF.env.isWWRegion()) {
                FF.router.loading.lock();
                var e = new s({});
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else this.openUrl(FF.Config.server.externalUrls.feedback)
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickClose: function() {
            this.close()
        }
    })
}), define("scenes/notification/views/ModalNotification", ["underscore", "jquery", "backbone", "scenes/notification/Api", "lib/ModalBase", "./ModalNotificationDetail", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar", "templates/notification/ModalNotification"], function(e, t, n, r, i, s, o, u, a, f) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-notification-id]": "onClickDetail"
        },
        initialize: function() {
            this.notificationCollection = FF.datastore.notificationCollection, i.prototype.initialize.call(this)
        },
        render: function(e) {
            this.renderContent(f, {
                notificationCollection: this.notificationCollection.sort()
            })
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll-for-modal]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar-for-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        open: function() {
            i.prototype.open.apply(this, arguments), this.setupComponents()
        },
        checkedAllDeferred: function() {
            return this.notificationCollection.uncheckedNum() === 0 ? t.Deferred().resolve().promise() : (this.notificationCollection.checked(), t(document).trigger("updateBadge"), r.notificationCheckDeferred())
        },
        onClickClose: function() {
            this.end(), this.trigger("onClickClose")
        },
        onClickDetail: function(e) {
            FF.router.loading.lock();
            var t = +e.target.getAttribute("data-app-notification-id"),
                n = this.notificationCollection.get(t);
            this.detailModal = new s({
                notificationModel: n
            }), this.detailModal.render(), FF.router.overlay.registerChildren(this.detailModal), this.listenToOnce(this.detailModal, "modalNotificationDetailBack", this.reopenSelf), this.listenToOnce(this.detailModal, "modalNotificationDetailClose", this.detailClose), this.detailModal.open(), FF.env.isWWRegion() && FF.router.loading.unlock()
        },
        reopenSelf: function() {
            this.detailModal = null, this.render(), this.open()
        },
        detailClose: function() {
            this.trigger("modalNotificationClose"), this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/ab/misc/ABLayerFactory", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/ClassBase"], function(e, t, n, r, i, s, o) {
    var u = o.extend({
        initialize: function(e, t) {
            this._assetIdList = e, this._assets = t, this._assetsManager = new s, this._layers = {}
        },
        createLayersDeferred: function(e, n) {
            var r = this,
                i = t.Deferred();
            return this._assetsManager.populateAssetsDeferred(this._assets, {
                isVisible: !e,
                retryDialog: !n
            }).then(function() {
                r._createLayers(), i.resolve()
            }).fail(function() {
                i.reject()
            }), i.promise()
        },
        _createLayers: function() {
            var t = this;
            e.each(this._assetIdList, function(e, n) {
                var i = t._assetsManager.getLayerNameByAssetId(e),
                    s = t._layers[e] = new r({
                        layerName: i
                    });
                s.activate()
            })
        },
        getLayerByAssetId: function(e) {
            return this._layers[e]
        },
        getLayerAll: function() {
            var t = [];
            return e.each(this._layers, function(e, n) {
                t.push({
                    assetId: n,
                    layer: e
                })
            }), t
        },
        setAllLayerVisible: function(t) {
            e.each(this.getLayerAll(), function(e) {
                e.layer.setVisible(t).process()
            })
        },
        getAssetManager: function() {
            return this._assetsManager
        },
        destroyAllLayer: function() {
            this.getAssetManager().destroyAllLayer()
        },
        dispose: function() {
            this._assets = void 0, this._assetIdList = void 0, this._layers = void 0
        }
    });
    return u
}), define("scenes/progress_map/LatestProgressData", ["lib/Storage"], function(e) {
    var t = {
        DUNGEON: "latest_dungeon_data",
        CAN_RETURN: "can_return_progress_map"
    };
    return {
        saveCanReturnDeferred: function(n) {
            var r = this,
                i = $.Deferred(),
                s = {
                    canReturn: n
                };
            return e.setItemDeferred(t.CAN_RETURN, JSON.stringify(s)).then(function(e) {
                i.resolve()
            }), i.promise()
        },
        saveDungeonDataByModelsDeferred: function(e, t) {
            if (e.isNormalWorld()) {
                var n = t.get("id"),
                    r = t.isForce(),
                    i = t.get("progress_map_level");
                return r ? this.saveDungeonDataDeferred(void 0, n, i, !0) : this.saveDungeonDataDeferred(n, void 0, i, !1)
            }
            return $.Deferred().resolve().promise()
        },
        saveDungeonDataDeferred: function(n, r, i, s) {
            var o = $.Deferred(),
                u = {
                    level: i,
                    dungeonId: void 0,
                    normalDungeonId: n,
                    forceDungeonId: r,
                    isForce: s
                };
            return e.setItemDeferred(t.DUNGEON, JSON.stringify(u)).then(function(e) {
                o.resolve()
            }), o.promise()
        },
        getCanReturnDeferred: function() {
            var n = this,
                r = $.Deferred();
            return e.getItemDeferred(t.CAN_RETURN).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {};
                r.resolve(t)
            }), r.promise()
        },
        getDungeonDataDeferred: function() {
            var n = this,
                r = $.Deferred();
            return e.getItemDeferred(t.DUNGEON).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {};
                r.resolve(t)
            }), r.promise()
        }
    }
}), define("scenes/common/ab/misc/ABViewUtil", ["underscore", "jquery", "sprintf", "backbone", "lib/ClassBase", "lib/ab/ABNode"], function(e, t, n, r, i, s) {
    var o = {
            MIN_DRAG_DISTANCE: 100,
            NORMAL_SCREEN_HEIGHT: 480
        },
        u = i.extend({}, {
            isDragTap: function(e) {
                var t = e.beganSX - e.screenX,
                    n = e.beganSY - e.screenY,
                    r = t * t + n * n;
                return r > o.MIN_DRAG_DISTANCE
            },
            isScreenHeightNarrow: function() {
                return kickmotor.nativefn.getLogicalScreenHeight() === o.NORMAL_SCREEN_HEIGHT
            },
            duplicateABNode: function(e, t, n, r, i, o) {
                return new s({
                    name: r,
                    layer: e,
                    duplicateFrom: t,
                    duplicateFromOptions: {
                        visualParentLayer: n,
                        visualParentNode: i,
                        visualParentTopNode: o
                    }
                })
            }
        });
    return u
}), define("scenes/common/ab/view/ABViewBase", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/EventBase"], function(e, t, n, r, i, s) {
    var o = 0,
        u = s.extend({
            initialize: function(e, t) {
                this.name = e, this._instanceId = this.name + "_" + ++o, this._ab = {}, this._tagState = {}, this._layer = t, this._topNodeShown = !0, this._topNode = this._drawView(), this._topNodePosition = {
                    x: void 0,
                    y: void 0
                }, this._flush()
            },
            dispose: function() {
                e.each(this.ab, function(e) {
                    e.deleteNode()
                }), this._flush(), this._ab = void 0, this._topNode = void 0, this._layer = void 0, this._isDisposed = !0, this.stopListening()
            },
            toString: function() {
                return "[ABView:" + this._instanceId + "]"
            },
            _drawView: function() {
                return FF.logger.warn("override this function"), void 0
            },
            _flush: function() {
                var t = [];
                e.each(this._ab, function(e) {
                    e && e.stream && (t = t.concat(e.stream), e.stream = [])
                }), t.length && kickmotor.animation.processAnimation(t)
            },
            getLayer: function() {
                return this._layer
            },
            getLayerName: function() {
                return this._layer ? this._layer.layerName : void 0
            },
            showTopNode: function() {
                this._topNode && (this._topNode.setVisible(!0), this._topNode.process(), this._topNodeShown = !0)
            },
            hideTopNode: function() {
                this._topNode && (this._topNode.setVisible(!1), this._topNode.process(), this._topNodeShown = !1)
            },
            isTopNodeShown: function() {
                return this._topNodeShown
            },
            setTopNodePosition: function(e, t) {
                this._topNode && (this._topNode.setPosition([e, t]).process(), this._topNodePosition.x = e, this._topNodePosition.y = t)
            },
            getTopNodePosition: function() {
                return this._topNodePosition
            },
            setTopNodeScale: function(e) {
                this._topNode && this._topNode.setScale([e, e]).process()
            },
            setTopNodeAlpha: function(e) {
                this._topNode && this._topNode.setAlpha(e).process()
            },
            setLayerZOrder: function(e) {
                var t = this.getLayer();
                t && t.setZOrder(e).process()
            },
            setTopNodeDepth: function(e) {
                this._topNode && this._topNode.setZOrder(e)
            },
            setTouchEnabled: function(e) {
                if (this._touchEnabled === e) return;
                this._touchEnabled = e, this._updateTouchEnabled()
            },
            _updateTouchEnabled: function() {
                FF.logger.warn("override this function")
            },
            isTouchEnabled: function() {
                return this._touchEnabled
            },
            _playTag: function(e, t, n, r) {
                if (!n && this._tagState[e] === t) return;
                this._tagState[e.name] = t, e.play(t, r)
            },
            executeAfter: function(e, t, n) {
                var r = this;
                setTimeout(function() {
                    r._isDisposed || (n ? e.call(n) : e())
                }, t)
            },
            waitDeferred: function(e) {
                var n = this,
                    r = t.Deferred();
                return e === void 0 || e <= 0 ? r.resolve().promise() : (setTimeout(function() {
                    n._isDisposed ? r.reject() : r.resolve()
                }, e), r.promise())
            }
        });
    return u
}), define("scenes/home/ab/views/BannerABView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase"], function(e, t, n, r, i, s, o) {
    var u = {
            BANNER_SELECTED: "banner_selected",
            BANNER_ANIMATION_END: "banner_animation_end"
        },
        a = {
            MAIN: "btn_%s_banner",
            BTN: "btn_%s_banner_visible_touch",
            IMG1: "btn_%s_banner_img",
            IMG2: "btn_%s_banner_add_img"
        },
        f = {
            TOUCH: "btn_touch"
        },
        l = {
            OPEN: "banner_open",
            LOOP: "banner_loop",
            CLOSE: "banner_close"
        },
        c = {
            BANNER_REPLACE_MILLISEC: 7500
        },
        h = o.extend({
            initialize: function(e, t, n) {
                this._bannerIndex = n, o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this._clearInterval(), this._btn.dispose(), this._btn = void 0, this._models = void 0, this._assetManager = void 0, o.prototype.dispose.apply(this)
            },
            _clearInterval: function() {
                this._iid !== void 0 && (clearInterval(this._iid), this._iid = void 0)
            },
            _drawView: function() {
                var e = this;
                return this._ab.main = (new i({
                    name: r(a.MAIN, this._bannerIndex),
                    layer: this.getLayerName()
                })).setVisible(!1), this._btn = new s(this._ab.main, this._ab.main.name, void 0), this._btn.setButtonStateTags(void 0, f.TOUCH, void 0), this._btn.setTouchHandler(function(t, n) {
                    e.trigger(u.BANNER_SELECTED, e)
                }), this._btn.setTouchHandlerAfterAnimation(function(t, n) {
                    e.trigger(u.BANNER_ANIMATION_END, e)
                }), this._ab.main
            },
            applyBannerModels: function(e, t) {
                this._models = e, this._assetManager = t
            },
            getCurrentBannerModel: function() {
                return this._models[this._currentBannerIndex]
            },
            stopBannerTransition: function() {
                this._clearInterval(), this.setTouchEnabled(!1)
            },
            restartBannerTransition: function() {
                this.startBannerTransition(), this.setTouchEnabled(!0)
            },
            startBannerTransition: function() {
                if (!this._models || this._models.length === 0) return;
                var e = this;
                this._currentBannerIndex = -1, this._clearInterval(), this._nextBanner(), this._clearInterval(), this._models.length > 1 && (this._iid = setInterval(function() {
                    e._playBannerAnimDeferred(l.CLOSE).then(function() {
                        if (e._isDisposed) return;
                        e._nextBanner()
                    })
                }, c.BANNER_REPLACE_MILLISEC))
            },
            _nextBanner: function() {
                var e = this;
                this._currentBannerIndex = (this._currentBannerIndex + 1) % this._models.length;
                var t = this.getCurrentBannerModel();
                if (t) {
                    var n = r("banner-%s", t.get("id")),
                        i = this._assetManager.getAssetInfo(n);
                    this._ab.main.loadBundle(i.bundle).setImage(r(a.IMG1, this._bannerIndex), i.assetPath).setImage(r(a.IMG2, this._bannerIndex), i.assetPath).process()
                }
                this._playBannerAnimDeferred(l.OPEN).then(function() {
                    if (e._isDisposed) return;
                    e._playBannerAnimDeferred(l.LOOP)
                })
            },
            _playBannerAnimDeferred: function(e, t) {
                return this._ab.main.setVisible(!0).play(e, t).processDeferred("action_stop")
            },
            _updateTouchEnabled: function() {
                this._btn && this._btn.setEnabled(this.isTouchEnabled())
            }
        }, {
            EVENTS: u
        });
    return h
}), define("scenes/home/ab/views/HomeABView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/misc/ABViewUtil", "scenes/common/ab/view/ABViewBase", "./BannerABView", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = {
            LINK_SELECTED: "link_selected",
            LINK_ANIMATION_END: "link_animation_end"
        },
        c = {
            NORMAL: "pos_0",
            S16X9: "pos_1"
        },
        h = {
            NORMAL: "normal",
            EVENT: "event",
            TOUGH: "tough",
            TOUGH_DISABLED: "tough_disabled"
        },
        p = {
            INIT: "open",
            OPEN: "btn_open",
            LOOP: "btn_loop",
            CLOSE: "btn_close",
            TOUCH: "btn_touch",
            TOUCH_TOUGH: "btn_touch_btn2",
            SORTIE: "btn_sortie",
            SORTIE_LOOP: "btn_sortie_loop"
        },
        d = {
            INIT: "open",
            LOOP: "chara_move_loop",
            MOVE_TO_NORMAL: "chara_move_01",
            MOVE_TO_EVENT: "chara_move_02",
            MOVE_TO_TOUGH: "chara_move_03",
            SORTIE_NORMAL: "chara_move_10",
            SORTIE_EVENT: "chara_move_20",
            SORTIE_TOUGH: "chara_move_30"
        },
        v = 5,
        m = u.extend({
            initialize: function(e, t, n, r, i, s) {
                this._btns = [], this._characterHolders = [], this._charNodes = [], this._banners = [], this._playerLayer = n, this._assetManager = r, this._normalBanners = i, this._eventBanners = s, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                e.each(this._btns, function(e) {
                    e.dispose()
                }), e.each(this._banners, function(e) {
                    e.dispose()
                }), this._banners = void 0, this._btns = void 0, this._characterHolders = void 0, this._charNodes = void 0, this._playerLayer.destroyLayer(), this._playerLayer = void 0, this._assetManager = void 0, this._normalBanners = void 0, this._eventBanners = void 0, this._btn0EfectNodes = void 0, this._btn1EfectNodes = void 0, this._btn2EfectNodes = void 0, this._allBtnEffettNodes = void 0, this._lastAssetInfo = void 0, u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                this._ab.main = new i({
                    name: "display_center",
                    layer: this.getLayerName()
                }), this._ab.main.setVisible(!1).process(), this._ab.characters = this._ab.main.createChildNode("character"), this._ab.btn0 = this._ab.main.createChildNode("btn_0"), this._ab.btn0Effect0 = this._ab.btn0.createChildNode("btn_0_bg_effects_particle"), this._ab.btn0Effect1 = this._ab.btn0.createChildNode("btn_0_circle_rotate"), this._ab.btn0Effect2 = this._ab.btn0.createChildNode("btn_0_front_lp_particle"), this._ab.btn0Sortie = this._ab.btn0.createChildNode("btn_0_sortie"), this._ab.btn0Anim = this._ab.btn0.createChildNode("btn_0_anm"), this._btn0EfectNodes = [this._ab.btn0Effect0, this._ab.btn0Effect1, this._ab.btn0Effect2], this._ab.btn1 = this._ab.main.createChildNode("btn_1"), this._ab.btn1Effect0 = this._ab.btn1.createChildNode("btn_1_bg_effects_particle"), this._ab.btn1Effect1 = this._ab.btn1.createChildNode("btn_1_circle_rotate"), this._ab.btn1Effect2 = this._ab.btn1.createChildNode("btn_1_front_lp_particle"), this._ab.btn1Sortie = this._ab.btn1.createChildNode("btn_1_sortie"), this._ab.btn1Anim = this._ab.btn1.createChildNode("btn_1_anm"), this._btn1EfectNodes = [this._ab.btn1Effect0, this._ab.btn1Effect1, this._ab.btn1Effect2], this._ab.btn2 = this._ab.main.createChildNode("btn_2"), this._ab.btn2Effect0 = this._ab.btn2.createChildNode("btn_2_bg_effects_particle"), this._ab.btn2Effect1 = this._ab.btn2.createChildNode("btn_2_circle_rotate"), this._ab.btn2Effect2 = this._ab.btn2.createChildNode("btn_2_front_lp_particle"), this._ab.btn2Sortie = this._ab.btn2.createChildNode("btn_2_sortie"), this._ab.btn2Anim = this._ab.btn2.createChildNode("btn_2_anm"), this._btn2EfectNodes = [this._ab.btn2Effect0, this._ab.btn2Effect1, this._ab.btn2Effect2], this._ab.btn2FrontEffects = this._ab.btn2.createChildNode("btn_2_front_effects").setVisible(!0).process(), this._ab.btn2Circle = this._ab.btn2.createChildNode("btn_2_circle"), this._ab.btn2BackTouch = this._ab.btn2.createChildNode("btn_2_back_touch_particle_01"), this._btn2SpecialNodes = [this._ab.btn2FrontEffects, this._ab.btn2Circle, this._ab.btn2BackTouch], this._ab.btn2Disabled = this._ab.main.createChildNode("btn_2_disable"), f.isReleasedExtremeDungeons() || (this._ab.main.setVisibleByNode("btn_2", !1), this._ab.main.setVisibleByNode("btn_2_coming_soon", !0)), this._allBtnEffettNodes = [], this._allBtnEffettNodes = this._allBtnEffettNodes.concat(this._btn0EfectNodes), this._allBtnEffettNodes = this._allBtnEffettNodes.concat(this._btn1EfectNodes), this._allBtnEffettNodes = this._allBtnEffettNodes.concat(this._btn2EfectNodes);
                var e;
                e = this._createButton(this._ab.btn0, "btn_0_visible_touch", h.NORMAL), this._btns.push(e), e = this._createButton(this._ab.btn1, "btn_1_visible_touch", h.EVENT), this._btns.push(e), e = this._createButton(this._ab.btn2, "btn_2_visible_touch", h.TOUGH), this._btns.push(e), e = this._createButton(this._ab.btn2Disabled, "btn_2_disable_visible_touch", h.TOUGH_DISABLED), e.setEnabled(!1), this._btns.push(e), this._initBanners();
                var t = {};
                for (var n = 0; n < v; n++) {
                    var s = this._ab.main.createChildNode(r("chara_%s", n));
                    this._characterHolders[n] = s, t[r("charaLayer%s", n)] = this._playerLayer.layerName, t[r("charaTopNode%s", n)] = s.name, t[r("charaSprite%s", n)] = "sprite_character_base"
                }
                return this._ab.main.setParam(t), this._ab.main
            },
            _createButton: function(t, n, r) {
                var i = new s(t, void 0, void 0, n);
                i.setTouchHandler(e.bind(this._handleBtnTouch, this));
                var o = p.TOUCH;
                return t.name === "btn_2" && (o = p.TOUCH_TOUGH, this._playNodes(this._btn2SpecialNodes, o)), t.name === "btn_2_disable" && !f.isReleasedExtremeDungeons() && (o = void 0), i.setButtonStateTags(void 0, o, void 0), i.ignoreTouchDuringTouchEndAnimation(), i.ignoreFrequentlyTouch(1e3), i.userOption = r, i
            },
            _handleBtnTouch: function(e, t) {
                var n = e.userOption;
                if (n === h.TOUGH_DISABLED && !f.isReleasedExtremeDungeons()) return;
                n !== h.TOUGH_DISABLED && this._setUIDeActive(), this._playSelectedContentAnimation(n, void 0)
            },
            _initBanners: function() {
                this._banners.push(this._createBanner(0, h.NORMAL, this._normalBanners)), this._banners.push(this._createBanner(1, h.EVENT, this._eventBanners)), this._createBanner(2, h.TOUGH, [])
            },
            _createBanner: function(e, t, n) {
                var r = this,
                    i = new a("banner" + e, this.getLayer(), e);
                return i.applyBannerModels(n, this._assetManager), this.listenTo(i, a.EVENTS.BANNER_SELECTED, function(e) {
                    FF.logger.debug("banner selected", e.name), r._setUIDeActive()
                }), this.listenTo(i, a.EVENTS.BANNER_ANIMATION_END, function(e) {
                    FF.logger.debug("animation end");
                    var n = e.getCurrentBannerModel();
                    r._playSelectedContentAnimation(t, n)
                }), i
            },
            _startBanners: function(t) {
                var n = this;
                this.executeAfter(function() {
                    e.each(n._banners, function(e) {
                        e.startBannerTransition()
                    })
                }, t)
            },
            _setUIDeActive: function() {
                this._stopBannerTransition(), this.setTouchEnabled(!1)
            },
            _setUIActiveAgain: function() {
                this._restartBannerTransition(), this.setTouchEnabled(!0)
            },
            _stopBannerTransition: function() {
                e.each(this._banners, function(e) {
                    e.stopBannerTransition()
                })
            },
            _restartBannerTransition: function() {
                e.each(this._banners, function(e) {
                    e.restartBannerTransition()
                })
            },
            _playSelectedContentAnimation: function(e, t) {
                var n = this,
                    r;
                switch (e) {
                    case h.NORMAL:
                        r = d.MOVE_TO_NORMAL;
                        break;
                    case h.EVENT:
                        r = d.MOVE_TO_EVENT;
                        break;
                    case h.TOUGH:
                        r = d.MOVE_TO_TOUGH;
                        break;
                    case h.TOUGH_DISABLED:
                        r = d.MOVE_TO_TOUGH
                }
                this._triggerSelectedEvent(e, t), r ? this._isSortie || e === h.TOUGH_DISABLED ? this.waitDeferred(300).then(function() {
                    n._triggerSelectedAnimationEndEvent(e, t)
                }) : this._playCharacterAnimDeferred(r).then(function() {
                    if (n._isDisposed) return;
                    n._triggerSelectedAnimationEndEvent(e, t)
                }) : this._triggerSelectedAnimationEndEvent(e, t)
            },
            _triggerSelectedEvent: function(e, t) {
                this.trigger(l.LINK_SELECTED, e, t)
            },
            _triggerSelectedAnimationEndEvent: function(e, t) {
                this.trigger(l.LINK_ANIMATION_END, e, t)
            },
            _playMainNodeAnimDeferred: function(e, t) {
                return t = t || {}, this._ab.main.play(e, t).processDeferred("action_stop")
            },
            _playCharacterAnimDeferred: function(e) {
                return this._ab.characters.play(e, {
                    autoRemove: !1
                }).processDeferred("action_stop")
            },
            _playNodes: function(t, n, r) {
                r = r || {}, e.each(t, function(e) {
                    e.play(n, r)
                })
            },
            _updateTouchEnabled: function() {
                var t = this.isTouchEnabled();
                FF.logger.debug("enabled", t), e.each(this._btns, function(e) {
                    e.setEnabled(t)
                })
            },
            _updateViewByScreenHeight: function() {
                var e;
                o.isScreenHeightNarrow() ? e = c.NORMAL : e = c.S16X9, this._ab.main.play(e, {
                    autoRemove: !1
                })
            },
            playInitialAnimation: function() {
                var e = this;
                this._isSortie ? this._playSortieCharacterAnimationDeferred() : this._playCharacterAnimDeferred(d.INIT), this._playMainNodeAnimDeferred(d.INIT).then(function() {
                    if (e._isDisposed) return;
                    e._isSortie ? (e._changeSortieBtn(2500), e._playSortieCharacterAnimationDeferred(1e3)) : e._playCharacterAnimDeferred(d.LOOP), e._startBanners(50)
                }), this._updateViewByScreenHeight(), this._playNodes(this._allBtnEffettNodes, p.LOOP), this._initBtns(!0), this._flush()
            },
            startWithoutInitialAnimation: function() {
                this._updateViewByScreenHeight(), this._playNodes(this._allBtnEffettNodes, p.LOOP), this._startBanners(1), this._initBtns(!1), this._isSortie ? (this._changeSortieBtn(2500), this._playSortieCharacterAnimationDeferred()) : this._playCharacterAnimDeferred(d.LOOP), this._flush()
            },
            _initBtns: function(t) {
                var n = t ? 1 : 999;
                e.each(this._btns, function(e) {
                    var t = e.isEnabled() ? p.INIT : p.CLOSE;
                    e.baseNode.play(t, {
                        isPlayChild: !1,
                        speed: n
                    })
                })
            },
            _changeSortieBtn: function(e) {
                var t = this,
                    n = function(n) {
                        n.play(p.SORTIE).setVisible(!0).processDeferred("action_stop", {
                            tag: p.SORTIE
                        }).then(function() {
                            t.executeAfter(function() {
                                n.play(p.SORTIE_LOOP).process()
                            }, e)
                        })
                    };
                this._isExtremeWorld ? n(this._ab.btn2Sortie) : this._isEventWorld ? n(this._ab.btn1Sortie) : n(this._ab.btn0Sortie)
            },
            _playSortieCharacterAnimationDeferred: function(e) {
                var t = this,
                    n = this._getSortieTag();
                return this.waitDeferred(e).then(function() {
                    return t._playCharacterAnimDeferred(n)
                })
            },
            _getSortieTag: function() {
                return this._isExtremeWorld ? d.SORTIE_TOUGH : this._isEventWorld ? d.SORTIE_EVENT : d.SORTIE_NORMAL
            },
            insertCharacter: function(e, t, n) {
                FF.logger.debug("insertCharacter", e, t);
                var r = this._index2slotNum(e),
                    s = this._characterHolders[r];
                if (!s || !t) return;
                var o = (new i({
                    name: s.name,
                    layer: this._playerLayer.layerName,
                    duplicateFrom: "character_nul",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: s.name,
                        visualParentTopNode: this._ab.main.name
                    }
                })).setParam({
                    color_change_parent: s.name
                }).loadBundle(t.bundle).setSpriteAnimeByNode("sprite_character_base", t.assetPath).setSpriteAnimeByNode("sprite_character_add", t.assetPath).setVisible(!n).process();
                o.createChildNode("shadow_nul").setVisible(!1).process(), this._charNodes[e] = o, this._lastAssetInfo = t
            },
            fillEmptyCharacters: function() {
                var e = this._lastAssetInfo;
                if (!e) return;
                var t = v;
                while (t--)
                    if (this._charNodes[t] === void 0) {
                        this.insertCharacter(t, e, !0);
                        var n = this._index2slotNum(t),
                            i = r("shadow_%02d", n);
                        this._ab.characters.createChildNode(i).setVisible(!1).process()
                    }
            },
            _index2slotNum: function(e) {
                return v - e - 1
            },
            changeSortie: function(e) {
                this._isSortie = !0, this._isEventWorld = e.isInEventDungeon, this._isExtremeWorld = e.isInExtremeDungeon
            },
            setContentDisabled: function(e) {
                var t, n = this._btns.length;
                while (n--) {
                    var i = this._btns[n];
                    if (i.userOption === e) {
                        t = i;
                        break
                    }
                }
                if (t) {
                    var s = this._ab[r("btn%sAnim", n)];
                    s.play(p.CLOSE, {
                        isPlayChild: !0
                    }).process(), s = this._ab[r("btn%sSortie", n)], s.setVisible(!1).process(), s = this._ab[r("btn%s", n)], s.setVisibleByNode(r("btn_%s_bg_effects", n), !1).setVisibleByNode(r("btn_%s_circle", n), !1).process(), t.setEnabled(!1);
                    if (t.userOption === h.TOUGH) {
                        var i = this._btns[n + 1];
                        i.setEnabled(!0), s.setVisibleByNode("btn_2_circle", !1), s.setVisibleByNode("btn_2_back_touch_particle_01", !1), s.setVisibleByNode("btn_2_objects", !1), s.setVisibleByNode("btn_2_front_effects", !1)
                    }
                }
            },
            showHomeABView: function() {
                this.showTopNode()
            },
            hideHomeABView: function() {
                this.hideTopNode()
            },
            isHomeABViewShown: function() {
                return this.isTopNodeShown()
            }
        }, {
            EVENTS: l,
            CONTENTS: h
        });
    return m
}), define("scenes/common/views/Banner", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/collections/Banner", "components/Button", "components/Carousel", "components/Indicator", "templates/common/Banner"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        CAROUSEL_RENDER_LOT: 2
    };
    return n.View.extend({
        initialize: function(e) {
            var t = e.displayType || FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_TOP,
                n = FF.datastore.bannerCollection.where({
                    display_type: t
                });
            this.bannerCollection = new i(n)
        },
        render: function() {
            t("[data-app-carousel-components-wrap]").empty(), t("[data-app-carousel-components-wrap]").append(r.process(a, {
                bannerModels: this.bannerCollection.getOpened(),
                lot: f.CAROUSEL_RENDER_LOT
            })), this.addTouchEvent(), this.setupComponents()
        },
        setupComponents: function() {
            this.prevBtn = new s({
                el: t("#prev"),
                message: -1
            }), this.nextBtn = new s({
                el: t("#next"),
                message: 1
            }), this.carousel = new o({
                el: t("[data-ui-carousel]"),
                direction: 0,
                btnPrev: this.prevBtn,
                btnNext: this.nextBtn,
                autoPlay: !0,
                isLoop: !0
            }), this.indicator = new u({
                el: t("[data-ui-indicator]"),
                className: "is-active",
                watch: this.carousel
            })
        },
        addTouchEvent: function() {
            t("[data-app-carousel-item]").on("anchorsbeforejump", this.onClickCarouselItem.bind(this))
        },
        removeTouchEvent: function() {
            t("[data-app-carousel-item]").off("anchorsbeforejump")
        },
        onClickCarouselItem: function(e) {
            var r = t(e.target).attr("data-app-carousel-item"),
                i = this.bannerCollection.get(r),
                s = i.get("url"),
                o = i.get("link_type");
            switch (o) {
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.NAVIGATE:
                    n.history.navigate(s, {
                        trigger: !0
                    });
                    break;
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.EXTERNAL:
                    kickmotor.platform.canOpenExternalURL(s, function(e) {
                        if (!e.canOpen) throw new Error("invalid url(" + s + ") value.");
                        kickmotor.platform.openExternalURL(s)
                    });
                    break;
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.REVIEW:
                    this.trigger("REVIEW_MODAL");
                    break;
                case FF.CONST.SERVER.BANNER.LINK_TYPE_OF.NOTIFICATION:
                    this.trigger("NOTIFICATION_MODAL", s);
                    break;
                default:
                    throw new Error("invalid link_type(" + o + ") value")
            }
        },
        dispose: function() {
            this.prevBtn && this.prevBtn.dispose(), this.nextBtn && this.nextBtn.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose(), this.bannerCollection && this.bannerCollection.stopListening(), this.removeTouchEvent(), this.$el.empty(), this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/home/views/Banner", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/Banner", "scenes/common/collections/Banner", "templates/home/Banner"], function(e, t, n, r, i, s, o) {
    var u = {
        CAROUSEL_RENDER_LOT: 1,
        COMPONENTS_WRAP_CLASS: "[data-app-carousel-components-wrap]"
    };
    return i.extend({
        initialize: function() {
            var e = FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_TOP,
                t = FF.datastore.bannerCollection.where({
                    display_type: e
                });
            this.bannerCollection = new s(t)
        },
        render: function() {
            t(u.COMPONENTS_WRAP_CLASS).empty(), t(u.COMPONENTS_WRAP_CLASS).append(r.process(o, {
                bannerModels: this.bannerCollection.getOpened(),
                LOT: u.CAROUSEL_RENDER_LOT
            })), this.addTouchEvent(), this.setupComponents()
        },
        activate: function() {
            this.carousel.activateTimer()
        },
        deactivate: function() {
            this.carousel.deactivateTimer()
        }
    })
}), define("scenes/home/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/TextMaster", "sprintf", "scenes/common/helper/FriendInvitePrize", "scenes/common/helper/ExternalCollaboPrize", "scenes/common/helper/MissionHelper", "scenes/common/helper/FuncTutorial", "scenes/common/helper/ExtremeEventHelper", "scenes/common/helper/PopupNotification", "scenes/common/views/ModalExtremeWorldOutOfPeriod", "scenes/common/views/ModalReviewOffer", "scenes/notification/views/ModalNotificationDetail", "scenes/notification/views/ModalNotification", "scenes/common/ab/misc/ABLayerFactory", "scenes/progress_map/LatestProgressData", "../ab/views/HomeABView", "util", "./Banner", "templates/home/Home"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E) {
    var S = {
            MYPAGE: "home_common",
            PLAYER_COMMON: "player_common"
        },
        x = {
            ACHIEVE_TYPE_NAMES: ["ABILITY_GENERATE", "ABILITY_UPGRADE", "BUDDY_LEVEL", "CLEAR_DUNGEON", "ENHANCE", "EVOLVE", "FRIEND_INVITE", "GACHA", "GET_ITEM"]
        },
        T = !1;
    return r.extend({
        categoryType: "home",
        contentType: "HOME",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-global-menu]": "onClickMenu",
            "anchorsbeforejump [data-app-mission]": "onClickMission",
            "anchorsbeforejump [data-app-real-incentive-mission]": "onClickRealIncentiveMission",
            "anchorsbeforejump [data-app-achievement-room]": "onClickAchievementRoom",
            "anchorsbeforejump [data-app-open-notification]": "openNotification",
            "anchorsbeforejump [data-app-open-giftbox]": "openGiftBox",
            "anchorsbeforejump [data-app-open-friend]": "openFriend",
            "anchorsbeforejump [data-app-sub-navi-shadow]": "toggleSubNavi",
            "anchorsbeforejump #otherRoom": "toggleSubNavi",
            "anchorsbeforejump [data-app-ritual-room]": "onClickRitualRoom",
            "anchorsbeforejump [data-app-world]": "openWorldDevelop",
            "anchorsbeforejump [data-app-events]": "openEventsDevelop"
        },
        initialize: function(e) {
            var t = this;
            this.bannerView = new w, this.dungeonSessionModel = FF.datastore.dungeonSessionModel, r.prototype.initialize.call(this), this.listenTo(this.bannerView, "REVIEW_MODAL", this.openReviewOffer), this.listenTo(this.bannerView, "NOTIFICATION_MODAL", this.openNotificationModal), this.listenTo(FF.eventNotifier, "modal:openNotify", this.onModalOpen.bind(this)), this.listenTo(FF.eventNotifier, "modal:closeNotify", this.onModalClose.bind(this)), this.listenTo(FF.eventNotifier, "app:changeScene", function() {
                t._hideHomeAB()
            }), this.listenTo(FF.eventNotifier, "app:changeSceneByPages", function() {
                t._hideHomeAB()
            }), this.listenTo(FF.eventNotifier, "globalnavi:changeLocation", function() {
                t._hideHomeAB()
            })
        },
        render: function() {
            var e = this._getMissionBadgeText();
            r.prototype.render.call(this, E, {
                newRelationNum: FF.datastore.stash.newRelationNum,
                giftBoxNum: FF.datastore.stash.giftBoxNum,
                uncheckedNotificationNum: FF.datastore.notificationCollection.uncheckedNum(),
                missionBadgeText: e,
                isInNormalDungeon: this.dungeonSessionModel.isInNormalDungeon(),
                isInEventDungeon: this.dungeonSessionModel.isInEventDungeon()
            }), this.bannerView.render(), this._initDeferred = t.Deferred(), t.when(this._initDeferred.promise(), this._loadABViewDeferred()).done(this._processAfterLayoutAndABReady.bind(this)), this.processAfterRender(), this.activateCrystalAnimation()
        },
        _getMissionBadgeText: function() {
            var t = FF.datastore.missionCollection.getRewardReceivableMissions(),
                n = e.reject(t, function(e) {
                    return e.isRealIncentive()
                }).length;
            return n ? "" + n : a.hasNewMission() ? i.getInstance().get("mission_badge_new") : null
        },
        processAfterContentLoad: function() {
            this._initDeferred.resolve(), this._initDeferred = void 0
        },
        activateCrystalAnimation: function() {
            (!FF.env.isIOS6_x() || !FF.env.isAndroid2_x()) && t("#crystal").addClass("is-animation-available")
        },
        _processAfterLayoutAndABReady: function() {
            var e = this;
            r.prototype.processAfterContentLoad.call(this), this._showHomeNotificationDeferred().then(this._showHomeTutorialIfNeedDeferred).then(this._showMissionTutorialIfNeedDeferred).then(this._showExternalCollaboPrizeModalIfNeedDeferred).then(this._showModalMissionClearIfNeedDeferred).then(this._startHomeABView.bind(this))
        },
        _showHomeNotificationDeferred: function() {
            return c.showModalIfNeedPopupNotificationDeferred("HOME", 0)
        },
        _showHomeTutorialIfNeedDeferred: function() {
            var e = t.Deferred();
            return f.hasSeen("HOME") ? e.resolve().promise() : f.showNavigationDeferred({
                key: "HOME",
                isTutorialIllustOnly: !0
            })
        },
        _showMissionTutorialIfNeedDeferred: function() {
            var e = t.Deferred();
            return f.hasSeen("MISSION") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/mission", {
                trigger: !0
            }), e.promise())
        },
        _showExternalCollaboPrizeModalIfNeedDeferred: function() {
            var e = t.Deferred();
            return u.canReceived() ? u.receiveAndOpenModalIfNeededDeferred() : e.resolve().promise()
        },
        _showModalMissionClearIfNeedDeferred: function() {
            var e = t.Deferred();
            return a.shouldShowModalMissionClear() ? a.openModalMissionClearIfNeedDeferred() : e.resolve().promise()
        },
        onModalOpen: function(e) {
            FF.logger.debug("recieved modal:openNotify", e), this._hideHomeAB()
        },
        onModalClose: function(e) {
            FF.logger.debug("recieved modal:closeNotify", e), this._showHomeAB()
        },
        onClickMenu: function() {
            FF.router.loading.lock(), n.history.navigate("#global_menu", {
                trigger: !0
            })
        },
        onClickMission: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#mission/list", {
                trigger: !0
            })
        },
        onClickRealIncentiveMission: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#real_incentive_mission/list", {
                trigger: !0
            })
        },
        onClickAchievementRoom: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#achievement_room/top", {
                trigger: !0
            })
        },
        onClickRitualRoom: function() {
            FF.router.loading.lock(), this._hideHomeAB(), n.history.navigate("#ritual_room/top", {
                trigger: !0
            })
        },
        openReviewOffer: function() {
            var e = this,
                t = new p({
                    reviewId: FF.CONST.CLIENT.REVIEW_ID_OF.BANNER
                });
            FF.router.overlay.registerChildren(t), t.render(), t.open(), this.listenToOnce(t, "REVIEW_DONE", function() {
                e.bannerView.render()
            })
        },
        openNotification: function() {
            var e = this;
            FF.router.loading.lock(), this.modalNotification = new v({}), FF.router.overlay.registerChildren(this.modalNotification), this.modalNotification.checkedAllDeferred().done(function() {
                e.modalNotification.render(), e.modalNotification.openAfterImageLoad({
                    isCrawlImgTag: !0
                })
            })
        },
        openNotificationModal: function(e) {
            var t = this;
            FF.router.loading.lock();
            var n = FF.datastore.notificationCollection.get(e);
            this.notificationModal = new d({
                notificationModel: n,
                isPopup: !0
            }), this.notificationModal.render(), FF.router.overlay.registerChildren(this.notificationModal), this.listenToOnce(this.notificationModal, "modalNotificationDetailBack", function() {
                t.notificationModal.end()
            }), this.notificationModal.open({
                isCrawlImgTag: !0
            })
        },
        openGiftBox: function() {
            this._hideHomeAB(), n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        openFriend: function() {
            this._hideHomeAB(), n.history.navigate("#friend", {
                trigger: !0
            })
        },
        openWorld: function(e) {
            var t = this;
            g.getCanReturnDeferred().then(function(r) {
                if (e === void 0) {
                    r.canReturn ? e = "#progress_map" : e = "#world";
                    if (t.dungeonSessionModel.isInNormalDungeon()) return t._jumpToCurrentDungeon();
                    t._hideHomeAB(), n.history.navigate(e, {
                        trigger: !0
                    })
                }
            })
        },
        openEvents: function(e) {
            if (this.dungeonSessionModel.isInEventDungeonExceptingExtremeDungeons()) return this._jumpToCurrentDungeon();
            e === void 0 && (e = "#events"), this._hideHomeAB(), n.history.navigate(e, {
                trigger: !0
            })
        },
        toggleSubNavi: function(e) {
            var n = !0,
                r = "removeClass",
                i = "deactivate";
            this._isSubNaviVisible && (r = "addClass", n = !1, i = "activate"), t("[data-app-sub-navi-parts]")[r]("di-n"), this._isSubNaviVisible = n, this.bannerView[i](), e.preventDefault()
        },
        openExtremeEvents: function(e) {
            e = e || "#event/extreme/world_list";
            if (this.dungeonSessionModel.isInExtremeDungeon()) return this._jumpToCurrentDungeon();
            this._hideHomeAB(), n.history.navigate(e, {
                trigger: !0
            })
        },
        openExtremeEventOutOfTermModal: function() {
            if (l.isExtremeWorldOpen()) {
                FF.router.loading.unlock();
                return
            }
            FF.modalStack.push(h, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onClickBack: function() {
            this._hideHomeAB(), FF.router.loading.lock(), n.history.navigate("#title", {
                trigger: !0
            })
        },
        _jumpToCurrentDungeon: function() {
            this._hideHomeAB();
            var e = this.dungeonSessionModel.getWorldModel(),
                t = this.dungeonSessionModel.get("dungeon_id"),
                r = e.getBattleListFragment(t);
            n.history.navigate(r, {
                trigger: !0
            })
        },
        dispose: function() {
            this.homeABView && this.homeABView.dispose(), this.bannerView && this.bannerView.dispose(), this._layerFactory && (this._layerFactory.destroyAllLayer(), this._layerFactory.dispose()), r.prototype.dispose.call(this)
        },
        _loadABViewDeferred: function() {
            if (!kickmotor.nativefn.isNative()) return t.Deferred().resolve().promise();
            var n = this,
                r = {};
            e.extend(r, FF.datastore.stash.homeAssets), e.extend(r, FF.datastore.stash.partyAssets);
            var i = FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_REGULAR,
                s = FF.datastore.bannerCollection.filter(function(e) {
                    return e.isOpened() && e.get("display_type") === i
                }),
                o = FF.CONST.SERVER.BANNER.DISPLAY_TYPE_OF.MYPAGE_EVENT,
                u = FF.datastore.bannerCollection.filter(function(e) {
                    return e.isOpened() && e.get("display_type") === o
                });
            e.each(s, function(t) {
                t && e.extend(r, t.get("assets"))
            }), e.each(u, function(t) {
                t && e.extend(r, t.get("assets"))
            }), this._assets = {
                assets: r
            };
            var a = [];
            a.push(S.MYPAGE), a.push(S.PLAYER_COMMON);
            var f = t.Deferred();
            return this._layerFactory = new m(a, r), n._layerFactory.createLayersDeferred(!0).then(function() {
                n._initABLayer(s, u), f.resolve()
            }), f.promise()
        },
        _initABLayer: function(n, r) {
            FF.logger.debug("#normalBanners", n), FF.logger.debug("#eventBanners", r);
            var i = this,
                o = this._layerFactory;
            t.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            });
            var u = o.getLayerAll();
            FF.logger.debug("layerAll:", u), this.homeABView = new y(S.MYPAGE, o.getLayerByAssetId(S.MYPAGE), o.getLayerByAssetId(S.PLAYER_COMMON), o.getAssetManager(), n, r);
            var a = FF.datastore.partyModel;
            e.each(a.getBuddyMap(), function(e, t) {
                var n = s("animation-buddy-%s", e.get("buddy_id")),
                    r = o.getAssetManager().getAssetInfo(n);
                i.homeABView.insertCharacter(parseInt(t) - 1, r)
            }), i.homeABView.fillEmptyCharacters(), this.listenTo(this.homeABView, y.EVENTS.LINK_SELECTED, function(e, t) {
                FF.logger.debug("selectedContent", e, t), FF.router.loading.lock()
            }), this.listenTo(this.homeABView, y.EVENTS.LINK_ANIMATION_END, function(e, t) {
                FF.logger.debug("animation end", e, t);
                var n = t ? t.get("url") : void 0;
                switch (e) {
                    case y.CONTENTS.NORMAL:
                        this.openWorld(n);
                        break;
                    case y.CONTENTS.EVENT:
                        this.openEvents(n);
                        break;
                    case y.CONTENTS.TOUGH:
                        this.openExtremeEvents(n);
                        break;
                    case y.CONTENTS.TOUGH_DISABLED:
                        this.openExtremeEventOutOfTermModal()
                }
            }), l.isExtremeWorldOpen() || this.homeABView.setContentDisabled(y.CONTENTS.TOUGH), this._hideHomeAB()
        },
        _startHomeABView: function() {
            if (!kickmotor.nativefn.isNative()) return;
            this._layerFactory.setAllLayerVisible(!0), this._showHomeAB();
            var e = this.dungeonSessionModel.isInNormalDungeon(),
                t = this.dungeonSessionModel.isInEventDungeon(),
                n = this.dungeonSessionModel.isInExtremeDungeon();
            (e || t || n) && this.homeABView.changeSortie({
                isInEventDungeon: t,
                isInExtremeDungeon: n
            }), T ? this.homeABView.startWithoutInitialAnimation() : (T = !0, this.homeABView.playInitialAnimation())
        },
        _hideHomeAB: function() {
            this.homeABView && this.homeABView.hideHomeABView()
        },
        _showHomeAB: function() {
            this.homeABView && this.homeABView.showHomeABView()
        },
        openWorldDevelop: function() {
            if (!FF.env.isDevelop()) return;
            n.history.navigate("#world", {
                trigger: !0
            })
        },
        openEventsDevelop: function() {
            if (!FF.env.isDevelop()) return;
            n.history.navigate("#events", {
                trigger: !0
            })
        }
    })
}), define("scenes/home/HomeScene", ["underscore", "jquery", "backbone", "lib/Scene", "lib/Xpromo", "scenes/common/helper/RootData", "scenes/common/helper/FuncTutorial", "./views/Layout"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        setupDeferred: function() {
            var e = t.Deferred();
            return s.updateRootDataIfNeedDeferred().then(function() {
                e.resolve()
            }), e.promise()
        },
        start: function() {
            this.setupDeferred().then(this._showUiRenewalTutorialDeferred).then(this._onSetupComplete.bind(this))
        },
        _showUiRenewalTutorialDeferred: function() {
            var e = t.Deferred();
            return o.hasSeen("UI_REBORN") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/ui_reborn", {
                trigger: !0
            }), e.reject().promise())
        },
        _onSetupComplete: function() {
            this.playBgm(), this.layoutView = new u({}), this.layoutView.render(), i.SendCustomEventIfNeed()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/common/views/relation/ModalProfileDetail", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "scenes/common/models/Profile", "templates/common/relation/ModalProfileDetail", "templates/common/relation/ModalFollowResult", "templates/common/relation/ModalError", "templates/common/relation/ModalUnfollowConfirm", "lib/ModalBase"], function(e, t, n, r, i, s, o, u, a, f) {
    return f.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-follow]": "onFollow",
            "anchorsbeforejump [data-app-unfollow]": "onUnfollow",
            "anchorsbeforejump [data-app-modal-cancel]": "onSkipFollow",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e, t) {
            t = t || {}, this._profileModel = e, this._templateDetail = t.template ? t.template : s, this._hideButton = t.hideButton ? t.hideButton : !1, this._statusBonusOpt = t.statusBonusOpt || {}, f.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(this._templateDetail, {
                profileModel: this._profileModel,
                userModel: FF.datastore.userModel,
                hideButton: this._hideButton,
                statusBonusOpt: this._statusBonusOpt
            })
        },
        renderResult: function(e) {
            this.renderContent(o, {
                currentFolloweeNum: e.current_followee_num,
                isUnfollow: e.isUnfollow,
                name: this._profileModel.getNickname(),
                isViaBattle: this._profileModel.isViaBattle()
            })
        },
        renderError: function(e) {
            this.renderContent(u, {
                errors: e.errors,
                isFollow: e.isFollow,
                isUnfollow: e.isUnfollow
            })
        },
        renderUnfollowConfirm: function() {
            this.renderContent(a, {
                id: this._profileModel.getUserId(),
                name: this._profileModel.getNickname()
            })
        },
        onFollow: function() {
            var t = this;
            FF.router.loading.lock();
            var n = this._profileModel.isViaBattle() ? FF.CONST.CLIENT.FOLLOW_SCENE_ID_OF.AFTER_DUNGEON : FF.CONST.CLIENT.FOLLOW_SCENE_ID_OF.INVITE_ID_SEARCH,
                i = {
                    isViaBattle: this._profileModel.isViaBattle(),
                    sceneId: n
                };
            FF.datastore.followeeProfileCollection.clearCache(), FF.datastore.followerProfileCollection.clearCache(), t.close(!0), t.listenToOnce(t, "closeAnimationEnd", function() {
                r.followDeferred(this._profileModel.getUserId(), i).then(function(n) {
                    t.open(), e.isEmpty(n.user_relation_errors) ? t._profileModel.isViaBattle() ? (t.trigger("onFollow", {
                        data: n
                    }), n.isUnfollow = !1, t.renderResult(n), FF.router.loading.hide(!0)) : (t.trigger("bakeFollowToast", {
                        data: n
                    }), t.end()) : (t.renderError({
                        isFollow: !0,
                        isUnfollow: !1,
                        errors: n.user_relation_errors
                    }), FF.router.loading.hide(!0))
                })
            })
        },
        onUnfollow: function() {
            var t = this;
            FF.router.loading.lock(), this.renderUnfollowConfirm(), this.listenToOnce(this, "decideToUnfollow", function() {
                FF.datastore.followeeProfileCollection.clearCache(), FF.datastore.followerProfileCollection.clearCache(), t.close(!0), t.listenToOnce(t, "closeAnimationEnd", function() {
                    r.unfollowDeferred(t._profileModel.getUserId()).then(function(n) {
                        e.isEmpty(n.user_relation_errors) ? (n.isUnfollow = !0, t.listenToOnce(t, "followResultClose", function() {
                            t.trigger("onUnfollow", {
                                data: n
                            })
                        }), t._isShowingResult = !0, t.renderResult(n), t.open(), FF.router.loading.hide(!0)) : (t.renderError({
                            isFollow: !1,
                            isUnfollow: !0,
                            errors: n.user_relation_errors
                        }), FF.router.loading.hide(!0))
                    })
                })
            })
        },
        onSkipFollow: function() {
            var e = this;
            FF.router.loading.lock(), r.finishFellowSessionDeferred().then(function(t) {
                e.trigger("profileDetailClose"), e.end(), FF.router.loading.hide()
            })
        },
        onClickDecide: function() {
            this.trigger("decideToUnfollow")
        },
        onClickClose: function() {
            this._isShowingResult ? (this._isShowingResult = !1, this.trigger("followResultClose")) : this.trigger("profileDetailClose"), this.end()
        },
        dispose: function() {
            f.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/Relation", ["jquery", "underscore", "backbone", "lib/Events", "scenes/common/util/Api", "scenes/common/views/relation/ModalProfileDetail", "templates/common/relation/ModalCanFollow"], function(e, t, n, r, i, s, o) {
    var u = function(e, t) {
        var n = new s(e, t);
        return n.render(), FF.router.overlay.registerChildren(n), n.open(), n
    };
    return t.extend({
        showModal: u,
        showModalIfNeedDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (FF.datastore.dungeonSessionModel.isInDungeon()) return n.resolve().promise();
            var r = FF.datastore.fellowSessionModel;
            if (!r.hasFellow() || !r.canFollow()) return n.resolve().promise();
            var i = r.createFellowProfileModel(),
                s = u(i, {
                    template: o
                });
            return this.listenToOnce(s, "profileDetailClose", function() {
                e("#modal").one("webkitTransitionEnd transitionend", function() {
                    t.stopListening(), FF.router.overlay.unregisterChildren(s), r.clear(), n.resolve()
                })
            }), n.promise()
        },
        finishFellowSessionIfNeedDeferred: function() {
            var t = FF.datastore.dungeonSessionModel;
            if (t.isInDungeon()) return e.Deferred().resolve().promise();
            var n = FF.datastore.fellowSessionModel;
            if (!n.isFinishable()) return e.Deferred().resolve().promise();
            var r = e.Deferred();
            return i.finishFellowSessionDeferred().done(function() {
                n.clear(), r.resolve()
            }), r.promise()
        },
        detailedFellowListingDeferred: function(t) {
            var n = e.Deferred();
            return i.detailedFellowListingDeferred(t).done(function(e) {
                n.resolve(e)
            }), n.promise()
        }
    }, r)
}), define("scenes/world_list/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend(n, {
        showAllClearDeferred: function() {
            return this.requestDeferred("/dff/user/finish_showing_all_clear", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/world_list/views/ModalAllClear", ["underscore", "jquery", "backbone", "templates/world_list/ModalAllClear", "lib/ModalBase", "scenes/world_list/Api"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function() {
            this.renderContent(r, {})
        },
        onClickModalClose: function() {
            FF.router.loading.lock();
            var e = this;
            s.showAllClearDeferred().done(function(t) {
                FF.datastore.userModel.set(t.user), e.end()
            })
        }
    })
}), define("scenes/world_list/views/Layout", ["underscore", "jquery", "backbone", "scenes/world_list/Api", "lib/LayoutBase", "components/Button", "components/Carousel", "components/Indicator", "scenes/common/helper/FuncTutorial", "scenes/common/helper/MissionHelper", "scenes/world_list/views/ModalAllClear", "util", "templates/world_list/WorldList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = {
            ACHIEVE_TYPE_NAMES: ["ABILITY_GENERATE", "ABILITY_UPGRADE", "BUDDY_LEVEL", "CLEAR_DUNGEON", "ENHANCE", "EVOLVE", "FRIEND_INVITE", "GACHA", "GET_ITEM"]
        },
        d = i.extend({
            contentType: "WORLD",
            designType: "MODERN",
            events: {
                "anchorsbeforejump [data-app-world-id]": "onClickWorld",
                "anchorsbeforejump [data-app-event]": "onClickEvent"
            },
            initialize: function(e) {
                this.prevWorldId = e.prevWorldId || void 0, i.prototype.initialize.call(this)
            },
            render: function() {
                i.prototype.render.call(this, h, {
                    worldCollection: FF.datastore.worldCollection,
                    prevWorldId: this.prevWorldId
                }), this.collectElements(), this.setupComponents(), this.checkWorldLength(), this.processAfterRender()
            },
            checkWorldLength: function() {
                this._realWorlds.size() < 2 ? (t("[data-ui-carousel-parent]").addClass("g-disable-animation is-only-one-world"), this._onMoveTo(1), this._onMoved(1)) : this._duplicatedWorld = t("[data-ui-carousel-children]")
            },
            processAfterContentLoad: function() {
                i.prototype.processAfterContentLoad.call(this);
                if (FF.datastore.userModel.get("has_all_clear_ver_to_show")) {
                    var e = new l;
                    FF.router.overlay.registerChildren(e), e.render(), e.openAfterImageLoad()
                } else {
                    if (this._shouldShowProgressMapTutorial()) return a.showNavigationDeferred({
                        key: "PROGRESS_MAP",
                        isTutorialIllustOnly: !0
                    });
                    f.openModalMissionClearIfNeedDeferred()
                }
            },
            _shouldShowProgressMapTutorial: function() {
                if (a.hasSeen("PROGRESS_MAP")) return !1;
                var t = FF.Config.server.progressMapTutorialCondition,
                    n = t.worldIdList,
                    r = t.totalNumClear,
                    i = FF.CONST.SERVER.DUNGEON.TYPE_OF,
                    s = 0;
                return e.each(n, function(e) {
                    var t = FF.datastore.worldCollection.get(e),
                        n = t.get("dungeon_status_summary");
                    if (!n) return;
                    var r = +n[i.NORMAL].clear_count;
                    s += r
                }), s >= r
            },
            collectElements: function() {
                this._realWorlds = t("[data-ui-carousel-children]"), this._indicators = t("[data-ui-indicator-children]"), this._worldInfo = t("[data-app-world-info]"), this._titleLogo = t("#titleLogo"), this._clearHistory = t("[data-app-dungeon-clear-history]"), this._masterHistory = t("[data-app-dungeon-master-history]"), this._clearForce = t("[data-app-dungeon-clear-force]"), this._masterForce = t("[data-app-dungeon-master-force]"), this._dungeonNumHistory = t("[data-app-dungeon-num-history]"), this._dungeonNumForce = t("[data-app-dungeon-num-force]")
            },
            setupComponents: function() {
                var e = this,
                    n = !1;
                this.infoArea = new s({
                    el: t("[data-app-world-info]")
                }), this.btnPrev = new s({
                    el: t("#worldSwitcherL"),
                    message: -1
                }), this.btnNext = new s({
                    el: t("#worldSwitcherR"),
                    message: 1
                }), this.carousel = new o({
                    el: t("#worldList"),
                    direction: 0,
                    isRepeat: !0,
                    btnPrev: this.btnPrev,
                    btnNext: this.btnNext,
                    startUp: this.getStartupPosition()
                }), 1 < this.carousel.getChildrenNum() && (n = !0), this.indicator = new u({
                    el: t("#selectableIndicator"),
                    enableTouch: n ? !0 : !1,
                    watch: this.carousel,
                    className: "is-active"
                });
                if (!n) return;
                this.btnPrev.addTouchBehavior(), this.btnNext.addTouchBehavior(), this.infoArea.addTouchBehavior(), this.listenTo(this.btnPrev, "swipeend", function(t) {
                    e.carousel.moveTo(t.direction === "left" ? 1 : -1)
                }).listenTo(this.btnPrev, "touchmoved", function(e) {
                    t("#worldSwitcherL").removeClass("mbgaui-active"), t("#worldSwitcherR").removeClass("mbgaui-active")
                }).listenTo(this.btnNext, "swipeend", function(t) {
                    e.carousel.moveTo(t.direction === "left" ? 1 : -1)
                }).listenTo(this.btnNext, "touchmoved", function(e) {
                    t("#worldSwitcherL").removeClass("mbgaui-active"), t("#worldSwitcherR").removeClass("mbgaui-active")
                }).listenTo(this.infoArea, "swipeend", function(t) {
                    e.carousel.moveTo(t.direction === "left" ? 1 : -1)
                }).listenTo(this.carousel, "moveTo", function(t) {
                    FF.SoundMgr.playChooseEffect(), e._onMoveTo(t)
                }).listenTo(this.carousel, "startedUp", function(t) {
                    e._onMoveTo(t)
                }).listenTo(this.carousel, "moved startedUp", function(t) {
                    e._onMoved(t)
                }).listenTo(this.carousel, "loopStarted", function(t) {
                    e._onLoopStarted(t)
                }).listenTo(this.indicator, "pointElement", function(t) {
                    e._onPointElement(t)
                })
            },
            _onMoveTo: function(e) {
                var t = e - 2;
                this._setActiveStateTo(t), this._hideWorldInfo()
            },
            _onMoved: function(e) {
                this._titleLogo.attr("src", "data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==");
                var t = this,
                    n = e - 2,
                    r = this._getSeriesIdByIndex(n),
                    i = pUrl(this._getTitleLogoUrl(r));
                this._setPlayData(r), window.setTimeout(function() {
                    t._titleLogo.attr("src", i), t._showWorldInfo()
                }, 0), this.carousel.unlock()
            },
            _onLoopStarted: function(e) {
                this.carousel.lock(), e.isLeftLoop ? (this.indicator.getLastChild().addClass("is-active"), this._duplicatedWorld.eq(1).addClass("is-active")) : e.isRightLoop && (this.indicator.getFirstChild().addClass("is-active"), this._duplicatedWorld.eq(2).addClass("is-active").end().eq(e.index).addClass("is-active"))
            },
            _setActiveStateTo: function(e) {
                this._duplicatedWorld && this._duplicatedWorld.removeClass("is-active"), this._realWorlds.eq(e).addClass("is-active")
            },
            _setPlayData: function(e) {
                var n = FF.CONST.SERVER.DUNGEON.TYPE_OF,
                    r = FF.datastore.worldCollection.get(e),
                    i = r.get("dungeon_status_summary"),
                    s = c.getTimeAsSec(),
                    o = r.get("dungeon_term_list"),
                    u = +this._countOpenDungeonByType(o, s, n.NORMAL),
                    a = +this._countOpenDungeonByType(o, s, n.FORCE),
                    f = +i[n.NORMAL].clear_count,
                    l = +i[n.NORMAL].master_count,
                    h = +i[n.FORCE].clear_count,
                    p = +i[n.FORCE].master_count;
                this._clearHistory.text(f), this._masterHistory.text(l), this._clearForce.text(h), this._masterForce.text(p), this._dungeonNumHistory.text(u), this._dungeonNumForce.text(a), t("#historyMasterInfo")[l === u ? "addClass" : "removeClass"]("is-completed"), t("#historyClearInfo")[f === u ? "addClass" : "removeClass"]("is-completed"), t("#forceMasterInfo")[p === a ? "addClass" : "removeClass"]("is-completed"), t("#forceClearInfo")[h === a ? "addClass" : "removeClass"]("is-completed")
            },
            _hideWorldInfo: function() {
                this._worldInfo.removeClass("show")
            },
            _showWorldInfo: function() {
                this._worldInfo.addClass("show")
            },
            _getSeriesIdByIndex: function(e) {
                var t = this._realWorlds.eq(e).find("[data-app-world-id]");
                return t.attr("data-app-world-id")
            },
            _getTitleLogoUrl: function(e) {
                return pUrl("static/img/category/world/logo_" + e + ".png")
            },
            _onPointElement: function(e) {
                var n = this._indicators.index(t(e.element)) + 1;
                this._lastPointedIndex !== n && 0 < n && (this._lastPointedIndex = n, this.carousel.directlyMoveTo(n))
            },
            _countOpenDungeonByType: function(t, n, r) {
                var i = e.filter(t, function(e) {
                    return +e.type === r && +e.opened_at <= n && n < +e.closed_at
                });
                return i.length
            },
            getStartupPosition: function() {
                if (!this.prevWorldId) return 0;
                var e = '[data-app-world-id="' + this.prevWorldId + '"]',
                    n = t(e).parent().index(),
                    r = n + 2;
                return r
            },
            onClickWorld: function(e) {
                FF.router.loading.lock();
                var r = t(e.target),
                    i = r.attr("data-app-world-id"),
                    s = r.find(".s-world-door-num"),
                    o = t("[data-app-zoom]"),
                    u = FF.env.isAndroid2_3(),
                    a = FF.env.isIOS6_x();
                this.carousel.disposeFunctionality(), this.indicator.disposeFunctionality(), kickmotor.sound.playEffect("se_common_100040", !1), s.addClass("animate").one("webkitAnimationEnd animationend", function() {
                    (u || a) && FF.router.loading.show(), n.history.navigate(sprintf("#world/%s/dungeon/list", i), {
                        trigger: !0
                    })
                }), !u && !a && o.addClass("animate")
            },
            onClickBack: function() {
                FF.router.loading.lock(), n.history.navigate("#home", {
                    trigger: !0
                })
            },
            onClickEvent: function() {
                FF.router.loading.lock(), n.history.navigate("#events", {
                    trigger: !0
                })
            },
            dispose: function() {
                this.detailModal && this.detailModal.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose(), this.btnPrev && this.btnPrev.dispose(), this.btnNext && this.btnNext.dispose(), i.prototype.dispose.call(this)
            }
        });
    return d
}), define("scenes/world_list/WorldListScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "scenes/common/helper/Relation", "scenes/progress_map/LatestProgressData", "./views/Layout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        start: function(e) {
            var t = this;
            o.saveCanReturnDeferred(!1).then(function() {
                return t.setupDeferred(e)
            }).done(function() {
                t.playBgm(), t.layoutView = new u({
                    prevWorldId: e
                }), t.layoutView.render()
            })
        },
        setupDeferred: function(e) {
            return s.finishFellowSessionIfNeedDeferred()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/global_menu/Api", ["scenes/common/util/Api"], function(e) {
    var t = 3600;
    return _.extend({}, e, {
        menuListDeferred: function() {
            return this.requestWithCacheDeferred("/dff/menu/list", {}, {
                expirationTime: t
            })
        },
        menuFriendDeferred: function() {
            return this.requestDeferred("/dff/menu/friend", {}, {
                expirationTime: t
            })
        },
        helpGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/help/get_data", {
                type: e
            })
        }
    })
}), define("scenes/global_menu/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "scenes/notification/views/ModalNotification", "templates/global_menu/GlobalMenu", "ww/scenes/common/views/ModalContact", "ww/scenes/migration_info/views/ModalMigrationInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = "https://ssl.sp.mbga.jp/_cust_feedback",
        p = "https://dena.com/legal/PP.html";
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-mobage-feedback]": "openMobageFeedback",
            "anchorsbeforejump [data-app-open-mobage-community]": "openMobageCommunity",
            "anchorsbeforejump [data-app-open-mobage-contact]": "openMobageContact",
            "anchorsbeforejump [data-app-open-mobage-feedback]": "openMobageFeedback",
            "anchorsbeforejump [data-app-open-policy]": "openPrivacyPolicy",
            "anchorsbeforejump [data-app-open-ww-migration-info]": "openWWMigrationInfo"
        },
        render: function() {
            s.prototype.render.call(this, u), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openMobageFeedback: function() {
            var e = FF.Config.server.externalUrls.feedback || h;
            this.openUrl(e)
        },
        openMobageCommunity: function() {
            i.platform.showCommunity()
        },
        openMobageContact: function() {
            if (FF.env.isWWRegion()) {
                var e = new a;
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else i.nativefn.call("mobageContact")
        },
        openWWMigrationInfo: function() {
            if (FF.env.isWWRegion()) {
                var e = new f;
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else i.nativefn.call("migrationinfo")
        },
        openUrl: function(e) {
            i.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                i.platform.openExternalURL(e)
            })
        },
        openPrivacyPolicy: function() {
            FF.env.isWWRegion() && (this.lockScreenBeforeGoExternalLink(), this.openUrl(p))
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/global_menu/GlobalMenuScene", ["underscore", "jquery", "backbone", "scenes/global_menu/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e.layoutView = new s({
                    el: t("#content")
                }), e.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        }
    })
}), define("scenes/serial_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        serialCampaignListDeferred: function() {
            return this.requestDeferred("/dff/serial_campaign/list", {})
        },
        serialCampaignGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/serial_campaign/show", {
                id: e
            })
        },
        serialCampaignApplyDeferred: function(e, t) {
            return this.requestDeferred("/dff/serial_campaign/apply", {
                id: e,
                code: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/serial_code/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "templates/serial_code/SerialCode", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-serial-campaign]": "openSerialCampaign",
            "anchorsbeforejump [data-app-open-watchward-campaign]": "openWatchwardCampaign",
            "anchorsbeforejump [data-app-open-sq-portal-campaign]": "openSqPortalCampaign",
            "anchorsbeforejump [data-app-open-emsaga-campaign]": "openEmsagaCampaign"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this, e), this.serialCampaigns = e.serialCampaigns, this.watchwardCampaigns = e.watchwardCampaigns, this.sqPortalCampaigns = e.sqPortalCampaigns, this.emsagaCampaigns = e.emsagaCampaigns
        },
        render: function() {
            s.prototype.render.call(this, o, {
                sortedCampaigns: this.getSortedCampaigns(),
                serialCampaigns: this.serialCampaigns,
                watchwardCampaigns: this.watchwardCampaigns,
                sqPortalCampaigns: this.sqPortalCampaigns,
                emsagaCampaigns: this.emsagaCampaigns
            }), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        getSortedCampaigns: function() {
            var t = [];
            return e.each(this.serialCampaigns, function(e) {
                e.isSerialCampaign = !0, t.push(e)
            }), e.each(this.watchwardCampaigns, function(e) {
                e.isWatchwardCampaign = !0, t.push(e)
            }), e.sortBy(t, function(e) {
                return e.opened_at
            })
        },
        openSerialCampaign: function(e) {
            var t = e.target.getAttribute("data-app-open-serial-campaign");
            n.history.navigate("#serial_campaign/" + t, {
                trigger: !0
            })
        },
        openWatchwardCampaign: function(e) {
            var t = e.target.getAttribute("data-app-open-watchward-campaign");
            n.history.navigate("#watchward_campaign/" + t, {
                trigger: !0
            })
        },
        openSqPortalCampaign: function(e) {
            n.history.navigate("#sq_portal_campaign", {
                trigger: !0
            })
        },
        openEmsagaCampaign: function(e) {
            n.history.navigate("#emsaga_campaign", {
                trigger: !0
            })
        },
        openUrl: function(e) {
            i.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                i.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            n.history.navigate("global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/serial_code/SerialCodeScene", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e.layoutView = new s({
                    serialCampaigns: FF.datastore.stash.serialCampaigns,
                    watchwardCampaigns: FF.datastore.stash.watchwardCampaigns,
                    sqPortalCampaigns: FF.datastore.stash.sqPortalCampaigns,
                    emsagaCampaigns: FF.datastore.stash.emsagaCampaigns
                }), e.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return FF.datastore.stash.serialCampaigns ? e.resolve().promise() : (r.serialCampaignListDeferred().done(function(t) {
                FF.datastore.stash.serialCampaigns = t.serial_campaigns || [], FF.datastore.stash.watchwardCampaigns = t.watchward_campaigns || [], FF.datastore.stash.sqPortalCampaigns = t.sq_portal_serial_campaigns || [], FF.datastore.stash.emsagaCampaigns = t.emsaga_serial_campaigns || [], e.resolve()
            }), e.promise())
        }
    })
}), define("scenes/friend/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "templates/friend/Friend", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-friend-list]": "openFriendList",
            "anchorsbeforejump [data-app-open-search-friend]": "openSearchFriend",
            "anchorsbeforejump [data-app-open-friend-invite]": "openFriendInvite",
            "anchorsbeforejump [data-app-open-profile]": "openProfile"
        },
        render: function() {
            s.prototype.render.call(this, o, {
                newRelationNum: FF.datastore.stash.newRelationNum,
                hasUnlockedRelation: !0,
                isInFriendInviteCampaign: FF.datastore.stash.friendMenu.isInFriendInviteCampaign,
                canInputFriendInvitation: FF.datastore.stash.friendMenu.canInputFriendInvitation
            }), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openFriendList: function() {
            n.history.navigate("#relation/follow_list", {
                trigger: !0
            })
        },
        openSearchFriend: function() {
            n.history.navigate("#relation/search", {
                trigger: !0
            })
        },
        openFriendInvite: function() {
            n.history.navigate("#friend_invite", {
                trigger: !0
            })
        },
        openProfile: function() {
            n.history.navigate("#profile", {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend/FriendScene", ["underscore", "jquery", "backbone", "scenes/global_menu/Api", "lib/Scene", "./views/Layout", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o) {
    return i.extend({
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e.layoutView = new s, e.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this._shouldShowFriendTutorial() ? (n.history.navigate("#func_tutorial/fellow", {
                trigger: !0
            }), e.reject().promise()) : FF.datastore.stash.friendMenu ? e.resolve().promise() : (r.menuFriendDeferred().done(function(t) {
                FF.datastore.stash.friendMenu = {
                    isInFriendInviteCampaign: t.is_in_friend_invite_campaign,
                    canInputFriendInvitation: t.can_input_friend_invitation
                }, e.resolve()
            }), e.promise())
        },
        _shouldShowFriendTutorial: function() {
            return o.hasSeen("FELLOW") ? !1 : o.hasSeen("PROFILE") ? o.hasSeen("FELLOW_LIST") ? !0 : !1 : !1
        }
    })
}), define("scenes/event_list/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "lib/TextMaster", "scenes/common/util/Api", "scenes/common/views/Banner", "scenes/common/Constant", "scenes/common/helper/PopupNotification", "scenes/common/helper/MissionHelper", "templates/event_list/EventList", "components/FreeScroll", "components/Scrollbar", "components/TimeKeeper", "components/CookieMania", "util", "lib/LayoutBase"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    return m.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-world-select]": "onSelectWorld",
            "anchorsbeforejump [data-app-event-mission]": "onClickEventMission",
            "anchorsbeforejump [data-app-btn-normal]": "onClickBack",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalLink"
        },
        _standBy: !1,
        initialize: function(e) {
            this.bannerView = new o({}), m.prototype.initialize.call(this)
        },
        render: function() {
            var e = FF.datastore.eventCollection.getEventModelsForTop(),
                t = this._getMissionBadgeText(),
                n = {
                    util: v,
                    events: e,
                    missionBadgeText: t
                };
            FF.env.isWWRegion() && (n.timeKeeper = new p({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            })), m.prototype.render.call(this, l, n), this.bannerView.render(), this.setupComponents(), this.processAfterRender()
        },
        _getMissionBadgeText: function() {
            var e = FF.CONST.SERVER.MISSION.TYPE_OF,
                t = FF.datastore.missionCollection.getRewardReceivableMissions({
                    type: e.EVENT
                }).length;
            return t ? "" + t : f.hasNewMission({
                type: e.EVENT
            }) ? i.getInstance().get("new") : null
        },
        processAfterContentLoad: function() {
            m.prototype.processAfterContentLoad.call(this), a.showModalIfNeedPopupNotificationDeferred("EVENT_LIST", 0)
        },
        setupComponents: function() {
            this.freescroll = new c({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new h({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function(e) {
            if (this._standBy) return;
            this._standBy = !0, window.setTimeout(function() {
                n.history.navigate("#home", {
                    trigger: !0
                })
            }, 300)
        },
        onSelectWorld: function(e) {
            FF.router.loading.lock();
            var t = e.target.getAttribute("data-world-id"),
                n = FF.datastore.worldCollection.get(t),
                r = n.getEventModel(),
                i = FF.datastore.dungeonSessionModel.get("world_id");
            n.isOpenedToClosedTerm() ? n.isLocked() ? this.onSelectLockedWorld(n, r) : i === +t ? this.onSelectChallengedWorld(n) : n.canBeginBattleTerm() ? this.onSelectOpenWorld(n, r) : n.isKeptOutToClosedTerm() && this.onSelectKeptOutWorld(n, r) : this.onSelectCloseWorld(n, r)
        },
        onSelectLockedWorld: function(e, t) {
            n.history.navigate(t.getIntroFragment(), {
                trigger: !0
            })
        },
        onSelectOpenWorld: function(e, t) {
            n.history.navigate(e.getDungeonListFragment(), {
                trigger: !0
            })
        },
        onSelectChallengedWorld: function(e) {
            var t = e.get("dungeon_id"),
                r = e.getBattleListFragment(t);
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onSelectKeptOutWorld: function(e, t) {
            n.history.navigate(e.getKeptOutFragment(), {
                trigger: !0
            })
        },
        onSelectCloseWorld: function(e, t) {
            n.history.navigate("#home", {
                trigger: !0
            })
        },
        onClickEventMission: function() {
            if (!FF.router.loading.lock()) return;
            n.history.navigate("#mission/list/event", {
                trigger: !0
            })
        },
        onClickInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        dispose: function() {
            this.bannerView && this.bannerView.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), m.prototype.dispose.call(this)
        }
    })
}), define("scenes/event_list/EventListScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        initialize: function() {},
        start: function() {
            this.layoutView = new s, this.layoutView.render(), this.playBgm()
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("scenes/event_intro/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        enterEventWorldDeferred: function(e, t) {
            return this.requestDeferred(sprintf("/dff/event/%s/%s/enter", t, e), {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/event_intro/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "scenes/event_intro/Api", "lib/LayoutBase", "components/FreeScroll", "components/TimeKeeper", "components/Scrollbar", "util"], function(e, t, n, r, i, s, o, u, a, f) {
    return s.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-help]": "onClickHelp",
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalLink"
        },
        initialize: function(e) {
            this.eventModel = e.eventModel, this.worldModel = e.eventModel.getWorldModel(), s.prototype.initialize.call(this)
        },
        render: function() {
            var e = this;
            this.getTemplate(function(t) {
                var n = {
                    worldModel: e.worldModel,
                    eventModel: e.eventModel,
                    lang: FF.env.getLanguage(),
                    timeKeeper: null,
                    isWWLayout: !1,
                    wikiUrl: FF.env.getWikiUrl()
                };
                FF.env.isWWRegion() && (n.timeKeeper = new u({
                    preset: {
                        language: "en",
                        format: "MMDDHHII"
                    }
                }), n.isWWLayout = !0), s.prototype.render.call(e, t, n), e.setupComponents(), e.processAfterRender()
            })
        },
        getTemplate: function(e) {
            require(["templates/event_intro/" + this.eventModel.get("id")], function(t) {
                e(t)
            })
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickNext: function() {
            FF.router.loading.lock();
            var e = this.worldModel.canBeginBattleTerm() ? this.worldModel.getDungeonListFragment() : this.worldModel.getKeptOutFragment();
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickHelp: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).attr("data-app-help");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickInternalLink: function(e) {
            var r = t(e.target).attr("data-app-internal-url");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/event_intro/EventIntroScene", ["underscore", "jquery", "backbone", "scenes/event_intro/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = t.Deferred(),
                i = FF.datastore.eventCollection.get(e),
                s = i.getWorldModel();
            return s.isLocked() ? r.enterEventWorldDeferred(e, i.get("type_name")).done(function() {
                s.unlocked(), FF.datastore.stash.hasShownFirstTimeEventIntroPage[e] = !0, n.resolve()
            }) : n.resolve(), n.promise()
        },
        getLayoutViewClass: function() {
            return s
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).done(function() {
                var n = FF.datastore.eventCollection.get(e),
                    r = t.getLayoutViewClass();
                t.layoutView = new r({
                    eventModel: n
                }), t.layoutView.render();
                var i = n.getWorldModel();
                FF.SoundMgr.playMusic(i.get("bgm"))
            })
        }
    })
}), define("scenes/battle_fail/views/Layout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "templates/battle_fail/BattleFail", "scenes/common/views/ModalTermCheck", "scenes/common/helper/Relation", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return i.extend({
        contentType: "ONLY_NEXT_BTN",
        designType: "CLASSIC",
        events: {
            "anchorsbeforejump [data-app-next]": "onClickGoNext"
        },
        initialize: function(e) {
            this.tip = e.tip, this.kind = e.kind, this.isWorldExpired = e.isWorldExpired, this.worldModel = e.worldModel, this.dungeonModel = e.dungeonModel, i.prototype.initialize.call(this)
        },
        render: function(e) {
            i.prototype.render.call(this, s, {
                util: r,
                tip: this.tip,
                kind: this.kind,
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                buddyModels: FF.datastore.partyModel.getBuddyModels()
            }), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickGoNext: function() {
            var e = this;
            u.showModalIfNeedDeferred().done(function() {
                window.setTimeout(function() {
                    e.goNext()
                }, 300)
            })
        },
        goNext: function() {
            if (this.isWorldExpired) {
                var e = new o({
                    worldModel: this.worldModel || null
                });
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            } else {
                var t = this.worldModel.getDungeonListFragment({
                    isForce: this.dungeonModel.isForce()
                });
                n.history.navigate(t, {
                    trigger: !0
                })
            }
        }
    })
}), define("scenes/battle_fail/BattleFailScene", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/Scene", "./views/Layout", "scenes/common/models/Dungeon"], function(e, t, n, r, i, s, o) {
    return i.extend({
        start: function(e, t, n) {
            var i = this;
            r.battleFailDeferred(e, t, n).done(function(e) {
                var n = new o(e.dungeon),
                    r = FF.datastore.worldCollection.get(n.get("world_id"));
                i.layoutView = new s({
                    kind: t,
                    tip: e.tip,
                    isWorldExpired: e.is_world_expired,
                    dungeonModel: n,
                    worldModel: r
                }), i.layoutView.render()
            })
        }
    })
}), define("scenes/battle_list/views/ModalBattleDetail", ["underscore", "jquery", "backbone", "templates/battle_list/ModalBattleDetail", "scenes/common/helper/TermCheck", "lib/ModalBase", "scenes/battle_list/Api", "scenes/common/Config", "lib/BattleStorage", "lib/ErrorHandler"], function(e, t, n, r, i, s, o, u, a, f) {
    return s.extend({
        el: "[data-app-modal]",
        className: "tmp-battle-detail",
        tmpl: r,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-battle-start]": "onClickBattleStart",
            "click .s-user-status-detail": "onClickMockBattle"
        },
        initialize: function(e) {
            var t = FF.datastore;
            this.battleModel = e.battleModel, this.dungeonModel = e.dungeonModel, this.dungeonSessionModel = e.dungeonSessionModel, this.userModel = t.userModel, this.worldModel = e.worldModel, this.clickedBattleStart = !1
        },
        render: function(t) {
            var n = {
                battleModel: this.battleModel,
                dungeonModel: this.dungeonModel,
                dungeonSessionModel: this.dungeonSessionModel,
                userModel: this.userModel,
                staminaMap: this.getStaminaMap()
            };
            this.renderContent(this.tmpl, e.extend(n, t)), this.renderStaminaPiece()
        },
        renderStaminaPiece: function() {
            var e = this;
            t(this.el).find("[data-app-stamina-piece]").each(function(n, r) {
                var i = n + 1;
                e.userModel.get("residual_stamina_piece") >= i ? t(r).addClass("p-stamina-piece img-rep") : t(r).removeClass("p-stamina-piece img-rep")
            })
        },
        getStaminaMap: function() {
            var t = this.userModel.get("stamina"),
                n = e.max([this.userModel.get("max_stamina"), t]),
                r = this.battleModel.get("stamina"),
                i = t / n * 100,
                s = (t - r) / n * 100,
                o = {
                    staminaPer: i + "%",
                    requiredStaminaPer: s + "%"
                };
            if (t - r < 0) throw new Error("invalid stamina value.");
            return o
        },
        onClickModalClose: function() {
            if (this.clickedBattleStart) return;
            this.end()
        },
        onClickMockBattle: function() {
            if (!FF.env.isDevelop()) return;
            FF.router.loading.lock();
            var e = this,
                t = this.worldModel.getApiOptions();
            this.beginSessionDeferred(e.battleModel.get("id"), t).then(function() {
                FF.redirect("/dff/debug/#battle/mock")
            }), this.end()
        },
        onClickBattleStart: function() {
            FF.router.loading.lock();
            var e = this;
            if (this.clickedBattleStart) return;
            this.clickedBattleStart = !0, i.showModalIfClosedDeferred().done(function() {
                e._transit()
            })
        },
        _transit: function() {
            var e = this,
                t = this.worldModel.getApiOptions();
            this.beginSessionDeferred(e.battleModel.get("id"), t).then(function() {
                FF.router.loading.hide(!0), e.close(!0), e.trigger("onClickBattleStart", e.battleModel)
            })
        },
        beginSessionDeferred: function(e, n) {
            n = n || {};
            var r = void 0,
                i = void 0;
            return t.Deferred().resolve().promise().then(f.bindTryCatchDeferred(function() {
                return i = "3016", a.loadDeferred()
            })).then(f.bindTryCatchDeferred(function(t) {
                i = "3029", r = t;
                var s = FF.datastore.stash.beginBattleToken;
                return o.battleBeginSessionDeferred(e, s, n)
            })).then(f.bindTryCatchDeferred(function(e) {
                return i = "3032", r.reset(), r.setSessionKey(e.session_key), r.saveDeferred()
            })).then(f.bindTryCatchDeferred(function() {
                i = "3045";
                var t = r.getSessionKey();
                return o.battleBeginBattleDeferred(e, t, n)
            })).fail(function(e) {
                window.onErrorFunc(e, i)
            })
        }
    })
}), define("scenes/battle_list/views/ModalStaminaRecovery", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/ModalBase", "scenes/common/helper/TermCheck", "scenes/common/views/ModalRetry", "templates/battle_list/ModalStaminaRecovery", "templates/battle_list/ModalStaminaRecoveryConfirm", "templates/battle_list/ModalComplete"], function(e, t, n, r, i, s, o, u, a, f) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-recover-items]": "onClickRecoverItems",
            "anchorsbeforejump [data-app-recover-coin]": "onClickRecoverCoin",
            "anchorsbeforejump [data-app-items-confirm]": "onClickItemsConfirm",
            "anchorsbeforejump [data-app-guide]": "onClickGuide"
        },
        _coinNum: 0,
        initialize: function() {
            var e = this;
            i.prototype.initialize.apply(this, arguments), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                FF.router.loading.show(), e.setBalanceDeferred().done(function() {
                    e.render()
                })
            }, function() {})
        },
        setBalanceDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = {};
            return FF.env.isWWRegion() && (i.handleRetry = !0, i.ModalRetry = o), r.getBalanceDeferred(i).done(function(t) {
                e._coinNum = t, n.resolve()
            }), n.promise()
        },
        render: function() {
            this.renderContent(u, {
                userModel: FF.datastore.userModel,
                coinNum: this._coinNum,
                config: FF.Config.server.recover.stamina,
                showMobageLegal: FF.env.isShowingMobageLegal()
            }), FF.router.loading.hide(!0)
        },
        onClickModalClose: function() {
            this.end()
        },
        onClickRecoverItems: function() {
            this.$el.empty(), this.$el.html(a({
                config: FF.Config.server.recover.stamina
            }))
        },
        onClickItemsConfirm: function() {
            FF.router.loading.lock();
            var e = this;
            s.showModalIfClosedDeferred().done(function() {
                r.recoverStaminaDeferred().done(function(t) {
                    t.user.soul_piece = t.user.soul_piece - 1, FF.datastore.userModel.set(t.user), e.$el.html(f()), FF.router.loading.hide(!0)
                })
            })
        },
        onClickRecoverCoin: function() {
            FF.router.loading.lock();
            var e = this;
            s.showModalIfClosedDeferred().then(function() {
                var n = t.Deferred();
                return r.purchaseItemDeferred({
                    id: e._getPaymentProductId(),
                    quantity: 1
                }).done(function(t) {
                    var r = JSON.parse(t);
                    if (!r.success) throw new Error("faild_payment");
                    FF.datastore.userModel.set(r.payment_result.user), e.$el.empty(), FF.env.isWWRegion() ? (e.putContent(f()), FF.router.overlay.registerChildren(e), e.open()) : e.$el.html(f()), FF.router.loading.hide(!0), n.resolve()
                }).fail(function(e) {
                    FF.router.loading.unlock(), n.reject()
                }).always(function() {
                    FF.env.isWWRegion() && e && e.setBalanceDeferred()
                }), n.promise()
            })
        },
        _getPaymentProductId: function() {
            return FF.env.isWWRegion() ? {
                entryPointId: FF.Config.server.recover.stamina.payment.paymentProductId,
                price: FF.Config.server.recover.stamina.payment.payCost,
                modalOptions: {
                    confirmType: "stamina"
                }
            } : FF.Config.server.recover.stamina.payment.paymentProductId
        },
        onClickGuide: function() {
            kickmotor.nativefn.call("mobageLegal")
        },
        dispose: function() {
            kickmotor.platform.resetMobageDashboardListener(), i.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/battle_list/views/ModalNotEnoughMaxStamina", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/battle_list/ModalNotEnoughMaxStamina"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, {})
        },
        closeModal: function() {
            this.end()
        }
    })
}), define("scenes/battle_list/views/ModalEnemy", ["underscore", "jquery", "backbone", "util", "templates/battle_list/ModalEnemy", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    var a = {
        ADJUST_Y: 10
    };
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.dungeonModel = e.dungeonModel, this.enemyId = e.enemyId
        },
        render: function() {
            this.renderContent(i, {
                dungeonModel: this.dungeonModel
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new u({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        processAfterContentLoad: function() {
            var e = this;
            s.prototype.processAfterContentLoad.call(this), this.listenToOnce(this, "openAnimationEnd", function() {
                e.setupComponents(), FF.env.isWWRegion() ? t("[data-app-hidden-content]").removeClass("vi-h") : e.scrollByEnemyId(e.enemyId)
            }.bind(e))
        },
        scrollByEnemyId: function(e) {
            if (!e) return;
            var n = sprintf("[data-app-enemy-id=%s]", e);
            this.freescroll.scrollBySelector(n, {
                adjustY: a.ADJUST_Y
            }), this.listenToOnce(this.freescroll, "startedUp", function() {
                t("[data-app-hidden-content]").removeClass("vi-h")
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/ModalItemPossessionLimit", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/common/ModalItemPossessionLimit"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-btn-enhancement]": "onClickEnhancement",
            "anchorsbeforejump [data-app-btn-ability-decompose]": "onClickAbilityDecompose",
            "anchorsbeforejump [data-app-btn-inventory-equipment]": "onClickInventoryEquipment",
            "anchorsbeforejump [data-app-btn-inventory-ability]": "onClickInventoryAbility",
            "anchorsbeforejump [data-app-equipment-possession-limit-expand]": "onClickEquipPossessionLimitExpand",
            "anchorsbeforejump [data-app-ability-possession-limit-expand]": "onClickAbilityPossessionLimitExpand"
        },
        render: function(t) {
            t = e.extend(t, {
                itemPossessionLimitCollection: FF.datastore.itemPossessionLimitCollection
            }), this.renderContent(i, t)
        },
        onClickEnhancement: function() {
            this._navigateWithBackFragment("#party/enhancement_base_select")
        },
        onClickAbilityDecompose: function() {
            this._navigateWithBackFragment("#party/ability_decompose")
        },
        onClickInventoryEquipment: function() {
            this._navigateWithBackFragment("#party/inventory")
        },
        onClickInventoryAbility: function() {
            this._navigateWithBackFragment("#party/inventory/ability")
        },
        _navigateWithBackFragment: function(e) {
            this.end(), FF.router.navigate(e, {
                trigger: !0,
                params: {
                    backFragment: location.hash
                }
            })
        },
        onClickEquipPossessionLimitExpand: function() {
            this._navigate("#party/possession_limit_expand/equipment")
        },
        onClickAbilityPossessionLimitExpand: function() {
            this._navigate("#party/possession_limit_expand/ability")
        },
        _navigate: function(e) {
            FF.router.loading.lock(), this.end(), n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickClose: function() {
            this.end(), FF.router.loading.hide()
        }
    })
}), define("scenes/common/helper/ItemPossessionLimit", ["jquery", "underscore", "backbone", "scenes/common/views/ModalItemPossessionLimit"], function(e, t, n, r) {
    var i = {
            IS_OVER: {
                TYPE: 1,
                FUNC: "isOverLimit"
            },
            IS_OVER_OR_MAX: {
                TYPE: 2,
                FUNC: "isOverOrMaxLimit"
            }
        },
        s = function(e, t) {
            var n = new r;
            FF.router.overlay.registerChildren(n), n.render({
                itemPossessionLimitModels: e,
                conditionInfo: t,
                MODAL_OPEN_CONDITION_INFO_OF: i
            }), n.open()
        },
        o = function(r, i) {
            i = i || {};
            var o = e.Deferred(),
                u;
            i.itemTypeNames ? (i.itemTypeNames = t.map(i.itemTypeNames, function(e) {
                return e.toLowerCase()
            }), u = FF.datastore.itemPossessionLimitCollection.filter(function(e) {
                return t.contains(i.itemTypeNames, e.get("item_type_name").toLowerCase())
            })) : u = FF.datastore.itemPossessionLimitCollection.models;
            var a = t.some(u, function(e) {
                return e[r.FUNC]()
            });
            return a ? (i.currentModal ? n.Events.listenToOnce(i.currentModal, "closeAnimationEnd", function() {
                s(u, r)
            }) : s(u, r), o.reject({
                rejectedByItemPossessionLimitHelper: !0
            })) : o.resolve(), o.promise()
        };
    return {
        showModalIfOverLimitDeferred: function(e) {
            return o(i.IS_OVER, e)
        },
        showModalIfOverOrMaxLimitDeferred: function(e) {
            return o(i.IS_OVER_OR_MAX, e)
        },
        openModal: s
    }
}), define("scenes/battle_list/ab/views/BridgeView", ["underscore", "jquery", "backbone", "util", "lib/ClassBase", "lib/ab/ABNode", "scenes/common/ab/view/ABViewBase"], function(e, t, n, r, i, s, o) {
    var u = -1,
        a = ["bridge_a_img_6", "bridge_a_img_5", "bridge_a_img_4", "bridge_a_img_3", "bridge_a_img_2", "bridge_a_img_1"],
        f = ["bridge_b_img_6", "bridge_b_img_5", "bridge_b_img_4", "bridge_b_img_3", "bridge_b_img_2", "bridge_b_img_1"],
        l = {
            MAIN_NODE_SHORT: "platform_bridge_a_right",
            MAIN_NODE_LONG: "platform_bridge_b_right",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_bridge_a_r_pos",
            STEEPLY_BRIDGE_POSITION: "platform_bridge_b_r_pos"
        },
        c = {
            MAIN_NODE_SHORT: "platform_bridge_a_left",
            MAIN_NODE_LONG: "platform_bridge_b_left",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_bridge_a_l_pos",
            STEEPLY_BRIDGE_POSITION: "platform_bridge_b_l_pos"
        },
        h = {
            MAIN_NODE_SHORT: "platform_boss_bridge_a_right",
            MAIN_NODE_LONG: "platform_boss_bridge_b_right",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_boss_bridge_a_r_pos",
            STEEPLY_BRIDGE_POSITION: "platform_boss_bridge_b_r_pos"
        },
        p = {
            MAIN_NODE_SHORT: "platform_boss_bridge_a_left",
            MAIN_NODE_LONG: "platform_boss_bridge_b_left",
            PARTS_SHALLOW: "bridge_a",
            PARTS_STEEPLY: "bridge_b",
            SHALLOW_BRIDGE_POSITION: "platform_boss_bridge_a_l_pos",
            STEEPLY_BRIDGE_POSITION: "platform_boss_bridge_b_l_pos"
        },
        d = {
            NORMAL: "normal",
            SP_ENEMY: "spEnemy"
        },
        v = {
            LEFT: "left",
            RIGHT: "right"
        },
        m = {
            NORMAL: "init",
            CLEAR_ANIM: "clear_area",
            CLEARED: "clear_area_end"
        },
        g = o.extend({
            initialize: function(e, t, n, r, i, s, a) {
                u = (u + 1) % 1e6, this._instanceCnt = u, this._bridgeType = n, this._isShallowAngleBridge = r, this._bridgeDir = i, this._topNodeName = s, this._duplicateFromlayerName = a, this._resolveParams(), o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                o.prototype.dispose.apply(this)
            },
            _resolveParams: function() {
                switch (this._bridgeType) {
                    case d.NORMAL:
                        this._bridgeDir === v.LEFT ? this._params = c : this._bridgeDir === v.RIGHT && (this._params = l);
                        break;
                    case d.SP_ENEMY:
                        this._bridgeDir === v.LEFT ? this._params = p : this._bridgeDir === v.RIGHT && (this._params = h)
                }
            },
            _drawView: function() {
                return this._ab.mainNode = (new s({
                    layer: this.getLayerName(),
                    name: this._isShallowAngleBridge ? this._params.MAIN_NODE_SHORT : this._params.MAIN_NODE_LONG,
                    topNodeName: this._topNodeName
                })).setVisible(!0), this._ab.mainNode
            },
            isLeftBridge: function() {
                return this._bridgeDir === v.LEFT
            },
            isRightBridge: function() {
                return this._bridgeDir === v.RIGHT
            },
            isShallowAngleBridge: function() {
                return this._isShallowAngleBridge
            },
            isSteeplyAngleBridge: function() {
                return !this._isShallowAngleBridge
            },
            showBridge: function(e) {
                this._isShallowAngleBridge ? this._showBridge(this._params.PARTS_SHALLOW, this._params.SHALLOW_BRIDGE_POSITION, a, e ? 1 : .5) : this._showBridge(this._params.PARTS_STEEPLY, this._params.STEEPLY_BRIDGE_POSITION, f, 1), this._updateBridge(!1)
            },
            _showBridge: function(t, n, r, i) {
                var o = this;
                if (!t || !n) return;
                var u = sprintf("%s__%s", n, this._instanceCnt),
                    a = this._ab[u] = (new s({
                        name: u,
                        layer: this._duplicateFromlayerName,
                        duplicateFrom: t,
                        duplicateFromOptions: {
                            visualParentLayer: this.getLayerName(),
                            visualParentNode: n,
                            visualParentTopNode: this._topNodeName
                        }
                    })).setVisible(!0);
                this._flush();
                var f = Math.abs(i * r.length);
                e.each(r, function(e, t) {
                    (new s({
                        name: e,
                        topNodeName: u,
                        layer: o._duplicateFromlayerName
                    })).setVisible(t + 1 <= f).process()
                }), this._ab.mainNode.setVisible(!0)
            },
            hideBridge: function() {
                this._ab.mainNode.setVisible(!1).process()
            },
            _updateBridge: function(e) {
                var t = e ? m.CLEAR_ANIM : m.CLEARED;
                if (this._lastTag === t) return;
                this._lastTag = t, this._lastTag && this._ab.mainNode.play(this._lastTag, {
                    autoRemove: !1
                }).process()
            },
            playBridgeEffect: function() {
                this._updateBridge(!0)
            },
            setTouchEnabled: function(e) {}
        }, {
            BRIDGE_DIRECTION: v,
            BRIDGE_TYPE: d
        });
    return g
}), define("scenes/battle_list/ab/views/PlatformView", ["underscore", "jquery", "backbone", "util", "lib/ClassBase", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase", "scenes/common/ab/misc/ABViewUtil", "./BridgeView"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = -1,
        c = {
            CHAR_SCALE: 1.5
        },
        h = {
            PLATFORM_TOUCHED: "platform_touched",
            INFO_TOUCHED: "info_touched",
            INFO_LONG_PRESSED: "info_long_pressed"
        },
        p = ["txt_0", "txt_3", "txt_4", "txt_5"],
        d = {
            TOUCH_START: void 0,
            TOUCH_END: "btn_touch",
            TOUCH_CANCEL: void 0,
            DISABLED: "btn_lock"
        },
        v = {
            LOCKED: "close_area_end",
            OPEN_AREA: "open_area",
            SELECTED: "open_area_end",
            UNLOCKING_EFFECT: "clear_area",
            UNLOCKED: "clear_area_end"
        },
        m = {
            NONE: "init",
            MAGIC_CIRCLE_SELECTED: "open_area_loop",
            MAGIC_CIRCLE: "clear_area_end"
        },
        g = {
            BOSS_DARKEN: "boss_darken"
        },
        y = {
            TOP_NODE: "stage",
            SOURCE_NODE: "platform_exit",
            PARENT_NODE: "list_pos",
            TOUCH_NODE: "platform_exit_visible_touch",
            PLATFORM_STAGE_NODE: "platform_exit_stage_pos",
            PLATFORM_EFFECT_NODES: ["platform_exit_effects_loop"],
            HIDE_NODES_AT_BATTLE_START: [],
            HIDE_NODE_WHEN_DISABLED: "platform_exit_gate",
            PLATFORM_TOUCH_EFFECT_NODE: "platform_exit_btn_eff",
            PLATFORM_CHARA_STAGE_NODE: void 0,
            PLATFORM_INFO_NODE: void 0,
            CLOUDS_PARTS_NODES: void 0,
            EVALETION_NODE: void 0,
            EVALUATION_EFFECT_NODES: void 0,
            BRIDGE_EFFECT_R: void 0,
            BRIDGE_EFFECT_L: void 0,
            BRIDGE_EFFECT_SHALLOW_R: void 0,
            BRIDGE_EFFECT_SHALLOW_L: void 0,
            TITLE_TEXT: void 0,
            BATTLE_NUM_TEXT: void 0,
            STAMINA_NUM_TEXT: void 0,
            STAGE_PARTS_NODE: void 0,
            ENEMY_CONTAINER: void 0,
            CHARA_NODE: "platform_exit_anm",
            BTN_INFO_NODE: void 0,
            NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT: 0
        },
        b = {
            TOP_NODE: "stage",
            SOURCE_NODE: "platform_normal",
            PARENT_NODE: "list_pos",
            TOUCH_NODE: "platform_normal_visible_touch",
            PLATFORM_STAGE_NODE: "platform_normal_stage_pos",
            PLATFORM_EFFECT_NODES: ["platform_normal_anm", "platform_normal_evaluation_default", "platform_normal_chara_stage_particle"],
            HIDE_NODES_AT_BATTLE_START: ["platform_normal_effects_loop", "platform_normal_stage_eff_front_particle"],
            HIDE_NODE_WHEN_DISABLED: void 0,
            PLATFORM_TOUCH_EFFECT_NODE: "platform_normal_btn_eff",
            PLATFORM_CHARA_STAGE_NODE: "platform_normal_chara_stage",
            PLATFORM_INFO_NODE: "platform_normal_info",
            CLOUDS_PARTS_NODES: ["platform_normal_clouds_img_01", "platform_normal_clouds_img_02"],
            EVALETION_NODE: "platform_normal_evaluation_sprite",
            EVALUATION_EFFECT_NODES: [void 0, "platform_normal_evaluation_eff_1", "platform_normal_evaluation_eff_2", "platform_normal_evaluation_eff_3"],
            BRIDGE_EFFECT_R: "platform_bridge_b_right",
            BRIDGE_EFFECT_L: "platform_bridge_b_left",
            BRIDGE_EFFECT_SHALLOW_R: "platform_bridge_a_right",
            BRIDGE_EFFECT_SHALLOW_L: "platform_bridge_a_left",
            TITLE_TEXT: "platform_normal_info2_txt",
            BATTLE_NUM_TEXT: "platform_normal_info_battle_txt",
            STAMINA_NUM_TEXT: "platform_normal_info_stamina_txt",
            STAGE_PARTS_NODE: "stage",
            ENEMY_CONTAINER: void 0,
            CHARA_NODE: "platform_normal_chara",
            BTN_INFO_NODE: void 0,
            NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT: 1
        },
        w = {
            TOP_NODE: "stage",
            SOURCE_NODE: "platform_boss",
            PARENT_NODE: "list_pos",
            TOUCH_NODE: "platform_boss_visible_touch",
            PLATFORM_STAGE_NODE: "platform_boss_stage_pos",
            PLATFORM_EFFECT_NODES: ["platform_boss_anm", "platform_boss_evaluation_default"],
            HIDE_NODES_AT_BATTLE_START: ["platform_boss_effects_loop", "platform_normal_stage_eff_front_particle_02"],
            HIDE_NODE_WHEN_DISABLED: void 0,
            PLATFORM_TOUCH_EFFECT_NODE: "platform_boss_btn_eff",
            PLATFORM_CHARA_STAGE_NODE: "platform_boss_chara_stage",
            PLATFORM_INFO_NODE: "platform_boss_info",
            CLOUDS_PARTS_NODES: ["platform_boss_clouds_img_01", "platform_boss_clouds_img_02"],
            EVALETION_NODE: "platform_boss_evaluation_sprite",
            EVALUATION_EFFECT_NODES: [void 0, "platform_boss_evaluation_eff_1", "platform_boss_evaluation_eff_2", "platform_boss_evaluation_eff_3"],
            BRIDGE_EFFECT_R: "platform_boss_bridge_b_right",
            BRIDGE_EFFECT_L: "platform_boss_bridge_b_left",
            BRIDGE_EFFECT_SHALLOW_R: "platform_boss_bridge_a_right",
            BRIDGE_EFFECT_SHALLOW_L: "platform_boss_bridge_a_left",
            TITLE_TEXT: "platform_boss_info2_txt",
            BATTLE_NUM_TEXT: "platform_boss_info_battle_txt",
            STAMINA_NUM_TEXT: "platform_boss_info_stamina_txt",
            STAGE_PARTS_NODE: "stage_boss",
            ENEMY_CONTAINER: "platform_boss_monster",
            CHARA_NODE: "platform_boss_chara",
            BTN_INFO_NODE: "btn_platform_boss",
            NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT: 2
        },
        E = u.extend({
            initialize: function(e, t, n, r, i, s, o) {
                l = (l + 1) % 1e6, this._instanceCnt = l, e += "_" + this._instanceCnt, this._hasSpEnemy = t && t.get("has_boss") === 1, this._isUnlocked = i, this._isExit = !!s, this._isCurrent = !!o, this._params = y, this._effectNodes = [], this._evaluation_effectNodes = [], this._hideNodes = [], this._isExit || (this._params = this._hasSpEnemy ? w : b), this._resourceLayer = r, u.prototype.initialize.apply(this, [e, n]), this._applyModel(t)
            },
            dispose: function() {
                this._model = void 0, this._bridgeR && this._bridgeR.dispose(), this._bridgeR = void 0, this._bridgeL && this._bridgeL.dispose(), this._bridgeL = void 0, this._ab && this._ab.touchNode && this._ab.touchNode.removeAllCallback(), this.button.dispose(), this.infoBtn && this.infoBtn.dispose(), this._effectNodes = void 0, this._evaluation_effectNodes = void 0, this._hideNodes = void 0, u.prototype.dispose.apply(this)
            },
            getBattleModel: function() {
                return this._model
            },
            hasSpEnemy: function() {
                return this._hasSpEnemy
            },
            isExit: function() {
                return this._isExit
            },
            isCurrent: function() {
                return this._isCurrent
            },
            isUnlocked: function() {
                return this._isExit || this._isUnlocked
            },
            canTouchSelect: function() {
                return this.isCurrent() || this.isUnlocked()
            },
            getTopNodeName: function() {
                return this._ab.mainNode.name
            },
            getSpEnemyContainerNodeName: function() {
                return this._params.ENEMY_CONTAINER
            },
            _drawView: function() {
                var t = this;
                return this._ab.mainNode = (new s({
                    name: sprintf(this._params.SOURCE_NODE + "_%s", this._instanceCnt),
                    layer: this.getLayerName(),
                    duplicateFrom: this._params.SOURCE_NODE,
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._params.PARENT_NODE,
                        visualParentTopNode: this._params.TOP_NODE
                    }
                })).setVisible(!0), this._params.ENEMY_CONTAINER && (this._ab.enemyContainer = this._ab.mainNode.createChildNode(this._params.ENEMY_CONTAINER)), this._params.STAGE_PARTS_NODE && (this._ab.stage = (new s({
                    name: sprintf(this._params.STAGE_PARTS_NODE + "_%s", this._instanceCnt),
                    layer: this._resourceLayer.layerName,
                    duplicateFrom: this._params.STAGE_PARTS_NODE,
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._params.PLATFORM_STAGE_NODE,
                        visualParentTopNode: this._ab.mainNode.name
                    }
                })).setVisible(!0)), this._params.EVALUATION_EFFECT_NODES && e.each(this._params.EVALUATION_EFFECT_NODES, function(e, n) {
                    if (e === void 0) t._evaluation_effectNodes.push(void 0);
                    else {
                        var r = t._ab["evaluation_effectNode_" + n] = t._ab.mainNode.createChildNode(e).setVisible(!1);
                        t._evaluation_effectNodes.push(r)
                    }
                }), this._params.PLATFORM_EFFECT_NODES && e.each(this._params.PLATFORM_EFFECT_NODES, function(e, n) {
                    var r = t._ab["effectNode_" + n] = t._ab.mainNode.createChildNode(e).setVisible(!0);
                    t._effectNodes.push(r)
                }), this._params.HIDE_NODES_AT_BATTLE_START && e.each(this._params.HIDE_NODES_AT_BATTLE_START, function(e, n) {
                    var r = t._ab["hideNode_" + n] = t._ab.mainNode.createChildNode(e);
                    t._hideNodes.push(r)
                }), this._params.PLATFORM_CHARA_STAGE_NODE && (this._ab.charaStageNode = this._ab.mainNode.createChildNode(this._params.PLATFORM_CHARA_STAGE_NODE).setVisible(!0)), this._params.PLATFORM_INFO_NODE && (this._ab.infoNode = this._ab.mainNode.createChildNode(this._params.PLATFORM_INFO_NODE).setVisible(!0)), this._ab.touchNode = this._ab.mainNode.createChildNode(this._params.TOUCH_NODE, {
                    topNodeName: this._ab.mainNode.name
                }).setVisible(!0), this._ab.touchEffectNode = this._ab.mainNode.createChildNode(this._params.PLATFORM_TOUCH_EFFECT_NODE, {
                    topNodeName: this._ab.mainNode.name
                }).setVisible(!0), this.button = new o(this._ab.mainNode, this._ab.mainNode.name, void 0, this._ab.touchNode.name), this.button.setButtonStateTags(void 0, void 0, void 0), this.button.setTouchHandler(function(e, n) {
                    if (a.isDragTap(n)) return;
                    if (!t.canTouchSelect()) {
                        FF.SoundMgr.playNgEffect();
                        return
                    }
                    t.trigger(h.PLATFORM_TOUCHED, t)
                }), this._params.BTN_INFO_NODE && (this._ab.infoBtnNode = this._ab.mainNode.createChildNode(this._params.BTN_INFO_NODE).setVisible(!0), this.infoBtn = new o(this._ab.infoBtnNode), this.infoBtn.setButtonStateTags(d.TOUCH_END, void 0, void 0), this.infoBtn.setTouchHandler(function(e, n) {
                    if (a.isDragTap(n)) return;
                    t.trigger(h.INFO_TOUCHED, t)
                }), this.infoBtn.setLongPressHandler(function(e) {
                    t.trigger(h.INFO_LONG_PRESSED, t)
                }, 3e3), this.infoBtn.ignoreTouchEnter()), this._ab.mainNode
            },
            _getBridgeType: function() {
                var e = void 0;
                return this._isExit || (e = this._hasSpEnemy ? f.BRIDGE_TYPE.SP_ENEMY : f.BRIDGE_TYPE.NORMAL), e
            },
            playSelectedAnimationDeferred: function() {
                var e = this;
                return this._playEffectDeferred(d.TOUCH_END).then(function() {
                    e._hasTargetEfefct && (e._playEffect(m.MAGIC_CIRCLE_SELECTED), e._flush())
                }), this._ab.touchEffectNode.play(d.TOUCH_END), this._flush(), this._ab.mainNode.play(d.TOUCH_END).processDeferred("action_stop", {
                    tag: d.TOUCH_END
                })
            },
            showRightBridge: function(e, t) {
                var n = this._getBridgeType();
                if (!n || this._bridgeR) return;
                this._bridgeR = new f(this.name + "_bridgeR", this.getLayer(), n, e, f.BRIDGE_DIRECTION.RIGHT, this._ab.mainNode.name, this._resourceLayer.layerName), this._bridgeR.showBridge(t)
            },
            showLeftBridge: function(e, t) {
                var n = this._getBridgeType();
                if (!n || this._bridgeL) return;
                this._bridgeL = new f(this.name + "_bridgeL", this.getLayer(), n, e, f.BRIDGE_DIRECTION.LEFT, this._ab.mainNode.name, this._resourceLayer.layerName), this._bridgeL.showBridge(t)
            },
            showTargetEfefct: function(e) {
                FF.logger.debug("target :", this.isExit() ? "exit" : this._model.get("name")), this._hasTargetEfefct = e, this._updateView()
            },
            playUnlockEffectDeferred: function() {
                return this._playBridgeEffect(v.OPEN_AREA), this._playEffectDeferred(v.OPEN_AREA, !1)
            },
            playClearEffectDeferred: function() {
                return this._playEffect(v.UNLOCKING_EFFECT, !1), this._updateStageNodeDeferred(v.UNLOCKING_EFFECT, !1)
            },
            insertCharactor: function(e, t) {
                if (!this._params.CHARA_NODE) return;
                if (this._ab.charactorNode) return;
                this._ab.mainNode.createChildNode(this._params.CHARA_NODE).setVisible(!0).process();
                var n = sprintf("character_nul_%s", this._instanceCnt);
                this._ab.charactorNode = (new s({
                    name: n,
                    layer: t.layerName,
                    duplicateFrom: "character_nul",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._params.CHARA_NODE,
                        visualParentTopNode: this._ab.mainNode.name
                    }
                })).setParam({
                    color_change_parent: n
                }).setScale([c.CHAR_SCALE, c.CHAR_SCALE]).loadBundle(e.bundle).setSpriteAnimeByNode("sprite_character_base", e.assetPath).setSpriteAnimeByNode("sprite_character_add", e.assetPath).setVisible(!0).play("walk").setSASpeed(.25).process()
            },
            changeLockedTemporary: function() {
                this._updateView(!0)
            },
            changeExtremeEventMode: function() {
                if (!this._hasSpEnemy) return;
                this._ab.mainNode.setVisibleByNode("platform_boss_eff_img", !1).setVisibleByNode("platform_boss_btn_eff_img", !1).setVisibleByNode("platform_boss_stage_circle_rotate_img", !1).setVisibleByNode("platform_boss_eff_chaos_img", !0).setVisibleByNode("platform_boss_btn_chaos_eff_img", !0).setVisibleByNode("platform_boss_stage_circle_rotate_chaos_img", !0).process()
            },
            darkenEnemyContainer: function() {
                this._ab.enemyContainer && this._ab.enemyContainer.play(g.BOSS_DARKEN, {
                    autoRemove: !1
                }).process()
            },
            setInfoBtnDisabled: function() {
                this.infoBtn && (this.infoBtn.setEnabled(!1), this.infoBtn.baseNode.play(d.DISABLED).setVisible(!1).process())
            },
            hideEffects: function() {
                this._ab.mainNode.suspendParticle({
                    descendant: !0
                }).process(), e.each(this._hideNodes, function(e, t) {
                    e.suspendParticle({
                        descendant: !0
                    }).setVisible(!1).process()
                }), this._playEffect(m.NONE)
            },
            _updateView: function(e) {
                var t = this,
                    n = this.isUnlocked() && !e;
                n ? (this._playEffect(t._hasTargetEfefct ? m.MAGIC_CIRCLE_SELECTED : m.MAGIC_CIRCLE, !1), this._updateStageNode(v.UNLOCKED, !1)) : (this._playEffect(t._hasTargetEfefct ? m.MAGIC_CIRCLE_SELECTED : m.NONE, !1), this.isCurrent() ? this._updateStageNode(v.SELECTED, !1) : this._updateStageNode(v.LOCKED, !1)), this._flush()
            },
            _playEffect: function(t, n) {
                FF.logger.debug("_playEffect", t), e.each(this._effectNodes, function(e, r) {
                    e.play(t, {
                        autoRemove: n
                    }).setVisible(!0)
                })
            },
            _playEffectDeferred: function(n, r) {
                FF.logger.debug("_playEffectDeferred", n);
                var i = this._params.NUM_PROMISE_FOR_UNLOCK_EFFECT_WAIT,
                    s = t.Deferred();
                return e.each(this._effectNodes, function(e, t) {
                    var o = e.play(n, {
                        autoRemove: r
                    }).processDeferred("action_stop", {
                        tag: n
                    });
                    o.then(function() {
                        --i === 0 && s.resolve()
                    })
                }), s.promise()
            },
            _updateStageNodeDeferred: function(e, n) {
                return this._ab.charaStageNode ? (this._updateStageNode(e, n), this._ab.charaStageNode.processDeferred("action_stop", {
                    tag: e
                })) : t.Deferred().resolve().promise()
            },
            _updateStageNode: function(e, t) {
                this._ab.charaStageNode && this._ab.charaStageNode.play(e, {
                    autoRemove: t
                }), this._ab.infoNode && this._ab.infoNode.play(e, {
                    autoRemove: t
                })
            },
            _playBridgeEffect: function(e) {
                var t;
                this._bridgeR ? (t = this._bridgeR.isShallowAngleBridge() ? this._params.BRIDGE_EFFECT_SHALLOW_R : this._params.BRIDGE_EFFECT_R, this._bridgeR.playBridgeEffect()) : this._bridgeL && (t = this._bridgeL.isShallowAngleBridge() ? this._params.BRIDGE_EFFECT_SHALLOW_L : this._params.BRIDGE_EFFECT_L, this._bridgeL.playBridgeEffect()), t && this._ab.mainNode.createChildNode(t).play(e).process()
            },
            _applyModel: function(e) {
                this._model = e, this._isExit ? (this._ab.mainNode.createChildNode("platform_exit_gate").setVisible(!0).process(), this.setTouchEnabled(!0)) : this._model && (this._setEvaluationRank(this._model.get("rank")), this._setTitle(this._model.get("name")), this._setRoundNum(this._model.get("round_num")), this._setStaminaNum(this._model.get("stamina")), this.setTouchEnabled(!0)), this._updateView()
            },
            _setEvaluationRank: function(t) {
                if (!this._params.EVALETION_NODE) return;
                t = this._isCurrent ? 0 : t;
                var n = p[t] || p[0];
                this._ab.mainNode.setSpriteActionByNode(this._params.EVALETION_NODE, n).setVisible(!0).process(), e.each(this._evaluation_effectNodes, function(e, n) {
                    if (e) {
                        var r = n === t;
                        FF.logger.debug(n, t, r), e.setVisible(r).process()
                    }
                })
            },
            _setTitle: function(e) {
                this._params.TITLE_TEXT && this._ab.mainNode.setText(this._params.TITLE_TEXT, e).process()
            },
            _setRoundNum: function(e) {
                this._params.BATTLE_NUM_TEXT && this._ab.mainNode.setText(this._params.BATTLE_NUM_TEXT, "" + e).process()
            },
            _setStaminaNum: function(e) {
                this._params.STAMINA_NUM_TEXT && this._ab.mainNode.setText(this._params.STAMINA_NUM_TEXT, "" + e).process()
            },
            _updateTouchEnabled: function() {
                this.button.setEnabled(this.isTouchEnabled()), this._params.HIDE_NODE_WHEN_DISABLED && this._ab.mainNode.createChildNode(this._params.HIDE_NODE_WHEN_DISABLED).setVisible(this.isTouchEnabled()).process()
            }
        }, {
            EVENTS: h,
            createExitPlatform: function(e, t) {
                return new E("platform_exit", void 0, e, t, !0, !0, !1)
            },
            createPlatform: function(e, t, n, r, i) {
                return new E("platform", e, t, n, r, !1, i)
            }
        });
    return E
}), define("scenes/battle_list/ab/misc/SpEnemyPlacementLogic", ["underscore", "jquery", "backbone", "util", "lib/ClassBase"], function(e, t, n, r, i) {
    function o() {
        return {
            baseX: 0,
            baseY: 10,
            marginX: 0
        }
    }
    var s = {
            NORMAL: 0,
            PARALLEL_NARROW: 1,
            PARALLEL: 2,
            PARALLEL_WIDE: 3,
            PARALLEL_MORE_WIDE: 4,
            PARALLEL_NARROW_DEPTH_R: 11,
            PARALLEL_DEPTH_R: 12,
            PARALLEL_WIDE_DEPTH_R: 13,
            PARALLEL_MORE_WIDE_DEPTH_R: 14,
            BOSS_410007: 1001
        },
        u = i.extend({
            initialize: function(t, n) {
                this._logicfunc = t, this._params = o(), e.extend(this._params, n)
            },
            placeEnemies: function(e) {
                this._logicfunc(e, this._params)
            }
        }, {
            TYPES: s,
            create: function(e) {
                return a[e]
            }
        }),
        a = [];
    a[s.NORMAL] = new u(function(t, n) {
        e.each(t, function(e, t) {
            e.getNodePos(function(n) {
                FF.logger.debug("####" + t + " pos " + e.name, n.pos[0])
            })
        })
    });
    var f = function(t, n) {
        var r = t.length,
            i = r === 1 ? 0 : -r * n.marginX * .5;
        e.each(t, function(e, t) {
            e.setPosition([n.baseX + i + t * n.marginX, n.baseY]).setZOrder(-t * (n.depthReverse ? -1 : 1)).process()
        })
    };
    return a[s.PARALLEL_NARROW] = new u(f, {
        marginX: 30
    }), a[s.PARALLEL] = new u(f, {
        marginX: 40
    }), a[s.PARALLEL_WIDE] = new u(f, {
        marginX: 50
    }), a[s.PARALLEL_MORE_WIDE] = new u(f, {
        marginX: 60
    }), a[s.PARALLEL_NARROW_DEPTH_R] = new u(f, {
        marginX: 30,
        depthReverse: !0
    }), a[s.PARALLEL_DEPTH_R] = new u(f, {
        marginX: 40,
        depthReverse: !0
    }), a[s.PARALLEL_WIDE_DEPTH_R] = new u(f, {
        marginX: 50,
        depthReverse: !0
    }), a[s.PARALLEL_MORE_WIDE_DEPTH_R] = new u(f, {
        marginX: 60,
        depthReverse: !0
    }), a[s.BOSS_410007] = new u(function(e, t) {
        e[1].setPosition([1, -12]).process(), e[2].setPosition([8, 15]).process()
    }), u
}), define("scenes/battle_list/ab/views/SpEnemyView", ["underscore", "jquery", "backbone", "util", "lib/EventBase", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase", "scenes/common/ab/misc/ABViewUtil", "../misc/SpEnemyPlacementLogic", "scenes/common/models/BattleListSpEnemy", "scenes/common/models/BattleListSpEnemyAdjustment"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
            TOUCH_START: "touchStart",
            TOUCH_END: "touchEnd"
        },
        p = u.extend({
            initialize: function(e, t, n) {
                this._platformView = n, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this._platformView = void 0, u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                var e = this.getLayerName(),
                    t = this._platformView.getLayerName(),
                    n = this._platformView.getTopNodeName(),
                    r = this._platformView.getSpEnemyContainerNodeName();
                return this._ab.group = (new s({
                    name: sprintf("alter_ab_for_%s", n),
                    layer: e,
                    duplicateFrom: "visible_nul",
                    duplicateFromOptions: {
                        visualParentLayer: t,
                        visualParentNode: r,
                        visualParentTopNode: n
                    }
                })).setVisible(!0), this._ab.group
            },
            playTagDeferred: function(e) {
                return this._ab.group.play(e, {}).processDeferred("action_stop")
            },
            suspendParticle: function() {
                this._ab.group.suspendParticle({
                    descendant: !0
                }).process()
            }
        }),
        d = u.extend({
            initialize: function(e, t, n, r) {
                this.structure = r, this._platformView = n, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this.structure = void 0, this._platformView = void 0, u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                var e = this.getLayerName(),
                    t = this._platformView.getLayerName(),
                    n = this._platformView.getTopNodeName(),
                    r = this._platformView.getSpEnemyContainerNodeName();
                return this._ab.container = (new s({
                    name: "base_visible_nul",
                    layer: e
                })).setVisible(!1), this._ab.group = (new s({
                    name: sprintf("character_group_nul_for_%s", n),
                    layer: e,
                    duplicateFrom: "character_group_nul",
                    duplicateFromOptions: {
                        visualParentLayer: t,
                        visualParentNode: r,
                        visualParentTopNode: n
                    }
                })).setVisible(!0), this._ab.group
            },
            playTagDeferred: function(e) {
                return this._ab.group.play(e, {}).processDeferred("action_stop")
            },
            getSubViewParentName: function() {
                return this._ab.group.name
            }
        }),
        v = u.extend({
            initialize: function(e, t, n) {
                this.structure = n, u.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this.structure = void 0, this._positionBaseNode = void 0, this._ab && this._ab.touchNode && this._ab.touchNode.removeAllCallback(), u.prototype.dispose.apply(this)
            },
            _drawView: function() {
                return void 0
            },
            setParant: function(e) {
                var t = this.structure.getChildPosId(),
                    n = sprintf("character_group_pos_nul_%s", t),
                    r = e.getSubViewParentName(),
                    i = e.getLayerName();
                this._ab.character = (new s({
                    name: sprintf("character_nul_%s_%s", t, r),
                    layer: this.getLayerName(),
                    duplicateFrom: "character_nul",
                    duplicateFromOptions: {
                        visualParentLayer: i,
                        visualParentNode: n,
                        visualParentTopNode: r
                    }
                })).setVisible(!0).play("idle"), this._ab.characterOrg = (new s({
                    name: "character_nul",
                    layer: this.getLayerName()
                })).setVisible(!1), this._positionBaseNode = new s({
                    layer: i,
                    name: n,
                    topNodeName: r
                }), this._ab.motionNode = this._ab.character.createChildNode("character_motion_nul").setVisible(!0), this._ab.motionAddNode = this._ab.character.createChildNode("character_motion_nul_add").setVisible(!0), this._ab.touchNode = this._ab.character.createChildNode("character_visible_touch"), this._topNode = this._ab.character, this._flush()
            },
            hideSubView: function() {
                this._positionBaseNode.setVisible(!1).process()
            },
            suspendParticle: function() {
                this._ab.character.suspendParticle({
                    descendant: !0
                }).process()
            },
            getPositionBaseNode: function() {
                return this._positionBaseNode
            },
            playTagDeferred: function(e) {
                return this._ab.character.play(e, {}).processDeferred("action_stop")
            },
            playTagToParts: function(e, t, n) {
                t === void 0 && (t = 0);
                if (n === void 0 || n < 1) n = 1;
                this._ab.motionNode.play(e, {
                    startRatio: t,
                    speed: n
                }), this._ab.motionAddNode.play(e, {
                    startRatio: t,
                    speed: n
                }), this._flush()
            },
            setTouchBegan: function(e) {
                this._setTouchEvent("action_touch_began", e)
            },
            setTouchEnded: function(e) {
                this._setTouchEvent("action_touch_ended", e)
            },
            _setTouchEvent: function(e, t) {
                var n = this;
                this._ab.touchNode.addCallback(e, function(e) {
                    t(e)
                })
            },
            _updateTouchEnabled: function() {
                var e = this.isTouchEnabled();
                this._ab.touchNode.setVisible(e).process()
            }
        }),
        m = i.extend({
            initialize: function() {
                this._mainView = void 0, this._subViews = []
            },
            dispose: function() {
                this._mainView && this._mainView.dispose(), this._mainView = void 0, e.each(this._subViews, function(e) {
                    e.dispose()
                }), this._subViews = void 0, this._alterABView && this._alterABView.dispose(), this._alterABView = void 0, this._model = void 0, i.prototype.dispose.apply(this)
            },
            renderModel: function(e, t, n, r, i) {
                var s = this;
                this._model = n;
                var o = i ? i : this._model.getSpEnemyAdjustmentes();
                FF.logger.debug("adjustments", o), this._alterType = o.getAlterType(), this._alterType === c.ENEMY_ALTER_TYPES.AB ? this._loadAlterAB(e, t, r, i) : this._constructView(e, t, r, i)
            },
            getModel: function() {
                return this._model
            },
            hideAll: function() {
                this._alterABView && (this._alterABView.suspendParticle(), this._alterABView.hideTopNode()), this._mainView && this._mainView.hideTopNode(), e.each(this._subViews, function(e) {
                    e.hideSubView(), e.suspendParticle()
                })
            },
            _loadAlterAB: function(e, t, n, r) {
                var i = this,
                    s = r ? r : this._model.getSpEnemyAdjustmentes(),
                    o = e.getLayerByAssetId(s.getAlterABAssetId()),
                    u = s.getInitTag() || "play";
                this._alterABView = new p("alterabview_" + this._model.get("id"), o, t), this._alterABView.setTopNodeScale(s.getScale());
                var a = s.getOffsets();
                this._alterABView.setTopNodePosition(a.x, a.y), this._alterABView.playTagDeferred(u), n || (this._alterABView.playTagDeferred("stop"), t.darkenEnemyContainer())
            },
            _constructView: function(t, n, r, i) {
                var s = this,
                    o = [],
                    u = this._model.getStructures(),
                    l = i ? i : this._model.getSpEnemyAdjustmentes();
                e.each(u, function(e, r) {
                    var i = e.getAssetId(),
                        o = e.getChildPosId(),
                        u = t.getLayerByAssetId(i),
                        a = new v("subview_" + o, u, e);
                    s._subViews.push(a), s._mainView || (s._mainView = new d("mainview_" + s._model.get("id"), u, n, e))
                }), e.each(this._subViews, function(e, t) {
                    var n = e.structure,
                        r = n.getChildPosId();
                    e.setParant(s._mainView), e.setTouchBegan(function(e) {
                        s.trigger(h.TOUCH_START, s), FF.eventNotifier.trigger("ab:onTapScreen", e)
                    }), e.setTouchEnded(function(e) {
                        if (a.isDragTap(e)) {
                            FF.logger.debug(s._mainView.name, "dragged");
                            return
                        }
                        s.trigger(h.TOUCH_END, s)
                    }), l.isHiddenChild(r) ? (FF.logger.debug("#### hide child", r), e.hideSubView()) : o.push(e.getPositionBaseNode()), e.setTopNodeScale(l.getScale())
                });
                var c = l.getInitTag();
                f.create(l.getArrangeType()).placeEnemies(o);
                var p = l.getOffsets();
                this._mainView.setTopNodePosition(p.x, p.y), this._playDeformDeferred(c ? c : "in", "idle"), r || (this._playDeformDeferred(c ? c : "stop", "stop"), n.darkenEnemyContainer())
            },
            _playDeformDeferred: function(e, t) {
                var n = this._model.isRandomPlayDeformTag(e),
                    r = this._playTagDeferred(e).then(function() {
                        FF.logger.debug("tag : ", e, "played")
                    });
                return t && this._playTagToParts(t, n), r
            },
            _playTagDeferred: function(n) {
                var r = [],
                    i;
                return e.each(this._subViews, function(e) {
                    i = e.playTagDeferred(n), i.then(function() {
                        FF.logger.debug(e.name, n, "played")
                    }), r.push(i)
                }), t.when.apply(null, r)
            },
            _playTagToParts: function(t, n, i, s) {
                e.each(this._subViews, function(e) {
                    e.playTagToParts(t, i ? r.random() : 0, s)
                })
            },
            setTouchEnabled: function(t) {
                e.each(this._subViews, function(e) {
                    e.setTouchEnabled(t)
                })
            }
        }, {
            EVENTS: h
        });
    return m
}), define("scenes/battle_list/ab/views/BattleListView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase", "./PlatformView", "./SpEnemyView"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
            EXIT_SELECTED: "exit_selected",
            OPERATIONS_SELECTED: "operarations_selected",
            ENEMY_INFO_LONG_PRESSED: "operarations_long_predded",
            BATTLE_SELECTED: "battle_selected",
            ENEMY_SELECTED: "enemy_selected"
        },
        l = {
            MASK_MARGIN_TOP: 60,
            MASK_MARGIN_BOTTOM: 54,
            BG_IMAGE_WIDTH: 320,
            BG_IMAGE_HEIGHT: 568,
            KICK_MOTER_DRAG_MARGIN: 50,
            SCREEN_WIDTH: 320,
            MAX_SCROLL_ADJUSTMENT: 50
        },
        c = {
            APPEAR: "open",
            FORCE: "force",
            ENTER_BATTLE: "battle_start"
        },
        h = o.extend({
            spEnemyViewAdjustmentForDev: void 0,
            initialize: function(e, t) {
                this._platformViews = [], this._enemyViews = {}, this._dragArea = [0, 0, 0, 0], this._charStayingView = void 0, this._nextTargetIndex = -1, this._firstPlatformViewYpos = void 0, this._lastPlatformViewYpos = void 0, this._innerUILocked = !1, this._goingOpeScene = !1, this._shouldShowProgressEffect = !1, this._lastEventIconPath = void 0, this._isTutorialMode = !1, this._isFuncTutorialMode = !1, this._leadBuddyId = void 0, o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                this._setDraggable(!1), this.opeBtn.dispose(), kickmotor.animation.processAnimation([{
                    exec: "clearTouchRect",
                    layer: this.getLayerName(),
                    node: this._ab.listContainer.name
                }]), e.each(this._platformViews, function(e) {
                    e.dispose()
                }), e.each(this._enemyViews, function(e) {
                    e.dispose()
                }), this._enemyViews = void 0, this._platformViews = void 0, this._charStayingView = void 0, this._nextTargetView = void 0, o.prototype.dispose.apply(this)
            },
            resetBattleListView: function() {
                this._innerUILocked = !1, this._goingOpeScene = !1, this.setTouchEnabled(!0), this.opeBtn.setEnabled(!0)
            },
            _drawView: function() {
                var e = this;
                return this._ab.stage = new i({
                    name: "stage",
                    layer: this.getLayerName()
                }), this._ab.listContainer = this._ab.stage.createChildNode("list_pos"), this._ab.rippleHitNode = (new i({
                    name: "list_visible_touch_duplicated",
                    layer: this.getLayerName(),
                    duplicateFrom: "list_visible_touch",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._ab.listContainer.name
                    }
                })).setVisible(!0).addCallback("action_touch_began", function(e) {
                    FF.eventNotifier.trigger("ab:onTapScreen", e)
                }), this._ab.operationNode = this._ab.stage.createChildNode("btn_strategy"), this.opeBtn = new s(this._ab.operationNode, void 0, void 0, "btn_strategy_visible"), this.opeBtn.setTouchHandler(function(t, n) {
                    if (e.isUILocked()) return;
                    FF.SoundMgr.playChooseEffect(), e._goingOpeScene = !0, e.opeBtn.setEnabled(!1)
                }), this.opeBtn.setTouchHandlerAfterAnimation(function(t, n) {
                    e._goingOpeScene && e.trigger(f.OPERATIONS_SELECTED)
                }), this.opeBtn.setButtonStateTags(void 0, "btn_touch", void 0), this.opeBtn.ignoreTouchEnter(), this._ab.eventUI = this._ab.stage.createChildNode("event_pos").setVisible(!1), this._ab.stage.setVisible(!1), this._ab.stage
            },
            _updateTouchEnabled: function() {
                this._setDraggable(this.isTouchEnabled())
            },
            setPlatFormLayer: function(e, t) {
                FF.logger.debug("setPlatFormLayer", e, t), this._platformLayerInfo = {
                    id: e,
                    layer: t
                }
            },
            setCharactorCommonLayer: function(e, t) {
                FF.logger.debug("setCharactorCommonLayer", e, t), this._charactorLayerInfo = {
                    id: e,
                    layer: t
                }
            },
            setDungeonName: function(e) {
                this._ab.stage.setText("title_txt", e).process()
            },
            changeSpecialEventMode: function(e, t, n) {
                this._ab.eventUI.loadBundle(e.bundle).process(), this._ab.eventUI.setVisible(!0).setText("event_txt", t + " " + n).process(), e.assetPath !== this._lastEventIconPath && (this._lastEventIconPath = e.assetPath, this._ab.eventUI.setImage("event_ico", this._lastEventIconPath).process())
            },
            changeExtremeEventMode: function() {
                this._ab.stage.setVisibleByNode("open_chaos_particle", !1), this._ab.stage.setVisibleByNode("black_eff_img", !1), e.each(this._platformViews, function(e) {
                    e.changeExtremeEventMode()
                })
            },
            showList: function() {
                this.showTopNode()
            },
            hideList: function() {
                this.hideTopNode()
            },
            appearDeferred: function(e, n) {
                var r;
                return this.showTopNode(), this._ab.stage.play(c.APPEAR, {
                    speed: e ? 100 : 2
                }), e ? (this._ab.stage.process(), r = t.Deferred().resolve().promise()) : r = this._ab.stage.processDeferred("action_stop"), n && this._changeForceDungeon(), r
            },
            _changeForceDungeon: function() {
                this._ab.stage.setVisible(!0).play(c.FORCE).process()
            },
            playEnterBattleDeferred: function() {
                return e.each(this._platformViews, function(e) {
                    e.hideEffects()
                }), e.each(this._enemyViews, function(e) {
                    e.hideAll()
                }), this._ab.stage.play(c.ENTER_BATTLE).processDeferred("action_stop", {
                    tag: c.ENTER_BATTLE
                })
            },
            setBackgroundImage: function(e) {
                if (!e) return;
                this._ab.stage.loadBundle(e.bundle).setImage("bg_img", e.assetPath, {
                    size: [l.BG_IMAGE_WIDTH, l.BG_IMAGE_HEIGHT]
                }).process()
            },
            isUILocked: function() {
                return !this.isTouchEnabled() || !this.isTopNodeShown() || this._innerUILocked || this._goingOpeScene
            },
            setShouldShowProgressEffectFlag: function(e) {
                FF.logger.debug("setShouldShowProgressEffectFlag", e), this._shouldShowProgressEffect = e
            },
            renderList: function(e, t, n, r) {
                var i = this;
                this._initScrollMask(), this._createPlatformViews(e, t, n, r), this._locatePlatformViews(r), this._adjustRippleHitArea(), this._initScroll(this._firstPlatformViewYpos, this._lastPlatformViewYpos - l.MAX_SCROLL_ADJUSTMENT, this._charStayingView.getTopNodePosition().y), this._playClearEffectDeferred().then(function() {
                    i._showTargetEffect()
                }), this.setTouchEnabled(!0)
            },
            insertCharacter: function(e, t) {
                this._leadBuddyId !== t && (this._leadBuddyId = t, this._insertCharacter(e, t))
            },
            changeTutorialMode: function() {
                this._isTutorialMode = !0, this.opeBtn.setEnabled(!1), this.opeBtn.baseNode.play("btn_lock", {
                    autoRemove: !1
                }).process(), e.each(this._platformViews, function(e) {
                    e.isExit() && e.setTouchEnabled(!1), e.hasSpEnemy() && e.setInfoBtnDisabled()
                })
            },
            canReuseInstance: function() {
                return this._isTutorialMode || this._isFuncTutorialMode ? !1 : !0
            },
            changeFuncTutorialMode: function(t) {
                t === "BATTLE_LIST" && (this._isFuncTutorialMode = !0, e.each(this._platformViews, function(e) {
                    e.setTouchEnabled(!1), e.hasSpEnemy() && e.setInfoBtnDisabled()
                }))
            },
            _createPlatformViews: function(e, t, n, r) {
                var i = this,
                    s, o = u.createExitPlatform(this.getLayer(), this._platformLayerInfo.layer);
                this._platformViews.push(o), t.forEach(function(t, o) {
                    var a = n.get("battle_id") === t.get("id"),
                        f = i._platformLayerInfo,
                        l = a || s === void 0,
                        c = u.createPlatform(t, i.getLayer(), f.layer, l, a);
                    a && (i._charStayingView = i._platformViews[i._platformViews.length - 1], s = c, i._nextTargetIndex = o), i._platformViews.push(c);
                    var h = i._nextTargetIndex !== -1 && i._nextTargetIndex <= o && c.hasSpEnemy();
                    i._attachSpEnemy(t, c, e, r, h)
                }), this._nextTargetView = s, o.showTargetEfefct(!0)
            },
            _locatePlatformViews: function(t) {
                var n = this,
                    r = 0,
                    i = 0,
                    s = 0,
                    o = 90,
                    a = 160,
                    l = 220,
                    c = 278,
                    h = 90,
                    p = 70,
                    d = 30,
                    v = 25,
                    m = 65;
                e.each(this._platformViews, function(e, g) {
                    var y = e.getBattleModel(),
                        b = n._platformViews[g - 1],
                        w = n._platformViews[g + 1],
                        E = !e.isExit(),
                        S = !(b && b.hasSpEnemy() || e.hasSpEnemy()),
                        x = b && b.isExit();
                    e.setTopNodeDepth(-g);
                    if (e.hasSpEnemy()) {
                        r = a, i -= h, E && (s % 2 === 0 ? e.showLeftBridge(S) : e.showRightBridge(S));
                        var T = n._enemyViews[y.get("id")];
                        T && T.setTouchEnabled(e.isTouchEnabled())
                    } else r = e.isExit() ? c : [l, o][s % 2], i -= p, b && b.hasSpEnemy() && (i -= v), x && (i -= d), E && (s % 2 === 0 ? e.showLeftBridge(S, x) : e.showRightBridge(S, x));
                    s++, S || (i -= m), e.setTopNodePosition(r, i), n._firstPlatformViewYpos === void 0 && (n._firstPlatformViewYpos = i), e.isExit() ? n.listenTo(e, u.EVENTS.PLATFORM_TOUCHED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playChooseEffect(), n._handleExitSelect(e)
                    }) : (n.listenTo(e, u.EVENTS.PLATFORM_TOUCHED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playDecideEffect(), n._handlePlatformSelect(e)
                    }), n.listenTo(e, u.EVENTS.INFO_TOUCHED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playChooseEffect();
                        var r = e.getBattleModel(),
                            i = n._getSpEnemyModelByBattleModel(r, t);
                        n.trigger(f.ENEMY_SELECTED, i)
                    }), n.listenTo(e, u.EVENTS.INFO_LONG_PRESSED, function(e) {
                        if (n.isUILocked()) return;
                        FF.SoundMgr.playChooseEffect();
                        var r = e.getBattleModel(),
                            i = n._getSpEnemyModelByBattleModel(r, t);
                        n.trigger(f.ENEMY_INFO_LONG_PRESSED, i)
                    }))
                }), this._lastPlatformViewYpos = i
            },
            _adjustRippleHitArea: function() {
                var e = this._lastPlatformViewYpos - 300,
                    t = 2 * Math.abs(568 / this._lastPlatformViewYpos),
                    n = -1e4;
                this._ab.rippleHitNode.setPosition([0, e]).setScale([1, t]).setZOrder(n).process()
            },
            _insertCharacter: function(e, t) {
                var n = e.getAssetManager().getAssetInfo(r("animation-buddy-%s", t));
                this._charStayingView.insertCharactor(n, this._charactorLayerInfo.layer)
            },
            _playClearEffectDeferred: function() {
                return this._shouldShowProgressEffect ? (this._nextTargetView.changeLockedTemporary(), this._charStayingView.playClearEffectDeferred()) : t.Deferred().resolve().promise()
            },
            _showTargetEffect: function() {
                var e = this;
                this._shouldShowProgressEffect ? e._nextTargetView.playUnlockEffectDeferred().then(function() {
                    if (!e._nextTargetView) return;
                    e._nextTargetView.showTargetEfefct(!0)
                }) : this._nextTargetView.showTargetEfefct(!0)
            },
            _initScrollMask: function() {
                var e = kickmotor.nativefn.getLogicalScreenHeight();
                kickmotor.animation.processAnimation([{
                    exec: "setScissor",
                    layer: this.getLayerName(),
                    rect: [0, l.MASK_MARGIN_TOP, l.SCREEN_WIDTH, e - l.MASK_MARGIN_BOTTOM - l.MASK_MARGIN_TOP]
                }])
            },
            _initScroll: function(e, t, n) {
                FF.logger.debug("_initScroll", t, n);
                var r = kickmotor.nativefn.getLogicalScreenHeight(),
                    i = r * .4,
                    s = r * .7,
                    o = r * .7,
                    u = -e + s,
                    a = -t + i,
                    f = u < a;
                FF.logger.debug("scroll min :", u, "max :", a), f || (FF.logger.debug("no scroll"), a = u), kickmotor.animation.processAnimation([{
                    exec: "addTouchRect",
                    layer: this.getLayerName(),
                    node: "list_pos",
                    rect: [0, t - r, l.SCREEN_WIDTH, r * 3],
                    isHitTestEnable: !0
                }]);
                var c = -n + o;
                FF.logger.debug("char pos:", c), c < u ? (c = u, FF.logger.debug(" ->", c)) : a < c && (c = a, FF.logger.debug(" ->", c)), this._ab.listContainer.setPosition([0, c]).process(), this._dragArea = [0, u, 0, a - u]
            },
            __debugShowScrollPos: function() {
                var e = this;
                if (!this._platformViews || !this._ab.listContainer) return;
                this._ab.listContainer.getNodePos(function(t) {
                    var n = t.pos[0][1];
                    e._lastScrollY !== n && FF.logger.debug("scroll", n), e._lastScrollY = n, setTimeout(function() {
                        e.__debugShowScrollPos()
                    }, 500)
                })
            },
            _setDraggable: function(e) {
                kickmotor.animation.processAnimation([{
                    exec: "setDragEnable",
                    layer: this.getLayerName(),
                    node: this._ab.listContainer.name,
                    isEnable: e,
                    dragArea: this._dragArea,
                    dragMargin: [0, l.KICK_MOTER_DRAG_MARGIN, 0, l.KICK_MOTER_DRAG_MARGIN],
                    slowdownRate: 16
                }])
            },
            _attachSpEnemy: function(e, t, n, r, i) {
                var s = this,
                    o = s._getSpEnemyModelByBattleModel(e, r);
                if (!o) return void 0;
                var u = o.getEnemyId(),
                    f = s._enemyViews[e.get("id")] = new a,
                    l;
                return this.spEnemyViewAdjustmentForDev && this.spEnemyViewAdjustmentForDev.getEnemyId() + "" === o.getEnemyId() && (l = this.spEnemyViewAdjustmentForDev), f.renderModel(n, t, o, i, l), this.listenTo(f, a.EVENTS.TOUCH_START, function(e) {}), this.listenTo(f, a.EVENTS.TOUCH_END, function(n) {
                    t.canTouchSelect() ? s.isUILocked() || (FF.SoundMgr.playDecideEffect(), s._handleEnemySelect(t, o, e)) : FF.SoundMgr.playNgEffect()
                }), f
            },
            _handlePlatformSelect: function(e) {
                var t = e.getBattleModel();
                this._playSelectedAnimation(e, f.BATTLE_SELECTED, t)
            },
            _handleEnemySelect: function(e, t, n) {
                this._playSelectedAnimation(e, f.BATTLE_SELECTED, n)
            },
            _handleExitSelect: function(e) {
                this._playSelectedAnimation(e, f.EXIT_SELECTED)
            },
            _playSelectedAnimation: function(e, t, n) {
                var r = this;
                if (this.isUILocked()) return;
                this._innerUILocked = !0, e.playSelectedAnimationDeferred().then(function() {
                    r._innerUILocked = !1, n ? r.trigger(t, n) : r.trigger(t)
                })
            },
            _getSpEnemyModelByBattleModel: function(e, t) {
                var n = e.get("sp_enemy_id") + "";
                return t.where({
                    id: n
                })[0]
            }
        }, {
            EVENTS: f
        });
    return h
}), define("scenes/battle_list/views/BattleListViewController", ["underscore", "jquery", "backbone", "sprintf", "lib/EventBase", "scenes/common/ab/misc/ABLayerFactory", "../ab/views/BattleListView"], function(e, t, n, r, i, s, o) {
    var u = {
            ABLAYER_NAME_LIST_UI: "battle_list",
            ABLAYER_NAME_IMAGES: "dungeon-pf-%s",
            ABLAYER_NAME_PLAYER_COMMON: "player_common_battle_list"
        },
        a = void 0,
        f = !1,
        l = i.extend({
            spEnemyViewAdjustmentForDev: void 0,
            initialize: function() {
                if (!f) throw new Error("Direct instantiation is not allowed.");
                this._resetProperties()
            },
            dispose: function() {
                throw new Error("Do not dispose BattleListViewController.")
            },
            storeView: function() {
                if (!this._view) return;
                this._view.canReuseInstance() ? this._view.hideList() : this.disposeView()
            },
            disposeView: function() {
                this._resetProperties(), this._diposeView()
            },
            hasView: function() {
                return this._view !== void 0
            },
            _resetProperties: function() {
                this._dungeonId = void 0, this._battleId = void 0, this._isEventWorld = !1, this._isForceDungeon = !1, this._leadBuddyId = void 0
            },
            _diposeView: function() {
                this._view && (this._view.dispose(), this._view = void 0), this._layerFactory && (this._layerFactory.destroyAllLayer(), this._layerFactory = void 0)
            },
            loadABViewDeferred: function(e, n, i) {
                var o = this,
                    a = FF.datastore.dungeonSessionModel.get("dungeon_id"),
                    f = FF.datastore.dungeonSessionModel.get("battle_id"),
                    l = FF.datastore.dungeonSessionModel.getWorldModel(),
                    c = l ? l.isEventWorld() : !1,
                    h = FF.datastore.partyModel.getLeaderBuddyModel().get("buddy_id");
                if (this._isViewReusable(a, f, c, i, h, n)) return FF.logger.debug("battle list view will be REUSED"), this._view.resetBattleListView(), t.Deferred().resolve().promise();
                FF.logger.debug("NEW battle list view created"), this.disposeView(), this._dungeonId = a, this._battleId = f, this._isEventWorld = c, this._isForceDungeon = i, this._leadBuddyId = h;
                var p = FF.datastore.currentDungeonModel.get("platform_style"),
                    d = r(u.ABLAYER_NAME_IMAGES, p),
                    v = r("dungeon-bg-%s", this._dungeonId),
                    m = e[v],
                    g = [];
                FF.datastore.battleListSpEnemyCollection.models.forEach(function(e, t) {
                    g = g.concat(e.getAssetIdList())
                }), g.push(d), g.push(u.ABLAYER_NAME_LIST_UI), g.push(u.ABLAYER_NAME_PLAYER_COMMON), this._layerFactory = new s(g, e);
                var y = t.Deferred();
                return o._layerFactory.createLayersDeferred().then(function() {
                    o._initABLayer(d, m, n), y.resolve()
                }), y.promise()
            },
            _isViewReusable: function(e, t, n, r, i, s) {
                var o = this._view !== void 0 && this._dungeonId === e && this._battleId === t && this._isEventWorld === n && this._isForceDungeon === r && this._leadBuddyId === i && !s && !this.spEnemyViewAdjustmentForDev;
                return FF.logger.debug("_isViewReusable", o), o
            },
            _initABLayer: function(t, n, r) {
                var i = this,
                    s = this._layerFactory,
                    a = s.getLayerAll(),
                    f = e.find(a, function(e) {
                        return e.assetId === u.ABLAYER_NAME_LIST_UI
                    }),
                    l = this._view = new o(f.assetId, f.layer);
                l.spEnemyViewAdjustmentForDev = this.spEnemyViewAdjustmentForDev, e.each(a, function(e, n) {
                    FF.logger.debug(e.assetId), e.assetId === t ? i._view.setPlatFormLayer(e.assetId, e.layer) : e.assetId === u.ABLAYER_NAME_PLAYER_COMMON && i._view.setCharactorCommonLayer(e.assetId, e.layer)
                }), l.setBackgroundImage(n), l.setLayerZOrder(-1);
                var c = FF.datastore.currentDungeonModel.get("name");
                l.setDungeonName(c), l.setShouldShowProgressEffectFlag(r), l.renderList(s, FF.datastore.battleCollection, FF.datastore.dungeonSessionModel, FF.datastore.battleListSpEnemyCollection), l.insertCharacter(s, this._leadBuddyId)
            },
            getCurrentDungeonId: function() {
                return this._dungeonId
            },
            setEventHandlers: function(e, t, n, r, i, s) {
                t !== void 0 && e.listenTo(this._view, o.EVENTS.EXIT_SELECTED, t.bind(e)), n !== void 0 && e.listenTo(this._view, o.EVENTS.BATTLE_SELECTED, n.bind(e)), r !== void 0 && e.listenTo(this._view, o.EVENTS.ENEMY_SELECTED, r.bind(e)), i !== void 0 && e.listenTo(this._view, o.EVENTS.OPERATIONS_SELECTED, i.bind(e)), s !== void 0 && e.listenTo(this._view, o.EVENTS.ENEMY_INFO_LONG_PRESSED, s.bind(e))
            },
            removeAllEventHandlers: function(e) {
                e.stopListening(this._view, o.EVENTS.EXIT_SELECTED), e.stopListening(this._view, o.EVENTS.BATTLE_SELECTED), e.stopListening(this._view, o.EVENTS.ENEMY_SELECTED), e.stopListening(this._view, o.EVENTS.OPERATIONS_SELECTED), e.stopListening(this._view, o.EVENTS.ENEMY_INFO_LONG_PRESSED)
            },
            appearListDeferred: function(e) {
                return this._view ? this._view.appearDeferred(e, this._isForceDungeon) : t.Deferred().resolve().promise()
            },
            playEnterBattleDeferred: function(e) {
                return this._view ? (this.showListView(), this._view.setTouchEnabled(!!e), this._view.playEnterBattleDeferred()) : t.Deferred().resolve().promise()
            },
            hideListView: function() {
                this._view && this._view.hideList()
            },
            showListView: function() {
                this._view && this._view.showList()
            },
            changeTutorialMode: function() {
                this._view && this._view.changeTutorialMode()
            },
            changeFuncTutorialMode: function(e) {
                this._view && this._view.changeFuncTutorialMode(e)
            },
            changeSpecialEventMode: function(e, t, n) {
                this._view && this._view.changeSpecialEventMode(e, t, n)
            },
            changeExtremeEventMode: function() {
                this._view && this._view.changeExtremeEventMode()
            },
            changeDebugView_temp: function() {
                this._view && this._view.changeDebugView_temp()
            }
        }, {
            getInstance: function() {
                return a || (f = !0, a = new l, f = !1), a
            }
        });
    return l
}), define("scenes/common/views/ModalBattleEscape", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "templates/common/ModalBattleEscape", "templates/common/ModalEscapeComplete", "lib/ModalBase", "scenes/battle_list/views/BattleListViewController"], function(e, t, n, r, i, s, o, u) {
    return o.extend({
        el: "[data-app-modal]",
        isNotNavigateFailScene: !1,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-complete-close]": "onEnd",
            "anchorsbeforejump [data-app-escape]": "onClickEscape"
        },
        initialize: function(e) {
            e = e || {}, this.isNotNavigateFailScene = e.isNotNavigateFailScene, this.isNotNavigateBattleListScene = e.isNotNavigateBattleListScene, this.isDisposingBattleListViewRequired = e.isNotNavigateBattleListScene, this.dungeonSessionModel = FF.datastore.dungeonSessionModel
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickEscape: function() {
            var e = this,
                t = this.dungeonSessionModel.get("dungeon_id"),
                i = this.dungeonSessionModel.getWorldModel().getApiOptions();
            FF.SoundMgr.playEscapeEffect(), r.dungeonLeaveDeferred(t, i).done(function(t) {
                FF.datastore.userModel.set(t.user), e.isDisposingBattleListViewRequired && u.getInstance().disposeView(), FF.datastore.clearDungeonSession(), e.isNotNavigateFailScene ? (FF.router.loading.hide(!0), e.$el.html(s())) : (e.end(), n.history.navigate(t.fragment, {
                    trigger: !0
                }))
            })
        },
        onClickModalClose: function() {
            FF.SoundMgr.playChooseEffect();
            var e = this.dungeonSessionModel.get("dungeon_id"),
                t = this.dungeonSessionModel.getWorldModel().getBattleListFragment(e);
            this.end(), this.isNotNavigateBattleListScene || n.history.navigate(t, {
                trigger: !0
            })
        }
    })
}), define("scenes/common/ab/view/TutoArrow", ["underscore", "jquery", "sprintf", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ClassBase"], function(e, t, n, r, i, s, o) {
    var u = -1,
        a = o.extend({
            initialize: function(e) {
                this._topNode = e
            },
            dispose: function() {
                this._topNode && this._topNode.deleteNode().process(), this._topNode = void 0
            },
            setPosition: function(e, t) {
                return this._topNode && this._topNode.setPosition([e, t]).process(), this
            },
            show: function() {
                var e = this,
                    t = this._topNode;
                if (!t) return;
                if (this._isShown) return;
                return this._isShown = !0, t.play("SHOW").processDeferred("action_stop").then(function() {
                    e._isShown && t.play("LOOP").process()
                }), this
            },
            hide: function() {
                var e = this._topNode;
                if (!e) return;
                if (!this._isShown) return;
                return this._isShown = !1, e.play("HIDE").process(), this
            },
            isShown: function() {
                return this._isShown
            },
            setZOrder: function(e) {
                return this._topNode && this._topNode.setZOrder(e).process(), this
            }
        }, {
            createTutoArrow: function(e, t, r, i, o) {
                o = o ? o : "layer_tutorial_arrow", i = i ? i : "", r = r === void 0 ? !0 : !!r;
                var f = n("an_arrow_%s", ++u),
                    l = (new s({
                        name: f,
                        layer: o,
                        duplicateFrom: "arrow",
                        topNodeName: i,
                        duplicateFromOptions: {
                            visualParentLayer: e,
                            visualParentNode: t
                        }
                    })).setVisible(!0).process(),
                    c = new a(l);
                return r && c.show(), c
            }
        });
    return a
}), define("scenes/battle_list/StorageKeys", [], function() {
    var e = {
        SPENEMY_ADJUSTMENT_DEBUG: "SPENEMY_ADJUSTMENT_DEBUG"
    };
    return e
}), define("scenes/battle_list/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "lib/Battle", "scenes/battle_list/Api", "templates/battle_list/BattleList", "./ModalBattleDetail", "./ModalStaminaRecovery", "./ModalNotEnoughMaxStamina", "./ModalEnemy", "scenes/common/Config", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/FuncTutorial", "scenes/common/helper/MissionHelper", "scenes/common/views/ModalBattleResume", "scenes/common/views/ModalBattleEscape", "scenes/common/views/ModalItemPossessionLimit", "components/FreeScroll", "components/Scrollbar", "lib/LayoutBase", "./BattleListViewController", "scenes/common/ab/misc/ABLayerFactory", "scenes/common/ab/view/TutoArrow", "lib/Storage", "scenes/battle_list/StorageKeys", "scenes/common/models/BattleListSpEnemyAdjustment"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C) {
    var k = {
            ACHIEVE_TYPE_NAMES: ["BUDDY_LEVEL"]
        },
        L = {
            BATTLE_LIST: "BATTLE_LIST",
            BATTLE_LIST_UI_REBORN: "BATTLE_LIST_2"
        },
        A = w.extend({
            contentType: "BASE",
            designType: "CLASSIC",
            tmpl: o,
            ModalBattleDetailViewClass: u,
            _isTransferring: !1,
            initialize: function() {
                var e = FF.datastore;
                this.userModel = e.userModel, this.dungeonModel = e.currentDungeonModel, this.dungeonSessionModel = e.dungeonSessionModel, this.worldModel = this.dungeonSessionModel.getWorldModel(), this.battleCollection = e.battleCollection, this.battleListSpEnemyCollection = e.battleListSpEnemyCollection, this.globalNaviSelector = t("[data-app-globalnavi]"), this._battleListViewController = E.getInstance(), w.prototype.initialize.call(this), this.listenTo(FF.eventNotifier, "modal:openNotify", this.onModalOpen.bind(this)), this.listenTo(FF.eventNotifier, "modal:closeNotify", this.onModalClose.bind(this))
            },
            loadSpEnemyViewAdjustmentDataDeferred: function() {
                var e = this,
                    n = t.Deferred();
                return this._battleListViewController.spEnemyViewAdjustmentForDev = void 0, n.resolve().promise()
            },
            loadABViewDeferred: function(e, t) {
                var n = this,
                    r = this.dungeonSessionModel.getUpdateProgressEffectFlag();
                return this._battleListViewController.loadABViewDeferred(e, r, t).then(function() {
                    n._battleListViewController.setEventHandlers(n, n.onTouchExit, n.onSelectBattle, n.onSelectEnemy, n.onClickOperations, n.onLongPressEnemyInfo)
                })
            },
            setupAdditionalUI: function() {},
            showTutoArrow: function() {
                this._arrow = x.createTutoArrow("layer_tutorial_arrow", "stage").setPosition(290, 70)
            },
            appearListDeferred: function(e) {
                return this._battleListViewController.appearListDeferred(e)
            },
            render: function(t) {
                FF.router.header.updatePartyStatusView({
                    isShowGauge: !0
                });
                var n = {
                    dungeonModel: this.dungeonModel,
                    dungeonSessionModel: this.dungeonSessionModel,
                    battleCollection: this.battleCollection
                };
                w.prototype.render.call(this, this.tmpl, e.extend(n, t)), this.setupComponents(), this.updateBackgroundImage(), this.processAfterRender()
            },
            processAfterContentLoad: function() {},
            processAfterListViewReady: function() {
                w.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation(), this.showModalIfCanResumeDeferred().then(d.openModalMissionClearIfNeedDeferred.bind(d))
            },
            setupComponents: function() {},
            updateBackgroundImage: function() {
                var e = this.dungeonModel.get("background_image_path");
                this.setBackgroundImage(e)
            },
            onModalOpen: function(e) {
                FF.logger.debug("recieved modal:openNotify", e), this._battleListViewController.hideListView()
            },
            onModalClose: function(e) {
                FF.logger.debug("recieved modal:closeNotify", e), this._battleListViewController.showListView()
            },
            onSelectBattle: function(e) {
                FF.router.loading.lock();
                var t = this;
                h.showModalIfOverLimitDeferred().done(function() {
                    if (!t.hasEnoughMaxStamina(e)) return t.showModalNotEnoughMaxStaminaModal();
                    if (!t.hasEnoughStamina(e)) return t.showModalRecoveryStaminaModal();
                    t.showDetail(e)
                }).fail(function() {
                    FF.logger.debug("showModalIfOverLimitDeferred failed")
                })
            },
            onSelectEnemy: function(e) {
                var t = this;
                this._devTargetEnemyModel = e, FF.router.loading.show(), FF.modalStack.push(l, {
                    initializer: function(n) {
                        return new n({
                            dungeonModel: t.dungeonModel,
                            enemyId: e.get("id")
                        })
                    },
                    renderer: function(e) {
                        return e.render()
                    },
                    opener: function(e) {
                        return e.openAfterImageLoad({
                            isCrawlImgTag: !0
                        })
                    }
                }), FF.modalStack.setOnComplete(t.onClickCloseByHide.bind(this))
            },
            onLongPressEnemyInfo: function(e) {},
            showModalIfCanResumeDeferred: function() {
                var e = this,
                    n = t.Deferred(),
                    r = this.dungeonSessionModel;
                return r.get("is_in_battle") ? (FF.router.loading.show(), this._battleListViewController.hideListView(), i.checkSessionAndUpdateDeferred(r.get("session_key")).then(function() {
                    FF.router.loading.hide();
                    var e = new v;
                    FF.router.overlay.registerChildren(e), e.render(), e.open(), n.reject()
                }, function() {
                    FF.router.loading.hide(), e._battleListViewController.showListView(), n.resolve()
                }), n.promise()) : n.resolve().promise()
            },
            hasEnoughStamina: function(e) {
                var t = this.userModel.get("stamina"),
                    n = e.get("stamina");
                return t - n >= 0
            },
            hasEnoughMaxStamina: function(t) {
                var n = e.max([this.userModel.get("max_stamina"), this.userModel.get("stamina")]),
                    r = t.get("stamina");
                return n - r >= 0
            },
            showDetail: function(e) {
                var t = this.ModalBattleDetailViewClass;
                this.modalBattleDetailView = new t({
                    battleModel: e,
                    dungeonModel: this.dungeonModel,
                    dungeonSessionModel: this.dungeonSessionModel,
                    worldModel: this.worldModel
                }), this.modalBattleDetailView.render(), this.listenTo(this.modalBattleDetailView, "closeNotify", this.onClickCloseDetail.bind(this)), this.listenTo(this.modalBattleDetailView, "onClickBattleStart", this.onClickBattleStart.bind(this)), FF.router.overlay.registerChildren(this.modalBattleDetailView), this.modalBattleDetailView.open()
            },
            showModalRecoveryStaminaModal: function() {
                var e = this;
                FF.router.loading.show(), this._battleListViewController.hideListView(), this.modalStaminaRecoveryView = new a, this.modalStaminaRecoveryView.setBalanceDeferred().done(function() {
                    e.modalStaminaRecoveryView.render(), e.listenTo(e.modalStaminaRecoveryView, "closeNotify", e.onClickCloseByHide.bind(e)), FF.router.overlay.registerChildren(e.modalStaminaRecoveryView), e.modalStaminaRecoveryView.open()
                })
            },
            showModalNotEnoughMaxStaminaModal: function() {
                FF.router.loading.show(), this.modalNotEnoughMaxStaminaView = new f, this.modalNotEnoughMaxStaminaView.render(), this.listenTo(this.modalNotEnoughMaxStaminaView, "closeNotify", this.onClickCloseByHide.bind(this)), FF.router.overlay.registerChildren(this.modalNotEnoughMaxStaminaView), this.modalNotEnoughMaxStaminaView.open()
            },
            onClickCloseDetail: function() {
                FF.router.loading.unlock()
            },
            onClickBattleStart: function(e) {
                var t = this;
                FF.router.loading.lock(), this._battleListViewController.playEnterBattleDeferred(!1).then(function() {
                    t._jumpToBattleScene(e)
                })
            },
            _jumpToBattleScene: function(e) {
                kickmotor.googleanalytics.sendScreenName(c.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.BattleAnimationStart), FF.redirect("/dff/battle/", {
                    battle_id: e.get("id")
                })
            },
            onClickCloseByHide: function() {
                FF.router.loading.hide()
            },
            onClickOperations: function() {
                FF.router.loading.lock(), this._battleListViewController.hideListView(), n.history.navigate("#operation/party", {
                    trigger: !0
                })
            },
            onTouchExit: function() {
                var e = this;
                FF.router.loading.lock(), this._battleListViewController.hideListView(), this.modalBattleEscape = new m({
                    isNotNavigateBattleListScene: !0,
                    isDisposingBattleListViewRequired: !0
                }), this.modalBattleEscape.render(), FF.router.overlay.registerChildren(this.modalBattleEscape), this.modalBattleEscape.open()
            },
            startFuncTutorialDeferred: function() {
                var e = this;
                return this._battleListViewController.hideListView(), this._battleListViewController.changeFuncTutorialMode(L.BATTLE_LIST), this._battleListViewController.removeAllEventHandlers(this), this._battleListViewController.setEventHandlers(this, void 0, void 0, void 0, this.onClickTutorialOperations), this.closeNavigation(), p.showNavigationDeferred({
                    key: L.BATTLE_LIST,
                    isTutorialBattleList: !0
                }).done(function() {
                    e.showTutoArrow(), e._battleListViewController.showListView()
                })
            },
            startFuncTutorialForUIRebornDeferred: function() {
                var e = this;
                return this._battleListViewController.hideListView(), this.closeNavigation(), p.showNavigationDeferred({
                    key: L.BATTLE_LIST_UI_REBORN,
                    isTutorialIllustOnly: !0
                }).done(function() {
                    e.openGlobalNavi(), e._battleListViewController.showListView()
                })
            },
            onClickTutorialOperations: function() {
                FF.router.loading.lock(), this._battleListViewController.hideListView(), n.history.navigate("#tutorial/operations", {
                    trigger: !0
                })
            },
            onClickGlobalNavi: function(e) {
                return !1
            },
            closeNavigation: function() {
                t("[data-app-btn-back]").addClass("is-disable"), this.globalNaviSelector.addClass("is-disable"), this.globalNaviSelector.find("a").on("anchorsbeforejump", this.onClickGlobalNavi)
            },
            openGlobalNavi: function() {
                this.globalNaviSelector.removeClass("is-disable"), this.globalNaviSelector.find("a").unbind("anchorsbeforejump", this.onClickGlobalNavi)
            },
            onClickBack: function() {
                FF.router.loading.lock(), this._battleListViewController.hideListView(), n.history.navigate("#home", {
                    trigger: !0
                })
            },
            dispose: function() {
                this.modalBattleDetailView && this.modalBattleDetailView.dispose(), this.modalStaminaRecoveryView && this.modalStaminaRecoveryView.dispose(), this.modalBattleEscape && this.modalBattleEscape.dispose(), this.modalEnemyView && this.modalEnemyView.dispose(), this.resetBackgroundImage(), FF.router.header.updatePartyStatusView({
                    isShowGauge: !1
                }), w.prototype.dispose.call(this), this._arrow && this._arrow.dispose(), this._arrow = void 0, this._battleListViewController.storeView(), this._battleListViewController = void 0
            }
        });
    return A
}), define("scenes/battle_list/BattleListScene", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred(),
                s = FF.datastore;
            return s.hasDungeonSession() ? i.resolve().promise() : (r.dungeonSessionDeferred().then(function(e) {
                s.setDungeonSession(e), i.resolve(e)
            }), i.promise())
        },
        start: function(e) {
            var t = this,
                n = !FF.router.dungeonWarpViewController.hasWarpView();
            n && FF.router.loading.show(), this._setABTouchEnabled(!1), this.setupDeferred(e).then(function(e) {
                t.renderLayoutView();
                var n = FF.datastore.currentDungeonModel.isForce();
                return FF.logger.debug("isForceDungeon", n), t.appearListDeferred(n)
            }).then(function() {
                var e = FF.datastore.currentDungeonModel.get("bgm");
                return FF.SoundMgr.playMusic(e), n && FF.router.loading.hide(), t._showFuncTutorialDeferred()
            }).then(function() {
                t._setABTouchEnabled(!0), t.layoutView.processAfterListViewReady()
            }).fail(function(e) {
                throw FF.logger.debug(e), new Error("Cannot start battle_list")
            })
        },
        _setABTouchEnabled: function(e) {
            kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: e
            })
        },
        _showFuncTutorialDeferred: function() {
            return this._isFuncTutorialRequired() ? this.layoutView.startFuncTutorialDeferred() : this._isFuncTutorialForUIRebornRequired() ? this.layoutView.startFuncTutorialForUIRebornDeferred() : t.Deferred().resolve().promise()
        },
        _isFuncTutorialRequired: function() {
            var e = FF.datastore.userModel,
                t = FF.datastore.dungeonSessionModel,
                n = FF.datastore.battleCollection;
            if (e.hasProceededFuncTutorial("BATTLE_LIST")) return !1;
            var r = t.getWorldModel();
            if (r.isEventWorld()) return !1;
            var i = t.get("battle_id"),
                s = n.first().get("id"),
                o = i !== s;
            return o
        },
        _isFuncTutorialForUIRebornRequired: function() {
            var e = FF.datastore.userModel,
                t = FF.datastore.dungeonSessionModel;
            if (e.hasProceededFuncTutorial("BATTLE_LIST_2")) return FF.logger.debug("no proceeded func tutorial"), !1;
            var n = t.getWorldModel();
            return n.isEventWorld() ? !1 : !0
        },
        renderLayoutView: function() {
            this.layoutView = new s, this.layoutView.render()
        },
        getABAssets: function() {
            return FF.datastore.dungeonSessionAssets
        },
        appearListDeferred: function(t) {
            var n = this,
                r = FF.router.dungeonWarpViewController.hasWarpView(),
                i = {};
            e.extend(i, this.getABAssets()), this._isFuncTutorialRequired() && (i.tutorial_arrow = FF.datastore.stash.commonABAssets.tutorial_arrow);
            var s = function() {
                FF.router.dungeonWarpViewController.playWarpOutDeferred().then(function() {
                    kickmotor.nativefn.setPumpASyncMode(!0), FF.router.dungeonWarpViewController.dispose()
                })
            };
            return this.layoutView.loadSpEnemyViewAdjustmentDataDeferred().then(function() {
                return n.layoutView.loadABViewDeferred(n.getABAssets(), t)
            }).then(function() {
                return n.layoutView.setupAdditionalUI(), s(), n.layoutView.appearListDeferred(r)
            })
        }
    })
}), define("scenes/common/helper/FirstDungeonClearFlag", ["jquery", "lib/Storage"], function(e, t) {
    var n = "first_dungeon_clear_flag";
    return {
        saveDeferred: function(e) {
            var r = {
                isFirstClear: e
            };
            return t.setItemDeferred(n, JSON.stringify(r))
        },
        loadDeferred: function() {
            var r = e.Deferred();
            return t.getItemDeferred(n).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {};
                r.resolve(t)
            }), r.promise()
        },
        resetDeferred: function() {
            return t.removeItemDeferred(n)
        }
    }
}), define("scenes/battle_epilogue/ab/views/EpilogueMovieView", ["underscore", "jquery", "backbone", "sprintf", "lib/ab/ABNode", "lib/ab/ABNodeButton", "scenes/common/ab/view/ABViewBase"], function(e, t, n, r, i, s, o) {
    var u = {
            MOVIE_FINISH: "movie_finish"
        },
        a = {
            TOP: "top",
            PIC1: "picture_img",
            PIC2: "picture_add_img"
        },
        f = {
            IN: "in",
            LOOP: "loop",
            OUT: "out",
            SKIP: "skip"
        },
        l = o.extend({
            initialize: function(e, t) {
                this._finished = !1, this._skipped = !1, o.prototype.initialize.apply(this, [e, t])
            },
            dispose: function() {
                o.prototype.dispose.apply(this)
            },
            _drawView: function() {
                var e = this,
                    t = 320,
                    n = kickmotor.nativefn.getLogicalScreenHeight();
                return this._ab.top = (new i({
                    name: a.TOP,
                    layer: this.getLayerName()
                })).setVisible(!1).addTouchRect([-t * .5, -n * .5, t, n]).addCallback("action_touch_ended", function(t) {
                    e._skipMovie()
                }), this._ab.top
            },
            insertPicture: function(e) {
                var t = this._ab.top;
                t.loadBundle(e.bundle).process(), t.setImage(a.PIC1, e.assetPath).process(), t.setImage(a.PIC2, e.assetPath).process()
            },
            startMovieDeferred: function() {
                var e = this,
                    t = this._ab.top;
                t.setVisible(!0).play(f.IN).processDeferred("action_stop").then(function() {
                    if (!e._skipped) return e._finished = !0, t.play(f.OUT).processDeferred("action_stop")
                }).then(function() {
                    e._skipped || e.trigger(u.MOVIE_FINISH)
                })
            },
            _skipMovie: function() {
                var e = this;
                if (this._finished || this._skipped) return;
                this._skipped = !0, this._ab.top.play(f.SKIP).processDeferred("action_stop").then(function() {
                    e.trigger(u.MOVIE_FINISH)
                })
            },
            _updateTouchEnabled: function() {}
        }, {
            EVENTS: u
        });
    return l
}), define("scenes/battle_epilogue/views/Layout", ["underscore", "jquery", "backbone", "templates/battle_epilogue/Epilogue", "scenes/common/views/ModalReviewOffer", "lib/LayoutBase", "scenes/common/helper/FirstDungeonClearFlag", "scenes/common/helper/Relation", "scenes/progress_map/LatestProgressData", "lib/ab/ABLayer", "lib/ab/CommonAssetsManager", "../ab/views/EpilogueMovieView", "lib/TimeMeasure", "scenes/common/helper/MissionHelper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = "battle_picture",
        g = "dungeon-picture-%s";
    return s.extend({
        contentType: "ONLY_NEXT_BTN",
        designType: "CLASSIC",
        events: {
            "anchorsbeforejump [data-app-btn-next]": "onGoNextClick"
        },
        initialize: function(e) {
            this._worldModel = e.worldModel, this._dungeonModel = e.dungeonModel, this._canReview = e.canReview, this._setABTouchEnabled(!1), this._isGoNextClicked = !1, s.prototype.initialize.call(this)
        },
        dispose: function() {
            this._setABTouchEnabled(!1), this._assetsManager && this._assetsManager.destroyAllLayer(), this._epilogueMovieView && this._epilogueMovieView.dispose(), s.prototype.dispose.call(this)
        },
        loadABDeferred: function(e) {
            h.start("loadAB");
            var t = this;
            return this._assetsManager = new l, this._assetsManager.populateAssetsDeferred(e).then(function() {
                h.end("loadAB"), t._initEpilogueMovieView()
            })
        },
        _initEpilogueMovieView: function() {
            h.start("initAB");
            var e = this._assetsManager.getAssetInfo(m),
                t = this._assetsManager.getAssetInfo(sprintf(g, this._dungeonModel.get("id"))),
                n = new f({
                    layerName: e.layerName
                });
            this._epilogueMovieView = new c(m, n), this._epilogueMovieView.insertPicture(t), h.end("initAB")
        },
        render: function(e) {
            s.prototype.render.call(this, r, {
                worldModel: this._worldModel,
                dungeonModel: this._dungeonModel,
                canReview: this._canReview
            }), this.processAfterRender(), this.setupComponents()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this);
            var e = this;
            u.showModalIfNeedDeferred().then(p.openModalMissionClearIfNeedDeferred.bind(p)).done(function() {
                e._openReviewModal()
            })
        },
        setupComponents: function() {
            this.freescroll = new d({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new v({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        setupComponents: function() {
            this.freescroll = new d({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new v({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _openReviewModal: function() {
            if (this._canReview) {
                var e = new i({
                    reviewId: this._dungeonModel.get("id")
                });
                FF.router.overlay.registerChildren(e), e.render(), e.open()
            }
        },
        _setABTouchEnabled: function(e) {
            kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: e
            })
        },
        onGoNextClick: function() {
            if (this._isGoNextClicked) return;
            this._isGoNextClicked = !0;
            var e = this;
            o.loadDeferred().then(function(t) {
                if (!t.isFirstClear) {
                    e._goNext();
                    return
                }
                o.resetDeferred().then(function() {
                    e._showMovie()
                })
            })
        },
        _showMovie: function() {
            t("#sceneBattleEpilogue").hide(), this._setABTouchEnabled(!0), this._epilogueMovieView && (this._epilogueMovieView.startMovieDeferred(), this.listenToOnce(this._epilogueMovieView, c.EVENTS.MOVIE_FINISH, this._goNext.bind(this)))
        },
        _goNext: function() {
            var e = this;
            FF.router.loading.show();
            var t = this._dungeonModel.isForce();
            this._epilogueMovieView.hideTopNode(), a.getCanReturnDeferred().then(function(r) {
                var i = void 0;
                r.canReturn ? i = "#progress_map" : i = e._worldModel.getDungeonListFragment({
                    isForce: t
                }), n.history.navigate(i, {
                    trigger: !0
                })
            })
        }
    })
}), define("scenes/common/helper/LastClearedDungeon", ["lib/Storage"], function(e) {
    var t = "last_cleared_dungeon";
    return {
        saveDeferred: function(n, r, i) {
            var s = this,
                o = $.Deferred();
            return e.getItemDeferred(t).then(function(o) {
                var u = o.value ? JSON.parse(o.value) : {},
                    a = s._generateKey(n, r);
                return u[a] = i, e.setItemDeferred(t, JSON.stringify(u))
            }).then(function(e) {
                o.resolve()
            }), o.promise()
        },
        getDeferred: function(n, r) {
            var i = this,
                s = $.Deferred();
            return e.getItemDeferred(t).then(function(e) {
                var t = e.value ? JSON.parse(e.value) : {},
                    o = i._generateKey(n, r);
                s.resolve(t[o])
            }), s.promise()
        },
        _generateKey: function(e, t) {
            return t || (t = FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL), sprintf("%s-%s", e, t)
        }
    }
}), define("scenes/battle_epilogue/BattleEpilogueScene", ["underscore", "jquery", "backbone", "lib/Storage", "scenes/battle_list/Api", "lib/Scene", "./views/Layout", "../common/models/Dungeon", "scenes/common/helper/LastClearedDungeon"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        start: function(e) {
            var t = this,
                n, r;
            i.battleEpilogueDeferred(e).then(function(e) {
                return n = FF.datastore.worldCollection.get(e.dungeon.world_id), r = new u(e.dungeon), t.layoutView = new o({
                    worldModel: n,
                    dungeonModel: r,
                    canReview: e.can_review
                }), t.layoutView.loadABDeferred(e.assets)
            }).then(function() {
                t.layoutView.render(), FF.SoundMgr.playMusic(r.get("bgm")), a.saveDeferred(r.get("world_id"), r.get("type"), r.get("id"))
            })
        }
    })
}), define("scenes/gacha/Api", ["jquery", "underscore", "util", "scenes/common/util/Api"], function(e, t, n, r) {
    var i = 13;
    return t.extend({}, r, {
        gachaSeriesDeferred: function(e) {
            return this.requestDeferred("/dff/gacha/show", {
                id: e
            })
        },
        gachaProbDeferred: function(e) {
            return this.requestDeferred("/dff/gacha/probability", {
                series_id: e
            })
        },
        gachaExecDeferred: function(e) {
            return this.requestDeferred("/dff/gacha/execute", {
                entry_point_id: e
            }, {
                type: "POST",
                forceThrowError: !0
            })
        },
        getAndTriggerBalance: function() {
            this.getBalanceDeferred().done(function(t) {
                e(document).trigger("getBalanceForGacha", t)
            })
        },
        calculateNextFreeGachaTime: function() {
            if (!FF.env.isWWRegion()) throw new Error("calculateNextFreeGachaTime not implemented in JP");
            var e = n.getTime(),
                t = new Date(e),
                r = null,
                s = !1,
                o = t.getUTCHours(),
                u = t.getUTCDate(),
                a = t.getUTCMonth(),
                f = t.getUTCFullYear();
            o >= i ? (r = i, s = !0) : r = i;
            var l = Date.UTC(f, a, u, r, 0, 0, 0);
            if (FF.env.isDevelop()) {
                var c = FF.env.debugTimeDiff * 1e3 || 0;
                l -= c
            }
            var h = new Date(l);
            return s && h.setDate(h.getDate() + 1), h.getTime() / 1e3
        }
    })
}), define("scenes/gacha/models/EntryPoint", ["backbone"], function(e) {
    var t = e.Model.extend({
        initialize: function(t) {
            e.Model.prototype.initialize.apply(t)
        },
        getFormattedName: function() {
            return this.get("name").replace(/\$CURRENCY/, FF.TextMaster.getMobacoinUnit())
        },
        getFormattedDescription: function() {
            return this.get("description").replace(/\$CURRENCY/, FF.TextMaster.getMobacoinUnit())
        },
        getClosedTermText: function(e) {
            return e = e || this._getTimeKeeper(), FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            })
        },
        _getTimeKeeper: function() {
            return new TimeKeeper({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            })
        }
    });
    return t
}), define("scenes/gacha/models/Box", ["backbone", "./EntryPoint"], function(e, t) {
    var n = e.Model.extend({
        initialize: function(n) {
            e.Model.prototype.initialize.apply(n);
            var r = n.entry_point_list.map(function(e) {
                return new t(e)
            });
            this.set("entryPointModels", r), this.unset("entry_point_list")
        }
    });
    return n
}), define("scenes/gacha/models/Banner", ["backbone"], function(e) {
    var t = e.Model.extend({
        isAppealBanner: function() {
            return this.get("type") !== FF.CONST.SERVER.GACHA.BANNER.TYPE_OF.NONE
        }
    });
    return t
}), define("scenes/gacha/collections/Banner", ["backbone", "../models/Banner"], function(e, t) {
    var n = e.Collection.extend({
        model: t,
        comparator: "disp_order"
    });
    return n
}), define("scenes/gacha/models/Series", ["underscore", "backbone", "util", "./Box", "../collections/Banner", "components/TimeKeeper"], function(e, t, n, r, i, s) {
    var o = t.Model.extend({
        idAttribute: "series_id",
        initialize: function(n) {
            var s = this;
            t.Model.prototype.initialize.apply(n);
            var o = n.box_list.map(function(e) {
                return new r(e)
            });
            this.set("boxModels", o), this.unset("box_list"), this.set("bannerCollection", new i(n.banner_list)), this.unset("banner_list");
            var u = this.get("bannerCollection").filter(function(e) {
                return e.has("equipment")
            });
            this.bannerEquipmentMap = {}, e.each(u, function(e) {
                s.bannerEquipmentMap[e.get("equipment").id] = {
                    order: e.get("disp_order")
                }
            })
        },
        getEntryPoints: function() {
            var t = [];
            return e.each(this.get("boxModels"), function(n) {
                e.each(n.get("entryPointModels"), function(e) {
                    t.push(e)
                })
            }), t
        },
        getBannerModelByBannerId: function(e) {
            return this.get("bannerCollection").get(e)
        },
        isOpened: function() {
            var e = n.getTimeAsSec();
            return this.get("opened_at") <= e && this.get("closed_at") > e
        },
        getClosedTermText: function(e) {
            return e = e || this._getTimeKeeper(), FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.regionTimeZoneOffset()
            }) + "まで"
        },
        _getTimeKeeper: function() {
            return new s({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            })
        },
        getSortedEquipmentModelsForGachaResult: function(t) {
            var n = FF.datastore.equipmentCollection.filter(function(n) {
                return e.contains(t, n.get("id"))
            });
            return n.sort(this.gachaResultEquipmentComparator.bind(this))
        },
        gachaResultEquipmentComparator: function(e, t) {
            if (e.get("rarity") > t.get("rarity")) return -1;
            if (e.get("rarity") < t.get("rarity")) return 1;
            if (e.get("has_soul_strike") && !t.get("has_soul_strike")) return -1;
            if (!e.get("has_soul_strike") && t.get("has_soul_strike")) return 1;
            if (this.bannerEquipmentMap[e.get("equipment_id")] && !this.bannerEquipmentMap[t.get("equipment_id")]) return -1;
            if (!this.bannerEquipmentMap[e.get("equipment_id")] && this.bannerEquipmentMap[t.get("equipment_id")]) return 1;
            if (this.bannerEquipmentMap[e.get("equipment_id")] && this.bannerEquipmentMap[t.get("equipment_id")]) {
                if (this.bannerEquipmentMap[e.get("equipment_id")].order < this.bannerEquipmentMap[t.get("equipment_id")].order) return -1;
                if (this.bannerEquipmentMap[e.get("equipment_id")].order > this.bannerEquipmentMap[t.get("equipment_id")].order) return 1
            }
            return e.get("has_someones_soul_strike") && !t.get("has_someones_soul_strike") ? -1 : !e.get("has_someones_soul_strike") && t.get("has_someones_soul_strike") ? 1 : e.get("equipment_id") < t.get("equipment_id") ? -1 : e.get("equipment_id") > t.get("equipment_id") ? 1 : 0
        },
        gachaProbabilityEquipmentComparator: function(e, t) {
            if (e.rarity > t.rarity) return -1;
            if (e.rarity < t.rarity) return 1;
            if (e.has_soul_strike && !t.has_soul_strike) return -1;
            if (!e.has_soul_strike && t.has_soul_strike) return 1;
            if (this.bannerEquipmentMap[e.id] && !this.bannerEquipmentMap[t.id]) return -1;
            if (!this.bannerEquipmentMap[e.id] && this.bannerEquipmentMap[t.id]) return 1;
            if (this.bannerEquipmentMap[e.id] && this.bannerEquipmentMap[t.id]) {
                if (this.bannerEquipmentMap[e.id].order < this.bannerEquipmentMap[t.id].order) return -1;
                if (this.bannerEquipmentMap[e.id].order > this.bannerEquipmentMap[t.id].order) return 1
            }
            return e.has_someones_soul_strike && !t.has_someones_soul_strike ? -1 : !e.has_someones_soul_strike && t.has_someones_soul_strike ? 1 : e.id < t.id ? -1 : e.id > t.id ? 1 : 0
        },
        hasExchangeShop: function() {
            return !!this.get("exchange_shop_id")
        },
        canUseExchangeShop: function() {
            if (!this.hasExchangeShop()) return !1;
            var t = this.getEntryPoints(),
                n = e.all(t, function(e) {
                    return e.get("executable_num") === 0
                });
            return n && this.get("user_exchange_shop_prize_num") === 0 ? !0 : !1
        },
        isAlreadyExchanged: function() {
            return this.hasExchangeShop() ? this.get("user_exchange_shop_prize_num") > 0 ? !0 : !1 : !1
        },
        hasExchangeShop: function() {
            return !!this.get("exchange_shop_id")
        },
        canUseExchangeShop: function() {
            if (!this.hasExchangeShop()) return !1;
            var t = this.getEntryPoints(),
                n = e.all(t, function(e) {
                    return e.get("executable_num") === 0
                });
            return n && this.get("user_exchange_shop_prize_num") === 0 ? !0 : !1
        },
        isAlreadyExchanged: function() {
            return this.hasExchangeShop() ? this.get("user_exchange_shop_prize_num") > 0 ? !0 : !1 : !1
        }
    });
    return o
}), define("scenes/gacha/collections/Series", ["lib/Collection", "../models/Series"], function(e, t) {
    var n = 1e3;
    return e.extend({
        model: t,
        getWithoutTutorial: function() {
            return _.filter(this.models, function(e) {
                return e.get("series_id") !== n
            })
        },
        compareFuncByPriority: function(e, t) {
            return e.get("priority") < t.get("priority") ? 1 : e.get("priority") > t.get("priority") ? -1 : e.get("opened_at") < t.get("opened_at") ? 1 : e.get("opened_at") > t.get("opened_at") ? -1 : e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : 0
        }
    })
}), define("scenes/gacha/Datastore", ["jquery", "backbone", "lib/ClassBase", "./collections/Series"], function(e, t, n, r) {
    return n.extend({
        initialize: function() {
            this.soulPieceNum = void 0, this.seriesCollection = new r
        },
        hasGachaAllData: function() {
            return this.soulPieceNum !== void 0 && this.seriesCollection.hasData
        },
        clearHasGachaAllData: function() {
            this.soulPieceNum = void 0, this.seriesCollection.reset()
        }
    })
}), define("scenes/gacha/Exec", ["jquery", "underscore", "kickmotor", "./Api", "scenes/common/helper/MissionHelper"], function(e, t, n, r, i) {
    var s = function(t) {
            var i = e.Deferred();
            return r.purchaseItemDeferred({
                id: t,
                quantity: 1,
                payment_context: {
                    os: n.nativefn.getNativeOS(),
                    version: n.nativefn.getAppVersion()
                }
            }).then(function(e) {
                var t = JSON.parse(e);
                if (!t.success || !t.payment_result.success) throw new Error("faild_payment");
                i.resolve(t.payment_result)
            }, function(e) {
                FF.logger.debug("purchase error", e);
                if (!e.isPurchasingCanceled) throw new Error("faild_payment");
                i.reject()
            }), i.promise()
        },
        o = function(e) {
            FF.datastore.stash.gachaExecResult = e, FF.datastore.userModel.set(e.user), FF.datastore.equipmentCollection.add(e.items), FF.datastore.soulStrikeCollection.add(e.soul_strikes), FF.datastore.itemPossessionLimitCollection.update(e.user_item_possession_limits)
        };
    return {
        forItemOrFreeDeferred: function(t) {
            var n = e.Deferred(),
                s = null;
            return r.gachaExecDeferred(t).then(function(n) {
                s = n || {};
                if (!s.items) throw new Error("no items : entryPointId " + t);
                return FF.logger.debug("gacha result", s), e.Deferred().resolve().promise()
            }).then(function() {
                return i.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                o(s), n.resolve(s)
            }), n.promise()
        },
        forCoinDeferred: function(t) {
            var n = e.Deferred(),
                r = null;
            return s(t).then(function(n) {
                r = n || {};
                if (!r.items) throw new Error("no items : entryPointId " + t);
                return FF.logger.debug("coin gacha result", n), e.Deferred().resolve().promise()
            }).then(function() {
                return i.saveAchievedMissionsDeferred(r.achieved_missions)
            }).done(function() {
                o(r), n.resolve(r)
            }).fail(function(e) {
                n.reject()
            }), n.promise()
        }
    }
}), define("scenes/gacha/views/ModalGachaExecItem", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalGachaExecItem"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-exec]": "onClickExec"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.arg = e, this.renderContent(i, this.arg)
        },
        onClickExec: function() {
            FF.router.loading.show(), this.trigger("confirm", "item"), this.arg = null, this.end(!0)
        },
        onClickModalClose: function() {
            FF.router.loading.hide(), this.arg = null, this.end()
        }
    })
}), define("scenes/gacha/views/ModalGachaSelected", ["underscore", "jquery", "backbone", "../Api", "../Exec", "lib/ModalBase", "templates/gacha/plain/ModalGachaSelected", "scenes/common/helper/ItemPossessionLimit", "./ModalGachaExecItem", "components/Modal"], function(e, t, n, r, i, s, o, u, a, f) {
    return s.extend({
        el: t(".modal"),
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal",
            "anchorsbeforejump [data-app-exec-by-coin]": "onClickExecByCoin",
            "anchorsbeforejump [data-app-exec-by-item]": "onClickExecByItem",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal"
        },
        initialize: function() {
            this.lotNum = void 0, this.entryPointItem = void 0, this.entryPointCoin = void 0
        },
        render: function(e) {
            var n = this;
            return this.entryPointItem = e.entryPointItem, this.entryPointCoin = e.entryPointCoin, this.lotNum = e.lotNum, this.soulPieceNum = FF.datastore.userModel.get("soul_piece"), this.formattedName = e.formattedName, r.getAndTriggerBalance(), this.renderContent(o, {
                lotNum: this.lotNum,
                entryPointItem: this.entryPointItem,
                entryPointCoin: this.entryPointCoin,
                soulPieceNum: this.soulPieceNum,
                formattedName: this.formattedName,
                coinNum: t("[data-app-coin-num]").text(),
                showMobageLegal: FF.env.isShowingMobageLegal()
            })
        },
        closeModal: function() {
            this._closeModal()
        },
        _closeModal: function(e) {
            this.box = null, this.entry = null, this.$el.empty(), this.close(e)
        },
        onClickExecByCoin: function(e) {
            FF.router.loading.lock();
            var s = this;
            t("[data-app-exec-by-coin]").addClass("is-disable mbgaui-disabled");
            var o = t(e.target).closest("[data-app-exec-by-coin]"),
                a = s._getEntryPointIdFromButtonElem(o);
            u.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                i.forCoinDeferred(a).then(function() {
                    FF.router.loading.hide();
                    var e = "#gacha/anim/coin/";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    FF.env.isWWRegion() && r.getAndTriggerBalance(), t("[data-app-exec-by-coin]").removeClass("is-disable"), s._closeModal()
                })
            })
        },
        _getEntryPointIdFromButtonElem: function(e) {
            var t = this,
                n = e.attr("data-app-exec-by-coin");
            return FF.env.isWWRegion() ? {
                entryPointId: n,
                price: t.entryPointCoin.get("pay_cost"),
                modalOptions: {
                    confirmType: "gacha"
                }
            } : n
        },
        onClickExecByItem: function(e) {
            FF.router.loading.lock();
            var r = this,
                s = t(e.target).closest("[data-app-exec-by-item]"),
                o = +s.attr("data-app-exec-by-item");
            u.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                r.gachaExecItemView = new a, r.gachaExecItemView.render({
                    heading: r.entryPointItem.get("name"),
                    pay_cost: r.entryPointItem.get("pay_cost"),
                    entryPointId: o,
                    selectView: this
                }), r.listenToOnce(r.gachaExecItemView, "confirm", function() {
                    r._closeModal(!0), r.stopListening(r.gachaExecItemView, "closeNotify"), i.forItemOrFreeDeferred(o).then(function() {
                        FF.router.loading.hide();
                        var e = "#gacha/anim/item/";
                        n.history.navigate(e, {
                            trigger: !0
                        })
                    }, function(e) {
                        throw new Error("item gacha exec failed: " + o)
                    })
                }), r.listenToOnce(r.gachaExecItemView, "closeNotify", function() {
                    r.trigger("closeNotify")
                }), r.gachaExecItemView.open()
            })
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        dispose: function() {
            this.gachaExecItemView && this.gachaExecItemView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/ModalError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.seriesName = e, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, this.seriesName)
        },
        onClickModalClose: function() {
            FF.router.loading.show(), location.hash = "title", location.reload(), this.end()
        }
    })
}), define("scenes/gacha/pages/Page", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "scenes/gacha/views/ModalGachaSelected", "scenes/gacha/views/ModalError", "lib/LayoutBase"], function(e, t, n, r, i, s, o) {
    var u = "bgm_06_004";
    return o.extend({
        categoryType: "gacha",
        contentType: "BASE",
        designType: "MODERN",
        setupDeferred: function() {
            this.addBalanceListener(), this.playMusic();
            var e = t.Deferred();
            return e.resolve().promise()
        },
        addBalanceListener: function() {
            var e = this;
            t(document).on("getBalanceForGacha", this.updateCoinNum.bind(this)), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                r.getAndTriggerBalance()
            }, function() {})
        },
        removeBalanceListener: function() {
            t(document).off("getBalanceForGacha"), kickmotor.platform.resetMobageDashboardListener()
        },
        updateCoinNum: function(e, n) {
            t("[data-app-coin-num]").text(n)
        },
        playMusic: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getGachaPageBgm() || u;
            FF.SoundMgr.playMusic(e)
        },
        showModalGachaSelectedBySeriesModelAndEntryPointId: function(t, n) {
            if (!this.seriesModel.isOpened()) {
                this.showErrorModal();
                return
            }
            this.gachaSelectedView && this.gachaSelectedView.dispose();
            var r = t.getEntryPoints(),
                s = e.find(r, function(e) {
                    return e.get("entry_point_id") === n
                });
            this.gachaSelectedView = new i;
            var o = e.find(r, function(e) {
                    return e.get("pay_type_name") === "item" && e.get("lot_num") === s.get("lot_num")
                }),
                u = e.find(r, function(e) {
                    return e.get("pay_type_name") === "coin" && e.get("lot_num") === s.get("lot_num")
                });
            FF.router.overlay.registerChildren(this.gachaSelectedView), this.gachaSelectedView.render({
                entryPointItem: o,
                entryPointCoin: u,
                formattedName: s.getFormattedName()
            }), this.gachaSelectedView.open(!0)
        },
        showErrorModal: function() {
            FF.router.loading.show(), this.modalErrorView = new s({
                seriesName: this.seriesModel.get("series_name")
            }), this.modalErrorView.render(), FF.router.overlay.registerChildren(this.modalErrorView), this.modalErrorView.open()
        },
        dispose: function() {
            this.removeBalanceListener(), this.gachaSelectedView && this.gachaSelectedView.dispose(), this.modalErrorView && this.modalErrorView.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/LineUp", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/gacha/LineUp", "components/FreeScroll", "components/Scrollbar", "components/TimeKeeper", "scenes/common/helper/PopupNotification", "util", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-gacha-top]": "onClickTopView",
            "anchorsbeforejump [data-app-external-url]": "onClickExternalUrl"
        },
        initialize: function(e) {
            this.seriesList = e.seriesList, r.prototype.initialize.call(this)
        },
        render: function() {
            FF.router.loading.show(), this.timeKeeper = new u({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            });
            var e = l.isReleasedByKey("FIRST_ANNIVERSARY_GACHA_OPEN") && !l.isReleasedByKey("FIRST_ANNIVERSARY_GACHA_CLOSE"),
                t = {
                    series_list: this.seriesList,
                    isWWLayout: FF.env.isWWRegion(),
                    timeKeeper: this.timeKeeper,
                    util: f,
                    isDuringPeriod: e
                };
            t.lang = FF.env.getLanguage(), r.prototype.render.call(this, i, t), this.processAfterRender(), this.generateComponents()
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), a.showModalIfNeedPopupNotificationDeferred("GACHA_LINEUP", 0)
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickTopView: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).closest("[data-app-gacha-top]"),
                i = +r.attr("data-app-gacha-top"),
                s = "#gacha/top/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        onClickExternalUrl: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.timeKeeper && this.timeKeeper.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/pages/LineUp", ["underscore", "jquery", "backbone", "./Page", "scenes/gacha/views/LineUp"], function(e, t, n, r, i) {
    return r.extend({
        initialize: function(e) {
            r.prototype.initialize.call(this, e);
            var t = e.datastore.seriesCollection;
            this.view = new i({
                seriesList: t.getWithoutTutorial().sort(t.compareFuncByPriority)
            })
        },
        render: function() {
            this.view.render()
        },
        dispose: function() {
            this.view && this.view.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/ModalGachaItemDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalGachaItemDetail"], function(e, t, n, r, i) {
    var s = 52,
        o = 5e3;
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal"
        },
        initialize: function(e, t) {
            this.stash = e, t.get("logic_name") === "reduced_losing" && +t.get("series_id") >= s || t.get("logic_name") === "plain" && +t.get("series_id") >= o ? this.stash.display_status = {
                level: e.optional_status_by_level.level,
                atk: e.optional_status_by_level.atk,
                def: e.optional_status_by_level.def,
                matk: e.optional_status_by_level.matk,
                mdef: e.optional_status_by_level.mdef,
                mnd: e.optional_status_by_level.mnd,
                acc: e.optional_status_by_level.acc,
                eva: e.optional_status_by_level.eva
            } : this.stash.display_status = {
                isMaxLevel: !0,
                level: e.level_max,
                atk: e.atk_max,
                def: e.def_max,
                matk: e.matk_max,
                mdef: e.mdef_max,
                mnd: e.mnd_max,
                acc: e.acc_max,
                eva: e.eva_max
            }, this.stash.gachaSeriesId = t.get("series_id"), this.stash.gachaSeriesLogic = t.get("logic_name"), this.replaceDispName(), r.prototype.initialize.call(this)
        },
        replaceDispName: function() {
            this.stash.description && (this.stash.description = this.getDispName(this.stash.description)), this.stash.soul_strike && this.stash.soul_strike.description && (this.stash.soul_strike.description = this.getDispName(this.stash.soul_strike.description)), this.stash.soul_strike && this.stash.soul_strike.extensive_description && (this.stash.soul_strike.extensive_description = this.getDispName(this.stash.soul_strike.extensive_description))
        },
        getDispName: function(e) {
            return e.replace(/{n}/g, "<br>")
        },
        render: function() {
            this.renderContent(i, this.stash)
        },
        closeModal: function() {
            this.end()
        }
    })
}), define("scenes/gacha/views/ModalGachaRiseMessage", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalGachaRiseMessage", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.seriesModel = e, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, this.seriesModel), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="riseMessage"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="riseMessage"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/ModalGachaWikiRedirect", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gacha/ModalGachaWikiRedirect"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "closeModal",
            "anchorsbeforejump [data-app-btn-open-wiki]": "openWiki"
        },
        initialize: function(e) {
            this.equipmentAttr = e, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(i, this.equipmentAttr)
        },
        closeModal: function() {
            this.end()
        },
        openWiki: function() {
            this.trigger("openWiki"), this.end()
        }
    })
}), define("templates_ww/gacha/ModalAboutRarity", [], function() {
    return function(a) {
        a || (a = {});
        var b, __p = "",
            __e = _.escape;
        with(a) __p += '<div class="c-modal-window">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene"><div class="c-ttl-scene__inner">About Rarity</div></h1>\n        <div class="ml-b2 mr-b2 mt-b2">\n            <p class="mb-b">Not all items are created equal. There is an ascending level of rarity:</p>\n            <ul class="mb-b">\n                <li>★</li>\n                <li>★★</li>\n                <li>★★★</li>\n                <li>★★★★</li>\n                <li>★★★★★</li>\n            </ul>\n            <p>The rarer the item, the less likely you are to acquire it.</p>\n        </div>\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead mlr-a" data-mbgaui-anchors data-app-btn-close data-app-sound="choose"><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>';
        return __p
    }
}), define("ww/scenes/gacha/views/ModalAboutRarity", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates_ww/gacha/ModalAboutRarity"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-close]": "onClickModalClose"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        render: function() {
            this.putContent(i())
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/gacha/views/plain/Top", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/gacha/Api", "scenes/gacha/Exec", "templates/gacha/plain/Top", "templates/gacha/plain/AdditionalAppealBurst", "components/Button", "components/Carousel", "components/Indicator", "components/FreeScroll", "components/Scrollbar", "ww/scenes/common/views/ModalBuyVC", "components/TimeKeeper"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    return r.extend({
        categoryType: "gacha",
        contentType: "ONLY_MITHRIL_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-go-prb-list]": "onClickGoPrb",
            "anchorsbeforejump [data-app-equip-detail]": "onClickEquipDetail",
            "anchorsbeforejump [data-app-wiki-redirect]": "onClickWikiRedirect",
            "anchorsbeforejump [data-app-exec-by-free]": "onClickExecByFree",
            "anchorsbeforejump [data-app-gacha-selected]": "onClickGachaSelected",
            "anchorsbeforejump [data-app-balance]": "onClickBalance",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal",
            "anchorsbeforejump [data-app-rise-message]": "onClickRiseMessage",
            "anchorsbeforejump [data-app-about-rarity]": "onClickAboutRarity",
            "anchorsbeforejump [data-app-exchange-shop-id]": "onClickGoExchangeShop",
            "anchorsbeforejump [data-app-go-burst-help]": "onClickGoBurstHelp"
        },
        initialize: function(e) {
            this.seriesModel = e.seriesModel, this.soulPieceNum = e.soulPieceNum, this.datastore = e.datastore, this.entryPoints = this.seriesModel.getEntryPoints(), r.prototype.initialize.call(this)
        },
        render: function() {
            FF.router.loading.show(), this.timeKeeper = new d({
                preset: {
                    language: "en",
                    format: "MMDDHHII"
                }
            });
            var e = {
                seriesModel: this.seriesModel,
                seriesId: this.seriesModel.get("series_id"),
                soulPieceNum: this.soulPieceNum,
                entryPoints: this.entryPoints,
                datastore: this.datastore,
                os: kickmotor.nativefn.getNativeOS(),
                name: this.seriesModel.get("series_name"),
                bannerCollection: this.seriesModel.get("bannerCollection").sort(),
                show_closed_at_flg: this.seriesModel.get("show_closed_at_flg"),
                show_prob_rise_flg: this.seriesModel.get("show_prob_rise_flg"),
                rise_message: this.seriesModel.get("rise_message"),
                closed_at: this.seriesModel.get("closed_at"),
                showMobageLegal: FF.env.isShowingMobageLegal(),
                isWWLayout: FF.env.isWWRegion(),
                timeKeeper: this.timeKeeper
            };
            r.prototype.render.call(this, o, e), this.renderAdditionalAppeal(), i.getAndTriggerBalance(), this.generateComponents(), this.addEventListeners(), this.processAfterRender()
        },
        renderAdditionalAppeal: function() {
            var e = t("#additional-appeal-area");
            switch (this.seriesModel.get("additional_appeal_type")) {
                case FF.CONST.SERVER.GACHA.ADDITIONAL_APPEAL.TYPE_OF.BURST:
                    e.append(t(u({
                        seriesModel: this.seriesModel
                    })));
                    return;
                default:
                    return
            }
        },
        generateComponents: function() {
            this.freescroll = new c({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new h({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.btnPrev = new a({
                el: t("#prev"),
                message: -1
            }), this.btnNext = new a({
                el: t("#next"),
                message: 1
            }), this.carousel = new f({
                el: t("[data-ui-carousel]"),
                isLoop: !0,
                autoPlay: !0,
                autoPlayDelay: 5e3,
                direction: 0,
                btnPrev: this.btnPrev,
                btnNext: this.btnNext
            }), this.indicator = new l({
                el: t("[data-ui-indicator]"),
                watch: this.carousel,
                className: "is-active"
            })
        },
        addEventListeners: function() {
            this.listenTo(this.carousel, "moveTo", function() {
                FF.router.loading.lock()
            }).listenTo(this.carousel, "moved", function() {
                FF.router.loading.unlock()
            })
        },
        removeEventListeners: function() {
            this.stopListening(this.carousel, "moveTo").stopListening(this.carousel, "moved")
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#gacha", {
                trigger: !0
            })
        },
        onClickGoPrb: function() {
            this.removeEventListeners(), this.trigger("move:probabilityList")
        },
        onClickExecByFree: function(e) {
            this.removeEventListeners();
            var n = t(e.target).closest("[data-app-exec-by-free]");
            this.trigger("exec:freeGacha", n.attr("data-app-exec-by-free"))
        },
        onClickEquipDetail: function(e) {
            var n = t(e.target).closest("[data-app-banner-id]"),
                r = n.attr("data-app-banner-id"),
                i = this.seriesModel.getBannerModelByBannerId(r);
            if (!i.get("item_id")) return;
            FF.SoundMgr.playChooseEffect(), this.trigger("show:modalItemDetail", r)
        },
        onClickWikiRedirect: function(e) {
            var n = t(e.target).closest("[data-app-banner-id]");
            this.trigger("show:confirmWikiRedirect", n.attr("data-app-banner-id"))
        },
        onClickGachaSelected: function(e) {
            this.removeEventListeners();
            var n = t(e.target).closest("[data-app-gacha-selected]"),
                r = n.attr("data-app-gacha-selected");
            this.trigger("show:modalGachaSelected", parseInt(r, 10))
        },
        onClickRiseMessage: function() {
            FF.SoundMgr.playChooseEffect(), this.trigger("show:modalRiseMessage")
        },
        onClickGoExchangeShop: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).closest("[data-app-exchange-shop-id]"),
                i = +r.attr("data-app-exchange-shop-id"),
                s = "#exchange_shop/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickGoBurstHelp: function(e) {
            FF.router.loading.lock();
            var t = "#html/burst_equipment_" + this.seriesModel.get("series_id");
            n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickBalance: function() {
            if (FF.env.isWWRegion()) this._openBuyVCModal();
            else {
                var e = this.carousel;
                this.lockScreenBeforeGoExternalLink(), kickmotor.platform.showBankDialog(), e.lock(), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                    e.unlock(), e.restartTimer()
                }, function() {})
            }
        },
        _openBuyVCModal: function() {
            this.buyVCModal = new p({});
            var e = t.Deferred();
            this.buyVCModal.openWithDeferredAsDeferred(e), e.promise().always(function() {
                i.getAndTriggerBalance(), FF.router.loading.hide()
            })
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        onClickAboutRarity: function() {
            this.trigger("show:modalAboutRarity")
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.btnPrev && this.btnPrev.dispose(), this.btnNext && this.btnNext.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose(), this.buyVCModal && this.buyVCModal.dispose(), r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/gacha/pages/Top", ["underscore", "jquery", "backbone", "scenes/common/helper/ItemPossessionLimit", "./Page", "scenes/gacha/Exec", "scenes/gacha/views/ModalGachaItemDetail", "scenes/gacha/views/ModalGachaRiseMessage", "scenes/gacha/views/ModalGachaWikiRedirect", "scenes/gacha/Api", "ww/scenes/gacha/views/ModalAboutRarity", "scenes/gacha/views/plain/Top"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        plain: c,
        reduced_losing: c
    };
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e), this.seriesId = e.args[0] - 0;
            var t = e.datastore;
            this.seriesModel = t.seriesCollection.get(this.seriesId);
            var n = h[this.seriesModel.get("logic_name")];
            this.view = new n({
                seriesModel: this.seriesModel,
                soulPieceNum: t.soulPieceNum,
                datastore: t
            }), this.listenTo(this.view, "move:probabilityList", this.goProbabilityList), this.listenTo(this.view, "show:modalRiseMessage", this.showModalRiseMessage), this.listenTo(this.view, "show:confirmWikiRedirect", this.showModalWikiRedirect), this.listenTo(this.view, "show:modalItemDetail", this.showModalItemDetail), this.listenTo(this.view, "show:modalGachaSelected", this.showModalGachaSelected), this.listenTo(this.view, "exec:freeGacha", this.execFreeGacha), FF.env.isWWRegion() && this.listenTo(this.view, "show:modalAboutRarity", this.showModalAboutRarity)
        },
        render: function() {
            this.view.render()
        },
        goProbabilityList: function() {
            FF.router.loading.lock();
            var e = "#gacha/probability/" + this.seriesId;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        execFreeGacha: function(e) {
            FF.router.loading.lock();
            if (!this.seriesModel.isOpened()) {
                this.showErrorModal();
                return
            }
            r.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                s.forItemOrFreeDeferred(e).then(function() {
                    FF.env.isUsingTodayWidget() && kickmotor.platform.saveInSharedMemory("gachaCountdown", f.calculateNextFreeGachaTime());
                    var e = "#gacha/anim/free/";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    FF.logger.debug("free gacha exec error", e), FF.router.loading.hide()
                })
            })
        },
        showModalGachaSelected: function(e) {
            FF.router.loading.lock(), this.showModalGachaSelectedBySeriesModelAndEntryPointId(this.seriesModel, e), this.lockCarousel(this.gachaSelectedView)
        },
        showModalItemDetail: function(e) {
            FF.router.loading.lock();
            var t = this,
                n = this.seriesModel.getBannerModelByBannerId(e),
                r = n.get("equipment");
            this.modalGachaItemDetailView = new o(r, this.seriesModel), FF.router.overlay.registerChildren(this.modalGachaItemDetailView), this.modalGachaItemDetailView.render(), this.modalGachaItemDetailView.open(), this.lockCarousel(this.modalGachaItemDetailView)
        },
        showModalWikiRedirect: function(e) {
            var t = this,
                n = this.seriesModel.getBannerModelByBannerId(e),
                r = n.get("equipment"),
                i = n.get("wiki_url");
            if (!r.has_soul_strike || !i) return;
            FF.router.loading.lock(), this.modalGachaWikiRedirectView = new a(r), FF.router.overlay.registerChildren(this.modalGachaWikiRedirectView), this.modalGachaWikiRedirectView.render(), this.modalGachaWikiRedirectView.open(), this.lockCarousel(this.modalGachaWikiRedirectView), this.listenToOnce(this.modalGachaWikiRedirectView, "openWiki", function() {
                kickmotor.platform.canOpenExternalURL(i, function(e) {
                    if (!e.canOpen) throw new Error("invalid wikiUrl(" + i + ") value.");
                    kickmotor.platform.openExternalURL(i)
                })
            })
        },
        showModalWikiRedirect: function(e) {
            var t = this,
                n = this.seriesModel.getBannerModelByBannerId(e),
                r = n.get("equipment"),
                i = n.get("wiki_url");
            if (!r.has_soul_strike || !i) return;
            FF.router.loading.lock(), this.modalGachaWikiRedirectView = new a(r), FF.router.overlay.registerChildren(this.modalGachaWikiRedirectView), this.modalGachaWikiRedirectView.render(), this.modalGachaWikiRedirectView.open(), this.listenToOnce(this.modalGachaWikiRedirectView, "closeNotify", function() {
                t.view.carousel.restartTimer()
            }), this.listenToOnce(this.modalGachaWikiRedirectView, "openWiki", function() {
                kickmotor.platform.canOpenExternalURL(i, function(e) {
                    if (!e.canOpen) throw new Error("invalid wikiUrl(" + i + ") value.");
                    kickmotor.platform.openExternalURL(i)
                })
            })
        },
        showModalRiseMessage: function() {
            var e = this;
            FF.router.loading.lock(), this.modalGachaRiseMessageView = new u({
                seriesModel: this.seriesModel
            }), this.modalGachaRiseMessageView.render(), FF.router.overlay.registerChildren(this.modalGachaRiseMessageView), this.modalGachaRiseMessageView.open(), this.lockCarousel(this.modalGachaRiseMessageView)
        },
        lockCarousel: function(e) {
            var t = this;
            this.view.carousel.lock(), this.listenToOnce(e, "closeNotify", function() {
                t.view.carousel.unlock(), t.view.carousel.restartTimer()
            })
        },
        showModalAboutRarity: function() {
            this.modalAboutRarityView = new l, this.modalAboutRarityView.render(), FF.router.overlay.registerChildren(this.modalAboutRarityView), this.modalAboutRarityView.open()
        },
        dispose: function() {
            this.view && this.view.dispose(), this.gachaSelectedView && this.gachaSelectedView.dispose(), this.modalGachaRiseMessageView && this.modalGachaRiseMessageView.dispose(), this.modalGachaItemDetailView && this.modalGachaItemDetailView.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/plain/Probability", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/gacha/plain/ProbabilityLayout", "templates/gacha/plain/ProbabilityContent", "components/OverScrollable", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    var a = 10;
    return r.extend({
        categoryType: "gacha",
        contentType: "ONLY_MITHRIL_STATUS",
        designType: "MODERN",
        events: {},
        initialize: function(t) {
            var n = this;
            this.seriesModel = t.seriesModel, this.entryPoints = this.seriesModel.getEntryPoints(), this.data = t.data, this.targetEntryPoint = undefined, e.each(this.entryPoints, function(e) {
                e.set("probability", n.data[e.get("entry_point_id")])
            }), r.prototype.initialize.call(this);
            var i;
            i = e.find(this.entryPoints, function(e) {
                return e.get("lot_num") === 1
            });
            if (!i) {
                var s = e.filter(e.keys(this.data), function(e) {
                    var t = /^[0-9]+$/;
                    return t.test(e)
                });
                i = e.find(this.entryPoints, function(e) {
                    return e.get("entry_point_id") === +s[0]
                })
            }
            this.setupLayoutByEntryPoint(i.get("entry_point_id"))
        },
        setupLayoutByEntryPoint: function(t) {
            this.targetEntryPointId = parseInt(t, 10);
            var n = e.filter(this.entryPoints, function(e) {
                return e.get("entry_point_id") === this.targetEntryPointId
            }, this);
            if (n.length !== 1) throw new Error("no such entryPoint: " + this.targetEntryPointId);
            this.targetEntryPoint = n[0];
            var s = this.targetEntryPoint.get("probability").equipments;
            this.maxPage = Math.ceil(s.length / a);
            var o = {
                targetEntryPointId: this.targetEntryPointId,
                targetEntryPoint: this.targetEntryPoint,
                numRarity: e.keys(this.targetEntryPoint.get("probability").prob_by_rarity).length,
                maxPage: this.maxPage,
                seriesModel: this.seriesModel,
                showProbability: !FF.env.isWWRegion()
            };
            r.prototype.render.call(this, i, o), this.page = 1, this.renderContent(this.page), this.generateComponents(), this.processAfterRender()
        },
        generateComponents: function() {
            this.overscrollable = new o({
                el: t("[data-ui-freescroll]"),
                loading: t("[data-ui-loading]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenTo(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)
        },
        updateByOverscroll: function() {
            if (this.isUpdatingByOverscroll) return;
            FF.router.loading.show(), this.isUpdatingByOverscroll = !0, this.page = this.page + 1, this.renderContent(this.page), this.isUpdatingByOverscroll = !1, this.scrollbar.updateContent(), FF.router.loading.hide()
        },
        renderContent: function(n) {
            if (n < 1) return;
            n > this.maxPage && this.stopListening(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll), this.page = n;
            var r = this.targetEntryPoint.get("probability").equipments,
                i = e.uniq(r).sort(this.seriesModel.gachaProbabilityEquipmentComparator.bind(this.seriesModel)),
                o = (n - 1) * a,
                u = i.slice(o, o + a),
                f = t("#item-rate-area");
            e.each(u, function(e) {
                f.append(t(s(e)))
            }), this.overscrollable && this.overscrollable.updateContent()
        },
        onClickBack: function() {
            this.trigger("move:gachaTop")
        },
        dispose: function() {
            this.scrollbar && this.scrollbar.dispose(), this.overscrollable && this.overscrollable.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/pages/Probability", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "./Page", "scenes/gacha/views/plain/Probability"], function(e, t, n, r, i, s) {
    var o = {
        plain: s,
        reduced_losing: s
    };
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e);
            var t = e.datastore;
            this.seriesId = e.args[0] - 0, this.seriesModel = t.seriesCollection.get(this.seriesId)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return i.prototype.setupDeferred.call(this).done(function() {
                r.gachaProbDeferred(e.seriesId).done(function(t) {
                    e.data = t, n.resolve()
                })
            }), n.promise()
        },
        render: function() {
            var e = o[this.seriesModel.get("logic_name")];
            this.view = new e({
                seriesModel: this.seriesModel,
                data: this.data
            }), this.listenTo(this.view, "move:gachaTop", this.onClickBack)
        },
        onClickBack: function() {
            FF.router.loading.lock();
            var e = "#gacha/top/" + this.seriesId;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        dispose: function() {
            this.view && this.view.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/GachaViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "util"], function(e, t, n, r, i, s, o, u) {
    var a = {
        MAX_GACHA_NUM: 11,
        MAX_LIGHT_LEVEL: 5,
        SUPER_HIGH_SPEED: 200,
        NORMAL_SPEED: 1,
        MAX_STAR: 5,
        DURATION_MSEC_FOR_DISABLE_TAP_ON_ITEM: 800,
        DURATION_MSEC_FOR_WAIT_UNTIL_FIRST_ITEM_DOWN: 900,
        SE: {
            SHOOTING_STAR: "se_gacha_common_100047",
            RARITY_STAR: "se_common_100007",
            DINGLE_NORMAL: "se_common_100008",
            DINGLE_GOOD: "se_common_100009",
            DINGLE_EXCELLENT: "se_common_100010",
            FIREWORK: "se_gacha_common_100048"
        },
        BGM: "bgm_09_105"
    };
    return o.extend({
        nodeStructure: {
            gacha: {
                touch: "gacha_nul"
            },
            ctrl: {
                quake: "bg_quake_nul",
                all: "bg_all_pos_nul"
            },
            bg: {
                noc: "no_charge_nul",
                fee: "fee_gacha_nul"
            },
            magic: {
                1: "magic01_nul",
                2: "magic02_nul",
                3: "magic03_nul",
                4: "magic04_nul",
                5: "magic05_nul",
                6: "magic06_nul",
                7: "magic07_nul",
                8: "magic08_nul",
                9: "magic09_nul",
                10: "magic10_nul",
                11: "magic11_nul"
            },
            picture: {
                noc1: "noc_picture_Lev01_nul",
                noc2: "noc_picture_Lev02_nul",
                noc3: "noc_picture_Lev03_nul",
                noc4: "noc_picture_Lev04_nul",
                fee1: "fee_picture_Lev01_nul",
                fee2: "fee_picture_Lev02_nul",
                fee3: "fee_picture_Lev03_nul",
                fee4: "fee_picture_Lev04_nul"
            },
            item: {
                ctrl: "item_nul"
            },
            itemBackLight: {
                1: "backLightLev1_nul",
                2: "backLightLev2_nul",
                3: "backLightLev3_nul",
                4: "backLightLev4_nul",
                5: "backLightLev5_nul"
            },
            starPos: {
                ctrl: "star_visible_nul"
            },
            itemStar: {
                1: "star01_nul",
                2: "star02_nul",
                3: "star03_nul",
                4: "star04_nul",
                5: "star05_nul",
                "5Congra": "star05Cong_nul"
            },
            sound: {
                burning: "sound_nul"
            }
        },
        isDoneShowItems: void 0,
        isStartedFadeOut: void 0,
        isDisabledTap: void 0,
        hasAlreadySkippedIntro: void 0,
        initialize: function(t, n) {
            FF.logger.debug("init gacha view controller"), kickmotor.nativefn.call("showNativeInfo", {
                isShow: !1,
                x: 4,
                y: 270
            });
            if (!e.isObject(t)) throw new Error("gacha result is empty.");
            this.assets = t.assets, this.entryPointId = t.entryPointId, this.gachaType = t.gachaType, this.equipmentModels = n, this.equipmentModelsForResult = u.cloneDeep(this.equipmentModels), this.maxRarity = e.max(this.equipmentModels, function(e) {
                return e.get("rarity")
            }).get("rarity"), this.hasSoulStrike = e.any(this.equipmentModels, function(e) {
                return e.get("has_soul_strike")
            }), FF.logger.debug("maxRarity", this.maxRarity), FF.logger.debug("hasSoulStrike", this.hasSoulStrike), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            }), this.assetsManager = new s, this.gachaLayer = null, this.currentItemNum = this.equipmentModels.length, this.currentPlaySpeed = a.NORMAL_SPEED, this.deferredObjMap = {
                waitForFirstItemDown: void 0,
                iteration: void 0,
                lightDown: void 0,
                item: void 0,
                fadeAwayItem: void 0
            }, FF.SoundMgr.playMusic(a.BGM)
        },
        _buildNodes: function() {
            var e;
            this.nodeMap = {};
            for (var t in this.nodeStructure)
                if (this.nodeStructure.hasOwnProperty(t)) {
                    this.nodeMap[t] = {};
                    for (var n in this.nodeStructure[t]) this.nodeStructure[t].hasOwnProperty(n) && (this.nodeMap[t][n] = new i({
                        name: this.nodeStructure[t][n],
                        layer: this.gachaLayer.layerName
                    }))
                }
            this.nodeMap.light = {}, this.nodeMap.lightPos = {};
            for (e = 1; e <= a.MAX_GACHA_NUM; e++) this.nodeMap.light[e + ""] = (new i({
                name: "dup_light_" + e,
                layer: this.gachaLayer.layerName,
                parentNodeName: sprintf("light%02s_pos_nul", e),
                duplicateFrom: "light_nul",
                duplicateFromOptions: {
                    parentNode: sprintf("light%02s_pos_nul", e)
                }
            })).process(), this.nodeMap.lightPos[e + ""] = new i({
                name: sprintf("light%02s_pos_nul", e),
                layer: this.gachaLayer.layerName
            });
            (new i({
                name: "light_nul",
                layer: this.gachaLayer.layerName
            })).setVisible(!1).process();
            for (e = 1; e <= a.MAX_GACHA_NUM; e++) this.nodeMap.light[e + ""].createChildNode("light_visible_nul").setVisible(!0).process();
            this.setVisibleTrueExclusively("lightPos", [])
        },
        setVisibleTrueExclusively: function(t, n) {
            FF.logger.debug("setVisibleTrueExclusively", [t, n]), e.isArray(n) || (n = [n]), n = e.map(n, function(e) {
                return e + ""
            }), e.each(this.nodeMap[t], function(e, t) {
                var r = n.indexOf(t) !== -1 ? !0 : !1;
                e.setVisible(r).process()
            })
        },
        switchLightNode: function(e, t) {
            var n;
            for (n = 1; n <= a.MAX_LIGHT_LEVEL; n++) {
                var r = sprintf("lightLev%02s_nul", n),
                    i = n === t ? !0 : !1;
                this.nodeMap.light[e + ""].createChildNode(r).setVisible(i).process()
            }
        },
        loadViewDeferred: function() {
            var n = t.Deferred();
            return this.loadAssetsDeferred().then(e.bind(function() {
                this.loadLayer(), this.prepareNodes(), this.setTouchCallback(), this.startPlaying(), n.resolve()
            }, this)), n.promise()
        },
        loadAssetsDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this._deleteUnusedAssets(), this.assetsManager.populateAssetsDeferred(this.assets).done(function() {
                FF.logger.debug("this.assets", e.assets), n.resolve()
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        _deleteUnusedAssets: function() {
            var t = this,
                n = "gacha_" + this.gachaType,
                r = [];
            e.each(this.assets, function(e, t) {
                t.indexOf("gacha_") !== -1 && t !== n && r.push(t)
            }), e.each(r, function(e) {
                delete t.assets[e]
            })
        },
        loadLayer: function() {
            var e = "gacha_" + this.gachaType,
                t = this.assetsManager.getAssetInfo(e);
            FF.logger.debug("gacha assetInfo", t), this.gachaLayer = new r({
                layerName: t.layerName,
                assetPath: t.assetPath
            }), this.gachaLayer.activate()
        },
        prepareNodes: function() {
            this._buildNodes(), FF.logger.debug("gacha nodes", this.nodeMap), this.setVisibleTrueExclusively("bg", this.gachaType), this.setVisibleTrueExclusively("magic", e.range(1, this.equipmentModels.length + 1)), this.setVisibleTrueExclusively("picture", this.gachaType + this._rarityToTagNum(this.maxRarity)), this.nodeMap.item.ctrl.setVisible(!1).process(), this.tapIconNode = new i({
                name: "tapIcon_pos_null_01",
                layer: this.gachaLayer.layerName
            })
        },
        _rarityToTagNum: function(e) {
            return Math.max(Math.min(e - 1, 4), 1)
        },
        _rarityToLightLevel: function(e, t) {
            return e === 5 && t ? 5 : Math.max(e - 1, 1)
        },
        setTouchCallback: function() {
            this.nodeMap.gacha.touch.addCallback("action_touch_began", e.bind(function() {
                FF.logger.debug("tapped"), this.deferredObjMap.iteration ? this.isDoneShowItems ? this.isStartedFadeOut || this.fadeOut() : this.deferredObjMap.item && !this.isDisabledTap ? (this._stopAndClearCallbacks(this.nodeMap.item.ctrl), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.currentPlaySpeed = a.SUPER_HIGH_SPEED, this.deferredObjMap.item.resolve(), this.deferredObjMap.item = void 0) : this.deferredObjMap.fadeAwayItem ? (this._stopAndClearCallbacks(this.nodeMap.item.ctrl), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.currentPlaySpeed = a.SUPER_HIGH_SPEED, this.deferredObjMap.fadeAwayItem.resolve(), this.deferredObjMap.fadeAwayItem = void 0) : this.deferredObjMap.lightDown && (this._stopAndClearCallbacks(this.nodeMap.lightPos[this.currentItemNum]), this.deferredObjMap.lightDown.resolve(), this.deferredObjMap.lightDown = void 0) : (this.currentPlaySpeed = a.SUPER_HIGH_SPEED, this.deferredObjMap.waitForFirstItemDown ? (this._stopAndClearCallbacks(this.nodeMap.ctrl.all), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.deferredObjMap.waitForFirstItemDown.resolve(), this.deferredObjMap.waitForFirstItemDown = void 0) : this.hasAlreadySkippedIntro || (this._stopAndClearCallbacks(this.nodeMap.ctrl.all), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this.hasAlreadySkippedIntro = !0, this.lightOutAction()))
            }, this)).process()
        },
        _stopAndClearCallbacks: function(e) {
            e.removeAllCallback().stop().process()
        },
        startPlaying: function() {
            var t = this.hasSoulStrike ? this.nodeMap.ctrl.quake : this.nodeMap.ctrl.all;
            this.hasAlreadySkippedIntro = !1, this._playTag(this.nodeMap.ctrl.all, "start", e.bind(function() {
                this._rarityToTagNum(this.maxRarity) === 4 && this.hasSoulStrike && this.nodeMap.ctrl.quake.addCallback("action_downStar_act", e.bind(function() {
                    this._playSEByType("SHOOTING_STAR")
                }, this)), this.preNoticeAction()
            }, this))
        },
        preNoticeAction: function() {
            var t = this.hasSoulStrike ? this.nodeMap.ctrl.quake : this.nodeMap.ctrl.all;
            this._playTag(t, "picture_Lev", e.bind(function() {
                this.lightOutAction()
            }, this))
        },
        lightOutAction: function() {
            var t = this;
            e.each(this.equipmentModels, function(e, t) {
                var n = this._rarityToLightLevel(e.get("rarity"), e.get("has_soul_strike"));
                this.switchLightNode(t + 1, n)
            }, this), this.setVisibleTrueExclusively("lightPos", e.range(1, this.equipmentModels.length + 1)), this._playTag(this.nodeMap.ctrl.all, "light_out", e.bind(function() {
                e.each(this.equipmentModels, e.bind(function(e, t) {
                    this.nodeMap.lightPos[t + 1 + ""].play("light_stay").process()
                }, this)), this.waitForFirstItemDownDeferred().then(function() {
                    t.iterateItem()
                })
            }, this))
        },
        waitForFirstItemDownDeferred: function() {
            var e = this;
            return this.currentPlaySpeed === a.SUPER_HIGH_SPEED ? t.Deferred().resolve().promise() : (this.deferredObjMap.waitForFirstItemDown = t.Deferred(), setTimeout(function() {
                e.deferredObjMap.waitForFirstItemDown && (e.deferredObjMap.waitForFirstItemDown.resolve(), e.deferredObjMap.waitForFirstItemDown = void 0)
            }, a.DURATION_MSEC_FOR_WAIT_UNTIL_FIRST_ITEM_DOWN), this.deferredObjMap.waitForFirstItemDown.promise())
        },
        iterateItem: function() {
            this.deferredObjMap.iteration = t.Deferred(), this.deferredObjMap.iteration.progress(e.bind(function() {
                this.currentEquipmentModel = this.equipmentModels.pop(), this.lightDownActionDeferred().then(e.bind(this.itemActionDeferred, this)).then(e.bind(this.fadeAwayItemDeferred, this)).then(e.bind(function() {
                    this.nodeMap.lightPos[this.currentItemNum].setVisible(!1).process(), this.currentItemNum--, this.deferredObjMap.iteration.notify()
                }, this))
            }, this)), this.deferredObjMap.iteration.notify()
        },
        lightDownActionDeferred: function() {
            this.deferredObjMap.lightDown = t.Deferred(), this.nodeMap.starPos.ctrl.setVisible(!1).process();
            var n = this.currentItemNum;
            return this.equipmentModels.length === 0 && this.nodeMap.sound.burning.stop().process(), this._playTag(this.nodeMap.lightPos[n], "light_down", e.bind(function() {
                this.deferredObjMap.lightDown.resolve(), this.deferredObjMap.lightDown = void 0
            }, this)), this.deferredObjMap.lightDown.promise()
        },
        itemActionDeferred: function() {
            var n = this;
            this.deferredObjMap.item = t.Deferred(), this.nodeMap.starPos.ctrl.setVisible(!0).process(), this.isDisabledTap = !0;
            var r = this.currentEquipmentModel.get("rarity"),
                i = this.currentEquipmentModel.get("has_soul_strike");
            this.currentPlaySpeed = a.NORMAL_SPEED;
            var s = sprintf("item-%s", this.currentEquipmentModel.get("equipment_id")),
                o = this.assetsManager.getAssetInfo(s);
            this.nodeMap.item.ctrl.removeAllCallback().loadBundle(o.bundle).setImage("item_image", o.assetPath).process(), this.setVisibleTrueExclusively("itemBackLight", this._rarityToLightLevel(r, i)), this.setVisibleTrueExclusively("itemStar", Math.min(r, a.MAX_STAR)), this.nodeMap.lightPos[this.currentItemNum].setVisible(!1).process(), r === 5 && i && (this.nodeMap.itemStar["5Congra"].setVisible(!0).process(), this.nodeMap.ctrl.quake.setVisible(!0), this._playTag(this.nodeMap.ctrl.quake, "item", function() {}, {
                isPlayChild: !1
            }), this.nodeMap.picture[this.gachaType + this._rarityToTagNum(this.maxRarity)].play("item", {
                speed: this.currentPlaySpeed
            }).process()), setTimeout(function() {
                n.equipmentModels.length >= 1 && (n.isDisabledTap = !1)
            }, a.DURATION_MSEC_FOR_DISABLE_TAP_ON_ITEM), this.nodeMap.item.ctrl.addCallbackOnce("action_item_out_act", function() {
                n.equipmentModels.length === 0 && (n.isDisabledTap = !1, n.nodeMap.item.ctrl.suspendPlay().process(), n.tapIconNode.setVisible(!0).play("item_last").process(), n.isDoneShowItems = !0)
            });
            var u = function() {
                n._playSEByType("RARITY_STAR")
            };
            for (var f = 1; f <= r; f++) this.nodeMap.item.ctrl.addCallbackOnce("action_count" + f + "_act", u);
            i && this.nodeMap.item.ctrl.addCallbackOnce("action_count6_act", u);
            var l = function(e, t) {
                    return e <= 2 ? "DINGLE_NORMAL" : t ? "DINGLE_EXCELLENT" : "DINGLE_GOOD"
                },
                c = l(r, i);
            this.nodeMap.item.ctrl.addCallbackOnce("action_dingleA_act", function() {
                n._playSEByType(c)
            });
            var h = function() {
                n._playSEByType("FIREWORK")
            };
            if (i)
                for (f = 1; f <= 3; f++) this.nodeMap.item.ctrl.addCallbackOnce("action_hanabi" + f + "_act", h);
            return this.nodeMap.item.ctrl.setVisible(!0), this._playTag(this.nodeMap.item.ctrl, "item", e.bind(function() {
                this.equipmentModels.length > 0 && (this.deferredObjMap.item.resolve(), this.deferredObjMap.item = void 0)
            }, this)), this.deferredObjMap.item.promise()
        },
        fadeAwayItemDeferred: function() {
            return this.deferredObjMap.fadeAwayItem = t.Deferred(), this._stopAndClearCallbacks(this.nodeMap.item.ctrl), this._stopAndClearCallbacks(this.nodeMap.ctrl.quake), this._playTag(this.nodeMap.item.ctrl, "item_fade_out", e.bind(function() {
                this.nodeMap.item.ctrl.setVisible(!1).process(), this.deferredObjMap.fadeAwayItem.resolve(), this.deferredObjMap.fadeAwayItem = void 0
            }, this)), this.deferredObjMap.fadeAwayItem.promise()
        },
        fadeOut: function() {
            this.isStartedFadeOut = !0, this.tapIconNode.suspendParticle().setVisible(!1).process(), this.deferredObjMap.iteration.resolve(), this.dispose(), this.trigger("show:result", this.entryPointId, this.equipmentModelsForResult)
        },
        _playTag: function(e, t, n, r) {
            FF.logger.debug("play tag", t), r = r || {}, r.speed = this.currentPlaySpeed, e.play(t, r).addCallbackOnce("action_stop", function() {
                FF.logger.debug(t + " ended"), n()
            }).process()
        },
        _playSoundEffect: function(t, n) {
            e.isObject(n) || (n = {});
            if (!FF.env.isNative()) return;
            kickmotor.sound.playEffect(t, !!n.loop)
        },
        _stopSoundEffect: function() {
            if (!FF.env.isNative()) return;
            kickmotor.sound.stopEffect()
        },
        _playSEByType: function(e, t) {
            var n = a.SE[e];
            if (!n) throw new Error("Sound effect not found. type:" + e);
            this._playSoundEffect(n, t)
        },
        dispose: function() {
            e.each(this.nodeMap, function(t) {
                e.each(t, function(e) {
                    e.removeAllCallback()
                })
            }), this.assetsManager.destroyAllLayer(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/gacha/pages/Animation", ["underscore", "jquery", "backbone", "util", "scenes/common/Config", "../GachaViewController", "./Page"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function(e) {
            o.prototype.initialize.call(this, e), this.gachaFeeType = e.args[0], this.datastore = e.datastore
        },
        render: function() {
            var e = r.cloneDeep(FF.datastore.stash.gachaExecResult);
            if (!Object.keys(e).length) throw new Error("gacha result info not exists.");
            this.showAnimation(e)
        },
        showAnimation: function(t) {
            FF.router.loading.lock();
            var r = this,
                o = parseInt(t.gacha_series_id, 10),
                u = this.datastore.seriesCollection.get(o);
            kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.GachaAnimation);
            var a = e.map(t.items, function(e) {
                    return e.id
                }),
                f = u.getSortedEquipmentModelsForGachaResult(a);
            this.gachaViewController = new s({
                assets: t.assets,
                gachaType: this.gachaFeeType === "free" ? "noc" : "fee",
                entryPointId: t.gacha_entry_point_id
            }, f), this.gachaViewController.loadViewDeferred(), this.listenToOnce(this.gachaViewController, "show:result", function() {
                n.history.navigate("#gacha/result/", {
                    trigger: !0
                })
            })
        },
        dispose: function() {
            this.gachaViewController && this.gachaViewController.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        partySaveDeferred: function(e, t) {
            var n = e.get("slotToBuddyId"),
                r = FF.datastore.partyStatusModel.isInDungeon() ? 1 : 0;
            return this.requestDeferred("/dff/party/save", {
                slot_to_buddy_id: n,
                row_by_user_buddy_id: t,
                skip_change_party: r
            }, {
                type: "POST"
            })
        },
        partyBulkSaveDeferred: function(e, n, r) {
            r = r || {
                type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.NONE
            };
            var i = t.isEqual(e.getSlotToBuddyId(), FF.datastore.partyModel.getSlotToBuddyId()) ? null : e.getSlotToBuddyId();
            return this.requestDeferred("/dff/party/bulk_save", {
                party: {
                    slot_to_buddy_id: i
                },
                equipment: {
                    data: n.equipment
                },
                soul_strike: {
                    data: n.soulStrike
                },
                ability: {
                    data: n.ability
                },
                row: {
                    data: n.row
                },
                record_materia: {
                    data: n.recordMateria
                },
                dress_record: {
                    data: n.dressRecord
                },
                save_context: r
            }, {
                type: "POST"
            })
        },
        EquipmentSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_equipment", {
                user_equipment_ids: t.isArray(e) ? e : [e]
            }, {
                type: "POST"
            })
        },
        EquipmentSpMaterialSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_equipment_sp_material", {
                user_equipment_sp_material_id_to_num: e
            }, {
                type: "POST"
            })
        },
        AbilitySellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_ability", {
                user_ability_ids: t.isArray(e) ? e : [e]
            }, {
                type: "POST"
            })
        },
        MaterialSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_ability_material", {
                materials: e
            }, {
                type: "POST"
            })
        },
        growEggSellDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/sell_grow_egg", e, {
                type: "POST"
            })
        },
        EquipmentLockDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/lock_equipment", {
                id_to_flag: e
            }, {
                type: "POST"
            })
        },
        AbilityLockDeferred: function(e) {
            return this.requestDeferred("/dff/inventory/lock_ability", {
                id_to_flag: e
            }, {
                type: "POST"
            })
        },
        getBuddyIdToNextRecordMateriaMap: function() {
            return this.requestDeferred("/dff/buddy/next_record_materias", {}, {
                type: "POST"
            })
        },
        getBuddyEvolutionRecipesDeferred: function() {
            return this.requestDeferred("/dff/buddy/evolution_recipes", {}, {
                type: "POST"
            })
        },
        getViewableRecordMateriasDeferred: function() {
            return this.requestDeferred("/dff/buddy/viewable_record_materias", {}, {})
        },
        getGenerationRecipesDeferred: function() {
            return this.requestDeferred("/dff/ability/get_generation_recipes", {}, {
                type: "POST"
            })
        },
        getUpgradeRecipesDeferred: function() {
            return this.requestDeferred("/dff/ability/get_upgrade_recipes", {}, {
                type: "POST"
            })
        },
        generateAbilityDeferred: function(e) {
            return this.requestDeferred("/dff/ability/generate", e, {
                type: "POST"
            })
        },
        upgradeAbilityDeferred: function(e) {
            return this.requestDeferred("/dff/ability/upgrade", e, {
                type: "POST"
            })
        },
        EquipmentEnhanceDeferred: function(e) {
            return this.requestDeferred("/dff/equipment/enhance", e, {
                type: "POST"
            })
        },
        EquipmentEvolveDeferred: function(e) {
            return this.requestDeferred("/dff/equipment/evolve", e, {
                type: "POST"
            })
        },
        BuddyEvolveDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/evolve", e, {
                type: "POST"
            })
        },
        buddySaveEquipmentDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/buddy/save_equipment", {
                equipment: e.equipment,
                soul_strike: e.soulStrike,
                is_recommended: t ? 1 : 0
            }, {
                type: "POST"
            })
        },
        buddySaveAbilityDeferred: function(e, t) {
            return t = t ? 1 : 0, this.requestDeferred("/dff/buddy/save_ability", {
                data: e,
                is_recommended: t
            }, {
                type: "POST"
            })
        },
        buddySaveRecordMateriaDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/save_record_materia", {
                data: e
            }, {
                type: "POST"
            })
        },
        buddySaveDressRecordDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/save_dress_record", {
                data: e
            }, {
                type: "POST"
            })
        },
        buddySaveRowDeferred: function(e) {
            return this.requestDeferred("/dff/buddy/save_row", {
                buddies: e
            }, {
                type: "POST"
            })
        },
        addEquipmentMaxLimitDeferred: function() {
            return FF.logger.debug(this), this.requestDeferred("/dff/item_possession_limit/add_equipment_max_limit", {}, {
                type: "POST"
            })
        },
        addAbilityMaxLimitDeferred: function() {
            return this.requestDeferred("/dff/item_possession_limit/add_ability_max_limit", {}, {
                type: "POST"
            })
        },
        useGrowEggDeferred: function(e) {
            return this.requestDeferred("/dff/grow_egg/use", e, {
                type: "POST"
            })
        },
        getBuddyLevelToExpMapDeferred: function(e) {
            return this.requestDeferred("/dff/grow_egg/get_buddy_level_to_exp_map", e, {})
        },
        getAndTriggerBalance: function() {
            this.getBalanceDeferred().done(function(t) {
                e(document).trigger("getBalanceForPossessionLimit", t)
            })
        },
        toggleOneEquipmentLock: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/inventory/lock_equipment", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        toggleOneAbilityLock: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/inventory/lock_ability", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        toggleEquipmentsLock: function(e, t) {
            var n = this._makeId2FlagForLock(e, t);
            if (!n) throw new Error("lockIds and unlockIds are required.");
            return this.requestDeferred("/dff/inventory/lock_equipment", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        toggleAbilitiesLock: function(e, t) {
            var n = this._makeId2FlagForLock(e, t);
            if (!n) throw new Error("lockIds and unlockIds are required.");
            return this.requestDeferred("/dff/inventory/lock_ability", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        _makeId2FlagForLock: function(e, n) {
            e = e || [], n = n || [];
            if (e.length + n.length === 0) return void 0;
            var r = {};
            return t.each(e, function(e) {
                r[e] = 1
            }), t.each(n, function(e) {
                r[e] = 0
            }), r
        },
        toggleOneRecordMateriaFavoriteDeferred: function(e, t) {
            var n = {};
            return n[e] = t ? 1 : 0, this.requestDeferred("/dff/inventory/set_favorite_record_materia", {
                id_to_flag: n
            }, {
                type: "POST"
            })
        },
        AbilityDecomposeDeferred: function(e) {
            return this.requestDeferred("/dff/ability/decompose", e, {
                type: "POST"
            })
        },
        AbilityMaterialConvertDeferred: function(e) {
            return this.requestDeferred("/dff/ability_material/convert", e, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/helper/BuddiesCanEquipSearcher", ["jquery", "underscore"], function(e, t) {
    return {
        getBuddyModelsAdaptTo: function(e, t) {
            var n;
            if (e.isEquipment()) n = this._equipmentFilter.bind(this);
            else {
                if (!e.isAbility()) throw new Error("Model must be equipment or ability: " + e);
                n = this._abilityFilter.bind(this)
            }
            return this._doIt(e, n, t)
        },
        _doIt: function(e, t, n) {
            var r = n || this._getDefaultBuddyCandidates();
            return r.filter(function(n) {
                return t(n, e)
            })
        },
        _getDefaultBuddyCandidates: function() {
            var e = FF.datastore.buddyCollection;
            return e.changeComparator(), e.sort(), e.models
        },
        _equipmentFilter: function(e, n) {
            var r = n.get("category_id"),
                i = this._extractCategoryIds(e.get("equipment_category"));
            return t.contains(i, r)
        },
        _abilityFilter: function(e, t) {
            var n = t.get("category_id"),
                r = t.get("rarity"),
                i = e.get("ability_category");
            for (var s in i) {
                var o = i[s];
                if (+o.category_id !== n) continue;
                return +o.rarity < r ? !1 : !0
            }
            return !1
        },
        _extractCategoryIds: function(e) {
            var n = [];
            return t.each(e, function(e) {
                n.push(+e.category_id)
            }), n
        }
    }
}), define("scenes/party/views/ModalBuddiesCanEquip", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalBuddiesCanEquip", "scenes/common/helper/BuddiesCanEquipSearcher", "scenes/party/Api", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-back]": "onClickModalBack"
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return FF.datastore.hasPartyAllData() ? e.resolve().promise() : (o.partyListDeferred().done(function(t) {
                FF.datastore.addPartyAllData(t), e.resolve()
            }), e.promise())
        },
        render: function(e) {
            var t = s.getBuddyModelsAdaptTo(e);
            this.renderContent(i, {
                buddies: t,
                isEquipment: e.isEquipment()
            }), this._setupComponents()
        },
        _setupComponents: function() {
            this._freescroll = new u({
                el: t("[data-ui-freescroll-for-can-equip]")
            }), this._scrollbar = new a({
                el: t("[data-ui-scrollbar-for-can-equip]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popAll()
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/helper/ItemLockViewHelper", ["jquery", "underscore"], function(e, t) {
    var n = {
        BTN_ELEM_ATTR: "[data-app-toggle-lock-btn]",
        BTN_LOCKED_CLASS_NAME: "p-locked",
        BTN_UNLOCKED_CLASS_NAME: "p-unlocked",
        LOCKED_CLASS_NAME: "is-locked",
        SORTIE_CLASS_NAME: "is-sortie",
        EQUIPED_CLASS_NAME: "is-in-equip",
        EQUIPED_SUPPORTER_CLASS_NAME: "is-in-equip-by-supporter",
        DISABLE_CLASS_NAME: "is-disable"
    };
    return {
        updateLockButtonView: function(t) {
            var r = e(n.BTN_ELEM_ATTR),
                i = t ? n.BTN_LOCKED_CLASS_NAME : n.BTN_UNLOCKED_CLASS_NAME,
                s = t ? n.BTN_UNLOCKED_CLASS_NAME : n.BTN_LOCKED_CLASS_NAME;
            r.removeClass(s), r.addClass(i)
        },
        updateLockableItemElemBase: function(e, t) {
            if (e === undefined) return;
            e ? t.addClass(n.LOCKED_CLASS_NAME) : t.removeClass(n.LOCKED_CLASS_NAME)
        },
        updateLockableItemElem: function(e, t, n) {
            this.updateLockableItemElemBase(e, t), n && this.updateDisabled(t)
        },
        updateDisabled: function(e) {
            this.isSelectableItemElem(e) ? e.removeClass(n.DISABLE_CLASS_NAME) : e.addClass(n.DISABLE_CLASS_NAME)
        },
        isSelectableItemElem: function(e) {
            return e.hasClass(n.LOCKED_CLASS_NAME) ? !1 : e.hasClass(n.SORTIE_CLASS_NAME) ? !1 : e.hasClass(n.EQUIPED_CLASS_NAME) ? !1 : e.hasClass(n.EQUIPED_SUPPORTER_CLASS_NAME) ? !1 : !0
        },
        updateLockableItemElemForInventory: function(e, t, n) {
            this.updateLockableItemElemBase(e, t), n && this.updateDisabledByLocked(t)
        },
        updateDisabledByLocked: function(e) {
            e.hasClass(n.LOCKED_CLASS_NAME) ? e.addClass(n.DISABLE_CLASS_NAME) : e.removeClass(n.DISABLE_CLASS_NAME)
        }
    }
}), define("scenes/party/views/ModalEquipmentDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalEquipmentDetail", "./ModalBuddiesCanEquip", "scenes/party/helper/ItemLockViewHelper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #buddiesCanEquip": "onClickBuddiesCanEquip",
            "anchorsbeforejump [data-app-toggle-lock]": "onClickToggleLock"
        },
        initialize: function(e) {
            e = e || {}, this.isUserSupporterBuddy = e.isUserSupporterBuddy, this.statusBonusOpt = e.statusBonusOpt || FF.resonator.getResonantStatusBonusOpt(), this.equipStatusBonusOpt = e.equipStatusBonusOpt, i.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.pop(this._equipmentModel.get("is_locked"))
        },
        render: function(e) {
            this._equipmentModel = e, !this.equipStatusBonusOpt && this.statusBonusOpt && (this.equipStatusBonusOpt = e.getStatusBonusOpt(this.statusBonusOpt));
            var t = e.getExpPerNextLvExp(),
                n = e.get("soul_strike_id"),
                r = n ? FF.datastore.soulStrikeCollection.get(n) : null;
            this.renderContent(s, {
                equipmentModel: e,
                soulStrike: r,
                expPerNextLvExp: t,
                isUserSupporterBuddy: this.isUserSupporterBuddy,
                equipStatusBonusOpt: this.equipStatusBonusOpt
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.freescroll = new a({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new f({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBuddiesCanEquip: function() {
            var e = this;
            FF.modalStack.push(o, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(e._equipmentModel)
                }
            })
        },
        onClickToggleLock: function() {
            var e = this,
                t = this._equipmentModel,
                n = t.get("is_locked");
            if (n === undefined) return;
            r.toggleOneEquipmentLock(t.id, !n).done(function() {
                t.set("is_locked", !n), u.updateLockButtonView(!n), FF.modalStack.isHidden() && (e.render(e._equipmentModel), e.open()), FF.router.loading.hide(!0)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/views/plain/Result", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/FreeScroll", "components/Scrollbar", "scenes/gacha/Api", "ww/scenes/common/views/ModalBuyVC", "scenes/common/helper/MissionHelper", "scenes/party/views/ModalEquipmentDetail", "templates/gacha/plain/Result"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
            ACHIEVE_TYPE_NAMES: ["GACHA"]
        },
        h = FF.env.isAndroid() || FF.env.isIOS6_x() || FF.env.isIOS7_x();
    return r.extend({
        categoryType: "gacha",
        contentType: "ONLY_MITHRIL_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-balance]": "onClickBalance",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal",
            "anchorsbeforejump [data-app-exec-by-free]": "onClickExecByFree",
            "anchorsbeforejump [data-app-gacha-selected]": "onClickGachaSelected",
            "anchorsbeforejump [data-app-btn-back-to-top]": "onClickBackToTop",
            "anchorsbeforejump [data-app-equipment]": "onTapEquipment",
            "anchorsbeforejump [data-app-exchange-shop-id]": "onClickGoExchangeShop",
            "anchorslongtap [data-app-equipment]": "onLongTapEquipment"
        },
        initialize: function(t) {
            var n = this;
            this.equipmentModels = t.equipmentModels, this.equipmentIds = e.map(t.equipmentModels, function(e) {
                return e.get("id")
            }), this.entryPoint = t.entryPoint, this.soulPieceNum = t.soulPieceNum, this.canExecAgain = t.canExecAgain, this.mbgaButton = t.mbgaButton, this.seriesModel = t.seriesModel, this.entryPointId = this.entryPoint.get("entry_point_id"), this.hasLongTap = !1, r.prototype.initialize.call(this)
        },
        render: function() {
            var e = this.seriesModel.getSortedEquipmentModelsForGachaResult(this.equipmentIds),
                t = {
                    seriesModel: this.seriesModel,
                    entryPoint: this.entryPoint,
                    equipmentModels: e,
                    soulPieceNum: this.soulPieceNum,
                    canExecAgain: this.canExecAgain,
                    showMobageLegal: FF.env.isShowingMobageLegal(),
                    os: kickmotor.nativefn.getNativeOS()
                };
            r.prototype.render.call(this, l, t), o.getAndTriggerBalance(), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), a.openModalMissionClearIfNeedDeferred(), this.startTwinkleAnimation()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll]"),
                useNativeScroll: h ? !1 : !0
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickGachaSelected: function(e) {
            this.trigger("show:modalGachaSelected")
        },
        onClickExecByFree: function(e) {
            this.trigger("exec:freeGacha")
        },
        onClickBalance: function() {
            if (FF.env.isWWRegion()) {
                this.buyVCModal = new u({});
                var e = t.Deferred();
                this.buyVCModal.openWithDeferredAsDeferred(e), e.promise().always(function() {
                    o.getAndTriggerBalance(), FF.router.loading.hide()
                })
            } else this.lockScreenBeforeGoExternalLink(), kickmotor.platform.showBankDialog()
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        onClickBackToTop: function() {
            FF.router.loading.lock();
            var e = this.seriesModel.isOpened() ? "#gacha/top/" + this.seriesModel.get("series_id") : "#gacha/";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#gacha/", {
                trigger: !0
            })
        },
        onClickGoExchangeShop: function(e) {
            FF.router.loading.lock();
            var r = t(e.target).closest("[data-app-exchange-shop-id]"),
                i = +r.attr("data-app-exchange-shop-id"),
                s = "#exchange_shop/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onTapEquipment: function(e) {
            this.onLongTapEquipment(e)
        },
        onLongTapEquipment: function(e) {
            var n = t(e.target).closest("[data-app-equipment]").attr("data-app-equipment"),
                r = FF.datastore.equipmentCollection.get(+n);
            this.freescroll.cancelScroll(), FF.modalStack.push(f, {
                renderer: function(e) {
                    FF.SoundMgr.playChooseEffect(), e.render(r)
                }
            })
        },
        startTwinkleAnimation: function() {
            t('[data-ui-animation-order="1"]').addClass("animate"), window.setTimeout(function() {
                t('[data-ui-animation-order="2"]').addClass("animate"), window.setTimeout(function() {
                    t('[data-ui-animation-order="3"]').addClass("animate"), window.setTimeout(function() {
                        t('[data-ui-animation-order="4"]').addClass("animate")
                    }, 200)
                }, 200)
            }, 200)
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/pages/Result", ["underscore", "jquery", "backbone", "util", "scenes/common/Config", "scenes/common/helper/ItemPossessionLimit", "./Page", "scenes/gacha/Exec", "scenes/gacha/views/plain/Result"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        plain: a,
        reduced_losing: a
    };
    return o.extend({
        initialize: function(e) {
            o.prototype.initialize.call(this, e), this.makeData(e), this.canExecAgain || e.datastore.clearHasGachaAllData();
            var t = f[this.seriesModel.get("logic_name")];
            this.view = new t({
                equipmentModels: this.equipmentModels,
                entryPoint: this.entryPoint,
                soulPieceNum: this.soulPieceNum,
                canExecAgain: this.canExecAgain,
                seriesModel: this.seriesModel
            }), this.listenTo(this.view, "show:modalGachaSelected", this.showModalGachaSelected), this.listenTo(this.view, "exec:freeGacha", this.execFreeGacha)
        },
        render: function() {
            kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.GachaResult), FF.datastore.stash.gachaExecResult = null, this.view.render()
        },
        showModalGachaSelected: function(e) {
            FF.router.loading.lock(), this.showModalGachaSelectedBySeriesModelAndEntryPointId(this.seriesModel, this.entryPoint.get("entry_point_id"))
        },
        execFreeGacha: function(e) {
            FF.router.loading.lock();
            var t = this.entryPoint.get("entry_point_id");
            s.showModalIfOverLimitDeferred({
                itemTypeNames: ["equipment"]
            }).done(function() {
                u.forItemOrFreeDeferred(t).then(function() {
                    FF.env.isWWRegion() && kickmotor.platform.saveInSharedMemory("gachaCountdown", Api.calculateNextFreeGachaTime());
                    var e = "#gacha/anim/free";
                    n.history.navigate(e, {
                        trigger: !0
                    })
                }, function(e) {
                    throw new Error("free gacha exec failed: " + t)
                })
            })
        },
        makeData: function(t) {
            var n = t.datastore;
            if (!FF.datastore.stash.gachaExecResult) throw new Error("gacha result info not exists.");
            var i = r.cloneDeep(FF.datastore.stash.gachaExecResult),
                s = e.map(i.items, function(e) {
                    return e.id
                }),
                o = parseInt(i.gacha_series_id, 10),
                u = parseInt(i.gacha_entry_point_id, 10),
                a = n.seriesCollection.get(o),
                f = e.find(a.getEntryPoints(), function(e) {
                    return e.get("entry_point_id") === u
                }),
                l = a.getSortedEquipmentModelsForGachaResult(s),
                c = !1,
                h = f.get("executable_num");
            f.set("executable_num", h - 1), f.get("executable_num") > 0 && (c = !0), c && e.has(i, "executable_count") && (i.executable_count || (c = !1)), this.seriesModel = a, this.entryPoint = f, this.equipmentModels = l, this.soulPieceNum = n.soulPieceNum, this.canExecAgain = c
        },
        dispose: function() {
            this.view && this.view.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/gacha/GachaScene", ["underscore", "jquery", "backbone", "scenes/gacha/Api", "lib/Scene", "./Datastore", "./pages/LineUp", "./pages/Top", "./pages/Probability", "./pages/Animation", "./pages/Result"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        initialize: function() {
            this.datastore = new s
        },
        pages: {
            line_up: o,
            top: u,
            probability: a,
            anim: f,
            result: l
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = this.datastore;
            return i.hasGachaAllData() ? n.resolve().promise() : (r.gachaSeriesDeferred().done(function(e) {
                i.soulPieceNum = parseInt(e.soul_piece_num, 10), i.seriesCollection.reset(e.series_list), n.resolve()
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(t, n) {
            var r = this,
                i = t || "line_up";
            i === "result" && !FF.datastore.stash.gachaExecResult && (i = "line_up"), FF.logger.debug("GachaScene: showPage : " + i, n), this.layoutView && this.layoutView.dispose();
            if (!!e.isUndefined(this.pages[i])) throw new Error("invalid page invoked in GachaScene. pageName: " + i);
            this.layoutView = new this.pages[i]({
                datastore: this.datastore,
                args: n
            }), this.layoutView.setupDeferred().done(function() {
                r.layoutView.render(n)
            })
        }
    })
}), define("scenes/friend_invite/views/ModalInviteFacebook", ["underscore", "jquery", "backbone", "templates/friend_invite/ModalInviteFacebook", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-go-facebook]": "onClickGoFacebook"
        },
        render: function() {
            this.renderContent(r, {})
        },
        onClickGoFacebook: function() {
            this.hasGone ? this.end() : (this.trigger("onClickGoFacebook"), this.close(), this.hasGone = !0)
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/friend_invite/views/ModalInviteGooglePlus", ["underscore", "jquery", "backbone", "templates/friend_invite/ModalInviteGooglePlus", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-go-googleplus]": "onClickGoGooglePlus"
        },
        render: function() {
            this.putContent(r())
        },
        onClickGoGooglePlus: function() {
            this.hasGone ? this.end() : (this.trigger("onClickGoGooglePlus"), this.close(), this.hasGone = !0)
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/friend_invite/views/TopLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/friend_invite/Api", "scenes/friend_invite/views/ModalInviteFacebook", "scenes/friend_invite/views/ModalInviteGooglePlus", "scenes/common/helper/FriendInvitePrize", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar", "components/Toast", "sprintf"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        _copyClicked: !1,
        events: {
            "anchorsbeforejump [data-app-copy-invite-id]": "onClickCopyInviteId",
            "anchorsbeforejump [data-app-sns]": "onClickSns",
            "anchorsbeforejump [data-app-prize-detail]": "onClickPrizeDetail",
            "anchorsbeforejump [data-app-btn-register]": "onClickBtnRegister"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this), this.invite_id = e.scene.invite_id, this.campaign = e.scene.campaign, this.user_friend_invite = e.scene.user_friend_invite, this.recommendBrowser = e.scene.recommendBrowser, this.timeKeeper = new a({
                preset: {
                    language: "jp",
                    format: "YYYYMMDDHHII"
                }
            })
        },
        render: function() {
            var e = this,
                t = {
                    invite_id: this.invite_id,
                    campaign: this.campaign,
                    user_friend_invite: this.user_friend_invite,
                    closed_at_str: this.timeKeeper.setUnixTime(this.campaign.closed_at).getString(),
                    recommendBrowser: this.recommendBrowser,
                    enabledServices: this._getEnabledShareSettings(),
                    canJumpToBrowser: this._canJumpToBrowser(),
                    isWWLayout: FF.env.isWWRegion()
                },
                n = this.campaign.id;
            require(["templates/friend_invite/" + n + "/Top"], function(n) {
                r.prototype.render.call(e, n, t), e.generateComponents(), e.processAfterRender()
            })
        },
        generateComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), u.canReceive() && u.checkAndOpenModalIfNeededDeferred()
        },
        onClickCopyInviteId: function() {
            kickmotor.nativefn.call("setPasteboard", {
                text: this.invite_id
            }), this._copyClicked = !0, FF.router.toast.topping(t("[data-app-toast-message-setPaste]").text()).bake()
        },
        onClickSns: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-sns"),
                u = this.campaign.id,
                a = this.invite_id;
            i.friendInvitePostUrlDeferred(u, r, a).then(function() {
                FF.router.loading.hide();
                if (r === "facebook" || r === "fb_messenger") {
                    var e = new s;
                    e.render(), n.listenTo(e, "onClickGoFacebook", n.onClickGoFacebook), FF.router.overlay.registerChildren(e), e.open()
                } else if (r === "googleplus" && FF.env.isIOS()) {
                    var t = new o;
                    t.render(), n.listenTo(t, "onClickGoGooglePlus", n.onClickGoGooglePlus), FF.router.overlay.registerChildren(t), t.open()
                } else r === "other" ? n._callGenericShare(r) : n._onPost(r)
            })
        },
        postingTitle: {
            mail: "【FINAL FANTASY Record Keeper】"
        },
        getPostingText: function(e) {
            var t = FF.Config.client.friendInvite.postingTextOf,
                n = FF.Config.server.baseUrl,
                r = FF.Config.server.invitePathMap;
            if (r.hasOwnProperty(e) && t.hasOwnProperty(e)) {
                var i = n + r[e] + "?" + this.invite_id,
                    s = t[e];
                return s = s(), h(s, i)
            }
            return t.copy
        },
        _onPost: function(e) {
            var t = this,
                n = kickmotor.nativefn.getNativeOS();
            return (e === "facebook" || e === "fb_messenger" || e === "googleplus" && n === "ios") && kickmotor.nativefn.call("setPasteboard", {
                text: t.getPostingText(e)
            }), t._copyClicked && kickmotor.nativefn.call("setPasteboard", {
                text: t.getPostingText("copy")
            }), this.shouldForceFacebookMessenger(e) && (e = "fb_messenger"), n === "ios" ? t._postMessageUsingOS(e, function() {
                t._postMessageUsingURLScheme(e)
            }) : n === "android" && t._postMessageUsingIntent(e, function() {
                t._postMessageUsingURLScheme(e)
            }), !1
        },
        _postMessageUsingOS: function(e, n) {
            var r = this,
                i = kickmotor.nativefn.autoUnregisterCallback(function(i) {
                    var s = {
                        service: e,
                        text: r.getPostingText(e)
                    };
                    e === "twitter" && i.isTwitterAvailable ? (s.callback = "" + t.nativefn.autoUnregisterCallback(t.noop), kickmotor.nativefn.call("postToSocialService", s)) : n()
                });
            kickmotor.nativefn.call("checkSocialService", {
                callback: "" + i
            })
        },
        _postMessageUsingIntent: function(e, n) {
            var r = this,
                i = {
                    facebook: "com.facebook.katana",
                    fb_messenger: "com.facebook.orca",
                    twitter: "com.twitter.android",
                    googleplus: "com.google.android.apps.plus",
                    whatsapp: "com.whatsapp"
                },
                s = t.nativefn.autoUnregisterCallback(function(t) {
                    var s;
                    i[e] && t[i[e]] ? (s = {
                        text: r.getPostingText(e),
                        packageName: i[e]
                    }, kickmotor.nativefn.call("intentShare", s)) : n()
                }),
                o = i[e] || "",
                u = {
                    packageName1: o,
                    packageName2: "",
                    callback: "" + s
                };
            kickmotor.nativefn.call("checkInstalled", u)
        },
        _postMessageUsingURLScheme: function(e) {
            var n = this,
                r, i;
            if (e === "facebook") r = "fb://feed", i = "http://m.facebook.com/";
            else if (e === "fb_messenger") r = "fb-messenger://compose", i = "http://m.facebook.com/messages/";
            else if (e === "twitter") r = "twitter://post?" + n._encodeParam({
                message: n.getPostingText(e)
            }), i = "http://twitter.com/intent/tweet?" + n._encodeParam({
                text: n.getPostingText(e)
            });
            else if (e === "mail") r = "mailto:?" + n._encodeParam({
                subject: n.postingTitle[e],
                body: n.getPostingText(e)
            }), i = r;
            else if (e === "line") {
                var s = t.nativefn.getNativeOS();
                r = "http://line.naver.jp/R/msg/text/?" + encodeURI(n.getPostingText(e)), i = r
            } else if (e === "googleplus") {
                r = "gplus://share?" + n._encodeParam({
                    message: n.getPostingText(e)
                });
                var o = FF.Config.server.baseUrl + FF.Config.server.invitePathMap[e] + "?" + this.invite_id;
                i = "https://plus.google.com/share?url=" + encodeURI(o)
            } else e === "whatsapp" && (r = "whatsapp://send?" + n._encodeParam({
                text: n.getPostingText(e)
            }), i = null);
            var u = kickmotor.nativefn.autoUnregisterCallback(function(t) {
                t.canOpen ? kickmotor.nativefn.call("openExternalURL", {
                    url: r
                }) : i ? kickmotor.nativefn.call("openExternalURL", {
                    url: i
                }) : n._callGenericShare(e)
            });
            kickmotor.nativefn.call("canOpenExternalURL", {
                url: r,
                callback: "" + u
            })
        },
        _callGenericShare: function(e) {
            var t = this;
            if (FF.env.isAndroid()) {
                var n = {
                    text: t.getPostingText(e),
                    packageName: ""
                };
                kickmotor.nativefn.call("intentShare", n)
            } else FF.env.isIOS() && kickmotor.iosgamecenter.checkiOS8Share(function(n) {
                n.enabled ? kickmotor.iosgamecenter.startiOS8Share(t.getPostingText(e), function() {
                    FF.router.loading.hide()
                }, !0) : t.onClickCopyInviteId()
            })
        },
        _canGenericShare: function() {
            return FF.env.isAndroid() || FF.env.isIOSVersionGreaterThanOrEqualTo(8, 0) && this._canShareWithoutScreenshot()
        },
        _canShareWithoutScreenshot: function() {
            return FF.env.isWWRegion() ? kickmotor.nativefn.getAppVersion() >= 406 : !1
        },
        _canJumpToBrowser: function() {
            return FF.env.isWWRegion() ? kickmotor.nativefn.getAppVersion() >= 406 : !0
        },
        _getEnabledShareSettings: function() {
            var t;
            return FF.env.isWWRegion() ? t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !1,
                line: !1,
                googleplus: !this._canGenericShare(),
                whatsapp: !0,
                other: this._canGenericShare()
            } : t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !0,
                line: !0,
                googleplus: !1,
                whatsapp: !1,
                other: !1
            }, e.keys(t).filter(function(e) {
                return t[e]
            })
        },
        _encodeParam: function(e) {
            return t.param(e).replace(/\+/g, "%20").replace(/'/g, "%27")
        },
        onClickGoFacebook: function() {
            this._onPost("facebook")
        },
        onClickGoGooglePlus: function() {
            this._onPost("googleplus")
        },
        onClickPrizeDetail: function() {
            n.history.navigate("friend_invite/prize", {
                trigger: !0
            })
        },
        onClickBtnRegister: function() {
            u.registerAndOpenModalIfNeededDeferred(!0)
        },
        onClickBack: function() {
            var e = this.backPageHash ? this.backPageHash : "#friend";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        shouldForceFacebookMessenger: function(e) {
            return FF.env.isWWRegion() ? e === "facebook" : !1
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend_invite/views/PrizeLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            r.prototype.initialize.call(this), this.campaign = e.scene.campaign, this.timeKeeper = new i({
                preset: {
                    language: "jp",
                    format: "YYYYMMDDHHII"
                }
            })
        },
        render: function() {
            var e = this,
                t = {
                    campaign: this.campaign,
                    closed_at_str: this.timeKeeper.setUnixTime(this.campaign.closed_at).getString(),
                    isWWLayout: FF.env.isWWRegion()
                },
                n = this.campaign.id;
            require(["templates/friend_invite/" + n + "/Prize"], function(n) {
                r.prototype.render.call(e, n, t), e.generateComponents(), e.processAfterRender()
            }), this.enableUserTouch()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("friend_invite", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend_invite/views/ModalNotFound", ["backbone", "templates/friend_invite/ModalNotFound", "lib/ModalBase"], function(e, t, n) {
    return n.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onclickClose"
        },
        render: function(e) {
            this.renderContent(t, {})
        },
        onclickClose: function() {
            this.end(), e.history.navigate("global_menu", {
                trigger: !0
            })
        }
    })
}), define("scenes/friend_invite/views/NotFoundLayout", ["lib/LayoutBase", "templates/friend_invite/NotFound", "./ModalNotFound"], function(e, t, n) {
    return e.extend({
        contentType: "BASE",
        designType: "MODERN",
        initialize: function() {
            e.prototype.initialize.call(this), this.modalNotFoundView = new n({
                el: $(".modal")
            })
        },
        render: function() {
            e.prototype.render.call(this, t, {}), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), FF.router.overlay.registerChildren(this.modalNotFoundView), this.modalNotFoundView.render({}), this.modalNotFoundView.open()
        },
        onClickBack: function() {
            Backbone.history.navigate("global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.modalNotFoundView && this.modalNotFoundView.dispose(), e.prototype.dispose.call(this)
        }
    })
}), define("scenes/friend_invite/FriendInviteScene", ["underscore", "jquery", "backbone", "scenes/friend_invite/Api", "lib/Scene", "./views/TopLayout", "./views/PrizeLayout", "./views/NotFoundLayout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        pages: {
            top: s,
            prize: o,
            not_found: u
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.friendInviteGetDataDeferred().done(function(t) {
                e.invite_id = t.invite_id, e.campaign = t.campaign, e.user_friend_invite = t.user_friend_invite, FF.datastore.stash.canReceiveInviterPrize = t.can_receive_inviter_prize, e.recommendBrowser = t.recommend_browser, FF.datastore.stash.canRegisterFriendInvitation = t.can_register_friend_invitation, FF.datastore.stash.userHash = t.user_hash, n.resolve(t)
            }), n.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred().then(function(n) {
                t.showPage(e)
            })
        },
        showPage: function(e) {
            var t = e || "top";
            this.campaign || (t = "not_found", FF.datastore.stash.friendMenu = void 0), this.layoutView && this.layoutView.dispose();
            if (this.pages[t] === undefined) throw new Error("invalid page invoked in FriendInviteScene. pageName: " + t);
            this.layoutView = new this.pages[t]({
                scene: this
            }), this.layoutView.render()
        }
    })
}), define("scenes/profile/pages/Page", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/LayoutBase", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s) {
    var o = FF.env.isIOS7_0();
    return i.extend({
        categoryType: "home",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        funcTutorialKey: undefined,
        isTutorialIllustOnly: !1,
        initialize: function(t) {
            i.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        },
        render: function(e, t) {
            i.prototype.render.call(this, e, t)
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.showFuncTutorialIfNeed()
        },
        showFuncTutorialIfNeed: function() {
            var e = this.funcTutorialKey;
            e && s.showNavigationDeferred({
                key: e,
                isTutorialIllustOnly: this.isTutorialIllustOnly
            })
        },
        onClickSsLimitationDeferred: function() {
            return this.blurSelectorOrder(), s.showSsLimitationDeferred()
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        },
        onTouchEndSort: function() {
            o && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onMouseMoveSort: function() {
            o && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onFocusSort: function() {
            t(document).trigger("focusInput")
        },
        onBlurSort: function() {
            o && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").show(), FF.env.isIOS() && setTimeout(function() {
                window.scrollTo(0, 1)
            }, 100)
        }
    })
}), define("scenes/profile/pages/Profile", ["underscore", "jquery", "backbone", "kickmotor", "./Page", "scenes/common/models/Profile", "scenes/common/util/Api", "scenes/common/helper/FuncTutorial", "templates/profile/Profile"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        funcTutorialKey: "PROFILE",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump [data-app-change-nickname]": "onClickChangeNickname",
            "anchorsbeforejump [data-app-change-comment]": "onClickChangeComment",
            "anchorsbeforejump [data-app-change-equipment]": "onClickChangeEquipment",
            "anchorsbeforejump [data-app-copy-invite-id]": "onClickCopyInviteId"
        },
        initialize: function() {
            this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, i.prototype.initialize.apply(this, arguments)
        },
        render: function(e) {
            this.invite_id = FF.datastore.userSupporterBuddyModel.get("invite_id"), i.prototype.render.call(this, a, {
                userSupporterBuddyModel: this.userSupporterBuddyModel,
                soulStrikeModel: this.userSupporterBuddyModel.getSoulStrikeModel(),
                inviteId: this.invite_id,
                hasUnlockedFellow: FF.datastore.userModel.hasUnlockedFellow()
            }), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.showFuncTutorialIfNeed()
        },
        showFuncTutorialIfNeed: function() {
            var e = this.funcTutorialKey;
            e && u.showNavigationDeferred({
                key: e,
                isTutorialIllustOnly: this.isTutorialIllustOnly
            })
        },
        onClickChangeNickname: function() {
            n.history.navigate("#update_nickname", {
                trigger: !0
            })
        },
        onClickChangeComment: function() {
            n.history.navigate("#configure_profile_message", {
                trigger: !0
            })
        },
        onClickChangeEquipment: function() {
            n.history.navigate("#profile/equipment_change", {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#friend", {
                trigger: !0
            })
        },
        onClickCopyInviteId: function() {
            r.nativefn.call("setPasteboard", {
                text: this.invite_id
            }), FF.router.toast.topping(t("[data-app-toast-message-setPaste]").text()).bake()
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        saveSupporterBuddyDeferred: function(e) {
            return this.requestDeferred("/dff/supporter_buddy/save_supporter_buddy", {
                data: {
                    user_buddy_id: e.userBuddyId,
                    soul_strike_id: e.soulStrikeId,
                    weapon_id: e.weaponId,
                    armor_id: e.armorId,
                    accessory_id: e.accessoryId,
                    dress_record_id: e.dressRecordId
                },
                need_dress_record_change_data: e.needDressRecordChangeData
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/party/views/ModalCharacterAvailableType", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalCharacterAvailableType", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack"
        },
        render: function(e, t) {
            var n = s({
                abilityCategoryObjMap: this.getSortedObj(e, this.sortByCategoryIdAsc),
                equipCategoryObjMap: this.getSortedObj(t, this.sortByCategoryIdAsc)
            });
            this.putContent(n), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll1 = new o({
                el: t("[data-ui-freescroll-for-set-type]"),
                useNativeScroll: !1
            }), this.scrollbar1 = new u({
                el: t("[data-ui-scrollbar-for-set-type]"),
                watch: this.freescroll1,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.freescroll2 = new o({
                el: t("[data-ui-freescroll-for-set-equip]"),
                useNativeScroll: !1
            }), this.scrollbar2 = new u({
                el: t("[data-ui-scrollbar-for-set-equip]"),
                watch: this.freescroll2,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        getSortedObj: function(t, n) {
            return e.map(t, function(e) {
                return e
            }).sort(n)
        },
        sortByCategoryIdAsc: function(e, t) {
            return +e.category_id < +t.category_id ? -1 : +e.category_id > +t.category_id ? 1 : 0
        },
        dispose: function() {
            this.freescroll1 && this.freescroll1.dispose(), this.scrollbar1 && this.scrollbar1.dispose(), this.freescroll2 && this.freescroll2.dispose(), this.scrollbar2 && this.scrollbar2.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/views/ModalBuddyDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "scenes/party/views/ModalCharacterAvailableType", "templates/profile/views/ModalBuddyDetail"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType"
        },
        initialize: function(e) {
            this.buddyModel = e, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, i.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(o, {
                buddy: this.buddyModel,
                buddyStatus: this.getBuddyStatus(),
                soulStrike: this.getSoulStrikeModel()
            })
        },
        getSoulStrikeModel: function() {
            return this.buddyModel.isSelectedForSupporterBuddy() ? this.userSupporterBuddyModel.getSoulStrikeModel() : this.buddyModel.getDefaultSoulStrikeModel()
        },
        getBuddyStatus: function() {
            var e = this.buddyModel.isSelectedForSupporterBuddy();
            return {
                hp: e ? this.userSupporterBuddyModel.hp() : this.buddyModel.get("hp"),
                atk: e ? this.userSupporterBuddyModel.atk() : this.buddyModel.get("atk"),
                def: e ? this.userSupporterBuddyModel.def() : this.buddyModel.get("def"),
                matk: e ? this.userSupporterBuddyModel.matk() : this.buddyModel.get("matk"),
                mdef: e ? this.userSupporterBuddyModel.mdef() : this.buddyModel.get("mdef"),
                mnd: e ? this.userSupporterBuddyModel.mnd() : this.buddyModel.get("mnd"),
                acc: e ? this.userSupporterBuddyModel.acc() : this.buddyModel.get("acc"),
                eva: e ? this.userSupporterBuddyModel.eva() : this.buddyModel.get("eva"),
                spd: e ? this.userSupporterBuddyModel.spd() : this.buddyModel.get("spd")
            }
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        onClickAvailableType: function() {
            var e = this.buddyModel;
            FF.modalStack.push(s, {
                renderer: function(t) {
                    var n = e.get("ability_category"),
                        r = e.get("equipment_category");
                    t.render(n, r)
                }
            })
        }
    })
}), define("scenes/profile/views/BuddyList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/profile/views/BuddyList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-buddy]": "onClickBuddyListItem"
        },
        initialize: function() {
            this.userSupporterBuddyModelId = FF.datastore.userSupporterBuddyModel.get("id")
        },
        render: function(e) {
            var t = r.process(i, {
                buddyCollection: e.buddyCollection,
                userSupporterBuddyModelId: this.userSupporterBuddyModelId,
                userSupporterBuddyModel: FF.datastore.userSupporterBuddyModel
            });
            this.$el.html(t)
        },
        updateSelectedClassByBuddyId: function(e) {
            this.$el.find("[data-app-buddy-list]").removeClass("is-in-equip-by-supporter"), this.$el.find("[data-app-buddy=" + e + "]").closest("[data-app-buddy-list]").addClass("is-in-equip-by-supporter")
        },
        getDomName: function(e) {
            return '[data-app-buddy="' + e + '"]'
        },
        activate: function(e) {
            t(this.getDomName(e)).addClass("is-active")
        },
        deactivate: function(e) {
            t(this.getDomName(e)).removeClass("is-active")
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickBuddyListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var n = t(e.target),
                r = n.hasClass("is-active"),
                i = +n.attr("data-app-buddy");
            r ? (n.removeClass("is-active"), i = null) : (t("[data-app-buddy]").removeClass("is-active"), n.addClass("is-active")), this.trigger("onClickBuddyListItem", {
                id: i
            }), FF.SoundMgr.playChooseEffect()
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/common/ui_module/ModalSortModuleViewSwitcher", ["underscore", "jquery", "scenes/common/Constant", "lib/ClassBase", "lib/TextMaster"], function(e, t, n, r, i) {
    var s = n.SORT_MODULE,
        o = {
            HIDE_CLASS: "di-n",
            INDEX_SORT_TYPE: 0,
            INDEX_ORDER_TYPE: 1,
            INDEX_SUB_SORT_TYPE: 2,
            INDEX_BUTTON_FACE: 3,
            INDEX_DISPLAY_KEY: 4
        };
    return r.extend({
        initialize: function(e, t, n, r, i, s, o) {
            this._sortType2SubSortTypes = this._makeSubSortTypeMap(e), this._sortType2OrderLabels = this._makeOrderButtonLabelMap(e), this._sortType2ButtonFace = this._makeButtonFaceMap(e), this._sortType2DisplayKeys = this._makeDisplayKeyMap(e), this._altSortTypeNames = e.altSortTypeNames, this._sortButtons = t.getButtons(), this._orderButtons = n.getButtons(), this._priorSeriesButtons = r.getButtons(), this._charaRoleButtons = i.getButtons(), this._abilityTypeButtons = s.getButtons(), this._resonanceButtons = o.getButtons(), this._subSortButtonTags = this._makeSubSortButtonTags(), this._currentSubSortType = e.defaultSubSortType, this._currentResonanceId = void 0, this._hideAllSubSortButtonsView(), this.updateSubSortButtonsView(e.defaultSortType)
        },
        _makeSubSortTypeMap: function(e) {
            return this._mapSortTypeToTargetParam(e, o.INDEX_SUB_SORT_TYPE)
        },
        _makeButtonFaceMap: function(e) {
            return this._mapSortTypeToTargetParam(e, o.INDEX_BUTTON_FACE)
        },
        _makeDisplayKeyMap: function(e) {
            return this._mapSortTypeToTargetParam(e, o.INDEX_DISPLAY_KEY)
        },
        _mapSortTypeToTargetParam: function(t, n) {
            var r = {};
            return e.each(t.sortTypeList, function(e) {
                var t = e[o.INDEX_SORT_TYPE],
                    i = e[n];
                if (!i) return;
                r[t] = i
            }), r
        },
        _makeOrderButtonLabelMap: function(t) {
            var n = {};
            return e.each(t.sortTypeList, function(e) {
                var r = e[o.INDEX_SORT_TYPE],
                    i = e[o.INDEX_ORDER_TYPE];
                if (!i || i === s.ORDER_DESC_TYPE_OF.NONE) return;
                n[r] = t.orderTypeMap[i]
            }), n
        },
        _makeSubSortButtonTags: function() {
            var e = s.SUB_SORT_TYPE_OF,
                t = {};
            return t[e.ASC_OR_DESC] = "[data-app-order-btns]", t[e.SERIES_ID] = "[data-app-series-btns]", t[e.CHARA_ROLE] = "[data-app-chara-role-btns]", t[e.ABILITY] = "[data-app-ability-type-btns]", t
        },
        getCurrentSubSortType: function() {
            return this._currentSubSortType
        },
        getSubSortTypeBy: function(e) {
            return this._sortType2SubSortTypes[e]
        },
        updateSubSortButtonsView: function(e) {
            var t = e || this._sortButtons.getSelectedType();
            if (!t) return;
            var n = this._sortType2SubSortTypes[t];
            if (!n) return;
            if (n === this._currentSubSortType) return;
            this._currentSubSortType = n, this._hideAllSubSortButtonsView(), this._showSubSortButtonsBy(n)
        },
        updateOrderButtonLabels: function() {
            var e = this._sortButtons.getSelectedType();
            if (!e) return;
            var n = this._sortType2OrderLabels[e];
            if (!n) return;
            t("[data-app-sort-order-desc-btn-label]").html(n[0]), t("[data-app-sort-order-asc-btn-label]").html(n[1])
        },
        updateSelectedSortTypeLabel: function() {
            var e = this._sortButtons.getSelectedType();
            if (!e) return;
            var n = this._sortType2ButtonFace[e] || "";
            t("[data-app-sort-selected-sort-type]").html(n)
        },
        updateCurrentSelectStatusView: function() {
            var e = this.getSelectedSortSummary(!1);
            t("[data-app-sort-module-sort-type-summary]").html(e);
            var n = this._resonanceButtons.getSelectedType() || FF.resonator.getResonantSeriesId();
            this._updateCurrentResonanceIconView(n)
        },
        getSelectedSortSummary: function(e, t, n, r, i, o) {
            var u = t || this._sortButtons.getSelectedType(),
                a = n || this._orderButtons.getSelectedType(),
                f = this._sortType2SubSortTypes[u],
                l = this._getSortButtonFaceForSummary(u, e),
                c = s.SUB_SORT_TYPE_OF;
            switch (f) {
                case c.ASC_OR_DESC:
                    return this._getSortSummaryForAscOrDesc(u, a, l);
                case c.SERIES_ID:
                    return this._getSortSummaryForPriorSeries(r, e);
                case c.CHARA_ROLE:
                    return this._getSortSummaryForCharaRoleType(i, e);
                case c.ABILITY:
                    return this._getSortSummaryForAbilityType(o, e)
            }
            return l
        },
        getDisplayKey: function(e) {
            return this._sortType2DisplayKeys[e] || void 0
        },
        _showSubSortButtonsBy: function(e) {
            var n = this._subSortButtonTags[e];
            if (!n) return;
            t(n).removeClass(o.HIDE_CLASS)
        },
        _hideAllSubSortButtonsView: function() {
            e.each(this._subSortButtonTags, function(e) {
                t(e).addClass(o.HIDE_CLASS)
            })
        },
        _getSortButtonFaceForSummary: function(e, t) {
            var n = this._altSortTypeNames[e];
            return n ? t && n.short ? n.short : !t && n.long ? n.long : this._sortType2ButtonFace[e] : this._sortType2ButtonFace[e]
        },
        _updateCurrentResonanceIconView: function(e) {
            if (this._currentResonanceId === e) return;
            var n = t("[data-app-sort-module-resonance-summary]");
            if (!n.size()) return;
            if (this._currentResonanceId) {
                var r = "p-icon-" + this._currentResonanceId;
                n.removeClass(r)
            }
            this._currentResonanceId = e;
            if (!e) return;
            var i = "p-icon-" + e;
            n.addClass(i)
        },
        _getSortSummaryForAscOrDesc: function(e, t, n) {
            var r = t === FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC,
                s = this._sortType2OrderLabels[e],
                o = r ? 0 : 1,
                u = s ? s[o] : "",
                a = i.getInstance().safeGetf("sortmodal_format_order", n, u) || "";
            return a
        },
        _getSortSummaryForPriorSeries: function(e, t) {
            var n = e || this._priorSeriesButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_series_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        },
        _getSortSummaryForCharaRoleType: function(e, t) {
            var n = e || this._charaRoleButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_chara_role_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        },
        _getSortSummaryForAbilityType: function(e, t) {
            var n = e || this._abilityTypeButtons.getSelectedType(),
                r = t ? "short" : "long",
                s = "sortmodal_" + r + "_summary_ability_type_" + n,
                o = i.getInstance().safeGet(s) || "";
            return o
        }
    })
}), define("scenes/common/ui_module/SortButtonComponent/MonoSelector", ["underscore", "jquery", "lib/ClassBase", "components/CookieMania"], function(e, t, n, r) {
    return n.extend({
        _defaultOptions: {
            toggleMode: !0,
            cookieKey: void 0,
            targetTag: "a",
            selectCssClass: "is-disable"
        },
        initialize: function(t, n) {
            if (!t) throw new Error("typeId is required.");
            this._typeId = t, this._options = e.defaults(n || {}, this._defaultOptions), this._selectedButton = void 0, this._selectedType = void 0, this._cookieMania = new r
        },
        initButton: function(e) {
            if (!e) return;
            var n = t(this._options.targetTag + "[" + this._typeId + '|="' + e + '"]');
            if (!n.length) return;
            this._selectButton(n, e)
        },
        getSelectedType: function() {
            return this._selectedType
        },
        saveToCookie: function() {
            var e = this._options.cookieKey;
            if (!e) return;
            this._cookieMania.set(e, this._selectedType)
        },
        onClick: function(e) {
            var n = t(e.target),
                r = n.attr(this._typeId);
            this._options.toggleMode ? this._onClickInToggleMode(n, r) : this._onClickNotInToggleMode(n, r)
        },
        _onClickInToggleMode: function(e, t) {
            t === this._selectedType ? this._deselectButton(this._selectedButton) : this._onClickNotInToggleMode(e, t)
        },
        _onClickNotInToggleMode: function(e, t) {
            this._selectedButton && this._deselectButton(this._selectedButton), this._selectButton(e, t)
        },
        _selectButton: function(e, t) {
            e.addClass(this._options.selectCssClass), this._selectedButton = e, this._selectedType = t
        },
        _deselectButton: function(e) {
            e.removeClass(this._options.selectCssClass), this._selectedButton === e && (this._selectedButton = void 0, this._selectedType = !1)
        }
    })
}), define("scenes/common/ui_module/SortButtonComponent/SortButtonComponentBase", ["backbone", "./MonoSelector"], function(e, t) {
    return e.View.extend({
        buttonTypeId: void 0,
        defaultParamKey: void 0,
        cookieId: void 0,
        toggleMode: void 0,
        targetTag: void 0,
        selectCssClass: void 0,
        initialize: function(e) {
            this._validateAttrs(), this._buttons = new t(this.buttonTypeId, {
                toggleMode: this.toggleMode,
                cookieKey: e[this.cookieId],
                targetTag: this.targetTag,
                selectCssClass: this.selectCssClass
            }), this._clickHook = void 0
        },
        getButtons: function() {
            return this._buttons
        },
        getSelectedType: function() {
            return this._buttons.getSelectedType()
        },
        setClickHook: function(e) {
            this._clickHook = e
        },
        saveToCookie: function() {
            this._buttons.saveToCookie()
        },
        selectDefault: function(e) {
            this._buttons.initButton(e[this.defaultParamKey])
        },
        onClick: function(e) {
            this._buttons.onClick(e), this._clickHook && this._clickHook()
        },
        _validateAttrs: function() {
            if (!this.buttonTypeId) throw new Error("buttonTypeId is required.");
            if (!this.defaultParamKey) throw new Error("defaultParamKey is required.");
            if (!this.cookieId) throw new Error("cookieId is required.")
        },
        dispose: function() {
            this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/common/ui_module/SortButtonComponent/MainSortButtonComponent", ["./SortButtonComponentBase"], function(e) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-main-sort-btn]": "onClick"
        },
        buttonTypeId: "data-app-main-sort-type",
        defaultParamKey: "defaultSortType",
        cookieId: "sort",
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/OrderButtonComponent", ["./SortButtonComponentBase"], function(e) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-order-asc-btn]": "onClick",
            "anchorsbeforejump [data-app-sort-order-desc-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-order-type",
        defaultParamKey: "defaultOrderType",
        cookieId: "order",
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/PriorSeriesButtonComponent", ["./SortButtonComponentBase"], function(e) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-prior-series-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-prior-series-id",
        defaultParamKey: "defaultPriorSeriesId",
        cookieId: "priorSeries",
        toggleMode: !1,
        targetTag: "div",
        selectCssClass: "is-active"
    })
}), define("scenes/common/ui_module/SortButtonComponent/CharaRoleButtonComponent", ["./SortButtonComponentBase"], function(e) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-chara-role-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-chara-role-type",
        defaultParamKey: "defaultCharaRoleType",
        cookieId: "charaRole",
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/AbilityTypeButtonComponent", ["./SortButtonComponentBase"], function(e) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-ability-type-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-ability-type",
        defaultParamKey: "defaultAbilityType",
        cookieId: "abilityType",
        toggleMode: !1,
        targetTag: void 0,
        selectCssClass: "is-selected"
    })
}), define("scenes/common/ui_module/SortButtonComponent/ResonanceButtonComponent", ["./SortButtonComponentBase"], function(e) {
    return e.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-resonance-btn]": "onClick"
        },
        buttonTypeId: "data-app-sort-resonance-series-id",
        defaultParamKey: "defaultResonanceSeriesId",
        cookieId: "resonance",
        toggleMode: !0,
        targetTag: "div",
        selectCssClass: "is-active"
    })
}), define("scenes/common/ui_module/ModalSortModule", ["underscore", "jquery", "scenes/common/Constant", "lib/ModalBase", "lib/TemplateRenderer", "templates/common/ui_module/ModalSortModule", "templates/common/ui_module/sort_module/MainSortTypeList", "templates/common/ui_module/sort_module/SubSortTypeList", "templates/common/ui_module/sort_module/ResonanceSeriesButtons", "components/CookieMania", "components/Tab", "components/FreeScroll", "components/Scrollbar", "./ModalSortModuleViewSwitcher", "./SortButtonComponent/MainSortButtonComponent", "./SortButtonComponent/OrderButtonComponent", "./SortButtonComponent/PriorSeriesButtonComponent", "./SortButtonComponent/CharaRoleButtonComponent", "./SortButtonComponent/AbilityTypeButtonComponent", "./SortButtonComponent/ResonanceButtonComponent"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    var w = e.extend(n, {
        HIDE_CLASS: "di-n",
        DISABLE_CLASS: "is-disable",
        SORT_TAB_INDEX: "0"
    });
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-sort-module-decide]": "onDecideSortClick",
            "anchorsbeforejump [data-app-modal-close]": "onModalCloseClick",
            "anchorsbeforejump [data-app-main-sort-btn]": "onSortButtonClick"
        },
        _defaultRenderParams: {
            sortTypeList: [],
            orderTypeMap: {},
            altSortTypeNames: {},
            defaultSortType: void 0,
            defaultOrderType: void 0,
            defaultPriorSeriesId: void 0,
            defaultCharaRoleType: void 0,
            defaultAbilityType: void 0,
            defaultResonanceSeriesId: void 0,
            isResonanceSimAvailable: !0
        },
        initialize: function(e) {
            this._tabPanes = [], this._tab = void 0, this._cookieMania = new f, this._buttonComponents = this._initButtonComponents(e)
        },
        _initButtonComponents: function(t) {
            var n = [this._sortButtons = new d(t), this._orderButtons = new v(t), this._priorSeriesButtons = new m(t), this._charaRoleButtons = new g(t), this._abilityTypeButtons = new y(t), this._resonanceButtons = new b(t)],
                r = this;
            return e.each(n, function(e) {
                e.setClickHook(r._buttonClickHook.bind(r))
            }), n
        },
        render: function(t) {
            var n = e.defaults(t || {}, this._defaultRenderParams);
            this._renderTemplates(n), this._initComponents(n), this._viewSwitcher = new p(n, this._sortButtons, this._orderButtons, this._priorSeriesButtons, this._charaRoleButtons, this._abilityTypeButtons, this._resonanceButtons), this._viewSwitcher.updateOrderButtonLabels(), this._viewSwitcher.updateSelectedSortTypeLabel(), this._viewSwitcher.updateCurrentSelectStatusView(), this._isResonanceSimAvailable = n.isResonanceSimAvailable
        },
        _renderTemplates: function(e) {
            this.renderContent(s, {
                isResonanceSimAvailable: e.isResonanceSimAvailable
            });
            var n = i.process(o, {
                    sortTypeList: e.sortTypeList
                }),
                r = i.process(u, {
                    ABILITY_TYPE_OF: FF.CONST.SERVER.ABILITY.CATEGORY_TYPE_OF
                }),
                f = i.process(a, {});
            t("[data-app-sort-module-main-sort-pane]").html(n), t("[data-app-sort-module-sub-sort-pane]").html(r), t("[data-app-sort-module-resonance-pane]").html(f)
        },
        _initComponents: function(t) {
            this._initScrollArea(), this._initTab(t), e.each(this._buttonComponents, function(e) {
                e.selectDefault(t)
            })
        },
        _initTab: function(e) {
            this._tabPanes = t('[data-ui-group="sort-module-pane"]'), this._tab = new l({
                tabs: t('[data-ui-group="sort-module-tab"]'),
                panes: this._tabPanes,
                className: "is-current",
                defaultPage: 0
            });
            var n = this._loadLastTab();
            n && e.isResonanceSimAvailable && this._tab.changeState(n), this._tab.hideInactivePanes(), this.listenTo(this._tab, "changedState", this._onTabStateChange)
        },
        _saveLastTab: function(e) {
            var t = w.COOKIE_KEYS.SORT_MODULE.LAST_TAB;
            this._cookieMania.set(t, e)
        },
        _loadLastTab: function() {
            var e = w.COOKIE_KEYS.SORT_MODULE.LAST_TAB;
            return this._cookieMania.get(e)
        },
        _onTabStateChange: function(e) {
            var n = t(e.prevPane),
                r = t(e.currentPane);
            n.addClass(w.HIDE_CLASS), r.removeClass(w.HIDE_CLASS);
            var i = "" + e.index;
            this._saveLastTab(i), e.index === w.SORT_TAB_INDEX && this._onSortTabActivate()
        },
        _onSortTabActivate: function() {
            this._scrollbar4MainSort.updateContent(), this._scrollbar4SubSort.updateContent()
        },
        _initScrollArea: function() {
            this._freescroll4MainSort = new c({
                el: t("[data-ui-freescroll-for-main-sort]")
            }), this._scrollbar4MainSort = new h({
                el: t("[data-ui-scrollbar-for-main-sort]"),
                watch: this._freescroll4MainSort,
                faceHeight: 31,
                disableOverscroll: !0
            }), this._freescroll4SubSort = new c({
                el: t("[data-ui-freescroll-for-sub-sort]")
            }), this._scrollbar4SubSort = new h({
                el: t("[data-ui-scrollbar-for-sub-sort]"),
                watch: this._freescroll4SubSort,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _makeResultMessage: function() {
            var e = this._sortButtons.getSelectedType(),
                t = this._viewSwitcher.getCurrentSubSortType(),
                n = w.SORT_MODULE.SUB_SORT_TYPE_OF,
                r = t === n.ASC_OR_DESC ? this._orderButtons.getSelectedType() : void 0,
                i = t === n.SERIES_ID ? this._priorSeriesButtons.getSelectedType() : void 0,
                s = t === n.CHARA_ROLE ? this._charaRoleButtons.getSelectedType() : void 0,
                o = t === n.ABILITY ? this._abilityTypeButtons.getSelectedType() : void 0,
                u = this._getCtxBasedResonantSeriesId(this._isResonanceSimAvailable) || +this._resonanceButtons.getSelectedType() || void 0;
            return {
                sortType: e,
                orderType: r,
                priorSeriesId: +i || void 0,
                charaRoleType: +s || void 0,
                abilityType: +o || void 0,
                resonanceSeriesId: u,
                buttonFace: this._viewSwitcher.getSelectedSortSummary(!0),
                displayKey: this._viewSwitcher.getDisplayKey(e)
            }
        },
        getDefaultSortOptions: function(t) {
            var n = e.defaults(t || {}, this._defaultRenderParams);
            this._viewSwitcher || (this._viewSwitcher = new p(n, this._sortButtons, this._orderButtons, this._priorSeriesButtons, this._charaRoleButtons, this._abilityTypeButtons, this._resonanceButtons));
            var r = n.defaultSortType,
                i = this._viewSwitcher.getSubSortTypeBy(r),
                s = w.SORT_MODULE.SUB_SORT_TYPE_OF,
                o = i === s.ASC_OR_DESC ? n.defaultOrderType : void 0,
                u = i === s.SERIES_ID ? n.defaultPriorSeriesId : void 0,
                a = i === s.CHARA_ROLE ? n.defaultCharaRoleType : void 0,
                f = i === s.ABILITY ? n.defaultAbilityType : void 0,
                l = this._getCtxBasedResonantSeriesId(t.isResonanceSimAvailable) || +n.defaultResonanceSeriesId || void 0,
                c = this._viewSwitcher.getSelectedSortSummary(!0, r, o, u, a, f);
            return {
                sortType: r,
                orderType: o,
                priorSeriesId: +u || void 0,
                charaRoleType: +a || void 0,
                abilityType: +f || void 0,
                resonanceSeriesId: l,
                buttonFace: c,
                displayKey: this._viewSwitcher.getDisplayKey(r)
            }
        },
        _getCtxBasedResonantSeriesId: function(e) {
            return e ? FF.resonator ? FF.resonator.isResonantRegardlessOfSimulation() ? FF.resonator.getResonantSeriesId() : void 0 : void 0 : void 0
        },
        onDecideSortClick: function() {
            this._saveToCookie();
            var e = this._makeResultMessage();
            FF.modalStack.pop(e)
        },
        _saveToCookie: function() {
            e.each(this._buttonComponents, function(e) {
                e.saveToCookie()
            })
        },
        onModalCloseClick: function() {
            FF.modalStack.pop()
        },
        _buttonClickHook: function() {
            this._viewSwitcher.updateCurrentSelectStatusView()
        },
        onSortButtonClick: function(e) {
            this._viewSwitcher.updateOrderButtonLabels(), this._viewSwitcher.updateSelectedSortTypeLabel(), this._viewSwitcher.updateSubSortButtonsView(), this._freescroll4SubSort.reset(), this._scrollbar4SubSort.updateContent()
        },
        dispose: function() {
            this._tab && this._tab.dispose(), this._freescroll4MainSort && this._freescroll4MainSort.dispose(), this._freescroll4SubSort && this._freescroll4SubSort.dispose(), this._scrollbar4MainSort && this._scrollbar4MainSort.dispose(), this._scrollbar4SubSort && this._scrollbar4SubSort.dispose(), e.each(this._buttonComponents, function(e) {
                e.dispose()
            }), this._buttonComponents = [], r.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/ui_module/SortModuleCookieValidator", ["underscore", "components/CookieMania"], function(e, t) {
    var n = {
        INDEX_SORT_TYPE: 0
    };
    return {
        validate: function(e, t) {
            return this._isValidMainSortType(e.sort, t) ? !0 : (this._clearCookies(e), !1)
        },
        _isValidMainSortType: function(r, i) {
            var s = new t,
                o = s.get(r);
            if (!o) return !1;
            var u = i.getSortTypeList(),
                a = e.find(u, function(e) {
                    return e[n.INDEX_SORT_TYPE] === o
                });
            return !!a
        },
        _clearCookies: function(n) {
            var r = new t;
            e.each(n, function(e) {
                r.unset(e)
            })
        }
    }
}), define("scenes/common/ui_module/SortModuleType/SortModuleTypeBase", ["underscore", "lib/ClassBase", "lib/TextMaster"], function(e, t, n) {
    return t.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity", void 0],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.EQUIPMENT_ID, t.NONE, n.NONE, "category", void 0]
            ]
        },
        getOrderTypeMap: function() {
            var e = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                t = {};
            return t[e.VALUE_TYPE] = ["value_desc", "value_asc"], t[e.DATE_TYPE] = ["date_desc", "date_asc"], t
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.CREATED_AT
        },
        getDefaultPriorSeriesId: function() {
            return FF.CONST.SERVER.SERIES.NAME_TO_ID.FF1
        },
        getDefaultCharaRoleType: function() {
            return "1"
        },
        getDefaultAbilityType: function() {
            return FF.CONST.SERVER.ABILITY.CATEGORY_TYPE_OF.BLACK_MAGIC
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        },
        isResonanceSimAvailable: function() {
            return !0
        },
        getLocalizedSortTypeList: function() {
            var t = this.getSortTypeList();
            return e.each(t, function(e) {
                var t = e[3],
                    r = "sortmodal_main_" + t,
                    i = n.getInstance().safeGet(r) || "";
                e[3] = i
            }), t
        },
        getLocalizedOrderTypeMap: function() {
            var t = this.getOrderTypeMap();
            return e.each(t, function(t) {
                e.each(t, function(e, t, r) {
                    var i = "sortmodal_order_" + e,
                        s = n.getInstance().safeGet(i) || "";
                    r[t] = s
                })
            }), t
        },
        getAltSortTypeNames: function() {
            var t = {},
                r = this.getSortTypeList();
            return e.each(r, function(e) {
                var r = e[0],
                    i = e[3],
                    s = "sortmodal_main_" + i,
                    o = n.getInstance().safeGet(s + "__short"),
                    u = n.getInstance().safeGet(s + "__long");
                if (o || u) t[r] = {
                    "short": o,
                    "long": u
                }
            }), t
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AbilityRecipeType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.abilityGenerationRecipeCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_GENERATE, t.NONE, n.NONE, "ability_can_generate"],
                [e.ABILITY_ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.abilityGenerationRecipeCollection.SORT_TYPE_OF.CAN_GENERATE
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AbilityType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.abilityCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.ABILITY_ID, t.NONE, n.NONE, "category"],
                [e.CATEGORY, t.NONE, n.ABILITY, "prior_category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"],
                [e.GRADE, t.VALUE_TYPE, n.ASC_OR_DESC, "ability_grade"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.abilityCollection.SORT_TYPE_OF.ABILITY_ID
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AbilityUpgradeType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.abilityCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_UPGRADE, t.NONE, n.NONE, "ability_can_upgrade"],
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.ABILITY_ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"],
                [e.GRADE, t.VALUE_TYPE, n.ASC_OR_DESC, "ability_grade"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.abilityCollection.SORT_TYPE_OF.CAN_UPGRADE
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AchievementBuddyType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.IS_NOT_ACQUIRED, t.NONE, n.NONE, "is_not_achieved"],
                [e.IS_ACQUIRED, t.NONE, n.NONE, "is_achieved"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.IS_ACQUIRED
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AchievementMemoryCrystalType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.memoryCrystalCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.IS_ACQUIRED, t.NONE, n.NONE, "is_achieved"],
                [e.IS_NOT_ACQUIRED, t.NONE, n.NONE, "is_not_achieved"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.memoryCrystalCollection.SORT_TYPE_OF.IS_NOT_ACQUIRED
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/AchievementRecordMateriaType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.recordMateriaCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.IS_ACQUIRED, t.NONE, n.NONE, "is_achieved"],
                [e.IS_NOT_ACQUIRED, t.NONE, n.NONE, "is_not_achieved"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.BUDDY_SERIES_ID, t.NONE, n.SERIES_ID, "series"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.recordMateriaCollection.SORT_TYPE_OF.IS_NOT_ACQUIRED
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/BuddyType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role", void 0],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.HP, t.VALUE_TYPE, n.ASC_OR_DESC, "hp", "hp"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def", "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk", "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef", "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd", "mnd"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.LV
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        }
    })
}), define("scenes/common/ui_module/SortModuleType/BuddyEvolutionType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_EVOLVE, t.NONE, n.NONE, "buddy_can_evolve"],
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv"],
                [e.HP, t.VALUE_TYPE, n.ASC_OR_DESC, "hp"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.CAN_EVOLVE
        }
    })
}), define("scenes/common/ui_module/SortModuleType/DressRecordBuddyType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.buddyCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.CHARA_ROLE, t.NONE, n.CHARA_ROLE, "chara_role", void 0],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.HP, t.VALUE_TYPE, n.ASC_OR_DESC, "hp", "hp"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def", "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk", "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef", "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd", "mnd"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.buddyCollection.SORT_TYPE_OF.SERIES_ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/EquipmentEvolutionType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CAN_EVOLVE_NOW, t.NONE, n.NONE, "equip_can_evolve"],
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire"],
                [e.EQUIPMENT_ID, t.NONE, n.NONE, "category"],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv"],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd"],
                [e.HAMMERING_NUM, t.VALUE_TYPE, n.ASC_OR_DESC, "hammering"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.CAN_EVOLVE_NOW
        }
    })
}), define("scenes/common/ui_module/SortModuleType/EquipmentType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.CREATED_AT, t.DATE_TYPE, n.ASC_OR_DESC, "acquire", void 0],
                [e.EQUIPMENT_ID, t.NONE, n.NONE, "category", void 0],
                [e.SERIES_ID, t.NONE, n.SERIES_ID, "series", void 0],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity", void 0],
                [e.LV, t.VALUE_TYPE, n.ASC_OR_DESC, "lv", void 0],
                [e.ATK, t.VALUE_TYPE, n.ASC_OR_DESC, "atk", "atk"],
                [e.DEF, t.VALUE_TYPE, n.ASC_OR_DESC, "def", "def"],
                [e.MATK, t.VALUE_TYPE, n.ASC_OR_DESC, "matk", "matk"],
                [e.MDEF, t.VALUE_TYPE, n.ASC_OR_DESC, "mdef", "mdef"],
                [e.MND, t.VALUE_TYPE, n.ASC_OR_DESC, "mnd", "mnd"],
                [e.HAMMERING_NUM, t.VALUE_TYPE, n.ASC_OR_DESC, "hammering", void 0]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentCollection.SORT_TYPE_OF.EQUIPMENT_ID
        }
    })
}), define("scenes/common/ui_module/SortModuleType/GrowEggType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.growEggCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.growEggCollection.SORT_TYPE_OF.RARITY
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/MaterialType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.materialCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.materialCollection.SORT_TYPE_OF.ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/NullType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            return []
        },
        getDefaultSortType: function() {
            return void 0
        },
        getDefaultPriorSeriesId: function() {
            return void 0
        },
        getDefaultCharaRoleType: function() {
            return void 0
        },
        getDefaultOrderType: function() {
            return void 0
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/RecordMateriaType", ["./SortModuleTypeBase", "lib/ReleaseControl"], function(e, t) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.recordMateriaCollection.SORT_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                r = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF,
                i = [
                    [e.CREATED_AT, n.DATE_TYPE, r.ASC_OR_DESC, "acquire"],
                    [e.RECORD_MATERIA_ID, n.NONE, r.NONE, "category"]
                ];
            return t.isReleasedRecordMateriaSort() && i.push([e.IS_FAVORITE, n.NONE, r.NONE, "is_favorite"]), i
        },
        getDefaultSortType: function() {
            return FF.datastore.recordMateriaCollection.SORT_TYPE_OF.RECORD_MATERIA_ID
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SpMaterialType", ["./SortModuleTypeBase"], function(e) {
    return e.extend({
        getSortTypeList: function() {
            var e = FF.datastore.equipmentSpMaterialCollection.SORT_TYPE_OF,
                t = FF.CONST.CLIENT.SORT_MODULE.ORDER_DESC_TYPE_OF,
                n = FF.CONST.CLIENT.SORT_MODULE.SUB_SORT_TYPE_OF;
            return [
                [e.ID, t.NONE, n.NONE, "category"],
                [e.RARITY, t.VALUE_TYPE, n.ASC_OR_DESC, "rarity"]
            ]
        },
        getDefaultSortType: function() {
            return FF.datastore.equipmentSpMaterialCollection.SORT_TYPE_OF.ID
        },
        getDefaultOrderType: function() {
            return FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC
        },
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SupporterBuddyType", ["./BuddyType"], function(e) {
    return e.extend({
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleType/SupporterEquipmentType", ["./EquipmentType"], function(e) {
    return e.extend({
        isResonanceSimAvailable: function() {
            return !1
        }
    })
}), define("scenes/common/ui_module/SortModuleFacade", ["underscore", "jquery", "scenes/common/Constant", "./ModalSortModule", "./SortModuleCookieValidator", "./SortModuleType/AbilityRecipeType", "./SortModuleType/AbilityType", "./SortModuleType/AbilityUpgradeType", "./SortModuleType/AchievementBuddyType", "./SortModuleType/AchievementMemoryCrystalType", "./SortModuleType/AchievementRecordMateriaType", "./SortModuleType/BuddyType", "./SortModuleType/BuddyEvolutionType", "./SortModuleType/DressRecordBuddyType", "./SortModuleType/EquipmentEvolutionType", "./SortModuleType/EquipmentType", "./SortModuleType/GrowEggType", "./SortModuleType/MaterialType", "./SortModuleType/NullType", "./SortModuleType/RecordMateriaType", "./SortModuleType/SpMaterialType", "./SortModuleType/SupporterBuddyType", "./SortModuleType/SupporterEquipmentType", "components/CookieMania"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x) {
    var T = {
        ability_change: o,
        ability_generation: s,
        ability_upgrade: u,
        ability_decompose: o,
        ability_material_convert: g,
        achievement_buddy: a,
        achievement_memory_crystal: f,
        achievement_record_materia: l,
        party_edit: c,
        buddy_list: c,
        buddy_evolution: h,
        dress_record_buddy: p,
        grow_egg: c,
        equip_change: v,
        enhance_weapon_tab: v,
        enhance_armor_tab: v,
        enhance_material: v,
        evolution_weapon_tab: d,
        evolution_armor_tab: d,
        record_materia_change: b,
        inventory_equip: v,
        inventory_ability: o,
        inventory_material: g,
        inventory_grow_egg: m,
        inventory_etc: y,
        inventory_sp_material: w,
        supporter_buddy_list: E,
        supporter_equip_change: S
    };
    return {
        openModalDeferred: function(e, n) {
            var i = n !== void 0 ? n : !0,
                s = t.Deferred();
            if (!FF.router.loading.lock()) return s.reject().promise();
            var o = this._makeCookieKeys(e),
                u = this._getRenderParams(e, o);
            return FF.modalStack.push(r, {
                initializer: function(e) {
                    return new e(o)
                },
                renderer: function(e) {
                    e.render(u)
                },
                onPop: function(e, t) {
                    if (!t) {
                        s.reject();
                        return
                    }
                    i && FF.resonator.simulateResonance(t.resonanceSeriesId), s.resolve(t)
                }
            }), s.promise()
        },
        getDefaultSortOptions: function(e) {
            this._validateCookieKeys(e);
            var t = this._makeCookieKeys(e),
                n = this._getRenderParams(e, t),
                i = new r(t),
                s = i.getDefaultSortOptions(n);
            return i.dispose(), s
        },
        resetSceneScopeStatus: function(e) {
            var t = new x,
                r = n.COOKIE_KEYS.SORT_MODULE,
                i = r.LAST_TAB;
            t.unset(i);
            var s = r.RESONANCE_PREFIX + e;
            t.unset(s)
        },
        _validateCookieKeys: function(e) {
            var t = this._getSortType(e),
                n = this._makeCookieKeys(e);
            i.validate(n, t)
        },
        _makeCookieKeys: function(e) {
            var t = n.COOKIE_KEYS.SORT_MODULE;
            return {
                sort: t.SORT_PREFIX + e,
                order: t.ORDER_PREFIX + e,
                priorSeries: t.PRIOR_SERIES_PREFIX + e,
                charaRole: t.CHARA_ROLE_PREFIX + e,
                abilityType: t.ABILITY_TYPE_PREFIX + e,
                resonance: t.RESONANCE_PREFIX + e
            }
        },
        _getRenderParams: function(e, t) {
            var n = {},
                r = this._getSortType(e);
            return this._makeRenderParams(t, r)
        },
        _getSortType: function(e) {
            var t = T[e];
            if (!t) throw new Error("Invalid collection type of sort module: " + e);
            return new t
        },
        _makeRenderParams: function(e, t) {
            var n = new x;
            return {
                sortTypeList: t.getLocalizedSortTypeList(),
                orderTypeMap: t.getLocalizedOrderTypeMap(),
                altSortTypeNames: t.getAltSortTypeNames(),
                defaultSortType: n.get(e.sort) || t.getDefaultSortType(),
                defaultOrderType: n.get(e.order) || t.getDefaultOrderType(),
                defaultPriorSeriesId: n.get(e.priorSeries) || t.getDefaultPriorSeriesId(),
                defaultCharaRoleType: n.get(e.charaRole) || t.getDefaultCharaRoleType(),
                defaultAbilityType: n.get(e.abilityType) || t.getDefaultAbilityType(),
                defaultResonanceSeriesId: n.get(e.resonance) || void 0,
                isResonanceSimAvailable: t.isResonanceSimAvailable()
            }
        }
    }
}), define("scenes/profile/pages/UserSupporterBuddyEdit", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/profile/Api", "./Page", "scenes/profile/views/ModalBuddyDetail", "scenes/profile/views/BuddyList", "templates/profile/UserSupporterBuddyEdit", "components/FreeScroll", "components/Scrollbar", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        SORT_MODULE_KEY: "supporter_buddy_list"
    };
    return s.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump [data-app-btn-back]": "onClickBack",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "mousemove [data-app-selector-order]": "onMouseMoveSort",
            "focus [data-app-selector-order]": "onFocusSort",
            "blur [data-app-selector-order]": "onBlurSort",
            "anchorslongtap [data-app-buddy]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.selectedBuddyId = void 0, this.buddyCollection = FF.datastore.buddyCollection, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, this.defaultBuddyId = this.userSupporterBuddyModel.get("id"), this._initSortOptions(), s.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), c.resetSceneScopeStatus(h.SORT_MODULE_KEY), this._sortOptions = c.getDefaultSortOptions(h.SORT_MODULE_KEY)
        },
        render: function() {
            s.prototype.render.call(this, a, {
                userSupporterBuddyModel: this.userSupporterBuddyModel,
                soulStrikeModel: this.userSupporterBuddyModel.getSoulStrikeModel()
            }), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this.setupComponents(), this.processAfterRender()
        },
        renderBuddyList: function(e) {
            e = e || {}, this.buddyCollection.changeComparator(e), this.buddyCollection.sort(), this.buddyList && this.buddyList.dispose(), this.buddyList = new u({
                el: t("#buddy_list")
            }), this.buddyList.render({
                buddyCollection: this.buddyCollection
            }), this.listenTo(this.buddyList, "onClickBuddyListItem", this.onClickBuddyListItem)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapCharaDetailView: function(e) {
            this.hasLongTap = !0, this.blurSelectorOrder(), this.freescroll.cancelScroll();
            var n = t(e.target).closest("[data-app-buddy]"),
                r = n.attr("data-app-buddy");
            this.openBuddyDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openBuddyDetail: function(e) {
            var t = this;
            FF.modalStack.push(o, {
                initializer: function(n) {
                    var r = +e === +t.userSupporterBuddyModel.get("id") ? t.userSupporterBuddyModel : t.buddyCollection.get(e);
                    return new n(r)
                },
                renderer: function(e) {
                    e.render()
                },
                onPop: function() {
                    t.hasLongTap = !1
                }
            })
        },
        renderUserSupporterBuddyById: function(e) {
            e = e || void 0;
            var n = e ? this.buddyCollection.get(e) : this.userSupporterBuddyModel,
                r = e ? n.get("default_image_path") : n.get("image_path"),
                i = t("#currentUserSupporterBuddy"),
                s = e ? n.getDefaultSoulStrikeModel() : n.getSoulStrikeModel(),
                o = s.get("image_path");
            i.find("[data-app-level]").html(n.get("level")), i.find("[data-app-img]").attr("src", pUrl(r)), i.find("[data-app-soul-strike-img]").attr("src", pUrl(s.get("image_path"))), i.find("[data-app-soul-strike-name]").html(s.get("name")), i.find("[data-app-soul-strike-description]").html(s.get("description")), i.find("[data-app-soul-strike-equip-img]").attr("src", o);
            var u = i.find("[data-app-soul-strike-icon]"),
                a = u.attr("class").search(/is-[a-z]+/),
                f = u.attr("class").substr(a).split(" ")[0];
            u.removeClass(f);
            var l = n.get("default_soul_strike_id"),
                c = s.isDefaultSoulStrike(l) ? "is-default" : s.isSomeones() ? "is-unique" : "is-common";
            u.addClass(c)
        },
        activateBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        deactivateBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        addSelectedBuddyIcon: function() {
            var e = t('[data-app-buddy="' + this.selectedBuddyId + '"]'),
                n = t('[data-app-buddy="' + this.defaultBuddyId + '"]'),
                r = n.find(".p-user-supporter-buddy");
            n.closest("[data-app-buddy-list]").removeClass(".is-in-equip-by-supporter"), e.closest("[data-app-buddy-list]").addClass(".is-in-equip-by-supporter"), e.append(r), n.find(".p-user-supporter-buddy").remove()
        },
        onClickBuddyListItem: function(e) {
            var t = this.userSupporterBuddyModel.get("id");
            this.selectedBuddyId = e.id, this.selectedBuddyId === t || !this.selectedBuddyId ? (this.renderUserSupporterBuddyById(0), this.deactivateBtn()) : (this.renderUserSupporterBuddyById(this.selectedBuddyId), this.activateBtn())
        },
        onClickDecide: function() {
            var e = this.buddyCollection.get(this.selectedBuddyId),
                t = e.get("default_soul_strike_id");
            this.saveSupporterBuddy({
                userBuddyId: e.get("id"),
                soulStrikeId: t,
                weaponId: 0,
                armorId: 0,
                accessoryId: 0,
                dressRecordId: 0
            })
        },
        cancelSupporterBuddy: function() {
            FF.datastore.resetSupporterTmpEquipments(), FF.datastore.resetSupporterTmpDressRecords(), FF.datastore.resetSupporterTmpSoulStrikes()
        },
        saveSupporterBuddy: function(e) {
            var n = this;
            i.saveSupporterBuddyDeferred(e).done(function(e) {
                n.updateSupporterBuddy(e), FF.router.toast.topping(t("#toast-message-update-buddy").text()), FF.router.loading.hide(), n._goBack()
            })
        },
        updateSupporterBuddy: function(t) {
            var n = this;
            e.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                n.userSupporterBuddyModel.setTmpEquipmentId({
                    typeName: e,
                    equipmentId: 0
                })
            }), this.userSupporterBuddyModel.set(t.user_supporter_buddy), this.userSupporterBuddyModel.takeOffSoulStrike(), this.userSupporterBuddyModel.takeOffDressRecord(), FF.datastore.clearSupporterTmpDressRecords(), FF.datastore.fixSupporterTmpEquipments(), FF.datastore.fixSupporterTmpSoulStrikes(), FF.datastore.fixSupporterTmpDressRecords(), this.deactivateBtn(), this.addSelectedBuddyIcon(), this.buddyList.deactivate(this.selectedBuddyId), this.buddyList.updateSelectedClassByBuddyId(this.selectedBuddyId), this.defaultBuddyId = this.selectedBuddyId, this.selectedBuddyId = void 0
        },
        onClickBack: function() {
            this.cancelSupporterBuddy(), this._goBack()
        },
        _goBack: function() {
            FF.router.loading.lock(), n.history.navigate("#profile/equipment_change", {
                trigger: !0
            })
        },
        onClickOpenSortModal: function() {
            c.openModalDeferred(h.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.buddyList && this.buddyList.dispose(), this.modalConfirmView && this.modalConfirmView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/views/EquipmentList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/profile/views/EquipmentList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/profile/pages/EquipmentChange", ["underscore", "jquery", "backbone", "util", "templates/profile/EquipmentChange", "scenes/profile/views/EquipmentList", "scenes/party/views/ModalEquipmentDetail", "./Page"], function(e, t, n, r, i, s, o, u) {
    return u.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-user-supporter-buddy-edit]": "onClickUserSupporterBuddyEdit",
            "anchorsbeforejump [data-app-soul-strike-btn]": "onClickSoulStrikeChange",
            "anchorsbeforejump [data-app-buddy-equip]": "onClickEquipChange",
            "anchorsbeforejump [data-app-dress-record-change]": "onClickDressRecordChange",
            "anchorslongtap [data-app-equipment-id]": "openEquipDetailModal"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, u.prototype.initialize.call(this, e)
        },
        render: function() {
            u.prototype.render.call(this, i, {
                userSupporterBuddyModel: this.userSupporterBuddyModel,
                soulStrikeModel: this.userSupporterBuddyModel.getSoulStrikeModel()
            }), this.renderEquipmentList(), this.processAfterRender()
        },
        renderEquipmentList: function() {
            this.equipList && this.equipList.dispose(), this.equipList = new s({
                el: t("[data-app-equip-list]")
            }), this.equipList.render({
                tmpEquipmentModelMap: this.userSupporterBuddyModel.getTmpEquipmentModelMap()
            })
        },
        openEquipDetailModal: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-equipment-id");
            if (!r) return;
            this.hasLongTap = !0;
            var i = FF.datastore.equipmentCollection.get(r);
            if (!i) {
                this.hasLongTap = !1;
                return
            }
            FF.SoundMgr.playChooseEffect(), FF.modalStack.push(o, {
                initializer: function(e) {
                    return new o({
                        isUserSupporterBuddy: !0
                    })
                },
                renderer: function(e) {
                    e.render(i)
                },
                onPop: function() {
                    n.hasLongTap = !1
                }
            })
        },
        onClickSoulStrikeChange: function() {
            var e = this;
            if (this.hasLongTap) return;
            FF.SoundMgr.playChooseEffect(), this.onClickSsLimitationDeferred().then(function() {
                n.history.navigate("#profile/soul_strike_change", {
                    trigger: !0
                })
            })
        },
        onClickDressRecordChange: function() {
            if (this.hasLongTap) return;
            n.history.navigate("#profile/dress_record_change/" + this.userSupporterBuddyModel.get("id"), {
                trigger: !0
            })
        },
        updateSoulStrikeView: function() {
            var e = t("#userSupporterBuddySoulStrike"),
                n = this.userSupporterBuddyModel.getSoulStrikeModel();
            e.find("[data-app-name]").html(n.get("name")), e.find("[data-app-gauge]").attr("class", "c-soul-strike-gauge__inner " + n.getSoulStrikeGaugeClassName()), e.find("[data-app-description]").html(n.get("description")), e.find("[data-app-img]").attr("src", n.get("image_path"));
            var r = e.find("[data-app-ss-icon]"),
                i = r.attr("class").search(/is-[a-z]+/),
                s = r.attr("class").substr(i).split(" ")[0];
            r.removeClass(s);
            var o = this.userSupporterBuddyModel.get("default_soul_strike_id"),
                u = n.isDefaultSoulStrike(o) ? "is-default" : n.isSomeones() ? "is-unique" : "is-common";
            r.addClass(u)
        },
        onClickEquipChange: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.target).attr("data-app-buddy-equip"),
                i = this.userSupporterBuddyModel.get("id"),
                s = "#profile/equipment_change_detail/" + i + "/" + r;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickUserSupporterBuddyEdit: function() {
            FF.router.loading.lock(), n.history.navigate("#profile/user_supporter_buddy_edit", {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#profile", {
                trigger: !0
            })
        },
        dispose: function() {
            this.equipList && this.equipList.dispose(), this.modalEquipDetailView && this.modalEquipDetailView.end(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/OverScrollView", ["jquery", "backbone", "scenes/common/Constant", "components/OverScrollable", "components/Scrollbar", "lib/ModalBase"], function(e, t, n, r, i, s) {
    var o = e.extend(!0, {}, n, {
            ANIMATION_CLASS_NAME: "is-animate",
            ELEMENT_SELECTORS: {
                RELOAD: "[data-ui-loading-upper]",
                LOADING: "[data-ui-loading-lower]",
                PREV_PAGE: "[data-ui-prev-page]",
                NEXT_PAGE: "[data-ui-next-page]",
                MAX_PAGE: "[data-ui-max-page]"
            },
            EVENT_NAMES: {
                REQUEST_RENDER: "requestRender"
            },
            LIST_DISPLAY_TYPES: {
                BUTTON: "BUTTON",
                BUDDY_TILE: "BUDDY_TILE",
                TILE: "TILE",
                EQUIP_TILE: "EQUIP_TILE",
                PROFILE_TILE: "PROFILE_TILE",
                RECORD_MATERIA_TILE: "RECORD_MATERIA_TILE",
                BUDDY_WIDE_LIST: "BUDDY_WIDE_LIST",
                PARTY_EDIT_TILE: "PARTY_EDIT_TILE",
                INFINIT: "INFINIT"
            },
            SCROLL_MIN_PERCENT: 0,
            SCROLL_MAX_PERCENT: 100,
            SCROLL_FACE_MOTION_SPEED: ".3s"
        }),
        u = FF.env.isIOS(),
        a = FF.env.isIOS7_0(),
        f = FF.env.isAndroid();
    return t.View.extend({
        _defaults: {
            useNativeScroll: !0,
            useLazyLoad: !0,
            itemPadNum: 0
        },
        initialize: function() {
            this.freeScrollContentSelectorName = this.options.freeScrollContentSelectorName || "[data-ui-freescroll-content]", this.freeScrollSelectorName = this.options.freeScrollSelectorName || "[data-ui-freescroll]", this.scrollbarSelectorName = this.options.scrollbarSelectorName || "[data-ui-scrollbar]", this._currentPageIndex = 0, this._maxPageIndex = 0, this._maxItems = undefined, this._isTapped = !1, this.checkOptions(), this.setMaxItems(), this.setupComponents(), this.bindEvents()
        },
        render: function(e) {
            var t = e.html,
                n = e.parentElement,
                r = e.imageWatcher;
            u && this.options.useNativeScroll ? this._renderForNativeScroll(t, n) : this._renderForFreeScroll(t, n, r), this.scrollbar.updateContent()
        },
        _renderForNativeScroll: function(e, t) {
            t.append(e), this.restartLazyLoad(), this._currentPageIndex === this._maxPageIndex && this.stopListening(this.overscrollable, "overscroll:up nativeScrollEnd", this.switchNextItems), FF.router.loading.hide()
        },
        _renderForFreeScroll: function(e, t, n) {
            t.html(e), this.setAroundPageText(), this.afterRender({
                imagewatcher: n
            }), this.forceUpdateListView()
        },
        checkOptions: function() {
            this.options = e.extend(!0, {}, this._defaults, this.options);
            if (!this.options.listElement.length) throw FF.logger.debug("No list element found", this.options), new Error("No list element found")
        },
        setMaxItems: function() {
            var e = this.options.displayType;
            if (!e || !o.LIST_DISPLAY_TYPES[e]) e = o.LIST_DISPLAY_TYPES.TILE;
            this._maxItems = o.OVERSCROLL_NUMS[e]
        },
        setupComponents: function() {
            this.overscrollable = new r({
                el: this.options.overscrollableEl || e(this.freeScrollSelectorName),
                reload: e(o.ELEMENT_SELECTORS.RELOAD),
                loading: e(o.ELEMENT_SELECTORS.LOADING),
                startUp: this.options.startUp,
                contentSelector: this.options.freeScrollContentSelectorName || null,
                useNativeScroll: u && this.options.useNativeScroll ? !0 : !1,
                useLazyLoad: this.options.useLazyLoad
            }), this.scrollbar = new i({
                el: e(this.scrollbarSelectorName),
                watch: this.overscrollable,
                faceHeight: o.CSS_VALUE.SCROLL_FACE_HEIGHT,
                disableOverscroll: !0,
                customScroller: this
            })
        },
        bindEvents: function() {
            this.stopListening(), this.listenTo(this.overscrollable, "scrollchange", this.onScrollChange).listenTo(this.overscrollable, "tappedScrollArea", this.onTapScroll).listenTo(this.overscrollable, "overscroll:changeAnimation", this.onChangeAnimation).listenTo(this.overscrollable, "overscroll:down", this.switchPrevItems).listenTo(this.overscrollable, "overscroll:up nativeScrollEnd", this.switchNextItems)
        },
        updateCollectionSize: function(e) {
            this._maxPageIndex = Math.floor((e - 1) / this._maxItems), this._collectionSize = e, this.updateFirstLastFlags()
        },
        updateContent: function() {
            this.overscrollable.updateContent()
        },
        updateContentWithScrollReset: function() {
            this.scrollbar.updateContentWithScrollReset()
        },
        switchPrevItems: function() {
            if (s.isModalOpening()) return;
            if (this._currentPageIndex === 0) return;
            if (!FF.router.loading.lock()) return;
            if (this._isTapped) {
                FF.router.loading.unlock();
                return
            }
            var e = this;
            this._currentPageIndex--, this.updateFirstLastFlags(), this.emptyList(), this._shouldSnapToBottom = !0, this._isWaitingRender = !0, this.listenToOnce(this.overscrollable, "allTransitionEnd", this.requestRender)
        },
        switchNextItems: function() {
            if (s.isModalOpening()) return;
            if (this._currentPageIndex === this._maxPageIndex) return;
            if (!FF.router.loading.lock()) return;
            if (this._isTapped) {
                FF.router.loading.unlock();
                return
            }
            var e = this;
            this._currentPageIndex++, this.updateFirstLastFlags();
            if (!u || !this.options.useNativeScroll) this.emptyList(), this._shouldSnapToBottom = !1, this._isWaitingRender = !0;
            this.listenToOnce(this.overscrollable, "allTransitionEnd", this.requestRender)
        },
        requestRender: function() {
            this.trigger(o.EVENT_NAMES.REQUEST_RENDER)
        },
        updateFirstLastFlags: function() {
            this._isFirstPage = this._currentPageIndex === 0, this._isLastPage = this._currentPageIndex === this._maxPageIndex
        },
        emptyList: function() {
            this.options.listElement.empty()
        },
        afterRender: function(t) {
            var n = this;
            this.setupIsScrollable(), this.setIsScrollableIfSinglePage(), e(o.ELEMENT_SELECTORS.RELOAD).removeClass(o.ANIMATION_CLASS_NAME), e(o.ELEMENT_SELECTORS.LOADING).removeClass(o.ANIMATION_CLASS_NAME), this._currentPageIndex === 0 ? e(o.ELEMENT_SELECTORS.RELOAD).hide() : e(o.ELEMENT_SELECTORS.RELOAD).show(), this._currentPageIndex === this._maxPageIndex ? e(o.ELEMENT_SELECTORS.LOADING).hide() : e(o.ELEMENT_SELECTORS.LOADING).show().css("opacity", "");
            if (!u || !this.options.useNativeScroll) this._currentPageIndex === this._maxPageIndex ? this.overscrollable.setContentHeightToParentHeight() : (this.overscrollable.resetContentHeightToParentHeight(), this.overscrollable.updateContent());
            this.overscrollable.moveHeadToAxis(this._shouldSnapToBottom), this.overscrollable.resetActualScrollable(), this._shouldSnapToBottom = !1, this._isWaitingRender = !1, this.getIsLastPage() && !this.overscrollable.getActualScrollable() ? this.trigger("scrollchange", {
                percent: o.SCROLL_MAX_PERCENT,
                speed: o.SCROLL_FACE_MOTION_SPEED
            }) : !this.getIsLastPage() && !this.overscrollable.getActualScrollable() && this.trigger("scrollchange", {
                percent: o.SCROLL_MIN_PERCENT,
                speed: o.SCROLL_FACE_MOTION_SPEED
            }), (a || f) && t.imagewatcher && this.listenToOnce(t.imagewatcher, "allImagesAreCompleted someImagesAreCompleted", this.forceUpdateListView), f && window.setTimeout(function() {
                e(n.freeScrollContentSelectorName).fastCss("opacity", .99), window.setTimeout(function() {
                    e(n.freeScrollContentSelectorName).fastCss("opacity", 1)
                }, 0)
            }, 0)
        },
        forceUpdateListView: function() {
            var t = this;
            e(this.freeScrollContentSelectorName).fastCss("opacity", "0.99"), window.setTimeout(function() {
                e(t.freeScrollContentSelectorName).fastCss("opacity", "1")
            }, 0)
        },
        setupIsScrollable: function() {
            this.overscrollable.setIsScrollable({
                isScrollable: this._maxPageIndex < 1 ? !1 : !0
            }), this.overscrollable.reset()
        },
        setIsScrollableIfSinglePage: function() {
            this._maxPageIndex === 0 && this.overscrollable.getScrollableWithCalculation() && this.overscrollable.setIsScrollable({
                isScrollable: !0
            })
        },
        onChangeAnimation: function(e) {
            if (!e) return;
            if (!this.overscrollable.getIsScrollable()) return;
            e.target[e.method](o.ANIMATION_CLASS_NAME)
        },
        onTapScroll: function() {
            this._isTapped = !0
        },
        onScrollChange: function(e) {
            this._isTapped = !1;
            if (this.getIsLastPage() && this._isWaitingRender || !this.overscrollable.getIsScrollable()) return;
            this._isWaitingRender ? e.percent = this.getNewPercent({
                isSnap: !0,
                snapToBottom: this._shouldSnapToBottom
            }) : e.percent = this.getNewPercent({
                isSnap: !1
            }), e.speed = o.SCROLL_FACE_MOTION_SPEED, this.trigger("scrollchange", e)
        },
        getNewPercent: function(e) {
            var t;
            if (this.getIsLastPage() && !this.overscrollable.getActualScrollable()) t = o.SCROLL_MAX_PERCENT;
            else {
                var n = this.getScrollBarHeight(),
                    r = n / (this._maxPageIndex + 1),
                    i = this.getScrollPercent(e),
                    s = r * (i / o.SCROLL_MAX_PERCENT),
                    u = r * this._currentPageIndex,
                    a = u + s;
                t = a / n
            }
            return isNaN(t) && (t = 0), t
        },
        getScrollPercent: function(e) {
            var t = this.overscrollable.getCurrentScroll() / this.overscrollable.getMaxScroll() * o.SCROLL_MAX_PERCENT;
            return e.isSnap ? t = e.snapToBottom ? o.SCROLL_MAX_PERCENT : o.SCROLL_MIN_PERCENT : t < o.SCROLL_MIN_PERCENT ? t = o.SCROLL_MIN_PERCENT : o.SCROLL_MAX_PERCENT < t && (t = o.SCROLL_MAX_PERCENT), t
        },
        setAroundPageText: function() {
            e(o.ELEMENT_SELECTORS.PREV_PAGE).html(this.getCurrentPage()), e(o.ELEMENT_SELECTORS.NEXT_PAGE).html(this.getCurrentPage() + 2)
        },
        setMaxPageText: function() {
            e(o.ELEMENT_SELECTORS.MAX_PAGE).html(this.getMaxPage() + 1)
        },
        setCurrentPage: function(e) {
            this._currentPageIndex = +e
        },
        getCurrentPage: function() {
            return this._currentPageIndex
        },
        getIsFirstPage: function() {
            return this._isFirstPage
        },
        getIsLastPage: function() {
            return this._isLastPage
        },
        getMaxPage: function() {
            return this._maxPageIndex
        },
        getScrollBarHeight: function() {
            return this._scrollBarHeight !== undefined ? this._scrollBarHeight : (this._scrollBarHeight = e(this.scrollbarSelectorName).height(), this._scrollBarHeight)
        },
        getStartNum: function() {
            var e = this._currentPageIndex * this._maxItems;
            return 0 < this._currentPageIndex && (e -= this.options.itemPadNum), e
        },
        getEndNum: function() {
            var e = this.getStartNum() + this._maxItems;
            return this._currentPageIndex === 0 && (e -= this.options.itemPadNum), e
        },
        cancelScroll: function() {
            this.overscrollable.cancelScroll()
        },
        reset: function() {
            this.overscrollable.reset(), this.resetScrollbarPosition(), this.resetCurrentPage()
        },
        resetScrollbarPosition: function() {
            this.trigger("scrollchange", {
                percent: 0,
                speed: 0
            })
        },
        resetCurrentPage: function() {
            this._currentPageIndex = 0
        },
        cleanup: function() {
            this.emptyList(), this.reset(), this.bindEvents()
        },
        restartLazyLoad: function() {
            this.overscrollable.restartLazyLoad()
        },
        rebindNativeScrollEvent: function() {
            this.overscrollable.rebindNativeScrollEvent()
        },
        dispose: function() {
            this.overscrollable && this.overscrollable.dispose(), this.scrollbar && this.scrollbar.dispose(), this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/party/helper/CollectionsFilteringHelper", ["jquery", "underscore"], function(e, t) {
    return {
        getFilteringModels: function(e) {
            e = e || {};
            var t = e.start,
                n = e.end,
                r = e.collection,
                i = r.length;
            return t === 0 && n >= i ? r.slice(t, n) : t === 0 ? r.slice(t, n - 1) : i <= n ? r.slice(t - 1, n) : r.slice(t - 1, n - 1)
        }
    }
}), define("scenes/party/helper/StatusDisplayToggle", ["jquery", "underscore", "backbone", "lib/ClassBase"], function(e, t, n, r) {
    var i = {
        DISPLAY_CLASS_NAME: "di-n",
        STATUS_DATA_NAME: "data-app-option-status",
        SHOW_CLASS_NAME: "is-show-switch-content"
    };
    return r.extend({
        initialize: function(e) {
            e = e || {}, this.$toggleListParentElem = e.toggleListParentElem, this.currentNum = 0, this.maxNum = e.maxNum
        },
        toggleStatus: function() {
            this._showContentIfNeed(), this.currentNum === this.maxNum ? (e("[" + i.STATUS_DATA_NAME + "=" + this.maxNum + "]").addClass(i.DISPLAY_CLASS_NAME), this._hideContent(), this.currentNum = 0) : (this.currentNum++, e("[" + i.STATUS_DATA_NAME + "]").addClass(i.DISPLAY_CLASS_NAME), e("[" + i.STATUS_DATA_NAME + "=" + this.currentNum + "]").removeClass(i.DISPLAY_CLASS_NAME))
        },
        applyToggleStatus: function() {
            e("[" + i.STATUS_DATA_NAME + "]").addClass(i.DISPLAY_CLASS_NAME), e("[" + i.STATUS_DATA_NAME + "=" + this.currentNum + "]").removeClass(i.DISPLAY_CLASS_NAME)
        },
        _showContentIfNeed: function() {
            var e = this.$toggleListParentElem.hasClass(i.SHOW_CLASS_NAME);
            e || this.$toggleListParentElem.addClass(i.SHOW_CLASS_NAME)
        },
        _hideContent: function() {
            this.$toggleListParentElem.removeClass(i.SHOW_CLASS_NAME)
        },
        dispose: function() {
            this._hideContent(), delete this.$toggleListParentElem, delete this.currentNum, delete this.maxNum
        }
    })
}), define("scenes/party/views/ModalSoulStrikeChangeConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalSoulStrikeChangeConfirm"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump #modalNegativeBtn": "onClickDecideNegative",
            "anchorsbeforejump #modalPositiveBtn": "onClickDecidePositive"
        },
        render: function(e) {
            this.renderContent(i, {})
        },
        onClickDecideNegative: function() {
            this.trigger("onClickDecideNegative"), FF.modalStack.popAll()
        },
        onClickDecidePositive: function() {
            this.trigger("onClickDecidePositive"), FF.modalStack.popAll()
        }
    })
}), define("scenes/common/views/ModalSoulStrikeChange", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "scenes/party/Api", "lib/ModalBase", "templates/common/ModalSoulStrikeChange", "components/OverScrollable", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-choose]": "onClickChoose"
        },
        initialize: function(e) {
            this.isLocked = !1, this.buddyModel = e.buddyModel, this.selectableSoulStrikeModels = this.buddyModel.getSelectableSoulStrikeModels(), this.selectableSoulStrikeModels.sort(this.buddyModel.recommendSoulStrikeCompareFunc), this.tmpSoulStrikeModels = e.tmpSoulStrikeModels, this.tmpSoulStrikeIds = e.tmpSoulStrikeIds, this.maxSoulStrikeSetNum = this.tmpSoulStrikeModels.length, this.isForUserSupporterBuddy = e.isForUserSupporterBuddy
        },
        render: function() {
            this.renderContent(o, {
                buddyModel: this.buddyModel,
                selectableSoulStrikeModels: this.selectableSoulStrikeModels,
                tmpSoulStrikeModels: this.tmpSoulStrikeModels,
                tmpSoulStrikeIds: this.tmpSoulStrikeIds,
                isForUserSupporterBuddy: this.isForUserSupporterBuddy,
                statusBonusOpt: FF.datastore.dungeonSessionModel.getStatusBonusOpt()
            }), this.generateComponents()
        },
        generateComponents: function() {
            this.overscrollable = new u({
                el: t("[data-ui-freescroll-for-soul-strike-change]"),
                contentSelector: "[data-ui-freescroll-content-for-soul-strike-change]",
                loading: t("[data-ui-loading]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar-for-soul-strike-change]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        hasEquippedSoulStrikeId: function(e) {
            return this.tmpSoulStrikeIds.indexOf(e) >= 0
        },
        disableBtnSelectText: function(e) {
            t(e).find("[data-app-select-text]").addClass("di-n"), t(e).find("[data-app-selected-text]").removeClass("di-n")
        },
        disableBtnSelectedText: function(e) {
            t(e).find("[data-app-select-text]").removeClass("di-n"), t(e).find("[data-app-selected-text]").addClass("di-n")
        },
        addEquipIcon: function(e) {
            t(e).addClass("is-in-equip")
        },
        removeEquipIcon: function(e) {
            t(e).removeClass("is-in-equip")
        },
        renderSoulStrikeSlot: function(e) {
            var n = FF.datastore.soulStrikeCollection.get(e),
                r = n.get("name"),
                i = pUrl(n.get("image_path")),
                s = t("[data-app-tmp-soul-strike-slot]"),
                o = s[this.tmpSoulStrikeIds.length];
            t(o).attr("data-app-tmp-soul-strike-id", e).find("[data-app-soul-strike-img]").attr("src", i).removeClass("di-n"), t(o).find("[data-app-soul-strike-name]").text(r)
        },
        removeSoulStrikeSlot: function(e) {
            if (this.isForUserSupporterBuddy) return;
            var n = FF.datastore.soulStrikeCollection.get(e),
                r = t('[data-app-tmp-soul-strike-id="' + e + '"]');
            r.attr("data-app-tmp-soul-strike-id", "").find("[data-app-soul-strike-name]").text(""), r.find("[data-app-soul-strike-img]").addClass("di-n").attr("src", ""), t("[data-app-tmp-soul-strike-slot-wrap]").append(r)
        },
        removeOldSoulStrike: function() {
            var n = t("[data-ui-freescroll-content-for-soul-strike-change]").find(".is-in-equip"),
                r = +t(n).attr("data-app-soul-strike-id");
            this.disableBtnSelectedText(n), this.removeEquipIcon(n), this.removeSoulStrikeSlot(r), this.tmpSoulStrikeIds = e.without(this.tmpSoulStrikeIds, r)
        },
        onClickChoose: function(n) {
            if (this.isLocked) return;
            this.isLocked = !0;
            var r = n.currentTarget,
                i = t(r).closest("[data-app-soul-strike-id]"),
                s = +t(i).attr("data-app-soul-strike-id");
            if (this.hasEquippedSoulStrikeId(s)) FF.SoundMgr.playCancelEffect(), this.disableBtnSelectedText(i), this.removeEquipIcon(i), this.removeSoulStrikeSlot(s), this.tmpSoulStrikeIds = e.without(this.tmpSoulStrikeIds, s), this.tmpSoulStrikeIds.length === 0 && t("[data-app-modal-close]").addClass("is-disable"), this.isLocked = !1;
            else {
                if (this.tmpSoulStrikeIds.length === this.maxSoulStrikeSetNum && !this.isForUserSupporterBuddy) {
                    FF.SoundMgr.playNgEffect(), this.isLocked = !1;
                    return
                }
                this.isForUserSupporterBuddy && this.removeOldSoulStrike(), FF.SoundMgr.playChooseEffect(), this.disableBtnSelectText(i), this.addEquipIcon(i), this.renderSoulStrikeSlot(s), this.tmpSoulStrikeIds.push(s), t("[data-app-modal-close]").hasClass("is-disable") && t("[data-app-modal-close]").removeClass("is-disable"), this.isLocked = !1
            }
        },
        onClickModalClose: function() {
            if (this.isLocked || this.tmpSoulStrikeIds.length === 0) return;
            var e = this;
            this.isLocked = !0, FF.router.loading.lock(), this.setTmpSoulStrikeId(), this.saveSoulStrikeDeferred().then(function() {
                FF.modalStack.pop(), t(document).trigger("soulStrikeChangeModalClose")
            })
        },
        setTmpSoulStrikeId: function() {
            var t = this;
            for (var n = 0; n < this.maxSoulStrikeSetNum; n++) this.tmpSoulStrikeIds[n] || this.tmpSoulStrikeIds.push(0);
            e.each(this.tmpSoulStrikeIds, function(e, n) {
                t.buddyModel.setTmpSoulStrikeId({
                    slot: n + 1,
                    soulStrikeId: e
                })
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            return !this.buddyModel.hasChangedSoulStrikeId() || this.buddyModel.hasChangedEquipmentId() || this.isForUserSupporterBuddy ? n.resolve().promise() : (i.buddySaveSoulStrikeDeferred(FF.datastore.buddyCollection.getChangedSoulStrikeInfo(), this.buddyModel.isSetTmpEquipmentByRecommend).done(function() {
                FF.router.toast.topping(t("#toast-message-soul-strike-onchange").text()), FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpSoulStrikes(), n.resolve()
            }), n.promise())
        },
        dispose: function() {
            this.scrollbar && this.scrollbar.dispose(), this.overscrollable && this.overscrollable.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/pages/EquipmentChangeDetail", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/profile/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/helper/FuncTutorial", "templates/profile/EquipmentChangeDetail", "templates/profile/views/EquipmentDetailList", "templates/party/views/EquipmentChangeDetailInfo", "templates/party/views/EquipmentSelectedItem", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalSoulStrikeChangeConfirm", "scenes/common/views/ModalSoulStrikeChange", "./Page", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    var w = e.extend({}, s, {
        PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        SOUL_STRIKE_SLOTS: 1,
        SORT_MODULE_KEY: "supporter_equip_change",
        EQUIPMENT_TYPE_OF: {
            weapon: 1,
            armor: 2,
            accessory: 3
        }
    });
    return y.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-equipment-list-id]": "onClickEquipmentList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "mousemove [data-app-selector-order]": "onMouseMoveSort",
            "focus [data-app-selector-order]": "onFocusSort",
            "blur [data-app-selector-order]": "onBlurSort",
            "anchorslongtap [data-app-equipped-detail-info]": "onLongTapEquippedDetail",
            "anchorslongtap [data-app-equip-list-button-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.buddyCollection = FF.datastore.buddyCollection, this.equipmentCollection = FF.datastore.equipmentCollection, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, this._initSortOptions(), y.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), b.resetSceneScopeStatus(w.SORT_MODULE_KEY), this._sortOptions = b.getDefaultSortOptions(w.SORT_MODULE_KEY)
        },
        render: function(e) {
            this.buddyId = e[0] - 0, this.typeName = e[1], this.orderKey = "USER_SUPPORTER_BUDDY_EQUIPMENT_CHANGE_DETAIL_" + this.typeName.toUpperCase(), this.userSupporterBuddyModel.set("shouldReserveOriginalEquipment", !0), y.prototype.render.call(this, a, {
                buddyImagePath: this.userSupporterBuddyModel.get("image_path")
            }), this.renderChangeDetailInfo(), this.renderSelectedItem(), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderEquipList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("[data-app-equip-detail-list]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new d({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: this.isAccessory() ? 1 : 2
            })
        },
        isAccessory: function() {
            return w.EQUIPMENT_TYPE_OF[this.typeName] === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ACCESSORY
        },
        getTmpEquipmentModel: function() {
            return this.userSupporterBuddyModel.getTmpEquipmentModelByTypeName(this.typeName) || null
        },
        getOldEquipmentModel: function() {
            return this.userSupporterBuddyModel.getEquipmentModelByTypeName(this.typeName) || null
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.userSupporterBuddyModel, e.tmpEquip = e.tmpEquip ? e.tmpEquip : {};
            var n = r.process(l, e);
            t("[data-app-equip-detail-info]").html(n)
        },
        renderSelectedItem: function() {
            var e = this.getTmpEquipmentModel(),
                n = r.process(c, {
                    equipmentModel: e,
                    typeName: this.typeName,
                    soulStrike: e ? e.getSoulStrikeModel() : null,
                    seriesId: null,
                    isUserSupporterBuddy: !0
                });
            t("[data-app-selected-equipment]").html(n)
        },
        renderEquipList: function(e) {
            e = e || {}, this.equipmentCollection.changeComparator(e), this.collection = this.equipmentCollection.sort().getListForChangeDetail(this.userSupporterBuddyModel, this.typeName, {
                forSupporter: !0
            }), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = h.getFilteringModels({
                    start: this.overScrollView.getStartNum(),
                    end: this.overScrollView.getEndNum(),
                    collection: this.collection
                }),
                n = r.process(f, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    equipmentModels: e,
                    typeName: this.typeName,
                    isAccessory: this.isAccessory()
                }),
                i = t("[data-app-equip-detail-list]");
            this.overScrollView.render({
                html: n,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onLongTapEquippedDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equipment-id]"),
                i = r.attr("data-app-equipment-id"),
                s = this.equipmentCollection.get(i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1
            })
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equip-list-button-id]"),
                i = r.attr("data-app-equip-list-button-id"),
                s = this.equipmentCollection.get(i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1, n._updateLockIcon(s, r)
            })
        },
        _openEquipDetailModal: function(e, t) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.overScrollView.cancelScroll(), this.generateEquipDetailModal(e, t)
        },
        generateEquipDetailModal: function(e, t) {
            FF.modalStack.push(v, {
                initializer: function(e) {
                    return new v({
                        isUserSupporterBuddy: !0
                    })
                },
                renderer: function(t) {
                    t.render(e)
                },
                onPop: t
            })
        },
        _updateLockIcon: function(e, t) {
            var n = e.get("is_locked");
            p.updateLockableItemElem(n, t, !1)
        },
        setHasChangedSoulStrikeDeferred: function() {
            var n = this,
                r = t.Deferred(),
                i = this.getOldEquipmentModel(),
                s = this._getSelectedEquipmentModel(),
                o = i ? i.get("soul_strike_id") : null,
                u = s ? s.get("soul_strike_id") : null;
            if (!o && !u) return r.resolve().promise();
            var a = this.userSupporterBuddyModel.getSelectableSoulStrikeModels();
            if (a.length === 1) return this.userSupporterBuddyModel.setTmpSoulStrikeId(a[0].get("id")), r.resolve().promise();
            if (a.length === 0) return r.resolve().promise();
            var f = this.userSupporterBuddyModel.getTmpSoulStrikeIds(),
                l = e.indexOf(f, u) > -1;
            if (l) return r.resolve().promise();
            var c = this.userSupporterBuddyModel.get("buddy_id"),
                h = s ? s.getSoulStrikeModel() : null,
                p = h ? h.isOwnByBuddyId(c) ? !0 : h.isCommon() : !1;
            if (p && !this.userSupporterBuddyModel.isTmpSoulStrikeSlotFull()) {
                var d = e.indexOf(f, w.SOUL_STRIKE_EMPTY_SLOT) + 1;
                return this.userSupporterBuddyModel.setTmpSoulStrikeIdBySlot(d, u), r.resolve().promise()
            }
            return a.length === w.SOUL_STRIKE_SLOTS ? r.resolve().promise() : p ? (this.hasChangedSoulStrike = !0, r.resolve().promise()) : r.resolve().promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var r = e.forceChange,
                i = this._getSelectedEquipmentId(),
                s = this.userSupporterBuddyModel.setTmpEquipmentId({
                    typeName: this.typeName,
                    equipmentId: i,
                    dryrun: !0
                }),
                o = s.equippingBuddy;
            this.userSupporterBuddyModel.setTmpEquipmentId({
                typeName: this.typeName,
                equipmentId: i
            }), this.setHasChangedSoulStrikeDeferred().then(this.saveEquipIfNeedDeferred.bind(this)).then(this.generateSoulStrikeChangeModalIfNeedDeferred.bind(this)).done(function() {
                var e = "#profile/soul_strike_change";
                n.history.navigate(e, {
                    trigger: !0
                })
            }).fail(function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickEquipmentList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-equipment-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = this.equipmentCollection.get(i),
                o = n.closest("[data-app-equip-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-equip-list-button-id")),
                a;
            u ? (a = this.estimateBuddyParamsWithEquipment(i), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(s ? s.get("id") : null)) : (a = this.estimateBuddyParamsWithEquipment(this.userSupporterBuddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        estimateBuddyParamsWithEquipment: function(t) {
            var n = this,
                r = e.clone(this.userSupporterBuddyModel.tmpEquipmentTypeNameToId);
            e.isNumber(t) && (r[this.typeName] = t);
            var i = this.userSupporterBuddyModel.getEquipmentModelMapByTypeNameToId(r),
                s = {};
            return e(w.PARAMETERS).each(function(e) {
                var t = n.userSupporterBuddyModel.estimateBuddyParamsWithEquipment(e, i);
                s[e] = t
            }), s
        },
        _getSelectedEquipmentId: function() {
            return this.selectedEquipmentId
        },
        _setSelectedEquipmentId: function(e) {
            this.selectedEquipmentId = e
        },
        _getSelectedEquipmentModel: function() {
            return this.selectedEquipmentId ? this.equipmentCollection.get(this.selectedEquipmentId) : null
        },
        getCurrentEquipmentId: function() {
            return this.userSupporterBuddyModel.getTmpEquipmentIdByTypeName(this.typeName)
        },
        onClickRemove: function() {
            if (this.userSupporterBuddyModel.getEquipmentIdByTypeName(this.typeName) === 0) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = this.estimateBuddyParamsWithEquipment(e),
                n = this.equipmentCollection.get(e),
                r = this.switchFocus(null);
            r ? (this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(n ? n.get("id") : null)) : (t = this.estimateBuddyParamsWithEquipment(this.userSupporterBuddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock()
        },
        saveEquipIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this.userSupporterBuddyModel.hasChangedEquipmentId() && !this.userSupporterbuddyModel.hasChangedSoulStrikeId()) return n.resolve().promise();
            var r = this.userSupporterBuddyModel.getChangedEquipmentInfo();
            return i.saveSupporterBuddyDeferred(r).done(function(t) {
                FF.datastore.fixSupporterTmpEquipments(), e.hasChangedSoulStrike || e.userSupporterBuddyModel.fixTmpSoulStrikes(), n.resolve()
            }), n.promise()
        },
        generateSoulStrikeChangeModalIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.hasChangedSoulStrike ? (this.userSupporterBuddyModel.fixTmpSoulStrikes(), FF.modalStack.push(m, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "onClickDecideNegative", function() {
                        n.reject()
                    }), e.listenToOnce(t, "onClickDecidePositive", function() {
                        n.resolve()
                    })
                },
                onPop: function() {
                    FF.router.loading.show()
                }
            }), n.promise()) : n.reject().promise()
        },
        _back: function() {
            var e = "#profile/equipment_change/" + this.buddyId;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        switchDecideBtn: function() {
            this._getSelectedEquipmentId() === this.getCurrentEquipmentId() || e.isUndefined(this._getSelectedEquipmentId()) ? this.hideDecideBtn() : this.showDecideBtn()
        },
        showDecideBtn: function() {
            t("[data-app-decide]").removeClass("is-disable")
        },
        hideDecideBtn: function() {
            t("[data-app-decide]").addClass("is-disable")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-equip-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-equip-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-equip-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickOpenSortModal: function() {
            b.openModalDeferred(w.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderEquipList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.buddyList && this.buddyList.dispose(), this.modalEquipDetailView && this.modalEquipDetailView.end(), y.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/ChangeDressRecordViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function(e) {
            this.dataMap = e.dataMap;
            if (this.dataMap.buddies.length > 1) throw new Error(sprintf("invalid change buddies num: %d", this.dataMap.buddies.length));
            this.buddy = this.dataMap.buddies[0], kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.dataMap.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.ab.topNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.setTouchCallback(), e.ab.topNode.setVisible(!0).play("play"), e.flush(), n.resolve()
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "buddy_dress";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.oldDressRecordAssetInfo = this.assetsManager.getAssetInfo(sprintf("old-dress-record-%s", this.buddy.id)), this.newDressRecordAssetInfo = this.assetsManager.getAssetInfo(sprintf("new-dress-record-%s", this.buddy.id)), this.changeExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.changeExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.ab.oldDressRecordImageNode.loadBundle(this.oldDressRecordAssetInfo.bundle).setSpriteAnime(this.oldDressRecordAssetInfo.assetPath, {
                node: "dress_before_sprite"
            }).setSpriteAnime(this.oldDressRecordAssetInfo.assetPath, {
                node: "dress_before_sprite_add"
            }), this.ab.newDressRecordImageNode.loadBundle(this.newDressRecordAssetInfo.bundle).setSpriteAnime(this.newDressRecordAssetInfo.assetPath, {
                node: "dress_after_sprite"
            })
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "buddy_dress_nul"
            }), this.ab.oldDressRecordImageNode = this.ab.topNode.createChildNode("dress_before_nul"), this.ab.newDressRecordImageNode = this.ab.topNode.createChildNode("dress_after_nul"), this.ab.visibleTouchNode = this.ab.topNode.createChildNode("visible_touch")
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.topNode.addCallbackOnce("action_enableSkip", function() {
                e.ab.visibleTouchNode.setVisible(!0).process(), FF.logger.debug("[[[[[------- アクション開始 -------]]]]]"), e.ab.visibleTouchNode.addCallback("action_touch_began", function() {
                    FF.logger.debug("[[[[[------- タッチしました。結果を表示します。 -------]]]]]"), e.closeAnimation()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.closeAnimation()
            })
        },
        closeAnimation: function() {
            this.dispose(), this.trigger("closeAnimation"), this.touchEnabled = !0
        },
        clearAB: function() {
            this.changeExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/profile/pages/DressRecordChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/profile/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/helper/StatusDisplayToggle", "./Page", "components/FreeScroll", "components/LongTap", "components/Scrollbar", "templates/profile/DressRecordChange", "templates/profile/views/DressRecordChangeInfo", "templates/profile/views/DressRecordChangeList", "scenes/common/ui_module/SortModuleFacade", "scenes/party/ChangeDressRecordViewController", "lib/TextMaster"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    var y = e.extend({}, s, {});
    return a.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-dress-record-list-id]": "onClickDressRecordList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        _longTaps: [],
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.hasChangedSoulStrike = !1, this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, a.prototype.initialize.call(this, e)
        },
        render: function(e) {
            this.buddyId = e[0], this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), a.prototype.render.call(this, h, {
                buddy: this.userSupporterBuddyModel
            }), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderChangeDetailInfo(), this.renderDressRecordList(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.userSupporterBuddyModel, e.tmpEquip = e.tmpEquip ? e.tmpEquip : {};
            var n = r.process(p, e);
            t("#dressRecordInfo").html(n)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("#dressRecordChangeList")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new u({
                toggleListParentElem: t("#dressRecordChangeList"),
                maxNum: 2
            })
        },
        renderDressRecordList: function(e) {
            e = e || {};
            var t = FF.datastore.dressRecordCollection;
            this.collection = t.sort().getListForChangeDetail(this.userSupporterBuddyModel, {
                forSupporter: !0
            }), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this.collection.slice(e, n),
                s = r.process(d, {
                    buddyModel: this.userSupporterBuddyModel,
                    dressRecordModels: i
                });
            t("#dressRecordChangeList").html(s), this.processAfterRender({
                notShowDeshi: !0
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            })
        },
        saveDressRecordIfNeedDeferred: function() {
            var e = t.Deferred();
            return this.userSupporterBuddyModel.hasChangedDressRecordId() ? (i.saveSupporterBuddyDeferred({
                userBuddyId: this.userSupporterBuddyModel.get("id"),
                soulStrikeId: this.userSupporterBuddyModel.getSoulStrikeId(),
                weaponId: this.userSupporterBuddyModel.getWeaponId(),
                armorId: this.userSupporterBuddyModel.getArmorId(),
                accessoryId: this.userSupporterBuddyModel.getAccessoryId(),
                dressRecordId: this.selectedDressRecordId,
                needDressRecordChangeData: !0
            }).done(function(t) {
                FF.datastore.userSupporterBuddyModel.set(t.user_supporter_buddy), FF.datastore.fixSupporterTmpDressRecords(), e.resolve(t)
            }), e.promise()) : e.resolve().promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var n = e.forceChange,
                r = this._getSelectedDressRecordId();
            this.userSupporterBuddyModel.setTmpDressRecordId({
                dressRecordId: r,
                forSupporter: !0
            }), this.saveDressRecordIfNeedDeferred().done(function(e) {
                t.showAnimation(e)
            }).fail(function() {
                t._back()
            })
        },
        updateSelectedDressRecordById: function(e, n) {
            var r = FF.datastore.dressRecordCollection.get(e);
            if (!n) {
                t("#selectedDressRecordImage").removeAttr("src").addClass("di-n"), t("#selectedDressRecordName").text("");
                return
            }
            r ? (t("#selectedDressRecordImage").attr("src", pUrl(r.get("image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(r.get("name"))) : (t("#selectedDressRecordImage").attr("src", pUrl(this.userSupporterBuddyModel.get("default_image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(this.userSupporterBuddyModel.get("dress_record_name")))
        },
        showAnimation: function(e) {
            var t = this;
            this.changeDressRecordController = new m({
                dataMap: e
            }), this.changeDressRecordController.loadViewDeferred(), this.listenToOnce(this.changeDressRecordController, "closeAnimation", function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickDressRecordList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-dress-record-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = FF.datastore.dressRecordCollection.get(i),
                o = n.closest("[data-app-dress-record-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-dress-record-list-button-id"));
            u ? (this._setSelectedDressRecordId(s ? s.get("dress_record_id") : 0), this.updateSelectedDressRecordById(s, u)) : (this._setSelectedDressRecordId(void 0), this.updateSelectedDressRecordById(void 0, u)), this.switchDisplayParts(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        _getSelectedDressRecordId: function() {
            return this.selectedDressRecordId
        },
        _setSelectedDressRecordId: function(e) {
            this.selectedDressRecordId = e
        },
        _getSelectedDressRecordIdModel: function() {
            return this.selectedDressRecordId ? FF.datastore.dressRecordCollection.get(this.selectedDressRecordId) : null
        },
        getCurrentDressRecordId: function() {
            return this.userSupporterBuddyModel.getTmpDressRecordId()
        },
        onClickRemove: function() {
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = FF.datastore.dressRecordCollection,
                n = t.get(e),
                r = this.switchFocus(null);
            r ? this._setSelectedDressRecordId(dressRecordModel ? dressRecordModel.get("id") : null) : this._setSelectedDressRecordId(void 0), this.switchDisplayParts(), FF.router.loading.unlock()
        },
        onClickOpenSortModal: function() {
            v.openModalDeferred(y.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _back: function() {
            history.back()
        },
        switchDisplayParts: function() {
            this._getSelectedDressRecordId() === this.getCurrentDressRecordId() || e.isUndefined(this._getSelectedDressRecordId()) ? this.hideParts() : this.showParts()
        },
        showParts: function() {
            t("[data-app-decide]").removeClass("is-disable"), t("#animArrow").addClass("is-active")
        },
        hideParts: function() {
            t("[data-app-decide]").addClass("is-disable"), t("#animArrow").removeClass("is-active")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-dress-record-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.modalEquipmentRemoveConfirmView && this.modalEquipmentRemoveConfirmView.dispose(), e.each(this._longTaps, function(e) {
                e.dispose()
            }), this._longTaps.length = 0, a.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/LockFlagManager", ["lib/ClassBase"], function(e) {
    return e.extend({
        initialize: function(e) {
            var t = this;
            this.locks = {}, e = _.isString(e) ? [e] : e, _.each(e, function(e) {
                t.locks[e] = undefined
            })
        },
        lock: function(e) {
            var t = this;
            e = _.isString(e) ? [e] : e, _.each(e, function(e) {
                t.locks[e] = !0
            })
        },
        unlock: function(e) {
            var t = this;
            e = _.isString(e) ? [e] : e, _.each(e, function(e) {
                t.locks[e] = !1
            })
        },
        isLocked: function(e) {
            return this.locks[e]
        },
        isAllLocked: function(e) {
            var t = this.getLocksValues(e);
            return t.length === e.length
        },
        isLockedAnyOf: function(e) {
            var t = this.getLocksValues(e);
            return !!t.length
        },
        getLocksValues: function(e) {
            var t = this;
            return e = _.isString(e) ? [e] : e, _.compact(_.map(e, function(e) {
                return t.isLocked(e)
            }))
        },
        dispose: function() {
            this.locks = {}
        }
    })
}), define("scenes/party/views/ModalSoulStrikeDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalSoulStrikeDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.buddyModel = e.buddyModel, this.soulStrikeModel = e.soulStrikeModel, r.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        render: function() {
            this.renderContent(i, {
                buddyModel: this.buddyModel,
                soulStrikeModel: this.soulStrikeModel
            })
        }
    })
}), define("scenes/party/views/ModalLeaveConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalLeaveConfirm"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-negative]": "onClickDecideNegative",
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function() {
            this.renderContent(i, {})
        },
        onClickDecideNegative: function() {
            FF.modalStack.popAll(!1)
        },
        onClickDecidePositive: function() {
            FF.modalStack.popAll(!0)
        }
    })
}), define("scenes/profile/pages/SoulStrikeChange", ["underscore", "jquery", "backbone", "scenes/profile/Api", "scenes/common/helper/LockFlagManager", "scenes/party/views/ModalSoulStrikeDetail", "scenes/party/views/ModalLeaveConfirm", "scenes/profile/pages/Page", "components/FreeScroll", "components/Scrollbar", "templates/profile/SoulStrikeChange"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        ACTIVE_CLASS_NAME: "is-active",
        DISABLE_CLASS_NAME: "is-disable",
        DISIDE_BTN_ELEM_NAME: "#decideBtn",
        LIST_ELEM_NAME: "#soulStrikeList",
        USER_SUPPORTER_SOUL_STRIKE_SLOT: 1
    };
    return u.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump [data-app-soulStrike-id]": "onClickSoulStrikeListItem",
            "anchorslongtap    [data-app-soulStrike-id]": "onLongTapSoulStrikeDetailView"
        },
        initialize: function(e) {
            this.userSupporterBuddyModel = FF.datastore.userSupporterBuddyModel, this.equippedSoulStrikes = this.userSupporterBuddyModel.getTmpSoulStrikeModels(), this.selectedSoulStrikeId = this.equippedSoulStrikes[0].get("id"), this.lockFlagManager = new i, this.lockFlagManager.initialize(["isTapped"]), u.prototype.initialize.call(this, e)
        },
        render: function(e) {
            u.prototype.render.call(this, l, {
                buddy: this.userSupporterBuddyModel,
                soulStrikes: this.getSelectableSoulStrikeModelsFilterByTmpEquipped(),
                equippedSoulStrikes: this.equippedSoulStrikes,
                defaultSoulStrikeId: this.userSupporterBuddyModel.get("default_soul_strike_id")
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapSoulStrikeDetailView: function(e) {
            var n = t(e.target).closest("[data-app-selected-soulStrike-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-soulStrike-id]"), r = n.attr("data-app-soulStrike-id")) : r = n.attr("data-app-selected-soulStrike-id"), this.freescroll.cancelScroll(), this.openSoulStrikeDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openSoulStrikeDetail: function(e) {
            var t = this,
                n = FF.datastore.soulStrikeCollection.get(e);
            FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({
                        buddyModel: t.userSupporterBuddyModel,
                        soulStrikeModel: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        getSelectableSoulStrikeModelsFilterByTmpEquipped: function() {
            var t = this.userSupporterBuddyModel.getTmpSoulStrikeIds(),
                n = this.userSupporterBuddyModel.getSelectableSoulStrikeModels(),
                r = e.filter(n, function(n) {
                    return e.indexOf(t, n.get("id")) === -1
                });
            return r
        },
        _hasChanged: function() {
            return this.userSupporterBuddyModel.hasChangedSoulStrikeId()
        },
        _showDecideBtn: function() {
            t(c.DISIDE_BTN_ELEM_NAME).removeClass(c.DISABLE_CLASS_NAME)
        },
        _hideDecideBtn: function() {
            t(c.DISIDE_BTN_ELEM_NAME).addClass(c.DISABLE_CLASS_NAME)
        },
        _isEmptyTmpSoulStrike: function() {
            return e.compact(this.userSupporterBuddyModel.getTmpSoulStrikeIds()).length === 0
        },
        _hasActiveTarget: function(e) {
            return e.hasClass(c.ACTIVE_CLASS_NAME)
        },
        _activateTarget: function(e) {
            e.addClass(c.ACTIVE_CLASS_NAME)
        },
        _deactivateTarget: function(e) {
            e.removeClass(c.ACTIVE_CLASS_NAME)
        },
        onClickSoulStrikeListItem: function(e) {
            var n = t(e.target);
            if (this.lockFlagManager.isLocked("isTapped")) return;
            this.lockFlagManager.lock("isTapped");
            if (this._hasActiveTarget(n)) {
                this._deactivateTarget(n), this.selectedSoulStrikeId = this.equippedSoulStrikes[0].get("id"), this._hideDecideBtn(), this.lockFlagManager.unlock("isTapped");
                return
            }
            var r = t(c.LIST_ELEM_NAME).find("." + c.ACTIVE_CLASS_NAME);
            this._deactivateTarget(r), this._activateTarget(n), this.selectedSoulStrikeId = n.attr("data-app-soulStrike-id"), this._showDecideBtn(), this.lockFlagManager.unlock("isTapped")
        },
        onClickDecide: function() {
            var e = this;
            if (this.lockFlagManager.isLocked("isTapped")) return;
            this.lockFlagManager.lock("isTapped"), this.userSupporterBuddyModel.setTmpSoulStrikeId({
                slot: c.USER_SUPPORTER_SOUL_STRIKE_SLOT,
                soulStrikeId: this.selectedSoulStrikeId
            }), FF.router.loading.lock(), this.saveSoulStrikeDeferred().done(function() {
                FF.router.loading.hide(), e._back()
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            if (!this._hasChanged()) return n.resolve().promise();
            var i = this.userSupporterBuddyModel.getTmpSoulStrikeId();
            return r.saveSupporterBuddyDeferred({
                userBuddyId: this.userSupporterBuddyModel.get("id"),
                soulStrikeId: i,
                weaponId: this.userSupporterBuddyModel.getWeaponId(),
                armorId: this.userSupporterBuddyModel.getArmorId(),
                accessoryId: this.userSupporterBuddyModel.getAccessoryId(),
                dressRecordId: this.userSupporterBuddyModel.getDressRecordId()
            }).done(function(r) {
                FF.datastore.userSupporterBuddyModel.set(r.user_supporter_buddy), FF.datastore.fixSupporterTmpEquipments(), e.userSupporterBuddyModel.fixTmpSoulStrikes(), FF.router.toast.topping(t("#toast-message-update-soul-strike").text()), n.resolve()
            }), n.promise()
        },
        _back: function() {
            n.history.navigate("#profile/equipment_change", {
                trigger: !0
            })
        },
        onClickBack: function() {
            var e = this;
            if (!this._hasChanged()) {
                this._back(), this.userSupporterBuddyModel.resetTmpSoulStrikes();
                return
            }
            if (this._isEmptyTmpSoulStrike()) {
                FF.router.toast.topping(t("#toast-message-no-soul-strike").text()).bake(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.modalStack.push(o, {
                renderer: function(e) {
                    e.render()
                },
                onPop: function(t, n) {
                    n ? e.saveSoulStrikeDeferred().then(function() {
                        e._back()
                    }) : (e.userSupporterBuddyModel.resetTmpSoulStrikes(), e._back())
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/profile/ProfileScene", ["jquery", "lib/Scene", "scenes/common/util/Api", "./pages/Profile", "./pages/UserSupporterBuddyEdit", "./pages/EquipmentChange", "./pages/EquipmentChangeDetail", "./pages/DressRecordChange", "./pages/SoulStrikeChange"], function(e, t, n, r, i, s, o, u, a) {
    return t.extend({
        pages: {
            profile: r,
            user_supporter_buddy_edit: i,
            equipment_change: s,
            equipment_change_detail: o,
            dress_record_change: u,
            soul_strike_change: a
        },
        setupDeferred: function() {
            var t = this,
                n = e.Deferred(),
                r = FF.datastore;
            return this.userProfileDeferred().done(function(e) {
                r.addUserSupporterBuddyAllData(e), n.resolve()
            }), n.promise()
        },
        userProfileDeferred: function() {
            var t = e.Deferred(),
                r = FF.datastore.userModel.get("id");
            return n.userProfileDeferred(r).done(function(e) {
                e.user_supporter_buddy.invite_id = e.invite_id, e.user_supporter_buddy.nickname = e.profile.nickname, e.user_supporter_buddy.profile_message = e.profile.profile_message, t.resolve(e)
            }), t.promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "profile";
            FF.logger.debug("ProfileScene: showPage : " + r, t), this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in ProfileScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                FF.SoundMgr.playMusic("bgm_09_040"), n.layoutView.render(t, e)
            })
        }
    })
}), define("scenes/relation/Api", ["underscore", "scenes/common/util/Api"], function(e, t) {
    return e.extend({}, t, {
        getFolloweeListDeferred: function() {
            return this.requestDeferred("/dff/relation/followee_list", {}, {
                type: "POST"
            })
        },
        getFollowerListDeferred: function() {
            return this.requestDeferred("/dff/relation/follower_list", {}, {
                type: "POST"
            })
        },
        getFolloweeAndFollowerListDeferred: function() {
            return this.requestDeferred("/dff/relation/followee_and_follower_list", {}, {
                type: "POST"
            })
        },
        findByUserIdsDeferred: function(e, t) {
            t = t || {};
            var n = {};
            return n.ids = e, n.dungeon_id = t.dungeonId, this.requestDeferred("/dff/relation/find_by_user_ids", n, {
                type: "POST",
                disableLoading: t.disableLoading
            })
        },
        findByInviteIdDeferred: function(e) {
            return this.requestDeferred("/dff/relation/find_by_invite_id", {
                id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/views/relation/ModalError", ["underscore", "jquery", "backbone", "templates/common/relation/ModalError", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        initialize: function(e) {
            this.errors = e.errors, this.isFollow = e.isFollow, this.isUnfollow = e.isUnfollow, i.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(r, {
                errors: this.errors,
                isFollow: this.isFollow,
                isUnfollow: this.isUnfollow
            }), FF.router.loading.hide(!0)
        }
    })
}), define("scenes/relation/pages/Page", ["underscore", "jquery", "lib/LayoutBase", "scenes/common/collections/Profile"], function(e, t, n, r) {
    return n.extend({
        categoryType: "home",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        initialize: function(e) {
            n.prototype.initialize.call(this), this.scene = e.scene
        },
        render: function(e, t) {
            n.prototype.render.call(this, e, t), this.processAfterRender()
        }
    })
}), define("scenes/relation/pages/FollowList", ["underscore", "jquery", "util", "backbone", "lib/TemplateRenderer", "scenes/common/util/Api", "scenes/relation/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/views/relation/ModalError", "scenes/common/helper/FuncTutorial", "scenes/common/helper/Relation", "scenes/common/collections/Profile", "./Page", "templates/relation/FollowList", "templates/relation/views/FollowList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = e.extend({}, u, {
            CURRENT_CLASS_NAME: "is-current",
            DISABLE_CLASS_NAME: "is-disable",
            FOLLOWEE_CATEGORY_NAME: "followee",
            FOLLOWER_CATEGORY_NAME: "follower"
        }),
        g = FF.env.isIOS() ? !0 : !1;
    return p.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-profile-detail]": "onClickCharaDetailView",
            "anchorsbeforejump [data-app-tab-small] li": "onClickTabSmall",
            "anchorsbeforejump [data-app-follow]": "onClickFollow"
        },
        initialize: function(e) {
            this.activeCategory = void 0, this.newFollowerNum = 0, this._footerEventHandlerFunc = this.onClickGlobalNavi.bind(this), FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", this._footerEventHandlerFunc), p.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return e._followeeProfileCollection = FF.datastore.followeeProfileCollection, e._followerProfileCollection = FF.datastore.followerProfileCollection, e._followeeProfileCollection.hasCache() && e._followerProfileCollection.hasCache() ? n.resolve().promise() : (o.getFolloweeAndFollowerListDeferred().done(function(t) {
                e._followeeProfileCollection.resetWithSettingCache(t.followees.target_profiles), e._followeeProfileCollection.addWithPreloadedUserRelations(t.followees.user_relations), e.updateFFDatastore(t), e.newFollowerNum = t.follower_new_count, e._followerProfileCollection.resetWithSettingCache(t.followers.target_profiles), e._followerProfileCollection.addWithPreloadedUserRelations(t.followers.user_relations), n.resolve()
            }), n.promise())
        },
        render: function() {
            p.prototype.render.call(this, d, {
                followeeCollection: this._followeeProfileCollection,
                followerCollection: this._followerProfileCollection,
                newRelationNum: this.newFollowerNum,
                userModel: FF.datastore.userModel
            }), this.activeCategory = m.FOLLOWEE_CATEGORY_NAME, this.renderOverScrollView(), this.setupRenderList(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            p.prototype.processAfterContentLoad.apply(this, arguments), l.showNavigationDeferred({
                key: "FELLOW_LIST",
                isTutorialIllustOnly: !0
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new a({
                displayType: "PROFILE_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setupRenderList: function() {
            this.switchActiveCategoryCollection()
        },
        renderCollectionList: function() {
            var e = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > e && this.overScrollView.setCurrentPage(e), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var n = this,
                r = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum(),
                u = this.activeCategoryCollection.getAvailableLength() ? this.activeCategoryCollection.sort().getAvailableModels().slice(r, s) : [],
                a = function() {
                    var e = i.process(v, {
                            models: u,
                            isFolloweeModels: n.activeCategory === m.FOLLOWEE_CATEGORY_NAME,
                            isFollowerModels: n.activeCategory === m.FOLLOWER_CATEGORY_NAME
                        }),
                        r = t("[data-app-list-items]");
                    n.overScrollView.render({
                        html: e,
                        parentElement: r,
                        imageWatcher: n.imageWatcher
                    }), n.processAfterRender({
                        notShowDeshi: !0
                    }), g && (n.overScrollView.restartLazyLoad(), n.overScrollView.updateContent())
                },
                f = e.filter(u, function(e) {
                    return e.isBeforeLoad()
                }),
                l = e.map(f, function(e) {
                    return e.getUserId()
                });
            if (l.length === 0) {
                a();
                return
            }
            o.findByUserIdsDeferred(l).done(function(t) {
                e.each(f, function(n) {
                    var r = e.find(t.target_profiles, function(e) {
                        return e.user_id === n.getUserId()
                    });
                    n.setWithMergePreloadedAttributes(r)
                }), a()
            })
        },
        switchActiveCategoryCollection: function() {
            this.activeCategoryCollection = this["_" + this.activeCategory + "ProfileCollection"];
            var e = this.activeCategoryCollection.getAvailableLength();
            this.overScrollView.updateCollectionSize(e), this.renderCollectionList(), this.activeCategoryCollection.resetIsNewRelation()
        },
        updateFFDatastore: function(e) {
            this.newFollowerNum = e.follower_new_count, FF.datastore.stash.newRelationNum = e.follower_new_count, t(document).trigger("updateBadge")
        },
        updateFollowNum: function() {
            t("[data-app-followee-num]").html(this._followeeProfileCollection.getAvailableLength()), t("[data-app-follower-num]").html(this._followerProfileCollection.getAvailableLength())
        },
        onClickCharaDetailView: function(e) {
            var n = t(e.target).closest("[data-app-profile-detail]"),
                r = n.attr("data-app-profile-detail");
            this.openProfileDetail(r)
        },
        openProfileDetail: function(e) {
            var t = this;
            if (this.isLocked || this.hasOpenedModal()) return;
            this.isLocked = !0;
            var n = this.activeCategoryCollection.get(e),
                r = n.getNickname();
            this.profileDetailModalView = c.showModal(n), this.listenTo(this.profileDetailModalView, "closeAnimationEnd", function() {
                t.isLocked = !1
            }).listenToOnce(this.profileDetailModalView, "onFollow", function(n) {
                t.updateAfterFollow(e, n.data), t.listenToOnce(t.profileDetailModalView, "closeAnimationEnd", function() {
                    t.renderUpdate(n.data)
                })
            }).listenToOnce(this.profileDetailModalView, "onUnfollow", function(n) {
                t.updateAfterUnfollow(e), t.listenToOnce(t.profileDetailModalView, "closeAnimationEnd", function() {
                    t.renderUpdate(n.data)
                })
            }).listenToOnce(this.profileDetailModalView, "bakeFollowToast", function(n) {
                t.updateAfterFollow(e, n.data), t.renderUpdate(n.data), FF.router.loading.hide(), t.bakeFollowToast()
            })
        },
        openFollowModalOrToast: function(t) {
            var n = this,
                r = {
                    sceneId: FF.CONST.CLIENT.FOLLOW_SCENE_ID_OF.FOLLOWER_LIST
                };
            s.followDeferred(+t, r).then(function(r) {
                e.isEmpty(r.user_relation_errors) ? (n.updateAfterFollow(t, r), r.isUnfollow = !1, n.bakeFollowToast(), n.renderUpdate(r), FF.router.loading.hide()) : n.openErrorModal({
                    isFollow: !0,
                    errors: r.user_relation_errors
                }), n.isLocked = !1
            })
        },
        bakeFollowToast: function() {
            FF.router.toast.topping(t("#toast-message-follow").text())
        },
        openErrorModal: function(e) {
            this.modalErrorView = new f(e), this.modalErrorView.render(), FF.router.overlay.registerChildren(this.modalErrorView), this.modalErrorView.open()
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        renderUpdate: function(e) {
            this.setSssGaugeIfNeed(e), this.updateFollowNum(), this.setupRenderList(), this.overScrollView.setIsScrollableIfSinglePage()
        },
        setSssGaugeIfNeed: function(e) {
            e.current_supporter_ss_gauge && FF.datastore.userModel.set("supporter_ss_gauge", e.current_supporter_ss_gauge)
        },
        updateAfterFollow: function(e, t) {
            var n = this.activeCategoryCollection.get(e);
            n.set("relation_status", FF.CONST.SERVER.RELATION.STATUS_OF.FRIEND), n.set("relation_updated_at", t.relation_updated_at), this._followeeProfileCollection.add(n.attributes), this._followerProfileCollection.add(n.attributes, {
                merge: !0
            })
        },
        updateAfterUnfollow: function(e) {
            var t = this.activeCategoryCollection.get(e);
            if (t.isFriend()) {
                t.set("relation_status", FF.CONST.SERVER.RELATION.STATUS_OF.FOLLOWER);
                var n = this._followerProfileCollection.get(e);
                n.isBeforeLoad() && n.setPreloadedAttributes(t.attributes), this._followerProfileCollection.add(t.attributes, {
                    merge: !0
                })
            }
            this._followeeProfileCollection.remove(e)
        },
        onClickTabSmall: function(e) {
            FF.router.loading.lock(), this.newFollowerNum > 0 && (t("[data-app-new-badge]").remove(), this.updateFFDatastore({
                follower_new_count: 0
            })), t("[data-app-tab-small] li").removeClass(m.CURRENT_CLASS_NAME), t(e.target).addClass(m.CURRENT_CLASS_NAME), this.activeCategory = t(e.target).attr("data-app-tab-small-category"), this.overScrollView.cleanup(), this.switchActiveCategoryCollection(), this.overScrollView.setIsScrollableIfSinglePage(), FF.router.loading.unlock()
        },
        onClickFollow: function(e) {
            if (this.isLocked || this.hasOpenedModal()) return;
            this.isLocked = !0;
            var n = t(e.target).closest("[data-app-follow]").attr("data-app-follow");
            this.openFollowModalOrToast(n)
        },
        onClickBack: function() {
            this.updateFFDatastore({
                follower_new_count: 0
            }), FF.router.loading.lock(), r.history.navigate("friend", {
                trigger: !0
            })
        },
        onClickGlobalNavi: function(e) {
            this.updateFFDatastore({
                follower_new_count: 0
            }), FF.router.globalcontrol.anchorsEventHandlerFunc(e)
        },
        dispose: function() {
            t(".g-navigation [data-mbgaui-anchors]").off("anchorsbeforejump", this._footerEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation(), this.overScrollView && this.overScrollView.dispose(), this.modalErrorView && this.modalErrorView.dispose(), this.modalFollowView && this.modalFollowView.dispose(), this.profileDetailModalView && this.profileDetailModalView.dispose(), p.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/UsersInputView", ["jquery", "backbone"], function(e, t) {
    var n = "is-disable",
        r = "is-show",
        i = "data-app-default-value",
        s = FF.env.isAndroidVersionGreaterThanOrEqualTo(5, 0);
    return t.View.extend({
        events: {
            "touchend [data-app-input-screen]": "onTouchStartInputScreen",
            "touchstart [data-app-input-attr]": "onTouchStartInput",
            "touchend [data-app-input-attr]": "onTouchEndInput",
            "focus [data-app-input-attr]": "onFocusInput",
            "keydown [data-app-register-input]": "onKeypressRegisterInput",
            "blur [data-app-register-input]": "onBlurRegisterInput"
        },
        initialize: function(e) {
            this.options = e, this._collectElements(), this._addEventListener()
        },
        _collectElements: function() {
            this._elements = {
                registerInput: e("[data-app-register-input]"),
                inputScreen: e("[data-app-input-screen]"),
                inputAttr: e("[data-app-input-attr]"),
                hiddenInputAttr: e("[data-app-hidden-input-attr]")
            }
        },
        _addEventListener: function() {
            this.listenTo(this.options.parent, "onClickBackKey", this.onClickBack)
        },
        onClickBack: function() {
            this._elements.inputScreen.hasClass(r) ? (this._elements.registerInput.blur(), FF.env.isAndroid2_3() && this.returnToOriginalDisplay()) : this.trigger("onClickBackWithoutFocus")
        },
        onTouchStartInput: function(t) {
            FF.env.isIOS() && (this._elements.inputScreen.addClass(r), this._elements.registerInput.focus(), this.options.isNickname && FF.env.isIOS7_0() && e(document).trigger("focusInput"));
            if (FF.env.isAndroid4_0() || s) this._elements.inputAttr.focus(), t.preventDefault()
        },
        onTouchStartInputScreen: function(e) {
            (FF.env.isAndroid2_3 || FF.env.isAndroid4_0 || FF.env.isAndroidVersionGreaterThanOrEqualTo5_0) && e.target.tagName.toLowerCase() === "div" && this.returnToOriginalDisplay()
        },
        onTouchEndInput: function(e) {
            if (FF.env.isAndroid4_4 || FF.env.isAndroidVersionGreaterThanOrEqualTo5_0) this._elements.inputScreen.addClass(r), this._elements.registerInput.focus(), e.preventDefault(), e.stopPropagation()
        },
        onFocusInput: function() {
            if (FF.env.isAndroid() && !FF.env.isAndroid4_4()) {
                this._elements.inputAttr.hide(), this._elements.inputScreen.addClass(r), this._elements.registerInput.focus();
                if (FF.env.isAndroid2_3()) {
                    var e = this,
                        t = this._elements.registerInput.val();
                    this._elements.registerInput.val(""), window.setTimeout(function() {
                        e._elements.registerInput.val(t)
                    })
                }
            }
        },
        onKeypressRegisterInput: function(t) {
            t.which === 13 && (e(t.target).blur(), FF.env.isAndroid2_3() && this.returnToOriginalDisplay(), t.preventDefault())
        },
        onBlurRegisterInput: function() {
            FF.env.isAndroid2_3() || this.returnToOriginalDisplay()
        },
        returnToOriginalDisplay: function() {
            this._elements.inputScreen.removeClass(r), this._elements.inputAttr.show();
            var t = this._elements.registerInput.val(),
                s = FF.env.isIOS() ? "text" : "val";
            if (e.trim(t).length) this._elements.inputAttr[s](t), this._elements.hiddenInputAttr.val(t), this.options.submitBtnEl.removeClass(n);
            else {
                this._elements.inputAttr[s](this._elements.inputAttr.attr(i)), this.options.submitBtnEl.addClass(n);
                if (this.options.isNickname) {
                    var o = this._elements.inputAttr.attr(i);
                    this._elements.hiddenInputAttr.val(o), this._elements.registerInput.val(o)
                }
            }
            this.options.isNickname && FF.env.isIOS7_0() && e(document).trigger("blurInput")
        },
        clearInput: function() {
            this._elements.registerInput.empty().val(""), this._elements.inputAttr.empty().val(""), this._elements.hiddenInputAttr.empty().val(""), this.options.submitBtnEl.addClass(n)
        },
        onClickSubmitButton: function() {
            FF.env.isAndroid() || FF.env.isIOS7_0() ? e(".layout-adjust").removeClass("layout-adjust") : this._elements.inputAttr.blur()
        },
        dispose: function() {
            this.stopListening(), this.undelegateEvents()
        }
    })
}), define("scenes/relation/pages/Search", ["underscore", "jquery", "scenes/common/collections/Profile", "./Page", "scenes/relation/Api", "scenes/common/helper/Relation", "scenes/common/views/UsersInputView", "templates/relation/Search"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-input-attr]": "onClickBack",
            "anchorsbeforejump [data-app-find-by-invite-id]": "_onFindByInviteId",
            "onBackKey [data-app-input-attr]": "onClickDeviceBackKey"
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this._resultProfileCollection = new n, e.resolve().promise()
        },
        render: function() {
            r.prototype.render.call(this, u, {
                profiles: this._resultProfileCollection.models,
                isWWLayout: FF.env.isWWRegion()
            }), this.generateUsersInputView(), FF.env.isIOS7_0() && this.addEventListener7_0(), FF.env.isAndroid() && this.addEventListenerAndroid()
        },
        generateUsersInputView: function() {
            var e = this;
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-find-by-invite-id]")
            }), this.listenTo(this.usersInputView, "onClickBackWithoutFocus", function() {
                t("#modal").hasClass("open") && t("[data-app-modal-close]").length > 0 ? t("[data-app-modal-close]").trigger("anchorsbeforejump") : (FF.SoundMgr.playChooseEffect(), e.onClickBack())
            })
        },
        _onFindByInviteId: function() {
            FF.router.loading.show();
            var e = this,
                n = t.trim(t('[name="inviteId"]').val());
            if (!this._isValidString(n)) {
                FF.SoundMgr.playNgEffect(), FF.router.loading.hide(), this._modalProfileDetailView = s.showModal(void 0);
                return
            }
            FF.SoundMgr.playChooseEffect(), i.findByInviteIdDeferred(n).then(function(t) {
                e._resultProfileCollection.reset(t.target_profiles);
                var n = e._resultProfileCollection.models[0];
                e._modalProfileDetailView = s.showModal(n), e.listenToOnce(e._modalProfileDetailView, "bakeFollowToast", function(t) {
                    FF.router.loading.hide(), e._bakeFollowToast()
                })
            })
        },
        _bakeFollowToast: function() {
            FF.router.toast.topping(t("#toast-message-follow").text()).bake()
        },
        _isValidString: function(e) {
            var t = /[^\x01-\x7E]/;
            return e.match(t) ? !1 : !0
        },
        _generateProfileDetailModal: function(e) {
            this._modalProfileDetailView = s.showModal(e)
        },
        onClickDeviceBackKey: function() {
            this.trigger("onClickBackKey")
        },
        onClickBack: function() {
            Backbone.history.navigate("friend", {
                trigger: !0
            })
        },
        addEventListener7_0: function() {
            var e = this;
            t(".c-layer-bg").on("touchstart", function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        addEventListenerAndroid: function() {
            FF.env.isUsingWWBackKeyHandler() || (kickmotor.nativefn.onBackKey = function() {
                t("[data-app-input-attr]").trigger("onBackKey")
            })
        },
        dispose: function() {
            this._modalProfileDetailView && this._modalProfileDetailView.dispose(), this.usersInputView && this.usersInputView.dispose(), FF.env.isAndroid() && FF.router.setupOnBackKey(), FF.env.isIOS7_0() && t(".c-layer-bg").off("touchstart"), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/relation/RelationScene", ["underscore", "jquery", "lib/Scene", "./pages/FollowList", "./pages/Search"], function(e, t, n, r, i) {
    return n.extend({
        pages: {
            follow_list: r,
            search: i
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return n.resolve().promise()
        },
        start: function(e, t) {
            var n = this;
            n.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "follow_list";
            this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in PartyScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutView.setupDeferred().done(function() {
                n.layoutView.render(t)
            })
        }
    })
}), define("scenes/gift_box/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        giftBoxGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/gift_box/get_data", {
                offset_id: e
            })
        },
        giftBoxReceiveSingleDeferred: function(e, t) {
            return this.requestDeferred("/dff/gift_box/receive", {
                id: e,
                offset_id: t
            }, {
                type: "POST"
            })
        },
        giftBoxReceiveAllDeferred: function() {
            return this.requestDeferred("/dff/gift_box/receive_all", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/gift_box/views/Layout", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "sprintf", "lib/LayoutBase", "templates/gift_box/GiftBox", "templates/gift_box/GiftList", "components/OverScrollable", "components/Scrollbar", "util"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        RECEIVE: "receive_single",
        RECEIVE_ALL: "receive_all",
        LOAD_MORE_GIFTS: "load_more_gifts"
    };
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-receive-gift]": "onClickReceiveSingle",
            "anchorsbeforejump [data-app-receive-all]": "onClickReceiveAll"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.gifts = e.gifts, this.itemPossessionLimit = e.itemPossessionLimit
        },
        render: function() {
            var e = {
                isEmpty: this.gifts.length > 0 ? !1 : !0
            };
            s.prototype.render.call(this, o, e), FF.datastore.stash.giftBoxNum < 1 && t("[data-app-receive-all]").hide(), this.appendGiftLists(this.gifts), this.generateComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.trigger("processedAfterContentLoad")
        },
        appendGiftLists: function(n) {
            var i = 0,
                s = this.itemPossessionLimit.ability.enable_give_num < 1 ? !0 : !1,
                o = this.itemPossessionLimit.equipment.enable_give_num < 1 ? !0 : !1;
            e.each(n, function(e) {
                e.remain_time_str = l.secondToDDHHMM(e.remain_second);
                var n = {
                    gift: e,
                    canReceive: e.item_type_name === "EQUIPMENT" && o || e.item_type_name === "ABILITY" && s ? !1 : !0
                };
                t("[data-ui-list-outline]").append(r.process(u, n)), i < e.id && (i = e.id)
            }.bind(this)), this.biggestGiftId = i, this.scrollbar && this.scrollbar.updateContent()
        },
        generateComponents: function() {
            this.overscrollable = new a({
                el: t("[data-ui-freescroll]"),
                loading: t("[data-ui-loading]"),
                useNativeScroll: !1
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenToOnce(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)
        },
        onClickReceiveSingle: function(e) {
            FF.router.loading.lock();
            var n = e.target.getAttribute("data-app-gift-box-id") || t(e.target).closest("[data-app-receive-gift]").attr("data-app-gift-box-id");
            this.trigger(c.RECEIVE, n, this.biggestGiftId)
        },
        onClickReceiveAll: function() {
            FF.router.loading.lock(), this.trigger(c.RECEIVE_ALL)
        },
        onClickBack: function() {
            n.history.navigate("#home", {
                trigger: !0
            })
        },
        updateByOverscroll: function() {
            if (this.isUpdatingByOverscroll) return;
            return this.isUpdatingByOverscroll = !0, this.trigger(c.LOAD_MORE_GIFTS, this.biggestGiftId), !1
        },
        addMoreGiftData: function(e) {
            e.gifts.length > 0 && (this.appendGiftLists(e.gifts), this.gifts = this.gifts.concat(e.gifts), this.listenToOnce(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)), this.isUpdatingByOverscroll = !1, FF.router.loading.hide()
        },
        setupAfterReceipt: function(e) {
            this.removeGift(e.received_gift_id);
            var n = e.gifts;
            n.length > 0 && (this.appendGiftLists(n), this.gifts = this.gifts.concat(n)), this._updateGiftReceivable(e.item_possession_limit), FF.datastore.stash.giftBoxNum < 1 && (t("[data-app-receive-all]").hide(), t("[data-app-empty-label]").removeClass("di-n")), this.scrollbar.updateContent()
        },
        removeGift: function(e) {
            t("[data-app-gift-box-list =" + e + "]").remove();
            for (var n = 0; n < this.gifts.length; n++) this.gifts[n].id === e && this.gifts.splice(n, 1)
        },
        _updateGiftReceivable: function(n) {
            this.itemPossessionLimit = n;
            var r = this.itemPossessionLimit.ability.enable_give_num < 1 ? !0 : !1,
                i = this.itemPossessionLimit.equipment.enable_give_num < 1 ? !0 : !1;
            e.each(this.gifts, function(e) {
                e.item_type_name === "EQUIPMENT" && i || e.item_type_name === "ABILITY" && r ? (t("[data-app-receive-gift][data-app-gift-box-id=" + e.id + "]").addClass("is-disable"), t("[data-app-receive-alert-" + e.id + "]").show()) : (t("[data-app-receive-gift][data-app-gift-box-id=" + e.id + "]").removeClass("is-disable"), t("[data-app-receive-alert-" + e.id + "]").hide())
            })
        },
        dispose: function() {
            this.overscrollable && this.overscrollable.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    }, {
        EVENT_TYPE: c
    })
}), define("scenes/gift_box/views/ModalReceived", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gift_box/ModalReceived"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        render: function() {
            this.renderContent(i, {})
        }
    })
}), define("scenes/gift_box/views/ModalError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/gift_box/ModalError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        render: function(e) {
            this.renderContent(i, e)
        }
    })
}), define("scenes/gift_box/GiftBoxScene", ["underscore", "jquery", "backbone", "scenes/gift_box/Api", "lib/Scene", "./views/Layout", "./views/ModalReceived", "./views/ModalError"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.giftBoxGetDataDeferred().done(function(t) {
                e._data = t, n.resolve()
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().done(function() {
                e._updateFFDatastore(e._data), e.renderLayoutView(), FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        renderLayoutView: function() {
            this.layoutView = new s({
                el: t("#content"),
                gifts: this._data.gifts,
                itemPossessionLimit: this._data.item_possession_limit,
                receivable_num: this._data.receivable_num
            }), this.layoutView.render(), this.listenToLayoutView()
        },
        listenToLayoutView: function() {
            this.listenTo(this.layoutView, s.EVENT_TYPE.RECEIVE, this.receiveSingle).listenTo(this.layoutView, s.EVENT_TYPE.RECEIVE_ALL, this.receiveAll).listenTo(this.layoutView, s.EVENT_TYPE.LOAD_MORE_GIFTS, this.loadMoreGifts)
        },
        loadMoreGifts: function(e) {
            r.giftBoxGetDataDeferred(e).done(function(e) {
                this.layoutView.addMoreGiftData(e)
            }.bind(this))
        },
        receiveSingle: function(e, t) {
            var n = this;
            r.giftBoxReceiveSingleDeferred(e, t).then(function(e) {
                FF.datastore.clearHasPartyAllData(), n._updateFFDatastore(e), n._receivedAction(e)
            }, function(e) {
                n._openOnErrorModal(e)
            })
        },
        _receivedAction: function(e) {
            this._openOnReceivedModal(), this.layoutView.setupAfterReceipt(e)
        },
        receiveAll: function() {
            var e = this;
            r.giftBoxReceiveAllDeferred().then(function(t) {
                FF.datastore.clearHasPartyAllData(), e._updateFFDatastore(t), e._data = t, e.layoutView.dispose(), e.renderLayoutView(), e.listenToOnce(e.layoutView, "processedAfterContentLoad", e._openOnReceivedModal)
            }, function(t) {
                e._openOnErrorModal(t)
            })
        },
        _updateFFDatastore: function(n) {
            FF.datastore.itemPossessionLimitCollection.reset(e.values(n.item_possession_limit)), FF.datastore.userModel.set(n.user), FF.datastore.stash.giftBoxNum = n.receivable_num, t(document).trigger("updateBadge")
        },
        _openOnReceivedModal: function() {
            var e = new o;
            FF.router.overlay.registerChildren(e), e.render(), e.open(!0)
        },
        _openOnErrorModal: function(e) {
            var t = this,
                n = new u;
            FF.router.overlay.registerChildren(n), n.render(e), n.open(), t.listenToOnce(n, "closeNotify", function() {
                FF.router.loading.show(), t.layoutView.dispose(), t.start()
            })
        }
    })
}), define("scenes/login_bonus/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        loginBonusReceiveDeferred: function() {
            return this.requestDeferred("/dff/login_bonus/receive", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/login_bonus/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/TimeKeeper", "templates/login_bonus/LoginBonus", "templates/login_bonus/FirstAnniversaryLoginBonus", "templates/login_bonus/TenMillionDownload"], function(e, t, n, r, i, s, o, u) {
    var a = {
            FIRST_ANNIVERSARY: 29,
            TEN_MILLION_DOWNLOAD: 43
        },
        f = {};
    f[a.FIRST_ANNIVERSARY] = o, f[a.TEN_MILLION_DOWNLOAD] = u;
    var l = {};
    return l[a.TEN_MILLION_DOWNLOAD] = {
        contentType: "NO_BASE"
    }, r.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-login-bonus-received]": "onLoginBonusReceivedClick"
        },
        initialize: function(t) {
            var n = this;
            this.received_login_bonus = t.received_login_bonus, this.directly_received_login_bonus = t.directly_received_login_bonus;
            var i = this.received_login_bonus.concat(this.directly_received_login_bonus);
            this.sorted_all_received_login_bonus = i.sort(this.displaySortFunc);
            var s = e.find(this.sorted_all_received_login_bonus, function(e) {
                return l[e.id]
            });
            s && e.each(["contentType", "designType"], function(e) {
                l[s.id][e] && (n[e] = l[s.id][e])
            }), r.prototype.initialize.call(this), this.login_bonus_index = 0
        },
        displaySortFunc: function(e, t) {
            return e.priority > t.priority ? -1 : e.priority < t.priority ? 1 : 0
        },
        render: function() {
            var e = this.sorted_all_received_login_bonus[this.login_bonus_index],
                t = {
                    title: e.name,
                    description: e.description,
                    prize_images: e.prize_images,
                    current_count: e.current_count,
                    current_prize_items: e.current_prize_items,
                    openedTermText: this.getTermText(e.opened_at)
                },
                n = e.id,
                i = f[n] || s;
            r.prototype.render.call(this, i, t), this.processAfterRender()
        },
        onLoginBonusReceivedClick: function() {
            FF.router.loading.lock(), this.login_bonus_index++, this.login_bonus_index >= this.sorted_all_received_login_bonus.length ? FF.router.goBootstrapNextScene() : this.render()
        },
        getTermText: function(e) {
            var t = this.getTimeKeeper();
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + t.setUnixTime(e).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + t.setUnixTime(e).getString({
                timeZoneOffset: 0
            }) : t.setUnixTime(e).getString()
        },
        getTimeKeeper: function() {
            return FF.env.isWWRegion() ? new i({
                format: "%h:%I %M/%D",
                months: "1 2 3 4 5 6 7 8 9 10 11 12".split(" ")
            }) : new i({
                format: "%Y年%M月%D日%h時%I分",
                months: "1 2 3 4 5 6 7 8 9 10 11 12".split(" ")
            })
        }
    })
}), define("scenes/login_bonus/LoginBonusScene", ["underscore", "jquery", "backbone", "scenes/login_bonus/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            FF.SoundMgr.playDefaultBgm();
            var n = t.Deferred();
            return r.loginBonusReceiveDeferred().done(function(r) {
                FF.datastore.stash.canReceiveLoginBonus = !1, e.each(r.received_login_bonus, function(e) {
                    FF.datastore.stash.giftBoxNum += e.current_prize_items.length
                }), t(document).trigger("updateBadge"), n.resolve(r)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    received_login_bonus: t.received_login_bonus,
                    directly_received_login_bonus: t.directly_received_login_bonus
                }), e.layoutView.render()
            }, function(e) {
                FF.router.goBootstrapNextScene()
            })
        }
    })
}), define("scenes/fellow_bonus/Api", ["scenes/common/util/Api"], function(e) {
    return _.extend({}, e, {
        fellowBonusReceiveDeferred: function() {
            return this.requestDeferred("/dff/relation/receive_fellow_bonus", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/fellow_bonus/views/Layout", ["jquery", "lib/LayoutBase", "templates/fellow_bonus/FellowBonus"], function(e, t, n) {
    return t.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-fellow-bonus-received]": "onFellowBonusReceivedClick"
        },
        initialize: function(e) {
            t.prototype.initialize.call(this), this.takenNum = e.takenNum, this.bonusGil = e.bonusGil
        },
        render: function() {
            var e = {
                takenNum: this.takenNum,
                bonusGil: this.bonusGil
            };
            t.prototype.render.call(this, n, e), this.processAfterRender()
        },
        onFellowBonusReceivedClick: function() {
            FF.router.loading.lock(), FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/fellow_bonus/FellowBonusScene", ["jquery", "scenes/fellow_bonus/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r) {
    return n.extend({
        setupDeferred: function() {
            var n = e.Deferred();
            return t.fellowBonusReceiveDeferred().done(function(t) {
                FF.datastore.stash.canReceiveFellowBonus = !1, FF.datastore.stash.giftBoxNum += t.user_gift_box_num, e(document).trigger("updateBadge"), n.resolve(t)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new r({
                    takenNum: t.taken_num,
                    bonusGil: t.bonus_gil
                }), e.layoutView.render()
            }, function(e) {
                FF.router.goBootstrapNextScene()
            })
        }
    })
}), define("scenes/serial_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/serial_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            this.end(), n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/serial_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-serial-code-apply]": "onClickSerialCodeApply",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.title = e.title, this.id = e.id, this.is_already_applied = e.is_already_applied, this.is_open = e.is_open, this.opened_at = e.opened_at, this.closed_at = e.closed_at, this.defVal = void 0
        },
        render: function() {
            var e = this;
            this.generateComponents();
            var t = {
                title: this.title,
                id: this.id,
                is_already_applied: this.is_already_applied,
                is_open: this.is_open,
                opened_at: this.timeKeeper.setUnixTime(this.opened_at).getString(),
                closed_at: this.timeKeeper.setUnixTime(this.closed_at).getString()
            };
            require(["templates/serial_campaign/" + this.id], function(n) {
                s.prototype.render.call(e, n, t), e.processAfterRender(), e.setupComponents(), e.generateUsersInputView()
            })
        },
        generateComponents: function() {
            this.timeKeeper = new u({
                preset: {
                    language: "jp",
                    format: "YYYYMMDDHHII"
                }
            })
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-serial-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickSerialCodeApply: function() {
            FF.router.loading.lock();
            var n = this,
                s = new i;
            FF.router.overlay.registerChildren(s);
            var o = t("[name=serialCode]").val();
            if (o === t("[name=serialCode]").attr("data-app-default-value")) {
                s.render({
                    isSuccess: !1
                }), s.open();
                return
            }
            r.serialCampaignApplyDeferred(this.id, o).done(function(t) {
                s.render({
                    isSuccess: !0
                }), s.open();
                var r = e.find(FF.datastore.stash.serialCampaigns, function(e) {
                    return e.id === n.id
                });
                r.can_apply = !1
            }).fail(function(e) {
                s.render({
                    isSuccess: !1,
                    error: e.error
                }), s.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            this.lockScreenBeforeGoExternalLink(), this.openUrl(n)
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/serial_campaign/SerialCampaignScene", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.serialCampaignGetDataDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(e) {
                t.layoutView = new s({
                    title: e.title,
                    id: e.id,
                    is_already_applied: e.is_already_applied,
                    is_open: e.is_open,
                    opened_at: e.opened_at,
                    closed_at: e.closed_at
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/serial_outside/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        serialCodeGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/serial_code_outside/show", {
                id: e
            })
        }
    })
}), define("scenes/serial_outside/views/Layout", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "lib/LayoutBase", "scenes/common/views/UsersInputView", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this), this.serialMap = e.serialMap, this.id = e.id
        },
        render: function() {
            var e = this;
            require(["templates/serial_outside/" + e.id], function(t) {
                var n = {
                    serialMap: e.serialMap
                };
                i.prototype.render.call(e, t, n), e.setupComponents(), e.processAfterRender()
            })
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickBack: function() {
            n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/serial_outside/SerialOutsideScene", ["underscore", "jquery", "backbone", "scenes/serial_outside/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.serialCodeGetDataDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(n) {
                t.layoutView = new s({
                    serialMap: n.serial_map,
                    id: e
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/external_collabo/views/ModalReceiveConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase"], function(e, t, n, r) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            this.url = e.url, this.urlAndroid = e.urlAndroid, this.installed = e.installed, this.id = e.id
        },
        render: function() {
            var e = this;
            require(["templates/common/external_collabo/" + e.id + "_conf"], function(t) {
                var n = {
                    url: e.url,
                    installed: e.installed
                };
                e.renderContent(t, n)
            })
        },
        onClickExternalLink: function() {
            var e = this;
            kickmotor.platform.canOpenExternalURL(e.url, function(t) {
                t.canOpen ? FF.env.isAndroid() && e.installed ? kickmotor.nativefn.openURLScheme(e.url) : kickmotor.platform.openExternalURL(e.url) : e.trigger("openConfirm")
            })
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/external_collabo/views/Layout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "scenes/common/views/UsersInputView", "components/FreeScroll", "components/Scrollbar", "scenes/common/helper/ExternalCollaboPrize", "components/Tab", "./ModalReceiveConfirm"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-receive]": "onClickReceiveConfirm",
            "anchorsbeforejump [data-app-external]": "onClickExternalLink"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this), this.isExternalOpened = e.isExternalOpened, this.achievedExternalConditionsMap = e.achievedExternalConditionsMap, this.internalPrizeMap = e.internalPrizeMap, this.iosUrl = e.iosUrl, this.androidUrl = e.androidUrl, this.urlSchemeIos = e.urlSchemeIos, this.urlSchemeAndroid = e.urlSchemeAndroid, this.id = e.id
        },
        render: function() {
            var e = this;
            require(["templates/external_collabo/" + e.id], function(t) {
                var n = {
                    isExternalOpened: e.isExternalOpened,
                    achievedExternalConditionsMap: e.achievedExternalConditionsMap,
                    internalPrizeMap: e.internalPrizeMap,
                    urlSchemeIos: e.urlSchemeIos,
                    urlSchemeAndroid: e.urlSchemeAndroid,
                    util: r
                };
                a.receiveAndOpenModalIfNeededDeferred(!1), i.prototype.render.call(e, t, n), e.setupComponents(), e.processAfterRender()
            })
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            });
            var e = t('[data-ui-group="tab"]');
            e && (this.panes = t('[data-ui-group="pane"]'), this.tab = new f({
                tabs: e,
                panes: this.panes,
                className: "is-current",
                defaultPage: 0
            }), this.tabOnChangedState(), this.listenTo(this.tab, "changedState", this.tabOnChangedState))
        },
        tabOnChangedState: function() {
            e.each(this.panes, function(e) {
                var n = t(e);
                n.hasClass("is-current") ? n.removeClass("di-n") : n.addClass("di-n")
            }), this.freescroll.reset(), this.freescroll.updateContent(), this.scrollbar.updateContentWithScrollReset()
        },
        onClickReceiveConfirm: function() {
            var e = this,
                t = e.urlSchemeIos;
            kickmotor.platform.canOpenExternalURL(e.urlSchemeIos, function(n) {
                if (n.canOpen) e.installed = !0;
                else {
                    e.installed = !1;
                    var r = kickmotor.nativefn.getNativeOS();
                    if (FF.env.isIOS()) t = e.iosUrl;
                    else {
                        if (!FF.env.isAndroid()) throw new Error("Unrecognized OS");
                        t = e.androidUrl
                    }
                }
                var i = new l({
                    installed: e.installed,
                    url: t,
                    urlAndroid: e.urlSchemeAndroid,
                    id: e.id
                });
                i.render(), FF.router.overlay.registerChildren(i), i.open(), e.listenToOnce(i, "openConfirm", function() {
                    i.onClickModalClose(), e.onClickReceiveConfirm()
                })
            })
        },
        onClickExternalLink: function(e) {
            var n = t(e.target).attr("data-app-external");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        onClickBack: function() {
            history.back()
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/external_collabo/ExternalCollabo", ["underscore", "jquery", "backbone", "scenes/external_collabo/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.showPrizeListDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(n) {
                t.layoutView = new s({
                    isExternalOpened: n.is_external_opened,
                    achievedExternalConditionsMap: n.achieved_external_conditions_map,
                    internalPrizeMap: n.internal_prize_map,
                    urlSchemeIos: n.url_scheme_ios,
                    urlSchemeAndroid: n.url_scheme_android,
                    androidUrl: n.android_url,
                    iosUrl: n.ios_url,
                    id: e
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/watchward_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        watchwardCampaignGetDataDeferred: function(e) {
            return this.requestDeferred("/dff/watchward_campaign/show", {
                id: e
            })
        },
        watchwardCampaignApplyDeferred: function(e, t) {
            return this.requestDeferred("/dff/watchward_campaign/apply", {
                id: e,
                code: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/watchward_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/watchward_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/watchward_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/watchward_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "templates/watchward_campaign/WatchwardCampaign", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-watchward-code-apply]": "onClickWatchwardCodeApply"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.watchwardCampaign = e.watchwardCampaign
        },
        render: function() {
            s.prototype.render.call(this, u, {
                watchwardCampaign: this.watchwardCampaign
            }), this.processAfterRender(), this.setupComponents(), this.generateUsersInputView()
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-watchward-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.modal = new i, FF.router.overlay.registerChildren(this.modal)
        },
        onClickWatchwardCodeApply: function() {
            FF.router.loading.lock();
            var e = this,
                n = this.modal,
                i = t("[name=watchwardCode]").val();
            if (i === t("[name=watchwardCode]").attr("data-app-default-value")) {
                n.render({
                    isSuccess: !1
                }), n.open();
                return
            }
            r.watchwardCampaignApplyDeferred(this.watchwardCampaign.id, i).done(function(e) {
                n.render({
                    isSuccess: !0
                }), n.open()
            }).fail(function(e) {
                n.render({
                    isSuccess: !1,
                    error: e.error
                }), n.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.modal && this.modal.end(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/watchward_campaign/WatchwardCampaignScene", ["underscore", "jquery", "backbone", "scenes/watchward_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.watchwardCampaignGetDataDeferred(e).done(function(e) {
                i.resolve(e)
            }), i.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(e).then(function(e) {
                t.layoutView = new s({
                    watchwardCampaign: e.watchward_campaign
                }), t.layoutView.render()
            })
        }
    })
}), define("scenes/sq_portal_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        sqPortalCampaignGetDataDeferred: function() {
            return this.requestDeferred("/dff/sq_portal_serial_campaign/show", {})
        },
        sqPortalCampaignApplyDeferred: function(e) {
            return this.requestDeferred("/dff/sq_portal_serial_campaign/apply", {
                code: e
            }, {
                type: "POST"
            })
        },
        sqPortalCampaignLogDeferred: function() {
            var t = e.Deferred();
            return this.requestDeferred("/dff/sq_portal_serial_campaign/log", {})
        }
    })
}), define("scenes/sq_portal_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/sq_portal_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/sq_portal_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/sq_portal_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "templates/sq_portal_campaign/SqPortalCampaign", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-sq-portal-code-apply]": "onClickSqPortalCodeApply",
            "anchorsbeforejump [data-app-go-log]": "onClickGoLog",
            "anchorsbeforejump [data-app-go-portal]": "onClickPortal"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.sqPortalCampaign = e.sqPortalCampaign
        },
        render: function() {
            s.prototype.render.call(this, u, {
                sqPortalCampaign: this.sqPortalCampaign
            }), this.processAfterRender(), this.setupComponents(), this.generateUsersInputView()
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-sq-portal-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.modal = new i, FF.router.overlay.registerChildren(this.modal)
        },
        onClickSqPortalCodeApply: function() {
            FF.router.loading.lock();
            var e = this,
                n = this.modal,
                i = t("[name=sqPortalCode]").val();
            if (i === t("[name=sqPortalCode]").attr("data-app-default-value")) {
                n.render({
                    isSuccess: !1
                }), n.open();
                return
            }
            r.sqPortalCampaignApplyDeferred(i).done(function(t) {
                e.usersInputView.clearInput(), n.render({
                    isSuccess: !0
                }), n.open()
            }).fail(function(e) {
                n.render({
                    isSuccess: !1,
                    error: e.error
                }), n.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickGoLog: function() {
            n.history.navigate("sq_portal_campaign_log", {
                trigger: !0
            })
        },
        onClickPortal: function() {
            var e = FF.env.isAndroid() ? FF.CONST.CLIENT.FF_PORTAL_URL.ANDROID : FF.CONST.CLIENT.FF_PORTAL_URL.IOS;
            kickmotor.platform.canOpenExternalURL(e.LAUNCH_URL, function(t) {
                t.canOpen ? kickmotor.platform.openExternalURL(e.LAUNCH_URL) : kickmotor.platform.openExternalURL(e.STORE_URL)
            })
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.modal && this.modal.end(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/sq_portal_campaign/SqPortalCampaignScene", ["underscore", "jquery", "backbone", "scenes/sq_portal_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.sqPortalCampaignGetDataDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    sqPortalCampaign: t.sq_portal_serial_campaign
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/sq_portal_campaign_log/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/sq_portal_campaign_log/SqPortalCampaignLog", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            r.prototype.initialize.call(this), this.data = e.data
        },
        render: function() {
            r.prototype.render.call(this, i, this.data), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("sq_portal_campaign", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/sq_portal_campaign_log/SqPortalCampaignLogScene", ["underscore", "jquery", "backbone", "scenes/sq_portal_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.sqPortalCampaignLogDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    data: t
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/emsaga_campaign/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        emsagaCampaignGetDataDeferred: function() {
            return this.requestDeferred("/dff/emsaga_serial_campaign/show", {})
        },
        emsagaCampaignApplyDeferred: function(e) {
            return this.requestDeferred("/dff/emsaga_serial_campaign/apply", {
                code: e
            }, {
                type: "POST"
            })
        },
        emsagaCampaignLogDeferred: function() {
            var t = e.Deferred();
            return this.requestDeferred("/dff/emsaga_serial_campaign/log", {})
        }
    })
}), define("scenes/emsaga_campaign/views/ModalResult", ["underscore", "jquery", "backbone", "scenes/serial_campaign/Api", "templates/emsaga_campaign/ModalResult", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-apply-done]": "onClickApplyDone"
        },
        render: function(e) {
            this.renderContent(i, {
                error: e.error,
                isSuccess: e.isSuccess
            })
        },
        onClickApplyDone: function() {
            n.history.navigate("#gift_box", {
                trigger: !0
            })
        },
        onClickModalClose: function() {
            this.close()
        }
    })
}), define("scenes/emsaga_campaign/views/Layout", ["underscore", "jquery", "backbone", "scenes/emsaga_campaign/Api", "./ModalResult", "lib/LayoutBase", "scenes/common/views/UsersInputView", "templates/emsaga_campaign/EmsagaCampaign", "components/TimeKeeper", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return s.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-emsaga-code-apply]": "onClickEmsagaCodeApply",
            "anchorsbeforejump [data-app-go-log]": "onClickGoLog"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this), this.emsagaCampaign = e.emsagaCampaign
        },
        render: function() {
            s.prototype.render.call(this, u, {
                emsagaCampaign: this.emsagaCampaign
            }), this.processAfterRender(), this.setupComponents(), this.generateUsersInputView()
        },
        generateUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t("[data-app-emsaga-code-apply]")
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this.onClickActualBack)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.modal = new i, FF.router.overlay.registerChildren(this.modal)
        },
        onClickEmsagaCodeApply: function() {
            FF.router.loading.lock();
            var e = this,
                n = this.modal,
                i = t("[name=emsagaCode]").val();
            if (i === t("[name=emsagaCode]").attr("data-app-default-value")) {
                n.render({
                    isSuccess: !1
                }), n.open();
                return
            }
            r.emsagaCampaignApplyDeferred(i).done(function(t) {
                e.usersInputView.clearInput(), n.render({
                    isSuccess: !0
                }), n.open()
            }).fail(function(e) {
                n.render({
                    isSuccess: !1,
                    error: e.error
                }), n.open()
            }), this.usersInputView.onClickSubmitButton()
        },
        onClickBack: function() {
            this.trigger("onClickBackKey")
        },
        onClickGoLog: function() {
            n.history.navigate("emsaga_campaign_log", {
                trigger: !0
            })
        },
        onClickActualBack: function() {
            n.history.navigate("serial_code", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.modal && this.modal.end(), this.usersInputView && this.usersInputView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/emsaga_campaign/EmsagaCampaignScene", ["underscore", "jquery", "backbone", "scenes/emsaga_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.emsagaCampaignGetDataDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    emsagaCampaign: t.emsaga_serial_campaign
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/emsaga_campaign_log/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/emsaga_campaign_log/EmsagaCampaignLog", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            r.prototype.initialize.call(this), this.data = e.data
        },
        render: function() {
            r.prototype.render.call(this, i, this.data), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("emsaga_campaign", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/emsaga_campaign_log/EmsagaCampaignLogScene", ["underscore", "jquery", "backbone", "scenes/emsaga_campaign/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.emsagaCampaignLogDeferred().done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(function(t) {
                e.layoutView = new s({
                    data: t
                }), e.layoutView.render()
            })
        }
    })
}), define("scenes/information/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "templates/information/Information", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    var f = "https://ffrkstrategy.gamematome.jp/game/951/wiki/Home",
        l = "https://dena.com/legal/PP.html";
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-twitter]": "openTwitter",
            "anchorsbeforejump [data-app-open-wiki]": "openWiki",
            "anchorsbeforejump [data-app-open-copyright]": "openCopyright",
            "anchorsbeforejump [data-app-open-staff-roll]": "openStaffRoll",
            "anchorsbeforejump [data-app-open-policy]": "openPrivacyPolicy",
            "anchorsbeforejump [data-app-open-logout]": "openLogout"
        },
        render: function() {
            s.prototype.render.call(this, o, {
                isWWRegion: FF.env.isWWRegion()
            }), this.setupComponents(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.startUpSlideInAnimation()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openCopyright: function() {
            n.history.navigate("#copyright", {
                trigger: !0
            })
        },
        openStaffRoll: function() {
            n.history.navigate("#staff_roll", {
                trigger: !0
            })
        },
        openLogout: function() {
            n.history.navigate("#mobage_logout", {
                trigger: !0
            })
        },
        openTwitter: function() {
            var e = FF.Config.server.externalUrls.twitter;
            this.openUrl(e)
        },
        openWiki: function() {
            this.lockScreenBeforeGoExternalLink();
            var e = FF.env.getLanguage();
            e == "es" ? url = "https://ffrkstrategy-es.gamematome.jp/game/953/wiki/" : e == "fr" ? url = "https://ffrkstrategy-fr.gamematome.jp/game/952/wiki/" : url = "https://ffrkstrategy.gamematome.jp/game/951/wiki/", this.openUrl(url)
        },
        openPrivacyPolicy: function() {
            this.lockScreenBeforeGoExternalLink();
            var e = l;
            this.openUrl(e)
        },
        openUrl: function(e) {
            i.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                i.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            n.history.navigate("global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/information/InformationScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout"], function(e, t, n, r, i) {
    return r.extend({
        start: function() {
            this.layoutView = new i, this.layoutView.render(), FF.SoundMgr.playMusic("bgm_09_040")
        }
    })
}), define("scenes/notification/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "./ModalNotification", "templates/notification/Notification"], function(e, t, n, r, i, s) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        render: function() {
            var e = this;
            r.prototype.render.call(this, s);
            var t = new i({});
            FF.router.overlay.registerChildren(t), t.checkedAllDeferred().done(function() {
                t.render(), t.open(), e.listenToOnce(t, "onClickClose", e.onClickClose), e.listenToOnce(t, "modalNotificationClose", e.onClickClose), e.listenToOnce(t, "openAnimationEnd", function() {
                    t.scrollbar.updateContent()
                })
            })
        },
        onClickClose: function() {
            this.trigger("onClickClose")
        },
        dispose: function() {
            this.modalNotification && this.modalNotification.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/notification/NotificationScene", ["underscore", "jquery", "backbone", "scenes/notification/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function() {
            FF.SoundMgr.playDefaultBgm(), this.layoutView = new s, this.layoutView.render(), this.listenToOnce(this.layoutView, "onClickClose", this.goNextScene)
        },
        goNextScene: function() {
            FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/help/Helper", ["underscore", "jquery", "backbone", "util", "scenes/global_menu/Api"], function(e, t, n, r, i) {
    return {
        setupDeferred: function(n) {
            var r = t.Deferred();
            return e.has(FF.datastore.stash, "help") || (FF.datastore.stash.help = {}), e.has(FF.datastore.stash.help, n) ? r.resolve().promise() : (i.helpGetDataDeferred(n).done(function(e) {
                return FF.datastore.stash.help[n] = e, r.resolve()
            }), r.promise())
        }
    }
}), define("scenes/help/views/HelpLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/HelpLayout"], function(e, t, n, r, i) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        render: function(e) {
            r.prototype.render.call(this, i, e), this.offBackEvent(), FF.router.loading.unlock()
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/help/views/LargeCategoryLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/LargeCategoryLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-help-info]": "onSelectCategory",
            "anchorsbeforejump [data-app-tutorial-help-info]": "onSelectTutorialCategory",
            "anchorsbeforejump [data-app-help-for-beginners]": "onSelectBeginnersHelp",
            "anchorsbeforejump [data-app-legal]": "onTouchLegalButton"
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="type"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="type"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        show: function() {
            r.prototype.show.call(this), t("#largeCategoryBackBtn").attr("data-app-btn-back", ""), this.onBackEvent()
        },
        hide: function() {
            r.prototype.hide.call(this), t("#largeCategoryBackBtn").removeAttr("data-app-btn-back")
        },
        onClickBack: function() {
            window.history.back()
        },
        onSelectCategory: function(e) {
            FF.router.loading.lock();
            var t = JSON.parse(e.currentTarget.getAttribute("data-app-help-info"));
            this.offBackEvent(), this.trigger("onSelectCategory", t)
        },
        onSelectTutorialCategory: function() {
            FF.router.loading.lock(), this.offBackEvent(), this.trigger("onSelectTutorialCategory")
        },
        onSelectBeginnersHelp: function() {
            n.history.navigate("/beginners_help/", {
                trigger: !0
            })
        },
        onTouchLegalButton: function() {
            this.openUrl("https:/dena.com/legal")
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/views/MiddleCategoryLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/MiddleCategoryLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-help-info]": "onSelectDetail"
        },
        initialize: function(e) {
            this.type = e.type, r.prototype.initialize.call(this)
        },
        render: function(e) {
            e.type = this.type, r.prototype.render.call(this, i, e), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="category"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="category"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        show: function() {
            r.prototype.show.call(this), t("#middleCategoryBackBtn").attr("data-app-btn-back", ""), this.onBackEvent()
        },
        hide: function() {
            r.prototype.hide.call(this), t("#middleCategoryBackBtn").removeAttr("data-app-btn-back")
        },
        onSelectDetail: function(e) {
            FF.router.loading.lock();
            var t = JSON.parse(e.currentTarget.getAttribute("data-app-help-info"));
            this.offBackEvent(), this.trigger("onSelectDetail", t)
        },
        onClickBack: function() {
            this.offBackEvent(), this.dispose()
        },
        dispose: function() {
            this.trigger("onCloseCategory"), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/views/ContentLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/help/ContentLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            this.type = e.type, this.categoryId = e.categoryId, r.prototype.initialize.call(this)
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.generateComponents(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            this.offBackEvent(), this.dispose()
        },
        dispose: function() {
            this.trigger("onCloseDetail"), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/views/TutorialCategoryLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/tutorial/common/ModalIllust", "scenes/tutorial/common/ModalIllustMulti", "templates/help/HelpTutorialCategory", "util", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-tutorial-help-info]": "onSelectDetail"
        },
        initialize: function() {
            r.prototype.initialize.call(this)
        },
        render: function() {
            r.prototype.render.call(this, o, {
                hasUnlockedRelation: FF.datastore.userModel.hasProceededFuncTutorial("FELLOW"),
                hasUnclockedExp: FF.datastore.userModel.hasProceededFuncTutorial("SS_EXP"),
                hasUnclockedSsMulti: FF.datastore.userModel.hasProceededFuncTutorial("SS_MULTI"),
                hasUnclockedSsMultiAndExp: FF.datastore.userModel.hasProceededFuncTutorial("SS_MULTI_AND_EXP"),
                hasUnclockedHammering: FF.datastore.userModel.hasProceededFuncTutorial("HAMMERING"),
                hasUnlockedDressRecord: FF.datastore.userModel.hasProceededFuncTutorial("DRESS_RECORD"),
                hasUnlockedMission: FF.datastore.userModel.hasProceededFuncTutorial("MISSION")
            }), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new a({
                el: t('[data-ui-freescroll="category"]')
            }), this.scrollbar = new f({
                el: t('[data-ui-scrollbar="category"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onSelectDetail: function(e) {
            FF.router.loading.lock();
            var n = t(e.target).attr("data-app-tutorial-help-info").split(",");
            n.length >= 2 ? this._showTutorialIllustMulti(e, n) : this._showTutorialIllustSingle(n)
        },
        _showTutorialIllustSingle: function(e) {
            var t = new i(e);
            t.render(), FF.router.overlay.registerChildren(t), t.openAfterImageLoad()
        },
        _showTutorialIllustMulti: function(e, n) {
            var r = n.length,
                i = t(e.target).attr("data-app-tutorial-speaker"),
                o = new s(n, r, i);
            o.render(), FF.router.overlay.registerChildren(o), o.openAfterImageLoad()
        },
        onClickBack: function() {
            this.offBackEvent(), this.dispose()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.trigger("onCloseTutorialCategory"), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/help/HelpScene", ["underscore", "jquery", "backbone", "scenes/global_menu/Api", "lib/Scene", "./Helper", "./views/HelpLayout", "./views/LargeCategoryLayout", "./views/MiddleCategoryLayout", "./views/ContentLayout", "./views/TutorialCategoryLayout"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        setupDeferred: function(e) {
            return s.setupDeferred(e)
        },
        start: function(e, n, r) {
            var i = this;
            this.helpLayoutView = new o, this.helpLayoutView.render(), FF.SoundMgr.playMusic("bgm_09_040"), this.setupDeferred(e).done(function() {
                var n = FF.datastore.stash.help[e];
                i.largeCategoryLayoutView = new u({
                    el: t("#helpType")
                }), i.largeCategoryLayoutView.render({
                    type: e,
                    categories: n.help_categories
                }), i.listenTo(i.largeCategoryLayoutView, "onSelectCategory", i.renderCategory), i.listenTo(i.largeCategoryLayoutView, "onSelectTutorialCategory", i.renderTutorialCategory), FF.router.loading.hide()
            })
        },
        renderCategory: function(n) {
            var r = this,
                i = n.type,
                s = n.categoryId;
            this.setupDeferred(i).done(function() {
                var n = FF.datastore.stash.help[i],
                    o = e.find(n.help_categories, function(e) {
                        return +e.id === +s
                    });
                r.middleCategoryLayoutView = new a({
                    el: t("#helpCategory"),
                    type: i
                }), r.middleCategoryLayoutView.render({
                    category: o
                }), r.largeCategoryLayoutView.hide(), r.listenTo(r.middleCategoryLayoutView, "onSelectDetail", r.renderDetail), r.listenTo(r.middleCategoryLayoutView, "onCloseCategory", r.largeCategoryLayoutView.show.bind(r.largeCategoryLayoutView))
            })
        },
        renderTutorialCategory: function() {
            this.tutorialCategoryLayoutView = new l({
                el: t("#helpTutorialCategory")
            }), this.tutorialCategoryLayoutView.render(), this.largeCategoryLayoutView.hide(), this.listenTo(this.tutorialCategoryLayoutView, "onCloseTutorialCategory", this.largeCategoryLayoutView.show.bind(this.largeCategoryLayoutView))
        },
        renderDetail: function(n) {
            var r = this,
                i = n.type,
                s = n.categoryId,
                o = n.helpId;
            this.setupDeferred(i).done(function() {
                var n = FF.datastore.stash.help[i],
                    u = e.find(n.help_categories, function(e) {
                        return +e.id === +s
                    }),
                    a = e.find(u.help_contents, function(e) {
                        return +e.id === +o
                    });
                r.contentLayoutView = new f({
                    el: t("#helpDetail"),
                    type: i,
                    categoryId: s
                }), r.contentLayoutView.render({
                    category: u,
                    content: a
                }), r.middleCategoryLayoutView.hide(), r.listenTo(r.contentLayoutView, "onCloseDetail", r.middleCategoryLayoutView.show.bind(r.middleCategoryLayoutView))
            })
        },
        dispose: function() {
            this.helpLayoutView && this.helpLayoutView.dispose(), this.categoryLayoutView && this.categoryLayoutView.dispose(), this.tutorialCategoryLayoutView && this.tutorialCategoryLayoutView.dispose(), this.detailLayoutView && this.detailLayoutView.dispose(), i.prototype.dispose.apply(this)
        }
    })
}), define("scenes/beginnersHelp/views/BeginnersHelpLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/beginnersHelp/BeginnersHelpLayout"], function(e, t, n, r, i) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-back]": "onClickBack"
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.offBackEvent(), FF.router.loading.unlock()
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/beginnersHelp/views/BeginnersHelpListLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/beginnersHelp/BeginnersHelpListLayout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-beginners-help-page-id]": "onSelectBeginnersHelpItem"
        },
        render: function(e) {
            r.prototype.render.call(this, i, e), this.generateComponents(), this.startUpSlideInAnimation(), this.processAfterRender()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t('[data-ui-freescroll="list"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="list"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onSelectBeginnersHelpItem: function(e) {
            var r = t(e.target).attr("data-app-beginners-help-page-id");
            n.history.navigate("/beginners_help/" + r, {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/beginnersHelp/views/BeginnersHelpDetailLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            this.pageId = e.pageId
        },
        events: {
            "anchorsbeforejump [data-app-link-to]": "onClickContentsLink",
            "anchorsbeforejump [data-app-jump-to-wday-event]": "onClickJumpToWdayEvent"
        },
        render: function(e) {
            var t = this;
            require(["templates/beginnersHelp/pages/" + this.pageId], function(n) {
                r.prototype.render.call(t, n, e), t.processAfterRender()
            })
        },
        onClickContentsLink: function(e) {
            var r = t(e.target).attr("data-app-link-to");
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickJumpToWdayEvent: function(e) {
            var t = FF.datastore.worldCollection.getDuringWdayEventWorldModel();
            if (!t) throw new Error("wday event has not been held");
            n.history.navigate(t.getDungeonListFragment(), {
                trigger: !0
            })
        },
        dispose: function() {
            r.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/beginnersHelp/BeginnersHelpScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/BeginnersHelpLayout", "./views/BeginnersHelpListLayout", "./views/BeginnersHelpDetailLayout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        start: function(e) {
            var n = this;
            this.helpLayoutView = new s, this.helpLayoutView.render(), FF.SoundMgr.playMusic("bgm_09_040"), e ? (this.detailLayoutView = new u({
                el: t("[data-app-beginners-help-detail]"),
                pageId: e
            }), this.detailLayoutView.render()) : (this.listLayoutView = new o({
                el: t("[data-app-beginners-help-list]")
            }), this.listLayoutView.render())
        },
        dispose: function() {
            this.helpLayoutView && this.helpLayoutView.dispose(), this.listLayoutView && this.listLayoutView.dispose(), this.detailLayoutView && this.detailLayoutView.dispose(), i.prototype.dispose.apply(this)
        }
    })
}), define("scenes/config/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/BattleConfig", "templates/config/Config", "components/Button", "components/Fluctuator", "components/MonoSelector", "components/FreeScroll", "components/Scrollbar", "lib/AnimationCut", "kickmotor"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = FF.env.isAndroid2_x(),
        d = i.getSkipOrderCandidates(),
        v = {
            ATB: "0",
            NO: "1"
        },
        m = {};
    m[d.ATB] = v.ATB, m[d.NO] = v.NO;
    var g = {};
    g[v.ATB] = d.ATB, g[v.NO] = d.NO;
    var y = ["en", "fr", "es"];
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        beforeLang: "en",
        events: {
            "anchorsbeforejump [data-app-push-notify]": "changeNotifyStatus",
            "anchorsbeforejump [data-app-push-skip]": "changeSkipStatus",
            "anchorsbeforejump [data-app-push-auto]": "changeAutoStatus",
            "change #languageChoice": "onChangeLanguage",
            "anchorsbeforejump [data-app-animation-cut]": "changeAnimationCut"
        },
        initialize: function() {
            r.prototype.initialize.apply(this, arguments), this._initializeVariables()
        },
        _initializeVariables: function() {
            this.battleConfig = null
        },
        render: function() {
            var n = {
                isWWLayout: FF.env.isWWRegion(),
                canChangeLanguage: FF.env.isWWRegion()
            };
            r.prototype.render.call(this, s, n), this.processAfterRender(), h.platform.getRemoteNotificationsEnabled(function(e) {
                var n = e.enabled ? "true" : "false";
                t('[data-app-push-notify="' + n + '"]').addClass("is-current")
            }), t('[data-app-animation-cut="' + c.isDisabled() + '"]').addClass("is-current"), h.sound.getBackgroundMusicVolume(function(e) {
                if (e.volume !== undefined) {
                    var n = t("[data-app-gauge-bgm]"),
                        r = "data-app-vol";
                    p ? n.css({
                        "-webkit-transition-duration": "0"
                    }).attr(r, e.volume) : n.css({
                        "-webkit-transition-duration": "0.01s"
                    }).attr(r, e.volume).one("webkitTransitionEnd", function() {
                        n.css({
                            "-webkit-transition-duration": "0.3s"
                        })
                    });
                    var i = e.volume * 10;
                    this.bgmDecrease = new o({
                        el: t("[data-app-bgm-decrease]"),
                        message: -2
                    }), this.bgmIncrease = new o({
                        el: t("[data-app-bgm-increase]"),
                        message: 2
                    }), this.bgmVolume = new u({
                        el: t("[data-app-bgm-volume]"),
                        max: 10,
                        increase: this.bgmIncrease,
                        decrease: this.bgmDecrease,
                        current: i
                    }), this.listenTo(this.bgmVolume, "valueChanged", function(e) {
                        var t = e.value / 10;
                        n.attr(r, t), h.sound.setBackgroundMusicVolume(t)
                    }.bind(this))
                }
            }.bind(this)), h.sound.getEffectsVolume(function(e) {
                if (e.volume !== undefined) {
                    var n = t("[data-app-gauge-se]"),
                        r = "data-app-vol";
                    p ? n.css({
                        "-webkit-transition-duration": "0"
                    }).attr(r, e.volume) : n.css({
                        "-webkit-transition-duration": "0.01s"
                    }).attr(r, e.volume).one("webkitTransitionEnd", function() {
                        n.css({
                            "-webkit-transition-duration": "0.3s"
                        })
                    });
                    var i = e.volume * 10;
                    this.seDecrease = new o({
                        el: t("[data-app-se-decrease]"),
                        message: -2
                    }), this.seIncrease = new o({
                        el: t("[data-app-se-increase]"),
                        message: 2
                    }), this.seVolume = new u({
                        el: t("[data-app-se-volume]"),
                        max: 10,
                        increase: this.seIncrease,
                        decrease: this.seDecrease,
                        current: i
                    }), this.listenTo(this.seVolume, "valueChanged", function(e) {
                        var t = e.value / 10;
                        n.attr(r, t), h.sound.setEffectsVolume(t)
                    }.bind(this))
                }
            }.bind(this)), this.setupComponents(), this.initializeBattleConf();
            if (FF.env.isWWRegion()) {
                var i = FF.env.getLanguage(),
                    a = "en";
                if (i && e.contains(y, i)) {
                    a = i, this.beforeLang = i;
                    var f = t("#languageChoice .inner"),
                        l = 0,
                        d = f.length;
                    for (; l < d; l++)
                        if (f[l].value == a) {
                            f[l].selected = !0;
                            break
                        }
                }
            }
            FF.router.loading.hide()
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        initializeBattleConf: function() {
            var e = this;
            i.loadBattleConfigDeferred().then(function(n) {
                var r = n.speed,
                    s = i.getBattleSpeedIndex(r);
                e.battleConfig = n, e.updateBattleSpeedDisplay(s), e.monoSelector = new a({
                    el: t("[data-app-ui-mono-selector]"),
                    idx: s,
                    className: "is-current",
                    useOneAsFirstIndex: !0
                }), e.listenTo(e.monoSelector, "clickMonoSelector", function(t) {
                    e.onClickMonoSelector(t)
                });
                var o = m[n.skipOrder] || v.ATB;
                t('[data-app-push-skip="' + o + '"]').addClass("is-current"), t('[data-app-text-skip="' + o + '"]').addClass("di-ib");
                var u = n.isAutoEnabledAtBattleStart;
                t('[data-app-push-auto="' + u + '"]').addClass("is-current"), t('[data-app-text-auto="' + u + '"]').addClass("di-ib")
            })
        },
        onClickMonoSelector: function(e) {
            this.battleConfig.speed = i.getBattleSpeedCandidates()[e.value], this.updateBattleSpeedDisplay(e.value), i.saveBattleConfigDeferred(this.battleConfig).then(function() {
                FF.logger.debug("saving_battle_config was completed")
            })
        },
        updateBattleSpeedDisplay: function(e) {
            t("[data-app-battle-speed-display]").text(e)
        },
        changeNotifyStatus: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-push-notify") === "true" ? !0 : !1;
            h.platform.setRemoteNotificationsEnabled(r, function() {
                t("[data-app-push-notify]").removeClass("is-current").filter('[data-app-push-notify="' + r + '"]').addClass("is-current")
            })
        },
        changeSkipStatus: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-push-skip");
            this.battleConfig.skipOrder = g[r] || d.ATB, t("[data-app-push-skip]").removeClass("is-current").filter('[data-app-push-skip="' + r + '"]').addClass("is-current"), t("[data-app-text-skip]").removeClass("di-ib").filter('[data-app-text-skip="' + r + '"]').addClass("di-ib"), i.saveBattleConfigDeferred(this.battleConfig)
        },
        changeAutoStatus: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-push-auto") === "true" ? !0 : !1;
            this.battleConfig.isAutoEnabledAtBattleStart = r, t("[data-app-push-auto]").removeClass("is-current").filter('[data-app-push-auto="' + r + '"]').addClass("is-current"), t("[data-app-text-auto]").removeClass("di-ib").filter('[data-app-text-auto="' + r + '"]').addClass("di-ib"), i.saveBattleConfigDeferred(this.battleConfig)
        },
        changeAnimationCut: function(e) {
            var n = e.originalEvent.srcElement,
                r = n.getAttribute("data-app-animation-cut") === "true" ? !0 : !1;
            c.changeDeferred(r).done(function() {
                c.apply()
            }), t("[data-app-animation-cut]").removeClass("is-current").filter('[data-app-animation-cut="' + r + '"]').addClass("is-current")
        },
        onChangeLanguage: function(t) {
            var n = t.originalEvent.srcElement,
                r = n.value;
            if (!e.contains(y, r)) {
                FF.logger.error("received event from unknown lang: " + r);
                return
            }
            h.platform.setLanguageSetting(r, function() {})
        },
        onClickBack: function() {
            this._requiresRestart() ? FF.redirect("/dff/#title") : history.back()
        },
        _requiresRestart: function() {
            return FF.env.isWWRegion() && FF.env.getLanguage() !== this.beforeLang
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.bgmDecrease && this.bgmDecrease.dispose(), this.bgmIncrease && this.bgmIncrease.dispose(), this.bgmVolume && this.bgmVolume.dispose(), this.seDecrease && this.seDecrease.dispose(), this.seIncrease && this.seIncrease.dispose(), this.seVolume && this.seVolume.dispose(), this.monoSelector && this.monoSelector.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/config/ConfigScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/html/views/Layout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return i.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        backgroundType: "GAME_TOP",
        render: function(e) {
            var t = this,
                n = "templates/html/" + e,
                s = {};
            r.validateTmplPath(n), require([n], function(e) {
                i.prototype.render.call(t, e, s), t.setupComponents(), t.processAfterRender()
            })
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/html/views/BrabraAnnouncementLayout", ["underscore", "jquery", "backbone", "util", "lib/LayoutBase", "templates/html/BrabraAnnouncement", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        backgroundType: "GAME_TOP",
        events: {
            "anchorsbeforejump [data-app-open-external-site]": "openExternalSite"
        },
        render: function(e) {
            r.validateTmplPath(e);
            var t = FF.datastore.limitedTimeServiceCollection.getHtmlSceneBgmByName(e);
            if (!t) throw new Error("undefined bgm:" + e);
            FF.SoundMgr.playMusic(t), i.prototype.render.call(this, s), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openExternalSite: function() {
            this.lockScreenBeforeGoExternalLink(), this.openUrl("http://www.square-enix.co.jp/music/sem/page/brabraff/tour/")
        },
        openUrl: function(e) {
            kickmotor.platform.canOpenExternalURL(e, function(t) {
                if (!t.canOpen) throw new Error("invalid url:" + e);
                kickmotor.platform.openExternalURL(e)
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/html/HtmlScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/Layout", "./views/BrabraAnnouncementLayout"], function(e, t, n, r, i, s, o) {
    var u = {
        COMMON: s
    };
    return u.brabra_announcement = o, i.extend({
        start: function(e) {
            var t = this._getLayoutClassByPath(e);
            this.layoutView = new t, this.layoutView.render(e)
        },
        _getLayoutClassByPath: function(e) {
            var t;
            e = e || "";
            for (var n in u) e.match(n) && (t = u[n]);
            return t || u.COMMON
        }
    })
}), define("scenes/download/views/Tips", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/Banner", "templates/download/Tips"], function(e, t, n, r, i, s) {
    var o = {
        CAROUSEL_RENDER_LOT: 1,
        COMPONENTS_WRAP_CLASS: "[data-app-carousel-components-wrap]"
    };
    return i.extend({
        initialize: function(e) {
            this.bannerCollection = e.tipDownloadCollection
        },
        render: function() {
            t(o.COMPONENTS_WRAP_CLASS).append(r.process(s, {
                bannerModels: this.bannerCollection.models,
                LOT: o.CAROUSEL_RENDER_LOT
            })), this.setupComponents()
        }
    })
}), define("scenes/download/views/ModalRetry", ["underscore", "jquery", "backbone", "templates/download/ModalRetry", "lib/ModalBase"], function(e, t, n, r, i) {
    return i.extend({
        el: "[data-app-modal]",
        render: function() {
            this.renderContent(r, {})
        }
    })
}), define("scenes/download/views/Layout", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "templates/download/Download", "lib/LayoutBase", "./Tips", "./ModalRetry"], function(e, t, n, r, i, s, o, u) {
    var a = s.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-download-tip-next]": "showNext",
            "anchorsbeforejump [data-app-download-tip-prev]": "showPrev"
        },
        initialize: function() {
            this.tipsView = new o({
                tipDownloadCollection: FF.datastore.tipDownloadCollection
            }), s.prototype.initialize.call(this)
        },
        render: function(e, t) {
            this.renderCallback = t, s.prototype.render.call(this, i, e), this.tipsView.render(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.renderCallback && this.renderCallback()
        },
        openRetryModal: function() {
            var e = this,
                t = new u;
            t.render(), FF.router.overlay.registerChildren(t), t.open(), this.listenToOnce(t, "closeAnimationEnd", function() {
                e.trigger("closeAnimationEnd")
            })
        },
        dispose: function() {
            this.tipsView && this.tipsView.dispose(), this.renderCallback = null, s.prototype.dispose.call(this)
        }
    });
    return a
}), define("scenes/download/DownloadScene", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function(e, t) {
            this.layoutOptions = e ? e : {}, this.gaugeWidth = 0, t || this.createLayoutViewDeferred(), this._start()
        },
        createLayoutViewDeferred: function() {
            var e = this;
            if (this.promised) return this.promised;
            var n = t.Deferred();
            return this.layoutView ? n.resolve().promise() : (this.layoutView = new s, this.layoutView.render({
                options: this.layoutOptions
            }, function() {
                e.promised = null, e.updateGauge(), n.resolve()
            }), this.promised = n.promise(), this.promised)
        },
        _start: function() {
            if (!FF.datastore.stash.download || e.isEmpty(FF.datastore.stash.download)) throw new Error("download info not exists.");
            FF.logger.debug("start download. bundle:", FF.datastore.stash.download.bundle), FF.env.isNative() ? this.startPrecache() : FF.router.goBootstrapNextScene()
        },
        startPrecache: function() {
            kickmotor.animation.precacheAssetsGetProgress(e.bind(this.downloadProgressCallback, this)), kickmotor.animation.precacheAssetsProgressive(FF.datastore.stash.download.bundle, e.bind(this.downloadFinishCallback, this), !0, FF.datastore.stash.download.force)
        },
        downloadProgressCallback: function(e) {
            var t = e.total_size,
                n = e.downloaded_size;
            this.gaugeWidth = n / t * 100, this.updateGauge(), FF.logger.debug("success::" + n + "/" + t)
        },
        updateGauge: function() {
            t("[data-app-download-gauge]").css("width", this.gaugeWidth + "%")
        },
        downloadFinishCallback: function(e, t) {
            e ? (FF.logger.debug("error::" + e), this.onDownloadError()) : (FF.logger.debug("download complete."), this.updateGauge(), this.goNextSceneIfNeed())
        },
        onDownloadError: function(e) {
            var t = this;
            this.createLayoutViewDeferred().then(function() {
                t.layoutView.openRetryModal(), t.listenToOnce(t.layoutView, "closeAnimationEnd", t.startPrecache.bind(t))
            })
        },
        goNextSceneIfNeed: function() {
            this.gaugeWidth = 100, FF.datastore.stash.download = FF.datastore.stash.download || {}, FF.datastore.stash.download.isBootstrapTransition ? FF.router.goBootstrapNextScene() : FF.datastore.stash.download.referer && n.history.navigate(FF.datastore.stash.download.referer, {
                trigger: !0
            })
        },
        dispose: function() {
            FF.datastore.stash.download = {}, this.layoutOptions = null, i.prototype.dispose.apply(this)
        }
    })
}), define("scenes/update_nickname/views/Confirm", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/tutorial/Api", "lib/ModalBase", "templates/tutorial/NicknameConfirm"], function(e, t, n, r, i, s, o) {
    return s.extend({
        categoryType: "home",
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickDecide"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, s.prototype.initialize.call(this)
        },
        render: function(e) {
            this.nickname = e, this.renderContent(o, {
                nickname: this.nickname
            })
        },
        onClickDecide: function() {
            var e = this,
                r = t.Deferred();
            if (this.isFiredTalkEnd) return;
            return this.isFiredTalkEnd = !0, i.nicknameUpdateDeferred(this.nickname).done(function(i) {
                FF.datastore.userModel.set(i.user), FF.datastore.userSupporterBuddyModel.set({
                    nickname: i.user.name
                }), FF.router.toast.topping(t("#toast-message-update-nickname").text()), e.onClickModalClose(), n.history.navigate("#profile", {
                    trigger: !0
                }), r.resolve()
            }).fail(function() {
                e.onClickModalClose(), e.trigger("nicknameAPIError"), e.isFiredTalkEnd = !1, r.resolve()
            }), r.promise()
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/tutorial/nickname/views/ModalNicknameError", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "templates/tutorial/ModalNicknameError"], function(e, t, n, r, i, s) {
    var o = {
        ERROR_TYPE_OF_NG_WORD: "ngWord",
        ERROR_TYPE_OF_CHARACTERS_OVER: "charactersOver"
    };
    return i.extend({
        el: "[data-app-modal]",
        render: function(e) {
            this.renderContent(s, {
                CONST: o,
                errorType: e,
                MAX_LENGTH: FF.Config.server.nickname.maxLength
            })
        }
    }, {
        getConstMap: function() {
            return o
        }
    })
}), define("scenes/update_nickname/views/Layout", ["underscore", "jquery", "scenes/common/collections/Profile", "backbone", "lib/LayoutBase", "scenes/common/views/UsersInputView", "./Confirm", "scenes/tutorial/nickname/views/ModalNicknameError", "templates/update_nickname/Nickname", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        MODAL_NICKNAME_ERROR_VIEW: u.getConstMap()
    };
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-input-attr]": "onClickBack",
            "anchorsbeforejump [data-app-nickname-register]": "onClickRegister",
            "onBackKey [data-app-input-attr]": "onClickDeviceBackKey"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, this.isClickedRegister = !1, i.prototype.initialize.call(this);
            var e = t.Deferred();
            return this._resultProfileCollection = new n, e.resolve().promise()
        },
        render: function(e) {
            this._resultProfileCollection.reset(e.target_profiles);
            var t = {
                profile: this._resultProfileCollection.models[0],
                defaultName: FF.Config.server.nickname.defaultName,
                nicknameMaxLength: FF.Config.server.nickname.maxLength
            };
            i.prototype.render.call(this, a, t), this.generateUsersInputView(), this.processAfterRender(), FF.env.isIOS7_0() && this.addEventListener7_0(), FF.env.isAndroid() && this.addEventListenerAndroid()
        },
        generateUsersInputView: function() {
            var e = this;
            this.usersInputView = new s({
                el: this.$el,
                parent: this,
                submitBtnEl: t(),
                isNickname: !0
            }), this.listenTo(this.usersInputView, "onClickBackWithoutFocus", function() {
                t("#modal").hasClass("open") && t("[data-app-modal-close]").length > 0 ? t("[data-app-modal-close]").trigger("anchorsbeforejump") : (FF.SoundMgr.playChooseEffect(), e.onClickBack())
            })
        },
        renderConfirmModal: function() {
            var e = this;
            this.confirmView && this.confirmView.dispose(), this.confirmView = new o, this.confirmView.render(this.nickname), FF.router.overlay.registerChildren(this.confirmView), this.confirmView.open();
            var n = t("[data-app-tutorial-name-edit-wrap]");
            n.hide(), this.listenToOnce(this.confirmView, "closeNotify", function() {
                n.show(), e.isFiredTalkEnd = !1, e.isClickedRegister = !1, e.nickname = null
            }), this.listenTo(this.confirmView, "nicknameAPIError", function() {
                e.listenToOnce(e.confirmView, "closeAnimationEnd", function() {
                    e.renderErrorModal(c.MODAL_NICKNAME_ERROR_VIEW.ERROR_TYPE_OF_NG_WORD), e.isFiredTalkEnd = !1, e.isClickedRegister = !1
                })
            })
        },
        renderErrorModal: function(e) {
            this.modalNicknameErrorView = new u, this.modalNicknameErrorView.render(e), FF.router.overlay.registerChildren(this.modalNicknameErrorView), this.modalNicknameErrorView.open()
        },
        addEventListener7_0: function() {
            var e = this;
            t(".c-layer-bg").on("touchstart", function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        addEventListenerAndroid: function() {
            FF.env.isUsingWWBackKeyHandler() || (kickmotor.nativefn.onBackKey = function() {
                t("[data-app-input-attr]").trigger("onBackKey")
            })
        },
        onClickRegister: function(e) {
            if (this.isFiredTalkEnd) return;
            FF.router.loading.lock();
            var n = FF.env.isIOS() ? "text" : "val",
                r = t("[data-app-input-attr]")[n]();
            this.nickname !== r && (this.nickname = r), this.nickname || (this.nickname = r ? r : FF.Config.server.nickname.defaultName);
            var i = /^[\s　]*$/,
                s = i.test(this.nickname);
            s && (this.nickname = FF.Config.server.nickname.defaultName);
            if (this.nickname.length > FF.Config.server.nickname.maxLength) {
                this.renderErrorModal(c.MODAL_NICKNAME_ERROR_VIEW.ERROR_TYPE_OF_CHARACTERS_OVER);
                return
            }
            this.isFiredTalkEnd = !0, this.isClickedRegister = !0, this.usersInputView.onClickSubmitButton(), this.renderConfirmModal()
        },
        onClickDeviceBackKey: function() {
            this.trigger("onClickBackKey")
        },
        onClickBack: function() {
            r.history.navigate("profile", {
                trigger: !0
            })
        },
        dispose: function() {
            this.wrapContent && (this.wrapContent = null), this.confirmView && this.confirmView.dispose(), this.usersInputView && this.usersInputView.dispose(), this.modalNicknameErrorView && this.modalNicknameErrorView.dispose(), FF.env.isAndroid() && FF.router.setupOnBackKey(), FF.env.isIOS7_0() && t(".c-layer-bg").off("touchstart"), t("[data-app-nickname-register]").off("touchend"), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/update_nickname/UpdateNicknameScene", ["underscore", "jquery", "backbone", "scenes/relation/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = [FF.datastore.userModel.get("id")];
            return r.findByUserIdsDeferred(e)
        },
        start: function(e) {
            var t = this;
            t.setupDeferred().then(function(e) {
                t.layoutView = new s, t.layoutView.render(e)
            })
        }
    })
}), define("scenes/configure_profile_message/views/Confirm", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/util/Api", "lib/ModalBase", "templates/configure_profile_message/ProfileMessageConfirm"], function(e, t, n, r, i, s, o) {
    return s.extend({
        categoryType: "home",
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickDecide"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, s.prototype.initialize.call(this)
        },
        render: function(e) {
            this.profile_message = e, this.renderContent(o, {
                profile_message: this.profile_message
            })
        },
        onClickDecide: function() {
            var e = this,
                r = t.Deferred();
            if (this.isFiredTalkEnd) return;
            return this.isFiredTalkEnd = !0, i.configureProfileMessageDeferred(this.profile_message).done(function(i) {
                FF.datastore.userModel.set(i.user), FF.datastore.userSupporterBuddyModel.set({
                    profile_message: e.profile_message
                }), FF.router.toast.topping(t("#toast-message-update-profile-message").text()), e.onClickModalClose(), n.history.navigate("#profile", {
                    trigger: !0
                }), r.resolve()
            }).fail(function() {
                e.onClickModalClose(), e.trigger("profileMessageAPIError"), e.isFiredTalkEnd = !1, r.resolve()
            }), r.promise()
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/configure_profile_message/views/ModalProfileMessageError", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "templates/configure_profile_message/ModalProfileMessageError"], function(e, t, n, r, i, s) {
    var o = {
        ERROR_TYPE_OF_NG_WORD: "ngWord",
        ERROR_TYPE_OF_CHARACTERS_OVER: "charactersOver"
    };
    return i.extend({
        el: "[data-app-modal]",
        render: function(e) {
            this.renderContent(s, {
                CONST: o,
                errorType: e,
                MAX_LENGTH: FF.Config.server.profileMessage.maxLength
            })
        }
    }, {
        getConstMap: function() {
            return o
        }
    })
}), define("scenes/configure_profile_message/views/Layout", ["underscore", "jquery", "scenes/common/collections/Profile", "backbone", "lib/LayoutBase", "scenes/common/views/UsersInputView", "./Confirm", "scenes/configure_profile_message/views/ModalProfileMessageError", "templates/configure_profile_message/ProfileMessage", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = {
        MODAL_PROFILE_MESSAGE_ERROR_VIEW: u.getConstMap()
    };
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "onBackKey [data-app-input-attr]": "onClickDeviceBackKey",
            "anchorsbeforejump [data-app-profile-register]": "onClickRegister",
            "anchorsbeforejump [data-app-input-attr]": "onClickBack"
        },
        initialize: function() {
            this.isFiredTalkEnd = !1, this.isClickedRegister = !1, i.prototype.initialize.call(this);
            var e = t.Deferred();
            return this._resultProfileCollection = new n, e.resolve().promise()
        },
        render: function(e) {
            this._resultProfileCollection.reset(e.target_profiles);
            var t = {
                profile: this._resultProfileCollection.models[0],
                defaultMessage: FF.Config.server.profileMessage.defaultMessage,
                profileMessageMaxLength: FF.Config.server.profileMessage.maxLength
            };
            i.prototype.render.call(this, a, t), this.generateUsersInputView(), this.processAfterRender(), FF.env.isIOS7_0() && this.addEventListener7_0(), FF.env.isAndroid() && this.addEventListenerAndroid()
        },
        generateUsersInputView: function() {
            var e = this;
            this.usersInputView = new s({
                el: this.$el,
                parent: this,
                submitBtnEl: t(),
                isNickname: !0
            }), this.listenTo(this.usersInputView, "onClickBackWithoutFocus", function() {
                t("#modal").hasClass("open") && t("[data-app-modal-close]").length > 0 ? t("[data-app-modal-close]").trigger("anchorsbeforejump") : (FF.SoundMgr.playChooseEffect(), e.onClickBack())
            })
        },
        renderConfirmModal: function() {
            var e = this;
            this.confirmView && this.confirmView.dispose(), this.confirmView = new o, this.confirmView.render(this.profileMessage), FF.router.overlay.registerChildren(this.confirmView), this.confirmView.open();
            var n = t("[data-app-tutorial-name-edit-wrap]");
            n.hide(), this.listenToOnce(this.confirmView, "closeNotify", function() {
                n.show(), e.isFiredTalkEnd = !1, e.isClickedRegister = !1, e.profileMessage = null
            }), this.listenTo(this.confirmView, "profileMessageAPIError", function() {
                e.listenToOnce(e.confirmView, "closeAnimationEnd", function() {
                    e.renderErrorModal(c.MODAL_PROFILE_MESSAGE_ERROR_VIEW.ERROR_TYPE_OF_NG_WORD), e.isFiredTalkEnd = !1, e.isClickedRegister = !1
                })
            })
        },
        renderErrorModal: function(e) {
            this.modalProfileMessageErrorView = new u, this.modalProfileMessageErrorView.render(e), FF.router.overlay.registerChildren(this.modalProfileMessageErrorView), this.modalProfileMessageErrorView.open()
        },
        addEventListener7_0: function() {
            var e = this;
            t(".c-layer-bg").on("touchstart", function(e) {
                e.preventDefault(), e.stopPropagation()
            })
        },
        addEventListenerAndroid: function() {
            FF.env.isUsingWWBackKeyHandler() || (kickmotor.nativefn.onBackKey = function() {
                t("[data-app-input-attr]").trigger("onBackKey")
            })
        },
        onClickRegister: function(e) {
            if (this.isFiredTalkEnd) return;
            FF.router.loading.lock();
            var n = FF.env.isIOS() ? "text" : "val",
                r = t("[data-app-input-attr]")[n]();
            this.profileMessage !== r && (this.profileMessage = r), this.profileMessage || (this.profileMessage = r ? r : FF.Config.server.profileMessage.defaultMessage);
            var i = /^[\s　]*$/,
                s = i.test(this.profileMessage);
            s && (this.profileMessage = FF.Config.server.profileMessage.defaultMessage);
            if (this.profileMessage.length > FF.Config.server.profileMessage.maxLength) {
                this.renderErrorModal(c.MODAL_PROFILE_MESSAGE_ERROR_VIEW.ERROR_TYPE_OF_CHARACTERS_OVER);
                return
            }
            this.isFiredTalkEnd = !0, this.isClickedRegister = !0, this.usersInputView.onClickSubmitButton(), this.renderConfirmModal()
        },
        onClickDeviceBackKey: function() {
            this.trigger("onClickBackKey")
        },
        onClickBack: function() {
            r.history.navigate("profile", {
                trigger: !0
            })
        },
        dispose: function() {
            this.wrapContent && (this.wrapContent = null), this.confirmView && this.confirmView.dispose(), this.usersInputView && this.usersInputView.dispose(), this.modalProfileMessageErrorView && this.modalProfileMessageErrorView.dispose(), FF.env.isAndroid() && FF.router.setupOnBackKey(), FF.env.isIOS7_0() && t(".c-layer-bg").off("touchstart"), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/configure_profile_message/ConfigureProfileMessageScene", ["underscore", "jquery", "backbone", "scenes/relation/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            var e = [FF.datastore.userModel.get("id")];
            return r.findByUserIdsDeferred(e)
        },
        start: function(e) {
            var t = this;
            t.setupDeferred().then(function(e) {
                t.layoutView = new s, t.layoutView.render(e)
            })
        }
    })
}), define("scenes/tutorial/common/LayoutBase", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/tutorial/Api", "scenes/tutorial/common/NavigationCharacter"], function(e, t, n, r, i, s) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        globalNaviSelector: t("[data-app-globalnavi]"),
        setupComponents: function() {
            r.prototype.setupComponents.call(this)
        },
        setupNavigationCharacter: function(e) {
            this.navigationCharacter = new s({
                el: t("#tutorialContainer"),
                talks: e || this.data
            })
        },
        getCurrentStepIllustImagePath: function(e) {
            var t = e ? e : 1,
                n = location.hash.split("#")[1];
            return FF.logger.debug(sprintf("/dff/static/img/category/tutorial/%s/pic_%d.png", n, t)), pUrl(sprintf("/dff/static/img/category/tutorial/%s/pic_%d.png", n, t))
        },
        onClickContainer: function() {
            this.navigationCharacter.setupTalk()
        },
        onClickProceed: function() {
            var e = this,
                t = FF.datastore.userModel;
            return FF.router.loading.show(), i.proceedTutorialDeferred(t.get("tutorial_step")).done(function(e) {
                t.set(e.user), n.history.navigate(e.fragment, {
                    trigger: !0
                }), FF.router.loading.hide()
            }), !1
        },
        onClickGlobalNavi: function(e) {
            return !1
        },
        closeAllGlobalNavi: function() {
            this.globalNaviSelector.addClass("is-disable"), this.globalNaviSelector.find("a").on("anchorsbeforejump", this.onClickGlobalNavi)
        },
        openAllGlobalNavi: function() {
            this.globalNaviSelector.removeClass("is-disable"), this.globalNaviSelector.find("a").unbind("anchorsbeforejump", this.onClickGlobalNavi)
        },
        dispose: function() {
            this.navigationCharacter && this.navigationCharacter.dispose(), this.openAllGlobalNavi(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/tutorial/battle_operations/views/Layout", ["underscore", "jquery", "backbone", "scenes/tutorial/Api", "scenes/common/helper/FuncTutorial", "scenes/tutorial/common/LayoutBase", "components/Loading", "scenes/tutorial/common/NavigationCharacter", "templates/tutorial/BattleOperations"], function(e, t, n, r, i, s, o, u, a) {
    var f = s.extend({
        contentType: "NO_BASE",
        designType: "CLASSIC",
        funcTutorialKey: "BATTLE_OPERATION",
        events: {
            "anchorsbeforejump #overlayNavigation": "onClickContainer"
        },
        initialize: function(e) {
            var t = FF.datastore;
            this.buddyModels = t.partyModel.getBuddyModels(), this.partyStatusModel = t.partyStatusModel, this.dungeonModel = t.currentDungeonModel, this.dungeonSessionModel = t.dungeonSessionModel, this.worldModel = this.dungeonSessionModel.getWorldModel(), this.talks = e.tutorial_talks, s.prototype.initialize.call(this)
        },
        render: function() {
            s.prototype.render.call(this, a, {
                buddyModels: this.buddyModels,
                partyStatusMap: this.partyStatusModel.getIdToDataMap()
            }), this.setBackgroundImage(this.dungeonModel.get("background_image_path")), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this), this.setupNavigator()
        },
        activationOnClickBack: function() {
            FF.SoundMgr.playChooseEffect(), t("[data-app-navigation-character-container]").remove(), t("[data-app-is-tap]").removeClass("is-disable"), t("[data-app-btn-back]").removeClass("is-disable").one("anchorsbeforejump", this.onClickBack), t("#overlay").addClass("hide")
        },
        onClickContainer: function() {
            this.navigationCharacter.setupTalk()
        },
        onClickBack: function() {
            window.history.back()
        },
        setupNavigator: function() {
            var e = this;
            this.navigationCharacter = new u({
                el: t("#overlayNavigation"),
                talks: this.talks
            });
            var n = i.getIllustImagePathByKey("battle_operation");
            this.listenToOnce(this.navigationCharacter, "SHOW_ILLUST", function() {
                e.navigationCharacter.showTutorialIllust([n]), e.listenToOnce(e.navigationCharacter, "closeNotify", function() {
                    e.navigationCharacter.popNavigationCharacter(), e.navigationCharacter.popTalkWindow(), e.navigationCharacter.renderTalk(), t("#overlay").removeClass("hide"), t("#overlayNavigation").one("anchorsbeforejump", e.activationOnClickBack.bind(e))
                })
            }), this.navigationCharacter.render({
                isPoppedWindow: !1
            })
        },
        dispose: function() {
            this.resetBackgroundImage(), this.navigationCharacter && this.navigationCharacter.dispose(), s.prototype.dispose.call(this)
        }
    });
    return f
}), define("scenes/tutorial/battle_operations/BattleOperationsScene", ["underscore", "jquery", "backbone", "scenes/tutorial/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        funcTutorialKey: "BATTLE_OPERATION",
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = FF.datastore;
            return i.hasDungeonSession() ? n.resolve().promise() : (r.dungeonSessionDeferred().then(function(e) {
                i.battleCollection.add(e.battles), i.dungeonSessionModel.set(e.dungeon), i.partyStatusModel.set(e.dungeon_session.party_status), n.resolve(e)
            }), n.promise())
        },
        start: function() {
            var e = this;
            this.setupDeferred().then(this.proceedFuncTutorialDeferred.bind(this)).then(function(t) {
                FF.datastore.userModel.set(t.user), e.layoutView = new s(t), e.layoutView.render(t);
                var n = FF.datastore.currentDungeonModel.get("bgm");
                FF.SoundMgr.playMusic(n)
            })
        },
        proceedFuncTutorialDeferred: function() {
            var e = t.Deferred();
            return r.proceedFuncTutorialDeferred({
                key: this.funcTutorialKey
            }).done(function(t) {
                FF.datastore.userModel.set(t.user), e.resolve(t)
            }), e.promise()
        }
    })
}), define("scenes/func_tutorial/pages/Page", ["underscore", "jquery", "backbone", "scenes/tutorial/Api", "scenes/tutorial/common/LayoutBase", "scenes/common/helper/FuncTutorial", "scenes/tutorial/common/NavigationCharacter", "templates/func_tutorial/FuncTutorialBase"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        tmpl: u,
        funcTutorialKey: void 0,
        navigateFragment: void 0,
        navigateHistoryBack: !1,
        events: {
            "anchorsbeforejump [data-app-tutorial-container]": "onClickContainer"
        },
        initialize: function(t) {
            i.prototype.initialize.call(this), this.arg = e.isObject(t) ? t : {}, this.illustNumber = 0
        },
        setupDeferred: function() {
            return this.proceedFuncTutorialDeferred({
                dryrun: !0
            })
        },
        proceedFuncTutorialDeferred: function(e) {
            var n = this,
                i = t.Deferred();
            return r.proceedFuncTutorialDeferred({
                key: this.funcTutorialKey,
                dryrun: e.dryrun
            }).done(function(e) {
                n.talks = e.tutorial_talks, FF.datastore.userModel.set(e.user), i.resolve(e)
            }), i.promise()
        },
        render: function() {
            i.prototype.render.call(this, this.tmpl), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.setupNavigator()
        },
        onClickContainer: function() {
            this.navigationCharacter && this.navigationCharacter.setupTalk()
        },
        setupNavigator: function() {
            var e = this;
            this.navigationCharacter = new o({
                el: t("[data-app-tutorial-container]"),
                talks: this.talks
            }), this.listenTo(this.navigationCharacter, "talkEnd", this.fireTalkEnd.bind(this)), this.listenTo(this.navigationCharacter, "SHOW_ILLUST", function() {
                e.navigationCharacter.showTutorialIllust([e.getNextIllustImagePath()])
            }), this.listenTo(this.navigationCharacter, "SHOW_ILLUST_DOUBLE", function() {
                e.navigationCharacter.showTutorialIllust([e.getNextIllustImagePath(), e.getNextIllustImagePath()])
            }), this.listenTo(this.navigationCharacter, "closeNotify", function() {
                e.navigationCharacter.popNavigationCharacter(), e.navigationCharacter.popTalkWindow(), e.navigationCharacter.renderTalk()
            }), this.navigationCharacter.render()
        },
        fireTalkEnd: function() {
            var e = this.navigationCharacter.getTalkNumber();
            if (e === this.talks.length) {
                if (this.isFiredTalkEnd) return;
                t("[data-app-tutorial-container]").one("anchorsbeforejump", this.onClickProceed.bind(this)), this.isFiredTalkEnd = !0
            }
        },
        onClickProceed: function() {
            FF.router.loading.lock(), this.navigationCharacter.dispose(), this.proceedFuncTutorial()
        },
        proceedFuncTutorial: function() {
            var e = this,
                t = this.navigateFragment;
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).done(function() {
                e.navigateHistoryBack ? window.history.back() : n.history.navigate(e.navigateFragment, {
                    trigger: !0
                })
            })
        },
        getNextIllustImagePath: function() {
            var e = this,
                t = s.getIllustImagePathByKey(this.funcTutorialKey.toLowerCase());
            return this.illustNumber++, t.replace(/_\d+\./, sprintf("_%d.", this.illustNumber))
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/func_tutorial/pages/Series", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SERIES",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/BuddyEvolution", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "BUDDY_EVOLUTION",
        navigateFragment: "#party/enhancement_top"
    })
}), define("scenes/func_tutorial/pages/Fellow", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "FELLOW",
        navigateFragment: "#friend",
        proceedFuncTutorial: function() {
            var e = this,
                t = this.navigateFragment;
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).done(function() {
                e.funcTutorialKey = "FELLOW_PLUS", e.proceedFuncTutorialDeferred({
                    dryrun: !1
                }).done(function() {
                    delete FF.datastore.stash.dungeonHash, $(document).trigger("updateBadge"), Backbone.history.navigate(t, {
                        trigger: !0
                    })
                })
            })
        }
    })
}), define("scenes/func_tutorial/pages/FellowPlus", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "FELLOW_PLUS",
        navigateFragment: void 0,
        initialize: function() {
            this.navigateFragment = FF.datastore.stash.dungeonHash || "#profile", delete FF.datastore.stash.dungeonHash, e.prototype.initialize.apply(this, arguments)
        }
    })
}), define("scenes/func_tutorial/pages/SsMultiAndExp", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SS_MULTI_AND_EXP",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/SsMulti", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SS_MULTI",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/SsExp", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "SS_EXP",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/Hammering", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "HAMMERING",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/UiReborn", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "UI_REBORN",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/AbilityDecompose", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "ABILITY_DECOMPOSE",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/AbilityMaterialConvert", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "ABILITY_MATERIAL_CONVERT",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/pages/DressRecord", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "DRESS_RECORD",
        navigateHistoryBack: !0
    })
}), define("scenes/movie_play/views/Layout", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/LayoutBase", "lib/TextMaster"], function(e, t, n, r, i, s) {
    var o = {
        EVENT_SKIP_CLICK: "onSkipClick",
        EVENT_SKIP_CONFIRMED: "onSkipConfirmed",
        EVENT_MODAL_SHOWN: "onModalShown",
        EVENT_MODAL_HIDDEN: "onModalHidden"
    };
    return i.extend({
        contentType: "NO_BASE",
        designType: "MODERN",
        events: {},
        initialize: function(e) {
            i.prototype.initialize.call(this), this._setABTouchEnabled(!1), this.movieName = e.movieName, this.uiView = e.uiView, this.options = e.options || {}, this.isSkipped = !1
        },
        setTextMap: function() {
            this.uiView.setTextMap({
                title: s.getInstance().get("movie_skip_title_1"),
                yes: s.getInstance().get("ok"),
                no: s.getInstance().get("cancel")
            })
        },
        _setABTouchEnabled: function(e) {
            kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: e,
                isEnableScreen: e
            })
        },
        _getTmpl: function() {
            throw new Error("Please override _getTmpl")
        },
        _getEndFragment: function() {
            throw new Error("Please override _getEndFragment")
        },
        render: function(e) {
            e = e || {}, this.setTextMap(), i.prototype.render.call(this, this._getTmpl(), e), this.processAfterRender(), this.$el.empty(), this._startMovie()
        },
        onClickProceed: function() {
            return !1
        },
        _startMovie: function() {
            var e = this;
            this._setABTouchEnabled(!0), kickmotor.nativefn.playVideo(this.movieName, this.onFinishPlayVideo.bind(this)), this.listenTo(this.uiView, o.EVENT_SKIP_CLICK, function() {
                FF.logger.debug(o.EVENT_SKIP_CLICK), e._showModalMessage()
            }), this.listenTo(this.uiView, o.EVENT_SKIP_CONFIRMED, function() {
                FF.logger.debug(o.EVENT_SKIP_CONFIRMED), e._skipMovie()
            }), this.listenTo(this.uiView, o.EVENT_MODAL_SHOWN, function() {
                FF.logger.debug(o.EVENT_MODAL_SHOWN), kickmotor.nativefn.pauseVideo()
            }), this.listenTo(this.uiView, o.EVENT_MODAL_HIDDEN, function() {
                FF.logger.debug(o.EVENT_MODAL_HIDDEN), kickmotor.nativefn.resumeVideo()
            }), this.listenTo(FF.router, "onApplicationForeground", function() {
                setTimeout(function() {
                    e.uiView && e.uiView.isModalShown() && kickmotor.nativefn.pauseVideo()
                }, 1e3)
            }), this.uiView.setActive()
        },
        _showModalMessage: function() {
            this.uiView.showModal(s.getInstance().get("movie_skip_body_3"))
        },
        _skipMovie: function() {
            if (this.isSkipped) {
                FF.logger.debug("already skipped");
                return
            }
            this.isSkipped = !0, this.uiView.setDeactive(), this._finishPlayVideo()
        },
        onFinishPlayVideo: function(e) {
            e.fileNotExist && FF.logger.error("movie is not found: " + this.movieName), this.isSkipped || this._finishPlayVideo()
        },
        _finishPlayVideo: function(e) {
            e = e || {}, kickmotor.nativefn.stopVideo(), this.stopListening(), this._setABTouchEnabled(!1), this.uiView.isModalShown() && (FF.logger.debug("video finished... it must be paused!"), this.uiView.setDeactive());
            if (!e.needNotNavigate) {
                var t = this._getEndFragment();
                n.history.navigate(t, {
                    trigger: !0
                })
            }
        }
    })
}), define("scenes/common/ab/MovieUIView", ["underscore", "jquery", "backbone", "lib/EventBase", "lib/ab/ABNode", "lib/ab/ABLayer", "lib/ab/ABNodeButton", "lib/TextMaster"], function(e, t, n, r, i, s, o, u) {
    var a = "movie_skip",
        f = "layer_" + a,
        l = "/Content/lang/ab/movie_skip/movie_skip.json",
        c = "/Content/lang/ww/compile/",
        h = "/ab/movie_skip/movie_skip.json",
        p = "open",
        d = "close",
        v = "open_modal_%d",
        m = "close_modal_%d",
        g = "stage",
        y = "footer",
        b = "black_img",
        w = "modal_%s",
        E = "progress_bar",
        S = "btn_right_%s",
        x = "btn_left_%s",
        T = "btn_skip",
        N = "openingUI",
        C = "modal_content_txt_%s",
        k = "modal_ttl_txt_%s",
        L = "onSkipClick",
        A = "onSkipConfirmed",
        O = "onModalShown",
        M = "onModalHidden",
        _ = "complete",
        D = "progress",
        P = "loading_loop",
        H = "close_bar",
        B = 320,
        j = r.extend({
            initialize: function(e) {
                this.node = e, this._lastTag = void 0, this._lastframe = void 0, this._ratio = 0, this._targetRatio = 0, this._hidden = !1, this.node.createChildNode("loading_txt_anm").play(P).process()
            },
            dispose: function() {
                this.node = void 0
            },
            hide: function(e) {
                if (this._hidden && !e) return;
                this._hidden = !0, e ? this.node.setVisible(!1).process() : this._playTag(H)
            },
            progress: function(e) {
                this._targetRatio = e
            },
            update: function() {
                if (this._hidden || this._completed) return;
                var e = (this._targetRatio - this._ratio) * .75;
                e = Math.min(.1, e), this._ratio += e, this._playTag(D, Math.floor(this._ratio * 100)), this._targetRatio === 1 && (this._ratio = 1, this._complete())
            },
            isCompleted: function() {
                return this._completed
            },
            _complete: function() {
                this._completed = !0, this.progress(1), this._playTag(_)
            },
            _playTag: function(e, t, n) {
                if (e === void 0) return;
                if (!n && this._lastTag === e && t === this._lastframe) return;
                this._lastTag = e, this._lastframe = t, t !== void 0 ? this.node.setVisible(!0).playFrame(this._lastTag, this._lastframe, this._lastframe).process() : this.node.setVisible(!0).play(this._lastTag).process()
            }
        });
    return r.extend({
        initialize: function(e) {
            this._active = !1, this._options = e, this.textMap = {}
        },
        loadAssetDeferred: function() {
            this._loadLayer(), this._initializeUI(), this._setupOnBackKey(), this._options.loadingBar || this.hideLoadingBar(!0), this._options.skipButton || this.hideSkipButton(!0);
            var e = t.Deferred();
            return e.resolve().promise()
        },
        _loadLayer: function() {
            this.layer = new s({
                layerName: f
            });
            if (FF.env.isWWRegion()) {
                var e = FF.env.getLanguage() || "en";
                this.layer.createLayer(c + e + h)
            } else this.layer.createLayer(l);
            this.layer.activate()
        },
        _initializeUI: function() {
            var t = this;
            this.ab = {}, this.ab.topNode = this.layer.createNode(g).setVisible(!1), this.ab.footerNode = this.layer.createNode(y), this.ab.imageNode = this.layer.createNode(b), this.modals = {}, this.modals["01"] = this._createModal("01"), this.modals["02"] = this._createModal("02"), this.skipBtn = (new o(this.ab.footerNode.createChildNode(T), void 0, N)).setButtonStateTags(void 0, void 0, void 0).setTouchHandler(e.bind(this._handleTouchSkip, this));
            var n = kickmotor.nativefn.getLogicalScreenHeight();
            kickmotor.animation.processAnimation([{
                exec: "addTouchRect",
                layer: f,
                node: g,
                rect: [0, 0, B, n],
                isHitTestEnable: !0
            }]), this.ab.topNode.addCallback("action_touch_began", function(e) {
                FF.eventNotifier.trigger("ab:onTapScreen", e)
            }), this._flush()
        },
        _createModal: function(t) {
            this.ab["modalNode" + t] = this.layer.createNode(sprintf(w, t)), this["cancelBtn" + t] = (new o(this.ab["modalNode" + t].createChildNode(sprintf(x, t), void 0, N))).setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(e) {
                e.setEnabled(!1)
            }).setTouchHandlerAfterAnimation(e.bind(this._handleTouchModalCancel, this)), this["okBtn" + t] = (new o(this.ab["modalNode" + t].createChildNode(sprintf(S, t), void 0, N))).setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(e) {
                e.setEnabled(!1)
            }).setTouchHandlerAfterAnimation(e.bind(this._handleTouchModalOk, this));
            var n = void 0;
            return t === "02" && (this.ab.loadingBarNode = this.ab["modalNode" + t].createChildNode(E), this.loadingBarControl = new j(this.ab.loadingBarNode), this.loadingBarControl.progress(0), n = this.loadingBarControl), {
                mainNode: this.ab["modalNode" + t],
                okButton: this["okBtn" + t],
                cancelButton: this["cancelBtn" + t],
                isShown: !1,
                loadingBarControl: n
            }
        },
        _handleTouchSkip: function(e) {
            if (!this._active) return;
            FF.SoundMgr.playChooseEffect(), this.trigger(L)
        },
        _handleTouchModalOk: function(e) {
            if (!this.isModalShown()) return;
            this.hideModal(), this.trigger(A)
        },
        _handleTouchModalCancel: function(e) {
            if (!this.isModalShown()) return;
            this.hideModal()
        },
        setTextMap: function(t) {
            e.extend(this.textMap, t)
        },
        _getText: function(e) {
            return this.textMap[e] || ""
        },
        setActive: function() {
            var e = this;
            this._active = !0, this.ab.topNode.setVisible(!0).process()
        },
        setDeactive: function() {
            this.hideModal(), this._active = !1
        },
        hideAll: function() {
            this.setDeactive(), this.ab.topNode.setVisible(!1).process()
        },
        hideLoadingBar: function(e) {
            this.loadingBarControl.hide(e)
        },
        setLoadingBarRatio: function(e) {
            this.loadingBarControl.progress(e), this._options.loadingBar && this.loadingBarControl.update()
        },
        setLoadingBarComplete: function() {
            var e = this;
            this.loadingBarControl.progress(1), this._options.loadingBar && this.loadingBarControl.update()
        },
        hideSkipButton: function(e) {
            this.skipBtn.setVisible(!1)
        },
        showModalComplete: function() {
            if (this._isModalShown) return;
            var e = u.getInstance().get("movie_skip_body_1");
            this._showModalByInfo({
                pos: "01",
                message: e
            }), this.trigger(O)
        },
        showModalIncomplete: function() {
            if (this._isModalShown) return;
            if (this.loadingBarControl.isCompleted()) this.showModalComplete();
            else {
                var e = u.getInstance().get("movie_skip_body_2");
                this._showModalByInfo({
                    pos: "02",
                    message: e
                }), this.trigger(O)
            }
        },
        showModal: function(e) {
            if (this._isModalShown) return;
            this._showModalByInfo({
                pos: "01",
                message: e
            }), this.trigger(O)
        },
        _showModalByInfo: function(e) {
            this._isModalShown = !0, this.ab.imageNode.play(p), this.skipBtn.setEnabled(!1);
            var t = this.modals[e.pos];
            t.isShown = !0, t.mainNode.setText(sprintf(C, e.pos), e.message).setText(sprintf(k, e.pos), this._getText("title")).play(sprintf(v, +e.pos)), t.cancelButton.setLabel(this._getText("no")).setEnabled(!0), t.okButton.setLabel(this._getText("yes")).setEnabled(!0), this._flush()
        },
        hideModal: function() {
            if (!this._isModalShown) return;
            this._hideModal(), this.trigger(M)
        },
        _hideModal: function() {
            this._isModalShown = !1, this.ab.imageNode.play(d), this.skipBtn.setEnabled(!0), e.each(["01", "02"], function(e) {
                var t = this.modals[e];
                t.isShown && (t.mainNode.play(sprintf(m, +e)), t.cancelButton.setEnabled(!1), t.okButton.setEnabled(!1), t.isShown = !1)
            }, this), this._flush()
        },
        isModalShown: function() {
            return this._isModalShown
        },
        _flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        _disposeABNodeButtons: function() {
            this.skipBtn && (this.skipBtn.dispose(), this.skipBtn = void 0);
            if (!this.modals) return;
            e.each(["01", "02"], function(e) {
                var t = this.modals[e];
                t.okButton && (t.okButton.dispose(), t.okButton = void 0), t.cancelButton && (t.cancelButton.dispose(), t.cancelButton = void 0)
            }, this)
        },
        _setupOnBackKey: function() {
            FF.env.isUsingWWBackKeyHandler() && this.listenTo(kickmotor.nativefn.onBackKeyHandler, "System::onBackKey", this._onBackKey)
        },
        _onBackKey: function() {
            this.isModalShown() ? this._handleTouchCancel() : this._handleTouchSkip()
        },
        dispose: function() {
            var e = this;
            kickmotor.animation.processAnimation([{
                exec: "clearTouchRect",
                layer: f,
                node: g
            }]), this._disposeABNodeButtons(), this.layer && (this.layer.destroyLayer().process(), this.layer = void 0), this.loadingBarControl && (this.loadingBarControl.dispose(), this.loadingBarControl = void 0), this.modals = void 0, this.ab = void 0, this._options = null, o.unlockAll()
        }
    })
}), define("scenes/movie_play/views/ModalUnsupportedDeviceError", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/movie/ModalUnsupportedDeviceError"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-btn-ok]": "onClickOk"
        },
        onClickOk: function() {
            this.end(), window.history.back()
        },
        render: function() {
            this.renderContent(i)
        }
    })
}), define("scenes/movie_play/MoviePlayScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/Layout", "scenes/common/ab/MovieUIView", "scenes/common/util/Api", "lib/Download", "./views/ModalUnsupportedDeviceError"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        layoutClass: i,
        start: function(e, t) {
            if (!FF.env.canPlayMovieJustAfterDownload() && !t.forceShow) {
                FF.modalStack.push(a, {
                    renderer: function(e) {
                        e.render()
                    }
                });
                return
            }
            var n = this;
            this.movieName = e, this.options = t || {}, this.movieAsset = void 0, this._getMovieAssetsDeferred(this.options.path).then(this._loadMovieAssetsDeferred.bind(this)).then(this._loadABAssetDeferred.bind(this)).then(this._start.bind(this))
        },
        _getMovieAssetsDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return e ? (o.getAssetsByPathsDeferred([e]).done(function(e) {
                return n.movieAsset = e.assets[0], r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        _loadMovieAssetsDeferred: function() {
            var e = this,
                r = t.Deferred();
            return this.movieAsset ? (u.hasFileNeededToDownloadDeferred([this.movieAsset], {
                url: location.hash
            }).then(function(e) {
                e.needDownload ? (n.history.navigate("download", {
                    trigger: !0
                }), r.reject()) : r.resolve()
            }), r.promise()) : r.resolve().promise()
        },
        _loadABAssetDeferred: function() {
            var e = this;
            return this.uiView = new s({
                loadingBar: !1,
                skipButton: !0
            }), this.uiView.loadAssetDeferred()
        },
        _start: function() {
            FF.SoundMgr.stopMusic(), this.layoutView = new this.layoutClass({
                movieName: this.movieName,
                uiView: this.uiView,
                options: this.options
            }), this.layoutView.render()
        },
        dispose: function() {
            this.uiView && this.uiView.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/func_tutorial/movies/views/Layout", ["scenes/movie_play/views/Layout", "templates/movie/Movie"], function(e, t) {
    return e.extend({
        _getTmpl: function() {
            return t
        },
        _getEndFragment: function() {
            return this.options.navigateFragment
        }
    })
}), define("scenes/func_tutorial/movies/Movie", ["underscore", "jquery", "backbone", "lib/Scene", "scenes/movie_play/MoviePlayScene", "scenes/common/helper/MovieHelper", "scenes/tutorial/Api", "./views/Layout"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        layoutClass: u,
        isMovie: !0,
        funcTutorialKey: void 0,
        tutorialMovieName: void 0,
        navigateFragment: void 0,
        movieFolderPath: "tutorial/",
        initialize: function() {
            if (!this.tutorialMovieName) throw new Error("undefined tutorialMovieName");
            if (!this.funcTutorialKey) throw new Error("undefined funcTutorialKey")
        },
        start: function() {
            var e = this,
                t = FF.CONST.CLIENT.SERVER_MOVIE_PATH,
                r = s.getFuncTutorialMovieName(this.movieFolderPath, this.tutorialMovieName),
                o = {
                    path: sprintf(t, r),
                    navigateFragment: this.navigateFragment
                };
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).then(function() {
                if (!FF.env.canPlayMovieJustAfterDownload()) {
                    n.history.navigate(o.navigateFragment, {
                        trigger: !0
                    });
                    return
                }
                i.prototype.start.call(e, r, o)
            })
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        proceedFuncTutorialDeferred: function(e) {
            var n = t.Deferred();
            return o.proceedFuncTutorialDeferred({
                key: this.funcTutorialKey,
                dryrun: e.dryrun
            }).done(function(e) {
                FF.datastore.userModel.set(e.user), n.resolve(e)
            }), n.promise()
        }
    })
}), define("scenes/func_tutorial/movies/Extreme", ["./Movie"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME_MOVIE",
        tutorialMovieName: "extreme",
        navigateFragment: "#event/extreme/world_list"
    })
}), define("scenes/func_tutorial/pages/Extreme", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "EXTREME",
        navigateHistoryBack: !0,
        processAfterContentLoad: function() {
            e.prototype.processAfterContentLoad.call(this), this.playBgm()
        },
        playBgm: function() {
            FF.SoundMgr.playMusic("bgm_12_048")
        }
    })
}), define("scenes/func_tutorial/movies/views/FirstAnniversaryLayout", ["lib/LayoutBase", "scenes/movie_play/views/Layout", "templates/func_tutorial/FirstAnniversaryLayout"], function(e, t, n) {
    return t.extend({
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        render: function(t) {
            t = t || {}, this.setTextMap(), e.prototype.render.call(this, n, t), this.processAfterRender(), FF.env.canPlayMovieJustAfterDownload() && (this.$el.hide(), this._startMovie())
        },
        _finishPlayVideo: function() {
            t.prototype._finishPlayVideo.call(this, {
                needNotNavigate: !0
            }), this.$el.show(), this.uiView.hideSkipButton(), FF.router.loading.hide()
        },
        onClickNext: function() {
            return FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/func_tutorial/movies/FirstAnniversary", ["./Movie", "./views/FirstAnniversaryLayout"], function(e, t) {
    return e.extend({
        layoutClass: t,
        funcTutorialKey: "FIRST_ANNIVERSARY",
        tutorialMovieName: "first_anniversary"
    })
}), define("scenes/func_tutorial/pages/Mission", ["./Page"], function(e) {
    return e.extend({
        funcTutorialKey: "MISSION",
        navigateHistoryBack: !0
    })
}), define("scenes/func_tutorial/movies/views/TenMillionDownloadLayout", ["lib/LayoutBase", "scenes/movie_play/views/Layout", "templates/func_tutorial/TenMillionDownloadLayout"], function(e, t, n) {
    return t.extend({
        render: function(t) {
            t = t || {}, this.setTextMap(), e.prototype.render.call(this, n, t), this.processAfterRender(), FF.env.canPlayMovieJustAfterDownload() && (this.$el.hide(), this._startMovie())
        },
        _finishPlayVideo: function() {
            return t.prototype._finishPlayVideo.call(this, {
                needNotNavigate: !0
            }), this.$el.show(), this.uiView.hideSkipButton(), FF.router.loading.hide(), FF.router.goBootstrapNextScene()
        }
    })
}), define("scenes/func_tutorial/movies/TenMillionDownload", ["./Movie", "./views/TenMillionDownloadLayout", "scenes/movie_play/MoviePlayScene", "scenes/common/helper/MovieHelper"], function(e, t, n, r) {
    return e.extend({
        layoutClass: t,
        funcTutorialKey: "TEN_MILLION_DOWNLOAD_MOVIE",
        tutorialMovieName: "ten_million_download",
        start: function() {
            var e = this,
                t = sprintf(r.getServerMoviePath(), this.movieFolderPath + this.tutorialMovieName),
                i = r.getFuncTutorialMovieName(this.movieFolderPath, this.tutorialMovieName),
                s = {
                    path: t,
                    navigateFragment: this.navigateFragment
                };
            this.proceedFuncTutorialDeferred({
                dryrun: !1
            }).then(function() {
                if (!FF.env.canPlayMovieJustAfterDownload()) {
                    Backbone.history.navigate(s.navigateFragment, {
                        trigger: !0
                    });
                    return
                }
                n.prototype.start.call(e, i, s)
            })
        }
    })
}), define("scenes/func_tutorial/FuncTutorialScene", ["jquery", "lib/Scene", "scenes/common/util/Api", "./pages/Series", "./pages/BuddyEvolution", "./pages/Fellow", "./pages/FellowPlus", "./pages/SsMultiAndExp", "./pages/SsMulti", "./pages/SsExp", "./pages/Hammering", "./pages/UiReborn", "./pages/AbilityDecompose", "./pages/AbilityMaterialConvert", "./pages/DressRecord", "./movies/Extreme", "./pages/Extreme", "./movies/FirstAnniversary", "./pages/Mission", "./movies/TenMillionDownload"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    return t.extend({
        pages: {
            series: r,
            buddy_evolution: i,
            fellow: s,
            fellow_plus: o,
            ss_multi_and_exp: u,
            ss_multi: a,
            ss_exp: f,
            hammering: l,
            ui_reborn: c,
            ability_decompose: h,
            ability_material_convert: p,
            dress_record: d,
            extreme_movie: v,
            extreme: m,
            first_anniversary: g,
            mission: y,
            ten_million_download_movie: b
        },
        setupDeferred: function() {
            return e.Deferred().resolve().promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e;
            if (!r) throw new Error("missing page in FuncTutorialScene");
            this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in FuncTutorialScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.isMovie ? n.layoutView.start(t, e) : n.layoutView.render(t, e)
            })
        }
    })
}), define("scenes/logout/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/logout/MobageLogout"], function(e, t, n, r, i) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-next]": "onClickNextButton",
            "anchorsbeforejump [data-app-btn-mobage-top]": "onClickMobageTopButton"
        },
        render: function() {
            r.prototype.render.call(this, i), this.processAfterRender()
        },
        onClickNextButton: function() {
            n.history.navigate("mobage_logout_confirm", {
                trigger: !0
            })
        },
        onClickMobageTopButton: function() {
            kickmotor.platform.showCommunity()
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/logout/MobageLogoutScene", ["underscore", "jquery", "lib/Scene", "./views/Layout"], function(e, t, n, r) {
    return n.extend({
        start: function() {
            var e = new r;
            e.render()
        }
    })
}), define("scenes/logout/views/ConfirmLayout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "lib/Storage", "templates/logout/MobageLogoutConfirm", "components/CookieMania"], function(e, t, n, r, i, s, o) {
    return r.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-menu-top]": "onClickMenuTopButton",
            "anchorsbeforejump [data-app-btn-mobage-logout]": "onClickMobageLogoutButton"
        },
        render: function() {
            r.prototype.render.call(this, s), this.processAfterRender()
        },
        onClickMenuTopButton: function() {
            n.history.navigate("global_menu", {
                trigger: !0
            })
        },
        onClickMobageLogoutButton: function() {
            FF.router.loading.lock();
            var e = new o;
            i.removeAllItemsDeferred().then(function(t) {
                FF.router.loading.unlock();
                if (!t.result) throw new Error("Failed in clearing local storage.");
                e.unsetAllCookie(), kickmotor.platform.mobageLogout()
            })
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/logout/MobageLogoutConfirmScene", ["underscore", "jquery", "backbone", "lib/Scene", "./views/ConfirmLayout"], function(e, t, n, r, i) {
    return r.extend({
        start: function() {
            var e = new i;
            e.render()
        }
    })
}), define("scenes/dungeon/DungeonWarpViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "scenes/common/ab/consts/ABLayerDepths", "lib/EventBase", "util"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        DESTORY_TIMER_MSEC: 5e3
    };
    return u.extend({
        initialize: function() {
            FF.logger.debug("init dungen warp view controller"), this.assetsManager = void 0, this.mainLayerName = void 0, this.warpNode = void 0, this.destroyTimerId = void 0
        },
        loadAssetsDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.env.isNative() ? (this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(e).then(function() {
                n.mainLayerName = "layer_dungeon_warp", n.warpNode = new i({
                    name: "warp_nul",
                    layer: n.mainLayerName
                }), r.resolve()
            }, function() {
                r.reject()
            }), r.promise()) : r.resolve().promise()
        },
        playWarpInDeferred: function() {
            return this.warpNode ? this.warpNode.setVisible(!0).play("in").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        playWarpLoop: function() {
            var e = this;
            if (!this.warpNode) return;
            return this.destroyTimerId = window.setTimeout(function() {
                e.dispose()
            }, f.DESTORY_TIMER_MSEC), (new r({
                layerName: this.mainLayerName
            })).setZOrder(o.DUNGEON_WARP).process(), this.warpNode.setVisible(!0).play("loop").process()
        },
        playWarpOutDeferred: function() {
            return this.warpNode ? this.warpNode.setVisible(!0).play("out").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        hasWarpView: function() {
            return !!this.warpNode
        },
        dispose: function() {
            this.destroyTimerId && window.clearTimeout(this.destroyTimerId), this.assetsManager && this.assetsManager.destroyAllLayer(), this.assetsManager = null, this.mainLayerName = null, this.warpNode = null
        }
    })
}), define("scenes/copyright/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates/copyright/Copyright", "components/Accordion", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        render: function() {
            var e = {
                isAndroid: FF.env.isAndroid(),
                isIOS: FF.env.isIOS()
            };
            i.prototype.render.call(this, s, e), this.setupComponents(), this.bindEvents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.accordion = new o({
                parentSelector: "[data-ui-accordion-parent]",
                childrenSelector: "[data-ui-accordion-child]",
                isSingleView: !0
            }), this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        bindEvents: function() {
            var e = this;
            this.listenTo(this.accordion, "displayChange", function() {
                e.scrollbar.updateContent()
            })
        },
        onClickBack: function() {
            n.history.navigate("#information", {
                trigger: !0
            })
        },
        dispose: function() {
            this.accordion && this.accordion.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/copyright/CopyrightScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/staff_roll/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates/staff_roll/StaffRoll", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        render: function() {
            var e = {};
            i.prototype.render.call(this, s, e), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#information", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/staff_roll/StaffRollScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/character_profile/views/Top", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/character_profile/Top", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-series]": "onTapSeries"
        },
        render: function() {
            r.prototype.render.call(this, i, {
                seriesList: FF.datastore.characterProfileCollection.getSeriesList()
            }), this.generateComponents(), this.startUpSlideInAnimation(), FF.router.loading.unlock()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onTapSeries: function(e) {
            var t = e.currentTarget.getAttribute("data-app-series");
            this.offBackEvent(), this.trigger("onSelectSeries", t)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        },
        onClickBack: function() {
            window.history.back()
        }
    })
}), define("scenes/character_profile/views/CharacterList", ["underscore", "jquery", "backbone", "lib/LayoutBase", "templates/character_profile/CharacterList", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-character]": "onTapCharacter"
        },
        render: function(e) {
            var t = FF.datastore.characterProfileCollection.getCharacterList(e);
            r.prototype.render.call(this, i, {
                seriesName: t[0].series_name,
                characterList: t
            }), this.generateComponents(), this.startUpSlideInAnimation(), this.processAfterRender()
        },
        generateComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onTapCharacter: function(e) {
            FF.router.loading.lock();
            var t = e.currentTarget.getAttribute("data-app-character");
            this.trigger("onSelectCharacter", t)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        },
        onClickBack: function() {
            this.trigger("onClickBack")
        }
    })
}), define("scenes/character_profile/views/ModalDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "templates/character_profile/ModalDetail"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-charaDetail-back]": "onClickClose"
        },
        render: function(e) {
            var t = FF.datastore.characterProfileCollection.get(~~e);
            this.putContent(o(t.toJSON()))
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t('[data-ui-freescroll="detail"]')
            }), this.scrollbar = new s({
                el: t('[data-ui-scrollbar="detail"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        open: function() {
            this.listenToOnce(this, "openAnimationEnd", this.setupComponents), r.prototype.open.apply(this, arguments)
        },
        onClickClose: function() {
            this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/character_profile/CharacterProfileScene", ["underscore", "jquery", "backbone", "./views/Top", "./views/CharacterList", "./views/ModalDetail", "lib/Scene"], function(e, t, n, r, i, s, o) {
    return o.extend({
        initialize: function() {
            this.topView = new r, this.listView = new i, this.setListener()
        },
        setupDeferred: function() {},
        start: function() {
            this.topView = new r, this.topView.render()
        },
        setListener: function() {
            this.listenTo(this.topView, "onSelectSeries", this.renderCharacterList), this.listenTo(this.listView, "onSelectCharacter", this.renderDetailContent), this.listenTo(this.listView, "onClickBack", this.start)
        },
        renderCharacterList: function(e) {
            this.listView.render(e)
        },
        renderDetailContent: function(e) {
            var t = new s;
            FF.router.overlay.registerChildren(t), t.render(e), t.open()
        },
        dispose: function() {
            this.topView && this.topView.dispose(), this.listView && this.listView.dispose(), o.prototype.dispose.apply(this)
        }
    })
}), define("ww/scenes/common/util/BackKeyHandler", ["jquery", "underscore"], function(e, t) {
    return t.extend({}, {
        onBackKey: function() {
            var t = e("body").css("pointer-events") === "none";
            if (t) return;
            var n = e("#overlay").hasClass("hide");
            n ? this._onBackKeyPressOutsideModal() : this._onBackKeyPressInsideModal()
        },
        _onBackKeyPressOutsideModal: function() {
            var e = ["[data-app-btn-back]", "[data-app-cancel]", "[data-app-btn-next]", "[data-app-next]", "[data-app-login-bonus-received]", "[data-app-navigation-character-container]", "[data-app-tutorial-clear]"];
            this._onBackKeyPressHelper(e, !1)
        },
        _onBackKeyPressInsideModal: function() {
            var e = ["[data-app-modal-back]", "[data-app-modal-close]", "[data-app-btn-close]", "[data-app-gemmodal-close]", "[data-app-tutorial-illustration-btn]", "[data-app-btn-back]", "[data-app-btn-cancel]", "[data-app-modal-cancel]", ".btn-close", ".btn-sub-tutorial", "[data-app-navigation-character-container]", "[data-app-decide-negative]", "[data-app-btn-next]", ".btn-sub-tutorial", "[data-app-supporter-modal-close]", "[data-app-complete-change-align]", "[data-app-btn-back-notification]", "[data-app-input-attr]"];
            this._onBackKeyPressHelper(e, !1)
        },
        _onBackKeyPressHelper: function(n, r) {
            t.find(n, function(n) {
                var i = e(n);
                return i ? t.find(i, function(t) {
                    var n = e(t);
                    if (r) {
                        var i = t.attr("data-app-enable-back-key");
                        if (!i) return !1
                    }
                    return n.hasClass("is-disable") ? !1 : t.parentNode && t.parentNode.style && t.parentNode.style.display === "none" ? !1 : (n.trigger("anchorsbeforejump"), !0)
                }) : !1
            })
        }
    })
}), define("scenes/mission/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getMissionListAndCheckDeferred: function() {
            return this.requestDeferred("/dff/mission/list_and_check", {})
        },
        confirmMissionListDeferred: function(e) {
            return this.requestDeferred("/dff/mission/confirm_mission_list", {
                type: e
            }, {
                type: "POST",
                disableLoading: !0,
                doNotHandleError: !0
            })
        },
        receiveRewardAllDeferred: function(e) {
            return this.requestDeferred("/dff/mission/receive_reward_all", {
                type: e
            }, {
                type: "POST"
            })
        },
        receiveRewardDeferred: function(e) {
            return this.requestDeferred("/dff/mission/receive_reward", {
                id: e
            }, {
                type: "POST"
            })
        },
        applyForRealIncentiveDeferred: function(e, t) {
            var n = t && t.withSNSShare ? {
                id: e,
                with_sns_share: !0
            } : {
                id: e
            };
            return this.requestDeferred("/dff/mission/apply_for_real_incentive", n, {
                type: "POST"
            })
        },
        checkAndAchieveMissionDeferred: function(e) {
            return this.requestDeferred("/dff/mission/check_and_achieve_mission", {
                id: e
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/quest/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        questListDeferred: function() {
            return this.requestDeferred("/dff/quest/list", {})
        }
    })
}), define("scenes/mission/pages/Page", ["underscore", "jquery", "backbone", "scenes/quest/Api", "lib/LayoutBase"], function(e, t, n, r, i) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(t) {
            i.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        }
    })
}), define("scenes/mission/views/ModalMissionRewardReceived", ["underscore", "jquery", "backbone", "scenes/mission/Api", "lib/ModalBase", "templates/mission/views/ModalMissionRewardReceived", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.models = e.models, this.hasRemapGrowEgg = e.hasRemapGrowEgg, this.remapGrowEggCnt = e.remapGrowEggCnt, this.renderContent(s, {
                models: this.models,
                hasRemapGrowEgg: this.hasRemapGrowEgg
            }), this.setupComponents()
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        setupComponents: function() {
            this._freescroll = new o({
                el: t("[data-ui-freescroll-for-reward-received]")
            }), this._scrollbar = new u({
                el: t("[data-ui-scrollbar-for-reward-received]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/views/ModalError", ["underscore", "jquery", "backbone", "scenes/common/util/ErrorHandler", "scenes/mission/Api", "templates/mission/views/ModalError", "lib/ModalBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose"
        },
        initialize: function(e) {
            o.prototype.initialize.call(this), this._errorType = e.errorType;
            var t = FF.CONST.SERVER.ERROR;
            this._errorTypeToFunc = {}
        },
        render: function() {
            this.renderContent(s, {
                errorType: this._errorType
            })
        },
        onClickClose: function() {
            var e = this._errorTypeToFunc[this._errorType];
            if (!e) {
                var t = new r;
                t.sendErrorInfo({
                    filename: location.href,
                    message: "no target func for " + this._errorType
                }), e = this._redirectTop
            }
            e.call(this)
        },
        _endModal: function() {
            o.prototype.end.call(this)
        },
        _redirectTop: function() {
            FF.redirect("/dff/")
        }
    })
}), define("templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", [], function() {
    return function(a) {
        function print() {
            __p += __j.call(arguments, "")
        }
        a || (a = {});
        var b, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(a) {
            var c = _.first(models);
            __p += '\n<div class="scene-modal-mission-reward c-modal-window scene-ww-real-incentive">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene">\n            <span class="c-ttl-scene__inner">\n            Sweepstakes Mission\n            </span>\n        </h1>\n        ', c.isRealIncentiveApplied() ? __p += '\n            <div class="s-ww-text-real-incentive-sns-share-confirm mlr-a mt-b4 mb-b4 img-rep">友達にシェアして当選確率を2倍にしよう！</div>\n        ' : __p += '\n            <div class="s-ww-text-real-incentive-apply-confirm mlr-a mt-b4 mb-b4 img-rep">応募しますか？</div>\n        ', __p += '\n        <div class="c-paper-container po-r">\n            <div class="c-paper-container__inner">\n                <div class="c-paper-container__content">\n                    <p>' + __e(c.get("title")) + "</p>\n                </div>\n            </div>\n        </div>\n        ", c.isRealIncentiveApplied() && (__p += '\n            <ul class="s-icon-container mt-b2 mb-b box-cc">\n                ', _.each(enabledServices.slice(0, 5), function(e) {
                __p += '\n                    <li class="p-icon-sns-' + __e(e) + ' img-rep mr-b" data-app-modal-real-incentive-mission="' + __e(c.get("id")) + '" data-app-sns-share="' + __e(e) + '" data-mbgaui-anchors>' + __e(e) + "</li>\n                "
            }), __p += "\n            </ul>\n        "), __p += '\n        <div class="mt-b2 mb-b pr-b pl-b ta-c">\n            \n            ';
            var d = "http://anniversary.finalfantasyrecordkeeper.com/sweepstakes/rules/";
            __p += "\n            ", c.isRealIncentiveApplied() ? __p += '\n                <p>Agree to the <span class="s-ww-fc-share" data-app-external-url="' + __e(d) + '" data-mbgaui-anchors>Terms of Use</span> and share?</p>\n            ' : __p += '\n                <p>Agree to the <span class="s-ww-fc-share" data-app-external-url="' + __e(d) + '" data-mbgaui-anchors>Terms of Use</span> and enter the sweepstakes?</p>\n            ', __p += '\n        </div>\n        <div class="c-btn-layout">\n            ', c.isRealIncentiveApplied() ? __p += '\n                <a class="c-btn is-sub-lead c-btn-layout__center" data-mbgaui-anchors data-app-sound="choose" data-app-modal-cancel data-app-enable-back-key="true"><span class="c-btn__inner">Cancel</span></a>\n            ' : __p += '\n                <a class="c-btn is-sub-lead c-btn-layout__left" data-mbgaui-anchors data-app-sound="choose" data-app-modal-cancel data-app-enable-back-key="true"><span class="c-btn__inner">Cancel</span></a>\n                <a class="c-btn is-sub-lead c-btn-layout__right" data-mbgaui-anchors data-app-sound="choose" data-app-modal-real-incentive-apply="' + __e(c.get("id")) + '" data-app-enable-back-key="true"><span class="c-btn__inner">Enter</span></a>\n            ', __p += "\n        </div>\n    </div>\n</div>\n"
        }
        return __p
    }
}), define("templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionApplied", [], function() {
    return function(a) {
        function print() {
            __p += __j.call(arguments, "")
        }
        a || (a = {});
        var b, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(a) {
            var c = _.first(models);
            __p += '\n<div class="scene-modal-mission-reward c-modal-window scene-ww-real-incentive">\n    <div class="c-modal-window__inner">\n        <h1 class="c-ttl-scene">\n            <span class="c-ttl-scene__inner">\n            Sweepstakes Mission\n            </span>\n        </h1>\n        <div class="s-ww-deshi"></div>\n        ', c.isRealIncentiveApplied() ? __p += '\n            <div class="s-ww-text-real-incentive-shared mlr-a mt-b4 mb-b4 img-rep">応募完了</div>\n        ' : __p += '\n            <div class="s-ww-text-real-incentive-sns-shared mlr-a mt-b4 mb-b4 img-rep">応募＆SNSシェア完了</div>\n        ', __p += '\n        <div class="c-btn-layout">\n            <a class="c-btn is-sub-lead c-btn-layout__center" data-mbgaui-anchors data-app-sound="choose" data-app-modal-close data-app-enable-back-key="true"><span class="c-btn__inner">Close</span></a>\n        </div>\n    </div>\n</div>\n'
        }
        return __p
    }
}), define("ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionApplied", ["underscore", "jquery", "backbone", "scenes/mission/Api", "lib/ModalBase", "templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionApplied", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.models = e.models, this.renderContent(s, {
                models: this.models
            }), this.setupComponents()
        },
        onClickModalClose: function() {
            FF.modalStack.popAll()
        },
        setupComponents: function() {
            this._freescroll = new o({
                el: t("[data-ui-freescroll-for-real-incentive-applied]")
            }), this._scrollbar = new u({
                el: t("[data-ui-scrollbar-for-real-incentive-applied]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("ww/scenes/common/config/ShareCampaign", ["lib/TextMaster"], function(e) {
    return {
        campaigns: {
            defaultInGameService: function(e) {
                return "Dummy Share Text for [" + e + "]. Please Implement"
            },
            realIncentiveMission: function(t, n) {
                return e.getInstance().get("ww_real_incentive_mission_share_" + n)
            }
        }
    }
}), define("ww/scenes/common/util/ShareHelper", ["underscore", "jquery", "lib/ClassBase", "scenes/friend_invite/views/ModalInviteFacebook", "scenes/friend_invite/views/ModalInviteGooglePlus", "ww/scenes/common/config/ShareCampaign"], function(e, t, n, r, i, s) {
    return n.extend({
        initialize: function(e) {
            this.inGameService = e.inGameService, n.prototype.initialize.call(this)
        },
        onClickShareDeferred: function(e, n) {
            this.d = t.Deferred(), this.campaignId = n;
            var s = t(e.target).attr("data-app-sns-share");
            FF.router.loading.hide();
            if (s === "facebook" || s === "fb_messenger") {
                var o = new r;
                o.render(), o.on("onClickGoFacebook", this.onClickGoFacebook, this), FF.router.overlay.registerChildren(o), o.open()
            } else if (s === "googleplus" && FF.env.isIOS()) {
                var u = new i;
                u.render(), u.on("onClickGoGooglePlus", this.onClickGoGooglePlus, this), FF.router.overlay.registerChildren(u), u.open()
            } else s === "other" ? this._callGenericShare(s) : (this._onPost(s), this.d.resolve());
            return this.d.promise()
        },
        postingTitle: {
            mail: "【FINAL FANTASY Record Keeper】"
        },
        getPostingText: function(e) {
            var t = s.campaigns[this.inGameService] || s.campaigns.defaultInGameService;
            return t(e, this.campaignId)
        },
        _onPost: function(e) {
            var t = this,
                n = kickmotor.nativefn.getNativeOS();
            return (e === "facebook" || e === "fb_messenger" || e === "googleplus" && n === "ios") && kickmotor.nativefn.call("setPasteboard", {
                text: t.getPostingText(e)
            }), n === "ios" ? t._postMessageUsingOS(e, function() {
                t._postMessageUsingURLScheme(e)
            }) : n === "android" && t._postMessageUsingIntent(e, function() {
                t._postMessageUsingURLScheme(e)
            }), !1
        },
        _postMessageUsingOS: function(e, n) {
            var r = this,
                i = kickmotor.nativefn.autoUnregisterCallback(function(i) {
                    var s = {
                        service: e,
                        text: r.getPostingText(e)
                    };
                    e === "twitter" && i.isTwitterAvailable ? (s.callback = "" + t.nativefn.autoUnregisterCallback(t.noop), kickmotor.nativefn.call("postToSocialService", s)) : n()
                });
            kickmotor.nativefn.call("checkSocialService", {
                callback: "" + i
            })
        },
        _postMessageUsingIntent: function(e, n) {
            var r = this,
                i = {
                    facebook: "com.facebook.katana",
                    fb_messenger: "com.facebook.orca",
                    twitter: "com.twitter.android",
                    googleplus: "com.google.android.apps.plus",
                    whatsapp: "com.whatsapp"
                },
                s = t.nativefn.autoUnregisterCallback(function(t) {
                    var s;
                    i[e] && t[i[e]] ? (s = {
                        text: r.getPostingText(e),
                        packageName: i[e]
                    }, kickmotor.nativefn.call("intentShare", s)) : n()
                }),
                o = i[e] || "",
                u = {
                    packageName1: o,
                    packageName2: "",
                    callback: "" + s
                };
            kickmotor.nativefn.call("checkInstalled", u)
        },
        _postMessageUsingURLScheme: function(e) {
            var n = this,
                r, i;
            if (e === "facebook") r = "fb://feed", i = "http://m.facebook.com/";
            else if (e === "fb_messenger") r = "fb-messenger://compose", i = "http://m.facebook.com/messages/";
            else if (e === "twitter") r = "twitter://post?" + n._encodeParam({
                message: n.getPostingText(e)
            }), i = "http://twitter.com/intent/tweet?" + n._encodeParam({
                text: n.getPostingText(e)
            });
            else if (e === "mail") r = "mailto:?" + n._encodeParam({
                subject: n.postingTitle[e],
                body: n.getPostingText(e)
            }), i = r;
            else if (e === "line") {
                var s = t.nativefn.getNativeOS();
                r = "http://line.naver.jp/R/msg/text/?" + encodeURI(n.getPostingText(e)), i = r
            } else if (e === "googleplus") {
                r = "gplus://share?" + n._encodeParam({
                    message: n.getPostingText(e)
                });
                var o = FF.Config.server.baseUrl + FF.Config.server.invitePathMap[e] + "?" + this.invite_id;
                i = "https://plus.google.com/share?url=" + encodeURI(o)
            } else e === "whatsapp" && (r = "whatsapp://send?" + n._encodeParam({
                text: n.getPostingText(e)
            }), i = null);
            var u = kickmotor.nativefn.autoUnregisterCallback(function(t) {
                t.canOpen ? kickmotor.nativefn.call("openExternalURL", {
                    url: r
                }) : i ? kickmotor.nativefn.call("openExternalURL", {
                    url: i
                }) : n._callGenericShare(e)
            });
            kickmotor.nativefn.call("canOpenExternalURL", {
                url: r,
                callback: "" + u
            })
        },
        _callGenericShare: function(e) {
            var t = this;
            if (FF.env.isAndroid()) {
                var n = {
                    text: t.getPostingText(e),
                    packageName: ""
                };
                kickmotor.nativefn.call("intentShare", n), t.d.resolve()
            } else FF.env.isIOS() && kickmotor.iosgamecenter.checkiOS8Share(function(n) {
                n.enabled ? kickmotor.iosgamecenter.startiOS8Share(t.getPostingText(e), function() {
                    FF.router.loading.hide(), t.d.resolve()
                }, !0) : (kickmotor.nativefn.call("setPasteboard", {
                    text: t.getPostingText("facebook")
                }), t.d.resolve())
            })
        },
        canGenericShare: function() {
            return FF.env.isAndroid() || FF.env.isIOSVersionGreaterThanOrEqualTo(8, 0) && this._canShareWithoutScreenshot()
        },
        _canShareWithoutScreenshot: function() {
            return kickmotor.nativefn.getAppVersion() >= 406
        },
        _canJumpToBrowser: function() {
            return kickmotor.nativefn.getAppVersion() >= 406
        },
        getDefaultEnabledShareSettings: function() {
            var t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !0,
                line: !0,
                googleplus: !1,
                whatsapp: !1,
                other: !1
            };
            return t = {
                twitter: !0,
                facebook: !0,
                fb_messenger: !1,
                mail: !1,
                line: !1,
                googleplus: !this.canGenericShare(),
                whatsapp: !0,
                other: this.canGenericShare()
            }, e.keys(t).filter(function(e) {
                return t[e]
            })
        },
        _encodeParam: function(e) {
            return t.param(e).replace(/\+/g, "%20").replace(/'/g, "%27")
        },
        onClickGoFacebook: function() {
            this._onPost("facebook"), this.d.resolve()
        },
        onClickGoGooglePlus: function() {
            this._onPost("googleplus"), this.d.resolve()
        }
    })
}), define("ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", ["underscore", "jquery", "scenes/mission/Api", "lib/ModalBase", "templates_ww/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", "components/FreeScroll", "components/Scrollbar", "ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionApplied", "ww/scenes/common/util/ShareHelper"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-modal-real-incentive-apply]": "onClickRealIncentiveApply",
            "anchorsbeforejump [data-app-sns-share]": "onClickRealIncentiveSNSShare",
            "anchorsbeforejump [data-app-external-url]": "onClickExternalUrl"
        },
        initialize: function() {
            this._shareHelper = new a({
                inGameService: "realIncentiveMission"
            }), r.prototype.initialize.call(this)
        },
        render: function(e) {
            this.models = e.models, this.renderContent(i, {
                models: this.models,
                enabledServices: this._getEnabledShareSettings()
            }), this.setupComponents()
        },
        onClickCancel: function(e) {
            FF.modalStack.pop()
        },
        onClickRealIncentiveApply: function(e) {
            var n = this;
            if (!FF.router.loading.lock()) return;
            var r = t(e.target),
                i = r.attr("data-app-modal-real-incentive-apply");
            this.trigger("applyExecuteDeferred", i)
        },
        onClickRealIncentiveSNSShare: function(e) {
            if (this.hasShared === !0) return;
            this.hasShared = !0;
            var n = this;
            if (!FF.router.loading.lock()) return;
            var r = t(e.target).attr("data-app-modal-real-incentive-mission");
            this._shareHelper.onClickShareDeferred(e, r).always(function() {
                n.trigger("applyExecuteDeferred", r, {
                    withSNSShare: !0
                })
            })
        },
        setupComponents: function() {
            this._freescroll = new s({
                el: t("[data-ui-freescroll-for-real-incentive-confirm]")
            }), this._scrollbar = new o({
                el: t("[data-ui-scrollbar-for-real-incentive-confirm]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _getEnabledShareSettings: function() {
            var t = {
                twitter: !0,
                facebook: !0,
                mail: !1,
                line: !1,
                googleplus: !0,
                whatsapp: !1,
                other: this._shareHelper.canGenericShare()
            };
            return e.keys(t).filter(function(e) {
                return t[e]
            })
        },
        onClickExternalUrl: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), this._shareHelper && this._shareHelper.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/pages/List", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/TextMaster", "scenes/common/helper/MissionHelper", "scenes/common/views/OverScrollView", "scenes/mission/Api", "templates/mission/Mission", "templates/mission/views/MissionList", "./Page", "scenes/mission/views/ModalMissionRewardReceived", "scenes/mission/views/ModalError", "ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionConfirm", "ww/scenes/real_incentive_mission/views/ModalRealIncentiveMissionApplied"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        DISABLE_CLASS_NAME: "di-n",
        CURRENT_CLASS_NAME: "is-current",
        INITIAL_CATEGORY: 1
    };
    return l.extend({
        events: {
            "anchorsbeforejump [data-app-tab-small] li": "onClickTabSmall",
            "anchorsbeforejump [data-app-mission-detail]": "onClickDetail",
            "anchorsbeforejump [data-app-mission-receive-all-reward]": "onClickReceiveAllReward",
            "anchorsbeforejump [data-app-real-incentive-apply-confirm]": "onClickRealIncentiveApplyConfirm",
            "anchorsbeforejump [data-app-real-incentive-apply-with-sns-share-confirm]": "onClickRealIncentiveApplyWithSNSShareConfirm",
            "anchorsbeforejump [data-app-external-url]": "onClickExternalUrl",
            "anchorsbeforejump #missionIntro": "onClickIntro"
        },
        initialize: function(e) {
            l.prototype.initialize.call(this, e), this.currentCategory = this._initialCategory || s.getMissionListCurrentCategory()
        },
        _listTmpl: f,
        _tmpl: a,
        _initialCategory: void 0,
        _introFragment: "#mission/intro",
        _detailFragment: "#mission/detail",
        render: function(e) {
            var t = FF.CONST.SERVER.MISSION.TYPE_OF,
                n = this._getTabBadgeText(t.BEGINNER),
                r = this._getTabBadgeText(t.NORMAL),
                i = this._getTabBadgeText(t.LIMITED_TIME),
                s = this._shouldShowNewOnTab(t.BEGINNER, n),
                o = this._shouldShowNewOnTab(t.NORMAL, r),
                u = this._shouldShowNewOnTab(t.LIMITED_TIME, i);
            l.prototype.render.call(this, this._tmpl, {
                beginnerTabBadgeText: n,
                normalTabBadgeText: r,
                limitedTimeTabBadgeText: i,
                showNewOnBeginnerTab: s,
                showNewOnNormalTab: o,
                showNewOnLimitedTimeTab: u,
                canReceiveAnyReward: FF.datastore.missionCollection.canReceiveAnyRewardByType(this.currentCategory)
            }), this.setCurrentCategory(), this.renderOverScrollView(), this.setupRenderList(), this._updateLastAccessOpenedAt()
        },
        _getTabBadgeText: function(e) {
            var t = FF.datastore.missionCollection.getRewardReceivableMissions({
                type: e
            }).length;
            return t ? "" + t : ""
        },
        _shouldShowNewOnTab: function(e, t) {
            return t ? !1 : this.currentCategory === e ? !1 : s.hasNewMission({
                type: e
            })
        },
        _updateLastAccessOpenedAt: function() {
            var e = this.currentCategory,
                t = FF.datastore.stash;
            if (!t.hasOwnProperty("missionTabConfirmedAtMap")) return;
            if (!t.missionTabConfirmedAtMap.hasOwnProperty(e)) return;
            var n = FF.datastore.missionCollection.getLatestMission(e);
            if (!n) return;
            var r = n.get("opened_at");
            if (t.missionTabConfirmedAtMap[e] >= r) return;
            u.confirmMissionListDeferred(e).done(function() {
                if (t.missionTabConfirmedAtMap[e] >= r) return;
                t.missionTabConfirmedAtMap[e] = r
            })
        },
        setCurrentCategory: function() {
            t("[data-app-tab-small] li").removeClass(v.CURRENT_CLASS_NAME), t('[data-app-tab-small-category="' + this.currentCategory + '"]').addClass(v.CURRENT_CLASS_NAME)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setupRenderList: function() {
            this.selectedModels = FF.datastore.missionCollection.getByTypeWithSorted(this.currentCategory), this.overScrollView.updateCollectionSize(this.selectedModels.length), this.overScrollView.setMaxPageText(), this._missionTypeConfirmedAt = FF.datastore.stash.missionTabConfirmedAtMap[this.currentCategory], this.renderCollectionList()
        },
        renderCollectionList: function() {
            var e = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > e && this.overScrollView.setCurrentPage(e), this._renderItems()
        },
        _showCommingSoon: function(t) {
            var n = FF.CONST.SERVER.MISSION.TYPE_OF;
            switch (this.currentCategory) {
                case n.BEGINNER:
                    return !1;
                default:
                case n.NORMAL:
                case n.LIMITED_TIME:
                    if (t > 0) return !1;
                    return e.every(this.selectedModels, function(e) {
                        return !e.isOpen() || !e.canChallenge()
                    })
            }
            return !1
        },
        _renderItems: function() {
            var n = this,
                i = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum(),
                o = this.selectedModels.length ? this.selectedModels.slice(i, s) : [],
                u = {};
            e.each(o, function(e) {
                u[e.get("id")] = e.isNew(n._missionTypeConfirmedAt)
            });
            var a = this._showCommingSoon(i),
                f = r.process(this._listTmpl, {
                    showCommingSoon: a,
                    models: o,
                    missionIdToNewMap: u,
                    isAnimationAvailable: !FF.env.isIOS6_x() && !FF.env.isAndroid()
                }),
                l = t("[data-app-list-items]");
            this.overScrollView.render({
                html: f,
                parentElement: l,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _updateAfterReceivedDeferred: function() {
            var e = t.Deferred();
            return this.overScrollView.cleanup(), this.setupRenderList(), this._updateAllReceiveButton(), this.overScrollView.setIsScrollableIfSinglePage(), setTimeout(function() {
                e.resolve()
            }, 0), e.promise()
        },
        onClickTabSmall: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = t(e.target).attr("data-app-tab-small-category");
            this.currentCategory = +n, this.setCurrentCategory(), this.overScrollView.cleanup(), this.setupRenderList(), this.overScrollView.setIsScrollableIfSinglePage(), this.stashCurrentTabCategory(), this._updateLastAccessOpenedAt(), this._updateTabBadge(), this._updateAllReceiveButton(), FF.router.loading.unlock()
        },
        onClickIntro: function(e) {
            FF.router.loading.lock();
            var t = this._introFragment;
            n.history.navigate(t, {
                trigger: !0
            })
        },
        stashCurrentTabCategory: function() {
            s.saveMissionListCurrentCategoryDeferred(this.currentCategory)
        },
        onClickDetail: function(e) {
            var r = this;
            if (!FF.router.loading.lock()) return;
            var i = t(e.target),
                o = i.attr("data-app-mission-detail"),
                a = FF.datastore.missionCollection.get(o);
            if (a.isWaitingReceiveReward()) u.receiveRewardDeferred(o).then(function(e) {
                return FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(e), t.Deferred().resolve().promise()
            }).then(r._updateAfterReceivedDeferred.bind(r)).done(function() {
                r._openModalMissionRewardReceived([a])
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            });
            else if (a.isRealIncentive() && !a.isAchieved()) u.checkAndAchieveMissionDeferred(o).then(function(e) {
                FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(e), r._updateAfterReceivedDeferred(), s.saveAchievedMissionsDeferred(e.achieved_missions)
            }).then(function(e) {
                s.openModalMissionClearIfNeedDeferred()
            }).done(function() {
                var e = FF.datastore.missionCollection.get(o);
                FF.router.loading.hide();
                if (!e.isAchieved()) {
                    var t = r._detailFragment + "/" + o;
                    n.history.navigate(t, {
                        trigger: !0
                    })
                }
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            });
            else {
                var f = this._detailFragment + "/" + o;
                n.history.navigate(f, {
                    trigger: !0
                })
            }
        },
        onClickRealIncentiveApplyConfirm: function(e) {
            var n = t(e.target),
                r = n.attr("data-app-real-incentive-apply-confirm");
            this._openModalRealIncentiveMissionApplyConfirm(r, {
                withSNSShare: !0
            })
        },
        onClickRealIncentiveApplyWithSNSShareConfirm: function(e) {
            var n = t(e.target),
                r = n.attr("data-app-real-incentive-apply-with-sns-share-confirm");
            this._openModalRealIncentiveMissionApplyConfirm(r, {
                withSNSShare: !0
            })
        },
        _realIncentiveApplyExecuteDeferred: function(e, n) {
            var r = this;
            u.applyForRealIncentiveDeferred(e, n).then(function(e) {
                return FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(e), t.Deferred().resolve().promise()
            }).then(r._updateAfterReceivedDeferred.bind(r)).done(function() {
                r._openModalRealIncentiveMissionApplied(e, n)
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            })
        },
        _openModalRealIncentiveMissionApplyConfirm: function(e, t) {
            var n = this,
                r = FF.datastore.missionCollection.get(e);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    FF.router.loading.hide(), n.listenTo(e, "applyExecuteDeferred", n._realIncentiveApplyExecuteDeferred), e.render({
                        models: [r]
                    })
                }
            })
        },
        _openModalRealIncentiveMissionApplied: function(e, t) {
            var n = this,
                r = FF.datastore.missionCollection.get(e);
            FF.modalStack.push(d, {
                renderer: function(e) {
                    FF.router.loading.hide(), e.render({
                        models: [r]
                    })
                }
            })
        },
        onClickReceiveAllReward: function(n) {
            var r = this;
            if (!FF.router.loading.lock()) return;
            if (!FF.datastore.missionCollection.canReceiveAnyRewardByType(this.currentCategory)) {
                FF.router.loading.hide();
                return
            }
            var i = null;
            u.receiveRewardAllDeferred(this.currentCategory).then(function(n) {
                return FF.datastore.clearHasPartyAllData(), r._updateFFDatastore(n), i = FF.datastore.missionCollection.getModels(e.map(n.missions, function(e) {
                    return e.id
                })), t.Deferred().resolve().promise()
            }).then(r._updateAfterReceivedDeferred.bind(r)).done(function() {
                r._openModalMissionRewardReceived(i)
            }).fail(function(e) {
                FF.router.loading.hide(), r._openModalError(e)
            })
        },
        onClickExternalUrl: function(e) {
            var n = t(e.target).attr("data-app-external-url");
            kickmotor.platform.canOpenExternalURL(n, function(e) {
                if (!e.canOpen) throw new Error("invalid url:" + n);
                kickmotor.platform.openExternalURL(n)
            })
        },
        _openModalMissionRewardReceived: function(t) {
            var n = this,
                r = e.any(t, function(e) {
                    return e.hasRemapGrowEgg()
                });
            FF.modalStack.push(c, {
                renderer: function(e) {
                    FF.router.loading.hide(), e.render({
                        models: t,
                        hasRemapGrowEgg: r
                    })
                },
                onPop: function() {
                    n._updateTabBadge()
                }
            })
        },
        _updateTabBadge: function() {
            var e = FF.CONST.SERVER.MISSION.TYPE_OF,
                t = this._getTabBadgeText(e.BEGINNER),
                n = this._getTabBadgeText(e.NORMAL),
                r = this._getTabBadgeText(e.LIMITED_TIME);
            this._setTabBadgeText(e.BEGINNER, t), this._setTabBadgeText(e.NORMAL, n), this._setTabBadgeText(e.LIMITED_TIME, r)
        },
        _showElem: function(e) {
            e.removeClass(v.DISABLE_CLASS_NAME)
        },
        _hideElem: function(e) {
            e.addClass(v.DISABLE_CLASS_NAME)
        },
        _setTabBadgeText: function(e, n) {
            var r = t('[data-app-badge-text="' + e + '"]');
            n ? (this._showElem(r), r.text(n)) : this._hideElem(r);
            var i = t('[data-app-new-badge="' + e + '"]');
            this._shouldShowNewOnTab(e, n) ? this._showElem(i) : this._hideElem(i)
        },
        _updateFFDatastore: function(n) {
            FF.datastore.itemPossessionLimitCollection.reset(e.values(n.item_possession_limit)), FF.datastore.userModel.set(n.user), FF.datastore.missionCollection.add(n.missions, {
                merge: !0
            }), t(document).trigger("updateBadge")
        },
        _openModalError: function(e) {
            FF.modalStack.push(h, {
                renderer: function(t) {
                    FF.router.loading.hide(), t.render(e)
                }
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        _updateAllReceiveButton: function() {
            var e = FF.datastore.missionCollection.canReceiveAnyRewardByType(this.currentCategory);
            e ? t("[data-app-mission-receive-all-reward]").removeClass("is-disable") : t("[data-app-mission-receive-all-reward]").addClass("is-disable")
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), l.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/views/MissionDetailByType", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/mission/views/BuddyLevelUp", "templates/mission/views/PushNotification", "templates/mission/views/ClearDungeon", "templates/mission/views/Gacha", "templates/mission/views/ClearDungeonByType", "templates/mission/views/EnhanceEquipment", "templates/mission/views/EvolveEquipment", "templates/mission/views/GenerateAbility", "templates/mission/views/UpgradeAbility", "templates/mission/views/GetBuddy", "templates/mission/views/LoginBonus"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    return n.View.extend({
        initialize: function() {
            var e = FF.CONST.SERVER.MISSION.ACHIEVE_TYPE_OF;
            this.tmplMap = {}, this.tmplMap[e.BUDDY_LEVEL] = i, this.tmplMap[e.PUSH_NOTIFICATION] = s, this.tmplMap[e.CLEAR_SPECIFIC_DUNGEON] = o, this.tmplMap[e.GACHA] = u, this.tmplMap[e.CLEAR_DUNGEON_BY_TYPE] = a, this.tmplMap[e.ENHANCE] = f, this.tmplMap[e.EVOLVE] = l, this.tmplMap[e.ABILITY_GENERATE] = c, this.tmplMap[e.ABILITY_UPGRADE] = h, this.tmplMap[e.EXCHANGE_SHOP] = p, this.tmplMap[e.LOGIN] = d
        },
        render: function(e) {
            var n = e.model,
                i = this._getTmpl(n),
                s = r.process(i, {
                    model: n
                });
            t("[data-app-achieve-type-container]").html(s)
        },
        _getTmpl: function(e) {
            var t = e.get("achieve_cond_type"),
                n = this.tmplMap[t];
            if (!n) throw "unexpected achieve cond type(" + t + ")";
            return n
        }
    })
}), define("scenes/common/views/ModalDungeonInfo", ["underscore", "jquery", "backbone", "util", "templates/common/ModalDungeonInfo", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "components/Tab"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
            BOSS: "boss",
            PRIZE: "prize",
            PROLOGUE: "prologue"
        },
        l = {
            ON_CHALLENGE: "onChallenge",
            ON_CLOSE: "onClose"
        };
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-challenge]": "onClickChallenge"
        },
        initialize: function(e) {
            this.dungeonModel = e.dungeonModel, this.selectedType = e.selectedType || f.PRIZE, this.enableChallengeButton = e.enableChallengeButton || !1
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        render: function(t) {
            this.renderContent(this._getTmpl(), e.extend({
                util: r,
                dungeonModel: this.dungeonModel,
                selectedType: this.selectedType,
                enableTab: this._enableTab(),
                enableChallengeButton: this.enableChallengeButton
            }, t)), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t('[data-ui-freescroll="dungeon-info"]')
            }), this.scrollbar = new u({
                el: t('[data-ui-scrollbar="dungeon-info"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this._enableTab() && (this.panes = t('[data-ui-group="dungeon-info-pane"]'), this.tab = new a({
                tabs: t('[data-ui-group="dungeon-info-tab"]'),
                panes: this.panes,
                className: "is-current",
                defaultPage: this._getIndexByTabName(this.selectedType)
            }), this.tabOnChangedState(), this.listenTo(this.tab, "changedState", this.tabOnChangedState))
        },
        _getIndexByTabName: function(n) {
            var r = 0;
            return e.each(this.panes, function(e, i) {
                t(e).attr("data-ui-tab-name") === n && (r = i)
            }), r
        },
        tabOnChangedState: function() {
            e.each(this.panes, function(e) {
                var n = t(e);
                n.hasClass("is-current") ? n.removeClass("di-n") : n.addClass("di-n")
            }), this.freescroll.reset(), this.freescroll.updateContent(), this.scrollbar.updateContentWithScrollReset()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem(), this.trigger(l.ON_CLOSE)
        },
        onClickChallenge: function() {
            FF.router.loading.lock(), this.trigger(l.ON_CHALLENGE)
        },
        _enableTab: function() {
            return this.dungeonModel.hasCaptures() || this.dungeonModel.hasPrologue()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.panes && (this.panes = null), this.tab && this.tab.dispose(), s.prototype.dispose.call(this)
        },
        _getTmpl: function() {
            return i
        }
    }, {
        EVENT: l,
        SELECTED_TYPE_OF: f
    })
}), define("scenes/common/helper/DungeonInfo", ["jquery", "underscore", "scenes/dungeon/Api", "scenes/common/views/ModalDungeonInfo"], function(e, t, n, r) {
    return {
        openDeferred: function(e, t) {
            var n = this;
            return this._setupDeferred(e, t).then(function(e) {
                n._openModal(e, t)
            })
        },
        _setupDeferred: function(t, r) {
            var i = e.Deferred();
            if (r.dungeonModel) return i.resolve(r.dungeonModel).promise();
            var s = FF.datastore.dungeonCollection.get(t);
            return s ? i.resolve(s).promise() : (n.dungeonInfoDeferred(t).then(function(e) {
                FF.datastore.dungeonCollection.add(e.dungeons, {
                    merge: !0
                }), s = FF.datastore.dungeonCollection.get(t), i.resolve(s)
            }), i.promise())
        },
        _openModal: function(e, n) {
            var r = this;
            FF.modalStack.push(this._getModalClass(e), {
                initializer: function(i) {
                    var s = new i(t.extend(n, {}, {
                        dungeonModel: e
                    }));
                    return n.enableChallengeButton && r._bindOnChallenge(s, n.onChallenge || r._onChallenge), n.onClose && r._bindOnClose(s, n.onClose), s
                },
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        _bindOnChallenge: function(e, t) {
            Backbone.Events.listenToOnce(e, r.EVENT.ON_CHALLENGE, function() {
                t(e.dungeonModel)
            })
        },
        _bindOnClose: function(e, t) {
            Backbone.Events.listenToOnce(e, r.EVENT.ON_CLOSE, function() {
                t()
            })
        },
        _onChallenge: function(e) {
            FF.modalStack.popAll();
            var t = e.getWorldModel();
            Backbone.history.navigate(t.getDungeonDetailFragment(e.get("id"), "party"), {
                trigger: !0
            })
        },
        challengeDungeon: function(e) {
            this._onChallenge(e)
        },
        _getModalClass: function(e) {
            var t = e.getWorldModel();
            return t.isNormalWorld() ? r : t.getEventModel().getHelper().getDungeonInfoModalClass()
        }
    }
}), define("scenes/mission/pages/Detail", ["underscore", "jquery", "backbone", "lib/TextMaster", "scenes/mission/Api", "components/FreeScroll", "components/Scrollbar", "templates/mission/MissionDetail", "scenes/mission/views/MissionDetailByType", "scenes/common/helper/DungeonInfo", "./Page"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return l.extend({
        contentType: "BASE",
        designType: "MODERN",
        initialize: function(e) {
            var t = e.args[0];
            this.model = FF.datastore.missionCollection.get(t), l.prototype.initialize.call(this, e)
        },
        events: {
            "anchorsbeforejump [data-app-btn-move-to]": "onClickMoveTo"
        },
        render: function(e) {
            var t = this.model.canMoveTo(),
                n = r.getInstance().safeGet(this.model.getMoveToLabel());
            l.prototype.render.call(this, u, {
                model: this.model,
                canMoveTo: t,
                moveToText: n
            }), this.renderAchieveTypeTmpl(), this.setupComponents(), FF.router.loading.hide()
        },
        renderAchieveTypeTmpl: function() {
            var e = new a;
            e.render({
                model: this.model
            })
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickMoveTo: function() {
            if (this.model.isAchieveTypeClearSpecificDungeon()) f.openDeferred(this.model.getTargetDungeonId(), {
                enableChallengeButton: !0
            });
            else {
                var e = this.model.getFragment();
                e && n.history.navigate(e, {
                    trigger: !0
                })
            }
        },
        onClickBack: function() {
            n.history.navigate("#mission/list", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), l.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/pages/Intro", ["underscore", "jquery", "backbone", "scenes/mission/Api", "components/FreeScroll", "components/Scrollbar", "templates/mission/MissionIntro", "./Page"], function(e, t, n, r, i, s, o, u) {
    return u.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #missionBtn": "onClickMissionBtn",
            "anchorsbeforejump #questHistoryLink": "onClickQuestHistoryLink"
        },
        render: function(e) {
            u.prototype.render.call(this, o, {
                hasCompletedQuest: FF.datastore.questCollection.hasCompletedQuest()
            }), this.setupComponents(), FF.router.loading.hide()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            n.history.fragment = "", n.history.navigate("#mission/list", {
                trigger: !0
            })
        },
        onClickMissionBtn: function(e) {
            if (!FF.router.loading.lock()) return;
            var t = "#mission/list";
            n.history.fragment = "", n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickQuestHistoryLink: function(e) {
            FF.logger.debug("onClickQuestHistoryLink"), FF.router.loading.lock();
            var t = "#quest/list";
            n.history.navigate(t, {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/mission/MissionScene", ["underscore", "jquery", "backbone", "lib/Scene", "./Api", "./pages/List", "./pages/Detail", "./pages/Intro"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        pages: {
            list: s,
            detail: o,
            intro: u
        },
        _isShowingIntroPage: !0,
        _canHaveNewBadgeIcon: !0,
        setupDeferred: function() {
            var e = t.Deferred();
            return i.getMissionListAndCheckDeferred().done(function(t) {
                FF.datastore.missionCollection.reset(t.missions, {
                    silent: !0
                }), FF.datastore.questCollection.reset(t.quests, {
                    silent: !0
                }), FF.datastore.stash.missionTabConfirmedAtMap = t.mission_tab_confirmed_at_map, FF.datastore.stash.isMissionFirstTime = t.is_mission_first_time, e.resolve(t)
            }), e.promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.playBgm(), n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e;
            FF.logger.debug("MissionScene: showPage: " + r, t);
            var i = FF.datastore.stash;
            this._isShowingIntroPage && i.isMissionFirstTime && (FF.logger.debug("this is first time visit, then show intro page."), r = "intro", i.isMissionFirstTime = !1), this.layoutPage && this.layoutPage.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in MissionScene. pageName: " + r);
            this.layoutPage = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutPage.setupDeferred().done(function() {
                n.layoutPage.render(t), n._canHaveNewBadgeIcon && (FF.datastore.stash.hasNewMission = !1)
            })
        },
        playBgm: function() {
            FF.SoundMgr.playMusic("bgm_07_051")
        }
    })
}), define("templates_ww/real_incentive_mission/Mission", [], function() {
    return function(a) {
        function print() {
            __p += __j.call(arguments, "")
        }
        a || (a = {});
        var b, __p = "",
            __e = _.escape,
            __j = Array.prototype.join;
        with(a) {
            __p += '<div class="c-layer-bg is-bg-type-home-lobby"></div>\n\n<div class="c-layer-content-1 scene-mission-top scene-ww-real-incentive">\n    <div class="s-freescroll-content">\n        <div class="c-freescroll-wrap">\n            <div class="c-freescroll" data-ui-freescroll>\n                <div data-app-list-chara-container>\n                    <ul data-app-list-items data-ui-freescroll-content>\n                        <!-- append views/MissionList.html -->\n                    </ul>\n                </div>\n                <div class="c-freescroll__scrollbar" data-ui-scrollbar><div class="c-freescroll__scrollbar-inner" data-ui-scrollbar-face></div></div>\n            </div>\n        </div>\n    </div>\n</div>\n\n<div class="c-layer-content-2 scene-mission-top scene-ww-real-incentive">\n    <div class="s-content-layout">\n        \n        <div class="ta-c">\n            \n            ';
            var c = "http://anniversary.finalfantasyrecordkeeper.com/sweepstakes/";
            __p += '\n            <div class="wrap-banner-image" data-app-external-url="' + __e(c) + '" data-mbgaui-anchors data-app-sound="choose">\n                <img src="' + __e(pUrl("/dff/static/img/category/real_quest/common/banner_campaign.png")) + '" width="288" height="80">\n            </div>\n        </div>\n    </div>\n</div>\n\n<div class="c-layer-content-11 scene-mission-top scene-ww-real-incentive">\n    <h1 class="c-ttl-scene">\n        <span class="c-ttl-scene__inner">Sweepstakes Mission</span>\n        <div class="s-ww-deshi"></div>\n    </h1>\n    <a class="c-btn-back img-rep" data-app-btn-back data-mbgaui-anchors data-app-sound="choose" data-app-eliminate-onfocus>戻る</a>\n</div>\n'
        }
        return __p
    }
}), define("ww/scenes/real_incentive_mission/pages/List", ["scenes/mission/pages/List", "templates_ww/real_incentive_mission/Mission"], function(e, t) {
    return e.extend({
        _tmpl: t,
        _initialCategory: 4,
        _introFragment: "#real_incentive_mission/intro",
        _detailFragment: "#real_incentive_mission/detail"
    })
}), define("ww/scenes/real_incentive_mission/pages/Detail", ["scenes/mission/pages/Detail"], function(e) {
    return e.extend({
        onClickBack: function() {
            Backbone.history.navigate("#real_incentive_mission/list", {
                trigger: !0
            })
        }
    })
}), define("ww/scenes/real_incentive_mission/RealIncentiveMissionScene", ["scenes/mission/MissionScene", "./pages/List", "./pages/Detail"], function(e, t, n) {
    return e.extend({
        pages: {
            list: t,
            detail: n
        },
        _isShowingIntroPage: !1,
        _canHaveNewBadgeIcon: !1
    })
}), define("ww/scenes/migration_info/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates_ww/migration_info/MigrationInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-link-account]": "linkAccount",
            "anchorsbeforejump [data-app-load-account]": "loadAccount",
            "anchorsbeforejump [data-app-modal-back]": "onClickBack"
        },
        render: function() {
            var e = {};
            i.prototype.render.call(this, s, e), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        linkAccount: function() {
            r.platform.linkAccount(function(e) {
                e.success ? FF.logger.debug("successfully linked account") : FF.logger.debug("failed to link account")
            })
        },
        loadAccount: function() {
            r.platform.loadAccount(function(e) {
                e.success ? FF.logger.debug("successfully loaded account") : FF.logger.debug("failed to load account")
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("ww/scenes/migration_info/MigrationInfoScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/migration_info/views/Layout", ["underscore", "jquery", "backbone", "kickmotor", "lib/LayoutBase", "templates/migration_info/MigrationInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-open-mobage-community]": "openMobageCommunity"
        },
        render: function() {
            var e = {};
            i.prototype.render.call(this, s, e), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openMobageCommunity: function() {
            r.platform.showCommunity()
        },
        onClickBack: function() {
            n.history.navigate("#global_menu", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/migration_info/MigrationInfoScene", ["underscore", "jquery", "backbone", "./views/Layout", "lib/Scene"], function(e, t, n, r, i) {
    return i.extend({
        setupDeferred: function() {},
        start: function() {
            this.layoutView = new r, this.layoutView.render()
        }
    })
}), define("scenes/quest/pages/Page", ["underscore", "jquery", "backbone", "scenes/quest/Api", "lib/LayoutBase"], function(e, t, n, r, i) {
    var s = {
        CURRENT_TAB_CATEGORY: "questCurrentTabCategory",
        CURRENT_PAGE_INDEX: "questCurrentPageIndex",
        HAS_CHALLENGED_QUEST: "hasChallengedQuest",
        OVER_SCROLL_HEIGHT: "questOverScrollHeight"
    };
    return i.extend({
        categoryType: "home",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        initialize: function(t) {
            i.prototype.initialize.call(this), t = e.isObject(t) ? t : {}, this.scene = t.scene
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        },
        render: function(e, t) {
            i.prototype.render.call(this, e, t)
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this)
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    }, {
        DATASTORE_KEY: s
    })
}), define("scenes/quest/pages/Layout", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/OverScrollView", "templates/quest/Quest", "templates/quest/views/QuestList", "./Page", "scenes/common/collections/Quest"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        ACHIEVE_TYPE_NAMES: ["ABILITY_GENERATE", "ABILITY_UPGRADE", "BUDDY_LEVEL", "CLEAR_DUNGEON", "ENHANCE", "EVOLVE", "FRIEND_INVITE", "GACHA", "GET_ITEM"],
        CURRENT_CLASS_NAME: "is-current"
    };
    return u.extend({
        contentType: "BASE",
        designType: "MODERN",
        funcTutorialKey: "QUEST",
        isTutorialIllustOnly: !0,
        CONST: f,
        initialCategory: "completed",
        DATASTORE_KEY: u.DATASTORE_KEY,
        events: {
            "anchorsbeforejump [data-app-quest-detail]": "onClickDetail"
        },
        initialize: function(e) {
            this.questCollection = FF.datastore.questCollection, this.selectedModels = [], this.initCurrentCategory(), u.prototype.initialize.call(this, [e])
        },
        initCurrentCategory: function() {
            this.currentCategory = this.initialCategory
        },
        stashCurrentTabCategory: function() {
            FF.datastore.stash[this.DATASTORE_KEY.CURRENT_TAB_CATEGORY] = this.currentCategory
        },
        render: function(e) {
            u.prototype.render.call(this, s, {
                allQuestNum: FF.datastore.stash.allQuestMasterNum,
                challengedQuestNum: this.questCollection.getChallengingQuestNum(),
                completedQuestNum: this.questCollection.getCompletedQuestNum(),
                maxOrders: FF.CONST.SERVER.QUEST.MAX_ORDERS
            }), this.setCurrentCategory(), this.renderNewBadge(), this.renderOverScrollView(e), this.setCurrentPageToOverScrollView(e), this.setupRenderList()
        },
        processAfterContentLoad: function() {
            u.prototype.processAfterContentLoad.call(this), this.renderToastMessageIfNeed()
        },
        renderToastMessageIfNeed: function() {
            var e = this;
            FF.datastore.stash[this.DATASTORE_KEY.HAS_CHALLENGED_QUEST] && (this.listenToOnce(this.overScrollView, "scrollchange", function() {
                FF.router.toast.eatAll()
            }), this.openToastMessage(), delete FF.datastore.stash[this.DATASTORE_KEY.HAS_CHALLENGED_QUEST])
        },
        openToastMessage: function() {
            FF.router.toast.topping(t("#toast-message-challenged").text()).bake()
        },
        setCurrentCategory: function() {
            t("[data-app-tab-small] li").removeClass(f.CURRENT_CLASS_NAME), t('[data-app-tab-small-category="' + this.currentCategory + '"]').addClass(f.CURRENT_CLASS_NAME)
        },
        renderNewBadge: function() {
            var e = this.questCollection.hasNewNormalQuest(),
                n = this.questCollection.hasNewSpecialQuest();
            e ? t('[data-app-tab-small-category="normal"] [data-app-new-badge]').removeClass("di-n") : t('[data-app-tab-small-category="normal"] [data-app-new-badge]').addClass("di-n"), n ? t('[data-app-tab-small-category="special"] [data-app-new-badge]').removeClass("di-n") : t('[data-app-tab-small-category="special"] [data-app-new-badge]').addClass("di-n")
        },
        renderOverScrollView: function(e) {
            var n = 0;
            e && typeof + e[0] == "number" && FF.datastore.stash.hasOwnProperty(this.DATASTORE_KEY.QUEST_OVER_SCROLL_HEIGHT) && (n = FF.datastore.stash[this.DATASTORE_KEY.QUEST_OVER_SCROLL_HEIGHT], delete FF.datastore.stash[this.DATASTORE_KEY.QUEST_OVER_SCROLL_HEIGHT]), this.overScrollView = new i({
                displayType: "TILE",
                startUp: n,
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setCurrentPageToOverScrollView: function(e) {
            e && typeof + e[0] == "number" && this.overScrollView.setCurrentPage(e), delete FF.datastore.stash[this.DATASTORE_KEY.CURRENT_PAGE_INDEX]
        },
        setupRenderList: function() {
            this.selectedModels = this.questCollection.getCompletedQuest(), this.overScrollView.updateCollectionSize(this.selectedModels.length), this.overScrollView.setMaxPageText(), this.renderCollectionList()
        },
        renderCollectionList: function() {
            var e = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > e && this.overScrollView.setCurrentPage(e), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this.selectedModels.length ? this.selectedModels.slice(e, n) : [],
                s = r.process(o, {
                    models: i,
                    currentCategory: this.currentCategory
                }),
                u = t("[data-app-list-items]");
            this.overScrollView.render({
                html: s,
                parentElement: u,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        stashCurrentOverScrollViewPos: function() {
            FF.datastore.stash[this.DATASTORE_KEY.CURRENT_PAGE_INDEX] = this.overScrollView.getCurrentPage(), FF.datastore.stash[this.DATASTORE_KEY.OVER_SCROLL_HEIGHT] = this.overScrollView.overscrollable.getCurrentScroll()
        },
        onClickDetail: function(e) {
            FF.router.loading.lock();
            var r = t(e.target),
                i = r.attr("data-app-quest-detail");
            this.stashCurrentOverScrollViewPos(), this.stashCurrentTabCategory();
            var s = "#quest/detail/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#mission/intro", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/quest/views/QuestDetailByType", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "util", "templates/quest/views/abilityGenerate", "templates/quest/views/abilityUpgrade", "templates/quest/views/buddyLevelUp", "templates/quest/views/clearDungeon", "templates/quest/views/enhance", "templates/quest/views/evolve", "templates/quest/views/friendInvite", "templates/quest/views/gacha", "templates/quest/views/getItem", "templates/quest/views/tutorial/abilityGenerate", "templates/quest/views/tutorial/abilityUpgrade", "templates/quest/views/tutorial/buddyLevelUp", "templates/quest/views/tutorial/clearDungeon", "templates/quest/views/tutorial/enhance", "templates/quest/views/tutorial/evolve", "templates/quest/views/tutorial/friendInvite", "templates/quest/views/tutorial/gacha", "templates/quest/views/tutorial/getItem"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S) {
    return n.View.extend({
        render: function(e) {
            this.model = e.model, this.setupTmplMap(), this.getTmpl();
            var n = this.getTmpl(),
                i = r.process(n, {
                    model: this.model
                });
            t("[data-app-achieve-type-container]").html(i)
        },
        setupTmplMap: function() {
            this.tmplMap = {
                enhance: f,
                evolve: l,
                getItem: p,
                clearDungeon: a,
                buddyLevel: u,
                abilityGenerate: s,
                abilityUpgrade: o,
                gacha: h,
                friendInvite: c
            }, this.tutorialTmplMap = {
                enhance: y,
                evolve: b,
                getItem: S,
                clearDungeon: g,
                buddyLevel: m,
                abilityGenerate: d,
                abilityUpgrade: v,
                gacha: E,
                friendInvite: w
            }
        },
        getTmpl: function() {
            var e = this.model.get("achieve_type_name"),
                t = this.model.get("is_tutorial");
            if (!FF.CONST.SERVER.QUEST.ACHIEVE_TYPE_OF[e]) return;
            var n = i.camelize(e, {
                forceLower: !0
            });
            return t ? this.tutorialTmplMap[n] : this.tmplMap[n]
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/quest/views/ModalCancel", ["underscore", "jquery", "backbone", "scenes/quest/Api", "templates/quest/views/ModalCancel", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onEnd"
        },
        render: function(e) {
            this.renderContent(i, {
                model: e.model,
                isConfirm: e.isConfirm
            })
        },
        onClickCancel: function() {
            this.trigger("onClickCancel"), this.end()
        },
        onClickDecide: function() {
            this.trigger("onClickDecide"), this.end(!0)
        }
    })
}), define("scenes/quest/views/ModalError", ["underscore", "jquery", "backbone", "scenes/common/util/ErrorHandler", "scenes/quest/Api", "templates/quest/views/ModalError", "lib/ModalBase"], function(e, t, n, r, i, s, o) {
    return o.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onEnd",
            "anchorsbeforejump [data-app-btn-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide"
        },
        initialize: function(e) {
            o.prototype.initialize.call(this), this._errorType = e.errorType, this._quest = e.questModel
        },
        render: function() {
            this.renderContent(s, {
                errorType: this._errorType
            })
        },
        onEnd: function() {
            var e = FF.CONST.SERVER.ERROR,
                t = {};
            t[e.QUEST_MAX_CHALLENGE_NUM] = this._endModal, t[e.QUEST_CAN_NOT_CHALLENGE] = this._redirectTop, t[e.QUEST_CAN_NOT_CANCEL] = this._redirectTop;
            var n = t[this._errorType];
            if (!n) {
                var i = new r;
                i.sendErrorInfo({
                    filename: location.href,
                    message: "no target func for " + this._errorType
                }), n = this._navigateUpperScene
            }
            n.call(this)
        },
        _endModal: function() {
            o.prototype.end.call(this)
        },
        _redirectTop: function() {
            FF.redirect("/dff/")
        }
    })
}), define("scenes/quest/pages/QuestDetail", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/quest/Api", "components/FreeScroll", "components/Scrollbar", "scenes/common/collections/Quest", "templates/quest/QuestDetail", "../views/QuestDetailByType", "../views/ModalCancel", "../views/ModalError", "./Page"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return h.extend({
        contentType: "BASE",
        designType: "MODERN",
        backpageUrlPrefix: "#quest/list",
        DATASTORE_KEY: h.DATASTORE_KEY,
        events: {
            "anchorsbeforejump [data-app-quest-challenge]": "onClickChallenge",
            "anchorsbeforejump [data-app-quest-cancel]": "onClickCancel"
        },
        initialize: function(e) {
            var t = e.args[0];
            this.model = FF.datastore.questCollection.get(t), this.questCollection = new u(FF.datastore.questCollection.filter(function(e) {
                return e.get("is_normal") || e.get("is_special")
            })), h.prototype.initialize.call(this, [e])
        },
        render: function(e) {
            h.prototype.render.call(this, a, {
                model: this.model
            }), this.renderAchieveTypeTmpl(), this.setupComponents(), this.processAfterRender()
        },
        renderAchieveTypeTmpl: function() {
            var e = this.model.get("achieve_type_name"),
                n = new f;
            n.render({
                model: this.model
            }), t("[data-app-achieve-type-container]").html()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        openCancelConfirmDeferred: function() {
            var e = t.Deferred();
            return this.openCancelModal({
                isConfirm: !0
            }), this.listenToOnce(this.cancelModal, "onClickDecide", function() {
                e.resolve()
            }), this.listenToOnce(this.cancelModal, "onClickCancel", function() {
                e.reject()
            }), e.promise()
        },
        openCancelModal: function(e) {
            e = e || {}, this.cancelModal = new l, this.cancelModal.render({
                model: this.model,
                isConfirm: e.isConfirm
            }), FF.router.overlay.registerChildren(this.cancelModal), this.cancelModal.open()
        },
        finishCancel: function(e) {
            this.model.set(e.quest), FF.logger.debug(e.quest), this.openCancelModal({
                isConfirm: !1
            }), this.listenToOnce(this.cancelModal, "closeNotify", function() {
                this.onClickBack()
            })
        },
        onClickChallenge: function() {
            FF.router.loading.lock();
            var e = FF.CONST.SERVER.ERROR;
            if (this.questCollection.getChallengingQuestNum() >= FF.CONST.SERVER.QUEST.MAX_ORDERS) {
                this.openModalErrorView(e.QUEST_MAX_CHALLENGE_NUM);
                return
            }
            var n = t.Deferred(),
                r = this,
                s = this.model.get("id");
            return i.questChallengeDeferred(s).done(function(e) {
                r.model.set(e.quest), e.quest.is_challenging ? FF.datastore.stash[r.DATASTORE_KEY.HAS_CHALLENGED_QUEST] = !0 : e.unlocked_quests.length && FF.datastore.questCollection.add(e.unlocked_quests), FF.logger.debug(e), r.onClickBack(), n.resolve()
            }).fail(function(t) {
                t.error === e.QUEST_MAX_CHALLENGE_NUM ? r.openModalErrorView(e.QUEST_MAX_CHALLENGE_NUM, r.model) : t.error === e.QUEST_CAN_NOT_CHALLENGE && r.openModalErrorView(e.QUEST_CAN_NOT_CHALLENGE, r.model), n.resolve()
            }), n.promise()
        },
        onClickCancel: function() {
            FF.router.loading.lock();
            var e = FF.CONST.SERVER.ERROR,
                n = t.Deferred(),
                r = this,
                s = this.model.get("id");
            return this.openCancelConfirmDeferred().done(function() {
                i.questCancelDeferred(s).done(function(e) {
                    r.finishCancel(e), n.resolve()
                }).fail(function(t) {
                    t.error === e.QUEST_CAN_NOT_CANCEL && r.openModalErrorView(e.QUEST_CAN_NOT_CANCEL, r.model), n.resolve()
                })
            }).fail(function() {
                n.resolve()
            }), n.promise()
        },
        backPage: function() {
            var e = !FF.env.isIOS() && FF.datastore.stash.hasOwnProperty(this.DATASTORE_KEY.CURRENT_PAGE_INDEX) ? this.backpageUrlPrefix + "/" + FF.datastore.stash[this.DATASTORE_KEY.CURRENT_PAGE_INDEX] : this.backpageUrlPrefix;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            this.backPage()
        },
        openModalErrorView: function(e, t) {
            this.errorModal = new c({
                errorType: e,
                questModel: t
            }), this.errorModal.render(), FF.router.overlay.registerChildren(this.errorModal), this.errorModal.open()
        },
        dispose: function() {
            this.cancelModal && this.cancelModal.dispose(), this.errorModal && this.errorModal.dispose(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), h.prototype.dispose.call(this)
        }
    })
}), define("scenes/quest/QuestScene", ["underscore", "jquery", "backbone", "lib/Scene", "./Api", "./pages/Layout", "./pages/QuestDetail", "scenes/common/collections/Quest"], function(e, t, n, r, i, s, o, u) {
    return r.extend({
        pages: {
            list: s,
            detail: o
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return i.questListDeferred().done(function(t) {
                FF.datastore.questCollection.add(t.quests, {
                    merge: !0
                }), FF.datastore.stash.allQuestMasterNum = t.total_quest_master_num || 0, e.resolve(t)
            }), e.promise()
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "quest";
            FF.logger.debug("QuestScene: showPage : " + r, t), this.layoutPage && this.layoutPage.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in QuestScene. pageName: " + r);
            this.layoutPage = new this.pages[r]({
                scene: this,
                args: t
            }), this.layoutPage.setupDeferred().done(function() {
                n.layoutPage.render(t)
            })
        }
    })
}), define("scenes/achievement_room/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getReleasedRecordMateriaListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_released_record_materia_list", {})
        },
        getReleasedMemoryCrystalListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_released_memory_crystal_list", {})
        },
        getReleasedBuddyListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_released_buddy_list", {})
        },
        getAchievementInfoListByItemIdsDeferred: function(e) {
            return this.requestDeferred("/dff/achievement_room/get_info_list_by_item_ids", {
                item_ids: e
            }, {
                type: "POST"
            })
        },
        getMovieReplayListDeferred: function() {
            return this.requestDeferred("/dff/achievement_room/get_movie_replay_list", {})
        }
    })
}), define("scenes/movie_replay/menu/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "kickmotor", "lib/LayoutBase", "lib/TemplateRenderer", "templates/movie_replay/MovieReplayMenu", "templates/movie_replay/MovieReplayMenuList", "components/FreeScroll", "components/Scrollbar", "components/Tab"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return s.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-replay-movie]": "replayMovie"
        },
        initialize: function(t) {
            s.prototype.initialize.call(this);
            var n = FF.CONST.SERVER.MOVIE_REPLAY.MOVIE_TYPE_OF,
                r = e.values(FF.CONST.SERVER.MOVIE_REPLAY.MOVIE_TYPE_OF),
                i = +t.movieType || n.STORY;
            if (!e.contains(r, i)) throw new Error("Invalid movie type: " + i);
            this._movieType = i
        },
        render: function() {
            var e = FF.datastore.userModel;
            s.prototype.render.call(this, u, {}), this._renderItems(), this.setupComponents(), this.processAfterRender()
        },
        _renderItems: function() {
            var e = FF.datastore.movieReplayCollection.getListByType(this._movieType),
                n = o.process(a, {
                    movies: e
                });
            t("[data-movie-replay-menu-list]").html(n)
        },
        setupComponents: function() {
            this.freescroll = new f({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new l({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.tab = new c({
                tabs: t('[data-ui-group="tab"]'),
                panes: void 0,
                className: "is-current",
                defaultPage: this._typeToTabIndex(this._movieType)
            }), this.listenTo(this.tab, "changedState", this._onTabStateChange.bind(this))
        },
        _onTabStateChange: function(e) {
            this._movieType = this._tabIndexToType(+e.index), this._renderItems(), this.scrollbar.updateContentWithScrollReset()
        },
        _typeToTabIndex: function(e) {
            return e - 1
        },
        _tabIndexToType: function(e) {
            return e + 1
        },
        replayMovie: function(e) {
            var i = t(e.currentTarget).attr("data-app-replay-movie"),
                s = r("movie_replay_detail/%s", i);
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#achievement_room/top", {
                trigger: !0
            })
        },
        dispose: function() {
            s.prototype.dispose.call(this)
        }
    })
}), define("scenes/movie_replay/menu/MovieReplayMenuScene", ["underscore", "jquery", "backbone", "scenes/achievement_room/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        start: function(e) {
            this.setupDeferred().done(function(t) {
                FF.datastore.movieReplayCollection.reset(t.movie_replay_list), this.layoutView = new s({
                    movieType: e
                }), this.layoutView.render()
            }), FF.SoundMgr.playMusic("bgm_09_040")
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return r.getMovieReplayListDeferred().done(function(t) {
                e.resolve(t)
            }), e.promise()
        }
    })
}), define("scenes/movie_replay/player/views/Layout", ["scenes/movie_play/views/Layout", "templates/movie/Movie"], function(e, t) {
    return e.extend({
        _getTmpl: function() {
            return t
        },
        _getEndFragment: function() {
            var e = this.options.endFragment || "#movie_replay";
            return e
        }
    })
}), define("scenes/movie_replay/player/MovieReplayScene", ["underscore", "jquery", "backbone", "scenes/movie_play/MoviePlayScene", "./views/Layout", "scenes/common/helper/MovieHelper"], function(e, t, n, r, i, s) {
    return r.extend({
        layoutClass: i,
        start: function(e) {
            var t = FF.datastore.movieReplayCollection.get(e),
                n, i = "#movie_replay/" + t.get("type"),
                o = {
                    endFragment: i
                };
            t.get("is_bundled") ? (n = s.getBundleMovieName(t.get("path")), o.forceShow = !0) : (n = s.getServerMovieName(t.get("path")), o.path = t.getServerPath()), r.prototype.start.call(this, n, o)
        }
    })
}), define("scenes/member_upgrade_bonus/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        memberUpgradeBonusReceiveDeferred: function() {
            return this.requestDeferred("/dff/member_upgrade_bonus_campaign/receive", {}, {
                type: "POST"
            })
        }
    })
}), define("scenes/member_upgrade_bonus/views/Layout", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/notification/views/ModalNotificationDetail", "templates/member_upgrade_bonus/MemberUpgradeBonus"], function(e, t, n, r, i, s) {
    return r.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-upgrade-bonus-received]": "onMemberUpgradeBonusReceivedClick"
        },
        initialize: function(e) {
            this.fromBanner = e.fromBanner, this.isReceived = e.isReceived, this.userGrade = FF.datastore.stash.user_grade, this.listenTo(this, "NOTIFICATION_MODAL", this.openNotificationModal), r.prototype.initialize.call(this)
        },
        render: function() {
            this.userGrade > FF.CONST.SERVER.USER.USER_GRADE_OF.KANTAN && !this.isReceived && this.fromBanner || this.userGrade === FF.CONST.SERVER.USER.USER_GRADE_OF.KANTAN ? this.trigger("NOTIFICATION_MODAL", 246) : (r.prototype.render.call(this, s), this.processAfterRender())
        },
        onMemberUpgradeBonusReceivedClick: function() {
            FF.router.loading.lock(), this.isBanner ? this.trigger("NOTIFICATION_MODAL", 246) : FF.router.goBootstrapNextScene()
        },
        openNotificationModal: function(e) {
            var t = this;
            FF.router.loading.lock();
            var r = FF.datastore.notificationCollection.get(e);
            this.notificationModal = new i({
                notificationModel: r,
                isPopup: !0
            }), this.notificationModal.render(), FF.router.overlay.registerChildren(this.notificationModal), this.listenToOnce(this.notificationModal, "modalNotificationDetailBack", function() {
                t.notificationModal.end(), n.history.navigate("#home", {
                    trigger: !0
                })
            }), this.listenToOnce(this.notificationModal, "modalNotificationDetailClose", function() {
                t.notificationModal.end(), n.history.navigate("#home", {
                    trigger: !0
                })
            }), this.notificationModal.open()
        }
    })
}), define("scenes/member_upgrade_bonus/MemberUpgradeBonusScene", ["underscore", "jquery", "backbone", "scenes/member_upgrade_bonus/Api", "lib/Scene", "./views/Layout"], function(e, t, n, r, i, s) {
    return i.extend({
        setupDeferred: function() {
            FF.SoundMgr.playDefaultBgm();
            var e = t.Deferred();
            return r.memberUpgradeBonusReceiveDeferred().done(function(n) {
                FF.datastore.stash.canReceiveMemberUpgradeBonus = !1, n.receved && (FF.datastore.stash.giftBoxNum++, t(document).trigger("updateBadge")), e.resolve(n)
            }), e.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred().then(function(n) {
                t.layoutView = new s({
                    fromBanner: e ? !0 : !1,
                    isReceived: n.receved,
                    userGrade: n.user_grade
                }), t.layoutView.render()
            }, function(e) {
                FF.router.goBootstrapNextScene()
            })
        }
    })
}), define("scenes/music_room/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getMusicRoomDeferred: function(e, t) {
            return this.requestDeferred("/dff/music_room/", {
                type: e,
                id: t
            })
        }
    })
}), define("scenes/music_room/views/Layout", ["underscore", "jquery", "backbone", "sprintf", "lib/LayoutBase", "lib/Download", "components/FreeScroll", "components/Scrollbar", "templates/music_room/Layout"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-toggle-play-content-id]": "onClickTogglePlay"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this), this.assets = e.assets, this.musicRoom = e.musicRoom, this.musicRoomContents = e.musicRoom.music_room_contents, this.id = e.id, this.type = e.type, this.playingContentId = e.playingContentId, this._currentScrollHeight = 0
        },
        render: function() {
            var t = {
                id: this.id,
                type: this.type,
                musicRoom: this.musicRoom,
                musicRoomContents: e.sortBy(this.musicRoomContents, function(e) {
                    return e.content_id
                })
            };
            i.prototype.render.call(this, a, t), this.setupComponents(), this.setBackgroundImage(this.getBackgroundImagePath()), this.freescroll.startUp(this._currentScrollHeight), this.processAfterRender(), this.playingContentId && this.toggleButtonName(this.playingContentId)
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickTogglePlay: function(i) {
            var o = this,
                u = t(i.target).attr("data-app-btn-toggle-play-content-id");
            if (+u === +o.playingContentId) {
                o.playingContentId = void 0, FF.SoundMgr.playMusic(this.musicRoom.default_bgm_file), o.toggleButtonName(u);
                return
            }
            var a = this.assets[u],
                f = e.find(this.musicRoomContents, function(e) {
                    return +e.content_id === +u
                });
            s.hasFileNeededToDownloadDeferred(e.values(a), {
                url: r("#music_room/%s/%d/%d", o.type, +o.id, +u)
            }).done(function(e) {
                if (e.needDownload) n.history.navigate("download", {
                    trigger: !0
                });
                else {
                    var t = o.playingContentId;
                    o.playingContentId = u, FF.SoundMgr.playMusic(f.bgm_file), o.toggleButtonName(u), t && o.toggleButtonName(t)
                }
            })
        },
        toggleButtonName: function(e) {
            var n = t(r('[data-app-label-content-id="%d"]', +e)); + e === +this.playingContentId ? (n.removeClass("img_text_play"), n.addClass("img_text_stop")) : (n.removeClass("img_text_stop"), n.addClass("img_text_play"));
            var i = +e === +this.playingContentId ? FF.TextMaster.get("music_stop_btn") : FF.TextMaster.get("music_play_btn");
            n.text(i)
        },
        getBackgroundImagePath: function() {
            return r("static/img/category/music_room/%s/%d/bg-%d.png", this.type, this.id, this.id)
        },
        onClickBack: function() {
            var e = this.type.split("_")[0];
            n.history.navigate(r("#event/%s/%d/prize_exchange", e, this.id), {
                trigger: !0
            })
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/music_room/MusicRoomScene", ["underscore", "jquery", "backbone", "scenes/music_room/Api", "lib/Scene", "lib/Download", "./views/Layout"], function(e, t, n, r, i, s, o) {
    return i.extend({
        setupDeferred: function(i, o) {
            var u = this,
                a = t.Deferred();
            return r.getMusicRoomDeferred(i, o).done(function(t) {
                var r = t.assets.default_bgm;
                s.hasFileNeededToDownloadDeferred(e.values(r), {
                    url: location.hash
                }).done(function(e) {
                    e.needDownload ? n.history.navigate("download", {
                        trigger: !0
                    }) : a.resolve(t)
                })
            }), a.promise()
        },
        start: function(t, n, r) {
            var i = this;
            this.setupDeferred(t, n).done(function(s) {
                i.assets = s.assets, i.musicRoom = s.music_room, i.layoutView = new o({
                    assets: i.assets,
                    musicRoom: i.musicRoom,
                    id: +n,
                    type: t,
                    playingContentId: +r
                }), i.layoutView.render();
                if (r) {
                    var u = e.find(i.musicRoom.music_room_contents, function(e) {
                        return +e.content_id === +r
                    });
                    FF.SoundMgr.playMusic(u.bgm_file)
                } else FF.SoundMgr.playMusic(i.musicRoom.default_bgm_file)
            })
        }
    })
}), define("scenes/exchange_shop/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getExchangeShopDeferred: function(e) {
            return this.requestDeferred("/dff/exchange_shop/prize_list", {
                shop_id: e
            })
        },
        exchangePrizeDeferred: function(e, t) {
            return this.requestDeferred("/dff/exchange_shop/exchange_prize", {
                shop_id: e,
                prize_id_2_num: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/common/views/party_memory/ResumeToaster", ["underscore"], function(e) {
    return {
        toastWithMessage: function(e) {
            if (!e) return;
            var t = e.toast;
            t && this._showToast(t, e.tmplArgs)
        },
        resetToast: function() {
            this._toast && this._toast.dispose(), this._toast = void 0
        },
        _showToast: function(e, t) {
            var n = this._makeToastTopping(e, t);
            FF.router.toast.eatAll(), FF.router.toast.topping(n).bake()
        },
        _makeToastTopping: function(t, n) {
            var r = $(t).text();
            return n ? e.template(r, n) : r
        }
    }
}), define("scenes/common/views/party_memory/ModalPartyMemoryRemoveConfirm", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "templates/common/party_memory/ModalPartyMemoryRemoveConfirm"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onPositiveClick",
            "anchorsbeforejump [data-app-decide-negative]": "onNegativeClick"
        },
        render: function(e, t) {
            this._partyMemoryModel = e, this.renderContent(s, {
                model: e,
                statusBonusOpt: t,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            })
        },
        onPositiveClick: function() {
            var e = this,
                t = this._partyMemoryModel.getMemoryNumber();
            r.partyMemoryRemoveDeferred(t).done(function(t) {
                FF.router.loading.hide();
                var n = t.party_memory_collection.list,
                    r = FF.datastore.partyMemoryCollection;
                r.refresh(n);
                var i = e._partyMemoryModel.getMemoryName();
                FF.modalStack.popToTotem(2, {
                    toast: "#toast-message-remove-done",
                    tmplArgs: {
                        memoryName: i
                    }
                })
            })
        },
        onNegativeClick: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemoryRenameError", ["lib/ModalBase", "templates/common/party_memory/ModalPartyMemoryRenameError"], function(e, t) {
    var n = {
        NG_WORD: "ngWord",
        CHARACTERS_OVER: "charactersOver"
    };
    return e.extend({
        el: "[data-app-modal]",
        render: function(e) {
            var r = n[e];
            if (!r) throw new Error("Error type not found: " + e);
            this.renderContent(t, {
                ERROR_TYPE_OF: n,
                errorType: r,
                MAX_LENGTH: FF.Config.server.partyMemoryName.maxLength
            })
        },
        onEnd: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemoryRename", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "./ModalPartyMemoryRenameError", "scenes/common/views/UsersInputView", "templates/common/party_memory/ModalPartyMemoryRename"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onDecideNameButtonClick",
            "anchorsbeforejump [data-app-decide-negative]": "onCancelButtonClick"
        },
        initialize: function() {
            i.prototype.initialize.call(this), this._maxLength = FF.Config.server.partyMemoryName.maxLength
        },
        render: function(e) {
            this._partyMemoryModel = e, this.renderContent(u, {
                defaultName: e.getMemoryName(),
                partyMemoryNameMaxLength: this._maxLength
            }), this._makeUsersInputView()
        },
        _makeUsersInputView: function() {
            this.usersInputView = new o({
                el: this.$el,
                parent: this,
                submitBtnEl: t(),
                isNickname: !0
            }), this.listenToOnce(this.usersInputView, "onClickBackWithoutFocus", this._onClickActualBack.bind(this))
        },
        onDecideNameButtonClick: function() {
            var e = FF.env.isIOS() ? "text" : "val",
                n = t("[data-app-input-attr]")[e]();
            if (n.length > this._maxLength) {
                this._openErrorModal("CHARACTERS_OVER");
                return
            }
            this._requestRename(n)
        },
        _requestRename: function(e) {
            var t = this._partyMemoryModel.getMemoryNumber();
            r.partyMemoryRenameDeferred(t, e).done(this._onRenameSuccess.bind(this)).fail(this._onRenameFailure.bind(this))
        },
        _onRenameSuccess: function(e) {
            FF.router.loading.hide();
            var t = e.party_memory_collection.list,
                n = FF.datastore.partyMemoryCollection;
            n.refresh(t), FF.modalStack.pop({
                toast: "#toast-message-rename-done"
            })
        },
        _onRenameFailure: function(e) {
            this._openErrorModal("NG_WORD")
        },
        _openErrorModal: function(e) {
            FF.modalStack.push(s, {
                renderer: function(t) {
                    t.render(e)
                }
            })
        },
        _onClickActualBack: function() {
            FF.modalStack.pop()
        },
        onCancelButtonClick: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this.usersInputView && this.usersInputView.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/achievement_room/views/ModalTransferConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/achievement_room/views/ModalTransferConfirm"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-go]": "onClickGo"
        },
        initialize: function(e) {
            this.itemAchievementInfoModel = e.itemAchievementInfoModel, this.itemModel = e.itemModel, r.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickGo: function() {
            n.history.navigate(this.itemAchievementInfoModel.getFragment(), {
                trigger: !0
            })
        },
        render: function() {
            this.renderContent(i, {
                itemModel: this.itemModel,
                itemAchievementInfo: this.itemAchievementInfoModel
            })
        }
    })
}), define("scenes/common/models/BuddyAchievementInfo", ["underscore", "lib/Model"], function(e, t) {
    return t.extend({
        getImagePath: function(e) {
            if (!e) throw new Error("not image_type");
            var t = this.get("buddy_id") + ".png",
                n = e + ".png";
            return this.get("image_path").replace(t, n)
        },
        getDisplayDressRecordMemoryOfHeroes: function() {
            var t = this.get("dress_record_memory_of_heroes");
            if (!t) return [];
            var n = e.map(t, this._replaceLineBreak);
            return n
        },
        _replaceLineBreak: function(t) {
            var n = e.clone(t);
            return n.description && (n.description = n.description.replace(/{n}/g, "<br>")), n.series.formal_name && (n.series.formal_name = n.series.formal_name.replace(/{n}/g, "<br>")), n.series.description && (n.series.description = n.series.description.replace(/{n}/g, "<br>")), n
        }
    })
}), define("scenes/common/models/ItemAchievementInfo", ["util", "lib/SeparatedModel"], function(e, t) {
    return t.extend({
        attributeSchema: {
            item_id: void 0
        },
        isOpen: function() {
            var t = e.getTimeAsSec();
            return this.get("opened_at") === 0 && this.get("closed_at") === 0 ? !0 : this.get("opened_at") <= t && this.get("closed_at") > t
        },
        isTypeDungeon: function() {
            var e = FF.CONST.SERVER.ITEM_ACHIEVEMENT_INFO.TYPE_OF,
                t = this.get("type");
            return t === e.NORMAL_WORLD
        },
        isTypeEvent: function() {
            var e = FF.CONST.SERVER.ITEM_ACHIEVEMENT_INFO.TYPE_OF,
                t = this.get("type");
            return t === e.EVENT_WORLD || t === e.EVENT_SPECIAL
        },
        getFragment: function() {
            var e = FF.CONST.SERVER.ITEM_ACHIEVEMENT_INFO.TYPE_OF,
                t, n;
            switch (this.get("type")) {
                case e.NORMAL_WORLD:
                    n = FF.datastore.worldCollection.get(this.get("world_id")), t = n.getDungeonDetailFragment(this.get("dungeon_id"), "info");
                    break;
                case e.EVENT_WORLD:
                    n = FF.datastore.worldCollection.get(this.get("world_id")), t = n.getDungeonListFragment();
                    break;
                case e.EVENT_SPECIAL:
                    var r = FF.datastore.eventCollection.get(this.get("event_id"));
                    t = r.getWorldModel().getDungeonListFragment();
                    break;
                default:
                    throw new Error("invalid ItemAchievementInfo.type " + this.get("type"))
            }
            return t
        },
        getOrderNo: function() {}
    })
}), define("scenes/common/collections/ItemAchievementInfo", ["lib/Collection", "../models/ItemAchievementInfo"], function(e, t) {
    return e.extend({
        model: t,
        comparator: function(e, t) {
            return e.get("item_id") < t.get("item_id") ? -1 : e.get("item_id") > t.get("item_id") ? 1 : e.get("is_locked") < t.get("is_locked") ? -1 : e.get("is_locked") > t.get("is_locked") ? 1 : e.get("priority") < t.get("priority") ? -1 : e.get("priority") > t.get("priority") ? 1 : 0
        },
        getAvailableListByItemId: function(e) {
            return this.sort(), this.filter(function(t) {
                return t.get("item_id") === +e && t.isOpen()
            })
        },
        getAvailableMap: function() {
            this.sort();
            var e = {};
            return this.each(function(t) {
                if (!t.isOpen()) return;
                if (e[t.get("item_id")]) return;
                e[t.get("item_id")] = t
            }), e
        }
    })
}), define("scenes/common/views/ModalCharacterAchievementInfo", ["underscore", "jquery", "backbone", "scenes/achievement_room/Api", "lib/ModalBase", "scenes/achievement_room/views/ModalTransferConfirm", "scenes/common/models/BuddyAchievementInfo", "scenes/common/collections/ItemAchievementInfo", "templates/common/ModalCharacterAchievementInfo", "scenes/common/helper/DungeonInfo", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = {
        TAB_NAME_BASIC_INFORMATION: "basicInformation",
        TAB_NAME_MEMORY_OF_HERO: "memoryOfHero"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalback",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #basicInformation": "onClickTab",
            "anchorsbeforejump #memoryOfHero": "onClickTab",
            "anchorsbeforejump [data-app-transfer]": "onClickTransfer"
        },
        initialize: function() {
            this.achievementInfo = void 0, this.currentPaneName = h.TAB_NAME_BASIC_INFORMATION, i.prototype.initialize.call(this)
        },
        setupDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return this.getAchievementInfoIfNeedDeferred(e).then(function(e) {
                n.achievementInfo = e, r.resolve()
            }), r.promise()
        },
        render: function() {
            var e = this;
            this.renderContent(a, this.achievementInfo), this.setupComponents()
        },
        getAchievementInfoIfNeedDeferred: function(n) {
            var i = this,
                s = t.Deferred();
            this.achievementInfo = n.achievementInfo || null;
            var a = n.buddyId || null;
            if (this.achievementInfo) return s.resolve(this.achievementInfo).promise();
            if (!a) throw new Error("achievementInfo or buddyId must be defined");
            return r.getAchievementInfoListByItemIdsDeferred([a]).then(function(t) {
                var n = new o(t.buddies.shift()),
                    r = new u(t.item_achievement_infos),
                    f = r.getAvailableListByItemId(a),
                    l = e.find(FF.datastore.buddyCollection.models, function(e) {
                        return e.get("buddy_id") === a - 0
                    });
                i.achievementInfo = {
                    buddy: n,
                    itemAchievementInfos: f,
                    achievedBuddy: l || null
                }, s.resolve(i.achievementInfo)
            }), s.promise()
        },
        onClickTransfer: function(n) {
            var r = this,
                i = t(n.target).attr("data-app-type"),
                o = e.find(this.achievementInfo.itemAchievementInfos, function(e) {
                    return e.get("type") === i - 0
                });
            o.isTypeDungeon() ? f.openDeferred(o.get("dungeon_id"), {
                enableChallengeButton: !0
            }) : FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({
                        itemModel: r.achievementInfo.buddy,
                        itemAchievementInfoModel: o
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        setupComponents: function() {
            this.freescroll1 = new l({
                el: t("[data-ui-freescroll-for-info]")
            }), this.scrollbar1 = new c({
                el: t("[data-ui-scrollbar-for-info]"),
                watch: this.freescroll1,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.freescroll2 = new l({
                el: t("[data-ui-freescroll-for-memory]")
            }), this.scrollbar2 = new c({
                el: t("[data-ui-scrollbar-for-memory]"),
                watch: this.freescroll2,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalback: function() {
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickTab: function(e) {
            var n = t(e.target),
                r = n.hasClass("is-current");
            if (r) return;
            FF.SoundMgr.playChooseEffect(), this.currentPaneName = n.attr("id"), this.toggleTabView(), this.scrollbar2.updateContentWithScrollReset(), this.freescroll2.reset()
        },
        toggleTabView: function() {
            t("#basicInformationTabView").toggleClass("is-current").toggleClass("di-n"), t("#memoryOfHeroTabView").toggleClass("is-current").toggleClass("di-n"), t("#basicInformation").toggleClass("is-current"), t("#memoryOfHero").toggleClass("is-current")
        },
        dispose: function() {
            this.freescroll1 && this.freescroll1.dispose(), this.scrollbar1 && this.scrollbar1.dispose(), this.freescroll2 && this.freescroll2.dispose(), this.scrollbar2 && this.scrollbar2.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalSoulStrikeList", ["underscore", "jquery", "backbone", "lib/ModalBase", "scenes/common/views/ModalSoulStrikeChange", "./ModalSoulStrikeDetail", "templates/party/views/ModalSoulStrikeList", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack",
            "anchorsbeforejump [data-app-soul-strike-btn]": "onClickSoulStrikeChange",
            "anchorslongtap [data-app-soulstrike-img]": "onLongTapSoulStrikeDetail"
        },
        initialize: function(e, t) {
            t = t || {}, this.isPushingRecommend = t.isPushingRecommend || !1, this.hasLongTap = !1, this.buddyModel = e, this.defaultSoulStrikeModel = this.buddyModel.getDefaultSoulStrikeModel(), this.ownSoulStrikeModels = this.buddyModel.getOwnSoulStrikeModels(), this.commonSoulStrikeModels = this.buddyModel.getCommonSoulStrikeModels(), r.prototype.initialize.call(this)
        },
        render: function() {
            var e = o({
                buddyModel: this.buddyModel,
                ownSoulStrikeModels: this.ownSoulStrikeModels,
                defaultSoulStrikeModel: this.defaultSoulStrikeModel,
                commonSoulStrikeModels: this.commonSoulStrikeModels,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon() && this.buddyModel.isInParty(),
                isInParty: this.buddyModel.isInParty(),
                canSelectSoulStrike: this.buddyModel.canSelectSoulStrike(),
                isPushingRecommend: this.isPushingRecommend
            });
            this.putContent(e), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll-for-mastered]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar-for-mastered]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapSoulStrikeDetail: function(e) {
            if (this.hasLongTap) return;
            this.hasLongTap = !0, this.freescroll.cancelScroll();
            var n = this,
                r = t(e.target).eq(0).attr("id"),
                i = FF.datastore.soulStrikeCollection.get(r);
            FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({
                        buddyModel: n.buddyModel,
                        soulStrikeModel: i
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            }), FF.SoundMgr.playChooseEffect()
        },
        onClickModalBack: function() {
            if (this.hasLongTap) return;
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickSoulStrikeChange: function() {
            if (this.hasLongTap) return;
            var n = this;
            if (this.buddyModel.hasChangedTmpAttr()) {
                FF.router.toast.topping(t("#toast-message-must-click-fix-btn").text()).bake(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.SoundMgr.playChooseEffect(), FF.modalStack.push(i, {
                initializer: function(t) {
                    var r = n.buddyModel.getTmpSoulStrikeModels(),
                        i = e.pluck(e.compact(r), "id");
                    return new t({
                        buddyModel: n.buddyModel,
                        selectableSoulStrikeModels: n.buddyModel.getSelectableSoulStrikeModels(),
                        tmpSoulStrikeModels: r,
                        tmpSoulStrikeIds: i
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalCharacterDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalCharacterDetail", "templates/party/views/ModalBuddySoulStrikeList", "./ModalCharacterAvailableType", "scenes/common/views/ModalCharacterAchievementInfo", "./ModalSoulStrikeList"], function(e, t, n, r, i, s, o, u, a, f) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalback",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType",
            "anchorsbeforejump [data-app-soul-strike-btn]": "onClickSoulStrikeList",
            "anchorsbeforejump [data-app-achievement-info-btn]": "onClickAchievementInfo"
        },
        render: function(e, t) {
            t = t || {}, t.useTmpInfo = t.useTmpInfo || !1, this.isPushingRecommend = t.isPushingRecommend || !1;
            if (!e) return;
            this._buddyModel = e;
            var n = t.useTmpInfo ? e.getTmpEquipmentModelMap() : e.getEquipmentModelMap(),
                r = t.useTmpInfo ? e.getTmpAbilityModels() : e.getAbilityModels(),
                i = t.useTmpInfo ? e.getTmpRecordMateriaModels() : e.getRecordMateriaModels();
            this.renderContent(s, {
                buddy: e,
                weapon: n.weapon,
                armor: n.armor,
                accessory: n.accessory,
                ability1: r[0],
                ability2: r[1],
                recordMateria1: i[0],
                useTmpInfo: t.useTmpInfo,
                statusBonusOpt: t.statusBonusOpt
            }), this.renderBuddySoulStrikeList(e)
        },
        renderBuddySoulStrikeList: function(e) {
            t("#buddySoulStrikeList").html(o({
                defaultSoulStrikeId: e.get("default_soul_strike_id"),
                soulStrikes: e.getTmpSoulStrikeModels()
            }))
        },
        onClickModalback: function() {
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        onClickAvailableType: function() {
            var e = this._buddyModel;
            FF.modalStack.push(u, {
                renderer: function(t) {
                    var n = e.get("ability_category"),
                        r = e.get("equipment_category");
                    t.render(n, r)
                }
            })
        },
        onClickSoulStrikeList: function() {
            var e = this;
            FF.modalStack.push(f, {
                initializer: function(t) {
                    var n = e._buddyModel;
                    return new t(n, {
                        isPushingRecommend: e.isPushingRecommend
                    })
                },
                renderer: function(e) {
                    e.render()
                },
                onResume: function() {
                    FF.router.toast.bake()
                }
            })
        },
        onClickAchievementInfo: function(e) {
            var t = e.currentTarget,
                n = t.attributes["data-app-buddy-id"].value;
            FF.modalStack.push(a, {
                initDeferred: function(e) {
                    return e.setupDeferred({
                        buddyId: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemoryDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "lib/TemplateRenderer", "./ResumeToaster", "templates/common/party_memory/ModalPartyMemoryDetail", "templates/common/party_memory/ModalPartyMemoryDetailListItem", "scenes/common/models/Party", "./ModalPartyMemoryRemoveConfirm", "./ModalPartyMemoryRename", "scenes/party/views/ModalCharacterDetail"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    return r.extend(e.extend(s, {
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onModalBackClick",
            "anchorsbeforejump [data-app-remove-memory]": "onRemoveMemoryClick",
            "anchorsbeforejump [data-app-rename-memory]": "onRenameMemoryClick",
            "anchorslongtap [data-app-modal-can-show-detail]": "_onBuddyLongTap"
        },
        render: function(e, t, n) {
            this._partyMemoryModel = e, this._statusBonusOpt = t, this.renderContent(o, {
                model: e,
                isActionDisabled: n
            }), this._renderBuddies(e, t)
        },
        _renderBuddies: function(e, n) {
            var r = i.process(u, {
                partyModel: e,
                statusBonusOpt: n
            });
            t("[data-ui-carousel-children]").html(r)
        },
        _onBuddyLongTap: function(e) {
            var n = t(e.target),
                r = n.closest("[data-app-partylist-buddy-id]").attr("data-app-partylist-buddy-id"),
                i = this._partyMemoryModel.getBuddyById(r);
            this._openCharacterDetail(i)
        },
        _openCharacterDetail: function(e) {
            var t = this;
            FF.SoundMgr.playChooseEffect(), FF.modalStack.push(c, {
                renderer: function(n) {
                    n.render(e, {
                        statusBonusOpt: t._statusBonusOpt
                    })
                }
            })
        },
        onResume: function(e) {
            if (!e) return;
            this.toastWithMessage(e)
        },
        onRemoveMemoryClick: function() {
            var e = this;
            FF.modalStack.push(f, {
                renderer: function(t) {
                    t.render(e._partyMemoryModel, e._statusBonusOpt)
                }
            })
        },
        onRenameMemoryClick: function() {
            var e = this;
            FF.modalStack.push(l, {
                renderer: function(t) {
                    t.render(e._partyMemoryModel)
                }
            })
        },
        onModalBackClick: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    }))
}), define("scenes/common/views/party_memory/ModalPartyMemorySaveConfirm", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "./ModalPartyMemoryDetail", "scenes/common/models/PartyMemory", "templates/common/party_memory/ModalPartyMemorySaveConfirm"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onPositiveClick",
            "anchorsbeforejump [data-app-decide-negative]": "onNegativeClick",
            "anchorsbeforejump [data-app-memory-detail]": "onClickMemoryDetail",
            "anchorsbeforejump [data-app-party-detail]": "onClickPartyDetail"
        },
        render: function(e, t) {
            this._partyMemoryModel = e, this._statusBonusOpt = t;
            var n = FF.datastore.partyModel.getBuddyModels();
            this.renderContent(u, {
                model: e,
                statusBonusOpt: t,
                buddies: n,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            })
        },
        onPositiveClick: function() {
            var e = this,
                t = this._partyMemoryModel.getMemoryNumber();
            r.partyMemorySaveDeferred(t).done(function(t) {
                FF.router.loading.hide();
                var n = t.party_memory_collection.list,
                    r = FF.datastore.partyMemoryCollection;
                r.refresh(n);
                var i = e._partyMemoryModel.getMemoryName();
                FF.modalStack.pop({
                    toast: "#toast-message-save-done",
                    tmplArgs: {
                        memoryName: i
                    }
                })
            })
        },
        onNegativeClick: function() {
            FF.modalStack.pop()
        },
        onClickMemoryDetail: function(e) {
            var t = this;
            FF.modalStack.push(s, {
                renderer: function(e) {
                    var n = !0;
                    e.render(t._partyMemoryModel, t._statusBonusOpt, n)
                },
                totem: !0
            })
        },
        onClickPartyDetail: function(e) {
            var t = this;
            FF.modalStack.push(s, {
                renderer: function(e) {
                    var n = !0,
                        r = o.makeDummyModelFromCurrentParty();
                    e.render(r, t._statusBonusOpt, n)
                },
                totem: !0
            })
        }
    })
}), define("scenes/common/helper/PartyRecommend", ["jquery", "underscore", "scenes/common/models/Party", "scenes/party/Api"], function(e, t, n, r) {
    return {
        setupDeferred: function() {
            var t = this,
                n = e.Deferred(),
                i = FF.datastore;
            return i.hasPartyAllData() ? n.resolve().promise() : (r.partyListDeferred().done(function(e) {
                i.addPartyAllData(e), n.resolve()
            }), n.promise())
        },
        recommendDeferred: function(t, n) {
            var r = this,
                i = e.Deferred();
            return setTimeout(function() {
                var e = r.recommend(n);
                i.resolve(e)
            }, t), i.promise()
        },
        recommend: function(e) {
            var n = this,
                r = t.compact(FF.datastore.partyModel.getBuddyModels());
            t.each(r, function(e) {
                e.takeOffAllEquipments(), e.takeOffAllAbilities()
            });
            var i = n._getRecommendedPartyModel(e),
                s = t.compact(i.getBuddyModels());
            return FF.datastore.equipmentCollection.setRecommendedWeaponAndArmor(s, e), FF.datastore.equipmentCollection.setRecommendedAccessory(s, e), t.each(s, function(e) {
                e.setTmpRecommendedSoulStrikeIds()
            }), FF.datastore.abilityCollection.setRecommendedAbilities(s, {
                useBuddyEquippedParam: !0
            }), t.each(s, function(e) {
                e.changeRowByRecommend()
            }), FF.datastore.recordMateriaCollection.setRecommended(s), i
        },
        isChangedByRecommend: function(e) {
            var n = FF.datastore.partyModel.getSlotToBuddyId(),
                r = FF.datastore.buddyCollection.hasAnyChanged(),
                i = r || !t.isEqual(e.getSlotToBuddyId(), n);
            return i
        },
        saveToServerDeferred: function(t) {
            var n = FF.datastore.buddyCollection,
                i = n.getChangedEquipmentInfo(),
                s = n.getChangedSoulStrikeInfo(),
                o = n.getChangedAbilityInfo(),
                u = n.getChangedRowInfo(),
                a = n.getChangedRecordMateriaInfo(),
                f = {
                    type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.RECOMMEND
                };
            return r.partyBulkSaveDeferred(t, {
                equipment: i,
                soulStrike: s,
                ability: o,
                row: u,
                recordMateria: a
            }, f).then(function(n) {
                return FF.datastore.updatePartyAssets(n), e.Deferred().resolve(t).promise()
            })
        },
        _getRecommendedPartyModel: function(e) {
            var r = FF.datastore.partyModel.getSlotToBuddyId(),
                i = FF.datastore.buddyCollection,
                s = i.getBuddiesSortedByRecommend(e).filter(function(e) {
                    return !e.isInParty()
                }),
                o = {};
            t.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                var t = r[String(e)];
                if (t) {
                    o[String(e)] = t;
                    return
                }
                var n = s.shift();
                if (!n) return;
                o[String(e)] = n.get("id")
            });
            var u = FF.datastore.partyModel;
            return new n({
                slotToBuddyId: o
            })
        }
    }
}), define("scenes/common/helper/PartyMemoryLoad", ["jquery", "underscore", "scenes/party/Api", "scenes/common/models/Party", "./PartyRecommend"], function(e, t, n, r, i) {
    return {
        _foundLostItem: !1,
        loadPartyAndSaveToServerDeferred: function(n) {
            this._foundLostItem = !1;
            var r = this._makeLoadDestPartyModel(n),
                i = t.compact(r.getBuddyModels()),
                s = this;
            t.each(i, function(e) {
                e = s._applyMemoryToBuddy(e, n, r)
            });
            var o = e.Deferred();
            return this._saveToServerDeferred(r, n.getMemoryNumber()).done(function(e) {
                s._fixPartyStatus(e), o.resolve({
                    foundLostItem: s._foundLostItem
                })
            }), o.promise()
        },
        _saveToServerDeferred: function(t, r) {
            var i = FF.datastore.buddyCollection,
                s = i.getChangedEquipmentInfo(),
                o = i.getChangedAbilityInfo(),
                u = i.getChangedSoulStrikeInfo(),
                a = i.getChangedRowInfo(),
                f = i.getChangedRecordMateriaInfo(),
                l = i.getChangedDressRecordInfo(),
                c = {
                    type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.PARTY_MEMORY,
                    data: {
                        party_memory_no: r
                    }
                };
            return n.partyBulkSaveDeferred(t, {
                equipment: s,
                ability: o,
                soulStrike: u,
                row: a,
                recordMateria: f,
                dressRecord: l
            }, c).then(function(n) {
                return FF.datastore.updatePartyAssets(n), e.Deferred().resolve(t).promise()
            })
        },
        _fixPartyStatus: function(e) {
            FF.datastore.buddyCollection.fixTmpRow(), FF.datastore.partyModel.set(e.attributes), FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpAbilities(), FF.datastore.fixTmpRecordMaterias(), FF.datastore.fixTmpSoulStrikes(), FF.datastore.fixTmpDressRecords()
        },
        _makeLoadDestPartyModel: function(e) {
            var n = e.getSlotToBuddyId();
            return new r({
                slotToBuddyId: t.clone(n)
            })
        },
        _applyMemoryToBuddy: function(e, t, n) {
            e.takeOffAllEquipments(), e.takeOffAllAbilities(), e.takeOffRecordMateria(), e.takeOffDressRecord();
            var r = t.getBuddyById(e.id);
            return e = this._rememberEquipments(e, r), e = this._rememberSoulStrikes(e, r, t), e = this._rememberAbilities(e, r), e = this._rememberRecordMateria(e, r), e = this._rememberDressRecord(e, r), e = this._rememberRow(e, r), e
        },
        _rememberEquipments: function(e, t) {
            var n = this._getEquipmentIdIfOwned(t, "weapon_id"),
                r = this._getEquipmentIdIfOwned(t, "armor_id"),
                i = this._getEquipmentIdIfOwned(t, "accessory_id");
            return e.setTmpWeaponId({
                equipmentId: n
            }), e.setTmpArmorId({
                equipmentId: r
            }), e.setTmpAccessoryId({
                equipmentId: i
            }), e
        },
        _rememberSoulStrikes: function(e, n) {
            var r = this;
            return t.each(FF.CONST.SERVER.SOUL_STRIKE.SLOTS, function(t) {
                var i = r._getSoulStrikeIdIfOwned(n, t);
                e.setTmpSoulStrikeId({
                    slot: t,
                    soulStrikeId: i
                })
            }), e.setDefaultSoulStrikeIfNeed(), e
        },
        _rememberAbilities: function(e, n) {
            var r = this;
            return t.each(FF.CONST.SERVER.ABILITY.SLOTS, function(t) {
                var i = r._getAbilityIdIfOwned(n, t);
                e.setTmpAbilityId({
                    slot: t,
                    abilityId: i
                })
            }), e
        },
        _rememberRecordMateria: function(e, n) {
            return t.each(FF.CONST.SERVER.RECORD_MATERIA.SLOTS, function(t) {
                var r = n.getRecordMateriaIdBySlot(t);
                e.setTmpRecordMateriaId({
                    slot: t,
                    recordMateriaId: r
                })
            }), e
        },
        _rememberDressRecord: function(e, t) {
            var n = t.getDressRecordId();
            return e.setTmpDressRecordId({
                dressRecordId: n
            }), e.setImagePathByDressRecordId(n), e
        },
        _rememberRow: function(e, t) {
            return e.setTmpRow(t.get("row")), e
        },
        _getEquipmentIdIfOwned: function(e, t) {
            var n = e.get(t);
            if (!n) return 0;
            var r = FF.datastore.equipmentCollection;
            return r.findWhere({
                id: n
            }) ? n : (this._foundLostItem = !0, 0)
        },
        _getSoulStrikeIdIfOwned: function(e, t) {
            var n = e.getSoulStrikeIdBySlot(t);
            return n ? e.canSelectSoulStrikeId(n) ? n : (this._foundLostItem = !0, 0) : 0
        },
        _getAbilityIdIfOwned: function(e, t) {
            var n = e.getAbilityIdBySlot(t);
            if (!n) return 0;
            var r = FF.datastore.abilityCollection;
            return r.findWhere({
                id: n
            }) ? n : (this._foundLostItem = !0, 0)
        }
    }
}), define("scenes/common/views/party_memory/ModalPartyMemoryLoadConfirm", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "./ModalPartyMemoryDetail", "scenes/common/models/PartyMemory", "scenes/common/helper/PartyMemoryLoad", "templates/common/party_memory/ModalPartyMemoryLoadConfirm"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-positive]": "onPositiveClick",
            "anchorsbeforejump [data-app-decide-negative]": "onNegativeClick",
            "anchorsbeforejump [data-app-memory-detail]": "onClickMemoryDetail",
            "anchorsbeforejump [data-app-party-detail]": "onClickPartyDetail"
        },
        render: function(e, t) {
            this._partyMemoryModel = e, this._statusBonusOpt = t;
            var n = FF.datastore.partyModel.getBuddyModels();
            this.renderContent(a, {
                model: e,
                statusBonusOpt: t,
                buddies: n,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            })
        },
        onPositiveClick: function() {
            var e = this;
            u.loadPartyAndSaveToServerDeferred(this._partyMemoryModel).then(function(t) {
                FF.router.loading.hide();
                var n = e._makeLoadCompleteMessage(t);
                FF.modalStack.popAll(n)
            })
        },
        _makeLoadCompleteMessage: function(e) {
            var t = this._partyMemoryModel.getMemoryName();
            return {
                event: "loadComplete",
                partyName: t,
                foundLostItem: e.foundLostItem
            }
        },
        onNegativeClick: function() {
            FF.modalStack.pop()
        },
        onClickMemoryDetail: function(e) {
            var t = this;
            FF.modalStack.push(s, {
                renderer: function(e) {
                    var n = !0;
                    e.render(t._partyMemoryModel, t._statusBonusOpt, n)
                },
                totem: !0
            })
        },
        onClickPartyDetail: function(e) {
            var t = this;
            FF.modalStack.push(s, {
                renderer: function(e) {
                    var n = !0,
                        r = o.makeDummyModelFromCurrentParty();
                    e.render(r, t._statusBonusOpt, n)
                },
                totem: !0
            })
        }
    })
}), define("scenes/common/views/party_memory/ModalPartyMemory", ["underscore", "jquery", "backbone", "scenes/common/util/Api", "lib/ModalBase", "lib/TemplateRenderer", "./ResumeToaster", "./ModalPartyMemoryDetail", "./ModalPartyMemorySaveConfirm", "./ModalPartyMemoryLoadConfirm", "templates/common/party_memory/ModalPartyMemory", "templates/common/party_memory/ModalPartyMemoryList", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    return i.extend(e.extend(o, {
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-back]": "onClickModalBack",
            "anchorsbeforejump [data-app-memory-detail]": "onClickMemoryDetail",
            "anchorsbeforejump [data-app-save-party]": "onClickMemorySave",
            "anchorsbeforejump [data-app-load-party]": "onClickMemoryLoad"
        },
        render: function(e, t, n) {
            this._partyMemoryCollection = e, this._statusBonusOpt = t || {}, this.renderContent(l, {}), this.renderListItems(e.models, this._statusBonusOpt), this.setupComponents(n)
        },
        renderListItems: function(e, n) {
            var r = FF.datastore.dungeonSessionModel.isInDungeon();
            t("[data-app-memory-list-items]").html(s.process(c, {
                models: e,
                statusBonusOpt: n,
                isInDungeon: r,
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS
            }))
        },
        setupComponents: function(e) {
            e = e || 0, this._freescroll = new h({
                el: t("[data-ui-freescroll-for-party-memory]"),
                startUp: e
            }), this._scrollbar = new p({
                el: t("[data-ui-scrollbar-for-party-memory]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onResume: function(e) {
            if (!e) return;
            this.toastWithMessage(e)
        },
        getCurrentScrollPos: function() {
            return this._freescroll.getCurrentScroll()
        },
        _findMemoryModel: function(e) {
            e = parseInt(e, 10);
            var t = this._partyMemoryCollection.findWhere({
                party_memory_no: e
            });
            if (!t) throw new Error("PartyMemory model not found: file no.= " + e);
            return t
        },
        onClickMemoryDetail: function(e) {
            var t = this,
                n = e.currentTarget.attributes["data-app-memory-no"].value,
                r = this._statusBonusOpt;
            FF.modalStack.push(u, {
                renderer: function(e) {
                    var i = t._findMemoryModel(n);
                    e.render(i, r)
                },
                onResume: function(e, t) {
                    e.onResume(t)
                },
                totem: !0
            })
        },
        onClickMemorySave: function(e) {
            var t = e.currentTarget.attributes["data-app-memory-no"].value,
                n = this._findMemoryModel(t),
                r = this._statusBonusOpt;
            if (!n.hasMemory()) {
                this._saveInitialMemory(t, n);
                return
            }
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render(n, r)
                }
            })
        },
        _saveInitialMemory: function(e, t) {
            var n = this;
            r.partyMemorySaveDeferred(e).done(function(e) {
                FF.router.loading.hide();
                var r = e.party_memory_collection.list,
                    i = FF.datastore.partyMemoryCollection;
                i.refresh(r), n._redrawListItems(i.models, n._statusBonusOpt), n._showSaveCompleteToast(t.getMemoryName())
            })
        },
        _redrawListItems: function(e, t) {
            if (FF.modalStack.isHidden()) {
                var n = this.getCurrentScrollPos();
                this.render(this._partyMemoryCollection, this._statusBonusOpt, n), this.open(), this.resetToast(), this._freescroll.restartLazyLoad();
                return
            }
            this.renderListItems(e, t), this.open(), this._freescroll.restartLazyLoad()
        },
        _showSaveCompleteToast: function(e) {
            this.toastWithMessage({
                toast: "#toast-message-save-done",
                tmplArgs: {
                    memoryName: e
                }
            })
        },
        onClickMemoryLoad: function(e) {
            var t = e.currentTarget.attributes["data-app-memory-no"].value,
                n = this._findMemoryModel(t),
                r = this._statusBonusOpt;
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(n, r)
                }
            })
        },
        onClickModalBack: function() {
            FF.modalStack.pop()
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    }))
}), define("scenes/common/helper/PartyMemory", ["jquery", "underscore", "lib/ModalStack", "scenes/common/views/party_memory/ModalPartyMemory", "./FuncTutorial", "scenes/common/util/Api", "scenes/party/Api"], function(e, t, n, r, i, s, o) {
    return {
        openPartyMemoryListModalDeferred: function(t) {
            var n = e.Deferred(),
                r = this;
            return this._fetchPartyListDeferred().done(function() {
                r._showTutorialDeferred().done(function() {
                    r._openModal(n, t)
                })
            }), n.promise()
        },
        _fetchPartyListDeferred: function() {
            var t = e.Deferred();
            return FF.datastore.hasPartyAllData() ? t.resolve().promise() : (o.partyListDeferred().done(function(e) {
                FF.datastore.addPartyAllData(e), t.resolve()
            }), t.promise())
        },
        _showTutorialDeferred: function() {
            return i.showNavigationDeferred({
                key: "PARTY_MEMORY",
                isTutorialIllustOnly: !0
            })
        },
        _openModal: function(e, t) {
            var n = FF.datastore.partyMemoryCollection;
            if (n.hasAllData) {
                this._openModalWithDatastore(e, t);
                return
            }
            var r = this;
            s.partyMemoryListDeferred().done(function(i) {
                var s = i.party_memory_collection.list;
                n.refresh(s), r._openModalWithDatastore(e, t)
            })
        },
        _openModalWithDatastore: function(e, t) {
            var n = 0;
            FF.modalStack.push(r, {
                renderer: function(e) {
                    var r = FF.datastore.partyMemoryCollection;
                    e.render(r, t, n)
                },
                onStack: function(e) {
                    n = e.getCurrentScrollPos()
                },
                onResume: function(e, t) {
                    e.onResume(t)
                },
                totem: !0
            }), FF.modalStack.setOnComplete(function(t) {
                e.resolve(t)
            })
        }
    }
}), define("scenes/exchange_shop/models/ExchangeShopPrize", ["underscore", "backbone", "lib/Model", "sprintf", "util"], function(e, t, n, r, i) {
    return n.extend({
        getItemTypeNames: function() {
            var t = this.get("item_package").items,
                n = e.map(t, function(e) {
                    return e.item_type_name
                });
            return e.uniq(n)
        },
        getPrizeName: function() {
            var t = "";
            return e.each(this.get("item_package").items, function(e) {
                e.num === 1 ? t += e.item_name : t += e.item_name + "&times;" + e.num
            }), t
        },
        getImagePath: function() {
            return this.get("item_package").items[0].image_path
        },
        canExchangeByRequestNum: function(e, t) {
            return t < this.get("required_num") * e ? !1 : this.isUnlimitedExchange() ? !0 : this.get("exchanged_num") + e <= this.get("exchangeable_num")
        },
        isUnlimitedExchange: function() {
            return this.get("exchangeable_num") === 0
        },
        remainExchangeableNum: function() {
            return this.get("exchangeable_num") - this.get("exchanged_num")
        },
        incrementExchangedNum: function(e) {
            this.set("exchanged_num", this.get("exchanged_num") + e)
        },
        isAlreadyExchangedAndUnexchangeable: function() {
            return this.get("exchanged_num") === 0 ? !1 : this.remainExchangeableNum() > 0 ? !1 : this.isUnlimitedExchange() ? !1 : !0
        },
        isAlreadyPossessed: function(t) {
            t = t || {};
            var n = t.memoryCrystalCollectionIncludingUsed,
                r = +this.get("item_package").items[0].item_id;
            if (this.hasBuddy()) return FF.datastore.buddyCollection.findWhere({
                buddy_id: r
            }) ? !0 : !1;
            if (this.hasMemoryCrystal()) {
                if (e.isUndefined(n)) throw new Error("no memoryCrystalCollectionIncludingUsed");
                return n.get(r) ? !0 : !1
            }
            if (this.hasGrowEgg()) return FF.datastore.growEggCollection.length > 0;
            throw new Error("unrecognized item. itemId:" + r)
        },
        canBePossessedOnlyOne: function() {
            return this.hasBuddy() ? !0 : this.hasMemoryCrystal() ? !0 : !1
        },
        canExchangeForRitualRoom: function(e, t, n) {
            return this.isAlreadyExchangedAndUnexchangeable() ? !1 : this.canBePossessedOnlyOne() && this.isAlreadyPossessed(n) ? !1 : this.canExchangeByRequestNum(e, t)
        },
        hasBuddy: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "buddy"
            })
        },
        hasEquipment: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment"
            })
        },
        hasGrowEgg: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "grow_egg"
            })
        },
        hasMemoryCrystal: function() {
            return e.any(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "memory_crystal"
            })
        },
        findBuddy: function() {
            return e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "buddy"
            })
        },
        findEquipment: function() {
            return e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment"
            })
        },
        findSoulStrike: function() {
            var t = e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "equipment" && e.soul_strike
            });
            return t ? t.soul_strike : void 0
        },
        findMemoryCrystal: function() {
            return e.find(this.get("item_package").items, function(e) {
                return e.type_name.toLowerCase() === "memory_crystal"
            })
        },
        getBuddyNameImagePath: function() {
            var e = this.findBuddy(),
                t = this.findMemoryCrystal(),
                n = this.get("item_package").id,
                r = e ? e.name_image_path : t ? t.buddy_name_image_path : null;
            if (!r) throw new Error("not found buddy name image path. item_package_id:" + n);
            return r
        }
    })
}), define("scenes/exchange_shop/collections/ExchangeShopPrize", ["lib/Collection", "../models/ExchangeShopPrize"], function(e, t) {
    return e.extend({
        model: t,
        getSortedModelsForDisplay: function() {
            return this.models.sort(function(e, t) {
                return e.get("disp_order") < t.get("disp_order") ? -1 : e.get("disp_order") > t.get("disp_order") ? 1 : e.get("id") > t.get("id") ? -1 : e.get("id") < t.get("id") ? 1 : 0
            })
        }
    })
}), define("scenes/exchange_shop/models/ExchangeShop", ["backbone", "lib/Model", "sprintf", "util", "../collections/ExchangeShopPrize", "components/TimeKeeper"], function(e, t, n, r, i, s) {
    return t.extend({
        initialize: function(e, n) {
            this.prizeCollection = new i(e.prizes), t.prototype.initialize.apply(this.arguments)
        },
        getPrizeCollection: function() {
            return this.prizeCollection
        },
        getOpenedToClosedTermText: function() {
            var e = this.getTimeKeeper();
            return FF.env.isWWRegion() ? '<span class="tl-time mr-b">PST</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: FF.env.offsetFromUTC
            }) + '<span class="tl-time mr-b ml-b">UTC</span>' + e.setUnixTime(this.get("closed_at")).getString({
                timeZoneOffset: 0
            }) : e.setUnixTime(this.get("opened_at")).getString() + "〜" + e.setUnixTime(this.get("closed_at")).getString()
        },
        getTimeKeeper: function() {
            return new s({
                format: "%M/%D %H:%I",
                months: "01 02 03 04 05 06 07 08 09 10 11 12".split(" ")
            })
        }
    })
}), define("scenes/exchange_shop/models/RequiredItem", ["backbone", "lib/Model", "sprintf", "util"], function(e, t, n, r) {
    return t.extend({})
}), define("scenes/exchange_shop/views/vertical_layout/ModalExchangeConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/vertical_layout/ModalExchangeConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickModalDecide"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum
            }), this.setupComponents()
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalDecide: function() {
            this.trigger("onClickToExchange", {
                selectedPrizeObjs: this.selectedPrizeObjs,
                totalRequiredNum: this.totalRequiredNum
            }), this.end(!0)
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/exchange_shop/views/vertical_layout/ModalExchangeResult", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/vertical_layout/ModalExchangeResult", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, r.prototype.initialize.call(this)
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum
            }), this.setupComponents()
        },
        onClickModalClose: function() {
            this.requiredItemModel.get("num") <= 0 && n.history.navigate("#home", {
                trigger: !0
            }), this.end(!0)
        }
    })
}), define("scenes/exchange_shop/views/ModalEquipmentDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/ModalEquipmentDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            this.trigger("detailModalClose"), this.end()
        },
        render: function(e) {
            this.replaceDispName(e), this.renderContent(i, e)
        },
        replaceDispName: function(e) {
            e.description && (e.description = this.getDispName(e.description)), e.soul_strike && e.soul_strike.description && (e.soul_strike.description = this.getDispName(e.soul_strike.description)), e.soul_strike && e.soul_strike.extensive_description && (e.soul_strike.extensive_description = this.getDispName(e.soul_strike.extensive_description))
        },
        getDispName: function(e) {
            return e.replace(/{n}/g, "<br>")
        }
    })
}), define("scenes/exchange_shop/views/vertical_layout/Layout", ["underscore", "jquery", "backbone", "sprintf", "scenes/common/helper/ItemPossessionLimit", "templates/exchange_shop/vertical_layout/PrizeList", "lib/LayoutBase", "./ModalExchangeConfirm", "./ModalExchangeResult", "../ModalEquipmentDetail", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = o.extend({
        SELECTABLE_NUM: 5,
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-confirm]": "onClickPrize",
            "anchorsbeforejump [data-app-banner-id]": "onClickPrizeDetail",
            "anchorsbeforejump [data-app-prize-visual]": "onTapEquipDetail"
        },
        state: {
            calculatedNum: 0
        },
        initialize: function(e) {
            this.exchangeShopId = +e.exchangeShopId, this.exchangeShopModel = e.exchangeShopModel, this.prizeCollection = e.prizeCollection, this.requiredItemModel = e.requiredItemModel, this.memoryCrystalCollection = e.memoryCrystalCollection, this.EVENT_TYPE = e.EVENT_TYPE, this.hasLongTap = !1, this.possessionNum = this.requiredItemModel.get("num"), this._currentScrollHeight = 0, this.exchangeShopSystemName = this.exchangeShopModel.get("system_name"), o.prototype.initialize.call(this)
        },
        render: function() {
            o.prototype.render.call(this, s, {
                exchangeShopId: this.exchangeShopId,
                exchangeShopModel: this.exchangeShopModel,
                prizeCollection: this.prizeCollection,
                requiredItemModel: this.requiredItemModel,
                memoryCrystalCollection: this.memoryCrystalCollection
            }), this.setupComponents();
            var e = this.getBackgroundImagePath();
            this.setBackgroundImage(e), this.freescroll.startUp(this._currentScrollHeight), this.processAfterRender()
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onTapEquipDetail: function(e) {
            var n = this,
                r = t(e.target).closest("[data-app-prize-id]").attr("data-app-prize-id"),
                i = this.prizeCollection.findWhere({
                    exchange_shop_id: n.exchangeShopId,
                    id: +r
                }),
                s = i.get("item_package").items;
            if (s.length > 1) return;
            var o = s[0],
                u = o.type_name.toLowerCase() === "equipment" ? new f : null;
            if (!u) return;
            FF.router.loading.lock(), this.freescroll.cancelScroll(), this.hasLongTap = !0, FF.SoundMgr.playChooseEffect(), u.render(o), FF.router.overlay.registerChildren(u), u.open(), this.listenToOnce(u, "detailModalClose", function() {
                n.hasLongTap = !1
            })
        },
        onClickPrize: function(n) {
            if (this.hasLongTap) return;
            if (!FF.router.loading.lock()) return;
            var r = this,
                s = [],
                o = [],
                a = t(n.target).closest("[data-app-prize-id]").attr("data-app-prize-id"),
                f = this.prizeCollection.findWhere({
                    exchange_shop_id: r.exchangeShopId,
                    id: +a
                });
            s.push({
                prizeModel: f,
                num: 1
            }), o.push(f.getItemTypeNames());
            var l = e.reduce(s, function(e, t) {
                return e + t.prizeModel.get("required_num") * t.num
            }, 0);
            i.showModalIfOverLimitDeferred({
                itemTypeNames: e.uniq(e.flatten(o))
            }).done(function() {
                var e = new u({
                    selectedPrizeObjs: s,
                    requiredItemModel: r.requiredItemModel,
                    exchangeShopId: r.exchangeShopId,
                    totalRequiredNum: l
                });
                FF.router.overlay.registerChildren(e), e.render(), e.open(), r.listenToOnce(e, "onClickToExchange", r.onClickToExchange)
            })
        },
        onClickToExchange: function(e) {
            if (!FF.router.loading.lock()) return;
            this.trigger(this.EVENT_TYPE.EXCHANGE, e)
        },
        renderResult: function(e) {
            var t = this,
                n = new a({
                    selectedPrizeObjs: e.selectedPrizeObjs,
                    requiredItemModel: t.requiredItemModel,
                    exchangeShopId: t.exchangeShopId,
                    totalRequiredNum: e.totalRequiredNum
                });
            FF.router.overlay.registerChildren(n), n.render(), n.open(), t.listenToOnce(n, "closeAnimationEnd", function() {
                FF.router.loading.show(), t._currentScrollHeight = t.freescroll.getCurrentScroll(), t.possessionNum = t.requiredItemModel.get("num"), t.render()
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.resetBackgroundImage(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), o.prototype.dispose.call(this)
        },
        getBackgroundImagePath: function() {
            return pUrl(r("/dff/static/img/common/bg/bg_exchange_shop_%d.png", this.exchangeShopId))
        }
    });
    return h
}), define("scenes/exchange_shop/views/ritual_room_layout/ModalExchangeConfirm", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/ritual_room_layout/ModalExchangeConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-decide]": "onClickModalDecide"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, this.memoryCrystalCollection = e.memoryCrystalCollection, this.growEggImagePathTemplate = e.growEggImagePathTemplate, r.prototype.initialize.call(this)
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum,
                memoryCrystalCollection: this.memoryCrystalCollection,
                growEggImagePathTemplate: this.growEggImagePathTemplate
            }), this.setupComponents()
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickModalDecide: function() {
            this.trigger("onClickToExchange", {
                selectedPrizeObjs: this.selectedPrizeObjs,
                totalRequiredNum: this.totalRequiredNum
            }), this.end(!0)
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/exchange_shop/views/ritual_room_layout/ModalExchangeResult", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/exchange_shop/ritual_room_layout/ModalExchangeResult", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.selectedPrizeObjs = e.selectedPrizeObjs, this.requiredItemModel = e.requiredItemModel, this.exchangeShopId = e.exchangeShopId, this.totalRequiredNum = e.totalRequiredNum, this.growEggImagePathTemplate = e.growEggImagePathTemplate, r.prototype.initialize.call(this)
        },
        setupComponents: function() {
            var e = this;
            this.freescroll = new s({
                el: t('[data-ui-freescroll="exchange-confirm"]')
            }), this.scrollbar = new o({
                el: t('[data-ui-scrollbar="exchange-confirm"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        render: function() {
            this.renderContent(this.tmpl, {
                selectedPrizeObjs: this.selectedPrizeObjs,
                requiredItemModel: this.requiredItemModel,
                exchangeShopId: this.exchangeShopId,
                totalRequiredNum: this.totalRequiredNum,
                isAnimationAvailable: !FF.env.isIOS6_x() && !FF.env.isAndroid2_x(),
                growEggImagePathTemplate: this.growEggImagePathTemplate
            }), this.setupComponents(), this.listenTo(this, "openAnimationEnd", function() {
                t("#exchangedAnimationWrap").addClass("is-animate")
            })
        },
        onClickModalClose: function() {
            this.end(!0)
        }
    })
}), define("scenes/exchange_shop/views/ritual_room_layout/Layout", ["underscore", "jquery", "backbone", "sprintf", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/MissionHelper", "scenes/common/views/ModalCharacterAchievementInfo", "templates/exchange_shop/ritual_room_layout/PrizeList", "lib/LayoutBase", "./ModalExchangeConfirm", "./ModalExchangeResult", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = "/dff/static/lang/image/growegg/%d/%d_ritual_room_112.png",
        d = a.extend({
            contentType: "NO_STATUS",
            designType: "MODERN",
            events: {
                "anchorsbeforejump [data-app-prize-id]": "onClickPrize",
                "anchorslongtap [data-app-prize-id]": "onLongTapPrizeDetail"
            },
            initialize: function(e) {
                this.exchangeShopId = +e.exchangeShopId, this.exchangeShopModel = e.exchangeShopModel, this.prizeCollection = e.prizeCollection, this.requiredItemModel = e.requiredItemModel, this.memoryCrystalCollection = e.memoryCrystalCollection, this.EVENT_TYPE = e.EVENT_TYPE, this.hasLongTap = !1, this.possessionNum = this.requiredItemModel.get("num"), this._currentScrollHeight = 0, a.prototype.initialize.call(this)
            },
            render: function() {
                a.prototype.render.call(this, u, {
                    exchangeShopId: this.exchangeShopId,
                    exchangeShopModel: this.exchangeShopModel,
                    prizeCollection: this.prizeCollection,
                    requiredItemModel: this.requiredItemModel,
                    memoryCrystalCollection: this.memoryCrystalCollection,
                    growEggImagePathTemplate: p
                }), this.setupComponents();
                var e = this.getBackgroundImagePath();
                this.setBackgroundImage(e), this.freescroll.startUp(this._currentScrollHeight), this.processAfterRender()
            },
            processAfterContentLoad: function() {
                a.prototype.processAfterContentLoad.call(this), s.openModalMissionClearIfNeedDeferred()
            },
            setupComponents: function() {
                var e = this;
                this.freescroll = new c({
                    el: t("[data-ui-freescroll]")
                }), this.scrollbar = new h({
                    el: t("[data-ui-scrollbar]"),
                    watch: this.freescroll,
                    faceHeight: 31,
                    disableOverscroll: !0
                })
            },
            onLongTapPrizeDetail: function(e) {
                var n = this,
                    r = t(e.target).closest("[data-app-prize-id]").attr("data-app-prize-id"),
                    i = this.prizeCollection.findWhere({
                        exchange_shop_id: n.exchangeShopId,
                        id: +r
                    }),
                    s = i.get("item_package").items;
                if (s.length > 1) return;
                var o = s[0],
                    u = o.type_name.toLowerCase() === "buddy" ? this.openBuddyModal.bind(this) : null;
                if (!u) return;
                FF.router.loading.lock(), this.hasLongTap = !0, FF.SoundMgr.playChooseEffect(), u(o)
            },
            openBuddyModal: function(e) {
                var t = this,
                    n = e.item_id;
                FF.modalStack.push(o, {
                    initDeferred: function(e) {
                        return e.setupDeferred({
                            buddyId: n
                        })
                    },
                    renderer: function(e) {
                        e.render()
                    },
                    onPop: function() {
                        t.hasLongTap = !1
                    }
                })
            },
            onClickPrize: function(n) {
                if (this.hasLongTap) return;
                FF.router.loading.lock();
                var r = this,
                    s = [],
                    o = [],
                    u = t(n.target).attr("data-app-prize-id"),
                    a = this.prizeCollection.findWhere({
                        exchange_shop_id: r.exchangeShopId,
                        id: +u
                    });
                FF.SoundMgr.playChooseEffect(), s.push({
                    prizeModel: a,
                    num: 1
                }), o.push(a.getItemTypeNames());
                var l = e.reduce(s, function(e, t) {
                    return e + t.prizeModel.get("required_num") * t.num
                }, 0);
                i.showModalIfOverLimitDeferred({
                    itemTypeNames: e.uniq(e.flatten(o))
                }).done(function() {
                    var e = new f({
                        selectedPrizeObjs: s,
                        requiredItemModel: r.requiredItemModel,
                        exchangeShopId: r.exchangeShopId,
                        totalRequiredNum: l,
                        currentMotifNum: r.currentMotifNum,
                        memoryCrystalCollection: r.memoryCrystalCollection,
                        growEggImagePathTemplate: p
                    });
                    FF.router.overlay.registerChildren(e), e.render(), e.open(), r.listenToOnce(e, "onClickToExchange", r.onClickToExchange)
                })
            },
            renderResult: function(e) {
                var t = this,
                    n = new l({
                        selectedPrizeObjs: e.selectedPrizeObjs,
                        requiredItemModel: t.requiredItemModel,
                        exchangeShopId: t.exchangeShopId,
                        totalRequiredNum: e.totalRequiredNum,
                        growEggImagePathTemplate: p
                    });
                FF.router.overlay.registerChildren(n), n.render(), n.open(), t.listenToOnce(n, "closeAnimationEnd", function() {
                    FF.router.loading.show(), t._currentScrollHeight = t.freescroll.getCurrentScroll(), t.possessionNum = t.requiredItemModel.get("num"), t.render()
                })
            },
            onClickToExchange: function(e) {
                if (!FF.router.loading.lock()) return;
                this.trigger(this.EVENT_TYPE.EXCHANGE, e)
            },
            onClickBack: function() {
                window.history.back()
            },
            dispose: function() {
                this.resetBackgroundImage(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), a.prototype.dispose.call(this)
            },
            getBackgroundImagePath: function() {
                return pUrl(r("/dff/static/image/common/bg/bg_exchange_shop_%d.png", this.exchangeShopId))
            }
        });
    return d
}), define("scenes/exchange_shop/ExchangeShopScene", ["underscore", "jquery", "backbone", "scenes/exchange_shop/Api", "scenes/party/Api", "scenes/common/helper/PartyMemory", "scenes/common/helper/MissionHelper", "lib/Scene", "lib/Download", "scenes/common/collections/MemoryCrystal", "./models/ExchangeShop", "./models/RequiredItem", "./views/vertical_layout/Layout", "./views/ritual_room_layout/Layout", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = {
            EXCHANGE: "exchange_prize"
        },
        g = {};
    return u.extend({
        initialize: function() {
            var e = FF.CONST.SERVER.EXCHANGE_SHOP.LAYOUT_TYPE_OF;
            g[e.VERTICAL_LAYOUT] = h, g[e.RITUAL_ROOM_LAYOUT] = p, u.prototype.initialize.apply(this, arguments)
        },
        setupDeferred: function(s) {
            var o = this,
                u = t.Deferred();
            return function() {
                var e = t.Deferred();
                return FF.datastore.hasPartyAllData() ? e.resolve().promise() : (i.partyListDeferred().done(function(t) {
                    FF.datastore.addPartyAllData(t), e.resolve()
                }), e.promise())
            }().then(r.getExchangeShopDeferred.bind(r, s)).then(function(n) {
                var r = t.Deferred(),
                    i = n.assets.default_bgm;
                return a.hasFileNeededToDownloadDeferred(e.values(i), {
                    url: location.hash
                }).then(function(e) {
                    r.resolve({
                        hasFileResult: e,
                        exchangeShopData: n
                    })
                }), r.promise()
            }).done(function(e) {
                var t = e.hasFileResult,
                    r = e.exchangeShopData;
                t.needDownload ? n.history.navigate("download", {
                    trigger: !0,
                    replace: !0
                }) : u.resolve(r)
            }), u.promise()
        },
        start: function(e) {
            var t = this;
            this.exchangeShopId = e, this.setupDeferred(e).done(function(e) {
                t.assets = e.assets, t.exchangeShopModel = new l(e.exchange_shop), t.prizeCollection = t.exchangeShopModel.getPrizeCollection(), t.requiredItemModel = new c(e.required_user_item), t.memoryCrystalCollection = new f(e.memory_crystals);
                var n = g[t.exchangeShopModel.get("layout_type")];
                t.layoutView = new n({
                    exchangeShopId: t.exchangeShopId,
                    exchangeShopModel: t.exchangeShopModel,
                    prizeCollection: t.prizeCollection,
                    requiredItemModel: t.requiredItemModel,
                    memoryCrystalCollection: t.memoryCrystalCollection,
                    EVENT_TYPE: m
                }), t.layoutView.render(), t.listenTo(t.layoutView, m.EXCHANGE, t.exchange), t.exchangeShopModel.get("default_bgm_file") && FF.SoundMgr.playMusic(t.exchangeShopModel.get("default_bgm_file"))
            })
        },
        exchange: function(n) {
            FF.router.loading.lock();
            var i = this,
                s = n.selectedPrizeObjs,
                u = n.totalRequiredNum,
                a = {};
            e.each(s, function(e) {
                a[e.prizeModel.get("id")] = e.num
            });
            var f = null;
            r.exchangePrizeDeferred(i.exchangeShopId, a).then(function(e) {
                return f = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return o.saveAchievedMissionsDeferred(f.achieved_missions)
            }).done(function() {
                FF.datastore.clearHasPartyAllData(), FF.datastore.userModel.set(f.user), FF.datastore.itemPossessionLimitCollection.update(f.item_possession_limits), i.requiredItemModel.set(f.required_user_item), e.each(s, function(e) {
                    e.prizeModel.incrementExchangedNum(e.num)
                }), i.layoutView.renderResult({
                    selectedPrizeObjs: s,
                    requiredItemModel: i.requiredItemModel,
                    totalRequiredNum: u
                })
            })
        }
    })
}), define("scenes/ritual_room/pages/Base", ["underscore", "jquery", "backbone", "sprintf", "lib/LayoutBase"], function(e, t, n, r, i) {
    return i.extend({
        initialize: function(e) {
            i.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            throw new Error("Please override setupDeferred")
        },
        onClickTop: function() {
            n.history.navigate("#ritual_room/top", {
                trigger: !0
            })
        },
        onClickIntro: function() {
            n.history.navigate("#ritual_room/intro", {
                trigger: !0
            })
        }
    })
}), define("scenes/common/models/UserItem", ["./ItemBase"], function(e) {
    return e.extend({
        idAttribute: "item_id",
        attributeSchema: {
            item_id: void 0,
            num: void 0
        },
        isUserItem: function() {
            return !0
        }
    })
}), define("scenes/common/collections/UserItem", ["lib/Collection", "../models/UserItem"], function(e, t) {
    return e.extend({
        model: t
    })
}), define("scenes/ritual_room/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getRequiredUserItemsDeferred: function() {
            return this.requestDeferred("/dff/ritual_room/get_required_user_items", {})
        }
    })
}), define("scenes/ritual_room/pages/Top", ["underscore", "jquery", "backbone", "sprintf", "templates/ritual_room/RitualRoom", "./Base", "scenes/common/collections/UserItem", "../Api", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = "bgm_05_032";
    return s.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-exchange-shop-id]": "onSelectExchangeShop",
            "anchorsbeforejump [data-app-go-to-intro]": "onClickIntro"
        },
        initialize: function(e) {
            this.requiredUserItemCollection = void 0, s.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            var e = this;
            return this.playMusic(), u.getRequiredUserItemsDeferred().then(function(t) {
                e.requiredUserItemCollection = new o(t.required_user_items)
            })
        },
        playMusic: function() {
            FF.SoundMgr.playMusic(l)
        },
        render: function() {
            s.prototype.render.call(this, this.tmpl, {
                requiredUserItemCollection: this.requiredUserItemCollection
            }), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new a({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new f({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onSelectExchangeShop: function(e) {
            var i = +t(e.target).closest("[data-app-exchange-shop-id]").attr("data-app-exchange-shop-id"),
                s = r("#exchange_shop/%d", i);
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/ritual_room/pages/Intro", ["underscore", "jquery", "backbone", "sprintf", "templates/ritual_room/RitualRoomIntro", "./Base", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u) {
    return s.extend({
        contentType: "BASE",
        designType: "MODERN",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-go-to-top]": "onClickTop"
        },
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        render: function() {
            s.prototype.render.call(this, this.tmpl, {}), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new o({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new u({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBack: function() {
            window.history.back()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/ritual_room/RitualRoomScene", ["underscore", "jquery", "backbone", "./pages/Top", "./pages/Intro", "lib/Scene"], function(e, t, n, r, i, s) {
    return s.extend({
        pages: {
            top: r,
            intro: i
        },
        start: function(e) {
            var t = this,
                n = this.pages[e];
            if (!n) throw new Error("invalid ritural room page: " + e);
            this.layoutView = new n, this.layoutView.setupDeferred().done(function() {
                t.layoutView.render()
            })
        }
    })
}), define("scenes/application_campaign/Api", ["underscore", "scenes/common/util/Api"], function(e, t) {
    return e.extend({}, t, {
        getApplicationCampaignDeferred: function(e) {
            return this.requestDeferred("/dff/application_campaign/", {
                id: e
            })
        },
        postApplicationCampaignDeferred: function(e, t) {
            return this.requestDeferred("/dff/application_campaign/apply", {
                id: e,
                apply_key: t
            }, {
                type: "POST"
            })
        }
    })
}), define("scenes/application_campaign/views/Layout", ["backbone", "sprintf", "lib/LayoutBase", "scenes/application_campaign/Api", "templates/application_campaign/Done", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return n.extend({
        _campaignId: void 0,
        _applyKey: void 0,
        contentType: "BASE",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-btn-apply]": "onClickApply",
            "anchorsbeforejump [data-app-internal-url]": "onClickInternalLink"
        },
        initialize: function(e) {
            n.prototype.initialize.call(this), this._campaignId = e.campaignId, this._applyKey = e.applyKey
        },
        render: function(e) {
            var t = this;
            this.getTemplate(function(r) {
                n.prototype.render.call(t, r, e), t.setupComponents(), t.processAfterRender()
            })
        },
        getTemplate: function(e) {
            require([t("templates/application_campaign/Form_%d", this._campaignId)], function(t) {
                e(t)
            })
        },
        onClickApply: function() {
            var e = this;
            FF.router.loading.show(), this.freescroll.disposeFunctionality(), this.scrollbar.disposeFunctionality(), r.postApplicationCampaignDeferred(this._campaignId, this._applyKey).done(function(t) {
                FF.router.loading.hide();
                var r = {
                    campaignId: e._campaignId,
                    contents: t.contents
                };
                n.prototype.render.call(e, i, r), e.setupComponents()
            })
        },
        onClickInternalLink: function(t) {
            var n = $(t.target).attr("data-app-internal-url");
            e.history.navigate(n, {
                trigger: !0
            })
        },
        onClickBack: function() {
            e.history.navigate("#home", {
                trigger: !0
            })
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: $("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: $("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), n.prototype.dispose.call(this)
        }
    })
}), define("scenes/application_campaign/ApplicationCampaignScene", ["lib/Scene", "./Api", "./views/Layout"], function(e, t, n) {
    return e.extend({
        setupDeferred: function(e) {
            var n = $.Deferred();
            return t.getApplicationCampaignDeferred(e).done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        start: function(e) {
            var t = this;
            this.setupDeferred(+e).done(function(r) {
                t.layoutView = new n({
                    campaignId: +e,
                    applyKey: r.apply_key
                }), t.layoutView.render({
                    campaignId: +e,
                    isApplied: r.is_applied,
                    contents: r.contents
                })
            })
        }
    })
}), define("scenes/party/UserContext", ["underscore", "jquery", "backbone", "lib/ClassBase"], function(e, t, n, r) {
    return r.extend({
        _flash: {},
        _dungeonSessionModel: void 0,
        _localBackFragment: void 0,
        initialize: function() {
            this._flash = FF.router.flash(), this._dungeonSessionModel = FF.datastore.dungeonSessionModel
        },
        isInDungeon: function() {
            return this._dungeonSessionModel.isInDungeon()
        },
        isPreDungeon: function() {
            return this._flash.isPreDungeon
        },
        isInOperation: function() {
            return this._flash.isInOperation
        },
        getSeriesId: function() {
            return this.isPreDungeon() ? this._flash.seriesId : this.isInDungeon() ? this._dungeonSessionModel.get("series_id") : void 0
        },
        getAbilityCategoryBonusMap: function() {
            return this.isPreDungeon() ? this._flash.abilityCategoryBonusMap : this.isInDungeon() ? this._dungeonSessionModel.get("ability_category_bonus_map") : void 0
        },
        getStatusBonusOpt: function() {
            return {
                seriesId: this.getSeriesId(),
                abilityCategoryBonusMap: this.getAbilityCategoryBonusMap()
            }
        },
        getDungeonId: function() {
            return this.isPreDungeon() ? this._flash.dungeonId : void 0
        },
        getBackFragment: function() {
            var e;
            return this._flash.backFragment ? e = this._flash.backFragment : this._localBackFragment && (e = this._localBackFragment, this.setBackFragment(void 0)), e
        },
        setBackFragment: function(e) {
            this._localBackFragment = e
        },
        clearBackFragment: function(e) {
            this._flash.backFragment = void 0, this._localBackFragment = void 0
        }
    })
}), define("scenes/common/helper/DungeonBackground", ["jquery", "underscore"], function(e, t) {
    var n = {
        HISTORY: "/dff/static/img/common/bg/bg_dungeon_history.png",
        HISTORY_1_5x: "/dff/static/img/common/bg/bg_dungeon_history_1.5x.png",
        FORCE: "/dff/static/img/common/bg/bg_dungeon_force.png",
        FORCE_1_5x: "/dff/static/img/common/bg/bg_dungeon_force_1.5x.png"
    };
    return {
        getPathByWorldId: function(e, t) {
            var r = FF.datastore.worldCollection.get(+e);
            if (r.isEventWorld()) {
                var i = r.getEventModel(),
                    s = i.getHelper();
                return s.getBackgroundImagePath(i, t.isForce)
            }
            return t.isForce ? FF.env.isIOS() ? n.FORCE : n.FORCE_1_5x : FF.env.isIOS() ? n.HISTORY : n.HISTORY_1_5x
        },
        getPathByDungeonId: function(e, t) {
            var n = FF.datastore.dungeonCollection.get(+e);
            return n.get("background_image_path")
        }
    }
}), define("scenes/party/pages/Page", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/LayoutBase", "scenes/common/helper/FuncTutorial", "scenes/common/helper/DungeonInfo", "scenes/common/helper/DungeonBackground", "scenes/common/views/ModalDungeonInfo"], function(e, t, n, r, i, s, o, u, a) {
    var f = FF.env.isIOS7_0();
    return i.extend({
        categoryType: "party",
        contentType: "ONLY_BTN",
        designType: "MODERN",
        funcTutorialKey: undefined,
        isTutorialIllustOnly: !1,
        initialize: function(t) {
            t = e.isObject(t) ? t : {}, this.scene = t.scene, this.context = t.context, this._applyContext(), i.prototype.initialize.call(this)
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve().promise()
        },
        render: function(e, t) {
            t = t || {}, t.context = t.context || this.context, i.prototype.render.call(this, e, t), this._updateBackground()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.showFuncTutorialIfNeed()
        },
        showFuncTutorialIfNeed: function() {
            var e = this.funcTutorialKey;
            e && s.showNavigationDeferred({
                key: e,
                isTutorialIllustOnly: this.isTutorialIllustOnly
            })
        },
        _applyContext: function() {
            this.context.isPreDungeon() && (this.contentType = "ONLY_BTN", this.events["anchorsbeforejump [data-app-dungeon-info]"] = "onClickDungeonInfo")
        },
        _updateBackground: function() {
            var e, t;
            this.context.isPreDungeon() ? (e = FF.datastore.dungeonCollection.get(this.context.getDungeonId()), t = u.getPathByWorldId(e.get("world_id"), {
                isForce: e.isForce()
            }), this.setBackgroundImage(t)) : this.context.isInOperation() && (e = FF.datastore.currentDungeonModel, t = u.getPathByDungeonId(e.get("id"), {
                isForce: e.isForce()
            }), this.setBackgroundImage(t))
        },
        onClickSortieLimitation: function() {
            this.blurSelectorOrder(), s.showSortieLimitationDeferred()
        },
        onClickDungeonInfo: function() {
            if (!this.isPreDungeon()) return;
            o.openDeferred(this.context.getDungeonId(), {
                selectedType: a.SELECTED_TYPE_OF.BOSS
            })
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        },
        isInDungeon: function() {
            return this.context.isInDungeon()
        },
        isPreDungeon: function() {
            return this.context.isPreDungeon()
        },
        onTouchEndSort: function() {
            f && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onMouseMoveSort: function() {
            f && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").hide()
        },
        onFocusSort: function() {
            t(document).trigger("focusInput")
        },
        onBlurSort: function() {
            f && t("#footDeco, [data-app-btn-decide-container], [data-app-confirm-btn-container], [data-app-eliminate-onfocus]").show(), FF.env.isIOS() && setTimeout(function() {
                window.scrollTo(0, 1)
            }, 100)
        }
    })
}), define("scenes/common/helper/Align", ["jquery", "underscore", "scenes/common/models/Party", "scenes/party/Api"], function(e, t, n, r) {
    var i = {
        FRONT: 1,
        BACK: 2
    };
    return {
        initialize: function() {
            this._alignMap = {}
        },
        setAlignDeferred: function(t, n) {
            var s = e.Deferred(),
                o = t.hasClass("is-back") ? i.BACK : i.FRONT,
                u = FF.datastore.buddyCollection.get(n);
            u.setTmpRow(o), FF.SoundMgr.playChooseEffect();
            if (this._isAlignChanged(u)) {
                var a = {};
                a[n] = o, r.buddySaveRowDeferred(a).done(function(e) {
                    u.fixTmpRow(), s.resolve()
                })
            } else s.resolve();
            return s.promise()
        },
        _isAlignChanged: function(e) {
            return e.getRow() !== e.getTmpRow()
        },
        setPartyAlign: function(e, t) {
            var n = e.hasClass("is-back") ? i.BACK : i.FRONT;
            this._alignMap[t] = n;
            var r = FF.datastore.buddyCollection.get(t);
            r.setTmpRow(n), FF.SoundMgr.playChooseEffect()
        },
        onCompleteChangeAlignDeferred: function() {
            var n = this,
                i = e.Deferred();
            if (!this._isPartyAlignChanged()) return i.resolve().promise();
            var s = this._alignMap;
            return r.buddySaveRowDeferred(s).done(function(e) {
                var r = FF.datastore.partyModel.getBuddyModels();
                t.each(r, function(e) {
                    if (!e) return !1;
                    if (!s[e.get("id")]) return !1;
                    e.fixTmpRow(), n._alignMap = {}
                }), i.resolve()
            }), i.promise()
        },
        _isPartyAlignChanged: function() {
            var e = this._alignMap,
                n = FF.datastore.partyModel.getBuddyModels();
            return t.some(n, function(t) {
                return t ? e[t.get("id")] ? t.getRow() !== e[t.get("id")] ? !0 : !1 : !1 : !1
            })
        },
        dispose: function() {
            this._alignMap = void 0
        }
    }
}), define("scenes/party/views/ModalDetachAllItems", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalDetachAllItems", "templates/party/views/ModalDetachAllItemsConfirm"], function(e, t, n, r, i, s, o) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalCancel",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-detach-all-items-confirm]": "onClickDetachAllItemsConfirm",
            "anchorsbeforejump [data-app-detach-all-items-execute]": "onClickDetachAllItemsExecute",
            "anchorsbeforejump [data-app-modal-members-checkbox]": "onClickMembersCheckBox",
            "anchorsbeforejump [data-app-modal-items-checkbox]": "onClickItemsCheckBox"
        },
        initialize: function() {
            var e = FF.datastore.dungeonSessionModel.isInDungeon();
            this.detachOptions = {
                members: {
                    partyMember: e ? !1 : !0,
                    waitingMember: !0
                },
                items: {
                    equipment: !0,
                    ability: !0,
                    recordMateria: !0
                }
            }
        },
        onClickMembersCheckBox: function(e) {
            var n = e.currentTarget,
                r = n.attributes["data-app-selected-content"].value;
            this._toggleOptions("members", r), t(e.currentTarget).toggleClass("is-checked"), this.toggleConfirmButtonIfNeed()
        },
        onClickItemsCheckBox: function(e) {
            var n = e.currentTarget,
                r = n.attributes["data-app-selected-content"].value;
            this._toggleOptions("items", r), t(e.currentTarget).toggleClass("is-checked"), this.toggleConfirmButtonIfNeed()
        },
        toggleConfirmButtonIfNeed: function() {
            this._canConfirmByMembers() && this._canConfirmByItems() ? t("[data-app-detach-all-items-confirm]").removeClass("is-disable") : t("[data-app-detach-all-items-confirm]").addClass("is-disable")
        },
        _canConfirmByMembers: function() {
            return this.detachOptions.members.partyMember === !1 && this.detachOptions.members.waitingMember === !1 ? !1 : !0
        },
        _canConfirmByItems: function() {
            return this.detachOptions.items.equipment === !1 && this.detachOptions.items.ability === !1 && this.detachOptions.items.recordMateria === !1 ? !1 : !0
        },
        _toggleOptions: function(e, t) {
            this.detachOptions[e][t] === !0 ? this.detachOptions[e][t] = !1 : this.detachOptions[e][t] = !0
        },
        onClickModalCancel: function() {
            this.render()
        },
        onClickModalClose: function() {
            this.trigger("detachAllItemsOnClickClose"), FF.modalStack.pop()
        },
        onClickDetachAllItemsConfirm: function() {
            var e = o({
                checkBoxInfo: this.detachOptions,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon()
            });
            this.putContent(e)
        },
        onClickDetachAllItemsExecute: function() {
            this.trigger("detachAllItemsExecute", this.detachOptions)
        },
        render: function() {
            var e = s({
                checkBoxInfo: this.detachOptions,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon()
            });
            this.putContent(e)
        }
    })
}), define("scenes/party/helper/AllItemDetacher", ["jquery", "underscore", "scenes/common/models/Party", "scenes/party/Api"], function(e, t, n, r) {
    var i = {
        API_REQUEST_INTERVAL: 200
    };
    return {
        setupDeferred: function() {
            var t = this,
                n = e.Deferred();
            return FF.datastore.hasPartyAllData() ? n.resolve().promise() : (r.partyListDeferred().done(function(e) {
                FF.datastore.addPartyAllData(e), n.resolve()
            }), n.promise())
        },
        prepareDetachAllItems: function(e) {
            return this.detachOptions = e, this.targetBuddies = this._getTargetBuddies(), t.each(this.targetBuddies, function(t) {
                t.detachAllItems({
                    detachEquipments: e.items.equipment,
                    detachAbilities: e.items.ability,
                    detachRecordMaterias: e.items.recordMateria
                })
            }), FF.datastore.buddyCollection.hasAnyChanged()
        },
        execApiRequestCyclicallyDeferred: function() {
            var t = this,
                n = e.Deferred();
            if (this.targetBuddies.length === 0) return n.resolve().promise();
            var r = function(e) {
                    e.then(function() {
                        if (t.targetBuddies.length === 0) {
                            n.resolve();
                            return
                        }
                        setTimeout(function() {
                            var e = t._executeDetachAllItemsDeferred(t._extractApiInfos());
                            r(e)
                        }, i.API_REQUEST_INTERVAL)
                    })
                },
                s = this._executeDetachAllItemsDeferred(this._extractApiInfos());
            return r(s), n.promise()
        },
        _executeDetachAllItemsDeferred: function(t) {
            var n = this,
                i = e.Deferred(),
                s = FF.datastore.partyModel,
                o = {
                    type: FF.CONST.SERVER.PARTY.SAVE_CONTEXT_TYPE_OF.DETACH_ALL
                };
            return r.partyBulkSaveDeferred(s, t, o).then(function(e) {
                FF.datastore.updatePartyAssets(e), i.resolve()
            }), i.promise()
        },
        _extractApiInfos: function() {
            var e = FF.datastore.partyModel,
                n = FF.datastore.buddyCollection,
                r = n.getChangedEquipmentInfo(),
                i = n.getChangedSoulStrikeInfo(),
                s = n.getChangedAbilityInfo(),
                o = n.getChangedRowInfo({
                    partyModel: e
                }),
                u = n.getChangedRecordMateriaInfo(),
                a = {
                    equipment: {},
                    ability: {},
                    soulStrike: {},
                    row: {},
                    recordMateria: {}
                },
                f = FF.CONST.SERVER.PARTY.MAX_MODIFY_BUDDY_NUM,
                l = 0;
            while (this.targetBuddies.length > 0 && l < f) {
                var c = this.targetBuddies.shift(),
                    h = c.get("id"),
                    p = r[h],
                    d = i[h],
                    v = s[h],
                    m = u[h],
                    g = !t.isEqual(p, undefined) || !t.isEqual(d, undefined) || !t.isEqual(v, undefined) || !t.isEqual(m, undefined);
                g && (l++, a.equipment[h] = p, a.soulStrike[h] = d, a.ability[h] = v, a.recordMateria[h] = m)
            }
            return a
        },
        _getTargetBuddies: function() {
            var e = this.detachOptions,
                n = FF.datastore.partyModel,
                r = [];
            return e.members.partyMember === !0 && e.members.waitingMember === !0 ? (Array.prototype.push.apply(r, n.getBuddyModels()), Array.prototype.push.apply(r, n.getBuddyModelsOutOfParty())) : e.members.partyMember === !0 && e.members.waitingMember === !1 ? Array.prototype.push.apply(r, n.getBuddyModels()) : Array.prototype.push.apply(r, n.getBuddyModelsOutOfParty()), t.filter(r, function(e) {
                return e ? !0 : !1
            })
        }
    }
}), define("scenes/party/views/InParty", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/common/Constant", "scenes/common/helper/Align", "scenes/common/helper/PartyMemory", "scenes/common/helper/PartyRecommend", "scenes/common/views/party_memory/ModalPartyMemory", "scenes/party/views/ModalCharacterDetail", "scenes/party/views/ModalDetachAllItems", "scenes/party/helper/AllItemDetacher", "components/SlideIn", "templates/party/views/InParty"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    var d = e.extend({}, i, {
            RECOMMENDED_CLASS_NAME: "is-recommended",
            DISPLAY_CLASS_NAME: "di-n",
            DISABLE_CLASS_NAME: "is-disable",
            ENABLE_CLASS_NAME: "is-enable",
            TOGGLE_CLASS_NAME: "is-toggle",
            UNTOUCHABLE_CLASS_NAME: "pe-n",
            WAIT_MSEC_TO_START_CALC: 100
        }),
        v = {
            RENDER: "render",
            CANCEL: "cancel",
            ALIGN: "align"
        };
    return r.extend({
        events: {
            "anchorsbeforejump [data-app-equipments]": "onClickEquipments",
            "anchorsbeforejump [data-app-abilities]": "onClickAbilities",
            "anchorsbeforejump [data-app-recordMateria]": "onClickRecordMateria",
            "anchorsbeforejump [data-app-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-decide]": "onClickSave",
            "anchorsbeforejump #partyMemory": "onClickPartyMemory",
            "anchorsbeforejump #recommendedParty": "onClickRecommend",
            "anchorsbeforejump [data-app-party-member-img]": "onClickBuddyImg",
            "anchorsbeforejump #detachAllItems": "onClickDetachAllItems",
            "anchorsbeforejump #alignEdit": "onClickAlignEdit",
            "anchorsbeforejump #alignEditDecide": "onClickAlignEdit",
            "anchorsbeforejump #editMenuBtn": "onClickeditMenu",
            "anchorsbeforejump #editMenuOverlay": "onClickEditMenuOverlay",
            "anchorsbeforejump #gotoMemberEdit": "onClickGoToMemberEdit",
            "anchorsbeforejump #gotoEquipEdit": "onClickGoToEquipEdit",
            "anchorsbeforejump #gotoAbilityEdit": "onClickGoToAbilityEdit",
            "anchorsbeforejump #gotoSoulStrikeEdit": "onClickGoToSoulStrikeEdit",
            "anchorsbeforejump #gotoRecordMateriaEdit": "onClickGoToRecordMateriaEdit",
            "anchorsbeforejump #showStatus": "onClickShowStatus",
            "anchorslongtap [data-app-party-member-img]": "_onLongTapCharaDetailView"
        },
        initialize: function(e) {
            e = e || {}, this._recommendedPartyModel = void 0, this._statusBonusOpt = e.statusBonusOpt ? e.statusBonusOpt : FF.datastore.dungeonSessionModel.getStatusBonusOpt(), this._partyNavigateParams = e.partyNavigateParams || {}, this.isInDungeon = FF.datastore.partyStatusModel.isInDungeon(), s.initialize(), this.footerEventHandlerFunc = this._onClickGlobalNavi.bind(this), this._addFooterEvent(this.footerEventHandlerFunc), this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.initialize(["isLocked", "isPushingRecommend", "isEditingAlign", "isShowStatus", "savedRecommendedData"])
        },
        render: function() {
            var t = this._recommendedPartyModel ? this._recommendedPartyModel.getBuddyModels() : e.map(FF.CONST.SERVER.PARTY.SLOTS, function() {
                return null
            });
            r.prototype.render.call(this, p, {
                PARTY_SLOTS: FF.CONST.SERVER.PARTY.SLOTS,
                PARTY_TOP_SUB_CATEGORY: FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY,
                partyStatusMap: FF.datastore.partyStatusModel.getIdToDataMap(),
                originalBuddies: FF.datastore.partyModel.getBuddyModels(),
                isInDungeon: this.isInDungeon,
                statusBonusOpt: this._statusBonusOpt,
                recommendedParty: this._recommendedPartyModel,
                recommendedBuddies: t,
                isRecommended: this.lockFlagManager.isLocked("isPushingRecommend")
            }), this._generateComponents(), this.trigger(v.RENDER, this), this._recommendedPartyModel && this._addRecommendedClass(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            r.prototype.processAfterContentLoad.call(this), this.lockFlagManager.isLocked("savedRecommendedData") && (this._toggleButtonIfNeed("#detachAllItems"), this.lockFlagManager.unlock("savedRecommendedData"))
        },
        _addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("touchend", e)
        },
        _removeFooterEvent: function(e) {
            t(".g-navigation [data-mbgaui-anchors]").off("touchend", e), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation()
        },
        _generateComponents: function() {
            this._slidein && this._slidein.dispose(), this._slidein = new h({
                el: t("[data-ui-slidein]")
            })
        },
        getIsPushingRecommend: function() {
            return this.lockFlagManager.isLocked("isPushingRecommend")
        },
        onClickRecommend: function(e) {
            var n = this;
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock(["isLocked", "isPushingRecommend"]), FF.router.loading.showDeferred().done(function() {
                n._toggleButtonsIfNeed(), n._hideStatusIfNeed(), n._calcRecommendedDataDeferred().then(function() {
                    n.lockFlagManager.unlock("isLocked"), n._isChangedByRecommend() ? (n.render(), n._showBtnContainer()) : (FF.router.toast.getIsMoving() || (n._clearRecommendedData(), n.lockFlagManager.unlock("isPushingRecommend"), n._toggleButtonsIfNeed(), FF.router.toast.topping(t("#toast-message-already-recommended").text()).bake()), FF.router.loading.hide())
                })
            })
        },
        _calcRecommendedDataDeferred: function() {
            var e = this,
                n = !1,
                r = t.Deferred(),
                i = d.WAIT_MSEC_TO_START_CALC;
            if (n) var s = setInterval(function() {
                n || (r.resolve(), clearInterval(s))
            }, i);
            else n = !0, u.setupDeferred().then(function() {
                return u.recommendDeferred(i, {
                    seriesId: e._statusBonusOpt.seriesId
                })
            }).then(function(t) {
                e._recommendedPartyModel = t, n = !1, r.resolve()
            });
            return r.promise()
        },
        _toggleButtonIfNeed: function(e) {
            this.lockFlagManager.isLocked("isPushingRecommend") ? t(e).addClass(d.DISABLE_CLASS_NAME) : t(e).removeClass(d.DISABLE_CLASS_NAME)
        },
        _toggleButtonsIfNeed: function() {
            this._toggleButtonIfNeed("#detachAllItems"), this._toggleButtonIfNeed("#partyMemory"), this._toggleButtonIfNeed("#recommendedParty"), this._toggleButtonIfNeed("#alignEdit"), this._toggleButtonIfNeed("#showStatus")
        },
        _addRecommendedClass: function() {
            e.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                t('[data-app-buddy-position="' + e + '"]').addClass(d.RECOMMENDED_CLASS_NAME)
            })
        },
        _removeRecommendedClass: function() {
            e.each(FF.CONST.SERVER.PARTY.SLOTS, function(e) {
                t('[data-app-buddy-position="' + e + '"]').removeClass(d.RECOMMENDED_CLASS_NAME)
            })
        },
        onClickSave: function(e) {
            var n = this;
            FF.router.loading.lock(), e.preventDefault();
            if (!this._recommendedPartyModel) throw new Error("not midified party");
            var r = this._recommendedPartyModel;
            if (!this.lockFlagManager.isLocked("isPushingRecommend")) {
                FF.router.loading.unlock();
                return
            }
            this.lockFlagManager.unlock("isPushingRecommend"), this._isChangedByRecommend() ? u.saveToServerDeferred(r).done(function(e) {
                FF.datastore.buddyCollection.fixTmpRow(), FF.datastore.partyModel.set(r.attributes), FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpAbilities(), FF.datastore.fixTmpRecordMaterias(), FF.datastore.fixTmpSoulStrikes(), FF.router.toast.topping(t("#toast-message-onchange").text()), n._recommendedPartyModel = void 0, n.lockFlagManager.lock("savedRecommendedData"), n.render(), n._hideBtnContainer(), FF.router.loading.hide()
            }) : (this._toggleButtonsIfNeed(), FF.router.loading.unlock())
        },
        _isChangedByRecommend: function() {
            return u.isChangedByRecommend(this._recommendedPartyModel)
        },
        onClickCancel: function(e) {
            FF.router.loading.lock(), this.lockFlagManager.unlock("isPushingRecommend"), e.preventDefault();
            if (!this._recommendedPartyModel) throw new Error("not modified party");
            this._clearRecommendedData(), this._cancelRecommendedData(), t("." + d.RECOMMENDED_CLASS_NAME).removeClass(d.RECOMMENDED_CLASS_NAME), this._removeRecommendedClass(), this._hideBtnContainer(), this._toggleButtonsIfNeed(), this.trigger(v.CANCEL, this)
        },
        _clearRecommendedData: function() {
            if (!this._recommendedPartyModel) return;
            this._recommendedPartyModel.dispose(), this._recommendedPartyModel = void 0
        },
        _showBtnContainer: function() {
            var e = this;
            this._slidein.slide(), this._disableRecommendButton(), this.listenTo(this._slidein, "slide:switched", function() {
                e._enableRecommendButton(), FF.router.loading.hide()
            })
        },
        _hideBtnContainer: function() {
            var e = this;
            this._slidein.back(), this._disableRecommendButton(), this.listenTo(this._slidein, "slide:original", function() {
                e._enableRecommendButton(), FF.router.loading.hide()
            })
        },
        _disableRecommendButton: function() {
            t("[data-app-decide]").addClass(d.DISABLE_CLASS_NAME), t("[data-app-cancel]").addClass(d.DISABLE_CLASS_NAME), t("#recommendedParty").addClass(d.UNTOUCHABLE_CLASS_NAME)
        },
        _enableRecommendButton: function() {
            t("[data-app-decide]").removeClass(d.DISABLE_CLASS_NAME), t("[data-app-cancel]").removeClass(d.DISABLE_CLASS_NAME), t("#recommendedParty").removeClass(d.UNTOUCHABLE_CLASS_NAME)
        },
        onClickPartyMemory: function() {
            var e = this;
            if (this.lockFlagManager.isLocked("isLocked")) return;
            FF.router.loading.showDeferred().done(function() {
                e._onLeave(), e._clearRecommendedData(), e._hideStatusIfNeed(), o.openPartyMemoryListModalDeferred(e._statusBonusOpt).then(function(t) {
                    e.lockFlagManager.unlock("isLocked");
                    if (!t || !t.event) return;
                    t.event === "loadComplete" && e._onPartyMemoryLoad(t)
                })
            })
        },
        _onLeave: function() {
            this._cancelRecommendedData(), this.lockFlagManager.lock("isLocked")
        },
        _cancelRecommendedData: function() {
            FF.datastore.resetTmpEquipments(), FF.datastore.resetTmpAbilities(), FF.datastore.resetTmpRecordMaterias(), FF.datastore.buddyCollection.resetTmpRow()
        },
        _onPartyMemoryLoad: function(n) {
            this.render();
            var r = "#toast-message-party-memory-load-complete";
            n.foundLostItem && (r += "-and-found-lost");
            var i = n.partyName,
                s = t(r).text(),
                o = e.template(s, n);
            window.setTimeout(function() {
                FF.router.toast.topping(o).bake()
            }, 0)
        },
        _onLongTapCharaDetailView: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "isEditingAlign"])) return;
            this.lockFlagManager.lock("isLocked"), FF.SoundMgr.playChooseEffect();
            var n = this,
                r = t(e.target),
                i = r.closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                s = +r.closest("[data-app-is-original]").attr("data-app-is-original") ? !1 : !0,
                o = FF.datastore.buddyCollection.get(i);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(o, {
                        useTmpInfo: s,
                        statusBonusOpt: n._statusBonusOpt
                    }), n.listenToOnce(e, "closeAnimationEnd", function() {
                        n.lockFlagManager.unlock("isLocked")
                    })
                }
            })
        },
        onClickDetachAllItems: function() {
            var e = this;
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), this._hideStatusIfNeed(), c.setupDeferred().done(function() {
                FF.modalStack.push(l, {
                    renderer: function(t) {
                        t.render(), e.listenToOnce(t, "openAnimationEnd", function() {
                            e.lockFlagManager.unlock("isLocked")
                        }), e.listenToOnce(t, "detachAllItemsExecute", function(n) {
                            e.lockFlagManager.lock("isLocked"), e.listenToOnce(t, "closeAnimationEnd", function() {
                                e._prepareAndExecAllItemDetachment(n)
                            }), FF.modalStack.pop()
                        })
                    }
                })
            })
        },
        _prepareAndExecAllItemDetachment: function(e) {
            var n = this,
                r = c.prepareDetachAllItems(e);
            r ? c.execApiRequestCyclicallyDeferred().then(function() {
                FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpAbilities(), FF.datastore.fixTmpRecordMaterias(), FF.datastore.fixTmpSoulStrikes(), n.render(), n.lockFlagManager.unlock("isLocked"), window.setTimeout(function() {
                    FF.router.toast.topping(t("#toast-message-detach-all").text()).bake()
                }, 0)
            }) : (this.lockFlagManager.unlock("isLocked"), FF.router.toast.topping(t("#toast-message-already-detached").text()).bake())
        },
        onClickAlignEdit: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show();
            var e = this;
            this.lockFlagManager.isLocked("isEditingAlign") ? s.onCompleteChangeAlignDeferred().done(function() {
                e._toggleEnableAlignEdit(), e.lockFlagManager.unlock("isEditingAlign"), e.lockFlagManager.unlock("isLocked"), e.trigger(v.ALIGN), FF.router.loading.hide()
            }) : (this._hideStatusIfNeed(), this._toggleEnableAlignEdit(), this.lockFlagManager.lock("isEditingAlign"), this.lockFlagManager.unlock("isLocked"), FF.router.loading.hide(), this.trigger(v.ALIGN))
        },
        _toggleEnableAlignEdit: function() {
            t("#alignEdit").toggleClass(d.DISPLAY_CLASS_NAME), t("#alignEditDecide").toggleClass(d.DISPLAY_CLASS_NAME).toggleClass(d.ENABLE_CLASS_NAME), t("[data-app-party-member-img]").toggleClass(d.TOGGLE_CLASS_NAME), t("[data-app-buddy-align-list]").toggleClass(d.ENABLE_CLASS_NAME), t("#partyTopOverlay").toggleClass(d.DISPLAY_CLASS_NAME), t("[data-app-dungeon-info]").toggleClass(d.DISABLE_CLASS_NAME)
        },
        onClickBuddyImg: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked");
            if (this.lockFlagManager.isLocked("isEditingAlign")) this.toggleAlign(e);
            else {
                if (this.lockFlagManager.isLocked("isPushingRecommend")) {
                    FF.SoundMgr.playNgEffect(), this.lockFlagManager.unlock("isLocked");
                    return
                }
                this.onClickGoToMemberEdit()
            }
            this.lockFlagManager.unlock("isLocked")
        },
        toggleAlign: function(e) {
            if (this.lockFlagManager.isLocked("isPushingRecommend")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            var n = t(e.originalEvent.srcElement).find("[data-app-toggle-align]"),
                r = n.toggleClass("is-back"),
                i = t(n).closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            s.setPartyAlign(r, i)
        },
        onClickeditMenu: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show(), FF.SoundMgr.playChooseEffect(), this._hideStatusIfNeed(), t("#editMenuBtnWrap").toggleClass(d.ENABLE_CLASS_NAME), t("#editMenuOverlay").toggleClass(d.ENABLE_CLASS_NAME), t("#editMenuList").toggleClass(d.DISPLAY_CLASS_NAME), t("#partyTopOverlay").toggleClass(d.DISPLAY_CLASS_NAME), e.preventDefault(), e.stopPropagation(), this.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
        },
        onClickEditMenuOverlay: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show(), t("#editMenuBtnWrap").removeClass(d.ENABLE_CLASS_NAME), t("#editMenuOverlay").removeClass(d.ENABLE_CLASS_NAME), t("#editMenuList").addClass(d.DISPLAY_CLASS_NAME), t("#partyTopOverlay").addClass(d.DISPLAY_CLASS_NAME), this.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
        },
        onClickGoToMemberEdit: function() {
            var e = "#party/party_edit";
            this._goToEquipmentPage(e)
        },
        onClickGoToEquipEdit: function() {
            var e = FF.datastore.partyModel.getLeaderBuddyModel().get("id"),
                t = "#party/equipment/" + e + "/" + d.PARTY_TOP_SUB_CATEGORY.EQUIPMENT;
            this._goToEquipmentPage(t)
        },
        onClickGoToAbilityEdit: function() {
            var e = FF.datastore.partyModel.getLeaderBuddyModel().get("id"),
                t = "#party/equipment/" + e + "/" + d.PARTY_TOP_SUB_CATEGORY.ABILITY;
            this._goToEquipmentPage(t)
        },
        onClickGoToSoulStrikeEdit: function() {
            var e = FF.datastore.partyModel.getLeaderBuddyModel().get("id"),
                t = "#party/equipment/" + e + "/" + d.PARTY_TOP_SUB_CATEGORY.SOULSTRIKE;
            this._goToEquipmentPage(t)
        },
        onClickGoToRecordMateriaEdit: function() {
            var e = FF.datastore.partyModel.getLeaderBuddyModel().get("id"),
                t = "#party/equipment/" + e + "/" + d.PARTY_TOP_SUB_CATEGORY.RECORD_MATERIA;
            this._goToEquipmentPage(t)
        },
        onClickShowStatus: function() {
            FF.router.loading.lock(), this.lockFlagManager.isLocked("isShowStatus") ? this._hideStatusIfNeed() : (this.lockFlagManager.lock("isShowStatus"), t("#partyStatus").toggleClass(d.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(d.DISPLAY_CLASS_NAME)), FF.router.loading.unlock()
        },
        _hideStatusIfNeed: function() {
            if (!this.lockFlagManager.isLocked("isShowStatus")) return;
            t("#partyStatus").addClass(d.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').addClass(d.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(d.DISPLAY_CLASS_NAME), this.lockFlagManager.unlock("isShowStatus")
        },
        _goToEquipmentPage: function(e) {
            if (this.lockFlagManager.isLocked("isPushingRecommend")) {
                FF.router.toast.topping(t("#toast-message-must-click-fix-btn").text()).bake();
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), FF.router.navigate(e, {
                trigger: !0,
                params: this._partyNavigateParams
            })
        },
        _makeCategoryFragment: function(e, n) {
            var r = t(e.target).closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            return "#party/equipment/" + r + "/" + n
        },
        onClickEquipments: function(e) {
            var t = this._makeCategoryFragment(e, d.PARTY_TOP_SUB_CATEGORY.EQUIPMENT);
            this._goToEquipmentPage(t)
        },
        onClickAbilities: function(e) {
            var t = this._makeCategoryFragment(e, d.PARTY_TOP_SUB_CATEGORY.ABILITY);
            this._goToEquipmentPage(t)
        },
        onClickRecordMateria: function(e) {
            var t = this._makeCategoryFragment(e, d.PARTY_TOP_SUB_CATEGORY.RECORD_MATERIA);
            this._goToEquipmentPage(t)
        },
        _onClickGlobalNavi: function(e) {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            var r = this,
                i = t(e.currentTarget).attr("data-app-href");
            return i === "#party" && this.enableUserTouch(), n.history.getFragment() !== i.replace(/^#/, "") ? (this._onLeave(), FF.SoundMgr.playChooseEffect(), n.history.navigate(i, {
                trigger: !0
            })) : FF.router.loading.hide(), !1
        },
        dispose: function() {
            this._removeFooterEvent(this.footerEventHandlerFunc), this.lockFlagManager && this.lockFlagManager.dispose(), this._slidein && this._slidein.dispose(), this._recommendedPartyModel && (this._clearRecommendedData(), this._cancelRecommendedData()), s.dispose(), r.prototype.dispose.call(this)
        }
    }, {
        EVENTS: v
    })
}), define("scenes/common/helper/SoulStrikeTutorial", [], function() {
    return {
        navigateIfNeedDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.userModel,
                n = t.hasProceededFuncTutorial("SS_MULTI_AND_EXP"),
                r = t.hasProceededFuncTutorial("SS_MULTI"),
                i = t.hasProceededFuncTutorial("SS_EXP");
            if (n || r && i) return e.resolve().promise();
            var s = FF.datastore.equipmentCollection.any(function(e) {
                    return e.get("has_someones_soul_strike")
                }),
                o = FF.datastore.soulStrikeCollection.any(function(e) {
                    return !e.get("allowed_buddy_id")
                }),
                u = this.getFragmentByCondition({
                    proceededSsMultiAndExp: n,
                    proceededSsMulti: r,
                    proceededSsExp: i,
                    hasSomeonesSs: s,
                    hasSharedSs: o
                });
            return u ? (Backbone.history.navigate(u, {
                trigger: !0
            }), e.reject()) : e.resolve(), e.promise()
        },
        getFragmentByCondition: function(e) {
            if (!e.hasSomeonesSs && !e.hasSharedSs) return;
            if (!e.proceededSsMulti && !e.proceededSsExp && e.hasSomeonesSs) return "#func_tutorial/ss_multi_and_exp";
            if (e.proceededSsMulti && e.hasSomeonesSs) return "#func_tutorial/ss_exp";
            if (!e.proceededSsMulti && e.hasSharedSs) return "#func_tutorial/ss_multi";
            return
        }
    }
}), define("scenes/party/pages/Party", ["underscore", "jquery", "backbone", "scenes/common/helper/LockFlagManager", "scenes/party/pages/Page", "scenes/party/views/InParty", "templates/party/Party", "scenes/common/helper/FuncTutorial", "scenes/common/helper/SoulStrikeTutorial"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        contentType: "NO_STATUS",
        funcTutorialKey: "PARTY_TOP",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump [data-app-btn-back]": "onClickBack",
            "anchorsbeforejump [data-app-ios-share]": "onClickIosShare"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this, e), this.lockFlagManager = new r, FF.SoundMgr.playAirshipBlackjackBgm(), this.context.clearBackFragment()
        },
        render: function() {
            var e = this;
            FF.env.isWWRegion() && this.isiOS8 == null ? kickmotor.iosgamecenter.checkiOS8Share(function(t) {
                e.isiOS8 = t.enabled, e._render()
            }) : e._render()
        },
        onClickIosShare: function() {
            if (!FF.env.isWWRegion()) return;
            var e = this;
            this.rootElm = this._getRootElement(), this.rootElm.addClass("ww-ios-share-mode"), t("#c-ripple").hide(), window.setTimeout(function() {
                kickmotor.iosgamecenter.startiOS8Share("", function() {
                    e.rootElm.removeClass("ww-ios-share-mode"), t("#c-ripple").show()
                })
            }, 0)
        },
        _getRootElement: function() {
            return this.rootElm || t("#container")
        },
        setupDeferred: function() {
            return u.hasSeen("PARTY_TOP") ? a.navigateIfNeedDeferred() : t.Deferred().resolve().promise()
        },
        render: function() {
            i.prototype.render.call(this, o), this._renderSubView(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.apply(this, arguments), u.showNavigationDeferred({
                key: "PARTY_TOP",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2
            }).then(function() {
                a.navigateIfNeedDeferred()
            })
        },
        _renderSubView: function() {
            this._inPartyView = new s({
                el: t("#partySubView"),
                lockFlagManager: this.lockFlagManager
            }), this._inPartyView.render()
        },
        onClickBack: function() {
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "savedRecommendedData"])) return;
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            this._inPartyView && this._inPartyView.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/PartyList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Constant", "templates/party/views/PartyList"], function(e, t, n, r, i, s) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-partylist-buddy-id]": "onClickPartyListItem",
            "anchorsbeforejump [data-app-partylist-empty-cell]": "onClickEmptyList"
        },
        initialize: function(e) {
            this.isInDungeon = e.isInDungeon, this.lockFlagManager = e.lockFlagManager
        },
        render: function(e) {
            e.isInDungeon = this.isInDungeon;
            var t = r.process(s, e);
            this.$el.html(t)
        },
        getDomName: function(e) {
            return '[data-app-partylist-buddy-id="' + e + '"]'
        },
        getDomNameOfEmptyList: function(e) {
            return '[data-app-partylist-empty-cell="' + e + '"]'
        },
        activate: function(e) {
            e.type === "buddyId" && (t(this.getDomName(e.id)).addClass("is-active"), this.selectedPartyId = e.id), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).addClass("is-active"), this.selectedEmptyCellOrder = e.order)
        },
        deactivate: function(e) {
            e.type === "buddyId" && (t(this.getDomName(e.id)).removeClass("is-active"), this.selectedPartyId = null), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).removeClass("is-active"), this.selectedEmptyCellOrder = null)
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickPartyListItem: function(e) {
            if (this.hasOpenedModal()) return;
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "isShowStatus"])) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-partylist-buddy-id"];
            if (!n || this.isInDungeon) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "buddyId",
                id: n
            }), this.trigger("change:partyList:selection", {
                id: n
            })) : this.selectedPartyId === n ? (this.deactivate({
                type: "buddyId",
                id: n
            }), this.trigger("change:partyList:selection", {
                id: null
            })) : this.selectedBuddyId ? this.trigger("swap:party", [this.selectedBuddyId, n]) : this.selectedEmptyCellOrder ? (this.trigger("move:party:ontoEmptySlot", {
                order: this.selectedEmptyCellOrder,
                id: n
            }), this.trigger("change:partyList:selection", {
                id: null
            })) : this.trigger("swap:party", [this.selectedPartyId, n]), FF.SoundMgr.playChooseEffect()
        },
        onClickEmptyList: function(e) {
            if (this.isInDungeon) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-partylist-empty-cell"];
            if (!n) return;
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "order",
                order: n
            }), this.trigger("change:partyList:selection", {
                order: n
            })) : this.selectedEmptyCellOrder === n ? (this.deactivate({
                type: "order",
                order: n
            }), this.trigger("change:partyList:selection", {
                order: null
            })) : this.selectedBuddyId ? this.trigger("add:party", {
                order: n,
                id: this.selectedBuddyId
            }) : this.selectedPartyId && (this.trigger("move:party:ontoEmptySlot", {
                order: n,
                id: this.selectedPartyId
            }), this.trigger("change:partyList:selection", {
                id: null
            })), FF.SoundMgr.playChooseEffect()
        },
        updateStatus: function(e) {
            this.selectedBuddyId = e.id
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedPartyId || this.selectedEmptyCellOrder || this.selectedBuddyId)
        },
        refreshState: function() {
            this.selectedPartyId = void 0, this.selectedBuddyId = void 0, this.selectedEmptyCellOrder = void 0
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/ViewBase", ["underscore", "jquery", "backbone", "sprintf", "util", "lib/ModalBase", "lib/TemplateRenderer", "components/ImageWatcher"], function(e, t, n, r, i, s, o, u) {
    return n.View.extend({
        render: function(e, t) {
            var n = o.process(e, t);
            this.$el.css("position", "").css("visibility", "").html(n)
        },
        processAfterRender: function(e) {
            FF.router.loading.lock();
            var t = this;
            e = i.option({
                notShowDeshi: !1,
                el: this.$el
            }, e);
            var n = new u(e),
                r = e.notShowDeshi ? "lock" : "show";
            this.listenTo(n, "takingTime", function() {
                FF.router.loading[r]()
            }).listenTo(n, "allImagesAreCompleted someImagesAreCompleted", this.processAfterContentLoad.bind(this)), this.imagewatcher = n
        },
        processAfterContentLoad: function() {
            this.stopListening(this.imagewatcher, "takingTime"), this.imagewatcher && this.imagewatcher.dispose(), this.imagewatcher = null, this.enableUserTouch(), FF.router.loading.hide(s.isModalOpening()), FF.router.toast && FF.router.toast.bake()
        },
        onCommonTouchStart: function(e) {
            this._isStarted = !0, this._isMoved = !1, this._startPoint = {
                x: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientX : e.touches.clientX ? e.touches[0].clientX : e,
                y: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientY : e.touches.clientY ? e.touches[0].clientY : e
            }, this.disableUserTouch(), t(e.currentTarget).one("anchorsonmove", t.proxy(this.onCommonAnchorsMove, this)).one("anchorsonend", t.proxy(this.onCommonTouchEnd, this))
        },
        onCommonTouchMove: function(e) {
            this._movedPoint = {
                x: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientX : e.touches.clientX ? e.touches[0].clientX : e,
                y: e.originalEvent.changedTouches ? e.originalEvent.changedTouches[0].clientY : e.touches.clientY ? e.touches[0].clientY : e
            }, this._diffPoint = {
                x: Math.abs(this._startPoint.x - this._movedPoint.x),
                y: Math.abs(this._startPoint.y - this._movedPoint.y)
            }, !this._isMoved && this._isStarted && (this._sensitivity < this._diffPoint.x || this._sensitivity < this._diffPoint.y) && (this._isMoved = !0), this.enableUserTouch()
        },
        onCommonAnchorsMove: function(e) {
            t(e.currentTarget).off("anchorsonend")
        },
        onCommonTouchEnd: function(e) {
            var t = this._isStarted && !this._isMoved ? "disableUserTouch" : "enableUserTouch";
            this[t]()
        },
        blurSelectorOrder: function() {
            if (!t("[data-app-selector-order]").length) return;
            t("[data-app-selector-order]").blur()
        },
        disableUserTouch: function() {
            t(document).trigger("disableUserTouch")
        },
        enableUserTouch: function() {
            t(document).trigger("enableUserTouch")
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/PartyEditBuddyList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/views/OverScrollView", "scenes/common/Constant", "scenes/party/views/ViewBase", "templates/party/views/PartyEditBuddyList", "templates/party/views/PartyEditBuddyListItems", "components/CookieMania", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l) {
    var c = e.extend({}, s, {
        SORT_MODULE_KEY: "party_edit",
        CURRENT_CLASS_NAME: "is-current",
        DISPLAY_CLASS_NAME: "di-n"
    });
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-buddylist-buddy-id]": "onClickBuddyListItem",
            "anchorsbeforejump [data-app-buddylist-dismiss]": "onClickDismissParty",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-design-type]": "onClickDesignType"
        },
        initialize: function(e) {
            this._seriesId = e.seriesId, this._isInDungeon = e.isInDungeon, this.lockFlagManager = e.lockFlagManager, this.cookieMania = new f, this._buddies = FF.datastore.buddyCollection.models, this._designType = this._getDesignType(), this._initSortOptions(), this._sortBuddyCollectionBy(this._sortOptions)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), l.resetSceneScopeStatus(c.SORT_MODULE_KEY), this._sortOptions = l.getDefaultSortOptions(c.SORT_MODULE_KEY)
        },
        getSortOptions: function() {
            return this._sortOptions
        },
        render: function() {
            o.prototype.render.call(this, u, {
                DESIGN_TYPE_OF: c.BUDDY_LIST_DESIGN_TYPE_OF
            }), this._setupOverScrollView(), this._renderListItems(), this._applyButtonActive(), this._toggleStatusButton(), this._setDesignTypeToCookie(this._designType), this._updateSortOptionButtonFace(this._sortOptions)
        },
        cancelScroll: function() {
            this._overScrollView.cancelScroll()
        },
        _setupOverScrollView: function() {
            this._overScrollView && this._overScrollView.dispose(), this._overScrollView = new i({
                displayType: this._isDesignIcon() ? "PARTY_EDIT_TILE" : "BUDDY_WIDE_LIST",
                listElement: t("[data-app-list-items]")
            }), this._overScrollView.updateCollectionSize(this._buddies.length), this._overScrollView.setMaxPageText(), this.listenTo(this._overScrollView, "requestRender", this._renderListItems)
        },
        _renderListItems: function() {
            var n = this._overScrollView.getStartNum(),
                i = this._overScrollView.getEndNum(),
                s = r.process(a, {
                    renderIndex: this._overScrollView.getCurrentPage(),
                    buddies: this._buddies.slice(n, i),
                    partyBuddyIds: e.values(FF.datastore.partyModel.getSlotToBuddyId()),
                    isInDungeon: this._isInDungeon,
                    isDesignIcon: this._isDesignIcon(),
                    selectedBuddyId: this.selectedBuddyId,
                    displayKey: this._sortOptions.displayKey
                }),
                o = t("[data-app-list-items]");
            this._overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            }), this.trigger("renderItems:buddyList")
        },
        onClickOpenSortModal: function() {
            this.trigger("hideStatusIfNeed"), l.openModalDeferred(c.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._sortBuddyCollectionBy(this._sortOptions), this._buddies = FF.datastore.buddyCollection.models, this._designType = this._getDesignType(), this._overScrollView.cleanup(), this.refreshState(), this.render(), this.trigger("onChangeSort")
        },
        _sortBuddyCollectionBy: function(e) {
            FF.datastore.buddyCollection.changeComparator(e), FF.datastore.buddyCollection.sort()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _getDesignType: function() {
            return this._getDesignTypeByCookie() || c.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _getDesignTypeByCookie: function() {
            return +this.cookieMania.get(c.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY)
        },
        _setDesignTypeToCookie: function(e) {
            this.cookieMania.set(c.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY, e)
        },
        _isDesignIcon: function(e) {
            return e = e || this._designType, e === c.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _isDesignWide: function(e) {
            return e = e || this._designType, e === c.BUDDY_LIST_DESIGN_TYPE_OF.WIDE
        },
        _applyButtonActive: function() {
            t("[data-app-design-type]").removeClass(c.CURRENT_CLASS_NAME), t("[data-app-design-type=" + this._designType + "]").addClass(c.CURRENT_CLASS_NAME)
        },
        _toggleStatusButton: function() {
            this._designType === c.BUDDY_LIST_DESIGN_TYPE_OF.ICON ? t("#showStatus").addClass(c.DISPLAY_CLASS_NAME) : t("#showStatus").removeClass(c.DISPLAY_CLASS_NAME)
        },
        onClickDesignType: function(e) {
            FF.router.loading.lock();
            var n = +t(e.target).attr("data-app-design-type");
            if (this._designType === n) return;
            this.trigger("hideStatusIfNeed"), this._designType = n, this.render()
        },
        activate: function(e) {
            t('[data-app-buddylist-buddy-id="' + e + '"]').addClass("is-active"), this.selectedBuddyId = e
        },
        deactivate: function(e) {
            t('[data-app-buddylist-buddy-id="' + e + '"]').removeClass("is-active"), this.selectedBuddyId = null
        },
        onClickBuddyListItem: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["isLocked", "isShowStatus"])) return;
            var n = e.currentTarget,
                r = +t(n).attr("data-app-buddylist-buddy-id");
            if (!r || this._isInDungeon) {
                FF.SoundMgr.playNgEffect();
                return
            }
            this.doesNotHaveAnySelection() ? (this.activate(r), this.trigger("change:buddyList:selection", {
                id: r
            })) : this.selectedBuddyId === r ? (this.deactivate(r), this.trigger("change:buddyList:selection", {
                id: null
            })) : this.selectedPartyId ? this.trigger("swap:party", [this.selectedPartyId, r]) : this.selectedEmptyCellOrder ? this.trigger("add:party", {
                order: this.selectedEmptyCellOrder,
                id: r
            }) : (this.deactivate(this.selectedBuddyId), this.activate(r), this.trigger("change:buddyList:selection", {
                id: r
            })), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissParty: function() {
            if (!this.selectedPartyId) return;
            this.trigger("dismiss:party", this.selectedPartyId)
        },
        updateStatus: function(e) {
            this.selectedPartyId = e.id, this.selectedEmptyCellOrder = e.order
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedPartyId || this.selectedEmptyCellOrder || this.selectedBuddyId)
        },
        updateVisible: function() {
            var n = FF.datastore.partyModel;
            t("[data-app-buddylist-buddy-id]").closest("li").removeClass("di-n"), e.each(n.getSlotToBuddyId(), function(e, n) {
                if (e) {
                    var r = sprintf("[data-app-buddylist-buddy-id=%s]", e);
                    t(r).closest("li").addClass("di-n"), t(r).removeClass("is-active")
                }
            }), this._overScrollView.updateContent()
        },
        refreshState: function() {
            this.selectedBuddyId = void 0, this.selectedPartyId = void 0, this.selectedEmptyCellOrder = void 0
        },
        dispose: function() {
            this._overScrollView && this._overScrollView.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalPartyEditConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "templates/party/views/ModalPartyEditConfirm", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide-negative]": "onClickDecideNegative",
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function(e) {
            var t = i({
                confirmType: e.confirmType
            });
            this.putContent(t)
        },
        onClickDecideNegative: function() {
            this.trigger("onClickDecideNegative")
        },
        onClickDecidePositive: function() {
            this.trigger("onClickDecidePositive")
        },
        onClickModalClose: function() {
            this.end()
        }
    })
}), define("scenes/party/pages/PartyEdit", ["underscore", "jquery", "backbone", "scenes/party/Api", "templates/party/PartyEdit", "scenes/common/helper/Align", "scenes/common/helper/LockFlagManager", "scenes/party/views/PartyList", "scenes/party/views/PartyEditBuddyList", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterDetail", "scenes/party/views/ModalPartyEditConfirm", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = {
        DISPLAY_CLASS_NAME: "di-n",
        ENABLE_CLASS_NAME: "is-enable",
        DISABLE_CLASS_NAME: "is-disable",
        TOGGLE_CLASS_NAME: "is-toggle",
        COLOR_CLASS_NAME: "fc-light",
        ENABLE_TOUCH_EVENT_CLASS_NAME: "pe-n-force"
    };
    return f.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-party-member-img]": "onClickBuddyImg",
            "anchorsbeforejump #goBuddyList": "onClickGoBuddyList",
            "anchorsbeforejump #showStatus": "onClickShowStatus",
            "anchorsbeforejump #alignEdit": "onClickAlignEdit",
            "anchorsbeforejump #alignEditDecide": "onClickAlignEdit",
            "anchorslongtap [data-app-can-show-detail-party]": "onLongTapCharaDetailView",
            "anchorslongtap [data-app-can-show-detail-buddy]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            f.prototype.initialize.call(this, e), this.confirmTemplate = void 0, this.footerEventHandlerFunc = this.onClickGlobalNavi.bind(this), this.addFooterEvent(this.footerEventHandlerFunc), this.partyModel = FF.datastore.partyModel, this.lockFlagManager = new o, this.lockFlagManager.initialize(["isEditingAlign", "isLocked", "isShowStatus"]), s.initialize()
        },
        render: function() {
            f.prototype.render.call(this, i), this.renderBuddyList(), this._sortOptions = this.buddyList.getSortOptions(), this.renderPartyList(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            f.prototype.processAfterContentLoad.apply(this, arguments), h.showNavigationDeferred({
                key: "PARTY_EDIT",
                isTutorialIllustOnly: !0
            })
        },
        renderBuddyList: function() {
            var e = this;
            this.buddyList && this.buddyList.dispose(), this.buddyList = new a({
                el: t("#buddyList"),
                seriesId: this.context.getSeriesId(),
                isInDungeon: this.isInDungeon(),
                lockFlagManager: this.lockFlagManager
            }), this.buddyList.render(), this.listenTo(this.buddyList, "hideStatusIfNeed", this._hideStatusIfNeed), this.listenTo(this.buddyList, "change:buddyList:selection", this.notifySelectionChangesToPartyList), this.listenTo(this.buddyList, "renderItems:buddyList", this.onRenderBuddyListItems), this.listenTo(this.buddyList, "onChangeSort", this._onChangeSortOfBuddyList.bind(this)), this.listenTo(this.buddyList, "swap:party", this.swapParty), this.listenTo(this.buddyList, "dismiss:party", this.dismissParty), this.listenTo(this.buddyList, "add:party", this.addParty)
        },
        renderPartyList: function() {
            var e = this,
                n = this.partyModel;
            this.partyList && this.partyList.dispose(), this.partyList = new u({
                el: t("#partyList"),
                isInDungeon: this.isInDungeon(),
                lockFlagManager: this.lockFlagManager
            }), this.partyList.render({
                party: n.getBuddyModels(),
                displayKey: this._sortOptions.displayKey
            }), this.listenTo(this.partyList, "change:partyList:selection", this.notifySelectionChangesToBuddyList), this.listenTo(this.partyList, "swap:party", this.swapParty), this.listenTo(this.partyList, "add:party", this.addParty), this.listenTo(this.partyList, "move:party:ontoEmptySlot", this.movePartyOntoEmptySlot), FF.env.isAndroid() && (e.partyList.$el.fastCss("opacity", .99), window.setTimeout(function() {
                e.partyList.$el.fastCss("opacity", 1)
            }, 0))
        },
        updateBuddyList: function() {
            this.buddyList.updateStatus({}), this.buddyList.refreshState(), this.buddyList.updateVisible()
        },
        onRenderBuddyListItems: function() {
            this.lockFlagManager.isLocked("isShowStatus") && (t("[data-app-status-overlay]").removeClass(p.DISPLAY_CLASS_NAME), t("[data-app-buddylist-dismiss]").addClass(p.DISABLE_CLASS_NAME))
        },
        _onChangeSortOfBuddyList: function() {
            this._sortOptions = this.buddyList.getSortOptions(), this.partyList.refreshState(), this.renderPartyList()
        },
        addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", e)
        },
        onClickGlobalNavi: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.currentTarget).attr("data-app-href");
            return this.savePartyDeferred().done(function() {
                n.history.navigate(r, {
                    trigger: !0
                })
            }), !1
        },
        onClickBack: function() {
            FF.router.loading.lock();
            var e = this;
            this.lockFlagManager.isLocked("isEditingAlign") && FF.datastore.buddyCollection.resetTmpRow(), this.savePartyDeferred().done(function() {
                e.context.getBackFragment() ? n.history.navigate(e.context.getBackFragment(), {
                    trigger: !0
                }) : n.history.navigate("#party", {
                    trigger: !0
                })
            })
        },
        generateZeroMemberModal: function() {
            this.modalPartyEditConfirmView = new c, FF.router.overlay.registerChildren(this.modalPartyEditConfirmView), this.modalPartyEditConfirmView.render({
                confirmType: this.confirmTemplate
            }), this.modalPartyEditConfirmView.open()
        },
        openCharacterDetail: function(e) {
            var t = this,
                n = FF.datastore.buddyCollection.get(e);
            FF.modalStack.push(l, {
                renderer: function(e) {
                    e.render(n)
                },
                onPop: function() {
                    t.lockFlagManager.unlock("isLocked")
                }
            })
        },
        onLongTapCharaDetailView: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["isEditingAlign", "isShowStatus"])) return;
            this.lockFlagManager.lock("isLocked");
            var n = t(e.target).closest("[data-app-partylist-buddy-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-buddylist-buddy-id]"), r = n.attr("data-app-buddylist-buddy-id")) : r = n.attr("data-app-partylist-buddy-id"), this.buddyList.cancelScroll(), this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        notifySelectionChangesToPartyList: function(e) {
            this.partyList.updateStatus(e)
        },
        notifySelectionChangesToBuddyList: function(e) {
            this.buddyList.updateStatus(e)
        },
        swapParty: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.swapParty(e), this.updateBuddyList(), this.renderPartyList(), FF.router.loading.unlock()
        },
        addParty: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.addParty(e), this.updateBuddyList(), this.renderPartyList(), FF.router.loading.unlock()
        },
        dismissParty: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.dismissParty(e), this.updateBuddyList(), this.renderPartyList(), FF.router.loading.unlock()
        },
        movePartyOntoEmptySlot: function(e) {
            FF.router.loading.lock();
            var t = this.partyModel;
            t.doesExistOriginalAttributes() || t.backupOriginalAttributes(), t.movePartyOntoEmptySlot(e), this.renderPartyList(), FF.router.loading.unlock()
        },
        isChanged: function() {
            var e = this.partyModel;
            return e.doesExistOriginalAttributes() ? e.hasChanged() ? !0 : !1 : !1
        },
        savePartyDeferred: function() {
            var e = t.Deferred(),
                n = this.partyModel;
            return this.isChanged() ? n.getIsPartyEmpty() ? (this.lockFlagManager.unlock("isLocked"), this.setConfirmModal("modalNoMemberExist"), this.generateZeroMemberModal(), e.reject().promise()) : (n.clearOriginalAttributes(), FF.datastore.buddyCollection.fixTmpRow(), r.partySaveDeferred(n, {}).done(function(t) {
                FF.datastore.updatePartyAssets(t), e.resolve()
            }), e.promise()) : e.resolve().promise()
        },
        setConfirmModal: function(e) {
            this.confirmTemplate = e
        },
        onClickGoBuddyList: function() {
            this.savePartyDeferred().done(function() {
                n.history.navigate("#party/buddy_list", {
                    trigger: !0
                })
            })
        },
        onClickShowStatus: function() {
            FF.router.loading.lock(), this.lockFlagManager.isLocked("isShowStatus") ? this._hideStatusIfNeed() : (this.lockFlagManager.lock("isShowStatus"), t("[data-app-status-overlay]").removeClass(p.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(p.DISPLAY_CLASS_NAME), t("[data-app-buddylist-dismiss]").addClass(p.DISABLE_CLASS_NAME)), FF.router.loading.unlock()
        },
        _hideStatusIfNeed: function() {
            if (!this.lockFlagManager.isLocked("isShowStatus")) return;
            t("[data-app-status-overlay]").addClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').addClass(p.DISPLAY_CLASS_NAME), t("[data-app-btn-label]").toggleClass(p.DISPLAY_CLASS_NAME), t("[data-app-buddylist-dismiss]").removeClass(p.DISABLE_CLASS_NAME), this.lockFlagManager.unlock("isShowStatus")
        },
        onClickAlignEdit: function() {
            if (this.lockFlagManager.isLocked("isLocked")) return;
            this.lockFlagManager.lock("isLocked"), FF.router.loading.show();
            var e = this;
            e.lockFlagManager.isLocked("isEditingAlign") ? s.onCompleteChangeAlignDeferred().done(function() {
                e._toggleEnableAlignEdit(), e.lockFlagManager.unlock("isEditingAlign"), e.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
            }) : this.savePartyDeferred().done(function() {
                e._hideStatusIfNeed(), e._toggleEnableAlignEdit(), e.lockFlagManager.lock("isEditingAlign"), e.lockFlagManager.unlock("isLocked"), FF.router.loading.hide()
            })
        },
        _toggleEnableAlignEdit: function() {
            t("#alignEdit").toggleClass(p.DISPLAY_CLASS_NAME), t("#alignEditDecide").toggleClass(p.DISPLAY_CLASS_NAME).toggleClass(p.ENABLE_CLASS_NAME), t("[data-app-toggle-align]").toggleClass(p.ENABLE_TOUCH_EVENT_CLASS_NAME), t("[data-app-partylist-empty-cell]").toggleClass(p.ENABLE_TOUCH_EVENT_CLASS_NAME), t("[data-app-party-member-img]").toggleClass(p.TOGGLE_CLASS_NAME).toggleClass(p.ENABLE_TOUCH_EVENT_CLASS_NAME), t("[data-app-status-overlay]").toggleClass(p.TOGGLE_CLASS_NAME), t("#partyEditOverlay").toggleClass(p.DISPLAY_CLASS_NAME), t("[data-app-array-color]").toggleClass(p.COLOR_CLASS_NAME)
        },
        onClickBuddyImg: function(e) {
            this.lockFlagManager.isLocked("isEditingAlign") && this.toggleAlign(e)
        },
        toggleAlign: function(e) {
            var n = t(e.originalEvent.srcElement).find("[data-app-toggle-align]"),
                r = n.toggleClass("is-back"),
                i = t(n).closest("[data-app-partylist-buddy-id]").attr("data-app-partylist-buddy-id");
            s.setPartyAlign(r, i)
        },
        dispose: function() {
            t(".g-navigation [data-mbgaui-anchors]").off("anchorsbeforejump", this.footerEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation(), this.lockFlagManager && this.lockFlagManager.dispose(), this.buddyList && this.buddyList.dispose(), this.partyList && this.partyList.dispose(), this.modalPartyEditConfirmView && this.modalPartyEditConfirmView.dispose();
            var e = this.partyModel;
            e.doesExistOriginalAttributes() && e.restoreOriginalAttributes();
            var n = FF.datastore.buddyCollection;
            n.changeComparator("default"), n.sort(), s.dispose(), f.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/BuddyList", ["underscore", "jquery", "backbone", "components/CookieMania", "lib/TemplateRenderer", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/ui_module/SortModuleFacade", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterDetail", "scenes/common/helper/LockFlagManager", "templates/party/BuddyList", "templates/party/views/BuddyListItems"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = e.extend({}, s, {
        SORT_MODULE_KEY: "buddy_list",
        CURRENT_CLASS_NAME: "is-current",
        DISPLAY_CLASS_NAME: "di-n"
    });
    return a.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-equipment]": "onClickBuddy",
            "anchorsbeforejump [data-app-buddy-img]": "onClickBuddy",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-design-type]": "onClickDesignType",
            "anchorsbeforejump #showStatus": "onClickShowStatus",
            "anchorslongtap [data-app-buddy-img]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            a.prototype.initialize.call(this, e), this.cookieMania = new r, this._buddies = FF.datastore.buddyCollection.models, this._designType = this._getDesignType(), this._initSortOptions(), this._sortBuddyCollectionBy(this._sortOptions), this.lockFlagManager = new l, this.lockFlagManager.initialize(["isShowStatus"])
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), u.resetSceneScopeStatus(p.SORT_MODULE_KEY), this._sortOptions = u.getDefaultSortOptions(p.SORT_MODULE_KEY)
        },
        render: function() {
            a.prototype.render.call(this, c, {
                DESIGN_TYPE_OF: p.BUDDY_LIST_DESIGN_TYPE_OF
            }), this._setupOverScrollView(), this._renderListItems(), this._applyButtonActive(), this._toggleStatusButton(), this._setDesignTypeToCookie(this._designType), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _setupOverScrollView: function() {
            this._overScrollView && this._overScrollView.dispose(), this._overScrollView = new o({
                displayType: this._isDesignIcon() ? "BUDDY_TILE" : "BUDDY_WIDE_LIST",
                listElement: t("[data-app-list-items]")
            }), this._overScrollView.updateCollectionSize(this._buddies.length), this._overScrollView.setMaxPageText(), this.listenTo(this._overScrollView, "requestRender", this._renderListItems)
        },
        _renderListItems: function() {
            var e = this._overScrollView.getStartNum(),
                n = this._overScrollView.getEndNum(),
                r = i.process(h, {
                    renderIndex: this._overScrollView.getCurrentPage(),
                    buddies: this._buddies.slice(e, n),
                    isInDungeon: this.isInDungeon,
                    isDesignIcon: this._isDesignIcon(),
                    displayKey: this._sortOptions.displayKey,
                    PARTY_TOP_SUB_CATEGORY: p.PARTY_TOP_SUB_CATEGORY
                }),
                s = t("[data-app-list-items]");
            this._overScrollView.render({
                html: r,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            }), this.lockFlagManager.isLocked("isShowStatus") && this._showStatus()
        },
        onLongTapCharaDetailView: function(e) {
            var n = t(e.target).closest("[data-app-buddy-id]"),
                r = n.attr("data-app-buddy-id");
            this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = FF.datastore.buddyCollection.get(e);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(t)
                }
            })
        },
        onClickOpenSortModal: function() {
            this._hideStatusIfNeed(), u.openModalDeferred(p.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._sortBuddyCollectionBy(this._sortOptions), this._buddies = FF.datastore.buddyCollection.models, this._designType = this._getDesignType(), this.render()
        },
        _sortBuddyCollectionBy: function(e) {
            FF.datastore.buddyCollection.changeComparator(e), FF.datastore.buddyCollection.sort()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _getDesignType: function() {
            return this._getDesignTypeByCookie() || p.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _getDesignTypeByCookie: function() {
            return +this.cookieMania.get(p.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY)
        },
        _setDesignTypeToCookie: function(e) {
            this.cookieMania.set(p.COOKIE_KEYS.DESIGN_TYPE_OF.PARTY, e)
        },
        _isDesignIcon: function() {
            return +this._designType === p.BUDDY_LIST_DESIGN_TYPE_OF.ICON
        },
        _isDesignWide: function() {
            return +this._designType === p.BUDDY_LIST_DESIGN_TYPE_OF.WIDE
        },
        _applyButtonActive: function() {
            t("[data-app-design-type]").removeClass(p.CURRENT_CLASS_NAME), t("[data-app-design-type=" + this._designType + "]").addClass(p.CURRENT_CLASS_NAME)
        },
        _toggleStatusButton: function() {
            this._designType === p.BUDDY_LIST_DESIGN_TYPE_OF.ICON ? t("#showStatus").addClass(p.DISPLAY_CLASS_NAME) : t("#showStatus").removeClass(p.DISPLAY_CLASS_NAME)
        },
        onClickDesignType: function(e) {
            var n = +t(e.target).attr("data-app-design-type");
            if (this._designType === n) return;
            FF.SoundMgr.playChooseEffect(), this._designType = n, this._hideStatusIfNeed(), this.render()
        },
        onClickBuddy: function(e) {
            FF.SoundMgr.playChooseEffect();
            var r = t(e.target).closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                i = t(e.target).attr("data-app-equipment") || p.PARTY_TOP_SUB_CATEGORY.EQUIPMENT;
            this.context.setBackFragment(location.hash), n.history.navigate("#party/equipment/" + r + "/" + i, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/party_edit", {
                trigger: !0
            })
        },
        onClickShowStatus: function() {
            FF.router.loading.lock(), this.lockFlagManager.isLocked("isShowStatus") ? this._hideStatusIfNeed() : this._showStatus(), FF.router.loading.unlock()
        },
        _showStatus: function() {
            t("[data-app-status-overlay]").removeClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').addClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="displayOff"]').removeClass(p.DISPLAY_CLASS_NAME), this.lockFlagManager.lock("isShowStatus")
        },
        _hideStatusIfNeed: function() {
            if (!this.lockFlagManager.isLocked("isShowStatus")) return;
            t("[data-app-status-overlay]").addClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="status"]').removeClass(p.DISPLAY_CLASS_NAME), t('[data-app-btn-label="displayOff"]').addClass(p.DISPLAY_CLASS_NAME), this.lockFlagManager.unlock("isShowStatus")
        },
        dispose: function() {
            this._overScrollView && this._overScrollView.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/EnhancementTop", ["underscore", "jquery", "backbone", "templates/party/EnhancementTop", "scenes/party/pages/Page", "scenes/common/helper/FuncTutorial", "scenes/common/helper/ItemPossessionLimit", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return i.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #abilityGenerate": "onClickAbilityGenerate"
        },
        initialize: function(e) {
            i.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.context.clearBackFragment()
        },
        render: function(e) {
            i.prototype.render.call(this, r, {}), this.processAfterRender(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.apply(this, arguments);
            var e = this;
            s.showNavigationDeferred({
                key: "ENHANCEMENT_TOP",
                isTutorialIllustOnly: !0
            }).then(function() {
                if (!e._isMemoryCrystalTutorialRequired()) return;
                n.history.navigate("#func_tutorial/buddy_evolution", {
                    trigger: !0
                })
            })
        },
        _isMemoryCrystalTutorialRequired: function() {
            var e = FF.datastore.memoryCrystalCollection.length > 0,
                t = !s.hasSeen("BUDDY_EVOLUTION");
            return e && t
        },
        onClickAbilityGenerate: function() {
            o.showModalIfOverLimitDeferred({
                itemTypeNames: ["ability"]
            }).done(function() {
                n.history.navigate("#party/ability_generate", {
                    trigger: !0
                })
            })
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#home", {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/HammeringTutorial", [], function() {
    return {
        navigateIfNeedDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.userModel;
            return t.hasProceededFuncTutorial("HAMMERING") || !this._hasHammeringBaseItem() ? e.resolve().promise() : (Backbone.history.navigate("func_tutorial/hammering", {
                trigger: !0
            }), e.reject().promise())
        },
        _hasHammeringBaseItem: function() {
            var e;
            return e = FF.datastore.equipmentSpMaterialCollection.any(function(e) {
                return e.isHammeringMaterial() && e.get("num") > 0
            }), e ? !0 : (e = FF.datastore.equipmentCollection.any(function(e) {
                return e.get("hammering_num") > 0
            }), e ? !0 : !1)
        }
    }
}), define("scenes/party/pages/EnhancementBaseSelect", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Constant", "scenes/common/helper/MissionHelper", "templates/party/EnhancementBaseSelect", "templates/party/views/EnhancementList", "scenes/party/pages/Page", "scenes/party/views/ModalEquipmentDetail", "scenes/common/views/OverScrollView", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "components/Tab", "scenes/common/helper/FuncTutorial", "scenes/common/helper/HammeringTutorial", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    var g = e.extend({}, i, {
        SORT_MODULE_KEY_FOR_WEAPON: "enhance_weapon_tab",
        SORT_MODULE_KEY_FOR_ARMOR: "enhance_armor_tab",
        ACHIEVE_TYPE_NAMES: ["ENHANCE"],
        WEAPON_TAB_INDEX: "0",
        ARMOR_TAB_INDEX: "1"
    });
    return a.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equip-id]": "_onLongTapEquipIcon"
        },
        initialize: function(e) {
            a.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm();
            var t = e && e.args && e.args[0] ? e.args[0] : FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON;
            this._hasLongTap = !1, this._currentTabIndex = this._getTabIndex(t), this._equipCollection = FF.datastore.equipmentCollection, this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0, this._initSortOptions(this._currentTabIndex)
        },
        _getTabIndex: function(e) {
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON) return g.WEAPON_TAB_INDEX;
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR) return g.ARMOR_TAB_INDEX;
            throw new Error("Invalid equipment type:", e)
        },
        _initSortOptions: function(e) {
            FF.resonator.resetSimulation(), m.resetSceneScopeStatus(g.SORT_MODULE_KEY_FOR_WEAPON), m.resetSceneScopeStatus(g.SORT_MODULE_KEY_FOR_ARMOR), this._sortOptions = this._getSortOptionsByTab(e)
        },
        render: function(e) {
            a.prototype.render.call(this, o, {
                userGil: FF.datastore.userModel.get("gil"),
                isShowingLv: this._isShowingLv
            }), this._initStatusDisplayToggleHelper(), this._initOverScrollView(), this._initTab(), this._updateItemListView(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new h({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: 2
            })
        },
        processAfterContentLoad: function() {
            a.prototype.processAfterContentLoad.call(this), d.showNavigationDeferred({
                key: "ENHANCEMENT",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2,
                speakerClassName: "is-cid"
            }).then(v.navigateIfNeedDeferred.bind(v)).then(s.openModalMissionClearIfNeedDeferred.bind(s))
        },
        _initOverScrollView: function() {
            this._overScrollView = new l({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this._overScrollView, "requestRender", this._renderItems)
        },
        _initTab: function() {
            this._tab = new p({
                tabs: t('[data-ui-group="tab"]'),
                panes: void 0,
                className: "is-current",
                defaultPage: this._currentTabIndex
            }), this.listenTo(this._tab, "changedState", this._onTabStateChange.bind(this))
        },
        _onTabStateChange: function(e) {
            this._currentTabIndex = "" + e.index, this._overScrollView.cleanup(), this._sortOptions = this._getSortOptionsByTab(this._currentTabIndex), FF.resonator.simulateResonance(this._sortOptions.resonanceSeriesId), this._updateItemListView(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this._overScrollView.setIsScrollableIfSinglePage()
        },
        _getSortOptionsByTab: function(e) {
            var t = this._getSortKeyByTab(e);
            return m.getDefaultSortOptions(t)
        },
        _getSortKeyByTab: function(e) {
            return e === g.WEAPON_TAB_INDEX ? g.SORT_MODULE_KEY_FOR_WEAPON : g.SORT_MODULE_KEY_FOR_ARMOR
        },
        _renderItems: function() {
            var e = this._overScrollView.getStartNum(),
                n = this._overScrollView.getEndNum(),
                i = this._getTargetEquipModels(!0).slice(e, n),
                s = r.process(u, {
                    renderIndex: this._overScrollView.getCurrentPage(),
                    models: i,
                    pageName: "enhancement",
                    isInDungeon: this.isInDungeon(),
                    isShowingLv: this._isShowingLv
                }),
                o = t("[data-app-list-equip-container]");
            this._overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _updateItemListView: function(e) {
            e = e || {}, this._equipCollection.changeComparator(e), this._overScrollView.updateCollectionSize(this._getTargetEquipModels(!1).length), this._overScrollView.setMaxPageText(), this._renderItems()
        },
        _getTargetEquipModels: function(e) {
            e && this._equipCollection.sort();
            var t;
            switch (this._currentTabIndex) {
                case g.WEAPON_TAB_INDEX:
                    t = this._equipCollection.getEnhancementSrcWeaponModels();
                    break;
                case g.ARMOR_TAB_INDEX:
                    t = this._equipCollection.getEnhancementSrcArmorModels();
                    break;
                default:
                    throw new Error("Invalid tab index:", this._currentTabIndex)
            }
            return t
        },
        _onLongTapEquipIcon: function(e) {
            var n = this;
            this._hasLongTap = !0, this._overScrollView.cancelScroll(), this.blurSelectorOrder(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.target).closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = this._equipCollection.get(i);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n._hasLongTap = !1
                }
            }), FF.modalStack.setOnComplete(function(e) {
                c.updateLockableItemElem(e, r, !1)
            })
        },
        onClickBack: function() {
            var e = this.context.getBackFragment() || "#party/enhancement_top";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickEquipList: function(e) {
            if (this._hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target);
            if (n.hasClass("is-sortie")) {
                FF.SoundMgr.playNgEffect(), FF.router.loading.unlock();
                return
            }
            FF.SoundMgr.playChooseEffect();
            var r = +n.attr("data-app-equip-id"),
                i = this._equipCollection.get(r);
            this._onSelectEquip(i)
        },
        _onSelectEquip: function(e) {
            this._stashCurrentPageInformation();
            var t = e.get("id"),
                r = "#party/enhancement_material_select/" + t;
            n.history.navigate(r, {
                trigger: !0
            })
        },
        _stashCurrentPageInformation: function() {
            FF.datastore.stash.isShowingLv = this._isShowingLv
        },
        onClickOpenSortModal: function() {
            var e = this._getSortKeyByTab(this._currentTabIndex);
            m.openModalDeferred(e).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._overScrollView.cleanup(), this._updateItemListView(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this._overScrollView && this._overScrollView.dispose(), this._tab && this._tab.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/Fusion", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/Fusion"], function(e, t, n, r, i) {
    var s = {
        tmplName: "[data-app-black-out-curtain]"
    };
    return n.View.extend({
        render: function() {
            this.$el.append(i())
        },
        dispose: function() {
            this.$el.find(s.tmplName).remove(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/FusionEquipmentViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "scenes/party/views/Fusion"], function(e, t, n, r, i, s, o, u) {
    var a = {
        BAR_ANIM_WAIT: 220,
        BAR_ANIM_BASE_SPEED: 2,
        RESULT_EFFECT_SOUND: "se_fusion_common_100050"
    };
    return o.extend({
        initialize: function(e) {
            var n = this,
                r = t.Deferred();
            this.type = e.type, this.equipDataMap = e.dataMap, this.baseModel = e.baseModel, this.oldItemAssetId = "old_src_user_equipment", this.newItemAssetId = "new_src_user_equipment", this.materialItemAssetId = "material_user_equipment", this.isFusionType() && (this.gainExp = e.exp), this.isAlreadyMaxLevel = this.equipDataMap.old_src_user_equipment.is_max_level, this.touchEnabled = !1;
            var i = this.equipDataMap.new_src_user_equipment.hammering_num,
                s = this.equipDataMap.old_src_user_equipment.hammering_num;
            this.diffHammeringNum = i - s, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        isFusionType: function() {
            return this.type === "result_fusion"
        },
        isGainExp: function() {
            return !this.isAlreadyMaxLevel
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.equipDataMap.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.fusionView = new u({
                    el: t("#content")
                }), e.ab.playNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.fusionView.render(), e.isFusionType() ? (e.setTouchCallback(), e.ab.playNode.setVisible(!0).play("play"), e.flush(), n.resolve()) : (e.ab.itemInAnimationEvolveNode.setVisible(!0), e.ab.playNode.play("set_evolution").processDeferred("action_stop").then(function() {
                    e.setTouchCallback(), e.ab.playNode.setVisible(!0).play("play_evolution"), e.flush(), n.resolve()
                }))
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "fusion_item";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.oldItemAssetInfo = this.assetsManager.getAssetInfo(this.oldItemAssetId), this.newItemAssetInfo = this.assetsManager.getAssetInfo(this.newItemAssetId), this.isFusionType() || (this.materialItemAssetInfo = this.assetsManager.getAssetInfo(this.materialItemAssetId)), this.fusionExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.fusionExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.isFusionType() && this.isGainExp() && this.ab.expBarNode.setVisible(!0), this.ab.resultNode.setVisible(!1), this.setOldImage(this.ab.itemInAnimation01Node, "item_01_img"), this.setNewImage(this.ab.itemInAnimation04Node, "item_04_img"), this.setNewImage(this.ab.fusionItemNode, "fusion_item_in_img"), this.setNewImage(this.ab.itemInAnimationNode, "item_img"), this.setNewImage(this.ab.resultNode, "item_a_img"), this.isFusionType() || this.setMaterialImage(this.ab.itemInAnimation02Node, "item_02_img"), this.setResultData()
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "top_nul"
            }), this.ab.playNode = this.ab.topNode.createChildNode("fusion_cam_nul"), this.ab.fusionItemNode = this.ab.topNode.createChildNode("fusion_item_nul"), this.ab.itemInAnimationNode = this.ab.topNode.createChildNode("item_in_animation_nul"), this.ab.itemInAnimationEvolveNode = this.ab.topNode.createChildNode("item_in_anmation_evolution_nul"), this.ab.itemInAnimation01Node = this.ab.topNode.createChildNode("item_in_anmation_01_nul"), this.ab.itemInAnimation02Node = this.ab.topNode.createChildNode("item_in_anmation_02_nul"), this.ab.itemInAnimation04Node = this.ab.topNode.createChildNode("item_in_anmation_04_nul"), this.ab.resultNode = this.ab.topNode.createChildNode("result_fusion_nul"), this.ab.expBarNode = this.ab.topNode.createChildNode("bar_nul"), this.ab.expBarImgNode = this.ab.topNode.createChildNode("bar_img"), this.ab.starNode = this.ab.topNode.createChildNode("star_nul"), this.ab.hammeringResultNode = this.ab.topNode.createChildNode("hammering_result_nul"), this.ab.hammeringResultNumNode = this.ab.topNode.createChildNode("hammering_result_num_nul"), this.ab.hammeringNumNode = this.ab.topNode.createChildNode("hammering_num_nul")
        },
        setOldImage: function(e, t) {
            e.loadBundle(this.oldItemAssetInfo.bundle).setImage(t, this.oldItemAssetInfo.assetPath)
        },
        setNewImage: function(e, t) {
            e.loadBundle(this.newItemAssetInfo.bundle).setImage(t, this.newItemAssetInfo.assetPath)
        },
        setMaterialImage: function(e, t) {
            e.loadBundle(this.materialItemAssetInfo.bundle).setImage(t, this.materialItemAssetInfo.assetPath)
        },
        setResultData: function() {
            var e = this.equipDataMap.new_src_user_equipment;
            this.ab.resultNode.setText("weapon_name_txt", e.name).setText("level_num", e.level).setText("atk_num", e.atk).setText("def_num", e.def).setText("magic_num", e.matk).setText("mag_def_num", e.mdef).setText("mind_num", e.mnd).setText("hit_num", e.acc).setText("eva_num", e.eva)
        },
        setTouchCallback: function() {
            var e = this,
                t = this.equipDataMap.bonus_hammered_num;
            this.isFusionType() && this.expBarSetup(), this.ab.playNode.addCallbackOnce("action_play", function() {
                FF.logger.debug("[[[[[------- アクション開始 -------]]]]]"), e.ab.topNode.addCallback("action_touch_began", function() {
                    FF.logger.debug("[[[[[------- タッチしました。結果を表示します。 -------]]]]]"), e.isFusionType() && e.isGainExp() && e.ab.expBarImgNode.removeAllCallback().stop({
                        descendant: !0
                    }).process(), t > 0 ? e.setupResultNodeAndBonus() : e.setupResultNode()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.isFusionType() && e.isGainExp && e.ab.expBarImgNode.removeAllCallback().stop({
                    descendant: !0
                }).process(), t > 0 ? e.setupResultNodeAndBonus() : e.setupResultNode()
            })
        },
        setupResultNodeAndBonus: function() {
            var e = this,
                t = this.isFusionType() ? "result_fusion_success" : "result_evolution_success";
            this.ab.playNode.removeAllCallback().stop({
                descendant: !0
            }), this.ab.topNode.removeAllCallback(), this.ab.resultNode.setVisible(!0).play(t).addCallbackOnce("action_success", function() {
                e.ab.topNode.addCallback("action_touch_began", function() {
                    FF.logger.debug("[[[[[------- タッチしました。結果を表示します。 -------]]]]]"), e.ab.resultNode.removeAllCallback(), e.setupResultNode()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                e.ab.resultNode.removeAllCallback(), e.setupResultNode()
            }), this.flush()
        },
        setupResultNode: function() {
            var e = this;
            this.ab.playNode.removeAllCallback().stop({
                descendant: !0
            }), this.ab.topNode.removeAllCallback().addCallback("action_touch_began", function() {
                if (e.touchEnabled) return;
                e.diffHammeringNum > 0 && !e.isFinishedHammeringAnimation ? (FF.logger.debug("[[[[[------- タッチしました。鍛錬を表示します。 -------]]]]]"), e.skipHammeringAnimation(), e.isFinishedHammeringAnimation = !0) : (FF.logger.debug("[[[[[------- タッチしました。ページに戻ります。 -------]]]]]"), FF.SoundMgr.stopEffect(), e.fusionView.dispose(), e.trigger("closeAnimation"), e.touchEnabled = !0)
            }), this.ab.resultNode.setVisible(!0).play(this.type).addCallbackOnce("action_stop", function() {
                e.diffHammeringNum > 0 && !e.isFinishedHammeringAnimation && e.startHammeringAnimation()
            }), this.baseModel.get("hammering_num") > 0 && this.diffHammeringNum === 0 && this._showStayHammeringNumInParam(), this.processStarNode(), FF.SoundMgr.playEffect(a.RESULT_EFFECT_SOUND, {
                loop: !0
            }), this.flush()
        },
        processStarNode: function() {
            var e = this.equipDataMap.new_src_user_equipment.rarity;
            this.ab.starNode.play("star_0" + e + "_e")
        },
        expBarSetup: function() {
            var e = this,
                t = this.baseModel.get("exp"),
                n = this.baseModel.getExpPerNextLvExp(),
                r = this.baseModel.get("level_max"),
                i = this.equipDataMap.old_src_user_equipment.level,
                s = this.equipDataMap.new_src_user_equipment.level,
                o = s - i,
                u = o > 0 ? o : 1,
                f = a.BAR_ANIM_BASE_SPEED * u,
                l = this.baseModel.getGrowthRate(s + 1, t + this.gainExp),
                c = 0;
            i < s ? (this.startExpBarAnimation(n, 100, {
                wait: a.BAR_ANIM_WAIT,
                speed: f
            }), this.ab.expBarImgNode.addCallback("action_stop", function() {
                c++, o === c ? (e.ab.expBarImgNode.removeAllCallback().process(), r !== i + c && e.startExpBarAnimation(0, l, {
                    speed: f
                })) : e.startExpBarAnimation(0, 100, {
                    speed: f
                })
            })) : this.startExpBarAnimation(n, l, {
                speed: f
            })
        },
        startExpBarAnimation: function(e, t, n) {
            this.ab.expBarImgNode.playFrame("bar_anm", e, t, n).process()
        },
        startHammeringAnimation: function() {
            var e = this,
                t = this.equipDataMap.bonus_hammered_num,
                n = this.equipDataMap.equipments_hammered_num;
            t > 0 ? (this.ab.hammeringResultNode.setText("hammering_result_num", t), this.ab.hammeringResultNode.setText("hammering_result_num_base_txt", n), this.ab.hammeringResultNode.setText("hammering_result_num_bonus_txt", t), this.ab.hammeringResultNode.play("hammering_01", {
                autoRemove: !1
            }).addCallbackOnce("action_stop", function() {
                e.isFinishedHammeringAnimation = !0
            }).process()) : (this.ab.hammeringResultNode.setText("hammering_result_num_base_txt", n), this.ab.hammeringResultNode.play("hammering_02", {
                autoRemove: !1
            }).addCallbackOnce("action_stop", function() {
                e.isFinishedHammeringAnimation = !0
            }).process()), this._showHammeredHammeringNumInParam()
        },
        skipHammeringAnimation: function() {
            var e = this.equipDataMap.bonus_hammered_num,
                t = this.equipDataMap.equipments_hammered_num;
            e > 0 ? this.ab.hammeringResultNode.setText("hammering_result_num", e).setText("hammering_result_num_base_txt", t).setText("hammering_result_num_bonus_txt", e).play("hammering_01_skip", {
                autoRemove: !1
            }).process() : this.ab.hammeringResultNode.setText("hammering_result_num_base_txt", t).play("hammering_02_skip", {
                autoRemove: !1
            }).process(), this._showSkipHammeringNumInParam()
        },
        _showStayHammeringNumInParam: function() {
            var e = this.equipDataMap.new_src_user_equipment.hammering_num,
                t = this.equipDataMap.new_src_user_equipment.max_hammering_num,
                n = this.baseModel.get("hammering_affect_param_key"),
                r = this.ab.hammeringNumNode.createChildNode(n + "_num_nul");
            r.setText(n + "_num_h", e), r.play("hammering_stay", {
                autoRemove: !1
            }).process(), this.ab.hammeringResultNumNode.setText("hammering_result_num_current_txt", e), this.ab.hammeringResultNumNode.setText("hammering_result_num_max_txt", t), this.ab.hammeringResultNumNode.play("hammering_stay", {
                autoRemove: !1
            }).process()
        },
        _showHammeredHammeringNumInParam: function() {
            var e = this.equipDataMap.new_src_user_equipment.hammering_num,
                t = this.equipDataMap.new_src_user_equipment.max_hammering_num,
                n = this.baseModel.get("hammering_affect_param_key"),
                r = this.ab.hammeringNumNode.createChildNode(n + "_num_nul");
            r.setText(n + "_num_h", e), r.play("hammering").process(), this.ab.hammeringResultNumNode.setText("hammering_result_num_current_txt", e), this.ab.hammeringResultNumNode.setText("hammering_result_num_max_txt", t), this.ab.hammeringResultNumNode.play("hammering").process()
        },
        _showSkipHammeringNumInParam: function() {
            var e = this.equipDataMap.new_src_user_equipment.hammering_num,
                t = this.equipDataMap.new_src_user_equipment.max_hammering_num,
                n = this.baseModel.get("hammering_affect_param_key"),
                r = this.ab.hammeringNumNode.createChildNode(n + "_num_nul");
            r.setText(n + "_num_h", e), r.play("hammering_skip", {
                autoRemove: !1
            }).process(), this.ab.hammeringResultNumNode.setText("hammering_result_num_current_txt", e), this.ab.hammeringResultNumNode.setText("hammering_result_num_max_txt", t), this.ab.hammeringResultNumNode.play("hammering_skip", {
                autoRemove: !1
            }).process()
        },
        clearAB: function() {
            this.fusionExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.fusionView && this.fusionView.dispose(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/party/views/ModalEnhancementConfirm", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "templates/party/views/ModalEnhancementConfirm", "templates/party/views/UsedEnhanceMaterialList", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f) {
    return u.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide"
        },
        render: function(e) {
            this.renderContent(s, {
                parameterMap: e
            });
            var n = r.process(o, {
                parameterMap: e
            });
            t("[data-app-used-material-list]").html(n), this._setupComponents()
        },
        open: function() {
            u.prototype.open.apply(this, arguments), this.listenToOnce(this, "openAnimationEnd", function() {
                t("[data-app-animation-target]").parent().addClass("is-animate")
            })
        },
        _setupComponents: function() {
            this._freescroll = new a({
                el: t("[data-ui-freescroll-for-enhance-confirm]")
            }), this._scrollbar = new f({
                el: t("[data-ui-scrollbar-for-enhance-confirm]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickCancel: function() {
            this.trigger("onClickCancel"), this.end()
        },
        onClickDecide: function() {
            this.trigger("onClickDecide")
        },
        dispose: function() {
            this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/SpMaterialRecommendWorker", ["jquery", "underscore", "backbone", "lib/ClassBase"], function(e, t, n, r) {
    return r.extend({
        _materials: [],
        _head: 0,
        _expRemain: 0,
        _id2UsedNum: {},
        initialize: function(e, t, n) {
            this._materials = this._getWorkingMaterialList(e, t);
            if (this._materials.length === 0) throw new Error("SpMaterialModels should not be empty.");
            this._head = 0, this._expRemain = n, this._id2UsedNum = {}
        },
        getId2UsedNum: function() {
            return t.isEmpty(this._id2UsedNum) ? void 0 : this._id2UsedNum
        },
        isExpRemaining: function() {
            return this._expRemain > 0
        },
        isMaterialRemaining: function() {
            var e = t.reduce(this._materials, function(e, t) {
                return e + t.num
            }, 0);
            return e > 0
        },
        isSelectedMaterialRemaining: function() {
            var e = this._materials[this._head];
            return !e || e.num === 0 ? !1 : !0
        },
        isExpNotEnough: function(e) {
            e = e || this._materials;
            var n = t.reduce(e, function(e, t) {
                return e + t.exp * t.num
            }, 0);
            return n < this._expRemain
        },
        isLowerMaterialsExpNotEnough: function() {
            var e = this._materials.slice(this._head + 1);
            return e.length === 0 ? !0 : this.isExpNotEnough(e)
        },
        useOne: function() {
            var e = this._materials[this._head];
            return !e || e.num === 0 ? !1 : (--e.num, this._expRemain -= e.exp, this._modifyUsedNum(e.id, 1), !0)
        },
        useOneIfNotOverExp: function() {
            var e = this._materials[this._head];
            return !e || e.num === 0 ? !1 : this._expRemain - e.exp < 0 ? !1 : this.useOne()
        },
        useAll: function() {
            var e = this;
            t.each(this._materials, function(t) {
                if (t.num <= 0) return;
                e._expRemain -= t.exp * t.num, e._modifyUsedNum(t.id, t.num), t.num = 0
            })
        },
        selectTopMaterial: function() {
            this._head = 0
        },
        selectBottomMaterial: function() {
            this._head = this._materials.length - 1
        },
        selectNextUpperMaterial: function() {
            ++this._head
        },
        selectNextLowerMaterial: function() {
            --this._head
        },
        selectMaterialAt: function(e) {
            this._head = e
        },
        isSelectedMaterialAvailable: function() {
            var e = this._materials[this._head];
            return e ? !0 : !1
        },
        cancelSurplusLowerMaterials: function() {
            if (this._expRemain > 0) return;
            for (var e = this._materials.length - 1; e >= 0; --e) {
                var t = this._materials[e],
                    n = t.id;
                if (!this._id2UsedNum[n]) continue;
                while (this._id2UsedNum[n] > 0) {
                    if (this._expRemain + t.exp > 0) return;
                    this._modifyByMaterial(t, -1)
                }
            }
        },
        useMoreLowerMaterialIfPossible: function() {
            var e = !0;
            while (e) e = this._tryUseMoreLowerMaterial()
        },
        _tryUseMoreLowerMaterial: function() {
            for (var e = 0; e < this._materials.length; ++e) {
                var t = this._materials[e];
                if (!this._id2UsedNum[t.id]) continue;
                for (var n = e + 1; n < this._materials.length; ++n) {
                    var r = this._materials[n];
                    if (r.num === 0) continue;
                    if (this._canReplaceUpperWithLower(t, r)) return this._modifyByMaterial(t, -1), this._modifyByMaterial(r, 1), !0
                }
            }
            return !1
        },
        _canReplaceUpperWithLower: function(e, t) {
            return this._expRemain + (e.exp - t.exp) <= 0
        },
        useMoreFewerMaterialIfPossible: function() {
            var e = !0;
            while (e) e = this._tryUseMoreFewerMaterial()
        },
        _tryUseMoreFewerMaterial: function() {
            var e = [],
                n = t(this._id2UsedNum).clone(),
                r = this._materials.length - 1;
            while (r >= 0 && e.length <= 4) {
                var i = this._materials[r];
                if (!n[i.id]) {
                    --r;
                    continue
                }
                e.push(i), --n[i.id];
                if (e.length >= 2) {
                    var s = this._replaceLowerMaterialsWithUpperMaterialIfPossible(e, r);
                    if (s) return !0
                }
                n[i.id] || --r
            }
            return !1
        },
        _replaceLowerMaterialsWithUpperMaterialIfPossible: function(e, t) {
            for (var n = t - 1; n >= 0; --n) {
                var r = this._materials[n];
                if (r.num === 0) continue;
                if (this._canReplaceLowersWithUpper(e, r)) return this._replaceMaterialsWithOneMaterial(e, r), !0
            }
            return !1
        },
        _canReplaceLowersWithUpper: function(e, t) {
            var n = this._getSumExpOfMaterials(e);
            return n >= t.exp && this._expRemain + (n - t.exp) <= 0
        },
        _getSumExpOfMaterials: function(e) {
            return t.reduce(e, function(e, t) {
                return e + t.exp
            }, 0)
        },
        _replaceMaterialsWithOneMaterial: function(e, n) {
            var r = this;
            t.each(e, function(e) {
                r._modifyByMaterial(e, -1)
            }), this._modifyByMaterial(n, 1)
        },
        _getWorkingMaterialList: function(e, n) {
            var r = t.sortBy(e, function(e) {
                    return -e.get("exp")
                }),
                i = [];
            return t.each(r, function(e) {
                if (e.get("num") === 0) return;
                var t = n ? e.getActualExp(n) : e.get("exp");
                i.push({
                    id: e.get("id"),
                    num: e.get("num"),
                    exp: t
                })
            }), i
        },
        _modifyByMaterial: function(e, t) {
            return e.num - t < 0 ? !1 : (e.num -= t, this._expRemain -= e.exp * t, this._modifyUsedNum(e.id, t), !0)
        },
        _modifyUsedNum: function(e, t) {
            this._id2UsedNum[e] || (this._id2UsedNum[e] = 0), this._id2UsedNum[e] += t, this._id2UsedNum[e] === 0 && delete this._id2UsedNum[e]
        }
    })
}), define("scenes/common/helper/SpMaterialRecommend", ["jquery", "underscore", "backbone", "lib/ClassBase", "./SpMaterialRecommendWorker"], function(e, t, n, r, i) {
    return r.extend({
        recommend: function(e, t, n, r) {
            var s = e;
            r || (s = this._filterMaterialModels(e, t));
            if (s.length === 0) return void 0;
            var o = new i(s, t, n);
            return o.isExpNotEnough() ? (o.useAll(), o.getId2UsedNum()) : (this._useGreedily(o), o.isExpRemaining() ? o.getId2UsedNum() : (o.useMoreFewerMaterialIfPossible(), o.useMoreLowerMaterialIfPossible(), o.getId2UsedNum()))
        },
        _filterMaterialModels: function(e, n) {
            return t.filter(e, function(e) {
                return e.get("equipment_type") === n.get("equipment_type")
            })
        },
        _useGreedily: function(e) {
            var t = 9999;
            e.selectTopMaterial();
            var n = 0;
            while (e.isExpRemaining() && e.isMaterialRemaining() && e.isSelectedMaterialAvailable()) {
                var r = e.useOneIfNotOverExp();
                r || (e.isLowerMaterialsExpNotEnough() && e.isSelectedMaterialRemaining() ? e.useOne() : e.selectNextUpperMaterial());
                if (++n > t) throw new Error("Very Greedy.")
            }
        }
    })
}), define("scenes/party/views/EnhancementSpMaterialSelector", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/helper/SpMaterialRecommend", "templates/party/views/SpMaterialSelectList", "components/FreeScroll", "components/Scrollbar", "components/QuantitySelector"], function(e, t, n, r, i, s, o, u, a) {
    return n.View.extend({
        DefaultOptions: {
            baseEquipModel: void 0,
            onIncrease: void 0,
            onDecrease: void 0,
            onMaximize: void 0
        },
        _quantitySelectors: [],
        _id2QuantitySelector: {},
        _selectedSum: 0,
        _id2selectedNum: {},
        initialize: function(t) {
            this._options = e.defaults(t, this.DefaultOptions), this._spMaterialCollection = FF.datastore.equipmentSpMaterialCollection, this._resetProperties()
        },
        setup: function() {
            this._renderSpMaterialList(), this._initSpMaterialListScroller(), this._initSpMaterialFluctuator(), this.updateAllFluctuatorsView()
        },
        dispose: function() {
            e.each(this._quantitySelectors, function(e) {
                e.dispose()
            }), this._quantitySelectors.length = 0, this._id2QuantitySelector = {}, this._resetProperties(), this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose()
        },
        getSelectedSum: function() {
            return this._selectedSum
        },
        getId2SelectedNumMap: function() {
            return this._id2selectedNum
        },
        getSelectedNum: function(e) {
            return this._id2selectedNum[e] || 0
        },
        getIsRecommendUsed: function() {
            return this._isRecommendUsed
        },
        updateAllFluctuatorsView: function() {
            e.each(this._quantitySelectors, function(e) {
                e.updateFluctuatorView()
            })
        },
        disableAllIncreaseButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setIncreaseButtonEnabled(!1)
            })
        },
        disableAllMaximizeButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setMaximizeButtonEnabled(!1)
            })
        },
        updateIncreaseButtonViewOnlyHammeringMaterial: function() {
            var t = this,
                n = this._getSpMaterialModels();
            e.each(n, function(e) {
                var n = +e.get("id"),
                    r = t._id2QuantitySelector[n],
                    i = e.get("hammering_num") > 0;
                i ? r.updateFluctuatorView() : (r.setIncreaseButtonEnabled(!1), r.setMaximizeButtonEnabled(!1))
            })
        },
        resetBy: function(e) {
            var t = this._id2QuantitySelector[e];
            if (!t) return;
            var n = t.getValue();
            this._selectedSum -= n, this._id2selectedNum[e] = 0, t.resetValue(), t.updateFluctuatorView()
        },
        resetAll: function() {
            e.each(this._quantitySelectors, function(e) {
                e.resetValue(), e.updateFluctuatorView()
            }), this._resetProperties()
        },
        recommend: function(e, t) {
            if (t <= 0) return;
            var n = new i,
                r = this._getSpMaterialModels(),
                s = n.recommend(r, e, t);
            if (!s) return;
            this._isRecommendUsed = !0, this._applyRecommendation(s)
        },
        maximize: function(e, t, n, r) {
            var s = this._spMaterialCollection.filter(function(t) {
                return t.get("num") > 0 && t.get("id") === e
            });
            if (s[0].isHammeringMaterial()) {
                this._maximizeHammeringMaterial(e, r);
                return
            }
            if (n <= 0) return;
            var o = new i,
                u = o.recommend(s, t, n, !0);
            if (!u) return;
            this._applyRecommendation(u)
        },
        _resetProperties: function() {
            this._selectedSum = 0, this._id2selectedNum = {}, this._isRecommendUsed = !1
        },
        _getSpMaterialModels: function() {
            var e = this._spMaterialCollection.getSortTypeOf(),
                t = e.FOR_WEAPON,
                n = this._options.baseEquipModel;
            n && n.get("is_armor") && (t = e.FOR_ARMOR), this._spMaterialCollection.changeComparator({
                sortType: t
            }), this._spMaterialCollection.sort();
            var r = this._spMaterialCollection.filter(function(e) {
                return e.get("num") > 0
            });
            return r
        },
        _renderSpMaterialList: function() {
            var e = this._getSpMaterialModels(),
                n = r.process(s, {
                    spMaterialModels: e
                });
            t("[data-app-sp-material-list-items]").html(n)
        },
        _initSpMaterialListScroller: function() {
            this._freescroll = new o({
                el: t("[data-ui-freescroll-2]")
            }), this._scrollbar = new u({
                el: t("[data-ui-scrollbar-2]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _initSpMaterialFluctuator: function() {
            var n = this,
                r = t("[data-ui-fluctuator]");
            e.each(r, function(e) {
                n._constructQuantitySelector(e)
            })
        },
        _constructQuantitySelector: function(e) {
            var n = t(e).find("[data-ui-fluctuator-input]"),
                r = +n.attr("data-app-fluctuator-sp-material-id"),
                i = this,
                s = new a({
                    el: e,
                    autoViewUpdate: !1,
                    onIncrease: function(e) {
                        i._clickIncreaseButton(1, r, e)
                    },
                    onDecrease: function(e) {
                        i._clickDecreaseButton(1, r, e)
                    },
                    onMaximize: function(e) {
                        i._onMaximizeButtonClick(r, e)
                    }
                });
            this._quantitySelectors.push(s), this._id2QuantitySelector[r] = s
        },
        _clickIncreaseButton: function(e, t, n, r) {
            var i = r !== void 0 ? r : !0,
                s = this._spMaterialCollection.findWhere({
                    id: +t
                }),
                o = this._options.onIncrease;
            this._updateSelectedNums(t, e), o && o(s, e, n), i && FF.SoundMgr.playChooseEffect()
        },
        _clickDecreaseButton: function(e, t, n, r) {
            var i = r !== void 0 ? r : !0,
                s = this._spMaterialCollection.findWhere({
                    id: +t
                }),
                o = this._options.onDecrease;
            this._updateSelectedNums(t, -e), o && o(s, e, n), i && FF.SoundMgr.playChooseEffect()
        },
        _onMaximizeButtonClick: function(e, t) {
            var n = this._options.onMaximize;
            if (!n) return;
            var r = this._spMaterialCollection.findWhere({
                id: +e
            });
            n(r, e)
        },
        _updateSelectedNums: function(e, t) {
            this._selectedSum += t;
            var n = (this._id2selectedNum[e] || 0) + t;
            n === 0 ? delete this._id2selectedNum[e] : this._id2selectedNum[e] = n
        },
        _maximizeHammeringMaterial: function(e, t) {
            var n = this._spMaterialCollection.findWhere({
                    id: e
                }),
                r = n.get("num"),
                i = n.get("hammering_num"),
                s = Math.ceil(t / i),
                o = Math.min(s, r),
                u = {};
            u[e] = o, this._applyRecommendation(u)
        },
        _applyRecommendation: function(t) {
            var n = this;
            e.each(t, function(e, t) {
                var r = n._id2QuantitySelector[t];
                n._clickIncreaseButton(e, t, r, !1), r.setValue(e), r.updateFluctuatorView()
            }), FF.SoundMgr.playChooseEffect()
        }
    })
}), define("scenes/party/pages/EnhancementMaterialSelect", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/Config", "scenes/common/helper/MissionHelper", "templates/party/EnhancementMaterialSelect", "templates/party/views/EnhancementList", "templates/party/views/EnhancementSelected", "scenes/party/FusionEquipmentViewController", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalEnhancementConfirm", "scenes/party/views/EnhancementSpMaterialSelector", "scenes/party/pages/Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "components/Tab", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w) {
    var E = e.extend({}, s, {
        SORT_MODULE_KEY: "enhance_material",
        ACTIVE_CLASS_NAME: "is-active",
        CHECKED_CLASS_NAME: "is-checked",
        EQUIPED_CLASS_NAME: "is-in-equip",
        SORTIE_CLASS_NAME: "is-sortie",
        LOCKED_CLASS_NAME: "is-locked",
        HIDE_CLASS_NAME: "di-n",
        DISABLE_CLASS_NAME: "is-disable",
        NUMBERLING_CLASS_NAME: "is-check-no",
        UI_DISABLED_CLASS_NAME: "mbgaui-disabled",
        EQUIPED_SUPPORTER_CLASS_NAME: "is-in-equip-by-supporter",
        HAS_HAMMERING_NUM_CLASS_NAME: "has-hammering-num",
        LIMIT_SELECT_NUM: 10,
        EQUIP_TAB_INDEX: 1,
        CONFIRM_RARITY: 3
    });
    return m.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-clear]": "onClickClear",
            "anchorsbeforejump [data-app-confirm]": "onClickConfirm",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-sp-material-recommend]": "onClickSpMaterialRecommend",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equip-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            m.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.hasLongTap = !1, this.selectionIds = [], this.exp = 0, this.hammeringNum = 0, this._spMaterialExp = 0, this._spMaterialHammeringNum = 0, this.userGil = FF.datastore.userModel.get("gil"), this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), w.resetSceneScopeStatus(E.SORT_MODULE_KEY), this._sortOptions = w.getDefaultSortOptions(E.SORT_MODULE_KEY)
        },
        render: function(e) {
            var t = this;
            this.baseId = e[0] - 0, this.equipCollection = FF.datastore.equipmentCollection, this.itemPossessionLimitCollection = FF.datastore.itemPossessionLimitCollection, this.baseModel = this.equipCollection.findWhere({
                id: this.baseId
            }), this.buddyCollection = FF.datastore.buddyCollection, this._spMaterialCollection = FF.datastore.equipmentSpMaterialCollection, m.prototype.render.call(this, f, {
                baseEquipment: this.baseModel,
                userGil: this.userGil,
                isShowingLv: this._isShowingLv
            }), this._setupTab(), this._setupSpMaterialPane(this.baseModel), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this.renderSelectedItem(), this.showMaxLvAlertIfNeed(), this._updateSelectingInfo(), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new y({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: 2
            })
        },
        _setupTab: function() {
            this._tabPanes = t('[data-ui-group="pane"]'), this._tab = new b({
                tabs: t('[data-ui-group="tab"]'),
                panes: this._tabPanes,
                className: "is-current",
                defaultPage: 0
            }), this._tab.hideInactivePanes(), this.listenTo(this._tab, "changedState", this._onTabStateChange)
        },
        _onTabStateChange: function(e) {
            var n = t(e.prevPane),
                r = t(e.currentPane);
            n.addClass(E.HIDE_CLASS_NAME), r.removeClass(E.HIDE_CLASS_NAME), e.index === E.EQUIP_TAB_INDEX && (this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            }), this.overScrollView.rebindNativeScrollEvent(), this.overScrollView.setIsScrollableIfSinglePage())
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderCollectionList: function(n) {
            n = n || {}, this.equipCollection.changeComparator(n), this.equipCollection.sort();
            var r = {},
                i = {};
            this.overScrollView.updateCollectionSize(this.getMaterialModels().length), this.overScrollView.setMaxPageText(), e.each(t("[data-app-equip-list]"), function(e) {
                var n = t(e).attr("data-app-equip-id"),
                    s = t(e).find("input");
                r[n] = t(e).attr("class") || "", i[n] = t(s).attr("class") || ""
            }), this._renderItems(), e.each(t("[data-app-equip-list]"), function(e) {
                var n = t(e).attr("data-app-equip-id");
                t(e).addClass(r[n]), t(e).find("input").addClass(i[n])
            })
        },
        renderSelectedItem: function() {
            var e = this.baseModel.isMaxLv() ? 100 : this.baseModel.getExpPerNextLvExp(),
                n = r.process(c, {
                    model: this.baseModel,
                    expPerNextLvExp: e
                });
            t("[data-app-selected-equipment]").html(n)
        },
        getMaterialModels: function() {
            var t = this,
                n = this.equipCollection.getEnhancementMaterialModels();
            return e.filter(n, function(e) {
                return e.get("id") === t.baseModel.get("id") ? !1 : !0
            })
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this._setupSelectionClassName(),
                s = r.process(l, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    models: this.getMaterialModels().slice(e, n),
                    pageName: "enhancement_selected",
                    isInDungeon: this.isInDungeon(),
                    isMaxOrOverCurrentMaxExp: this.isMaxOrOverCurrentMaxExp(),
                    isMaxOrOverCurrentMaxHammeringNum: this.isMaxOrOverCurrentMaxHammeringNum(),
                    isMaxOrOverCurrentMaxExpAndHammeringNum: this.isMaxOrOverCurrentMaxExpAndHammeringNum(),
                    selectionClassNameMap: i,
                    selectionIds: this.selectionIds,
                    CONST: E,
                    isShowingLv: this._isShowingLv
                }),
                o = t("[data-app-list-equip-container]");
            this.overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _setupSelectionClassName: function() {
            var t = {};
            return e.each(this.selectionIds, function(e, n) {
                n += 1, t[e] = "is-check-no" + n
            }), t
        },
        onLongTapEquipDetail: function(e) {
            var n = t(e.target),
                r = n.closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = r.find("input").hasClass(E.CHECKED_CLASS_NAME);
            if (s) return;
            this.overScrollView.cancelScroll(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.hasLongTap = !0;
            var o = this.equipCollection.get(i);
            this._openEquipmentDetailModal(r, o)
        },
        _openEquipmentDetailModal: function(e, t) {
            var n = this;
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(t)
                },
                onPop: function(r, i) {
                    n.hasLongTap = !1;
                    var s = n._canEquipBeEnabled(t);
                    g.updateLockableItemElem(i, e, s)
                }
            })
        },
        _canEquipBeEnabled: function(e) {
            if (this._isSelectedLimit()) return !1;
            if (this.isMaxOrOverCurrentMaxExpAndHammeringNum()) return !1;
            var t = e.get("hammering_num");
            return this.isMaxOrOverCurrentMaxExp() && t <= 0 ? !1 : !0
        },
        openConfirmModal: function() {
            FF.router.loading.lock();
            var e = this,
                t = this.baseModel.get("id"),
                n = this._spMaterialSelector.getId2SelectedNumMap(),
                r = this._spMaterialSelector.getIsRecommendUsed();
            i.EquipmentEnhanceDeferred({
                src_user_equipment_id: t,
                material_user_equipment_ids: this.selectionIds,
                equipment_sp_material_id_2_num: n,
                displayed_required_gil: this.calcCostGil(),
                is_sp_material_recommend_used: r ? 1 : 0,
                exec: 0
            }).done(function(t) {
                var n = e._makeParamsMapForConfirmModal(t);
                e._renderConfirmModal(n)
            })
        },
        _renderConfirmModal: function(e) {
            this.modalEnhancementConfirmView = new d, this.modalEnhancementConfirmView.render(e), FF.router.overlay.registerChildren(this.modalEnhancementConfirmView), this.modalEnhancementConfirmView.open(!0);
            var n = this;
            this.listenToOnce(this.modalEnhancementConfirmView, "onClickCancel", function() {
                n.stopListening(n.modalEnhancementConfirmView, "onClickDecide"), t("[data-app-confirm]").removeClass(E.UI_DISABLED_CLASS_NAME)
            }), this.listenToOnce(this.modalEnhancementConfirmView, "onClickDecide", function() {
                n.stopListening(n.modalEnhancementConfirmView, "onClickCancel"), n.onClickDecide()
            })
        },
        _makeParamsMapForConfirmModal: function(t) {
            var n = this._getSelectedSpMaterialModels(),
                r = this.equipCollection.getModels(this.selectionIds),
                i = this._containsRarityNAndMore(E.CONFIRM_RARITY, n, r),
                s = this.baseModel.getExpPerNextLvExp(),
                o = this.baseModel.get("hammering_num") + e.reduce(r, function(e, t) {
                    return t.get("hammering_num") + e
                }, 0),
                u = o > this.baseModel.get("max_hammering_num"),
                a = {
                    base: t.old_src_user_equipment,
                    changedStatus: t.new_src_user_equipment,
                    costGil: t.required_gil,
                    exp: t.available_exp + t.over_exp,
                    overExp: t.over_exp,
                    userGil: this.userGil,
                    haveSuperRare: i,
                    expPerNextLvExp: s,
                    growthRate: this.growthRate,
                    selectedEquipModels: r,
                    selectedSpMaterialModels: n,
                    isHammeringNumOverflow: u
                };
            return a.base.uri = this.baseModel.get("image_path"), a.base.categoryName = this.baseModel.get("category_name"), a
        },
        _containsRarityNAndMore: function(t, n, r) {
            var i = function(n) {
                return e.find(n, function(e) {
                    return e.get("rarity") >= t
                })
            };
            return i(n) || i(r)
        },
        _getSelectedSpMaterialModels: function() {
            var t = [],
                n = this._spMaterialSelector.getId2SelectedNumMap();
            return e.each(this._spMaterialCollection.models, function(e) {
                var r = e.get("id"),
                    i = n[r];
                if (i > 0) {
                    var s = e.clone();
                    s.set("num", i), t.push(s)
                }
            }), t
        },
        addSelectionIds: function(e) {
            var t = this.equipCollection.get(e);
            this.selectionIds.push(e), t.set("isSelected", !0)
        },
        removeSelectionIds: function(t) {
            var n = this,
                r = void 0;
            e.each(t, function(t) {
                n.selectionIds = e.without(n.selectionIds, +t), r = n.equipCollection.get(t), r.unset("isSelected")
            })
        },
        _isSelectedLimit: function() {
            return this.selectionIds.length >= E.LIMIT_SELECT_NUM
        },
        setSelectedNum: function() {
            t("[data-app-selected-num]").text(this.selectionIds.length)
        },
        showMaxLvAlertIfNeed: function() {
            var e = this.isMaxOrOverCurrentMaxExp(),
                n = this.isMaxOrOverCurrentMaxHammeringNum(),
                r = e && n;
            r ? (t("[data-app-max-lv-alert]").addClass(E.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").addClass(E.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").removeClass(E.HIDE_CLASS_NAME)) : e ? (t("[data-app-max-lv-alert]").removeClass(E.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").addClass(E.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").addClass(E.HIDE_CLASS_NAME)) : n ? (t("[data-app-max-lv-alert]").addClass(E.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").removeClass(E.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").addClass(E.HIDE_CLASS_NAME)) : (t("[data-app-max-lv-alert]").addClass(E.HIDE_CLASS_NAME), t("[data-app-max-hammering-num-alert]").addClass(E.HIDE_CLASS_NAME), t("[data-app-both-max-alert]").addClass(E.HIDE_CLASS_NAME))
        },
        hideMaxLvAlert: function() {
            t("[data-app-max-lv-alert]").addClass(E.HIDE_CLASS_NAME)
        },
        setExp: function() {
            var e = !1,
                n = this.baseModel.get("level"),
                r = this.baseModel.get("level_max"),
                i = this.baseModel.get("hammering_num"),
                s = this.baseModel.get("max_hammering_num"),
                o = Math.min(this.baseModel.get("hammering_num") + this.hammeringNum, s);
            t("[data-app-level]").text(n).removeClass("fc-up"), t("[data-app-hammering-num]").text(i).removeClass("fc-up"), i < o && (s < o && (o = s), t("[data-app-hammering-num]").text(o).addClass("fc-up")), this._showExpIfNeed(), this._showOverExpIfNeed();
            if (n < r) {
                var u = Math.min(n + 1, r),
                    a = 0,
                    f = this.exp,
                    l = this.baseModel.get("exp"),
                    c = this.baseModel.getExpToLvN(u),
                    h = this.baseModel.getExpPerNextLvExp(),
                    p = this.baseModel.getTotalExpToLvN(u);
                t("[data-app-exp-gauge]").width(h + "%"), this.growthRate = this.baseModel.getGrowthRate(u, l + f);
                while (this.growthRate >= 100) {
                    t("[data-app-level]").text(u).addClass("fc-up"), n + 1 !== r && t("[data-app-exp-gauge]").width(0), e ? a -= c : a = l + f - p, u += 1, c = this.baseModel.getExpToLvN(u), this.growthRate = Math.floor(a / c * 100), e = !0;
                    if (u > r) {
                        this.growthRate = 100;
                        break
                    }
                }
                t("[data-app-exp-gauge-up]").width(this.growthRate + "%")
            } else this.growthRate = 0, t("[data-app-exp-gauge]").width("100%"), t("[data-app-exp-gauge-up]").width("0%")
        },
        _showExpIfNeed: function() {
            this.exp > 0 ? (t("[data-app-exp-num]").text(this.exp), t("[data-app-exp-num-text]").removeClass(E.HIDE_CLASS_NAME)) : t("[data-app-exp-num-text]").addClass(E.HIDE_CLASS_NAME)
        },
        _showOverExpIfNeed: function() {
            var e = -this._getExpRemain();
            e > 0 ? (t("[data-app-exp-num-over]").text(e), t("[data-app-exp-num-over-text]").removeClass(E.HIDE_CLASS_NAME)) : t("[data-app-exp-num-over-text]").addClass(E.HIDE_CLASS_NAME)
        },
        _getNumMaterials: function() {
            var e = this._spMaterialSelector.getSelectedSum();
            return this.selectionIds.length + e
        },
        setCostGil: function() {
            t("[data-app-costGil]").text(this.calcCostGil())
        },
        calcCostGil: function() {
            var e = this.baseModel.getTotalExpToCurrentMaxLv() - this.baseModel.get("exp"),
                t = this._calcSpMaterialCostGil(e),
                n = this._calcEquipmentMaterialCostGil(e - this._spMaterialExp);
            return t + n
        },
        _calcSpMaterialCostGil: function(t) {
            var n = this,
                r = 0,
                i = this._spMaterialSelector.getId2SelectedNumMap(),
                s = this._spMaterialCollection.sortBy(function(e) {
                    return -e.getActualExp(n.baseModel)
                });
            return e.each(s, function(e) {
                if (t <= 0) return;
                var s = e.get("id"),
                    o = i[s];
                if (!o) return;
                var u = e.getActualExp(n.baseModel),
                    a = Math.min(o, Math.ceil(t / u));
                t -= a * u, r += a
            }), r * this.baseModel.get("required_enhancement_base_gil")
        },
        _calcEquipmentMaterialCostGil: function(t) {
            var n = this,
                r = 0,
                i = this.baseModel.get("category_id"),
                s = this.baseModel.get("equipment_type");
            return e.each(this.selectionIds, function(e) {
                if (t <= 0) return;
                var o = n.equipCollection.get(e);
                t -= o.getExp(i, s), ++r
            }), r * this.baseModel.get("required_enhancement_base_gil")
        },
        canPay: function() {
            return this.userGil - this.calcCostGil() >= 0
        },
        showGilAlert: function() {
            t("[data-app-no-gil]").removeClass(E.HIDE_CLASS_NAME)
        },
        hideGilAlert: function() {
            t("[data-app-no-gil]").addClass(E.HIDE_CLASS_NAME)
        },
        showConfirmBtn: function() {
            t("[data-app-confirm]").removeClass(E.DISABLE_CLASS_NAME)
        },
        hideConfirmBtn: function() {
            t("[data-app-confirm]").addClass(E.DISABLE_CLASS_NAME)
        },
        showClearBtn: function() {
            t("[data-app-clear]").removeClass(E.DISABLE_CLASS_NAME)
        },
        hideClearBtn: function() {
            t("[data-app-clear]").addClass(E.DISABLE_CLASS_NAME)
        },
        hasActiveClass: function(e) {
            return e.hasClass(E.ACTIVE_CLASS_NAME)
        },
        removeAllActiveClass: function() {
            t("[data-app-equip-list]").removeClass(E.ACTIVE_CLASS_NAME)
        },
        removeAllOtherActiveClass: function(e) {
            t("[data-app-equip-list]").removeClass(E.ACTIVE_CLASS_NAME), e.addClass(E.ACTIVE_CLASS_NAME)
        },
        enableSelection: function() {
            var e = t("[data-app-equip-list]:not(." + E.EQUIPED_CLASS_NAME + ", ." + E.EQUIPED_SUPPORTER_CLASS_NAME + ", ." + E.LOCKED_CLASS_NAME + ", ." + E.SORTIE_CLASS_NAME + ")" + " input:not(." + E.CHECKED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").removeClass(E.DISABLE_CLASS_NAME)
        },
        disableSelection: function() {
            var e = t("[data-app-equip-list]:not(." + E.EQUIPED_CLASS_NAME + ", ." + E.EQUIPED_SUPPORTER_CLASS_NAME + ", ." + E.LOCKED_CLASS_NAME + ", ." + E.SORTIE_CLASS_NAME + ")" + " input:not(." + E.CHECKED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").addClass(E.DISABLE_CLASS_NAME)
        },
        enableSelectionOnlyHasHammeringNum: function() {
            var e = t("[data-app-equip-list]." + E.HAS_HAMMERING_NUM_CLASS_NAME + ":not(." + E.LOCKED_CLASS_NAME + ")" + " input:not(." + E.CHECKED_CLASS_NAME + ", ." + E.EQUIPED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").removeClass(E.DISABLE_CLASS_NAME)
        },
        disableSelectionExceptHasHammeringNum: function() {
            var e = t("[data-app-equip-list]." + E.EQUIPED_CLASS_NAME + ", ." + E.EQUIPED_SUPPORTER_CLASS_NAME + ", ." + E.SORTIE_CLASS_NAME + " input:not(." + E.CHECKED_CLASS_NAME + ")");
            e.closest("[data-app-equip-list]").addClass(E.DISABLE_CLASS_NAME)
        },
        enableSelectionHasHammeringNumAndNotEquipped: function() {
            this.disableSelection(), this.enableSelectionOnlyHasHammeringNum(), this.disableSelectionExceptHasHammeringNum()
        },
        clearSelected: function() {
            var n = this;
            t("[data-app-equip-list] ." + E.CHECKED_CLASS_NAME).removeClass(E.CHECKED_CLASS_NAME), t("[data-app-equip-list]." + E.ACTIVE_CLASS_NAME).removeClass(E.ACTIVE_CLASS_NAME);
            var r = t("[data-app-equip-list][class*=" + E.NUMBERLING_CLASS_NAME + "]");
            e.each(r, function(e) {
                var r = n.getNumberingClass(e);
                t(e).removeClass(r)
            }), this.removeSelectionIds(this.selectionIds), this.selectionIds = []
        },
        getNumberingClass: function(n) {
            var r = t(n).attr("class").split(" "),
                i = e.find(r, function(e) {
                    return e.indexOf(E.NUMBERLING_CLASS_NAME) >= 0
                });
            return i
        },
        onClickEquipList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = this.baseModel.get("category_id"),
                i = this.baseModel.get("equipment_type"),
                s = n.find("input"),
                o = +n.attr("data-app-equip-id"),
                u = this.equipCollection.get(o),
                a = s.hasClass(E.CHECKED_CLASS_NAME);
            if (a) this.removeAllActiveClass(), this.deselectTarget(n), this.exp -= u.getExp(r, i), this.hammeringNum -= u.get("hammering_num"), this.removeSelectionIds([o]);
            else {
                if (!this._isSelectableEquip(n)) {
                    FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                    return
                }
                this.removeAllOtherActiveClass(n), this.addSelectionIds(o), this.selectTarget(n), this.exp += u.getExp(r, i), this.hammeringNum += u.get("hammering_num")
            }
            this._updateSelectingInfo(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        _isSelectableEquip: function(e) {
            return this._isSelectedLimit() ? !1 : this.isMaxOrOverCurrentMaxExpAndHammeringNum() ? !1 : g.isSelectableItemElem(e) ? !0 : !1
        },
        _updateSelectingInfo: function() {
            this.showMaxLvAlertIfNeed(), this.setSelectedNum(), this.setCostGil(), this.setExp(), this._updateMaterialSelectStates(), this.canPay() ? (this.hideGilAlert(), this.showConfirmBtn()) : (this.showGilAlert(), this.hideConfirmBtn()), this._getNumMaterials() === 0 ? (this.hideClearBtn(), this.hideConfirmBtn()) : this.showClearBtn()
        },
        _updateMaterialSelectStates: function() {
            if (this.isMaxOrOverCurrentMaxExpAndHammeringNum()) {
                this.disableSelection(), this._spMaterialSelector.disableAllIncreaseButton(), this._spMaterialSelector.disableAllMaximizeButton();
                return
            }
            var e = this.isMaxOrOverCurrentMaxExp() && !this.isMaxOrOverCurrentMaxHammeringNum();
            this._isSelectedLimit() ? this.disableSelection() : e ? this.enableSelectionHasHammeringNumAndNotEquipped() : this.enableSelection(), e ? this._spMaterialSelector.updateIncreaseButtonViewOnlyHammeringMaterial() : this._spMaterialSelector.updateAllFluctuatorsView()
        },
        isMaxOrOverCurrentMaxExp: function() {
            var e = this.baseModel.get("exp") + this.exp;
            return e >= this.baseModel.getTotalExpToCurrentMaxLv()
        },
        isMaxOrOverExp: function(e) {
            var t = this.baseModel.get("exp") + e;
            return t >= this.baseModel.getTotalExpToCurrentMaxLv()
        },
        isMaxOrOverCurrentMaxHammeringNum: function() {
            var e = this.baseModel.get("hammering_num") + this.hammeringNum;
            return e >= this.baseModel.get("max_hammering_num")
        },
        isMaxOrOverCurrentMaxExpAndHammeringNum: function() {
            return this.isMaxOrOverCurrentMaxExp() && this.isMaxOrOverCurrentMaxHammeringNum()
        },
        selectTarget: function(e) {
            e.find("input").addClass(E.CHECKED_CLASS_NAME), e.addClass(E.NUMBERLING_CLASS_NAME + this.selectionIds.length)
        },
        deselectTarget: function(e) {
            e.find("input").removeClass(E.CHECKED_CLASS_NAME);
            var n = this.getNumberingClass(e);
            e.removeClass(n);
            var r = +n.split(E.NUMBERLING_CLASS_NAME)[1],
                i = this.selectionIds.length - r;
            for (var s = 1; s <= i; s++) {
                var o = E.NUMBERLING_CLASS_NAME + (r + s),
                    u = t("[class*=" + o + "]");
                u.removeClass(o), u.addClass(E.NUMBERLING_CLASS_NAME + (r + s - 1))
            }
        },
        onClickDecide: function() {
            FF.router.loading.lock(), this.offBackEvent();
            var e = this,
                n = this.baseModel.get("id"),
                r = this._spMaterialSelector.getId2SelectedNumMap(),
                s = this._spMaterialSelector.getIsRecommendUsed(),
                o = null;
            i.EquipmentEnhanceDeferred({
                src_user_equipment_id: n,
                material_user_equipment_ids: this.selectionIds,
                equipment_sp_material_id_2_num: r,
                displayed_required_gil: this.calcCostGil(),
                is_sp_material_recommend_used: s ? 1 : 0,
                exec: 1
            }).then(function(e) {
                return o = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return a.saveAchievedMissionsDeferred(o.achieved_missions)
            }).done(function() {
                e.showAnimation(o)
            })
        },
        showAnimation: function(e) {
            var t = this;
            kickmotor.googleanalytics.sendScreenName(u.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.EquipEnhancementAnimation), this.fusionController = new h({
                dataMap: e,
                baseModel: this.baseModel,
                type: "result_fusion",
                exp: this.exp
            }), this.modalEnhancementConfirmView.end(!0), this.fusionController.loadViewDeferred(), this.listenToOnce(this.fusionController, "closeAnimation", function() {
                t.updatePage(e), t.onBackEvent()
            })
        },
        updatePage: function(e) {
            this.updateGil(e.current_gil), this.updateBaseModel(e), this._updateSpMaterialCollection(), this.onClickClear();
            var t = e.new_src_user_equipment.is_max_level;
            t ? this.backPage() : n.history.loadUrl()
        },
        updateGil: function(e) {
            FF.datastore.userModel.set("gil", e)
        },
        updateBaseModel: function(e) {
            FF.logger.debug("enhanceDataMap", e);
            var t = e.new_src_user_equipment,
                n = this.selectionIds;
            this.baseModel.set(t), this.itemPossessionLimitCollection.update(e.item_possession_limits), this.removeSelectionIds(n), this.equipCollection.remove(n)
        },
        _updateSpMaterialCollection: function() {
            var t = this,
                n = this._spMaterialSelector.getId2SelectedNumMap();
            e.each(n, function(e, n) {
                var r = t._spMaterialCollection.get(n),
                    i = r.get("num") - e;
                r.set("num", i)
            })
        },
        onClickClear: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._resetSpMaterialSelect(), this.clearSelected(), this.exp = 0, this.hammeringNum = 0, this._updateSelectingInfo(), FF.router.loading.unlock()
        },
        _resetSpMaterialSelect: function() {
            this._spMaterialSelector.resetAll(), this.exp -= this._spMaterialExp, this.hammeringNum -= this._spMaterialHammeringNum, this._spMaterialExp = 0, this._spMaterialHammeringNum = 0
        },
        backPage: function() {
            var e = this.baseModel.get("equipment_type"),
                t = "#party/enhancement_base_select",
                r = t + "/" + e;
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickConfirm: function() {
            this.blurSelectorOrder(), this.openConfirmModal()
        },
        onClickBack: function() {
            this.backPage()
        },
        onClickOpenSortModal: function() {
            w.openModalDeferred(E.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _setupSpMaterialPane: function(e) {
            this._spMaterialSelector = new v({
                baseEquipModel: e,
                onIncrease: this._onSpMaterialIncrease.bind(this),
                onDecrease: this._onSpMaterialDecrease.bind(this),
                onMaximize: this._onSpMaterialMaximize.bind(this)
            }), this._spMaterialSelector.setup()
        },
        _onSpMaterialIncrease: function(e, t, n) {
            var r = t || 1;
            this._modifyCurrentExpByNum(e, r), n.setDecreaseButtonEnabled(!0), this._updateSelectingInfo()
        },
        _onSpMaterialDecrease: function(e, t, n) {
            var r = t || 1;
            this._modifyCurrentExpByNum(e, -r), this._updateSelectingInfo()
        },
        _onSpMaterialMaximize: function(e, t) {
            var n = this._spMaterialSelector.getSelectedNum(t);
            this._modifyCurrentExpByNum(e, -n), this._spMaterialSelector.resetBy(t);
            var r = this._getExpRemain(),
                i = this._getHammeringRemain();
            this._spMaterialSelector.maximize(t, this.baseModel, r, i), this._updateSelectingInfo()
        },
        _modifyCurrentExpByNum: function(e, t) {
            if (t === 0) return;
            var n = t * e.getActualExp(this.baseModel),
                r = t * e.get("hammering_num");
            this.exp += n, this.hammeringNum += r, this._spMaterialExp += n, this._spMaterialHammeringNum += r
        },
        onClickSpMaterialRecommend: function() {
            this._resetSpMaterialSelect();
            var e = this._getExpRemain();
            this._spMaterialSelector.recommend(this.baseModel, e), this._updateSelectingInfo()
        },
        _getExpRemain: function() {
            var e = this.baseModel.get("exp"),
                t = this.baseModel.getTotalExpToCurrentMaxLv(),
                n = t - e - this.exp;
            return n
        },
        _getHammeringRemain: function() {
            var e = this.baseModel.get("max_hammering_num") - this.baseModel.get("hammering_num") - this.hammeringNum;
            return e >= 0 ? e : 0
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        processAfterContentLoad: function() {
            m.prototype.processAfterContentLoad.call(this), a.openModalMissionClearIfNeedDeferred()
        },
        dispose: function() {
            this._tab && this._tab.dispose(), this._spMaterialSelector && this._spMaterialSelector.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), this.overScrollView && this.overScrollView.dispose(), this.modalEnhancementConfirmView && this.modalEnhancementConfirmView.end(), this.fusionController && this.fusionController.dispose(), !this.selectionIds.length || this.removeSelectionIds(this.selectionIds), m.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/EvolutionBaseSelect", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/MissionHelper", "scenes/common/views/OverScrollView", "templates/party/EvolutionBaseSelect", "templates/party/views/EvolutionList", "scenes/common/collections/Equipment", "scenes/party/views/ModalEquipmentDetail", "scenes/party/pages/Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "components/Tab", "scenes/common/helper/FuncTutorial", "scenes/common/helper/HammeringTutorial", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend({}, s, {
        SORT_MODULE_KEY_FOR_WEAPON: "evolution_weapon_tab",
        SORT_MODULE_KEY_FOR_ARMOR: "evolution_armor_tab",
        ACHIEVE_TYPE_NAMES: ["EVOLVE"],
        HIDE_CLASS_NAME: "di-n",
        WEAPON_TAB_INDEX: "0",
        ARMOR_TAB_INDEX: "1"
    });
    return h.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equip-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            h.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm();
            var t = e && e.args && e.args[0] ? e.args[0] : FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON;
            this.hasLongTap = !1, this._currentTabIndex = this._getTabIndex(t), this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0, this.selectedEquipModel = void 0, this._initSortOptions(this._currentTabIndex)
        },
        _getTabIndex: function(e) {
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.WEAPON) return b.WEAPON_TAB_INDEX;
            if (+e === +FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ARMOR) return b.ARMOR_TAB_INDEX;
            throw new Error("Invalid equipment type:", e)
        },
        _initSortOptions: function(e) {
            FF.resonator.resetSimulation(), y.resetSceneScopeStatus(b.SORT_MODULE_KEY_FOR_WEAPON), y.resetSceneScopeStatus(b.SORT_MODULE_KEY_FOR_ARMOR), this._sortOptions = this._getSortOptionsByTab(e)
        },
        render: function() {
            var e = FF.datastore.equipmentCollection,
                t = e.getEvolutionSrcModels();
            this.evolveCollection = new l, this.evolveCollection.add(t), h.prototype.render.call(this, a, {
                userGil: FF.datastore.userModel.get("gil"),
                isShowingLv: this._isShowingLv
            }), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this._initTab()
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new d({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: 2
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        _initTab: function() {
            this._tab = new v({
                tabs: t('[data-ui-group="tab"]'),
                panes: void 0,
                className: "is-current",
                defaultPage: this._currentTabIndex
            }), this.listenTo(this._tab, "changedState", this._onTabStateChange.bind(this))
        },
        _onTabStateChange: function(e) {
            this._currentTabIndex = "" + e.index, this.overScrollView.cleanup(), this._sortOptions = this._getSortOptionsByTab(this._currentTabIndex), FF.resonator.simulateResonance(this._sortOptions.resonanceSeriesId), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this.overScrollView.setIsScrollableIfSinglePage()
        },
        _getSortOptionsByTab: function(e) {
            var t = this._getSortKeyByTab(e);
            return y.getDefaultSortOptions(t)
        },
        _getSortKeyByTab: function(e) {
            return e === b.WEAPON_TAB_INDEX ? b.SORT_MODULE_KEY_FOR_WEAPON : b.SORT_MODULE_KEY_FOR_ARMOR
        },
        renderCollectionList: function(e) {
            e = e || {}, this.evolveCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this._getTargetEquipModels(!1).length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this._getTargetEquipModels(!0).slice(e, n),
                s = r.process(f, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    models: i,
                    pageName: "evolution",
                    isInDungeon: this.isInDungeon(),
                    isShowingLv: this._isShowingLv
                }),
                o = t("[data-app-list-equip-container]");
            this.overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        _getTargetEquipModels: function(e) {
            e && this.evolveCollection.sort();
            var t;
            switch (this._currentTabIndex) {
                case b.WEAPON_TAB_INDEX:
                    t = this.evolveCollection.getEnhancementSrcWeaponModels();
                    break;
                case b.ARMOR_TAB_INDEX:
                    t = this.evolveCollection.getEnhancementSrcArmorModels();
                    break;
                default:
                    throw new Error("Invalid tab index:", this._currentTabIndex)
            }
            return t
        },
        processAfterContentLoad: function() {
            var e = this;
            h.prototype.processAfterContentLoad.call(this), m.showNavigationDeferred({
                key: "EVOLUTION",
                isTutorialIllustOnly: !0
            }).then(g.navigateIfNeedDeferred.bind(g)).then(o.openModalMissionClearIfNeedDeferred.bind(o))
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.overScrollView.cancelScroll(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.hasLongTap = !0, this.blurSelectorOrder();
            var r = t(e.target).closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = this.evolveCollection.get(i);
            FF.modalStack.push(c, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n.hasLongTap = !1
                }
            }), FF.modalStack.setOnComplete(function(e) {
                p.updateLockableItemElem(e, r, !1)
            })
        },
        onClickOpenSortModal: function() {
            var e = this._getSortKeyByTab(this._currentTabIndex);
            y.openModalDeferred(e).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickEquipList: function(e) {
            if (this.hasLongTap) return;
            var n = t(e.target),
                r = +n.attr("data-app-equip-id");
            if (n.hasClass("is-sortie") || n.hasClass("is-lv-lack")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.selectedEquipModel = this.evolveCollection.get(r), this.decide()
        },
        decide: function() {
            var e = this.selectedEquipModel.get("id"),
                t = "#party/evolution_selected/" + e;
            FF.datastore.stash.isShowingLv = this._isShowingLv, n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this._tab && this._tab.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), h.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalEvolutionConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "templates/party/views/ModalEvolutionConfirm", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-cancel]": "onClickCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide"
        },
        open: function() {
            s.prototype.open.apply(this, arguments), this.listenToOnce(this, "openAnimationEnd", function() {
                t(".c-anim-status-blink-default").parent().addClass("is-animate")
            })
        },
        render: function(e) {
            this.renderContent(i, {
                parameterMap: e
            })
        },
        onClickCancel: function() {
            this.trigger("onClickCancel"), this.end()
        },
        onClickDecide: function() {
            this.trigger("onClickDecide")
        }
    })
}), define("scenes/party/pages/EvolutionSelected", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/Config", "scenes/common/helper/MissionHelper", "templates/party/EvolutionMaterialSelect", "templates/party/views/EvolutionList", "templates/party/views/EvolutionSelected", "../FusionEquipmentViewController", "scenes/party/views/ModalEquipmentDetail", "../views/ModalEvolutionConfirm", "./Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g) {
    var y = e.extend({}, s, {
        HIDE_CLASS_NAME: "di-n"
    });
    return v.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-equip-list]": "onClickEquipList",
            "anchorsbeforejump [data-app-base-change]": "onClickBaseChange",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump #btnLabelSwitcher": "onClickLabelSwitcher",
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorslongtap [data-app-equip-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            v.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.hasLongTap = !1, this.materialModel = void 0, this.exp = 0, this.isOpeningConfirmModal = !1, this.userGil = FF.datastore.userModel.get("gil"), this._isShowingLv = FF.datastore.stash.hasOwnProperty("isShowingLv") ? FF.datastore.stash.isShowingLv : !0
        },
        render: function(e) {
            this.baseId = e[0] - 0, this.equipCollection = FF.datastore.equipmentCollection, this.baseModel = this.equipCollection.get(this.baseId), this.costGil = this.baseModel.get("required_evolution_gil"), v.prototype.render.call(this, f, {
                userGil: this.userGil,
                costGil: this.costGil,
                baseEquipment: this.baseModel,
                isShowingLv: this._isShowingLv
            }), this.renderSelectedItem(), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.overScrollView.updateCollectionSize(this.getFilterByBaseModel().length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new g({
                toggleListParentElem: t("#equipmentList"),
                maxNum: 2
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-equip-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        _renderItems: function() {
            var e = this.getFilterByBaseModel(),
                n = this.overScrollView.getStartNum(),
                r = this.overScrollView.getEndNum(),
                i = l({
                    renderIndex: null,
                    models: e.slice(n, r),
                    pageName: "evolution_selected",
                    isInDungeon: this.isInDungeon(),
                    isShowingLv: this._isShowingLv
                }),
                s = t("[data-app-list-equip-container]");
            this.overScrollView.render({
                html: i,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        renderSelectedItem: function() {
            var e = r.process(c, {
                model: this.baseModel
            });
            t("[data-app-selected-equipment]").html(e)
        },
        getFilterByBaseModel: function() {
            var t = this;
            return e.filter(this.equipCollection.models, function(e) {
                var n = e.get("id") === t.baseModel.get("id"),
                    r = e.get("equipment_id") === t.baseModel.get("equipment_id");
                return !n && r
            })
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.overScrollView.cancelScroll(), FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equip-id]"),
                i = r.attr("data-app-equip-id"),
                s = this.equipCollection.get(i);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n.hasLongTap = !1
                }
            }), FF.modalStack.setOnComplete(function(e) {
                m.updateLockableItemElem(e, r, !0)
            })
        },
        openConfirmModal: function() {
            var e = this,
                t = this.baseModel.get("id"),
                n = this.materialModel.get("id");
            i.EquipmentEvolveDeferred({
                src_user_equipment_id: t,
                material_user_equipment_id: n,
                exec: 0
            }).done(function(t) {
                var n = e.materialModel.get("evolution_num") >= 1,
                    r = t.new_src_user_equipment.exp,
                    i = e.baseModel.getTotalExpToLvN(e.baseModel.get("level") + 1),
                    s = Math.floor(r / i * 100),
                    o = e.baseModel.get("hammering_num") + e.materialModel.get("hammering_num"),
                    u = o > e.baseModel.get("max_hammering_num"),
                    a = {
                        base: t.old_src_user_equipment,
                        changedStatus: t.new_src_user_equipment,
                        costGil: t.required_gil,
                        exp: t.available_exp,
                        userGil: e.userGil,
                        expPerNextLvExp: s,
                        material: e.materialModel,
                        isSelectedEvolvedMaterial: n,
                        isHammeringNumOverflow: u
                    };
                a.base.uri = e.baseModel.get("image_path"), a.base.categoryName = e.baseModel.get("category_name"), a.base.description = e.baseModel.getDispName(), e.modalEvolutionConfirmView = new d, e.modalEvolutionConfirmView.render(a), FF.router.overlay.registerChildren(e.modalEvolutionConfirmView), e.modalEvolutionConfirmView.open(!0), e.listenToOnce(e.modalEvolutionConfirmView, "onClickCancel", function() {
                    e.stopListening(e.modalEvolutionConfirmView, "onClickDecide"), e.isOpeningConfirmModal = !1
                }), e.listenToOnce(e.modalEvolutionConfirmView, "onClickDecide", function() {
                    e.stopListening(e.modalEvolutionConfirmView, "onClickCancel"), e.onClickDecide()
                })
            })
        },
        canPay: function() {
            return this.userGil - this.costGil >= 0
        },
        onClickEquipList: function(n) {
            if (this.hasLongTap) return;
            FF.router.loading.lock();
            var r = t(n.target),
                i = +r.attr("data-app-equip-id");
            this.materialModel = e.findWhere(this.getFilterByBaseModel(), {
                id: i
            });
            if (r.hasClass("is-sortie") || r.hasClass("is-in-equip") || r.hasClass("is-in-equip-by-supporter")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            if (this.canPay()) {
                if (this.isOpeningConfirmModal) {
                    FF.router.loading.unlock();
                    return
                }
                this.isOpeningConfirmModal = !0, FF.SoundMgr.playChooseEffect(), this.openConfirmModal()
            } else FF.SoundMgr.playNgEffect(), FF.router.loading.unlock()
        },
        onClickDecide: function() {
            FF.router.loading.lock(), this.offBackEvent();
            var e = this,
                n = this.baseModel.get("id"),
                r = this.materialModel.get("id"),
                s = null;
            i.EquipmentEvolveDeferred({
                src_user_equipment_id: n,
                material_user_equipment_id: r,
                exec: 1
            }).then(function(e) {
                return s = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return a.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                e.showAnimation(s)
            })
        },
        onClickLabelSwitcher: function() {
            this._isShowingLv ? (t("#btnLabelLv").removeClass(y.HIDE_CLASS_NAME), t("#btnLabelHammer").addClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="level"]').addClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="hammer"]').removeClass(y.HIDE_CLASS_NAME)) : (t("#btnLabelLv").addClass(y.HIDE_CLASS_NAME), t("#btnLabelHammer").removeClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="level"]').removeClass(y.HIDE_CLASS_NAME), t('[data-app-label-name="hammer"]').addClass(y.HIDE_CLASS_NAME)), this._isShowingLv = !this._isShowingLv, FF.datastore.stash.isShowingLv = this._isShowingLv
        },
        showAnimation: function(e) {
            var t = this;
            kickmotor.googleanalytics.sendScreenName(u.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.EquipEvolutionAnimation), this.fusionController = new h({
                dataMap: e,
                baseModel: this.baseModel,
                type: "result_evolution"
            }), this.modalEvolutionConfirmView.end(!0), this.fusionController.loadViewDeferred(), this.listenToOnce(this.fusionController, "closeAnimation", function() {
                t.updatePage(e), t.onBackEvent()
            })
        },
        updatePage: function(e) {
            this.updateGil(e.current_gil), this.updateBaseModel(e)
        },
        updateGil: function(e) {
            FF.datastore.userModel.set("gil", e)
        },
        updateBaseModel: function(e) {
            FF.logger.debug("evolutionDataMap", e);
            var t = e.new_src_user_equipment,
                n = this.materialModel.get("id");
            this.baseModel.set(t), this.equipCollection.remove(n), FF.datastore.itemPossessionLimitCollection.update(e.item_possession_limits), this.backPage()
        },
        backPage: function() {
            var e = this.baseModel.get("equipment_type"),
                t = "#party/evolution",
                r = t + "/" + e;
            n.history.navigate(r, {
                trigger: !0
            })
        },
        onClickBaseChange: function() {
            window.history.back()
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.modalEvolutionConfirmView && this.modalEvolutionConfirmView.end(), this.fusionController && this.fusionController.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), v.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/GrowEgg", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "templates/party/GrowEgg", "templates/party/views/BuddyGrowEggList", "templates/party/views/PartyGrowEggList", "./Page", "../views/ModalCharacterDetail", "components/FreeScroll", "components/Scrollbar", "components/Button", "components/Carousel", "components/Indicator", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = e.extend({}, i, {
        SORT_MODULE_KEY: "grow_egg"
    });
    return a.extend({
        categoryType: "enhancement",
        currentBuddy: undefined,
        contentType: "NO_STATUS",
        designType: "MODERN",
        funcTutorialKey: "GROWEGG",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump [data-app-buddylist-buddy-id]": "onClickListItem",
            "anchorsbeforejump [data-app-partylist-buddy-id]": "onClickListItem",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-can-show-detail-party]": "onLongTapCharaDetailView",
            "anchorslongtap [data-app-can-show-detail-buddy]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            a.prototype.initialize.call(this, e), this.isInDungeon = this.isInDungeon(), this.currentPageIndex = +e.args, this.currentPageIndex === void 0 && (this.currentPageIndex = FF.datastore.partyCollection.getCurrentDeckNo() - 1), this.changeCurrentPartyModelTo(this.currentPageIndex), this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), v.resetSceneScopeStatus(m.SORT_MODULE_KEY), this._sortOptions = v.getDefaultSortOptions(m.SORT_MODULE_KEY)
        },
        render: function() {
            a.prototype.render.call(this, s, {
                isInDungeon: this.isInDungeon
            }), this.renderBuddyList(this._sortOptions), this.setupComponents(), this._updateSortOptionButtonFace(this._sortOptions), this.renderPartyList(), this.processAfterRender(), this.isInDungeon && this.setMainPartyFrame()
        },
        setMainPartyFrame: function() {
            t('[data-app-party-list-index="' + this.currentPartyNum + '"]').closest("li").addClass("main-party-frame")
        },
        changeCurrentPartyModelTo: function(e) {
            var t = e + 1;
            this.currentPartyNum = t, this.currentPartyModel = FF.datastore.partyModel
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickOpenSortModal: function() {
            v.openModalDeferred(m.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderPartyList(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        emptyBuddyList: function() {
            this.buddyList && this.buddyList.dispose()
        },
        renderBuddyList: function(e) {
            e = e || {};
            var n = FF.datastore.buddyCollection;
            n.changeComparator(e), n.sort(), this.buddyList && this.buddyList.dispose(), t("[data-app-buddy-list]").html(o({
                el: t("[data-app-buddy-list]"),
                buddies: this.currentPartyModel.getBuddyModelsOutOfParty()
            })), this.scrollbar && this.scrollbar.updateContent()
        },
        renderPartyList: function() {
            var e = this.currentPartyModel;
            t("[data-app-party-list-index]").empty(), t('[data-app-party-list-index="' + this.currentPartyNum + '"]').html(u({
                isInDungeon: this.isInDungeon,
                party: e.getBuddyModels()
            }))
        },
        setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        addEventListener: function() {
            var e = this;
            this.listenTo(this.carousel, "scrollchange", function(t) {
                e.onScrollChange(t)
            }).listenTo(this.carousel, "moveTo", function(t) {
                e.onMoveTo(t)
            }).listenTo(this.carousel, "moved", function(t) {
                e.onMoved(t)
            })
        },
        onScrollChange: function(e) {
            FF.router.loading.lock(), this.currentData = e, this.changeCurrentPartyModelTo(e.index), this.renderPartyList()
        },
        onMoveTo: function(e) {
            this.emptyBuddyList(), this.renderBuddyList(this._sortOptions), this.carousel && this.carousel.lock(), FF.router.loading.lock()
        },
        onMoved: function() {
            this.updateArrowState(this.currentData), this.carousel && this.carousel.unlock(), FF.router.loading.unlock()
        },
        updateCarouselState: function() {
            this.carousel && this.carousel[this.currentPartyModel.getIsPartyEmpty() ? "lock" : "unlock"]()
        },
        updateArrowState: function(e) {
            this.btnPrev[e.isFirst ? "disable" : "enable"](), this.btnNext[e.isLast ? "disable" : "enable"]()
        },
        onClickListItem: function(e) {
            if (this.hasOpenedModal()) return;
            var r = t(e.currentTarget);
            if (r.hasClass("is-sortie")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.datastore.stash.growEggCurrentPageIndex = this.currentPartyNum - 1, this.blurSelectorOrder();
            var i = +r.attr("data-app-buddylist-buddy-id");
            i || (i = +r.attr("data-app-partylist-buddy-id"));
            var s = "#party/grow_egg_selected/" + i;
            n.history.navigate(s, {
                trigger: !0
            }), FF.SoundMgr.playChooseEffect()
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        openCharacterDetail: function(e) {
            var t = FF.datastore.buddyCollection.get(e);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(t)
                }
            })
        },
        onLongTapCharaDetailView: function(e) {
            this.blurSelectorOrder();
            var n = t(e.target).closest("[data-app-partylist-buddy-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-buddylist-buddy-id]"), r = n.attr("data-app-buddylist-buddy-id")) : r = n.attr("data-app-partylist-buddy-id"), this.freescroll.cancelScroll(), this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.btnPrev && this.btnPrev.dispose(), this.btnNext && this.btnNext.dispose(), this.carousel && this.carousel.dispose(), this.indicator && this.indicator.dispose();
            var e = FF.datastore.buddyCollection;
            e.changeComparator("default"), e.sort(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/GrowEggRecommend", ["jquery", "underscore", "backbone", "lib/ClassBase", "./SpMaterialRecommendWorker"], function(e, t, n, r, i) {
    return r.extend({
        recommend: function(e, t) {
            var n = new i(e, null, t);
            return this._useGreedily(n), n.getId2UsedNum()
        },
        _useGreedily: function(e) {
            var t = 9999;
            e.selectTopMaterial();
            var n = 0;
            while (e.isExpRemaining() && e.isMaterialRemaining() && e.isSelectedMaterialAvailable()) {
                var r = e.useOneIfNotOverExp();
                r || (e.isLowerMaterialsExpNotEnough() && e.isSelectedMaterialRemaining() ? e.useOne() : e.selectNextUpperMaterial());
                if (++n > t) throw new Error("Very Greedy.")
            }
        }
    })
}), define("scenes/party/views/ModalGrowEggDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalGrowEggDetail"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-sell-material]": "onClickSell",
            "anchorsbeforejump [data-app-decide-to-sell]": "onClickDecideToSell",
            "change [data-app-selector-num]": "onChangeNum"
        },
        render: function(e) {
            var t = s({
                model: e,
                isConfirm: !1
            });
            this.putContent(t)
        },
        onClickModalClose: function() {
            this.end()
        },
        onClickSell: function() {
            this.trigger("onClickSell")
        },
        onClickDecideToSell: function() {
            this.trigger("onClickDecideToSell")
        },
        onChangeNum: function() {
            var e = +t("[data-app-selector-num] :selected").text();
            this.trigger("onChangeNum", this.inventoryModel, e)
        },
        dispose: function() {
            this.inventoryModel = null, i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalGrowEggUseConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalGrowEggUseConfirm", "components/Counter", "components/Meter"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-modal-cancel]": "onClickModalCancel",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "change [data-app-selector-num]": "onChangeNum"
        },
        initialize: function(e) {
            e = e || {}, this.isLocked = !1, this.buddyModel = e.buddyModel, this.originalLv = this.buddyModel.get("level"), this.totalGainExp = e.totalGainExp, this.overExp = e.overExp, this.selectedGrowEggModels = e.selectedGrowEggModels, this.selectedGrowEggMaps = e.selectedGrowEggMaps, this.changedStatus = e.changedStatus, this.buddyLevelUpAmount = this.changedStatus.level - this.buddyModel.get("level"), this.originalBuddyExpPercent = e.originalBuddyExpPercent, this.afterBuddyExpPercent = e.changedBuddyExpPercent, this.counterList = this.getCounterListArray()
        },
        getCounterListArray: function() {
            var e = [],
                t = 0,
                n = this.buddyLevelUpAmount,
                r = 100,
                i, s;
            for (; t <= n; t++) {
                if (this.isChangedLvMax() && t === n) break;
                i = t === 0 ? this.originalBuddyExpPercent : r, s = t === n ? r - this.afterBuddyExpPercent : 0, e.push({
                    max: r,
                    from: i,
                    to: s
                })
            }
            return e
        },
        render: function() {
            var e = s({
                buddyModel: this.buddyModel,
                changedStatus: this.changedStatus,
                selectedGrowEggModels: this.selectedGrowEggModels,
                selectedGrowEggMaps: this.selectedGrowEggMaps,
                totalGainExp: this.totalGainExp,
                overExp: this.overExp,
                isConfirm: !0,
                afterBuddyExpPercent: this.afterBuddyExpPercent,
                originalBuddyExpPercent: this.originalBuddyExpPercent
            });
            this.putContent(e)
        },
        resultRender: function() {
            var e = this,
                t = s({
                    buddyModel: this.buddyModel,
                    changedStatus: this.changedStatus,
                    selectedGrowEggModels: this.selectedGrowEggModels,
                    selectedGrowEggMaps: this.selectedGrowEggMaps,
                    totalGainExp: this.totalGainExp,
                    overExp: this.overExp,
                    isConfirm: !1,
                    buddyLevelUpAmount: this.buddyLevelUpAmount,
                    afterBuddyExpPercent: this.afterBuddyExpPercent,
                    originalBuddyExpPercent: this.originalBuddyExpPercent
                });
            this.putContent(t), FF.env.isIOS6_x() || FF.env.isAndroid2_x() ? e.staticResult() : this.listenToOnce(this, "openAnimationEnd", function() {
                e.animateResult()
            })
        },
        animateResult: function() {
            var e = this;
            this.counter = new o({
                el: t("[data-ui-counter]"),
                parent: this,
                list: this.counterList
            }), this.meter = new u({
                el: t("[data-ui-meter]"),
                max: 100,
                reverse: !0
            }), FF.SoundMgr.playEffect("se_battle_common_101054", {
                loop: !0
            }), this.listenTo(this.counter, "countchange", function(t) {
                e.meter.changeTo(t.to)
            }).listenTo(this.counter, "countnext", function(t) {
                e.meter.reset(t.max)
            }).listenTo(this.counter, "countmax", function() {
                (!this.isChangedLvMax() || !this.isChangedLvJustBeforeMaxLv()) && t("[data-app-gauge-old]").remove(), FF.SoundMgr.stopEffect(), FF.SoundMgr.playEffect("se_battle_common_101054", {
                    loop: !0
                }), FF.SoundMgr.playEffect("se_battle_common_101058"), t(".scene-modal-grow-egg").addClass("anim-grow-egg-lvup"), e.counter.startNextCount()
            }).listenTo(this.counter, "countend", function() {
                FF.SoundMgr.stopEffect(), this.isChangedLvMax() && this.isChangedLvJustBeforeMaxLv() && (FF.SoundMgr.playEffect("se_battle_common_101058"), t(".scene-modal-grow-egg").addClass("anim-grow-egg-lvup"))
            }.bind(this))
        },
        staticResult: function() {
            t("[data-ui-meter]").width(this.afterBuddyExpPercent + "%"), t(".scene-modal-grow-egg").addClass("static-grow-egg-lvup")
        },
        isChangedLvMax: function() {
            var e = this.buddyModel.get("level_max");
            return this.changedStatus.level === e
        },
        isChangedLvJustBeforeMaxLv: function() {
            var e = this.buddyModel.get("level_max");
            return e === this.originalLv + 1
        },
        onClickModalClose: function() {
            FF.SoundMgr.stopEffect(), this.end(!0), this.trigger("resultAnimFinish")
        },
        onClickModalCancel: function() {
            if (this.isLocked) return;
            this.isLocked = !0, this.end()
        },
        onClickDecide: function() {
            if (this.isLocked) return;
            this.isLocked = !0, this.trigger("onClickDecide")
        },
        onChangeNum: function() {
            var e = +t("[data-app-selector-num] :selected").text();
            this.trigger("onChangeNum", this.inventoryModel, e)
        },
        dispose: function() {
            this.counter && this.counter.dispose(), this.meter && this.meter.dispose(), this.inventoryModel = null, i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/GrowEggSelected", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/helper/MissionHelper", "scenes/party/Api", "scenes/common/helper/GrowEggRecommend", "templates/party/GrowEggSelected", "templates/party/views/GrowEggSelectedBuddyStatus", "templates/party/views/GrowEggSelectList", "scenes/party/views/ModalGrowEggDetail", "scenes/party/views/ModalGrowEggUseConfirm", "scenes/party/pages/Page", "components/Button", "components/FreeScroll", "components/QuantitySelector", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    var g = {
        ACHIEVE_TYPE_NAMES: ["BUDDY_LEVEL"]
    };
    return h.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        _quantitySelectors: [],
        _id2QuantitySelector: [],
        events: {
            "anchorsbeforejump [data-app-buddy-detail]": "onClickSelectBuddy",
            "anchorsbeforejump [data-app-decide]": "renderConfirmModal",
            "anchorsbeforejump [data-app-grow-egg-recommend]": "onClickGrowEggRecommend",
            "anchorslongtap [data-app-grow-egg-img]": "onLongTapGrowEggDetail"
        },
        initialize: function(e) {
            var t = e.args[0];
            this.partyModel = FF.datastore.partyModel, this.buddyCollection = FF.datastore.buddyCollection, this.buddyModel = this.buddyCollection.get(t), this.growEggCollection = FF.datastore.growEggCollection, this.isLocked = !1, this.hasLongTap = !1, this.buddyLevelToExpMaps = {}, this.selectedGrowEggMaps = {}, this.isRecommendUsed = !1, h.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                r = this.buddyModel.get("buddy_id");
            return s.getBuddyLevelToExpMapDeferred({
                buddy_id: r
            }).then(function(e) {
                this.buddyLevelToExpMaps[r] = e.buddy_level_to_exp_map, n.resolve()
            }.bind(this)), n.promise()
        },
        render: function(e) {
            h.prototype.render.call(this, u, {
                party: this.partyModel.getBuddyModels(),
                buddy: this.buddyModel,
                inParty: this.partyModel.isBuddyModelInParty(this.buddyModel)
            }), this.renderSelectedBuddyStatus(), this.renderGrowEggList(), this.setupComponents(), this.listenToComponents(), this.toggleVisibleClassFluctuatorBtn(), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            h.prototype.processAfterContentLoad.call(this), i.openModalMissionClearIfNeedDeferred()
        },
        renderSelectedBuddyStatus: function() {
            var e = this.buddyModel.get("level") + 1,
                n = this.buddyModel.get("exp"),
                i = this.getRestExpToNextLv(),
                s = this.getProgressRate({
                    targetLv: e,
                    initialExp: n
                }),
                o = r.process(a, {
                    buddy: this.buddyModel,
                    isLvUpped: !1,
                    changedLv: 0,
                    totalGainExp: 0,
                    overExp: 0,
                    restExpToNextLv: i,
                    progressRateToNextLv: s,
                    progressRateToChangedLv: 0
                });
            t("[data-app-buddy-status]").html(o)
        },
        renderBuddyStatusByData: function(e) {
            var n = this.buddyModel.get("level") + 1,
                i = this.buddyModel.get("level") < e.changedLv,
                s = this.buddyModel.get("exp"),
                o = this.getProgressRate({
                    targetLv: n,
                    initialExp: s
                }),
                u = this.getTotalGainExp(),
                f = this._getRestExpToMaxLv(),
                l = u > f ? u - f : 0,
                c = r.process(a, {
                    buddy: this.buddyModel,
                    isLvUpped: i,
                    changedLv: e.changedLv,
                    totalGainExp: this.getTotalGainExp(),
                    overExp: l,
                    restExpToNextLv: e.restExp,
                    progressRateToNextLv: o,
                    progressRateToChangedLv: e.progressRateToChangedLv
                });
            t("[data-app-buddy-status]").html(c)
        },
        renderGrowEggList: function() {
            var e = this.growEggCollection.filter(function(e) {
                    return e.get("num") > 0
                }),
                n = r.process(f, {
                    growEggModels: e,
                    buddy: this.buddyModel
                });
            t("[data-app-list-items]").html(n)
        },
        renderConfirmModal: function() {
            if (this.isLocked) return;
            this.isLocked = !0, this.getGrowthBuddyDataDeferred(this.buddyModel, {
                exec: 0
            }).then(function(t) {
                var n = t.buddy.level + 1,
                    r = t.buddy.exp,
                    i = this.getProgressRate({
                        targetLv: n,
                        initialExp: r
                    }),
                    s = this.getProgressRate({
                        targetLv: this.buddyModel.get("level") + 1,
                        initialExp: this.buddyModel.get("exp")
                    }),
                    o = this.getTotalGainExp(),
                    u = this._getRestExpToMaxLv(),
                    a = o > u ? o - u : 0,
                    f = [];
                e.each(this.selectedGrowEggMaps, function(e, t) {
                    f.push(this.growEggCollection.get(t))
                }.bind(this)), this.modalGrowEggUseConfirmView = new c({
                    buddyModel: this.buddyModel,
                    changedStatus: t.buddy,
                    changedBuddyExpPercent: i,
                    originalBuddyExpPercent: s,
                    totalGainExp: o,
                    overExp: a,
                    selectedGrowEggModels: f,
                    selectedGrowEggMaps: this.selectedGrowEggMaps
                }), this.modalGrowEggUseConfirmView.render(), FF.router.overlay.registerChildren(this.modalGrowEggUseConfirmView), this.modalGrowEggUseConfirmView.open(), this.listenToOnce(this.modalGrowEggUseConfirmView, "onClickDecide", this.renderResultModal), this.isLocked = !1
            }.bind(this))
        },
        renderResultModal: function() {
            FF.router.loading.lock(), this.offBackEvent();
            var e = null;
            this._closeModalGrowEggUseConfirmDeferred().then(this.getGrowthBuddyDataDeferred.bind(this, this.buddyModel, {
                exec: 1
            })).then(function(n) {
                return e = n || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return i.saveAchievedMissionsDeferred(e.achieved_missions)
            }).then(function() {
                this.modalGrowEggUseConfirmView.resultRender(), this.modalGrowEggUseConfirmView.open(), this.updateBaseModel(e.buddy), this.updateGrowEggCollection(), this.listenToOnce(this.modalGrowEggUseConfirmView, "resultAnimFinish", this.updatePage)
            }.bind(this))
        },
        _closeModalGrowEggUseConfirmDeferred: function() {
            var e = t.Deferred();
            return this.modalGrowEggUseConfirmView.close(!0), t("[data-app-modal]").one("webkitTransitionEnd", function() {
                e.resolve()
            }), e.promise()
        },
        openGrowEggDetailModal: function(e) {
            var t = e.attr("data-app-grow-egg-id");
            if (!t) {
                this.hasLongTap = !1;
                return
            }
            FF.SoundMgr.playChooseEffect();
            var n = this.growEggCollection.get(t);
            this.modalGrowEggDetailView = new l, this.modalGrowEggDetailView.render(n), FF.router.overlay.registerChildren(this.modalGrowEggDetailView), this.modalGrowEggDetailView.open(), this.listenToOnce(this.modalGrowEggDetailView, "growEggDetailModalClose", function() {
                this.hasLongTap = !1
            }.bind(this))
        },
        toggleVisibleClassFluctuatorBtn: function(e) {
            var n = e ? e.changedLv === this.buddyModel.get("level_max") : !1;
            this.buddyModel.isMaxLv() ? t("[data-ui-fluctuator] .button").addClass("is-disable") : n ? (t("[data-ui-fluctuator-increase] .button").addClass("is-disable"), this.toggleDecreaseBtn()) : (this.toggleIncreaseBtn(), this.toggleDecreaseBtn())
        },
        toggleIncreaseBtn: function() {
            var n = t("[data-ui-fluctuator-increase]");
            e.each(n, function(e) {
                var n = t(e).closest("[data-ui-fluctuator]").find("[data-ui-fluctuator-input]"),
                    r = +n.val(),
                    i = +n.attr("data-ui-fluctuator-max");
                r === i ? t(e).find(".button").addClass("is-disable") : t(e).find(".button").removeClass("is-disable")
            })
        },
        toggleDecreaseBtn: function() {
            var n = t("[data-ui-fluctuator-decrease]");
            e.each(n, function(e) {
                var n = t(e).closest("[data-ui-fluctuator]").find("[data-ui-fluctuator-input]"),
                    r = +n.val();
                r ? t(e).find(".button").removeClass("is-disable") : t(e).find(".button").addClass("is-disable")
            })
        },
        disableInCreaseBtnsIfMaxLv: function(e) {
            e || t("[data-ui-fluctuator-increase] .button").addClass("is-disable")
        },
        showBtnContainer: function() {
            t("[data-app-button-container]").find("[data-app-clear], [data-app-decide]").removeClass("is-disable")
        },
        hideBtnContainer: function() {
            t("[data-app-button-container]").find("[data-app-clear], [data-app-decide]").addClass("is-disable")
        },
        setupComponents: function() {
            this.setupQuantitySelector(), this.freescroll = new d({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new m({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        listenToComponents: function() {
            var e = this;
            this.listenTo(this.freescroll, "scrollchange", function() {
                e.trigger("scrollchange")
            })
        },
        setupQuantitySelector: function() {
            var n = this,
                r = t("[data-ui-fluctuator]");
            e.each(r, function(e) {
                var t = n._constructQuantitySelector(e);
                n._quantitySelectors.push(t)
            }), this._initClearSelectionButton(this._quantitySelectors)
        },
        _constructQuantitySelector: function(e) {
            var n = t(e).find("[data-ui-fluctuator-input]"),
                r = +n.attr("data-app-fluctuator-grow-egg-id"),
                i = this,
                s = new v({
                    el: e,
                    autoViewUpdate: !1,
                    onIncrease: function(e) {
                        i._onQuantityUpdate(r, e)
                    },
                    onDecrease: function(e) {
                        i._onQuantityUpdate(r, e)
                    },
                    onMaximize: function(e) {
                        i._maximizeEggSelect(r, e)
                    }
                });
            return this._id2QuantitySelector[r] = s, s
        },
        _onQuantityUpdate: function(e, t, n) {
            var r = n !== void 0 ? n : !0,
                i = t.getValue();
            this.updateSelectedGrowEggMaps(i, e);
            var s = this.getResultDataMap();
            this.processByGrowEggNumberChange(s);
            var o = s.isChangedLvMax;
            o ? (t.updateFluctuatorView(), this._disableAllIncreaseButton(), this._disableAllMaximizeButton()) : this._updateAllFluctuatorsView(), r && FF.SoundMgr.playChooseEffect()
        },
        _updateAllFluctuatorsView: function() {
            e.each(this._quantitySelectors, function(e) {
                e.updateFluctuatorView()
            })
        },
        _disableAllIncreaseButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setIncreaseButtonEnabled(!1)
            })
        },
        _disableAllMaximizeButton: function() {
            e.each(this._quantitySelectors, function(e) {
                e.setMaximizeButtonEnabled(!1)
            })
        },
        _initClearSelectionButton: function(e) {
            this.clearBtn = new p({
                el: t("[data-app-clear-wrap]")
            });
            var n = this;
            this.clearBtn.listenTo(this.clearBtn, "message", function(t) {
                n._clearAllSelect(e)
            })
        },
        _clearAllSelect: function(t) {
            this._resetSelectedNum();
            var n = this.getResultDataMap();
            this.processByGrowEggNumberChange(n), e.each(t, function(e) {
                e.resetValue(), e.updateFluctuatorView()
            })
        },
        _resetSelectedNum: function() {
            this.selectedGrowEggMaps = {}, this.isRecommendUsed = !1
        },
        _clearSelectByEggId: function(e) {
            this.updateSelectedGrowEggMaps(0, e);
            var t = this.getResultDataMap();
            this.processByGrowEggNumberChange(t);
            var n = this._id2QuantitySelector[e];
            n.resetValue(), n.updateFluctuatorView()
        },
        resetQuantitySelector: function() {
            e.each(this._quantitySelectors, function(e) {
                e.dispose()
            }), this._quantitySelectors.length = 0, this._id2QuantitySelector = {}
        },
        updateSelectedGrowEggMaps: function(e, t) {
            this.selectedGrowEggMaps[t] = e, this.selectedGrowEggMaps[t] === 0 && delete this.selectedGrowEggMaps[t]
        },
        processByGrowEggNumberChange: function(t) {
            var n = e.isEmpty(this.selectedGrowEggMaps);
            n ? this.hideBtnContainer() : this.showBtnContainer();
            var r = this.getTotalGainExp();
            this.setTotalGainExp(r), this.toggleIncreaseBtn(), this.disableInCreaseBtnsIfMaxLv(t.totalExpOfNextLv), this.renderBuddyStatusByData(t)
        },
        updateBaseModel: function(e) {
            this.buddyModel.set(e)
        },
        updateGrowEggCollection: function() {
            e.each(this.selectedGrowEggMaps, function(e, t) {
                var n = this.growEggCollection.get(t),
                    r = n.get("num") - e;
                n.set("num", r), n.get("num") === 0 && this.growEggCollection.remove(n)
            }.bind(this)), this._resetSelectedNum(), FF.datastore.growEggCollection = this.growEggCollection
        },
        updatePage: function() {
            this.hideBtnContainer(), this.renderGrowEggList(), this.renderSelectedBuddyStatus(), this.toggleVisibleClassFluctuatorBtn(), this.resetQuantitySelector(), this.setupQuantitySelector(), this.freescroll.updateContent(), this.scrollbar.updateContent(), FF.router.loading.hide(), i.openModalMissionClearIfNeedDeferred(), this.onBackEvent()
        },
        getRestExpToNextLv: function() {
            if (this.buddyModel.isMaxLv()) return 0;
            var e = this.buddyModel.get("buddy_id"),
                t = this.buddyLevelToExpMaps[e],
                n = t[this.buddyModel.get("level") + 1],
                r = this.buddyModel.get("exp");
            return n - r
        },
        _getRestExpToMaxLv: function() {
            if (this.buddyModel.isMaxLv()) return 0;
            var e = this.buddyModel.get("buddy_id"),
                t = this.buddyModel.get("level_max"),
                n = this.buddyModel.get("exp"),
                r = this.buddyLevelToExpMaps[e][t];
            return r - n
        },
        getProgressRate: function(e) {
            if (this.buddyModel.isMaxLv()) return 0;
            var t = this.buddyModel.get("buddy_id"),
                n = this.buddyLevelToExpMaps[t],
                r = n[e.targetLv];
            if (!r) return 100;
            var i = n[e.targetLv - 1];
            return Math.floor((e.initialExp - i) / (r - i) * 100)
        },
        getTotalGainExp: function() {
            var t = this,
                n = 0;
            return e.each(this.selectedGrowEggMaps, function(e, r) {
                n += t.growEggCollection.get(r).get("exp") * e
            }), n
        },
        getResultDataMap: function() {
            var e = this.buddyModel.get("level"),
                n = this.buddyModel.get("level") + 1,
                r = this.buddyModel.get("level_max"),
                i = this.buddyModel.get("buddy_id"),
                s = 0,
                o = this.getTotalGainExp() + this.buddyModel.get("exp"),
                u = this.buddyLevelToExpMaps[i][n],
                a = 0,
                f = t("[data-ui-fluctuator-increase] .button"),
                l = !1;
            while (o - u >= 0) {
                n += 1, e += 1, u = e === r ? 0 : this.buddyLevelToExpMaps[i][n];
                if (!u || e === r) break
            }
            return u ? (s = u - o, a = this.getProgressRate({
                targetLv: n,
                initialExp: o
            })) : a = 100, l = e === r, {
                restExp: s,
                changedLv: e,
                isChangedLvMax: l,
                progressRateToChangedLv: a,
                totalExpOfNextLv: u
            }
        },
        setTotalGainExp: function(e) {
            t("[data-app-growth-num]").html(e)
        },
        getBuddyLevelToExpMapDeferredIfNeed: function() {
            var e = t.Deferred(),
                n = this.buddyModel.get("buddy_id");
            return this.buddyLevelToExpMaps[n] ? e.resolve() : s.getBuddyLevelToExpMapDeferred({
                buddy_id: n
            }).then(function(t) {
                this.buddyLevelToExpMaps[n] = t.buddy_level_to_exp_map, e.resolve()
            }.bind(this)), e.promise()
        },
        getGrowthBuddyDataDeferred: function(e, n) {
            var r = t.Deferred();
            return s.useGrowEggDeferred({
                user_buddy_id: e.id,
                grow_egg_id_2_num: this.selectedGrowEggMaps,
                is_recommend_used: this.isRecommendUsed ? 1 : 0,
                current_exp: e.get("exp"),
                exec: n.exec
            }).then(function(e) {
                r.resolve(e)
            }), r.promise()
        },
        onClickSelectBuddy: function(e) {
            var n = t(e.target);
            if (n.hasClass("is-current")) return;
            FF.router.loading.lock(), this.toggleClass(n, "is-current");
            var r = +n.closest("[data-app-buddy-detail]").attr("data-app-buddy-detail");
            this.buddyModel = this.buddyCollection.get(r), this.getBuddyLevelToExpMapDeferredIfNeed().then(function() {
                this._resetSelectedNum(), this.updatePage()
            }.bind(this))
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        onLongTapGrowEggDetail: function(e) {
            var n = t(e.target).closest("[data-app-grow-egg-img]");
            this.hasLongTap = !0, this.openGrowEggDetailModal(n)
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("party/grow_egg/" + FF.datastore.stash.growEggCurrentPageIndex, {
                trigger: !0
            })
        },
        onClickGrowEggRecommend: function() {
            if (this.buddyModel.isMaxLv()) return;
            var e = this.growEggCollection.filter(function(e) {
                return e.get("num") > 0
            });
            if (e.length === 0) return;
            this._clearAllSelect(this._quantitySelectors), this._recommendGrowEggs(e)
        },
        _maximizeEggSelect: function(e, t) {
            var n = this.growEggCollection.filter(function(t) {
                return t.get("num") > 0 && t.get("id") === e
            });
            this._clearSelectByEggId(e), this._recommendGrowEggs(n), t.isMax() && t.setMaximizeButtonEnabled(!1)
        },
        _recommendGrowEggs: function(e) {
            var t = new o,
                n = this._getRestExpToMaxLv() - this.getTotalGainExp(),
                r = t.recommend(e, n);
            if (!r) return;
            this.isRecommendUsed = !0, this._applyRecommendation(r)
        },
        _applyRecommendation: function(t) {
            var n = this;
            e.each(t, function(e, t) {
                var r = n._id2QuantitySelector[t];
                r.setValue(e), r.updateFluctuatorView(), n._onQuantityUpdate(t, r, !1)
            }), FF.SoundMgr.playChooseEffect()
        },
        dispose: function() {
            this.resetQuantitySelector(), this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.clearBtn && this.clearBtn.dispose(), this.modalGrowEggDetailView && this.modalGrowEggDetailView.end(), this.modalGrowEggUseConfirmView && this.modalGrowEggUseConfirmView.end(), h.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddyEquipmentList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/BuddyEquipmentList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/BuddyEquipment", ["underscore", "jquery", "backbone", "util", "components/SlideIn", "scenes/party/Api", "scenes/party/views/ViewBase", "scenes/party/views/BuddyEquipmentList", "templates/party/views/BuddyEquipment"], function(e, t, n, r, i, s, o, u, a) {
    var f = {
        HIDE_CLASS_NAME: "di-n",
        FC_UP_CLASS_NAME: "fc-up",
        FC_DOWN_CLASS_NAME: "fc-down",
        RECOMMENDED_CLASS_NAME: "is-recommended"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-equip-remove]": "onClickEquipRemove",
            "anchorsbeforejump [data-app-equip-recommend]": "onClickEquipRecommend",
            "anchorsbeforejump #cancelBtn": "onClickCancel",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump [data-app-buddy-equip]": "onClickEquipChange"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.isShowingDecideBtn = !1, this.hasClickedEquipmentRemove = !1, this.buddy = e.buddyModel, this.buddyId = this.buddy.get("id"), this.recommendedWeaponModel = void 0, this.recommendedArmorModel = void 0, this.recommendedAccessoryModel = void 0, this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.unlock("isRecommended")
        },
        render: function(e) {
            e = e || {}, this._statusBonusOpt = e.statusBonusOpt || FF.resonator.getResonantStatusBonusOpt(), o.prototype.render.call(this, a, {
                party: FF.datastore.partyModel.getBuddyModels(),
                buddy: this.buddy,
                inParty: FF.datastore.partyModel.isBuddyModelInParty(this.buddy),
                statusBonusOpt: this._statusBonusOpt,
                recommendedWeaponModel: this.recommendedWeaponModel,
                recommendedArmorModel: this.recommendedArmorModel,
                recommendedAccessoryModel: this.recommendedAccessoryModel
            }), this.generateComponents(), this.renderEquipmentList(), this._updateStatusHp(), FF.router.toast.bake()
        },
        generateComponents: function() {
            this._slidein && this._slidein.dispose(), this._slidein = new i({
                el: t("[data-ui-slidein]")
            })
        },
        renderEquipmentList: function() {
            this.equipList && this.equipList.dispose(), this.equipList = new u({
                el: t("[data-app-equip-list]")
            });
            var e = this.buddy.getStatusBonusOpt(this._statusBonusOpt);
            this.equipList.render({
                seriesId: e.seriesId,
                hasRoleBonus: e.hasRoleBonus,
                isInDungeon: this.buddy.isInDungeon(),
                tmpEquipmentModelMap: this.buddy.getTmpEquipmentModelMap(),
                recommendedWeaponModel: this.recommendedWeaponModel,
                recommendedArmorModel: this.recommendedArmorModel,
                recommendedAccessoryModel: this.recommendedAccessoryModel
            }), this.switchButtonShowStatus()
        },
        updateStatus: function(n) {
            var i = this,
                s = this.buddy.getStatusBonusOpt(this._statusBonusOpt);
            s.useTmpEquipment = !0, e.each(this.buddy.CONST.EQUIPMENT_PARAMETERS, function(e) {
                var o = "_updateStatus" + r.ucamelize(e);
                if (i[o]) return i[o](n);
                var u = +t("[data-app-status-before-" + e + "]").text(),
                    a = i.buddy.getParamOf(e, s),
                    l = a > u ? f.FC_UP_CLASS_NAME : a < u ? f.FC_DOWN_CLASS_NAME : "";
                u === a ? t("[data-app-status-after-" + e + "]").addClass(f.HIDE_CLASS_NAME).removeClass(f.FC_UP_CLASS_NAME).removeClass(f.FC_DOWN_CLASS_NAME) : t("[data-app-status-after-" + e + "]").removeClass(f.HIDE_CLASS_NAME).addClass(l).text(a)
            })
        },
        _updateStatusHp: function(e) {
            var n = FF.datastore.dungeonSessionModel.isInDungeon(),
                r = n && this.buddy.isInParty();
            if (r) return;
            var i = t("[data-app-status-hp]"),
                s = t("[data-app-status-max-hp]"),
                o = +i.text(),
                u = this.buddy.getStatusBonusOpt(this._statusBonusOpt);
            u.useTmpEquipment = !0;
            var a = this.buddy.getParamOf("hp", u),
                l = a > o ? f.FC_UP_CLASS_NAME : a < o ? f.FC_DOWN_CLASS_NAME : "";
            if (o === a) i.removeClass(f.FC_UP_CLASS_NAME).removeClass(f.FC_DOWN_CLASS_NAME), s.removeClass(f.FC_UP_CLASS_NAME).removeClass(f.FC_DOWN_CLASS_NAME);
            else {
                i.removeClass(f.FC_UP_CLASS_NAME).removeClass(f.FC_DOWN_CLASS_NAME).text(a), s.removeClass(f.FC_UP_CLASS_NAME).removeClass(f.FC_DOWN_CLASS_NAME).text(a);
                if (!e || e.caller !== "onClickCancel") i.addClass(l), s.addClass(l)
            }
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        onClickEquipRemove: function() {
            FF.router.loading.lock(), this.lockFlagManager.lock("isRecommended");
            var n = this,
                r = e.find(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                    return n.buddy.getTmpEquipmentIdByTypeName(e) !== 0
                });
            if (!r) {
                FF.router.toast.topping(t("[data-app-message-already-empty]").text()).bake(), FF.router.loading.unlock();
                return
            }
            e.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(e) {
                n.buddy.setTmpEquipmentId({
                    typeName: e,
                    equipmentId: 0
                })
            }), this.hasClickedEquipmentRemove = !0, this.updateStatus(), this.renderEquipmentList(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.unlock()
            })
        },
        onClickEquipRecommend: function() {
            FF.router.loading.show(), this.lockFlagManager.lock("isRecommended");
            if (!this.recommendedWeaponModel || !this.recommendedArmorModel || !this.recommendedAccessoryModel) this.recommendedWeaponModel = this.buddy.getRecommendedWeaponModel(this._statusBonusOpt), this.recommendedArmorModel = this.buddy.getRecommendedArmorModel(this._statusBonusOpt), this.recommendedAccessoryModel = this.buddy.getRecommendedAccessoryModel(this._statusBonusOpt), this.renderEquipmentList();
            var n = this.buddy.getWeaponId(),
                r = this.buddy.getArmorId(),
                i = this.buddy.getAccessoryId(),
                s = this.recommendedWeaponModel ? this.recommendedWeaponModel.get("id") : 0,
                o = this.recommendedArmorModel ? this.recommendedArmorModel.get("id") : 0,
                u = this.recommendedAccessoryModel ? this.recommendedAccessoryModel.get("id") : 0,
                a = n === s,
                l = r === o,
                c = i === u;
            a || (this.buddy.setTmpWeaponId({
                equipmentId: s,
                isSetByRecommend: !0
            }), t("[data-app-weapon]").addClass(f.RECOMMENDED_CLASS_NAME)), l || (this.buddy.setTmpArmorId({
                equipmentId: o,
                isSetByRecommend: !0
            }), t("[data-app-armor]").addClass(f.RECOMMENDED_CLASS_NAME)), c || (this.buddy.setTmpAccessoryId({
                equipmentId: u,
                isSetByRecommend: !0
            }), t("[data-app-accessory]").addClass(f.RECOMMENDED_CLASS_NAME));
            var h = this.buddy.getRecommendedSoulStrikeIds(),
                p = this.buddy.getTmpSoulStrikeIds(),
                d = e.difference(h, p).length === 0;
            d || this.buddy.setTmpRecommendedSoulStrikeIds();
            if (a && l && c && d) {
                FF.router.toast.topping(t("#toast-message-already-max").text()).bake(), FF.router.loading.hide();
                return
            }
            this.updateStatus(), this.showDecideBtnContainer(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.hide()
            })
        },
        onClickDecide: function(e) {
            if (!FF.router.loading.lock()) return;
            var t = this;
            FF.SoundMgr.playDecideEffect(), this.saveEquipDeferred().then(function() {
                t.listenToOnce(t._slidein, "slide:original", function() {
                    t.render({
                        statusBonusOpt: t._statusBonusOpt
                    }), t.hasClickedEquipmentRemove = !1, FF.router.loading.hide(), t.lockFlagManager.unlock("isRecommended")
                }), t._slidein.back()
            })
        },
        saveEquipDeferred: function() {
            var e = this,
                n = t.Deferred();
            return !this.buddy.hasChangedEquipmentId() && !this.buddy.hasChangedSoulStrikeId() ? n.resolve().promise() : (s.buddySaveEquipmentDeferred(FF.datastore.buddyCollection.getChangedEquipmentAndSoulStrikeInfo(), this.buddy.isSetTmpEquipmentByRecommend).done(function() {
                var r;
                e.buddy.hasChangedEquipmentId() && e.buddy.hasChangedSoulStrikeId() ? r = "#toast-message-equipment-and-soul-strike-onchange" : e.buddy.hasChangedEquipmentId() ? r = "#toast-message-onchange" : r = "#toast-message-soul-strike-onchange", FF.router.toast.eatAll().topping(t(r).text()), FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpSoulStrikes(), n.resolve()
            }), n.promise())
        },
        onClickCancel: function() {
            if (!FF.router.loading.lock()) return;
            var e = this;
            FF.SoundMgr.playChooseEffect(), FF.datastore.resetTmpEquipments(), FF.datastore.resetTmpSoulStrikes(), this.hasClickedEquipmentRemove = !1, this.listenToOnce(this._slidein, "slide:original", function() {
                FF.router.loading.unlock(), e.lockFlagManager.unlock("isRecommended")
            });
            var n = t("." + f.RECOMMENDED_CLASS_NAME).size();
            n ? (t("." + f.RECOMMENDED_CLASS_NAME).removeClass(f.RECOMMENDED_CLASS_NAME), this.switchButtonShowStatus()) : this.renderEquipmentList(), this.updateStatus({
                caller: "onClickCancel"
            })
        },
        switchButtonShowStatus: function() {
            this.buddy.hasChangedEquipmentId() || this.buddy.hasChangedSoulStrikeId() ? this.showDecideBtnContainer() : this.showBtnContainer()
        },
        showBtnContainer: function() {
            this._slidein.back(), this.isShowingDecideBtn = !1
        },
        showDecideBtnContainer: function() {
            this._slidein.slide(), this.isShowingDecideBtn = !0
        },
        onClickEquipChange: function(e) {
            if (this.hasLongTap) return;
            if (this.isShowingDecideBtn) {
                FF.SoundMgr.playNgEffect(), this.trigger("showToastOfMustClickFix");
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.target).attr("data-app-buddy-equip"),
                i = "#party/equipment_change/" + this.buddyId + "/" + r;
            n.history.navigate(i, {
                trigger: !0
            })
        },
        dispose: function() {
            this._slidein && this._slidein.dispose(), this.equipList && this.equipList.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddySoulStrikeList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/BuddySoulStrikeList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/BuddySoulStrike", ["underscore", "jquery", "backbone", "components/SlideIn", "scenes/party/Api", "scenes/party/views/ViewBase", "scenes/party/views/BuddySoulStrikeList", "templates/party/views/BuddySoulStrike"], function(e, t, n, r, i, s, o, u) {
    var a = {
        RECOMMENDED_CLASS_NAME: "is-recommended"
    };
    return s.extend({
        events: {
            "anchorsbeforejump [data-app-soulStrike-edit]": "onClickSoulStrikeChange",
            "anchorsbeforejump [data-app-soulStrike-remove]": "onClickSoulStrikeRemove",
            "anchorsbeforejump [data-app-soulStrike-recommend]": "onClickSoulStrikeRecommend",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump #cancelBtn": "onClickCancel"
        },
        initialize: function(e) {
            this.buddy = e.buddyModel, this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.unlock("isRecommended"), this.recommendedSoulStrikeModels = void 0
        },
        render: function() {
            var e = this.buddy.getTmpSoulStrikeModels();
            s.prototype.render.call(this, u, {
                buddy: this.buddy,
                isInDungeon: this.buddy.isInDungeon(),
                tmpSoulStrikeModels: e,
                recommendedSoulStrikeModels: this.recommendedSoulStrikeModels || []
            }), this.generateComponents(), this.renderSoulStrikeList(), FF.router.loading.hide(), FF.router.toast.bake()
        },
        generateComponents: function() {
            this._slidein && this._slidein.dispose(), this._slidein = new r({
                el: t("[data-ui-slidein]")
            })
        },
        renderSoulStrikeList: function() {
            this.soulStrikeList && this.soulStrikeList.dispose(), this.soulStrikeList = new o({
                el: t("#soulStrikeList")
            }), this.soulStrikeList.render({
                tmpSoulStrikeModels: this.buddy.getTmpSoulStrikeModels(),
                recommendedSoulStrikeModels: this.recommendedSoulStrikeModels || [],
                defaultSoulStrikeId: this.buddy.get("default_soul_strike_id")
            }), this.switchButtonShowStatus()
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        onClickSoulStrikeRemove: function() {
            FF.router.loading.lock(), this.lockFlagManager.lock("isRecommended"), this.buddy.takeOffSoulStrike();
            if (!this.buddy.hasChangedSoulStrikeId()) {
                FF.router.toast.topping(t("[data-app-message-already-empty]").text()).bake(), FF.router.loading.unlock();
                return
            }
            this.renderSoulStrikeList(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.unlock()
            })
        },
        onClickSoulStrikeRecommend: function() {
            var n = this;
            FF.router.loading.show(), this.recommendedSoulStrikeModels || (this.recommendedSoulStrikeModels = this.buddy.getRecommendedSoulStrikeModels(), this.renderSoulStrikeList());
            var r = this.buddy.getTmpSoulStrikeModels(),
                i = e.isEqual(e.compact(r), this.recommendedSoulStrikeModels);
            if (i) {
                FF.router.toast.topping(t("#toast-message-already-max").text()).bake(), FF.router.loading.hide();
                return
            }
            this.lockFlagManager.lock("isRecommended"), this.buddy.setTmpRecommendedSoulStrikeIds(), t("#buddySoulStrikeList").addClass(a.RECOMMENDED_CLASS_NAME), this.showDecideBtnContainer(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.hide()
            })
        },
        onClickDecide: function(e) {
            if (!FF.router.loading.lock()) return;
            var t = this;
            FF.SoundMgr.playDecideEffect(), this.saveSoulStrikeDeferred().then(function() {
                t.listenToOnce(t._slidein, "slide:original", function() {
                    t.lockFlagManager.unlock("isRecommended"), t.render()
                }), t._slidein.back()
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.buddy.hasChangedSoulStrikeId() ? (i.buddySaveSoulStrikeDeferred(FF.datastore.buddyCollection.getChangedSoulStrikeInfo(), this.buddy.isSetTmpEquipmentByRecommend).done(function() {
                FF.router.toast.topping(t("#toast-message-onchange").text()), FF.datastore.fixTmpSoulStrikes(), n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        onDecideTouchMove: function(e) {
            s.prototype.onCommonTouchMove.call(this, e), this.onCommonTouchMove(e)
        },
        onClickCancel: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = this;
            e.preventDefault(), FF.SoundMgr.playChooseEffect(), FF.datastore.resetTmpSoulStrikes(), this.listenToOnce(this._slidein, "slide:original", function() {
                n.lockFlagManager.unlock("isRecommended"), FF.router.loading.unlock()
            });
            var r = t("#buddySoulStrikeList").hasClass(a.RECOMMENDED_CLASS_NAME);
            r ? (t("#buddySoulStrikeList").removeClass(a.RECOMMENDED_CLASS_NAME), this.switchButtonShowStatus()) : this.renderSoulStrikeList()
        },
        switchButtonShowStatus: function() {
            this.buddy.hasChangedSoulStrikeId() ? this.showDecideBtnContainer() : this.showBtnContainer()
        },
        showBtnContainer: function() {
            this._slidein.back(), this.isShowingDecideBtn = !1
        },
        showDecideBtnContainer: function() {
            this._slidein.slide(), this.isShowingDecideBtn = !0
        },
        onClickSoulStrikeChange: function(e) {
            if (this.isShowingDecideBtn) {
                FF.SoundMgr.playNgEffect(), this.trigger("showToastOfMustClickFix");
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var t = "#party/soul_strike_change/" + this.buddy.get("id");
            n.history.navigate(t, {
                trigger: !0
            })
        },
        dispose: function() {
            this.soulStrikeList && this.soulStrikeList.dispose(), this._slidein && this._slidein.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddyAbilityList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/BuddyAbilityList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/BuddyAbility", ["underscore", "jquery", "backbone", "components/SlideIn", "scenes/party/Api", "scenes/party/views/BuddyAbilityList", "scenes/party/views/ViewBase", "templates/party/views/BuddyAbility"], function(e, t, n, r, i, s, o, u) {
    var a = {
        RECOMMENDED_CLASS_NAME: "is-recommended",
        DISABLE_ON_SUBMIT_CLASS_NAME: "mbgaui-disabled"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-buddy-detail]": "onClickSelectBuddy",
            "anchorsbeforejump [data-app-ability-remove]": "onClickAbilityRemove",
            "anchorsbeforejump [data-app-ability-recommend]": "onClickAbilityRecommend",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorsbeforejump #cancelBtn": "onClickCancel",
            "anchorsbeforejump [data-app-edit-ability]": "onClickAbilityChange"
        },
        initialize: function(e) {
            this.isShowingDecideBtn = !1, this.buddy = e.buddyModel, this.buddyId = this.buddy.get("id"), this.recommendedAbilities = void 0, this.lockFlagManager = e.lockFlagManager, this.lockFlagManager.unlock("isRecommended")
        },
        render: function() {
            o.prototype.render.call(this, u, {
                buddy: this.buddy,
                inParty: FF.datastore.partyModel.isBuddyModelInParty(this.buddy),
                abilities: this.buddy.getAbilityModels()
            }), this.generateComponents(), this.renderAbilityList()
        },
        _getRecommendedAbilities: function(e) {
            FF.datastore.abilityCollection.setRecommendedAbilities([e], {
                useBuddyEquippedParam: !0
            });
            var t = e.getTmpAbilityModels();
            return FF.datastore.resetTmpAbilities(), t
        },
        generateComponents: function() {
            this._slidein && (this.stopListening(this._slidein, "slide:original").stopListening(this._slidein, "slide:switched"), this._slidein.dispose()), this._slidein = new r({
                el: t("[data-ui-slidein]")
            }), this.listenTo(this._slidein, "slide:original", function() {
                t("[data-app-ability-remove]").removeClass(a.DISABLE_ON_SUBMIT_CLASS_NAME), t("[data-app-ability-recommend]").removeClass(a.DISABLE_ON_SUBMIT_CLASS_NAME)
            }), this.listenTo(this._slidein, "slide:switched", function() {
                t("#cancelBtn").removeClass(a.DISABLE_ON_SUBMIT_CLASS_NAME)
            })
        },
        renderAbilityList: function() {
            this.abilityList && this.abilityList.dispose(), this.abilityList = new s({
                el: t("[data-app-ability-list]")
            }), this.abilityList.render({
                isInDungeon: this.buddy.isInDungeon(),
                tmpAbilities: this.buddy.getTmpAbilityModels(),
                recommendedAbilities: [this.recommendedAbilities && this.recommendedAbilities[0] ? this.recommendedAbilities[0] : null, this.recommendedAbilities && this.recommendedAbilities[1] ? this.recommendedAbilities[1] : null]
            }), this.switchButtonShowStatus()
        },
        onClickSelectBuddy: function(e) {
            FF.router.loading.lock();
            var n = t(e.target);
            if (n.hasClass("is-active")) {
                FF.router.loading.unlock();
                return
            }
            FF.datastore.resetTmpAbilities(), this.buddyId = +n.closest("[data-app-buddy-detail]").attr("data-app-buddy-detail"), this.buddy = FF.datastore.buddyCollection.get(this.buddyId), this.toggleClass(n, "is-active"), this.updateBuddyStatus(this.buddy), this.render()
        },
        updateBuddyStatus: function(e) {
            t("[data-app-status-name]").html(e.get("name")), t("[data-app-status-level]").html(e.get("level")), t("[data-app-status-job_name]").html(e.get("job_name"))
        },
        updateAbilityCommands: function(n) {
            var r = this;
            e.each(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                var i = t("[data-app-command-ability" + e + "]"),
                    s = n.isChanged ? r.buddy.getTmpAbilityBySlot(e) : r.buddy.getAbilityBySlot(e),
                    o = s ? pUrl(s.get("command_icon_path")) : null,
                    u = s ? s.get("id") : null;
                i.attr("src", o).attr("id", u), s ? i.removeClass("di-n") : i.addClass("di-n")
            })
        },
        toggleClass: function(e, n) {
            t("." + n).removeClass(n), e.addClass(n)
        },
        toastAlreadyChangedMessage: function() {
            FF.router.toast.topping(t("[data-app-message-already-changed]").text()).bake()
        },
        toastAlreadyMaxMessage: function() {
            FF.router.toast.topping(t("[data-app-message-already-max]").text()).bake()
        },
        onClickBack: function() {
            FF.router.loading.lock(), n.history.navigate("party/ability/" + FF.datastore.stash.abilityCurrentPageIndex, {
                trigger: !0
            })
        },
        onClickAbilityRemove: function() {
            FF.router.loading.lock(), this.lockFlagManager.lock("isRecommended");
            var e = this.buddy.getTmpAbilityIdBySlot(1) === 0,
                n = this.buddy.getTmpAbilityIdBySlot(2) === 0;
            if (e && n) {
                FF.router.toast.topping(t("[data-app-message-already-empty]").text()).bake(), FF.router.loading.unlock();
                return
            }
            t("[data-app-ability-recommend]").addClass(a.DISABLE_ON_SUBMIT_CLASS_NAME), this.buddy.setTmpAbilityId({
                slot: 1,
                abilityId: 0
            }), this.buddy.setTmpAbilityId({
                slot: 2,
                abilityId: 0
            }), this.updateBuddyStatus(this.buddy), this.updateAbilityCommands({
                isChanged: !0
            }), this.renderAbilityList(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.unlock()
            })
        },
        onClickAbilityRecommend: function() {
            FF.router.loading.show();
            if (this.buddy.isSetTmpAbilityByRecommend) {
                this.toastAlreadyMaxMessage(), FF.router.loading.hide();
                return
            }
            this.lockFlagManager.lock("isRecommended"), this.recommendedAbilities || (this.recommendedAbilities = this._getRecommendedAbilities(this.buddy), this.renderAbilityList()), t("[data-app-ability-remove]").addClass(a.DISABLE_ON_SUBMIT_CLASS_NAME);
            var e = this.buddy.getTmpAbilityIdBySlot(1),
                n = this.buddy.getTmpAbilityIdBySlot(2),
                r = this.recommendedAbilities[0] ? this.recommendedAbilities[0].get("id") : 0,
                i = this.recommendedAbilities[1] ? this.recommendedAbilities[1].get("id") : 0;
            e !== r && t('[data-app-ability="1"]').addClass(a.RECOMMENDED_CLASS_NAME), n !== i && t('[data-app-ability="2"]').addClass(a.RECOMMENDED_CLASS_NAME);
            if (e === r && n === i) {
                this.toastAlreadyMaxMessage(), t("[data-app-ability-remove]").removeClass(a.DISABLE_ON_SUBMIT_CLASS_NAME), FF.router.loading.hide();
                return
            }
            this.buddy.setTmpAbilityId({
                slot: 1,
                abilityId: r,
                isSetByRecommend: !0
            }), this.buddy.setTmpAbilityId({
                slot: 2,
                abilityId: i,
                isSetByRecommend: !0
            }), this.updateBuddyStatus(this.buddy), this.updateAbilityCommands({
                isChanged: !0
            }), this.switchButtonShowStatus(), this.listenToOnce(this._slidein, "slide:switched", function() {
                FF.router.loading.hide()
            })
        },
        onClickDecide: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = this,
                r = t.Deferred();
            FF.SoundMgr.playDecideEffect(), t("#cancelbutton").addClass(a.DISABLE_ON_SUBMIT_CLASS_NAME);
            if (!this.buddy.hasChangedAbilityId()) return this.onClickCancel(), t(document).one("enableUserTouch", function() {
                n.toastAlreadyChangedMessage()
            }), r.resolve().promise();
            var s = FF.datastore.buddyCollection.getChangedAbilityInfo();
            return i.buddySaveAbilityDeferred(s, this.buddy.isSetTmpAbilityByRecommend).done(function() {
                n._slidein.back(), n.listenToOnce(n._slidein, "slide:original", function() {
                    FF.datastore.fixTmpAbilities(), n.isShowingDecideBtn = !1, FF.router.loading.hide(), FF.router.toast.eatAll().topping(t("[data-app-message-onchange]").text()).bake(), n.lockFlagManager.unlock("isRecommended"), r.resolve()
                }), n.recommendedAbilities = void 0
            }), r.promise()
        },
        onClickCancel: function() {
            if (!FF.router.loading.lock()) return;
            var e = this;
            FF.SoundMgr.playChooseEffect(), t("#decideBtn").addClass(a.DISABLE_ON_SUBMIT_CLASS_NAME), FF.datastore.resetTmpAbilities(), this.listenToOnce(this._slidein, "slide:original", function() {
                FF.router.loading.unlock(), e.lockFlagManager.unlock("isRecommended")
            });
            var n = t("." + a.RECOMMENDED_CLASS_NAME).size();
            n ? (t("." + a.RECOMMENDED_CLASS_NAME).removeClass(a.RECOMMENDED_CLASS_NAME), this.switchButtonShowStatus()) : (this.renderAbilityList(), this.isShowingDecideBtn = !1), this.updateBuddyStatus(this.buddy), this.updateAbilityCommands({
                isChanged: !1
            })
        },
        switchButtonShowStatus: function() {
            this.buddy.hasChangedAbilityId() ? this.showDecideBtnContainer() : this.showBtnContainer()
        },
        showBtnContainer: function() {
            this._slidein.back(), this.isShowingDecideBtn = !1
        },
        showDecideBtnContainer: function() {
            this._slidein.slide(), this.isShowingDecideBtn = !0
        },
        onClickAbilityChange: function(e) {
            if (this.buddy.isInDungeon()) return;
            if (this.isShowingDecideBtn) {
                FF.SoundMgr.playNgEffect(), this.trigger("showToastOfMustClickFix");
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var r = t(e.target).attr("data-app-buddy-ability"),
                i = "#party/ability_change/" + this.buddyId;
            n.history.navigate(i, {
                trigger: !0
            })
        },
        dispose: function() {
            this.abilityList && this.abilityList.dispose(), this._slidein && this._slidein.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/BuddyRecordMateria", ["underscore", "jquery", "backbone", "scenes/party/views/ViewBase", "components/FreeScroll", "components/Scrollbar", "templates/party/views/BuddyRecordMateria"], function(e, t, n, r, i, s, o) {
    return r.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-buddy-record-materia]": "onClickRecordMateriaChange",
            "anchorsbeforejump [data-app-achievement-room]": "onClickAchievementRoom"
        },
        initialize: function(e) {
            this.buddy = e.buddyModel
        },
        render: function(e) {
            var t = this.buddy.get("buddy_id"),
                n = FF.datastore.stash.buddyIdToNextRecordMateriaMap[t];
            r.prototype.render.call(this, o, {
                buddy: this.buddy,
                recordMaterias: this.buddy.getRecordMateriaModels(),
                nextRecordMateriaData: n
            }), this.renderRecordMateriaList()
        },
        renderRecordMateriaList: function() {
            var e = this.buddy.get("evolution_num") > 0,
                n = this.buddy.recordMaterias[0],
                r = n ? '<img src="' + pUrl(n.get("image_path")) + '" width="35" height="35">' : "",
                i = n ? n.get("name") : "",
                s = n ? "block" : "none";
            t("#equippedRecordMateriaImg").html(r).css("display", s), t("#equippedRecordMateriaName").html(i), e ? t("[data-app-buddy-record-materia]").removeClass("is-disable") : t("[data-app-buddy-record-materia]").addClass("is-disable")
        },
        onClickBack: function() {
            n.history.navigate("#party", {
                trigger: !0
            })
        },
        onClickRecordMateriaChange: function(e) {
            if (this.buddy.isInDungeon()) return;
            FF.router.loading.lock();
            var r = this.buddy.get("id"),
                i = t(e.target).attr("data-app-buddy-record-materia"),
                s = "#party/record_materia_change/" + r + "/" + i;
            n.history.navigate(s, {
                trigger: !0
            })
        },
        onClickRecordMateriaList: function() {
            n.history.navigate("#party/record_materia_list", {
                trigger: !0
            })
        },
        onClickAchievementRoom: function() {
            this._partyNavigateParams = FF.router.flash(), this._partyNavigateParams.backFragmentForRecordMateriaList = location.hash, FF.router.navigate("#achievement_room/record_materia", {
                trigger: !0,
                params: this._partyNavigateParams
            })
        },
        dispose: function() {
            r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalEquipmentRemoveConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalEquipmentRemoveConfirm"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide-negative]": "onClickDecideNegative",
            "anchorsbeforejump [data-app-decide-positive]": "onClickDecidePositive"
        },
        render: function(e) {
            this.renderContent(s, {
                equippingBuddyModel: e.equippingBuddyModel
            })
        },
        onClickDecideNegative: function() {
            FF.modalStack.popAll(!1)
        },
        onClickDecidePositive: function() {
            FF.modalStack.popAll(!0)
        }
    })
}), define("scenes/party/pages/DressRecordChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalEquipmentRemoveConfirm", "scenes/party/pages/Page", "components/FreeScroll", "components/LongTap", "components/Scrollbar", "templates/party/DressRecordChange", "templates/party/views/DressRecordChangeInfo", "templates/party/views/DressRecordChangeList", "scenes/common/ui_module/SortModuleFacade", "scenes/party/ChangeDressRecordViewController", "lib/TextMaster"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    var w = e.extend({}, s, {});
    return l.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-dress-record-list-id]": "onClickDressRecordList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        _longTaps: [],
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.hasChangedSoulStrike = !1, this._initSortOptions(), l.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {},
        render: function(e) {
            this.buddyId = e[0], this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), l.prototype.render.call(this, d, {
                buddy: this.buddyModel
            }), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderChangeDetailInfo(), this.renderDressRecordList(), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new c({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new p({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.buddyModel, e.tmpEquip = e.tmpEquip ? e.tmpEquip : {}, e.seriesId = this.context.getSeriesId();
            var n = r.process(v, e);
            t("#dressRecordInfo").html(n)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("#dressRecordChangeList")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new a({
                toggleListParentElem: t("#dressRecordChangeList"),
                maxNum: 2
            })
        },
        getTmpEquipmentModel: function() {
            return this.buddyModel.getTmpEquipmentModelByTypeName(this.typeName) || null
        },
        getOldEquipmentModel: function() {
            return this.buddyModel.getEquipmentModelByTypeName(this.typeName) || null
        },
        renderDressRecordList: function(e) {
            e = e || {};
            var t = FF.datastore.dressRecordCollection;
            this.collection = t.sort().getListForChangeDetail(this.buddyModel), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = this.collection.slice(e, n),
                s = r.process(m, {
                    dressRecordModels: i,
                    isInDungeon: this.isInDungeon(),
                    buddyModel: this.buddyModel
                });
            t("#dressRecordChangeList").html(s), this.processAfterRender({
                notShowDeshi: !0
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            })
        },
        saveDressRecordIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.buddyModel.hasChangedDressRecordId() ? (i.buddySaveDressRecordDeferred(FF.datastore.buddyCollection.getChangedDressRecordInfo(), this.buddyModel.isSetTmpEquipmentByRecommend).done(function(e) {
                FF.datastore.fixTmpDressRecords(), n.resolve(e)
            }), n.promise()) : n.resolve().promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var n = e.forceChange,
                r = this._getSelectedDressRecordId();
            this.buddyModel.setTmpDressRecordId({
                dressRecordId: r
            }), this.saveDressRecordIfNeedDeferred().done(function(e) {
                t.updateBuddyImageInfo(e), t.showAnimation(e)
            }).fail(function() {
                t._back()
            })
        },
        updateBuddyImageInfo: function(t) {
            var n = t.buddies[0];
            this.buddyModel.setImagePath(n.image_path), FF.datastore.stash.partyAssets[sprintf("animation-buddy-%s", n.buddy_id)] = e.clone(t.assets[sprintf("new-dress-record-%s", n.id)])
        },
        updateSelectedDressRecordById: function(e, n) {
            var r = FF.datastore.dressRecordCollection.get(e);
            if (!n) {
                t("#selectedDressRecordImage").removeAttr("src").addClass("di-n"), t("#selectedDressRecordName").text("");
                return
            }
            r ? (t("#selectedDressRecordImage").attr("src", pUrl(r.get("image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(r.get("name"))) : (t("#selectedDressRecordImage").attr("src", pUrl(this.buddyModel.get("default_image_path"))).removeClass("di-n"), t("#selectedDressRecordName").text(this.buddyModel.get("dress_record_name")))
        },
        showAnimation: function(e) {
            var t = this;
            this.changeDressRecordController = new y({
                dataMap: e
            }), this.changeDressRecordController.loadViewDeferred(), this.listenToOnce(this.changeDressRecordController, "closeAnimation", function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickDressRecordList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-dress-record-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = FF.datastore.dressRecordCollection.get(i),
                o = n.closest("[data-app-dress-record-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-dress-record-list-button-id")),
                a;
            u ? (this._setSelectedDressRecordId(s ? s.get("dress_record_id") : 0), this.updateSelectedDressRecordById(s, u)) : (this._setSelectedDressRecordId(void 0), this.updateSelectedDressRecordById(void 0, u)), this.switchDisplayParts(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        _getSelectedDressRecordId: function() {
            return this.selectedDressRecordId
        },
        _setSelectedDressRecordId: function(e) {
            this.selectedDressRecordId = e
        },
        _getSelectedDressRecordIdModel: function() {
            return this.selectedDressRecordId ? FF.datastore.dressRecordCollection.get(this.selectedDressRecordId) : null
        },
        getCurrentDressRecordId: function() {
            return this.buddyModel.getTmpDressRecordId()
        },
        onClickRemove: function() {
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = FF.datastore.dressRecordCollection,
                n = t.get(e),
                r = this.switchFocus(null);
            r ? this._setSelectedDressRecordId(dressRecordModel ? dressRecordModel.get("id") : null) : this._setSelectedDressRecordId(void 0), this.switchDisplayParts(), FF.router.loading.unlock()
        },
        onClickOpenSortModal: function() {
            g.openModalDeferred(w.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.resetCurrentPage(), this._setSelectedDressRecordId(void 0), this.hideParts(), this.renderDressRecordList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        _back: function() {
            history.back()
        },
        switchDisplayParts: function() {
            this._getSelectedDressRecordId() === this.getCurrentDressRecordId() || e.isUndefined(this._getSelectedDressRecordId()) ? this.hideParts() : this.showParts()
        },
        showParts: function() {
            t("[data-app-decide]").removeClass("is-disable"), t("#animArrow").addClass("is-active")
        },
        hideParts: function() {
            t("[data-app-decide]").addClass("is-disable"), t("#animArrow").removeClass("is-active")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-dress-record-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-dress-record-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.modalEquipmentRemoveConfirmView && this.modalEquipmentRemoveConfirmView.dispose(), e.each(this._longTaps, function(e) {
                e.dispose()
            }), this._longTaps.length = 0, l.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/DressRecordTutorial", [], function() {
    return {
        navigateIfNeedDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.userModel,
                n = FF.datastore.dressRecordCollection;
            return t.hasProceededFuncTutorial("DRESS_RECORD") || !n.hasDressRecord() ? e.resolve().promise() : (Backbone.history.navigate("func_tutorial/dress_record", {
                trigger: !0
            }), e.reject().promise())
        }
    }
}), define("scenes/common/view_helper/ViewHelper", ["underscore", "jquery"], function(e, t) {
    var n = {
        getStatusBonusFontColorClass: function(e, t, n) {
            if (!n) return "";
            if (n.hasOwnProperty("aurable")) {
                var r = n.aurable;
                if (!r) return ""
            }
            var i = e.isRisenBySeriesBonus(t, n),
                s = e.isRisenByRoleBonus(t, n),
                o = s ? "fc-role-bonus" : i ? "fc-up" : "";
            return o = this._insertEmpty(o, n), o
        },
        getStatusBonusCellClass: function(t, n) {
            if (e.isEmpty(t)) return "";
            if (n.hasOwnProperty("aurable")) {
                var r = n.aurable;
                if (!r) return ""
            }
            var i = n.seriesId,
                s = t.hasSeriesBonus(i),
                o = n.hasRoleBonus,
                u;
            if (s) switch (n.size) {
                case "s":
                    u = "is-same-series-s";
                    break;
                case "m":
                default:
                    u = "is-same-series-m";
                    break;
                case "l":
                    u = "is-same-series-l"
            } else if (o) switch (n.size) {
                case "s":
                    u = "is-role-bonus-s";
                    break;
                case "m":
                default:
                    u = "is-role-bonus-m";
                    break;
                case "l":
                    u = "is-role-bonus-l"
            } else u = "";
            return u = this._insertEmpty(u, n), u
        },
        _insertEmpty: function(e, t) {
            return !t.omitSpace && e.length > 0 && e.indexOf(" ") !== 0 && (e = " " + e), e
        },
        isSeriesIconDefined: function(e) {
            var t = FF.CONST.SERVER.SERIES;
            return e === +t.EMPTY_SERIES_ID ? !1 : e === +t.NAME_TO_ID.EXTREME ? !1 : !0
        }
    };
    return n
}), define("scenes/party/pages/Equipment", ["underscore", "jquery", "backbone", "scenes/common/Constant", "scenes/party/Api", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterAvailableType", "scenes/common/helper/LockFlagManager", "scenes/party/views/BuddyEquipment", "scenes/party/views/BuddySoulStrike", "scenes/party/views/BuddyAbility", "scenes/party/views/BuddyRecordMateria", "scenes/party/pages/DressRecordChange", "scenes/common/helper/DressRecordTutorial", "templates/party/Equipment", "scenes/common/view_helper/ViewHelper", "scenes/common/helper/FuncTutorial", "scenes/common/helper/DressRecordTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, p) {
    var g = e.extend({}, r, {
        FC_UP_CLASS_NAME: "fc-up",
        FC_DOWN_CLASS_NAME: "fc-down",
        CURRENT_CLASS_NAME: "is-current",
        CATEGORY_ID: {
            EQUIPMENT: 1,
            SOUL_STRIKE: 2,
            ABILITY: 3,
            RECORD_MATERIA: 4
        }
    });
    return s.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-buddy-detail]": "onClickSelectBuddy",
            "anchorsbeforejump [data-app-character-set-type]": "onClickAvailableType",
            "anchorsbeforejump [data-app-dress-record-change]": "onClickDressRecordChange",
            "anchorsbeforejump [data-app-category]": "onClickSelectCategory"
        },
        initialize: function(e) {
            this.categoryView = void 0, FF.resonator.resetSimulation(), s.prototype.initialize.call(this, e), this.globalNaviEventHandlerFunc = this.onClickGlobalNavi.bind(this), this.overwriteGlobalNaviEvent(), this.lockFlagManager = new u, this.lockFlagManager.initialize(["isTapped", "isRecommended"])
        },
        overwriteGlobalNaviEvent: function() {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t("#globalNavigation [data-mbgaui-anchors]").on("anchorsbeforejump", this.globalNaviEventHandlerFunc)
        },
        resetGlobalNaviEvent: function() {
            t("#globalNavigation [data-mbgaui-anchors]").off("anchorsbeforejump", this.globalNaviEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation()
        },
        onClickGlobalNavi: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this._resetTmpIfNeed();
            var r = t(e.target).attr("data-app-href");
            return n.history.navigate(r, {
                trigger: !0
            }), !1
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.datastore.stash.buddyIdToNextRecordMateriaMap ? n.resolve().promise() : (i.getBuddyIdToNextRecordMateriaMap().then(function(e) {
                FF.datastore.stash.buddyIdToNextRecordMateriaMap = e.buddy_id_to_record_materia_map, n.resolve()
            }), n.promise())
        },
        render: function(e) {
            var n = FF.datastore.partyModel;
            this.buddyId = e[0] - 0, this.categoryId = this.categoryId ? this.categoryId : e[1] - 0, this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), s.prototype.render.call(this, d, {
                party: n.getBuddyModels(),
                buddy: this.buddyModel,
                inParty: n.isBuddyModelInParty(this.buddyModel),
                statusBonusOpt: this.context.getStatusBonusOpt(),
                partyStatusMap: FF.datastore.partyStatusModel.getIdToDataMap()
            }), this._renderCategoryViewById(this.categoryId), this._toggleClass(t('[data-app-category="' + this.categoryId + '"]'), g.CURRENT_CLASS_NAME), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.apply(this, arguments), m.showNavigationDeferred({
                key: "EQUIPMENT_CHANGE",
                isTutorialIllustOnly: !0
            }).then(p.navigateIfNeedDeferred)
        },
        _renderCategoryViewById: function(e) {
            e = e ? e : g.PARTY_TOP_SUB_CATEGORY.EQUIPMENT, this.categoryView && this.categoryView.dispose(), this.categoryView = this._getCategoryView()[e], this.categoryView = new this.categoryView({
                el: t("#categoryContent"),
                buddyModel: this.buddyModel,
                lockFlagManager: this.lockFlagManager
            }), this.categoryView.render({
                statusBonusOpt: this.context.getStatusBonusOpt()
            }), this.listenTo(this.categoryView, "showToastOfMustClickFix", this.showToastOfMustClickFix)
        },
        _getCategoryView: function() {
            return {
                1: a,
                2: f,
                3: l,
                4: c
            }
        },
        _resetTmpIfNeed: function() {
            this.categoryId === g.CATEGORY_ID.EQUIPMENT ? FF.datastore.resetTmpEquipments() : this.categoryId === g.CATEGORY_ID.ABILITY ? FF.datastore.resetTmpAbilities() : this.categoryId === g.CATEGORY_ID.SOUL_STRIKE && FF.datastore.resetTmpSoulStrikes(), this._resetStatusHp(), this.lockFlagManager.unlock("isRecommended")
        },
        onClickSelectBuddy: function(e) {
            FF.router.loading.lock();
            var n = t(e.target);
            if (n.hasClass("is-active")) return;
            this._toggleClass(n, "is-active"), this._resetTmpIfNeed();
            var r = +n.closest("[data-app-buddy-detail]").attr("data-app-buddy-detail");
            this.render([r])
        },
        _toggleClass: function(e, n) {
            t(e).siblings().removeClass(n), e.addClass(n)
        },
        onClickAvailableType: function() {
            var e = this;
            FF.modalStack.push(o, {
                renderer: function(t) {
                    var n = e.buddyModel.get("ability_category"),
                        r = e.buddyModel.get("equipment_category");
                    t.render(n, r)
                }
            })
        },
        onClickDressRecordChange: function(e) {
            FF.router.loading.lock();
            var r = t(e.target);
            if (r.hasClass("is-active")) return;
            this._toggleClass(r, "is-active"), FF.datastore.resetTmpEquipments(), n.history.navigate("party/dress_record_change/" + this.buddyId, {
                trigger: !0
            })
        },
        _resetStatusHp: function() {
            if (!this.lockFlagManager.isLocked("isRecommended")) return;
            var e = t("[data-status-hp-wrap]"),
                n = t("[data-app-status-hp]"),
                r = t("[data-app-status-max-hp]"),
                i = FF.datastore.partyStatusModel.getIdToDataMap(),
                s = this.context.getStatusBonusOpt(),
                o = this.buddyModel.getStatusBonusOpt(s);
            o.useTmpEquipment = !0;
            var u = this.buddyModel.getParamOf("hp", o),
                a = i.hp || u;
            n.removeClass(g.FC_UP_CLASS_NAME).removeClass(g.FC_DOWN_CLASS_NAME).text(a), r.removeClass(g.FC_UP_CLASS_NAME).removeClass(g.FC_DOWN_CLASS_NAME).text(u);
            var f = v.getStatusBonusFontColorClass(this.buddyModel, "hp", o);
            e.addClass(f)
        },
        onClickSelectCategory: function(e) {
            var n = t(e.target);
            if (n.hasClass(g.CURRENT_CLASS_NAME)) return;
            if (this.lockFlagManager.isLocked("isTapped")) return;
            this.lockFlagManager.lock("isTapped"), FF.router.loading.lock(), this._resetTmpIfNeed(), this._toggleClass(n, g.CURRENT_CLASS_NAME), this.categoryId = +n.attr("data-app-category"), this._renderCategoryViewById(this.categoryId), this.lockFlagManager.unlock("isTapped"), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        showToastOfMustClickFix: function() {
            FF.router.toast.topping(t("#toast-message-must-click-fix-btn").text()).bake()
        },
        onClickBack: function() {
            FF.router.loading.lock(), this._resetTmpIfNeed();
            var e = this.context.getBackFragment() || "#party";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        dispose: function() {
            this.resetGlobalNaviEvent(), this.lockFlagManager && this.lockFlagManager.dispose(), this.categoryView && this.categoryView.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/models/InventoryEtc", ["scenes/common/models/ItemBase"], function(e) {
    return e.extend({})
}), define("scenes/party/collections/InventoryEtc", ["scenes/common/collections/ItemBase", "../models/InventoryEtc"], function(e, t) {
    var n = {
        ID_ASC: "inventory_id_asc"
    };
    return e.extend({
        model: t,
        initialize: function() {
            e.prototype.initialize.call(this), this.ORDER_TYPE_OF = n, this.add(FF.datastore.memoryCrystalCollection.models)
        },
        changeComparator: function(e) {
            var t = this;
            switch (e) {
                case n.ID_ASC:
                    this.comparator = function(e, n) {
                        return !e.isMemoryCrystal() && n.isMemoryCrystal() ? -1 : e.isMemoryCrystal() && !n.isMemoryCrystal() ? 1 : e.get("rarity") < n.get("rarity") ? -1 : e.get("rarity") > n.get("rarity") ? 1 : t.defaultComparatorFunc(e, n)
                    };
                    break;
                default:
                    this.comparator = function(e, n) {
                        return t.defaultComparatorFunc(e, n)
                    }
            }
        },
        defaultComparatorFunc: function(e, t) {
            return e.get("id") < t.get("id") ? -1 : e.get("id") > t.get("id") ? 1 : e.get("created_at") < t.get("created_at") ? -1 : e.get("created_at") > t.get("created_at") ? 1 : 0
        },
        getSellData: function(e, t) {
            var n = {};
            return n[this.SELL_IDS_KEY_NAME] = {}, n[this.SELL_IDS_KEY_NAME][e] = t, n
        },
        getBlockSellData: function(e) {
            var t = this,
                n = {};
            n[this.SELL_IDS_KEY_NAME] = {};
            var r = _.indexBy(this.models, "id");
            return _.each(e, function(e) {
                n[t.SELL_IDS_KEY_NAME][e] = r[e].get("num")
            }), n
        },
        getAvailableModels: function() {
            return this.models
        },
        getAvailableLength: function() {
            return this.length
        }
    })
}), define("scenes/party/views/ModalInventoryDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "components/QuantitySelector", "templates/party/views/ModalInventoryAbilityDetail", "templates/party/views/ModalInventoryEquipDetail", "templates/party/views/ModalInventoryMaterialDetail", "templates/party/views/ModalInventoryGrowEggDetail", "templates/party/views/ModalInventoryEquipmentSpMaterialDetail", "templates/party/views/ModalInventoryMemoryCrystalDetail", "templates/party/views/ModalInventoryBlockSale", "scenes/party/helper/ItemLockViewHelper", "./ModalBuddiesCanEquip"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        DISABLE_CLASS_NAME: "is-disable"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-enhancement]": "onClickEnhancement",
            "anchorsbeforejump [data-app-remove-ability]": "onClickRemoveAbility",
            "anchorsbeforejump [data-app-remove-equip]": "onClickRemoveEquip",
            "anchorsbeforejump [data-app-sell]": "onClickSell",
            "anchorsbeforejump [data-app-sell-equip]": "onClickSell",
            "anchorsbeforejump [data-app-sell-ability]": "onClickSell",
            "anchorsbeforejump [data-app-decide-to-sell]": "onClickDecideToSell",
            "anchorsbeforejump [data-app-decide-to-block-sell]": "onClickDecideToBlockSell",
            "anchorsbeforejump [data-app-toggle-lock]": "onClickToggleLock",
            "anchorsbeforejump #buddiesCanEquip": "onClickBuddiesCanEquip"
        },
        initialize: function(e) {
            e = e || {}, this.inventoryModel = e.inventoryModel || null, this.isInDungeon = FF.datastore.dungeonSessionModel.isInDungeon()
        },
        renderDetail: function() {
            var e = this.inventoryModel;
            if (e.isEquipment()) this.renderEquip();
            else if (e.isAbility()) this.renderAbility();
            else if (e.isMaterial()) this.renderMaterial();
            else if (e.isGrowEgg()) this.renderGrowEgg();
            else if (e.isEquipSpMaterial()) this.renderEquipmentSpMaterial();
            else {
                if (!e.isMemoryCrystal()) throw new Error("invalid model: " + e);
                this.renderMemoryCrystal()
            }
        },
        renderSell: function() {
            var e = this.inventoryModel;
            e.isEquipment() ? this.renderEquipSellConfirm() : e.isAbility() ? this.renderAbilitySellConfirm() : e.isMaterial() ? this.renderMaterialSellConfirm() : e.isGrowEgg() ? this.renderGrowEggSellConfirm() : e.isEquipSpMaterial() ? this.renderEquipmentSpMaterialSellConfirm() : FF.logger.error("invalid model: " + e)
        },
        renderEquip: function() {
            var e = this.inventoryModel,
                t = e.getEquippedBuddy(e.get("id"));
            this.renderContent(u, {
                equipmentModel: e,
                equippedBuddyName: t ? t.get("name") : null,
                isConfirm: !1,
                isInDungeon: this.isInDungeon,
                soulStrikeModel: e.getSoulStrikeModel()
            }), this._updateSellButtonEnabled(e)
        },
        renderEquipSellConfirm: function() {
            var e = this.inventoryModel,
                t = e.getEquippedBuddy(e.get("id"));
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(u, {
                userGil: this.userGil,
                equipmentModel: e,
                equippedBuddyName: t ? t.get("name") : null,
                isConfirm: !0,
                soulStrikeModel: e.getSoulStrikeModel()
            })
        },
        renderAbility: function() {
            this.renderContent(o, {
                abilityModel: this.inventoryModel,
                isConfirm: !1,
                isInDungeon: this.isInDungeon
            }), this._updateSellButtonEnabled(this.inventoryModel)
        },
        renderAbilitySellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(o, {
                userGil: this.userGil,
                abilityModel: this.inventoryModel,
                isConfirm: !0
            })
        },
        renderMaterial: function() {
            this.renderContent(a, {
                materialModel: this.inventoryModel,
                isConfirm: !1
            })
        },
        renderMaterialSellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(a, {
                userGil: this.userGil,
                materialModel: this.inventoryModel,
                isConfirm: !0
            }), this.setupQuentitySelector()
        },
        renderGrowEgg: function() {
            this.renderContent(f, {
                growEggModel: this.inventoryModel,
                isConfirm: !1
            })
        },
        renderGrowEggSellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(f, {
                userGil: this.userGil,
                growEggModel: this.inventoryModel,
                isConfirm: !0
            }), this.setupQuentitySelector()
        },
        renderEquipmentSpMaterial: function() {
            this.renderContent(l, {
                equipmentSpMaterialModel: this.inventoryModel,
                isConfirm: !1
            })
        },
        renderEquipmentSpMaterialSellConfirm: function() {
            this.userGil = FF.datastore.userModel.get("gil"), this.renderContent(l, {
                userGil: this.userGil,
                equipmentSpMaterialModel: this.inventoryModel,
                isConfirm: !0
            }), this.setupQuentitySelector()
        },
        renderMemoryCrystal: function() {
            this.renderContent(c, {
                memoryCrystal: this.inventoryModel
            })
        },
        renderBlockSale: function(t, n) {
            var r = e.max(t, function(e) {
                    return e.get("rarity") || e.get("level")
                }),
                i = 1,
                s = 0;
            for (var o = 0; o < t.length; o++) {
                if (t[o].isMaterial() || t[o].isGrowEgg() || t[o].isEquipSpMaterial()) i = t[o].get("num");
                s += +t[o].get("sale_gil") * i
            }
            this.renderContent(h, {
                models: t,
                rarity: r.get("rarity"),
                sale_gil: s,
                userGil: n
            })
        },
        onClickModalClose: function() {
            FF.modalStack.popAll()
        },
        onClickEnhancement: function() {
            this.trigger("onClickEnhancement")
        },
        onClickRemoveEquip: function() {
            this.trigger("onClickRemoveEquip")
        },
        onClickRemoveAbility: function() {
            this.trigger("onClickRemoveAbility")
        },
        onClickSell: function() {
            this.trigger("onClickSell")
        },
        onClickDecideToSell: function() {
            var e = this.quantitySelector ? this.quantitySelector.getValue() : 1;
            this.trigger("onClickDecideToSell", e)
        },
        onClickDecideToBlockSell: function() {
            this.trigger("onClickDecideToBlockSell")
        },
        setupQuentitySelector: function() {
            this.quantitySelector = new s({
                el: this.$el.find("[data-ui-fluctuator]"),
                current: 1
            }), this.listenTo(this.quantitySelector, "update", this.updateQuantity.bind(this))
        },
        updateQuantity: function() {
            FF.SoundMgr.playChooseEffect();
            var e = this.quantitySelector.getValue();
            this._updateDecideButton(e), this.trigger("onChangeNum", this.inventoryModel, e)
        },
        _updateDecideButton: function(e) {
            e === 0 ? t("[data-app-decide-to-sell]").addClass("is-disable") : t("[data-app-decide-to-sell]").removeClass("is-disable")
        },
        _updateSellButtonEnabled: function(e) {
            var t = this._getSellButtonElem(e);
            if (!t) return;
            e.get("is_locked") ? t.addClass(v.DISABLE_CLASS_NAME) : t.removeClass(v.DISABLE_CLASS_NAME)
        },
        _getSellButtonElem: function(e) {
            return e.isEquipment() ? t("[data-app-sell-equip]") : e.isAbility() ? t("[data-app-sell-ability]") : void 0
        },
        onClickToggleLock: function() {
            var e = this.inventoryModel,
                t = e.get("is_locked");
            if (t === undefined) return;
            var n = this,
                r = this._getLockApi(e);
            r(e.id, !t).done(function() {
                e.set("is_locked", !t), p.updateLockButtonView(!t), n._updateSellButtonEnabled(e), FF.modalStack.isHidden() && (n.renderDetail(), n.open()), FF.router.loading.hide(!0)
            })
        },
        _getLockApi: function(e) {
            if (e.isEquipment()) return r.toggleOneEquipmentLock.bind(r);
            if (e.isAbility()) return r.toggleOneAbilityLock.bind(r);
            throw new Error("Unlockable model: " + e)
        },
        isLocked: function() {
            return this.inventoryModel.get("is_locked")
        },
        onClickBuddiesCanEquip: function() {
            var e = this;
            FF.modalStack.push(d, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(e.inventoryModel)
                }
            })
        },
        dispose: function() {
            this.quantitySelector && this.quantitySelector.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityMaterialDetail", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalAbilityMaterialDetail"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        render: function(e) {
            this.renderContent(i, {
                abilityMaterialModel: e
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        }
    })
}), define("scenes/party/pages/Inventory", ["underscore", "jquery", "util", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/collections/InventoryEtc", "scenes/party/views/ModalInventoryDetail", "scenes/party/views/ModalAbilityMaterialDetail", "templates/party/Inventory", "templates/party/views/InventoryList", "templates/party/views/InventoryInfo", "scenes/party/pages/Page", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/common/ui_module/SortModuleFacade", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend({}, o, {
            ACTIVE_CLASS_NAME: "is-active",
            CHECKED_CLASS_NAME: "is-checked",
            CURRENT_CLASS_NAME: "is-current",
            DISABLE_CLASS_NAME: "is-disable",
            EQUIPED_CLASS_NAME: "is-in-equip",
            NUMBERLING_CLASS_NAME: "is-check-no",
            SORTIE_CLASS_NAME: "is-sortie",
            LOCKED_CLASS_NAME: "is-locked",
            UI_DISABLED_CLASS_NAME: "mbgaui-disabled",
            EQUIPED_CLASS_NAME_BY_SUPPORTER: "is-in-equip-by-supporter",
            BUNDLE_LOCK_MODE_CLASS_NAME: "is-bundle-lock-mode",
            HIDE_SORT_BTN_CLASS_NAME: "di-n",
            POINTER_EVENT_NONE_CLASS_NAME: "pe-n-force",
            LIMIT_MAX_NUM: 50,
            LIMIT_SELECT_NUM: 10
        }),
        w = {
            EQUIPMENT: "equipment",
            ABILITY: "ability",
            MATERIAL: "material",
            GROW_EGG: "growEgg",
            ETC: "etc",
            EQUIPMENT_SP_MATERIAL: "equipmentSpMaterial"
        },
        E = {};
    E[w.EQUIPMENT] = 2, E[w.ABILITY] = 2;
    var S = {};
    return S[w.EQUIPMENT] = "inventory_equip", S[w.ABILITY] = "inventory_ability", S[w.MATERIAL] = "inventory_material", S[w.GROW_EGG] = "inventory_grow_egg", S[w.ETC] = "inventory_etc", S[w.EQUIPMENT_SP_MATERIAL] = "inventory_sp_material", d.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-tab-small-category]": "onClickTabSmall",
            "anchorsbeforejump [data-app-inventory-list]": "onClickInventoryList",
            "anchorsbeforejump [data-app-inventory-list-material]": "onClickInventoryListMaterial",
            "anchorsbeforejump #clearBtn": "onClickClear",
            "anchorsbeforejump #decideBtn": "onClickDecideBtn",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-possession-limit-expand]": "onClickPossessionExpand",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-status-display-toggle]": "onClickDisplayToggle",
            "anchorsbeforejump #bundleLockBtn": "onClickBundleLock",
            "anchorslongtap [data-app-inventory-list]": "onLongTapInventoryDetail",
            "anchorslongtap [data-app-inventory-list-material]": "onLongTapInventoryDetail"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this._isBundleLockMode = !1, this.hasListItemTapped = !1, this.userGil = FF.datastore.userModel.get("gil"), this.selectedCollection = void 0, this.selectedCollectionName = void 0, this.activeCategory = e.args && e.args[0] ? e.args[0] : w.EQUIPMENT, this.selectionId = void 0, this.selectionIds = [], this.etcCollection = new a, this._initSortOptions(this.activeCategory), this.footerEventHandlerFunc = this.onClickGlobalNavi.bind(this), this.addFooterEvent(this.footerEventHandlerFunc), FF.SoundMgr.playAirshipBlackjackBgm(), d.prototype.initialize.call(this, e)
        },
        _initSortOptions: function(e) {
            FF.resonator.resetSimulation();
            var t = this._getSortModuleKey(e);
            g.resetSceneScopeStatus(t), this._sortOptions = g.getDefaultSortOptions(t)
        },
        _getSortModuleKey: function(e) {
            return S[e]
        },
        addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", e)
        },
        onClickGlobalNavi: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect();
            var n = t(e.currentTarget).attr("data-app-href");
            return r.history.navigate(n, {
                trigger: !0
            }), !1
        },
        render: function() {
            var e = {
                userGil: this.userGil
            };
            d.prototype.render.call(this, c, e), this.selectActiveTab(), this.renderOverScrollView(), this.setupRenderList(this.activeCategory)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "TILE",
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        setPossessionNum: function(e) {
            t("[data-app-possession-num]").html(e)
        },
        setPossessionLimitNum: function(e) {
            t("[data-app-possession-limit-num]").html(e)
        },
        setSelectedNum: function(e) {
            t("[data-app-selected-num]").html(e)
        },
        setSelectedLimitNum: function(e) {
            t("[data-app-selected-limit-num]").html(e)
        },
        renderInfo: function() {
            var e = i.process(p, {
                category: this.activeCategory,
                isMaterialCategory: this.isMaterialCategory(),
                isEquipCategory: this.isEquipCategory()
            });
            t("[data-app-inventory-info]").html(e)
        },
        setupRenderList: function(e) {
            e === w.ETC ? this.selectedCollection = this.etcCollection : this.selectedCollection = FF.datastore[e + "Collection"], this.overScrollView.updateCollectionSize(this.selectedCollection.getAvailableLength()), this.overScrollView.setMaxPageText(), this.selectedCollectionName = e, this.renderInfo(), this._updateSortOptionButtonFace(this._sortOptions), this._setupStatusDisplayToggleHelper(), this.isEquipCategory() ? (this.setPossessionNum(this.selectedCollection.getAvailableLength()), this.showDecideButtonContainer()) : this.hideDecideButtonContainer(), this.renderCollectionList(this._sortOptions);
            var t = FF.datastore.itemPossessionLimitCollection.findByTypeName(e);
            t = t ? t.get("max_num") : b.LIMIT_MAX_NUM, this.setPossessionLimitNum(t), this.setSelectedNum(0), this.setSelectedLimitNum(b.LIMIT_SELECT_NUM)
        },
        renderCollectionList: function(e) {
            e = e || {};
            var n = t("[data-app-selector-order]"),
                r = n.prop("selectedIndex"),
                i = n.find("option").eq(r),
                s = i.attr("data-app-series-name"),
                o = i.attr("data-app-category-type");
            this.selectedCollection.changeComparator(e, {
                series_name: s,
                categoryType: o,
                upgradeRecipeMap: this.abilityUpgradeRecipeMap
            });
            var u = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > u && this.overScrollView.setCurrentPage(u), this._renderItems()
        },
        _renderItems: function() {
            var n = this.overScrollView.getStartNum(),
                r = this.overScrollView.getEndNum(),
                s = this.selectedCollection.getAvailableLength() ? this.selectedCollection.sort().getAvailableModels().slice(n, r) : [],
                o = e.map(s, function(e) {
                    return e.get("id")
                }),
                u = i.process(h, {
                    models: s,
                    displayKey: this._sortOptions.displayKey,
                    isInDungeon: this.isInDungeon(),
                    isEquipCategory: this.isEquipCategory(),
                    isMaterialCategory: this.isMaterialCategory(),
                    selectionClassNameMap: this._setupSelectionClassName()
                }),
                a = t("[data-app-list-items]");
            this.overScrollView.render({
                html: u,
                parentElement: a,
                imageWatcher: this.imageWatcher
            }), this._applyTappableClassInEachListElems(o), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        processAfterContentLoad: function() {
            d.prototype.processAfterContentLoad.apply(this, arguments), y.showNavigationDeferred({
                key: "INVENTORY",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2,
                speakerClassName: "is-cid"
            })
        },
        _setupSelectionClassName: function() {
            var t = {};
            return e.each(this.selectionIds, function(e, n) {
                n += 1, t[e] = "is-checked is-check-no" + n
            }), t
        },
        _getSelectionIds: function() {
            var e = this.selectionIds;
            return e ? e : null
        },
        _setSelectionIds: function(e) {
            var t = this.selectedCollection.get(e);
            this.selectionIds.push(e), t.set("isSelected", !0)
        },
        _removeSelectionIds: function(t) {
            var n = this,
                r = void 0;
            e.each(t, function(t) {
                n.selectionIds = e.without(n.selectionIds, +t), r = n._getInventoryModel(t), r.unset("isSelected")
            })
        },
        _isSelectedLimit: function() {
            var e = this._getSelectionIds(),
                t = e ? e.length : 0;
            return t === b.LIMIT_SELECT_NUM
        },
        _getInventoryModel: function(e) {
            return this.selectedCollection.get(e)
        },
        _getAllInventoryListItemId: function() {
            return e.map(t("[data-app-inventory-id]"), function(e) {
                return +t(e).attr("data-app-inventory-id")
            })
        },
        openDetailModal: function() {
            var e = this,
                t = this._getInventoryModel(this.selectionId);
            FF.modalStack.push(f, {
                initializer: function(e) {
                    return new f({
                        inventoryModel: t
                    })
                },
                renderer: function(n) {
                    n.renderDetail(), t.isEquipment() ? (e.listenToOnce(n, "onClickEnhancement", e.goEnhancement), e.listenToOnce(n, "onClickRemoveEquip", e.removeEquip)) : t.isAbility() && e.listenToOnce(n, "onClickRemoveAbility", e.removeAbility), e.listenToOnce(n, "onClickSell", function() {
                        e.openSellModal()
                    })
                },
                onPop: function(t) {
                    e._onDetailModalClose(t), e.hasLongTap = !1
                }
            })
        },
        goEnhancement: function() {
            r.history.navigate("#party/enhancement", {
                trigger: !0
            })
        },
        onClickSortieLimitation: function() {
            if (this._isBundleLockMode) return;
            d.prototype.onClickSortieLimitation.call(this)
        },
        onClickPossessionExpand: function() {
            if (this._isBundleLockMode) return;
            r.history.navigate("#party/possession_limit_expand/" + this.activeCategory, {
                trigger: !0
            })
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickBundleLock: function() {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.overScrollView.cancelScroll(), this._toggleBundleLockMode(), FF.router.loading.unlock()
        },
        _toggleBundleLockMode: function() {
            this._isBundleLockMode = !this._isBundleLockMode, this._toggleBundleLockOverlay(), this.selectionIds.length > 0 && this._clearItems(), this._applyTappableClassInEachListElems(), this._toggleBtnText(), this._toggleTitleText(), t("[data-app-bundle-lock-btn-text]").toggleClass("di-n")
        },
        _toggleTitleText: function() {
            var e = this._isBundleLockMode ? t("#ttlText").attr("data-app-block-sale-text") : t("#ttlText").attr("data-app-default-text");
            t("#ttlText").text(e)
        },
        _toggleBtnText: function() {
            var e = this._isBundleLockMode ? t("#decideBtn").attr("data-app-bundle-lock-confirm-text") : t("#decideBtn").attr("data-app-block-sale-confirm-text");
            t("#btnContainerText").text(e)
        },
        _toggleBundleLockOverlay: function() {
            var e = this._isBundleLockMode ? "addClass" : "removeClass";
            t("#content")[e](b.BUNDLE_LOCK_MODE_CLASS_NAME), t("[data-app-tab-small-category], [data-app-possession-limit-expand]")[e](b.POINTER_EVENT_NONE_CLASS_NAME)
        },
        _applyTappableClassInEachListElems: function(n) {
            var r = this;
            if (!this.isEquipCategory()) return;
            var i = {};
            n && e.each(n, function(e) {
                i[e] = 1
            }), e.each(t("[data-app-inventory-id]"), function(e) {
                var s = t(e),
                    o = +t(e).attr("data-app-inventory-id");
                if (n && !i[o]) return;
                var u = r.selectedCollection.get(o);
                r._applyDisable(u, s)
            })
        },
        _applyDisable: function(e, t) {
            this._setupSelectionClassName()[e.id] ? t.removeClass(b.DISABLE_CLASS_NAME) : e.get("is_locked") ? t.addClass(b.DISABLE_CLASS_NAME) : b.LIMIT_SELECT_NUM === this.selectionIds.length ? t.addClass(b.DISABLE_CLASS_NAME) : this._isBundleLockMode ? t.removeClass(b.DISABLE_CLASS_NAME) : e.isUsedByBuddy() || e.isUsedBySupporter() ? t.addClass(b.DISABLE_CLASS_NAME) : t.removeClass(b.DISABLE_CLASS_NAME)
        },
        openSellModal: function() {
            FF.router.loading.lock();
            var e = this,
                t = this._getInventoryModel(this.selectionId);
            FF.modalStack.setGuardMultiplePushMode(!1), FF.modalStack.push(f, {
                initializer: function(e) {
                    return new f({
                        inventoryModel: t
                    })
                },
                renderer: function(n) {
                    FF.modalStack.setGuardMultiplePushMode(!0), n.renderSell(), (t.isMaterial() || t.isGrowEgg() || t.isEquipSpMaterial()) && e.listenTo(n, "onChangeNum", e.changeNum), e.listenToOnce(n, "onClickDecideToSell", e.decideToSell)
                },
                onPop: function(t) {
                    e._onDetailModalClose(t), e.hasLongTap = !1
                }
            })
        },
        onClickDecideBtn: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._isBundleLockMode ? this._decideBundleLockDeferred() : this.openBlockSaleModal()
        },
        _decideBundleLockDeferred: function() {
            var n = t.Deferred(),
                r = this,
                i = this._getSelectionIds();
            if (i === null) throw new Error("invalid selectionIds.");
            var o, u;
            if (this.selectedCollectionName === w.EQUIPMENT) o = "toggleEquipmentsLock", u = FF.datastore.equipmentCollection;
            else {
                if (this.selectedCollectionName !== w.ABILITY) throw new Error("invalid selectedCollectionName.");
                o = "toggleAbilitiesLock", u = FF.datastore.abilityCollection
            }
            return s[o](i).done(function() {
                e.each(i, function(e) {
                    var n = u.get(e);
                    n.set("is_locked", !0), t('[data-app-inventory-id="' + e + '"]').addClass(b.LOCKED_CLASS_NAME)
                }), r._clearItems(), r._applyTappableClassInEachListElems(), FF.router.loading.hide(), FF.router.toast.topping(t("#toastMessageLocked").text()).bake(), n.resolve()
            }), n.promise()
        },
        openBlockSaleModal: function() {
            var n = this,
                r = this.userGil,
                i = e.map(this.selectionIds, function(e) {
                    return n._getInventoryModel(e)
                });
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.renderBlockSale(i, r), n.listenToOnce(e, "onClickDecideToBlockSell", n.decideToBlockSell)
                },
                onPop: function(e) {
                    t("#decideBtn").removeClass(b.UI_DISABLED_CLASS_NAME)
                }
            })
        },
        openAbilityMaterialDetailModal: function() {
            FF.router.loading.lock();
            var e = this,
                t = this._getInventoryModel(this.selectionId);
            FF.modalStack.push(l, {
                renderer: function(e) {
                    e.render(t)
                },
                onPop: function(t) {
                    e.hasLongTap = !1
                }
            })
        },
        removeEquip: function() {
            var e = this,
                n = +this.selectionId,
                r = this._getInventoryModel(n),
                i = r.getTypeName(),
                o = FF.datastore.buddyCollection,
                u = o.get(r.get("inUseBy").buddyId);
            u.setTmpEquipmentId({
                typeName: i,
                equipmentId: 0
            });
            var a = o.getChangedEquipmentAndSoulStrikeInfo();
            s.buddySaveEquipmentDeferred(a).done(function() {
                FF.datastore.fixTmpEquipments(), FF.datastore.fixTmpSoulStrikes(), e.finishAfterRemove(n), FF.router.toast.topping(t("[data-app-toast-message-remove]").text()).bake(), FF.router.loading.hide(), FF.modalStack.popAll(), e.hasLongTap = !1
            })
        },
        removeAbility: function() {
            var e = this,
                n = +this.selectionId,
                r = this._getInventoryModel(n),
                i = FF.datastore.buddyCollection,
                o = i.get(r.get("inUseBy").buddyId),
                u = o.get("ability_1_id") === n ? 1 : 2;
            o.setTmpAbilityId({
                slot: u,
                abilityId: 0
            });
            var a = i.getChangedAbilityInfo();
            s.buddySaveAbilityDeferred(a).done(function() {
                FF.datastore.fixTmpAbilities(), e.finishAfterRemove(n), FF.router.toast.topping(t("[data-app-toast-message-remove]").text()).bake(), FF.router.loading.hide(), FF.modalStack.popAll(), e.hasLongTap = !1
            })
        },
        setGil: function(e) {
            var n = +t("[data-app-user-gil]").text();
            t("[data-app-user-gil]").text(n + e), this.userGil = n + e, FF.datastore.userModel.set("gil", this.userGil)
        },
        setTotalGil: function(e) {
            var n = +t("[data-app-total-sale-amount]").text();
            t("[data-app-total-sale-amount]").text(+e + n)
        },
        resetTotalGil: function(e) {
            t("[data-app-total-sale-amount]").text(0)
        },
        changeNum: function(e, n) {
            if (!e || n === void 0) return;
            var r = e.get("sale_gil") * n,
                i = this.userGil + r;
            t("[data-app-sale-gil-total]").text(r), t("[data-app-new-user-gil]").text(i)
        },
        decideToSell: function(e) {
            FF.modalStack.popAll(), FF.router.loading.show();
            var t = this.selectionId;
            switch (this.activeCategory) {
                case w.EQUIPMENT:
                    this.decideToSellEquip([t]);
                    break;
                case w.ABILITY:
                    this.decideToSellAbility([t]);
                    break;
                case w.MATERIAL:
                    this.decideToSellMaterial(t, e);
                    break;
                case w.GROW_EGG:
                    this.decideToSellGrowEgg(t, e);
                    break;
                case w.EQUIPMENT_SP_MATERIAL:
                    this.decideToSellEquipmentSpMaterial(t, e)
            }
        },
        decideToBlockSell: function() {
            FF.modalStack.popAll(), FF.router.loading.show();
            var e = this._getSelectionIds();
            switch (this.activeCategory) {
                case w.EQUIPMENT:
                    this.setSelectedNum(0), this.decideToSellEquip(e);
                    break;
                case w.ABILITY:
                    this.setSelectedNum(0), this.decideToSellAbility(e);
                    break;
                default:
                    throw new Error("Cannot block sale " + this.activeCategory)
            }
        },
        decideToSellEquip: function(e) {
            var t = this;
            s.EquipmentSellDeferred(e).done(function(n) {
                t.setGil(n.gil), t._removeSelectionIds(e), t.selectedCollection.remove(e), t.finishAfterTheSell(n), t.selectionIds.length === 0 && t.hideBtnContainer()
            })
        },
        decideToSellAbility: function(e) {
            var t = this;
            s.AbilitySellDeferred(e).done(function(n) {
                t.setGil(n.gil), t._removeSelectionIds(e), t.selectedCollection.remove(e), t.finishAfterTheSell(n), t.selectionIds.length === 0 && t.hideBtnContainer()
            })
        },
        decideToSellMaterial: function(e, t) {
            var n = this,
                r = {};
            r[e] = t, s.MaterialSellDeferred(r).done(function(r) {
                n.setGil(r.gil);
                var i = n.selectedCollection.get(e),
                    s = i.get("num") - t;
                i.set("num", s), n.finishAfterTheSell(r)
            })
        },
        decideToSellGrowEgg: function(e, t) {
            var n = this,
                r = this.selectedCollection.getSellData(e, t);
            s.growEggSellDeferred(r).done(function(r) {
                n.setGil(r.gil);
                var i = n.selectedCollection.get(e),
                    s = i.get("num") - t;
                i.set("num", s), s === 0 && (n._removeSelectionIds([e]), n.selectedCollection.remove(e), FF.datastore.growEggCollection.remove(e)), n.finishAfterTheSell(r), n.selectionIds.length === 0 && n.hideBtnContainer()
            })
        },
        decideToSellEquipmentSpMaterial: function(e, t) {
            var n = this,
                r = {};
            r[e] = t, s.EquipmentSpMaterialSellDeferred(r).done(function(r) {
                n.setGil(r.gil);
                var i = n.selectedCollection.get(e),
                    s = i.get("num") - t;
                i.set("num", s), n.finishAfterTheSell(r)
            })
        },
        finishAfterTheSell: function(e) {
            this.setSelectedNum(this.selectionIds.length), this.setPossessionNum(this.selectedCollection.getAvailableLength()), this.updateItemPossessionLimit(e.item_possession_limits), this.overScrollView.updateCollectionSize(this.selectedCollection.getAvailableLength()), this.overScrollView.setMaxPageText(), this.overScrollView.cleanup(), FF.router.toast.topping(t("[data-app-toast-message-sell]").text()), t("#decideBtn").removeClass(b.UI_DISABLED_CLASS_NAME), this.renderCollectionList(this._sortOptions), this._applyTappableClassInEachListElems(), this.overScrollView.setIsScrollableIfSinglePage(), this.selectionIds.length === 0 && this.resetTotalGil(), this.listenToOnce(FF.router.toast, "bakeStart", function() {
                FF.SoundMgr.playPayGilEffect()
            })
        },
        finishAfterRemove: function(e) {
            var n = t("[data-app-inventory-id=" + e + "]");
            n.removeClass([b.DISABLE_CLASS_NAME, b.ACTIVE_CLASS_NAME, b.EQUIPED_CLASS_NAME].join(" ")), t("[data-app-equipped-buddy]", n).remove()
        },
        updateItemPossessionLimit: function(e) {
            if (!e) return;
            FF.datastore.itemPossessionLimitCollection.update(e)
        },
        showBtnContainer: function() {
            t("#clearBtn").removeClass(b.DISABLE_CLASS_NAME), t("#decideBtn").removeClass(b.DISABLE_CLASS_NAME)
        },
        hideBtnContainer: function() {
            t("#decideBtn").addClass(b.DISABLE_CLASS_NAME), t("#clearBtn").addClass(b.DISABLE_CLASS_NAME)
        },
        showSellInfoContainer: function() {
            t("[data-app-sell-info-container]").show()
        },
        hideSellInfoContainer: function() {
            t("[data-app-sell-info-container]").hide()
        },
        showSubCategoryContainer: function() {
            t("[data-app-sub-category-container]").show()
        },
        hideSubCategoryContainer: function() {
            t("[data-app-sub-category-container]").hide()
        },
        showDecideButtonContainer: function() {
            t("#btnContainer").show(), this.forceUpdateBySelector(".c-layer-content-3")
        },
        hideDecideButtonContainer: function() {
            t("#btnContainer").hide(), this.forceUpdateBySelector(".c-layer-content-3")
        },
        isActiveElem: function(e) {
            return this.hasActiveClass(e) || this.hasCheckedClass(e)
        },
        addCheckedClass: function(e) {
            e.addClass(b.CHECKED_CLASS_NAME)
        },
        removeCheckedClass: function(e) {
            e.removeClass(b.CHECKED_CLASS_NAME)
        },
        hasCheckedClass: function(e) {
            return e.hasClass(b.CHECKED_CLASS_NAME)
        },
        hasEquipedClass: function(e) {
            return e.hasClass(b.EQUIPED_CLASS_NAME)
        },
        hasSupporterEquipedClass: function(e) {
            return e.hasClass(b.EQUIPED_CLASS_NAME_BY_SUPPORTER)
        },
        hasLockedClass: function(e) {
            return e.hasClass(b.LOCKED_CLASS_NAME)
        },
        addDisableClassIfHasNotCheckedClass: function() {
            t("[data-app-inventory-list]:not(." + b.CHECKED_CLASS_NAME + ")").addClass(b.DISABLE_CLASS_NAME)
        },
        hasActiveClass: function(e) {
            return e.hasClass(b.ACTIVE_CLASS_NAME)
        },
        removeAllActiveClass: function() {
            t("[data-app-inventory-list]").removeClass(b.ACTIVE_CLASS_NAME)
        },
        removeAllOtherActiveClass: function(e) {
            t("[data-app-inventory-list]").removeClass(b.ACTIVE_CLASS_NAME), e.addClass(b.ACTIVE_CLASS_NAME)
        },
        addNumberingClass: function(e) {
            var t = this.selectionIds.length + 1;
            this.setSelectedNum(t), e.addClass(b.NUMBERLING_CLASS_NAME + t)
        },
        setupNumberingClass: function(e) {
            var n = this.selectionIds.length;
            this.setSelectedNum(n - 1);
            var r = this.getNumberingClass(e);
            e.removeClass(r);
            var i = +r.split(b.NUMBERLING_CLASS_NAME)[1],
                s = n - i;
            for (var o = 1; o <= s; o++) {
                var u = b.NUMBERLING_CLASS_NAME + (i + o),
                    a = t("[class*=" + u + "]");
                a.removeClass(u), a.addClass(b.NUMBERLING_CLASS_NAME + (i + o - 1))
            }
        },
        getNumberingClass: function(n) {
            var r = t(n).attr("class").split(" "),
                i = e.find(r, function(e) {
                    return e.indexOf(b.NUMBERLING_CLASS_NAME) >= 0
                });
            return i
        },
        isMaterialCategory: function() {
            var e = this.activeCategory;
            return e === w.MATERIAL || e === w.GROW_EGG || e === w.EQUIPMENT_SP_MATERIAL ? !0 : !1
        },
        isEquipCategory: function() {
            var e = this.activeCategory;
            return e === w.EQUIPMENT || e === w.ABILITY ? !0 : !1
        },
        onClickTabSmall: function(e) {
            if (this._isBundleLockMode) return;
            FF.router.loading.lock(), this.blurSelectorOrder(), this.activeCategory = t(e.target).attr("data-app-tab-small-category"), this._initSortOptions(this.activeCategory), this.updateLocationHash(), this._removeSelectionIds(this.selectionIds), this.selectionIds = [], this.overScrollView.cleanup(), this.setupRenderList(this.activeCategory), this.overScrollView.setIsScrollableIfSinglePage(), this.resetTotalGil(), this.setSelectedNum(0), this.hideBtnContainer(), this.selectActiveTab(), FF.router.loading.unlock()
        },
        onClickInventoryList: function(e) {
            if (this.hasLongTap || this.hasListItemTapped) return;
            this.hasListItemTapped = !0;
            var n = t(e.target);
            this.overScrollView.cancelScroll();
            if (n.hasClass(b.SORTIE_CLASS_NAME) && !this._isBundleLockMode) {
                FF.SoundMgr.playNgEffect(), this.hasListItemTapped = !1;
                return
            }
            var r = +n.attr("data-app-inventory-id"),
                i = this.selectedCollection.get(r),
                s = i.getSellNum(),
                o = {
                    id: r,
                    model: i,
                    target: n,
                    sellNum: s,
                    saleGil: i.get("sale_gil") * s,
                    isActive: this.isActiveElem(n)
                };
            FF.router.loading.lock(), this.blurSelectorOrder(), this._isBundleLockMode ? this._updateListForBundleLockMode(o) : this._updateListForSellMode(o), this.hasListItemTapped = !1, FF.SoundMgr.playChooseEffect(), FF.router.loading.unlock()
        },
        _updateListForSellMode: function(e) {
            var t = e.id,
                n = e.model,
                r = e.target,
                i = e.sellNum,
                s = e.saleGil,
                o = e.isActive;
            if (o) this.removeAllActiveClass(), !this.hasEquipedClass(r) && !this.hasSupporterEquipedClass(r) && !n.isMemoryCrystal() && (this.setupNumberingClass(r), this.removeCheckedClass(r), this.setTotalGil(-s), b.LIMIT_SELECT_NUM === this.selectionIds.length ? (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems()) : (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems([t])), this.selectionIds.length || this.hideBtnContainer());
            else {
                if (this._isSelectedLimit()) {
                    FF.router.loading.unlock();
                    return
                }
                this.removeAllOtherActiveClass(r), !this.hasEquipedClass(r) && !this.hasSupporterEquipedClass(r) && !n.isMemoryCrystal() && (this.addNumberingClass(r), this.addCheckedClass(r), this.setTotalGil(s), this.showBtnContainer(), this._setSelectionIds(t)), this._isSelectedLimit() && this.addDisableClassIfHasNotCheckedClass()
            }
        },
        _updateListForBundleLockMode: function(e) {
            var t = e.id,
                n = e.target,
                r = e.saleGil,
                i = e.isActive;
            if (i) this.removeAllActiveClass(), this.hasLockedClass(n) || (this.setupNumberingClass(n), this.removeCheckedClass(n), b.LIMIT_SELECT_NUM === this.selectionIds.length ? (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems()) : (this._removeSelectionIds([t]), this._applyTappableClassInEachListElems([t])), this.selectionIds.length || this.hideBtnContainer());
            else {
                if (this._isSelectedLimit()) {
                    FF.router.loading.unlock();
                    return
                }
                this.removeAllOtherActiveClass(n), this.hasLockedClass(n) || (this.addNumberingClass(n), this.addCheckedClass(n), this.showBtnContainer(), this._setSelectionIds(t)), this._isSelectedLimit() && this.addDisableClassIfHasNotCheckedClass()
            }
        },
        onClickInventoryListMaterial: function(e) {
            if (this.hasLongTap) return;
            var n = t(e.target);
            this.overScrollView.cancelScroll(), this.selectionId = +n.attr("data-app-inventory-id"), this._isSelectedAbilityMaterialNotForSale() ? this.openAbilityMaterialDetailModal() : this.openSellModal(), FF.SoundMgr.playChooseEffect()
        },
        onClickOpenSortModal: function() {
            var e = this._getSortModuleKey(this.activeCategory);
            g.openModalDeferred(e).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, FF.router.loading.lock(), this.overScrollView.cleanup(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), FF.router.loading.unlock()
        },
        _updateSortOptionButtonFace: function(e) {
            var n = t("#sort-modal-btn-wrap"),
                r = t("#sort-modal-btn");
            if (!e.sortType) {
                n.addClass(b.HIDE_SORT_BTN_CLASS_NAME);
                return
            }
            n.removeClass(b.HIDE_SORT_BTN_CLASS_NAME), r.html(e.buttonFace)
        },
        onLongTapInventoryDetail: function(e) {
            if (this.hasLongTap) return;
            this.overScrollView.cancelScroll();
            var n = t(e.target),
                r = this.isActiveElem(n);
            if (r) return;
            if (this._isSelectedLimit()) return;
            FF.router.loading.lock(), this.blurSelectorOrder(), this.hasLongTap = !0, this.selectionId = n.closest("[data-app-inventory-id]").attr("data-app-inventory-id"), this._isSelectedAbilityMaterialNotForSale() ? this.openAbilityMaterialDetailModal() : this.openDetailModal(), FF.SoundMgr.playChooseEffect()
        },
        _isSelectedAbilityMaterialNotForSale: function() {
            var e = this._getInventoryModel(this.selectionId);
            return e.isMaterial() && !e.isAvailableForSale()
        },
        _onDetailModalClose: function(e) {
            if (!this.hasLongTap) return;
            var n = t("[data-app-inventory-id=" + this.selectionId + "]"),
                r = e.isLocked(),
                i = !this._isSelectedLimit();
            this._isBundleLockMode ? v.updateLockableItemElemForInventory(r, n, i) : v.updateLockableItemElem(r, n, i)
        },
        onClickClear: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._clearItems(), this._applyTappableClassInEachListElems(), FF.router.loading.unlock()
        },
        _removeNumberingClass: function() {
            var n = this,
                r = t("[data-app-inventory-list][class*=" + b.NUMBERLING_CLASS_NAME + "]");
            e.each(r, function(e) {
                var r = n.getNumberingClass(e);
                t(e).removeClass(r)
            })
        },
        _clearItems: function() {
            t("[data-app-inventory-list]." + b.CHECKED_CLASS_NAME).removeClass(b.CHECKED_CLASS_NAME), t("[data-app-inventory-list]." + b.ACTIVE_CLASS_NAME).removeClass(b.ACTIVE_CLASS_NAME), t("[data-app-total-sale-amount]").text(0), this.setSelectedNum(0), this._removeNumberingClass(), this._removeSelectionIds(this.selectionIds), this.selectionIds = [], this.hideBtnContainer()
        },
        onClickBack: function() {
            var e = this.context.getBackFragment() || "#party/enhancement_top";
            r.history.navigate(e, {
                trigger: !0
            })
        },
        selectActiveTab: function() {
            t("[data-app-tab-small-category]").removeClass(b.CURRENT_CLASS_NAME);
            var e = sprintf('[data-app-tab-small-category="%s"]', this.activeCategory);
            t(e).addClass(b.CURRENT_CLASS_NAME), this.isMaterialCategory() && t("[data-app-material-tab]").addClass(b.CURRENT_CLASS_NAME)
        },
        _setupStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.statusDisplayToggleHelper = new m({
                toggleListParentElem: t("[data-app-list-chara-container]"),
                maxNum: E[this.activeCategory] || 0
            })
        },
        updateLocationHash: function() {
            r.history.navigate("#party/inventory/" + this.activeCategory)
        },
        dispose: function() {
            t(".g-navigation [data-mbgaui-anchors]").off("anchorsbeforejump", this.footerEventHandlerFunc), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation(), this.overScrollView && this.overScrollView.dispose(), this.etcCollection && this.etcCollection.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), !this.selectionIds.length || this._removeSelectionIds(this.selectionIds), this._isBundleLockMode && (this._isBundleLockMode = !1, this._toggleBundleLockOverlay()), d.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/EquipmentChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalEquipmentDetail", "scenes/party/views/ModalSoulStrikeChangeConfirm", "scenes/party/views/ModalEquipmentRemoveConfirm", "scenes/party/pages/Page", "templates/party/EquipmentChange", "templates/party/views/EquipmentChangeInfo", "templates/party/views/EquipmentSelectedItem", "templates/party/views/EquipmentChangeList", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend({}, s, {
        SORT_MODULE_KEY: "equip_change",
        SOUL_STRIKE_EMPTY_SLOT: 0,
        PARAMETERS: ["hp", "atk", "def", "matk", "mdef", "mnd", "acc", "eva"],
        EQUIPMENT_TYPE_OF: {
            weapon: 1,
            armor: 2,
            accessory: 3
        }
    });
    return p.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-equipment-list-id]": "onClickEquipmentList",
            "anchorsbeforejump [data-app-remove]": "onClickRemove",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-equipped-detail-info]": "onLongTapEquippedDetail",
            "anchorslongtap [data-app-equip-list-button-id]": "onLongTapEquipDetail"
        },
        initialize: function(e) {
            this.hasLongTap = !1, this.isClickedDecide = !1, this.hasChangedSoulStrike = !1, this._initSortOptions(), p.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), y.resetSceneScopeStatus(b.SORT_MODULE_KEY), this._sortOptions = y.getDefaultSortOptions(b.SORT_MODULE_KEY)
        },
        render: function(e) {
            this.buddyId = e[0] - 0, this.typeName = e[1], this.buddyModel = FF.datastore.buddyCollection.get(this.buddyId), this.buddyModel.set("shouldReserveOriginalEquipment", !0), p.prototype.render.call(this, d, {
                buddy: this.buddyModel,
                statusBonusOpt: FF.resonator.getResonantStatusBonusOpt()
            }), this.renderChangeDetailInfo(), this.renderSelectedItem(), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderEquipList(), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "BUTTON",
                listElement: t("#equipmentChangeList")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new f({
                toggleListParentElem: t("#equipmentChangeList"),
                maxNum: this.isAccessory() ? 1 : 2
            })
        },
        getTmpEquipmentModel: function() {
            return this.buddyModel.getTmpEquipmentModelByTypeName(this.typeName) || null
        },
        getOldEquipmentModel: function() {
            return this.buddyModel.getEquipmentModelByTypeName(this.typeName) || null
        },
        renderChangeDetailInfo: function(e) {
            e = e || {}, e.buddy = this.buddyModel, e.tmpEquip = e.tmpEquip ? e.tmpEquip : {}, e.statusBonusOpt = FF.resonator.getResonantStatusBonusOpt();
            var n = r.process(v, e);
            t("#equipmentChangeInfo").html(n)
        },
        renderSelectedItem: function() {
            var e = this.getTmpEquipmentModel(),
                n = FF.resonator.getResonantAbilityCategoryBonusMap(),
                i = this.buddyModel.hasRoleBonus(n);
            t("#equipmentSelectedItem").html(r.process(m, {
                equipmentModel: e,
                typeName: this.typeName,
                soulStrike: e ? e.getSoulStrikeModel() : null,
                isUserSupporterBuddy: !1,
                seriesId: FF.resonator.getResonantSeriesId(),
                hasRoleBonus: i
            }))
        },
        renderEquipList: function() {
            var e = FF.resonator.getResonantAbilityCategoryBonusMap(),
                t = this.buddyModel.hasRoleBonus(e);
            this._sortOptions.hasRoleBonus = t;
            var n = FF.datastore.equipmentCollection;
            n.changeComparator(this._sortOptions), this.collection = n.sort().getListForChangeDetail(this.buddyModel, this.typeName), this.overScrollView.updateCollectionSize(this.collection.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = u.getFilteringModels({
                    start: this.overScrollView.getStartNum(),
                    end: this.overScrollView.getEndNum(),
                    collection: this.collection
                }),
                n = FF.resonator.getResonantAbilityCategoryBonusMap(),
                i = this.buddyModel.hasRoleBonus(n),
                s = r.process(g, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    equipmentModels: e,
                    isInDungeon: this.isInDungeon(),
                    equipStatusBonusOpt: {
                        seriesId: FF.resonator.getResonantSeriesId(),
                        hasRoleBonus: i,
                        calcBoostStatus: !0
                    },
                    isAccessory: this.isAccessory(),
                    displayKey: this._sortOptions.displayKey
                }),
                o = t("#equipmentChangeList");
            this.overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onLongTapEquippedDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equipment-id]"),
                i = r.attr("data-app-equipment-id"),
                s = FF.datastore.equipmentCollection.get(+i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1
            })
        },
        onLongTapEquipDetail: function(e) {
            var n = this;
            this.hasLongTap = !0;
            var r = t(e.target).closest("[data-app-equip-list-button-id]"),
                i = r.attr("data-app-equip-list-button-id"),
                s = FF.datastore.equipmentCollection.get(+i);
            this._openEquipDetailModal(s, function() {
                n.hasLongTap = !1, n._updateLockIcon(s, r)
            })
        },
        _openEquipDetailModal: function(e, t) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.overScrollView.cancelScroll(), this.generateEquipDetailModal(e, t)
        },
        generateEquipDetailModal: function(t, n) {
            var r = FF.resonator.getResonantStatusBonusOpt(),
                i = t.hasSeriesBonus(r.seriesId),
                s = this.buddyModel.hasRoleBonus(r.abilityCategoryBonusMap),
                o = e.extend({
                    hasSeriesBonus: i,
                    hasRoleBonus: s
                }, r);
            FF.modalStack.push(l, {
                initializer: function(e) {
                    return new l({
                        equipStatusBonusOpt: o
                    })
                },
                renderer: function(e) {
                    e.render(t)
                },
                onPop: n
            })
        },
        _updateLockIcon: function(e, t) {
            var n = e.get("is_locked");
            a.updateLockableItemElem(n, t, !1)
        },
        setHasChangedSoulStrikeDeferred: function() {
            var n = this;
            this.hasChangedSoulStrike = !1;
            var r = t.Deferred(),
                i = this.getOldEquipmentModel(),
                s = this._getSelectedEquipmentModel(),
                o = i ? i.get("soul_strike_id") : null,
                u = s ? s.get("soul_strike_id") : null;
            if (!o && !u) return r.resolve().promise();
            var a = this.buddyModel.getSelectableSoulStrikeModels();
            if (a.length === 1) return this.buddyModel.setTmpSoulStrikeId(a[0].get("id")), r.resolve().promise();
            if (a.length === 0) return r.resolve().promise();
            var f = this.buddyModel.getTmpSoulStrikeIds(),
                l = e.indexOf(f, u) > -1;
            if (l) return r.resolve().promise();
            var c = this.buddyModel.get("buddy_id"),
                h = s ? s.getSoulStrikeModel() : null,
                p = h ? h.isOwnByBuddyId(c) ? !0 : h.isCommon() : !1;
            if (p && !this.buddyModel.isTmpSoulStrikeSlotFull()) {
                var d = e.indexOf(f, b.SOUL_STRIKE_EMPTY_SLOT) + 1;
                return this.buddyModel.setTmpSoulStrikeIdBySlot(d, u), r.resolve().promise()
            }
            return a.length === FF.CONST.SERVER.SOUL_STRIKE.SLOTS.length ? r.resolve().promise() : p ? (this.hasChangedSoulStrike = !0, r.resolve().promise()) : r.resolve().promise()
        },
        generateSoulStrikeChangeModalIfNeedDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.hasChangedSoulStrike ? (FF.modalStack.push(c, {
                renderer: function(t) {
                    t.render(), e.listenToOnce(t, "onClickDecideNegative", function() {
                        n.reject()
                    }), e.listenToOnce(t, "onClickDecidePositive", function() {
                        n.resolve()
                    })
                },
                onPop: function() {
                    FF.router.loading.show()
                }
            }), n.promise()) : n.reject().promise()
        },
        saveEquipIfNeedDeferred: function() {
            var n = this,
                r = t.Deferred();
            if (!this.buddyModel.hasChangedEquipmentId() && !this.buddyModel.hasChangedSoulStrikeId()) return r.resolve().promise();
            var s = FF.datastore.buddyCollection.getChangedEquipmentAndSoulStrikeInfo(),
                o = e.keys(s.soulStrike).length > 0;
            return i.buddySaveEquipmentDeferred(s, this.buddyModel.isSetTmpEquipmentByRecommend).done(function() {
                FF.datastore.fixTmpEquipments(), (!n.hasChangedSoulStrike || o) && FF.datastore.fixTmpSoulStrikes(), r.resolve()
            }), r.promise()
        },
        onClickDecide: function() {
            if (this.isClickedDecide) return;
            this.isClickedDecide = !0, this.blurSelectorOrder(), this.decide()
        },
        decide: function(e) {
            var t = this;
            e = e || {};
            var r = e.forceChange,
                i = this._getSelectedEquipmentId(),
                s = this.buddyModel.setTmpEquipmentId({
                    typeName: this.typeName,
                    equipmentId: i,
                    dryrun: !0
                }),
                o = s.equippingBuddy;
            if (o && !r) {
                this.generateConfirmModal({
                    equippingBuddyModel: o
                });
                return
            }
            this.buddyModel.setTmpEquipmentId({
                typeName: this.typeName,
                equipmentId: i
            }), this.setHasChangedSoulStrikeDeferred().then(this.saveEquipIfNeedDeferred.bind(this)).then(this.generateSoulStrikeChangeModalIfNeedDeferred.bind(this)).done(function() {
                var e = "#party/soul_strike_change/" + t.buddyId;
                n.history.navigate(e, {
                    trigger: !0
                })
            }).fail(function() {
                t._back()
            })
        },
        onClickBack: function() {
            this._back()
        },
        onClickEquipmentList: function(e) {
            if (this.hasLongTap) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = e.currentTarget,
                i = r.attributes["data-app-equipment-list-id"];
            if (!i || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            i = parseInt(i.value, 10);
            var s = FF.datastore.equipmentCollection.get(i),
                o = n.closest("[data-app-equip-list-button-id]"),
                u = this.switchFocus(+o.attr("data-app-equip-list-button-id")),
                a;
            u ? (a = this.estimateBuddyParamsWithEquipment(i), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(s ? s.get("id") : null)) : (a = this.estimateBuddyParamsWithEquipment(this.buddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: a
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        estimateBuddyParamsWithEquipment: function(t) {
            var n = this,
                r = e.clone(this.buddyModel.tmpEquipmentTypeNameToId);
            e.isNumber(t) && (r[this.typeName] = t);
            var i = this.buddyModel.getEquipmentModelMapByTypeNameToId(r),
                s = {};
            return e(b.PARAMETERS).each(function(e) {
                var t = n.buddyModel.estimateBuddyParamsWithEquipment(e, i, FF.resonator.getResonantStatusBonusOpt());
                s[e] = t
            }), s
        },
        _getSelectedEquipmentId: function() {
            return this.selectedEquipmentId
        },
        _setSelectedEquipmentId: function(e) {
            this.selectedEquipmentId = e
        },
        _getSelectedEquipmentModel: function() {
            return this.selectedEquipmentId ? FF.datastore.equipmentCollection.get(this.selectedEquipmentId) : null
        },
        getCurrentEquipmentId: function() {
            return this.buddyModel.getTmpEquipmentIdByTypeName(this.typeName)
        },
        onClickRemove: function() {
            if (this.buddyModel.getEquipmentIdByTypeName(this.typeName) === 0) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = this.estimateBuddyParamsWithEquipment(e),
                n = FF.datastore.equipmentCollection,
                r = n.get(e),
                i = this.switchFocus(null);
            i ? (this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(r ? r.get("id") : null)) : (t = this.estimateBuddyParamsWithEquipment(this.buddyModel[this.typeName]), this.renderChangeDetailInfo({
                tmpEquip: t
            }), this._setSelectedEquipmentId(void 0)), this.switchDecideBtn(), FF.router.loading.unlock()
        },
        onClickOpenSortModal: function() {
            y.openModalDeferred(b.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderChangeDetailInfo(), this._setSelectedEquipmentId(void 0), this.hideDecideBtn(), this.renderEquipList(), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        generateConfirmModal: function(e) {
            var t = this,
                n = e.equippingBuddyModel;
            FF.modalStack.push(h, {
                renderer: function(e) {
                    e.render({
                        equippingBuddyModel: n
                    })
                },
                onPop: function(e, n) {
                    n ? t.decide({
                        forceChange: !0
                    }) : t.isClickedDecide = !1
                }
            })
        },
        _back: function() {
            var e = "#party/equipment/" + this.buddyId + "/" + b.PARTY_TOP_SUB_CATEGORY.EQUIPMENT;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        switchDecideBtn: function() {
            this._getSelectedEquipmentId() === this.getCurrentEquipmentId() || e.isUndefined(this._getSelectedEquipmentId()) ? this.hideDecideBtn() : this.showDecideBtn()
        },
        showDecideBtn: function() {
            t("[data-app-decide]").removeClass("is-disable")
        },
        hideDecideBtn: function() {
            t("[data-app-decide]").addClass("is-disable")
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("[data-app-remove]").removeClass("is-active"), e.each(t("[data-app-equip-list-button-id]"), function(e) {
                var i = +t(e).attr("data-app-equip-list-button-id");
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[data-app-equip-list-button-id]"), function(e) {
                t(e).removeClass("is-active")
            }), t("[data-app-remove]").hasClass("is-active") ? t("[data-app-remove]").removeClass("is-active") : (t("[data-app-remove]").addClass("is-active"), r = !0)), r
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        isAccessory: function() {
            return b.EQUIPMENT_TYPE_OF[this.typeName] === FF.CONST.SERVER.EQUIPMENT.TYPE_OF.ACCESSORY
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.modalEquipmentRemoveConfirmView && this.modalEquipmentRemoveConfirmView.dispose(), p.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/SoulStrikeChangeList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/SoulStrikeChangeList"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-soulStrike-id]": "onClickSoulStrikeListItem",
            "anchorsbeforejump [data-app-soulStrike-dismiss]": "onClickDismissSoulStrike"
        },
        initialize: function(e) {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        getDomName: function(e) {
            return '[data-app-soulStrike-id="' + e + '"]'
        },
        activate: function(e) {
            t(this.getDomName(e)).addClass("is-active"), this.selectedListId = e
        },
        deactivate: function(e) {
            t(this.getDomName(e)).removeClass("is-active"), this.selectedListId = null
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickSoulStrikeListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-soulStrike-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate(n), this.trigger("change:selectedList:selection", {
                id: n
            })) : this.selectedListId === n ? (this.deactivate(n), this.trigger("change:selectedList:selection", {
                id: null
            })) : this.selectedInfoId ? this.trigger("swap:soulStrike", [this.selectedInfoId, n]) : this.selectedEmptyCellOrder ? this.trigger("add:soulStrike", {
                order: this.selectedEmptyCellOrder,
                id: n
            }) : (this.deactivate(this.selectedListId), this.activate(n), this.trigger("change:selectedList:selection", {
                id: n
            })), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissSoulStrike: function() {
            if (!this.selectedInfoId) return;
            this.blurSelectorOrder(), this.trigger("dismiss:soulStrike", {
                id: this.selectedInfoId
            })
        },
        updateStatus: function(e) {
            this.selectedInfoId = e.id, this.selectedEmptyCellOrder = e.order
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedInfoId || this.selectedEmptyCellOrder || this.selectedListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/SoulStrikeChangeInfo", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/SoulStrikeChangeInfo"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-selected-soulStrike-id]": "onClickSoulStrikeListItem",
            "anchorsbeforejump [data-app-selected-soulStrike-empty-cell]": "onClickEmptyList"
        },
        initialize: function(e) {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        getDomName: function(e) {
            return '[data-app-selected-soulStrike-id="' + e + '"]'
        },
        getDomNameOfEmptyList: function(e) {
            return '[data-app-selected-soulStrike-empty-cell="' + e + '"]'
        },
        activate: function(e) {
            e.type === "soulStrikeId" && (t(this.getDomName(e.id)).addClass("is-active"), this.selectedInfoId = e.id), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).addClass("is-active"), this.selectedEmptyCellOrder = e.order)
        },
        deactivate: function(e) {
            e.type === "soulStrikeId" && (t(this.getDomName(e.id)).removeClass("is-active"), this.selectedInfoId = null), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).removeClass("is-active"), this.selectedEmptyCellOrder = null)
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickSoulStrikeListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-selected-soulStrike-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "soulStrikeId",
                id: n
            }), this.trigger("change:soulStrike:selection", {
                id: n
            })) : this.selectedInfoId === n ? (this.deactivate({
                type: "soulStrikeId",
                id: n
            }), this.trigger("change:soulStrike:selection", {
                id: null
            })) : this.selectedListId ? this.trigger("swap:soulStrike", [this.selectedListId, n]) : this.selectedEmptyCellOrder ? (this.trigger("move:soulStrike:ontoEmptySlot", {
                order: this.selectedEmptyCellOrder,
                id: n
            }), this.trigger("change:soulStrike:selection", {
                id: null
            })) : this.trigger("swap:soulStrike", [this.selectedInfoId, n]), FF.SoundMgr.playChooseEffect()
        },
        onClickEmptyList: function(e) {
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-selected-soulStrike-empty-cell"];
            if (!n) return;
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "order",
                order: n
            }), this.trigger("change:soulStrike:selection", {
                order: n
            })) : this.selectedEmptyCellOrder === n ? (this.deactivate({
                type: "order",
                order: n
            }), this.trigger("change:soulStrike:selection", {
                order: null
            })) : this.selectedListId ? this.trigger("add:soulStrike", {
                order: n,
                id: this.selectedListId
            }) : this.selectedInfoId && (this.trigger("move:soulStrike:ontoEmptySlot", {
                order: n,
                id: this.selectedInfoId
            }), this.trigger("change:soulStrike:selection", {
                id: null
            }))
        },
        updateStatus: function(e) {
            this.selectedListId = e.id
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedInfoId || this.selectedEmptyCellOrder || this.selectedListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/pages/SoulStrikeChange", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/party/pages/Page", "scenes/party/views/SoulStrikeChangeList", "scenes/party/views/SoulStrikeChangeInfo", "scenes/party/views/ModalSoulStrikeDetail", "scenes/party/views/ModalLeaveConfirm", "components/FreeScroll", "components/Scrollbar", "templates/party/SoulStrikeChange"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    return s.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump #decideBtn": "onClickDecide",
            "anchorslongtap [data-app-can-show-detail-selectedList]": "onLongTapSoulStrikeDetailView",
            "anchorslongtap [data-app-can-show-detail-list]": "onLongTapSoulStrikeDetailView"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this, e), this.resetupLayout()
        },
        resetupLayout: function() {
            if (!this.context.isInOperation()) return;
            this.contentType = "NO_BASE", this.designType = "CLASSIC", this.setupLayout()
        },
        render: function(e) {
            var t = e[0] - 0;
            this.buddyModel = FF.datastore.buddyCollection.get(t), s.prototype.render.call(this, h, {
                buddy: this.buddyModel
            }), this.renderSoulStrikeList(), this.setupComponents(), this.renderSelectedSoulStrike(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onLongTapSoulStrikeDetailView: function(e) {
            var n = t(e.target).closest("[data-app-selected-soulStrike-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-soulStrike-id]"), r = n.attr("data-app-soulStrike-id")) : r = n.attr("data-app-selected-soulStrike-id"), this.freescroll.cancelScroll(), this.openSoulStrikeDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openSoulStrikeDetail: function(e) {
            var t = this,
                n = FF.datastore.soulStrikeCollection.get(e);
            FF.modalStack.push(a, {
                initializer: function(e) {
                    return new e({
                        buddyModel: t.buddyModel,
                        soulStrikeModel: n
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        renderSoulStrikeList: function() {
            var n = this,
                r = this.buddyModel.getTmpSoulStrikeIds(),
                i = this.buddyModel.getSelectableSoulStrikeModels(),
                s = e.filter(i, function(t) {
                    return e.indexOf(r, t.get("id")) === -1
                });
            this.soulStrikeList && this.soulStrikeList.dispose(), this.soulStrikeList = new o({
                el: t("#soulStrikeList")
            }), this.soulStrikeList.render({
                soulStrikes: s,
                defaultSoulStrikeId: this.buddyModel.get("default_soul_strike_id")
            }), this.listenTo(this.soulStrikeList, "change:selectedList:selection", function(e) {
                n.selectedList.updateStatus(e)
            }), this.listenTo(this.soulStrikeList, "swap:soulStrike", this.swapSoulStrike), this.listenTo(this.soulStrikeList, "add:soulStrike", this.addSoulStrike), this.listenTo(this.soulStrikeList, "dismiss:soulStrike", this.dismissSoulStrike), this.scrollbar && this.scrollbar.updateContent()
        },
        renderSelectedSoulStrike: function() {
            var e = this;
            this.selectedList && this.selectedList.dispose(), this.selectedList = new u({
                el: t("#soulStrikeChangeInfo")
            }), this.selectedList.render({
                soulStrikes: this.buddyModel.getTmpSoulStrikeModels(),
                defaultSoulStrikeId: this.buddyModel.get("default_soul_strike_id")
            }), this.listenTo(this.selectedList, "change:soulStrike:selection", function(t) {
                e.soulStrikeList.updateStatus(t)
            }), this.listenTo(this.selectedList, "move:soulStrike:ontoEmptySlot", this.movePartyOntoEmptySlot), this.listenTo(this.selectedList, "swap:soulStrike", this.swapSoulStrike), this.listenTo(this.selectedList, "add:soulStrike", this.addSoulStrike), FF.env.isAndroid() && (this.selectedList.$el.fastCss("opacity", .99), window.setTimeout(function() {
                e.selectedList.$el.fastCss("opacity", 1)
            }, 0))
        },
        _renderSubView: function() {
            this.renderSoulStrikeList(), this.renderSelectedSoulStrike(), this._toggleDecideBtn(), FF.router.loading.unlock()
        },
        _swapTmpSoulStrike: function(e) {
            var t = e[0],
                n = e[1],
                r = this.buddyModel.getTmpSlotBySoulStrikeId(t),
                i = this.buddyModel.getTmpSlotBySoulStrikeId(n);
            r ? i ? (this.buddyModel.setTmpSoulStrikeId({
                slot: i,
                soulStrikeId: t
            }), this.buddyModel.setTmpSoulStrikeId({
                slot: r,
                soulStrikeId: n
            })) : this.buddyModel.setTmpSoulStrikeId({
                slot: r,
                soulStrikeId: n
            }) : this.buddyModel.setTmpSoulStrikeId({
                slot: i,
                soulStrikeId: t
            })
        },
        _addTmpSoulStrike: function(e) {
            this.buddyModel.setTmpSoulStrikeId({
                slot: e.order,
                soulStrikeId: e.id
            })
        },
        _resetTmpSoulStrike: function(e) {
            var t = this.buddyModel.getTmpSlotBySoulStrikeId(e.id);
            this.buddyModel.setTmpSoulStrikeId({
                slot: t,
                soulStrikeId: 0
            })
        },
        swapSoulStrike: function(e) {
            FF.router.loading.lock(), this._swapTmpSoulStrike(e), this._renderSubView()
        },
        addSoulStrike: function(e) {
            FF.router.loading.lock(), this._addTmpSoulStrike(e), this._renderSubView()
        },
        dismissSoulStrike: function(e) {
            FF.router.loading.lock(), this._resetTmpSoulStrike(e), this._renderSubView()
        },
        movePartyOntoEmptySlot: function(e) {
            FF.router.loading.lock(), this._resetTmpSoulStrike(e), this._addTmpSoulStrike(e), this._renderSubView()
        },
        _hasChanged: function() {
            return this.buddyModel.hasChangedSoulStrikeId()
        },
        _showDecideBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        _hideDecideBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        _toggleDecideBtn: function() {
            this._hasChanged() && !this._isEmptyTmpSoulStrike() ? this._showDecideBtn() : this._hideDecideBtn()
        },
        _isEmptyTmpSoulStrike: function() {
            return e.compact(this.buddyModel.getTmpSoulStrikeIds()).length === 0
        },
        onClickDecide: function() {
            var e = this;
            FF.router.loading.lock(), this.saveSoulStrikeDeferred().done(function() {
                FF.router.loading.hide(), e._back()
            })
        },
        saveSoulStrikeDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this._hasChanged() ? (r.buddySaveSoulStrikeDeferred(FF.datastore.buddyCollection.getChangedSoulStrikeInfo(), this.buddyModel.isSetTmpEquipmentByRecommend).done(function() {
                FF.datastore.fixTmpSoulStrikes(), n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        _back: function() {
            var e = this.context.isInOperation() ? this.context.getBackFragment() : "#party/equipment/" + this.buddyModel.get("id") + "/" + FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.SOULSTRIKE;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            var e = this;
            if (!this._hasChanged()) {
                this._back(), this.buddyModel.resetTmpSoulStrikes();
                return
            }
            if (this._isEmptyTmpSoulStrike()) {
                FF.router.toast.topping(t("#toast-message-no-soul-strike").text()).bake(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render()
                },
                onPop: function(t, n) {
                    n ? e.saveSoulStrikeDeferred().then(function() {
                        e._back()
                    }) : (e.buddyModel.resetTmpSoulStrikes(), e._back())
                }
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.soulStrikeList && this.soulStrikeList.dispose(), this.selectedList && this.selectedList.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/AbilityChangeList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/views/ViewBase", "templates/party/views/AbilityChangeList"], function(e, t, n, r, i, s) {
    var o = {
        "anchorsbeforejump [data-app-ability-id]": "onClickAbilityListItem",
        "anchorsbeforejump [data-app-abilitylist-dismiss]": "onClickDismissAbility"
    };
    return i.extend({
        initialize: function(e) {
            this.isInDungeon = e.isInDungeon, this.statusDisplayToggleHelper = e.statusDisplayToggleHelper, this.selectedAbilityId = e.selectedAbilityId, this.selectedEmptyCellOrder = e.selectedEmptyCellOrder, this.selectedAbilityListId = e.selectedAbilityListId
        },
        render: function(e) {
            e.isInDungeon = this.isInDungeon;
            var t = r.process(s, e),
                n = e.useNativeScroll ? "append" : "html";
            this.undelegateEvents(), this.$el[n](t), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            }), e.useNativeScroll || this.trigger("renderingStart", this.imagewatcher)
        },
        processAfterContentLoad: function() {
            i.prototype.processAfterContentLoad.call(this), this.delegateEvents(o), this.trigger("allImagesAreCompleted")
        },
        getDomName: function(e) {
            return '[data-app-ability-id="' + e + '"]'
        },
        activate: function(e) {
            t(this.getDomName(e)).addClass("is-active"), this.selectedAbilityListId = e
        },
        deactivate: function(e) {
            t(this.getDomName(e)).removeClass("is-active"), this.selectedAbilityListId = null
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickAbilityListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-ability-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate(n), this.trigger("change:abilityList:selection", {
                id: n
            })) : this.selectedAbilityListId === n ? (this.deactivate(n), this.trigger("change:abilityList:selection", {
                id: null
            })) : this.selectedAbilityId ? this.trigger("swap:ability", [this.selectedAbilityId, n]) : this.selectedEmptyCellOrder ? this.trigger("add:ability", {
                order: this.selectedEmptyCellOrder,
                id: n
            }) : (this.deactivate(this.selectedAbilityListId), this.activate(n), this.trigger("change:abilityList:selection", {
                id: n
            })), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissAbility: function() {
            if (!this.selectedAbilityId) return;
            this.blurSelectorOrder(), this.trigger("dismiss:ability", {
                id: this.selectedAbilityId
            }), this.selectedAbilityId = null, this.selectedAbilityListId = null
        },
        resetStatus: function() {
            this.updateStatus({
                id: void 0,
                order: void 0
            })
        },
        updateStatus: function(e) {
            this.selectedAbilityId = e.id, this.selectedEmptyCellOrder = e.order
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedAbilityId || this.selectedEmptyCellOrder || this.selectedAbilityListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        getSelectedIds: function() {
            return {
                selectedAbilityId: this.selectedAbilityId,
                selectedEmptyCellOrder: this.selectedEmptyCellOrder,
                selectedAbilityListId: this.selectedAbilityListId
            }
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/AbilityChangeInfo", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "templates/party/views/AbilityChangeInfo"], function(e, t, n, r, i) {
    return n.View.extend({
        events: {
            "anchorsbeforejump [data-app-selected-ability-id]": "onClickSelectedAbilityListItem",
            "anchorsbeforejump [data-app-ability-empty-cell]": "onClickEmptyList"
        },
        initialize: function(e) {},
        render: function(e) {
            var t = r.process(i, e);
            this.$el.html(t)
        },
        getDomName: function(e) {
            return '[data-app-selected-ability-id="' + e + '"]'
        },
        getDomNameOfEmptyList: function(e) {
            return '[data-app-ability-empty-cell="' + e + '"]'
        },
        activate: function(e) {
            e.type === "abilityId" && (t(this.getDomName(e.id)).addClass("is-active"), this.selectedAbilityId = e.id), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).addClass("is-active"), this.selectedEmptyCellOrder = e.order)
        },
        deactivate: function(e) {
            e.type === "abilityId" && (t(this.getDomName(e.id)).removeClass("is-active"), this.selectedAbilityId = null), e.type === "order" && (t(this.getDomNameOfEmptyList(e.order)).removeClass("is-active"), this.selectedEmptyCellOrder = null)
        },
        hasOpenedModal: function() {
            return t("[data-app-modal]").hasClass("open")
        },
        onClickSelectedAbilityListItem: function(e) {
            if (this.hasOpenedModal()) return;
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-selected-ability-id"];
            if (!n) {
                FF.SoundMgr.playNgEffect();
                return
            }
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "abilityId",
                id: n
            }), this.trigger("change:selectedList:selection", {
                id: n
            })) : this.selectedAbilityId === n ? (this.deactivate({
                type: "abilityId",
                id: n
            }), this.trigger("change:selectedList:selection", {
                id: null
            })) : this.selectedAbilityListId ? this.trigger("swap:ability", [this.selectedAbilityListId, n]) : this.selectedEmptyCellOrder ? (this.trigger("move:ability:ontoEmptySlot", {
                order: this.selectedEmptyCellOrder,
                id: n
            }), this.trigger("change:selectedList:selection", {
                id: null
            })) : this.trigger("swap:ability", [this.selectedAbilityId, n]), FF.SoundMgr.playChooseEffect()
        },
        onClickEmptyList: function(e) {
            this.blurSelectorOrder();
            var t = e.currentTarget,
                n = t.attributes["data-app-ability-empty-cell"];
            if (!n) return;
            n = parseInt(n.value, 10), this.doesNotHaveAnySelection() ? (this.activate({
                type: "order",
                order: n
            }), this.trigger("change:selectedList:selection", {
                order: n
            })) : this.selectedEmptyCellOrder === n ? (this.deactivate({
                type: "order",
                order: n
            }), this.trigger("change:selectedList:selection", {
                order: null
            })) : this.selectedAbilityListId ? this.trigger("add:ability", {
                order: n,
                id: this.selectedAbilityListId
            }) : this.selectedAbilityId && (this.trigger("move:ability:ontoEmptySlot", {
                order: n,
                id: this.selectedAbilityId
            }), this.trigger("change:selectedList:selection", {
                id: null
            })), FF.SoundMgr.playChooseEffect()
        },
        updateStatus: function(e) {
            this.selectedAbilityListId = e.id
        },
        doesNotHaveAnySelection: function() {
            return !(this.selectedAbilityId || this.selectedEmptyCellOrder || this.selectedAbilityListId)
        },
        blurSelectorOrder: function() {
            var e = t("[data-app-selector-order]");
            if (!e.length) return;
            e.blur()
        },
        dispose: function() {
            this.$el.empty(), this.undelegateEvents(), this.stopListening()
        }
    })
}), define("scenes/party/views/ModalAbilityDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalAbilityDetail", "scenes/party/helper/ItemLockViewHelper", "scenes/party/views/ModalBuddiesCanEquip"], function(e, t, n, r, i, s, o, u) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #buddiesCanEquip": "onClickBuddiesCanEquip",
            "anchorsbeforejump [data-app-toggle-lock]": "onClickToggleLock"
        },
        initialize: function(e) {
            e = e || {}, this.isRecipe = e.isRecipe, i.prototype.initialize.call(this)
        },
        onClickModalClose: function() {
            FF.modalStack.pop()
        },
        render: function(e) {
            this._abilityModel = e, this.renderContent(s, {
                ability: e,
                isRecipe: this.isRecipe
            })
        },
        onClickToggleLock: function() {
            var e = this,
                t = this._abilityModel,
                n = t.get("is_locked");
            if (n === undefined) return;
            r.toggleOneAbilityLock(t.id, !n).done(function() {
                t.set("is_locked", !n), o.updateLockButtonView(!n), FF.modalStack.isHidden() && (e.render(e._abilityModel), e.open()), FF.router.loading.hide(!0)
            })
        },
        onClickBuddiesCanEquip: function() {
            var e = this;
            FF.modalStack.push(u, {
                initDeferred: function(e) {
                    return e.setupDeferred()
                },
                renderer: function(t) {
                    t.render(e._abilityModel)
                }
            })
        }
    })
}), define("scenes/party/pages/AbilityChange", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/pages/Page", "templates/party/AbilityChange", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/ItemLockViewHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/AbilityChangeList", "scenes/party/views/AbilityChangeInfo", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalLeaveConfirm", "scenes/party/views/ModalEquipmentRemoveConfirm", "components/FreeScroll", "components/Scrollbar", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var b = e.extend(i, {
            SORT_MODULE_KEY: "ability_change"
        }),
        w = FF.env.isIOS() ? !0 : !1;
    return o.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump #decideBtn": "onClickDecideBtn",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-can-show-detail-list]": "onLongTapCharaDetailView",
            "anchorslongtap [data-app-can-show-detail-info]": "onLongTapCharaDetailView"
        },
        initialize: function(e) {
            this.buddyModel = void 0, this.slotToAbilityId = {}, this.confirmedTakeOffAbility = [], this._initSortOptions(), o.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), y.resetSceneScopeStatus(b.SORT_MODULE_KEY), this._sortOptions = y.getDefaultSortOptions(b.SORT_MODULE_KEY)
        },
        render: function(t) {
            var n = +t[0];
            this.buddyModel = FF.datastore.buddyCollection.get(n), this.slotToAbilityId = e.clone(this.buddyModel.getTmpAbilitySlotToId()), o.prototype.render.call(this, u, {
                buddy: this.buddyModel
            }), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderAbilityList(this._sortOptions), this.renderSelectedAbility(), this._updateSortOptionButtonFace(this._sortOptions)
        },
        onClickOpenSortModal: function() {
            y.openModalDeferred(b.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this._overScrollView.cleanup(), this.renderSelectedAbility(), this.renderAbilityList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        renderOverScrollView: function() {
            this._overScrollView && (this.stopListening(this._overScrollView, "requestRender"), this._overScrollView.dispose()), this._overScrollView = new s({
                displayType: "BUTTON",
                listElement: t("#abilityList")
            }), this.listenTo(this._overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new l({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        onLongTapCharaDetailView: function(e) {
            this.blurSelectorOrder(), this._overScrollView.cancelScroll();
            var n = t(e.target).closest("[data-app-selected-ability-id]"),
                r;
            n.length === 0 ? (n = t(e.target).closest("[data-app-ability-id]"), r = n.attr("data-app-ability-id")) : (r = n.attr("data-app-selected-ability-id"), n = t('[data-app-ability-id="' + r + '"]')), this.openAbilityDetail(r, n), FF.SoundMgr.playChooseEffect()
        },
        openAbilityDetail: function(e, t) {
            var n = this,
                r = FF.datastore.abilityCollection.get(e);
            FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(r)
                },
                onPop: function() {
                    n._onDetailModalClose(r, t)
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.get("is_locked");
            f.updateLockableItemElem(n, t, !1)
        },
        renderAbilityList: function(e) {
            e = e || {};
            var t = FF.datastore.abilityCollection;
            t.changeComparator(e), this.abilities = t.sort().getListForChangeDetail(this.buddyModel), this._overScrollView.updateCollectionSize(this.abilities.length), this._overScrollView.setMaxPageText(), this._renderItems()
        },
        _listenToAbilityListEvents: function() {
            var e = this;
            this.listenTo(this.abilityList, "change:abilityList:selection", function(t) {
                e.selectedList.updateStatus(t)
            }).listenTo(this.abilityList, "swap:ability", this.swapAbility).listenTo(this.abilityList, "add:ability", this.addAbility).listenTo(this.abilityList, "dismiss:ability", this.dismissAbility).listenTo(this.abilityList, "renderingStart", function(t) {
                e._overScrollView.afterRender({
                    imagewatcher: t
                })
            })
        },
        _renderItems: function() {
            var e = this,
                t = {};
            w ? this.abilityList ? this.stopListening(this.abilityList) : this.generateAbilityList(t) : (this.abilityList && (t = this.abilityList.getSelectedIds(), this.stopListening(this.abilityList), this.abilityList.dispose()), this.generateAbilityList(t)), this._listenToAbilityListEvents(), this._overScrollView.setAroundPageText();
            var n = a.getFilteringModels({
                start: this._overScrollView.getStartNum(),
                end: this._overScrollView.getEndNum(),
                collection: this.abilities
            });
            this.abilityList.render({
                buddyModel: this.buddyModel,
                renderIndex: this._overScrollView.getCurrentPage(),
                abilities: n,
                useNativeScroll: w,
                slot1AbilityId: this.slotToAbilityId.slot1,
                slot2AbilityId: this.slotToAbilityId.slot2,
                confirmedTakeOffAbility: this.confirmedTakeOffAbility
            }), w && (this._overScrollView.restartLazyLoad(), this._overScrollView.updateContent())
        },
        generateAbilityList: function(e) {
            this.abilityList = new c({
                el: t("#abilityList"),
                isInDungeon: this.isInDungeon(),
                statusDisplayToggleHelper: this.statusDisplayToggleHelper,
                selectedAbilityId: e.selectedAbilityId,
                selectedEmptyCellOrder: e.selectedEmptyCellOrder,
                selectedAbilityListId: e.selectedAbilityListId
            })
        },
        _listenToSelectedAbilityEvents: function() {
            var e = this;
            this.listenTo(this.selectedList, "change:selectedList:selection", function(t) {
                e.abilityList.updateStatus(t)
            }).listenTo(this.selectedList, "swap:ability", this.swapAbility).listenTo(this.selectedList, "add:ability", this.addAbility).listenTo(this.selectedList, "move:ability:ontoEmptySlot", this.moveAbilityOntoEmptySlot)
        },
        renderSelectedAbility: function() {
            var e = this;
            this.selectedList && (this.stopListening(this.selectedList), this.selectedList.dispose()), this.selectedList = new h({
                el: t("#selectedAbilityList")
            }), this.selectedList.render({
                abilities: this._getSlotToAbilityModel()
            }), this._listenToSelectedAbilityEvents(), FF.env.isAndroid() && (this.selectedList.$el.fastCss("opacity", .99), window.setTimeout(function() {
                e.selectedList.$el.fastCss("opacity", 1)
            }, 0))
        },
        _getSlotToAbilityModel: function() {
            return e.map(this.slotToAbilityId, function(e) {
                return FF.datastore.abilityCollection.get(e)
            })
        },
        _getModelsFilterBySelectedAbilities: function() {
            var e = this,
                t = FF.datastore.abilityCollection.filter(function(t) {
                    return e.buddyModel.canEquipAbility(t) ? t.get("id") === e.slotToAbilityId.slot1 ? !1 : t.get("id") === e.slotToAbilityId.slot2 ? !1 : !0 : !1
                });
            return t
        },
        swapAbility: function(e) {
            FF.router.loading.lock();
            var t = this;
            this._confirmTakeoffModalDeferred(e).then(function() {
                t._swapSlotToAbility(e), t._renderSubViews()
            })
        },
        addAbility: function(e) {
            FF.router.loading.lock();
            var t = this;
            this._confirmTakeoffModalDeferred([e.id]).then(function() {
                t.slotToAbilityId["slot" + e.order] = e.id, t._addEquippedBuddyImg(e.id), t._renderSubViews()
            })
        },
        dismissAbility: function(e) {
            FF.router.loading.lock(), this._removeSlotToAbilityId(e), this._removeEquippedBuddyImg(e.id), this._renderSubViews()
        },
        moveAbilityOntoEmptySlot: function(e) {
            FF.router.loading.lock(), this._removeSlotToAbilityId(e), this.slotToAbilityId["slot" + e.order] = e.id, this.renderSelectedAbility(), this._toggleDecideBtn(), FF.router.loading.unlock()
        },
        _renderSubViews: function() {
            this.renderSelectedAbility(), this._toggleDecideBtn(), this.abilityList.resetStatus(), FF.router.loading.unlock()
        },
        _removeSlotToAbilityId: function(t) {
            var n = this;
            e.each(this.slotToAbilityId, function(e, r) {
                t.id === e && (n.slotToAbilityId[r] = 0)
            })
        },
        _getOrder: function(t) {
            var n;
            return e.each(this.slotToAbilityId, function(e, r) {
                e === t && (n = r)
            }), n
        },
        _swapSlotToAbility: function(e) {
            if (e.length !== 2) throw new Error("swapAbility: Ids must be array of two ids.");
            var t = [this._getOrder(e[0]), this._getOrder(e[1])];
            if (t[0] && t[1]) this.slotToAbilityId[t[0]] = e[1], this.slotToAbilityId[t[1]] = e[0];
            else if (t[0]) this._removeEquippedBuddyImg(e[0]), this._addEquippedBuddyImg(e[1]), this.slotToAbilityId[t[0]] = e[1];
            else {
                if (!t[1]) throw new Error(sprintf("swapAbility cant swap two they are not in the ability ids: %s, %s", e[0], e[1]));
                this._removeEquippedBuddyImg(e[1]), this._addEquippedBuddyImg(e[0]), this.slotToAbilityId[t[1]] = e[0]
            }
        },
        _addEquippedBuddyImg: function(e) {
            var n = FF.datastore.abilityCollection.get(e),
                r = t("[data-app-ability-id=" + e + "]"),
                i = pUrl(this.buddyModel.get("image_path")),
                s = r.find("[data-app-equipping-buddy]");
            s.removeClass("di-n").html('<img src="' + i + '" data-app-equipping-buddy-img width="30">'), r.addClass("is-disable is-in-equip").removeClass("is-active")
        },
        _removeEquippedBuddyImg: function(e) {
            var n = FF.datastore.abilityCollection.get(e),
                r = t("[data-app-ability-id=" + e + "]"),
                i = r.find("[data-app-equipping-buddy]");
            r.find("[data-app-equipping-buddy] [data-app-equipping-buddy-img]").remove(), i.addClass("di-n"), r.removeClass("is-disable is-in-equip")
        },
        _isChanged: function() {
            var t = this.buddyModel.getTmpAbilitySlotToId();
            return !e.isEqual(t, this.slotToAbilityId)
        },
        _isEquippingMe: function(e) {
            return e ? e.get("id") === this.buddyModel.get("id") : !1
        },
        _showDecideBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        _hideDecideBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        _toggleDecideBtn: function() {
            this._isChanged() ? this._showDecideBtn() : this._hideDecideBtn()
        },
        onClickDecideBtn: function() {
            var e = this;
            FF.router.loading.lock(), this.blurSelectorOrder(), this._saveAbilityDeferred().then(function() {
                e._back()
            })
        },
        _hasEquippedSomeone: function(e) {
            return e && !this._isEquippingMe(e)
        },
        _confirmTakeoffModalDeferred: function(n) {
            var r = this,
                i = t.Deferred(),
                s, o;
            e.each(n, function(t) {
                var n = FF.datastore.abilityCollection.get(+t),
                    i = n.getEquippedBuddy(),
                    u = e.contains(r.confirmedTakeOffAbility, n.get("id"));
                if (u) return;
                r._hasEquippedSomeone(i) && (s = i, o = n)
            });
            if (!s) return i.resolve().promise();
            var u = e.contains(this.confirmedTakeOffAbility, o.get("id"));
            return u ? i.resolve().promise() : (FF.modalStack.push(v, {
                renderer: function(e) {
                    e.render({
                        equippingBuddyModel: s
                    })
                },
                onPop: function(e, t) {
                    t ? (r.confirmedTakeOffAbility.push(o.get("id")), i.resolve()) : i.reject()
                }
            }), i.promise())
        },
        _saveAbilityDeferred: function() {
            var n = this,
                i = t.Deferred();
            e.each(FF.CONST.SERVER.ABILITY.SLOTS, function(e) {
                var t = n.slotToAbilityId["slot" + e],
                    r = n.buddyModel.getTmpAbilityIdBySlot(e);
                if (r === t) return;
                n.buddyModel.setTmpAbilityId({
                    slot: e,
                    abilityId: t
                })
            });
            if (!this.buddyModel.hasChangedAbilityId()) return i.resolve().promise();
            var s = FF.datastore.buddyCollection.getChangedAbilityInfo();
            return r.buddySaveAbilityDeferred(s).done(function() {
                FF.datastore.fixTmpAbilities(), i.resolve()
            }), i.promise()
        },
        _back: function() {
            var e = "#party/equipment/" + this.buddyModel.get("id") + "/" + FF.CONST.CLIENT.PARTY_TOP_SUB_CATEGORY.ABILITY;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            var t = this,
                n = e.isEqual(this.slotToAbilityId, this.buddyModel.getTmpAbilitySlotToId());
            if (n) return this._back();
            FF.modalStack.push(d, {
                renderer: function(e) {
                    e.render()
                },
                onPop: function(e, n) {
                    n ? t._saveAbilityDeferred().then(function() {
                        t._back()
                    }) : t._back()
                }
            })
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        dispose: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this._overScrollView && this._overScrollView.dispose(), this.abilityList && this.abilityList.dispose(), this.selectedList && this.selectedList.dispose();
            var e = FF.datastore.buddyCollection;
            e.changeComparator("default"), e.sort(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityGenerationConfirm", ["underscore", "jquery", "backbone", "scenes/common/helper/MissionHelper", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalAbilityGenerationConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.abilityRecipeModel = e, this.isStartedGenerate = !1
        },
        render: function(e, t) {
            var n = this.abilityRecipeModel.get("material_id_2_num"),
                r = this.abilityRecipeModel.get("required_gil");
            this.renderContent(o, {
                abilityRecipeModel: this.abilityRecipeModel,
                requiredMaterialArray: n,
                userGil: t,
                afterGil: t - r,
                canPay: t >= r
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll-for-generation-confirm]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar-for-generation-confirm]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickDecide: function() {
            FF.router.loading.lock();
            var e = this;
            if (this.isStartedGenerate) return;
            this.isStartedGenerate = !0;
            var n = this.abilityRecipeModel.get("id"),
                s = null;
            FF.SoundMgr.playPayGilEffect(), i.generateAbilityDeferred({
                ability_id: n,
                exec: 1
            }).then(function(e) {
                return s = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return r.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                e.trigger("generateAbility", s)
            }).fail(function() {
                FF.SoundMgr.playChooseEffect(), e.end()
            })
        },
        onClickModalClose: function() {
            this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/GenerateAbilityViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "scenes/party/views/Fusion"], function(e, t, n, r, i, s, o, u) {
    var a = {
        RESULT_EFFECT_SOUND: "se_fusion_common_100061"
    };
    return o.extend({
        initialize: function(e) {
            var n = this,
                r = t.Deferred();
            this.type = e.type, this.abilityAttributes = e.abilityAttributes, this.assets = e.assets, this.increasedArg1Val = e.increasedArg1Val, this.itemId = "item-" + this.abilityAttributes.ability_id, this.touchEnabled = !1, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !0
            })
        },
        isGenerateType: function() {
            return this.type === "result_fusion"
        },
        loadViewDeferred: function() {
            var e = this,
                n = t.Deferred();
            return this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.assets).done(function() {
                e.loadLayer(), e.prepareNode(), e.fusionView = new u({
                    el: t("#content")
                }), e.ab.playNode.loadBundle(e.assetInfo.bundle).setVisible(!1), e.fusionView.render(), e.isGenerateType() ? (e.setTouchCallback(), e.ab.playNode.setVisible(!0).play("play"), e.flush(), n.resolve()) : e.ab.playNode.play("set_evolution").processDeferred("action_stop").then(function() {
                    e.setTouchCallback(), e.ab.resultNode.setVisible(!0), e.ab.seirendoNode.setVisible(!0), e.ab.playNode.setVisible(!0).play("play_evolution"), e.flush(), n.resolve()
                })
            }).fail(function() {
                FF.router.loading.hide(), n.reject()
            }), n.promise()
        },
        loadLayer: function() {
            var e = "fusion_ability";
            this.assetInfo = this.assetsManager.getAssetInfo(e), this.itemAssetInfo = this.assetsManager.getAssetInfo(this.itemId), this.fusionExecLayer = new r({
                layerName: this.assetInfo.layerName,
                assetPath: this.assetInfo.assetPath
            }), this.fusionExecLayer.activate()
        },
        prepareNode: function() {
            this.buildNode(), this.ab.resultNode.setVisible(!1), this.setImage(this.ab.fusionItemNode, "fusion_item_in_img"), this.setResultData()
        },
        buildNode: function() {
            this.ab = {}, this.ab.topNode = new i({
                layer: this.assetInfo.layerName,
                name: "top_nul"
            }), this.ab.playNode = this.ab.topNode.createChildNode("fusion_cam_nul"), this.ab.fusionItemNode = this.ab.topNode.createChildNode("fusion_item_nul"), this.ab.resultNode = this.ab.topNode.createChildNode("result_fusion_nul"), this.ab.seirendoNode = this.ab.topNode.createChildNode("seiren_do_txt"), this.ab.starNode = this.ab.topNode.createChildNode("star_nul")
        },
        setImage: function(e, t) {
            e.loadBundle(this.itemAssetInfo.bundle).setImage(t, this.itemAssetInfo.assetPath)
        },
        setResultData: function() {
            this.ab.resultNode.setText("weapon_name_txt", this.abilityAttributes.name).setText("content_txt", this.abilityAttributes.description).setText("level_num", this.abilityAttributes.grade).setImage("item_img", this.itemAssetInfo.assetPath).setImage("item_a_img", this.itemAssetInfo.assetPath).setText("number_use_num_00", this.abilityAttributes.arg1).setText("number_use_num_01", "(+" + this.increasedArg1Val + ")").setText("level_num", this.abilityAttributes.grade)
        },
        setTouchCallback: function() {
            var e = this;
            this.ab.playNode.addCallbackOnce("action_play", function() {
                FF.logger.debug("[[[[[------- アクション開始 -------]]]]]"), e.ab.topNode.addCallback("action_touch_began", function() {
                    FF.logger.debug("[[[[[------- タッチしました。結果を表示します。 -------]]]]]"), e.setupResultNode()
                }).process()
            }).addCallbackOnce("action_stop", function() {
                FF.logger.debug("[[[[[------- アクション停止 -------]]]]]"), e.setupResultNode()
            })
        },
        setupResultNode: function() {
            var e = this;
            this.ab.playNode.removeAllCallback().stop({
                descendant: !0
            }), this.ab.topNode.removeAllCallback().addCallback("action_touch_began", function() {
                if (e.touchEnabled) return;
                FF.logger.debug("[[[[[------- タッチしました。ページに戻ります。 -------]]]]]"), FF.SoundMgr.stopEffect(), e.fusionView.dispose(), e.trigger("closeAnimation"), e.touchEnabled = !0
            }), this.ab.resultNode.setVisible(!0).play(this.type), this.processStarNode(), FF.SoundMgr.playEffect(a.RESULT_EFFECT_SOUND, {
                loop: !0
            }), this.flush()
        },
        processStarNode: function() {
            this.ab.starNode.play("star_0" + this.abilityAttributes.rarity + "_e")
        },
        clearAB: function() {
            this.fusionExecLayer.destroyLayer(), this.flush()
        },
        flush: function() {
            var t = [];
            e.each(this.ab, function(e) {
                t = t.concat(e.stream), e.stream = []
            }), t.length && kickmotor.animation.processAnimation(t)
        },
        dispose: function() {
            this.clearAB(), this.ab = null, this.assetsManager.destroyAllLayer(), this.fusionView && this.fusionView.dispose(), this.stopListening(), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            })
        }
    })
}), define("scenes/party/views/AbilityGenerationList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Config", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/views/ViewBase", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalAbilityGenerationConfirm", "scenes/party/GenerateAbilityViewController", "templates/party/views/AbilityListForGenerate", "templates/party/views/AbilityMiddleCategoryTab", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    var d = e.extend({}, s, {
        ABILITY_LIST_CONTAINER_DATA_NAME: "[data-app-list-items]",
        CURRENT_CLASS_NAME: "is-current",
        LARGE_CATEGORY_ID_OF_TILE: 0
    });
    return u.extend({
        events: {
            "anchorsbeforejump [data-app-ability-list]": "onClickAbilityList",
            "anchorslongtap [data-app-ability-list]": "onLongTapAbilityDetail"
        },
        initialize: function(e) {
            var t = this;
            this.lockFlagManager = e.lockFlagManager, this.statusDisplayToggleHelper = e.statusDisplayToggleHelper, this.sortTypeOf = e.SORT_TYPE_OF, this.orderTypeOf = e.ORDER_TYPE_OF, this.abilityDisplayCategoryModel = FF.datastore.abilityDisplayCategoryModel, this.backButtonEvent = void 0, u.prototype.initialize.call(this, e)
        },
        render: function(e) {
            this.userGil = e.userGil, this.sortOptions = e.sortOptions, this.filterByBuddyModel = e.filterByBuddyModel, this.abilityRecipeCollection = e.abilityRecipeCollection, this.activeLargeCategoryId = e.activeLargeCategoryId, this.middleCategoryMap = this.abilityDisplayCategoryModel.getMiddleCategoryMapByLargeCategoryId(this.activeLargeCategoryId), this.activeMiddleCategoryId = e.activeMiddleCategoryId ? e.activeMiddleCategoryId : this.getDefaultMiddleCategoryId(this.middleCategoryMap), this.displayCategoryList = null, this.renderOverScrollView(), this.renderList(), this.renderMiddleCategoryTab()
        },
        getActiveMiddleCategoryId: function() {
            return this.activeMiddleCategoryId
        },
        getDefaultMiddleCategoryId: function(e) {
            if (!e) return;
            return Math.min.apply(null, Object.keys(e))
        },
        getCanEquipModels: function(t) {
            var n = this,
                r;
            return this.filterByBuddyModel ? r = e.filter(t, function(e) {
                return n.filterByBuddyModel.canEquipAbility(e)
            }) : r = t, e.isEmpty(r) && (r = undefined), r
        },
        getFilterByAbilityIdModelsMap: function() {
            var t = this,
                n = [],
                r = this.getAbilityRecipesInMiddleCategory();
            return this.displayCategoryList = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId), e.each(this.displayCategoryList, function(i) {
                var s = e.filter(r, function(e) {
                        return +e.get("display_category_id") === +i.id
                    }),
                    o = t.getCanEquipModels(s);
                n.push(o)
            }), n
        },
        getFilterByRarityDescModelsMap: function() {
            return this.getFilterByRarityAscModelsMap().reverse()
        },
        getFilterByRarityAscModelsMap: function() {
            var t = this.getAbilityRecipesInMiddleCategory(),
                n = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            p.isReleasedExtremeDungeons() || (n = 5);
            var r = e.range(1, n + 1),
                i = this.getCanEquipModels(t),
                s = e.groupBy(i, function(e) {
                    return e.get("rarity")
                }),
                o = e.map(r, function(e) {
                    return s[e]
                });
            return o
        },
        getFilterByCanGenerateModelsMap: function() {
            var e = this,
                t = this.getAbilityRecipesInMiddleCategory(),
                n = e.getCanEquipModels(t);
            return [n]
        },
        getAbilityRecipesInMiddleCategory: function() {
            var t = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId),
                n = {};
            e.each(t, function(e) {
                n[e.id] = !0
            });
            var r = this.abilityRecipeCollection.filter(function(e) {
                return n[e.get("display_category_id")]
            });
            return r
        },
        getModelsMap: function() {
            var e = this.sortOptions.sortType,
                t = this.sortOptions.orderType;
            if (e === this.sortTypeOf.ABILITY_ID) return this.getFilterByAbilityIdModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.DESC) return this.getFilterByRarityDescModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.ASC) return this.getFilterByRarityAscModelsMap();
            if (e === this.sortTypeOf.CAN_GENERATE) return this.getFilterByCanGenerateModelsMap()
        },
        renderList: function() {
            var t = this,
                n, r, i = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum();
            this.filterByBuddyModel ? (n = this.abilityRecipeCollection.sort().filter(function(e) {
                return t.filterByBuddyModel.canEquipAbility(e)
            }), r = n.length, n = n.slice(i, s)) : (r = this.abilityRecipeCollection.length, n = this.abilityRecipeCollection.sort().slice(i, s));
            var o = this.getModelsMap(),
                a = e.compact(o).length === 0;
            this.overScrollView.updateCollectionSize(r), this.overScrollView.setMaxPageText();
            var f = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            p.isReleasedExtremeDungeons() || (f = 5), u.prototype.render.call(this, c, {
                sortType: this.sortOptions.sortType,
                orderType: this.sortOptions.orderType,
                SORT_TYPE_OF: this.sortTypeOf,
                ORDER_TYPE_OF: this.orderTypeOf,
                buddyModel: this.filterByBuddyModel,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                abilityRecipeModels: n,
                modelsMap: o,
                isGenerateNothing: a,
                displayCategoryList: this.displayCategoryList,
                maxRarityNum: f
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            }), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            }), this.overScrollView.setIsScrollableIfSinglePage()
        },
        renderMiddleCategoryTab: function() {
            var e = r.process(h, {
                middleCategoryMap: this.middleCategoryMap,
                activeMiddleCategoryId: this.activeMiddleCategoryId
            });
            t("#abilityMiddleCategory").html(e)
        },
        processAfterRender: function() {
            var e = this;
            u.prototype.processAfterRender.call(this, arguments), this.listenToOnce(this.imagewatcher, "allImagesAreCompleted someImagesAreCompleted", function() {
                e.undelegateEvents(), e.delegateEvents(e.events), e.lockFlagManager.unlock("hasLockedList")
            })
        },
        resetOverScrollView: function() {
            this.overScrollView.reset()
        },
        renderOverScrollView: function() {
            var e = this.activeLargeCategoryId === d.LARGE_CATEGORY_ID_OF_TILE ? "TILE" : "INFINIT";
            this.overScrollView && this.resetOverScrollView(), this.overScrollView = new o({
                displayType: e,
                listElement: t(d.ABILITY_LIST_CONTAINER_DATA_NAME),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this.renderList)
        },
        onLongTapAbilityDetail: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.lockFlagManager.lock("hasLongTapped"), this.blurSelectorOrder(), this.overScrollView.cancelScroll();
            var n = this,
                r = t(e.target).closest("[data-app-ability-id]").attr("data-app-ability-id"),
                i = this.abilityRecipeCollection.get(r);
            FF.modalStack.push(a, {
                initializer: function(e) {
                    return new a({
                        isRecipe: !0
                    })
                },
                renderer: function(e) {
                    e.render(i)
                },
                onPop: function(e) {
                    n.lockFlagManager.unlock("hasLongTapped")
                }
            })
        },
        onClickAbilityList: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasLockedList", "hasLongTapped", "hasTapped"])) return;
            this.lockFlagManager.lock("hasTapped"), FF.SoundMgr.playChooseEffect(), FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = +n.attr("data-app-ability-id"),
                i = this.abilityRecipeCollection.get(r);
            this.generateModal(i)
        },
        generateModal: function(e) {
            var t = this;
            this.abilityGenerateConfirmModal = new f(e), this.abilityGenerateConfirmModal.render(this.materialCollection, this.userGil), FF.router.overlay.registerChildren(this.abilityGenerateConfirmModal), this.listenToOnce(this.abilityGenerateConfirmModal, "generateAbility", this.showAnimation).listenToOnce(this.abilityGenerateConfirmModal, "closeNotify", function() {
                t.lockFlagManager.unlock("hasTapped")
            }), this.abilityGenerateConfirmModal.open(!0)
        },
        _offBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").addClass("is-disable")
        },
        _onBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").removeClass("is-disable")
        },
        showAnimation: function(e) {
            FF.router.loading.lock(), this._offBackEvent();
            var t = this;
            kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.AbilityGenerateAnimation), this.generateController = new l({
                type: "result_fusion",
                abilityAttributes: e.generated_ability,
                assets: e.assets
            }), this.abilityGenerateConfirmModal.end(!0), this.generateController.loadViewDeferred(), this.listenToOnce(this.generateController, "closeAnimation", function() {
                t.trigger("updatePage", e), t.lockFlagManager.unlock("hasTapped"), t.generateController.dispose(), t._onBackEvent()
            })
        },
        onClickTabMiddle: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-middle-category-tab]").removeClass(d.CURRENT_CLASS_NAME), t(e.target).addClass(d.CURRENT_CLASS_NAME), this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.renderList(), this.overScrollView.updateContentWithScrollReset()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.generateController && this.generateController.dispose(), this.abilityGenerateConfirmModal && this.abilityGenerateConfirmModal.end(), u.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalBuddySelector", ["underscore", "jquery", "backbone", "lib/ModalBase", "components/FreeScroll", "components/Scrollbar", "templates/party/views/ModalBuddySelector"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-buddylist-dismiss]": "onClickDismiss",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-buddylist]": "onClickBuddy"
        },
        render: function(e) {
            this.selectedBuddyId = e.selectedBuddyId, this.renderContent(o, {
                buddies: FF.datastore.buddyCollection.models,
                selectedBuddyId: this.selectedBuddyId
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new i({
                el: t("[data-ui-freescroll-buddy-filter]")
            }), this.scrollbar = new s({
                el: t("[data-ui-scrollbar-buddy-filter]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        onClickBuddy: function(e) {
            var n = +t(e.target).attr("data-app-buddylist-id");
            FF.modalStack.pop(n)
        },
        onClickDismiss: function() {
            FF.modalStack.pop()
        },
        onClickModalClose: function() {
            FF.modalStack.pop(this.selectedBuddyId)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/AbilityGeneration", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/FuncTutorial", "scenes/common/helper/LockFlagManager", "scenes/common/helper/MissionHelper", "scenes/common/ui_module/SortModuleFacade", "scenes/party/helper/StatusDisplayToggle", "scenes/party/pages/Page", "scenes/party/views/AbilityGenerationList", "scenes/party/views/ModalBuddySelector", "templates/party/AbilityGeneration"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    var d = e.extend({}, i, {
        SORT_MODULE_KEY: "ability_generation",
        ACHIEVE_TYPE_NAMES: ["ABILITY_GENERATE"],
        CURRENT_CLASS_NAME: "is-current",
        GENERABLE_RECIPE_GRADE: 1
    });
    return l.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump #selectedBuddyBtn": "popBuddySelectorModal",
            "anchorsbeforejump [data-app-large-category-tab]": "onClickTabLarge",
            "anchorsbeforejump [data-app-middle-category-tab]": "onClickTabMiddle",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function(e) {
            l.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.lockFlagManager = new o, this.lockFlagManager.initialize(["hasLockedList", "hasLongTapped", "hasTapped"]), this.userGil = FF.datastore.userModel.get("gil"), this.selectedBuddyId = void 0, this.activeLargeCategoryId = 0, this.activeMiddleCategoryId = void 0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), a.resetSceneScopeStatus(d.SORT_MODULE_KEY), this._sortOptions = a.getDefaultSortOptions(d.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var n = t.Deferred();
            return FF.datastore.abilityGenerationRecipeCollection.hasAllData ? n.resolve().promise() : (r.getGenerationRecipesDeferred().then(function(t) {
                var r = e.map(t.recipe, function(e, t) {
                    return e[d.GENERABLE_RECIPE_GRADE].id = +t, e[d.GENERABLE_RECIPE_GRADE]
                });
                FF.datastore.abilityGenerationRecipeCollection.addAllData(r), n.resolve()
            }), n.promise())
        },
        render: function() {
            l.prototype.render.call(this, p, {
                userGil: this.userGil,
                buddyModel: this.getBuddyModelForFilter(),
                largeCategories: FF.datastore.abilityDisplayCategoryModel.getLargeCategoryMap()
            }), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper(), this.setupRender(), this.processAfterRender()
        },
        setupListBaseTmpl: function() {
            var e = t("#listBaseTmpl").text();
            t("#abilityGenerationList").append(e)
        },
        processAfterContentLoad: function() {
            l.prototype.processAfterContentLoad.call(this), s.showNavigationDeferred({
                key: "ABILITY_GENERATION",
                isTutorialIllustMultiOnly: !0,
                maxNum: 3,
                speakerClassName: "is-cid"
            }).then(u.openModalMissionClearIfNeedDeferred.bind(u))
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new f({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        getBuddyModelForFilter: function() {
            return FF.datastore.buddyCollection.get(this.selectedBuddyId)
        },
        setupRender: function() {
            this.abilityRecipeCollection = FF.datastore.abilityGenerationRecipeCollection, this.materialCollection = FF.datastore.materialCollection, this.abilityRecipeCollection.generateRequiredMaterialsData(this.materialCollection), this.abilityRecipeCollection.setHasNum(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderCollectionList: function(e) {
            e = e || {}, this.abilityRecipeCollection.changeComparator(e), this.listView && (this.listView.dispose(), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper()), this.listView = new c({
                el: t("#abilityList"),
                statusDisplayToggleHelper: this.statusDisplayToggleHelper,
                lockFlagManager: this.lockFlagManager,
                SORT_TYPE_OF: this.abilityRecipeCollection.getSortTypeOf(),
                ORDER_TYPE_OF: this.abilityRecipeCollection.getOrderTypeOf()
            }), this.listView.render({
                userGil: this.userGil,
                sortOptions: e,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                filterByBuddyModel: this.getBuddyModelForFilter(),
                abilityRecipeCollection: this.abilityRecipeCollection
            }), this.stopListening(this.listView, "updatePage", this.updatePage).listenToOnce(this.listView, "updatePage", this.updatePage)
        },
        onClickOpenSortModal: function() {
            a.openModalDeferred(d.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.listView.resetOverScrollView(), this.activeMiddleCategoryId = this.listView.getActiveMiddleCategoryId(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        updateGil: function(e) {
            t("[data-app-user-gil]").text(e), this.userGil = e, FF.datastore.userModel.set("gil", e)
        },
        updateMaterialCollection: function(t) {
            var n = 0,
                r = e.keys(t),
                i = r.length,
                s;
            for (n = 0; n < i; n++) {
                s = e.findWhere(this.materialCollection.models, {
                    id: +r[n]
                });
                var o = s.get("num") - t[r[n]];
                s.set("num", o)
            }
        },
        updateAbilityCollection: function(e) {
            FF.datastore.abilityCollection.add(e)
        },
        updateItemPossessionLimitCollection: function(e) {
            FF.datastore.itemPossessionLimitCollection.update(e)
        },
        updatePage: function(t) {
            this.updateGil(t.current_gil), this.updateMaterialCollection(t.material_id_2_num), this.updateAbilityCollection(t.generated_ability), this.updateItemPossessionLimitCollection(t.item_possession_limits);
            var n = e.keys(t.material_id_2_num);
            this.abilityRecipeCollection.updateRequiredMaterialsNum(this.materialCollection, n), this.abilityRecipeCollection.setHasNum(), this._updateSortOptionButtonFace(this._sortOptions), this.renderCollectionList(this._sortOptions), u.openModalMissionClearIfNeedDeferred()
        },
        onClickTabLarge: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-large-category-tab]").removeClass(d.CURRENT_CLASS_NAME), t(e.target).addClass(d.CURRENT_CLASS_NAME), this.activeLargeCategoryId = +t(e.target).attr("data-app-large-category-tab"), this.activeMiddleCategoryId = null, this.renderCollectionList(this._sortOptions), FF.router.loading.unlock()
        },
        onClickTabMiddle: function(e) {
            this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.listView.onClickTabMiddle(e)
        },
        popBuddySelectorModal: function() {
            var e = this;
            if (this.lockFlagManager.isLockedAnyOf(["hasLockedList", "hasLongTapped", "hasTapped"])) return;
            FF.router.loading.lock(), this.blurSelectorOrder(), FF.modalStack.push(h, {
                renderer: function(t) {
                    t.render({
                        selectedBuddyId: e.selectedBuddyId
                    })
                },
                onPop: function(t, n) {
                    if (n === e.selectedBuddyId) return;
                    e.selectedBuddyId = n, e.activeMiddleCategoryId = e.listView.getActiveMiddleCategoryId(), e.renderCollectionList(e._sortOptions), e.updateSelectedBuddyData()
                }
            })
        },
        updateSelectedBuddyData: function() {
            var e = this.getBuddyModelForFilter(),
                n = t("#selectedBuddyName"),
                r = t("#selectedBuddyImg");
            e ? (n.text(e.get("name")), r.attr("src", pUrl(e.get("image_path"))), r.removeClass("di-n")) : (n.text(n.attr("data-app-default-text")), r.removeAttr("src"), r.addClass("di-n"))
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), this.listView && this.listView.dispose(), l.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityUpgradeConfirm", ["underscore", "jquery", "backbone", "scenes/common/helper/MissionHelper", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalAbilityUpgradeConfirm", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o, u, a) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        initialize: function(e) {
            this.abilityModel = e, this.isStartedUpgrade = !1
        },
        render: function(e, t, n) {
            var r = this,
                i = this.abilityModel.id,
                s = e.required_gil,
                u = this.abilityModel.generateRequiredMaterialsData(e.material_id_2_num);
            this.renderContent(o, {
                abilityModel: this.abilityModel,
                requiredMaterials: u,
                userGil: n,
                requiredGil: s,
                afterGil: n - s,
                canPay: n >= s,
                upgradedAbility: e.upgraded_ability
            }), this.setupComponents()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t('[data-ui-freescroll="upgrade"]')
            }), this.scrollbar = new a({
                el: t('[data-ui-scrollbar="upgrade"]'),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        setupDeferred: function() {
            var e = t.Deferred(),
                n = this.abilityModel.id;
            return i.upgradeAbilityDeferred({
                user_ability_id: n,
                exec: 0
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        onClickDecide: function() {
            var e = this;
            FF.router.loading.lock();
            if (this.isStartedUpgrade) return;
            this.isStartedUpgrade = !0;
            var n = this.abilityModel.id,
                s = null;
            i.upgradeAbilityDeferred({
                user_ability_id: n,
                exec: 1
            }).then(function(e) {
                return s = e || {}, t.Deferred().resolve().promise()
            }).then(function() {
                return r.saveAchievedMissionsDeferred(s.achieved_missions)
            }).done(function() {
                e.trigger("upgradeAbility", s)
            }).fail(function() {
                e.end()
            })
        },
        onClickModalClose: function() {
            this.end()
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/AbilityUpgradeList", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Config", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/party/helper/ItemLockViewHelper", "scenes/party/views/ViewBase", "scenes/party/views/ModalAbilityDetail", "scenes/party/GenerateAbilityViewController", "scenes/party/views/ModalAbilityUpgradeConfirm", "templates/party/views/AbilityListForUpgrade", "templates/party/views/AbilityMiddleCategoryTab", "lib/ReleaseControl"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = e.extend({}, s, {
        ABILITY_LIST_CONTAINER_DATA_NAME: "[data-app-list-items]",
        CURRENT_CLASS_NAME: "is-current",
        LARGE_CATEGORY_ID_OF_TILE: 0
    });
    return a.extend({
        events: {
            "anchorsbeforejump [data-app-ability-list]": "onClickAbilityList",
            "anchorslongtap [data-app-ability-list]": "onLongTapAbilityDetail"
        },
        initialize: function(e) {
            var t = this;
            this.lockFlagManager = e.lockFlagManager, this.statusDisplayToggleHelper = e.statusDisplayToggleHelper, this.sortTypeOf = e.SORT_TYPE_OF, this.orderTypeOf = e.ORDER_TYPE_OF, this.abilityDisplayCategoryModel = FF.datastore.abilityDisplayCategoryModel, this.backButtonEvent = void 0, a.prototype.initialize.call(this, e)
        },
        render: function(e) {
            this.userGil = e.userGil, this.sortOptions = e.sortOptions, this.abilityCollection = e.abilityCollection, this.abilitiesHavingRecipe = e.abilitiesHavingRecipe, this.abilityUpgradeRecipeMap = e.abilityUpgradeRecipeMap, this.activeLargeCategoryId = e.activeLargeCategoryId, this.middleCategoryMap = this.abilityDisplayCategoryModel.getMiddleCategoryMapByLargeCategoryId(this.activeLargeCategoryId), this.activeMiddleCategoryId = e.activeMiddleCategoryId ? e.activeMiddleCategoryId : this.getDefaultMiddleCategoryId(this.middleCategoryMap), this.renderOverScrollView(), this.renderList(), this.renderMiddleCategoryTab()
        },
        getActiveMiddleCategoryId: function() {
            return this.activeMiddleCategoryId
        },
        getDefaultMiddleCategoryId: function(e) {
            if (!e) return;
            return Math.min.apply(null, Object.keys(e))
        },
        getFilterByAbilityIdModelsMap: function() {
            var t = this,
                n = [],
                r = this.getHavingAbilityRecipesInMiddleCategory(),
                i = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId);
            return e.each(i, function(t) {
                var i = e.filter(r, function(e) {
                    return +e.get("display_category_id") === +t.id
                });
                e.isEmpty(i) && (i = undefined), n.push(i)
            }), n
        },
        getFilterByRarityDescModelsMap: function() {
            return this.getFilterByRarityAscModelsMap().reverse()
        },
        getFilterByRarityAscModelsMap: function() {
            var t = this.getHavingAbilityRecipesInMiddleCategory(),
                n = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            d.isReleasedExtremeDungeons() || (n = 5);
            var r = e.range(1, n + 1),
                i = e.groupBy(t, function(e) {
                    return e.get("rarity")
                }),
                s = e.map(r, function(e) {
                    return i[e]
                });
            return s
        },
        getFilterByGradeDescModelsMap: function() {
            return this.getFilterByGradeAscModelsMap().reverse()
        },
        getFilterByGradeAscModelsMap: function() {
            var t = this.getHavingAbilityRecipesInMiddleCategory(),
                n = FF.CONST.SERVER.ABILITY.MAX_GRADE,
                r = e.range(1, n + 1),
                i = e.groupBy(t, function(e) {
                    return e.get("grade")
                }),
                s = e.map(r, function(e) {
                    return i[e]
                });
            return s
        },
        getFilterByActiveMiddleCategoryModelsMap: function() {
            var t = this,
                n = this.getHavingAbilityRecipesInMiddleCategory();
            return e.isEmpty(n) && (n = undefined), [n]
        },
        getHavingAbilityRecipesInMiddleCategory: function() {
            var t = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId),
                n = {};
            e.each(t, function(e) {
                n[e.id] = !0
            });
            var r = e.filter(this.abilitiesHavingRecipe, function(e) {
                return n[e.get("display_category_id")]
            });
            return r
        },
        getModelsMap: function() {
            var e = this.sortOptions.sortType,
                t = this.sortOptions.orderType;
            if (e === this.sortTypeOf.ABILITY_ID) return this.getFilterByAbilityIdModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.DESC) return this.getFilterByRarityDescModelsMap();
            if (e === this.sortTypeOf.RARITY && t === this.orderTypeOf.ASC) return this.getFilterByRarityAscModelsMap();
            if (e === this.sortTypeOf.CREATED_AT && t === this.orderTypeOf.DESC) return this.getFilterByActiveMiddleCategoryModelsMap();
            if (e === this.sortTypeOf.CREATED_AT && t === this.orderTypeOf.ASC) return this.getFilterByActiveMiddleCategoryModelsMap();
            if (e === this.sortTypeOf.GRADE && t === this.orderTypeOf.DESC) return this.getFilterByGradeDescModelsMap();
            if (e === this.sortTypeOf.GRADE && t === this.orderTypeOf.ASC) return this.getFilterByGradeAscModelsMap();
            if (e === this.sortTypeOf.CAN_UPGRADE) return this.getFilterByActiveMiddleCategoryModelsMap()
        },
        renderList: function() {
            var t = this.getModelsMap(),
                n = e.compact(t).length === 0,
                r = t[0] ? t[0].length : this.abilitiesHavingRecipe.length;
            this.overScrollView.updateCollectionSize(r), this.overScrollView.setMaxPageText();
            var i = this.overScrollView.getStartNum(),
                s = this.overScrollView.getEndNum(),
                o = FF.CONST.SERVER.ABILITY.MAX_RARITY;
            d.isReleasedExtremeDungeons() || (o = 5);
            var u = this.abilityDisplayCategoryModel.getSmallCategoryListByIds(this.activeLargeCategoryId, this.activeMiddleCategoryId);
            a.prototype.render.call(this, h, {
                sortType: this.sortOptions.sortType,
                orderType: this.sortOptions.orderType,
                SORT_TYPE_OF: this.sortTypeOf,
                ORDER_TYPE_OF: this.orderTypeOf,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                modelsMap: t,
                displayCategoryList: u,
                abilities: this.abilitiesHavingRecipe.slice(i, s),
                recipes: this.abilityUpgradeRecipeMap,
                isInDungeon: FF.datastore.dungeonSessionModel.isInDungeon(),
                isUpgradeNothing: n,
                maxRarityNum: o,
                maxGradeNum: FF.CONST.SERVER.ABILITY.MAX_GRADE
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            }), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            }), this.overScrollView.setIsScrollableIfSinglePage()
        },
        renderMiddleCategoryTab: function() {
            var e = r.process(p, {
                middleCategoryMap: this.middleCategoryMap,
                activeMiddleCategoryId: this.activeMiddleCategoryId
            });
            t("#abilityMiddleCategory").html(e)
        },
        processAfterRender: function() {
            var e = this;
            a.prototype.processAfterRender.call(this, arguments), this.listenToOnce(this.imagewatcher, "allImagesAreCompleted someImagesAreCompleted", function() {
                e.undelegateEvents(), e.delegateEvents(e.events), e.lockFlagManager.unlock("hasLockedList")
            })
        },
        resetOverScrollView: function() {
            this.overScrollView.reset()
        },
        renderOverScrollView: function() {
            var e = this.activeLargeCategoryId === v.LARGE_CATEGORY_ID_OF_TILE ? "TILE" : "INFINIT";
            this.overScrollView && this.resetOverScrollView(), this.overScrollView = new o({
                displayType: e,
                listElement: t(v.ABILITY_LIST_CONTAINER_DATA_NAME),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this.renderList)
        },
        onLongTapAbilityDetail: function(e) {
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.lockFlagManager.lock("hasLongTapped"), this.blurSelectorOrder(), this.overScrollView.cancelScroll();
            var n = this,
                r = t(e.target).closest("[data-app-ability-id]"),
                i = r.attr("data-app-ability-id"),
                s = this.abilityCollection.get(i);
            FF.modalStack.push(f, {
                initializer: function(e) {
                    return new f({
                        isRecipe: !1
                    })
                },
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n._onDetailModalClose(s, r), n.lockFlagManager.unlock("hasLongTapped")
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.get("is_locked");
            u.updateLockableItemElem(n, t, !1)
        },
        onClickAbilityList: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasLockedList", "hasLongTapped", "hasTapped"])) return;
            this.lockFlagManager.lock("hasTapped"), FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = +n.attr("data-app-ability-id");
            this.selectedAbilityModel = this.abilityCollection.get(r);
            if (n.hasClass("is-max-grade") || n.attr("data-app-sortie-limitation") === "") {
                this.lockFlagManager.unlock("hasTapped"), FF.router.loading.unlock(), FF.SoundMgr.playNgEffect();
                return
            }
            FF.SoundMgr.playChooseEffect(), this.generateModal()
        },
        generateModal: function() {
            var e = this;
            this.abilityUpgradeConfirmModal = new c(this.selectedAbilityModel), this.abilityUpgradeConfirmModal.setupDeferred().done(function(t) {
                e.abilityUpgradeConfirmModal.render(t, e.materialCollection, e.userGil), e.abilityUpgradeConfirmModal.open(!0)
            }), FF.router.overlay.registerChildren(this.abilityUpgradeConfirmModal), this.listenToOnce(this.abilityUpgradeConfirmModal, "upgradeAbility", this.showAnimation).listenToOnce(this.abilityUpgradeConfirmModal, "closeNotify", function() {
                e.lockFlagManager.unlock("hasTapped")
            })
        },
        _offBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").addClass("is-disable")
        },
        _onBackEvent: function() {
            this.backButtonEvent = t("[data-app-btn-back]").removeClass("is-disable")
        },
        showAnimation: function(e) {
            FF.router.loading.lock(), this._offBackEvent();
            var t = this;
            kickmotor.googleanalytics.sendScreenName(i.googleAnalytics.DIRECT_CALL_SCREEN_NAME_OF.AbilityUpgradeAnimation);
            var n = this.getIncreasedArg1Val(e);
            this.generateController = new l({
                type: "result_evolution",
                abilityAttributes: e.upgraded_ability,
                assets: e.assets,
                increasedArg1Val: n
            }), this.abilityUpgradeConfirmModal.end(!0), this.generateController.loadViewDeferred(), this.listenToOnce(this.generateController, "closeAnimation", function() {
                t.trigger("updatePage", [e, t.selectedAbilityModel]), t.lockFlagManager.unlock("hasTapped"), t._onBackEvent()
            })
        },
        getIncreasedArg1Val: function(e) {
            var t = e.upgraded_ability.arg1 - this.selectedAbilityModel.get("arg1");
            if (t < 0) throw new Error("invalid increasedArg1Val value: " + t);
            return t
        },
        onClickTabMiddle: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-middle-category-tab]").removeClass(v.CURRENT_CLASS_NAME), t(e.target).addClass(v.CURRENT_CLASS_NAME), this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.renderList(), this.overScrollView.updateContentWithScrollReset()
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.generateController && this.generateController.dispose(), this.abilityGenerateConfirmModal && this.abilityGenerateConfirmModal.end(), a.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/AbilityUpgrade", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/LockFlagManager", "scenes/common/helper/MissionHelper", "scenes/common/ui_module/SortModuleFacade", "scenes/party/helper/StatusDisplayToggle", "scenes/party/pages/Page", "scenes/party/views/AbilityUpgradeList", "templates/party/AbilityUpgrade"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = e.extend({}, i, {
        SORT_MODULE_KEY: "ability_upgrade",
        ACHIEVE_TYPE_NAMES: ["ABILITY_UPGRADE"],
        CURRENT_CLASS_NAME: "is-current"
    });
    return f.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        funcTutorialKey: "ABILITY_UPGRADE",
        isTutorialIllustOnly: !0,
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-large-category-tab]": "onClickTabLarge",
            "anchorsbeforejump [data-app-middle-category-tab]": "onClickTabMiddle",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function(e) {
            f.prototype.initialize.call(this, e), FF.SoundMgr.playCidBlacksmithBgm(), this.lockFlagManager = new s, this.lockFlagManager.initialize(["hasLockedList", "hasLongTapped", "hasTapped"]), this.userGil = FF.datastore.userModel.get("gil"), this.abilityUpgradeRecipeMap = void 0, this.selectedAbilityModel = void 0, this.activeLargeCategoryId = 0, this.activeMiddleCategoryId = void 0, this.abilityCollection = FF.datastore.abilityCollection, this.materialCollection = FF.datastore.materialCollection, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), u.resetSceneScopeStatus(h.SORT_MODULE_KEY), this._sortOptions = u.getDefaultSortOptions(h.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.getUpgradeRecipesDeferred().then(function(t) {
                e.abilityUpgradeRecipeMap = t.recipe, n.resolve()
            }), n.promise()
        },
        render: function() {
            f.prototype.render.call(this, c, {
                userGil: this.userGil,
                buddyModel: this.getBuddyModelForFilter(),
                largeCategories: FF.datastore.abilityDisplayCategoryModel.getLargeCategoryMap()
            }), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper(), this.setupRender(), this.processAfterRender()
        },
        setupListBaseTmpl: function() {
            var e = t("#listBaseTmpl").text();
            t("#abilityUpgradeList").append(e)
        },
        processAfterContentLoad: function() {
            f.prototype.processAfterContentLoad.call(this), o.openModalMissionClearIfNeedDeferred()
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new a({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        getBuddyModelForFilter: function() {
            return FF.datastore.buddyCollection.get(this.selectedBuddyId)
        },
        setupRender: function() {
            this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        setupCollection: function(e) {
            var n = this;
            e = e || {};
            var r = t("[data-app-selector-order]"),
                i = r.prop("selectedIndex"),
                s = r.find("option").eq(i),
                o = s.attr("data-app-category-type");
            this.abilityCollection.changeComparator(e, {
                categoryType: o,
                upgradeRecipeMap: this.abilityUpgradeRecipeMap
            }), this.abilityCollection.sort(), this.abilitiesHavingRecipe = this.abilityCollection.filter(function(e) {
                var t = e.get("ability_id");
                return n.abilityUpgradeRecipeMap[t]
            })
        },
        renderCollectionList: function(e) {
            e = e || {}, this.setupCollection(e), this.listView && (this.listView.dispose(), this.setupListBaseTmpl(), this.initStatusDisplayToggleHelper()), this.listView = new l({
                el: t("#abilityList"),
                statusDisplayToggleHelper: this.statusDisplayToggleHelper,
                lockFlagManager: this.lockFlagManager,
                SORT_TYPE_OF: this.abilityCollection.getSortTypeOf(),
                ORDER_TYPE_OF: this.abilityCollection.getOrderTypeOf()
            }), this.listView.render({
                userGil: this.userGil,
                sortOptions: e,
                activeLargeCategoryId: this.activeLargeCategoryId,
                activeMiddleCategoryId: this.activeMiddleCategoryId,
                abilityCollection: this.abilityCollection,
                abilitiesHavingRecipe: this.abilitiesHavingRecipe,
                abilityUpgradeRecipeMap: this.abilityUpgradeRecipeMap
            }), this.stopListening(this.listView, "updatePage", this.updatePage).listenToOnce(this.listView, "updatePage", this.updatePage)
        },
        onClickOpenSortModal: function() {
            u.openModalDeferred(h.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.listView.resetOverScrollView(), this.activeMiddleCategoryId = this.listView.getActiveMiddleCategoryId(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        updateGil: function(e) {
            t("[data-app-user-gil]").text(e), this.userGil = e, FF.datastore.userModel.set("gil", e)
        },
        updateMaterialCollection: function(t) {
            var n = 0,
                r = e.keys(t),
                i = r.length,
                s;
            for (n = 0; n < i; n++) {
                s = e.findWhere(this.materialCollection.models, {
                    id: +r[n]
                });
                var o = s.get("num") - t[r[n]];
                s.set("num", o)
            }
        },
        updateAbilityCollection: function(e) {
            this.selectedAbilityModel.set(e)
        },
        updatePage: function(e) {
            var t = e[0];
            this.selectedAbilityModel = e[1], this.updateGil(t.current_gil), this.updateMaterialCollection(t.material_id_2_num), this.updateAbilityCollection(t.upgraded_ability), this.selectedAbilityModel = null, this._updateSortOptionButtonFace(this._sortOptions), this.renderCollectionList(this._sortOptions), o.openModalMissionClearIfNeedDeferred()
        },
        onClickTabLarge: function(e) {
            if (this.lockFlagManager.isLocked("hasLockedList")) return;
            FF.router.loading.lock(), this.lockFlagManager.lock("hasLockedList"), this.blurSelectorOrder(), t("[data-app-large-category-tab]").removeClass(h.CURRENT_CLASS_NAME), t(e.target).addClass(h.CURRENT_CLASS_NAME), this.activeLargeCategoryId = +t(e.target).attr("data-app-large-category-tab"), this.activeMiddleCategoryId = null, this.renderCollectionList(this._sortOptions), FF.router.loading.unlock()
        },
        onClickTabMiddle: function(e) {
            this.activeMiddleCategoryId = +t(e.target).attr("data-app-middle-category-tab"), this.listView.onClickTabMiddle(e)
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), this.listView && this.listView.dispose(), f.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalAbilityDecompose", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalAbilityDecompose", "components/FreeScroll", "components/Scrollbar"], function(e, t, n, r, i, s, o) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-cancel]": "onClickBtnCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickBtnDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-back]": "onClickModalBack"
        },
        render: function(t) {
            var n = t.selectedIds,
                r = t.abilityMaterialId2Num,
                s = t.requiredGil,
                o = t.isConfirm,
                u = FF.datastore.userModel.get("gil"),
                a = FF.datastore.abilityCollection,
                f = e.map(n, function(e) {
                    return a.get(e)
                }),
                l = e.find(f, function(e) {
                    return e.get("rarity") >= 3
                }),
                c = l != null,
                h = FF.datastore.materialCollection,
                p = e.keys(r).sort(),
                d = h.getRarityTypeSortedList(p),
                v = !FF.env.isIOS6_x() && !FF.env.isAndroid2_x();
            this.renderContent(i, {
                abilities: f,
                abilityMaterials: d,
                abilityMaterialId2Num: r,
                userGil: u,
                requiredGil: s,
                afterGil: u - s,
                canPay: u >= s,
                isConfirm: o,
                hasRareAbility: c,
                isAnimationAvailable: v
            }), this.setupComponents(), o || FF.SoundMgr.playPayGilEffect(), v && this.activateAnimate()
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll-modal]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar-modal]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        activateAnimate: function() {
            this.listenTo(this, "openAnimationEnd", function() {
                window.setTimeout(function() {
                    t(".is-ready-for-animate").addClass("is-animate"), t(".s-anim-result").on("webkitAnimationEnd animationend", function() {
                        t(this).fastCss("overflow", "hidden")
                    })
                }, 250)
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop(), this.trigger("onClose")
        },
        onClickBtnCancel: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickModalBack: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickBtnDecide: function() {
            this.trigger("onDecide")
        }
    })
}), define("scenes/party/pages/AbilityDecompose", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/Config", "scenes/common/Constant", "scenes/common/views/OverScrollView", "scenes/common/ui_module/SortModuleFacade", "templates/party/AbilityDecompose", "templates/party/views/AbilityListForDecompose", "scenes/party/pages/Page", "scenes/party/views/ModalAbilityDetail", "scenes/party/views/ModalAbilityDecompose", "scenes/party/helper/StatusDisplayToggle", "scenes/party/helper/ItemLockViewHelper", "components/CookieMania", "lib/Mutex", "lib/TemplateRenderer"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y) {
    var i = e.extend({}, o, {
        ACTIVE_CLASS_NAME: "is-active",
        CHECKED_CLASS_NAME: "is-checked",
        CURRENT_CLASS_NAME: "is-current",
        DISABLE_CLASS_NAME: "is-disable",
        EQUIPED_CLASS_NAME: "is-in-equip",
        NUMBERLING_CLASS_NAME: "is-check-no",
        SORTIE_CLASS_NAME: "is-sortie",
        LOCKED_CLASS_NAME: "is-locked",
        UI_DISABLED_CLASS_NAME: "mbgaui-disabled",
        LIMIT_MAX_NUM: 50,
        LIMIT_SELECT_NUM: 10,
        ABILITY_LIST_CONTAINER_DATA_NAME: "[data-app-ability-list-container]",
        LABEL_SELECTED_NUM_SELECTOR: "[data-app-label-selected-num]",
        LABEL_SELECTED_COST_SELECTOR: "[data-app-label-selected-cost]",
        SORT_MODULE_KEY: "ability_decompose"
    });
    return c.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-ability-list]": "onClickAbilityList",
            "anchorslongtap    [data-app-ability-list]": "onLongTapAbilityDetail",
            "anchorsbeforejump [data-app-clear]": "onClickClear",
            "anchorsbeforejump [data-app-decompose]": "onClickDecompose"
        },
        initialize: function(e) {
            c.prototype.initialize.call(this, e), this.hasLongTap = !1, this.cookieMania = new m, this._transitionMutex = new g, this.userGil = FF.datastore.userModel.get("gil"), this.abilityCollection = FF.datastore.abilityCollection, this.materialCollection = FF.datastore.materialCollection, this.abilityRecipeMap = void 0, this.selectedIds = [], this.selectedAbilityMap = {}, this.abilityMaterialId2Num = {}, this.requiredTotalGil = 0, this.decomposableAbilities = void 0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), a.resetSceneScopeStatus(i.SORT_MODULE_KEY), this._sortOptions = a.getDefaultSortOptions(i.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = t.Deferred();
            return this.navigateFuncTutorialIfNeedDeferred().then(this.callGetUpgradeRecepesApiDeferred.bind(this)).then(function() {
                e.resolve()
            }), e.promise()
        },
        navigateFuncTutorialIfNeedDeferred: function() {
            var e = t.Deferred(),
                r = FF.datastore.userModel;
            return r.hasProceededFuncTutorial("ABILITY_DECOMPOSE") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/ability_decompose", {
                trigger: !0
            }), e.reject().promise())
        },
        callGetUpgradeRecepesApiDeferred: function() {
            var e = this,
                n = t.Deferred();
            return r.getUpgradeRecipesDeferred().then(function(t) {
                e.abilityRecipeMap = t.recipe, n.resolve()
            }), n.promise()
        },
        render: function() {
            c.prototype.render.call(this, f, {
                userGil: this.userGil
            }), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), this.collectElements()
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new d({
                toggleListParentElem: t("#abilityList"),
                maxNum: 2
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "TILE",
                listElement: t(i.ABILITY_LIST_CONTAINER_DATA_NAME)
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderCollectionList: function(e) {
            var t = this;
            e = e || {}, this.overScrollView.cleanup(), this.abilityCollection.changeComparator(e), this.abilityCollection.sort(), this.decomposableAbilities = this.abilityCollection.filter(function(e) {
                return t.abilityRecipeMap.hasOwnProperty(e.get("ability_id"))
            }), this.overScrollView.updateCollectionSize(this.decomposableAbilities.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _setupSelectionClassName: function() {
            var t = {};
            return e.each(this.selectedIds, function(e, n) {
                var r = n + 1;
                t[e] = i.CHECKED_CLASS_NAME + " " + i.NUMBERLING_CLASS_NAME + r
            }), t
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = this._setupSelectionClassName(),
                s = y.process(l, {
                    abilities: this.decomposableAbilities.slice(e, n),
                    recipes: this.abilityRecipeMap,
                    isInDungeon: this.isInDungeon(),
                    selectedIds: this.selectedIds,
                    selectionClassNameMap: r,
                    CONST: i
                }),
                o = t(i.ABILITY_LIST_CONTAINER_DATA_NAME);
            this.overScrollView.render({
                html: s,
                parentElement: o,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        collectElements: function() {
            this.selectedNumElement = t(i.LABEL_SELECTED_NUM_SELECTOR), this.selectedCostElement = t(i.LABEL_SELECTED_COST_SELECTOR)
        },
        onClickAbilityList: function(e) {
            if (this.hasLongTap || this._transitionMutex.isLocked()) return;
            this.overScrollView.cancelScroll();
            var n = t(e.target),
                r = this.isElemSelectable(n),
                i = this.isElemSelected(n);
            if (!r || !i && !this.areSelectableRemainingAbilities()) {
                FF.SoundMgr.playNgEffect();
                return
            }
            this._transitionMutex.lock(), this.blurSelectorOrder();
            var s = +n.attr("data-app-ability-id");
            i ? (this.removeAllActiveClass(), this.setupNumberingClass(n), this.removeCheckedClass(n), this.removeSelectedIds([s])) : (this.removeAllOtherActiveClass(n), this.addNumberingClass(n), this.addCheckedClass(n), this.addSelectedId(s)), this._calcDecomposeResult(), this.updateDisplay(), this.areSelectableRemainingAbilities() ? this.enableRemainingAbilities() : this.disableRemainingAbilities(), FF.SoundMgr.playChooseEffect(), this._transitionMutex.unlock()
        },
        _calcDecomposeResult: function() {
            var e = {},
                t = 0,
                n = Number(FF.CONST.SERVER.ABILITY.DECOMPOSE_ABILITY_FACTOR),
                r = Number(FF.CONST.SERVER.ABILITY.DECOMPOSE_REQUIRING_GIL_FACTOR);
            for (var i in this.selectedAbilityMap) {
                var s = this.selectedAbilityMap[i],
                    o = s.get("ability_id"),
                    u = s.get("grade"),
                    a = this.abilityRecipeMap[o],
                    f = {};
                for (var l in a) {
                    if (u < l) continue;
                    var c = a[l],
                        h = c.material_id_2_num;
                    for (var p in h) isNaN(f[p]) && (f[p] = 0), f[p] += h[p]
                }
                for (var p in f) isNaN(e[p]) && (e[p] = 0), e[p] += Math.ceil(f[p] * n)
            }
            for (var p in e) {
                var d = this.materialCollection.get(p),
                    v = e[p];
                t += Math.ceil(d.get("sale_gil") * v * r)
            }
            this.abilityMaterialId2Num = e, this.requiredTotalGil = t
        },
        updateDisplay: function() {
            this.selectedNumElement.text(this.selectedIds.length), this.selectedCostElement.text(this.requiredTotalGil), this.hasSelectedAbilities() ? this.showDecomposeBtn() : this.hideDecomposeBtn()
        },
        hasActiveClass: function(e) {
            return e.hasClass(i.ACTIVE_CLASS_NAME)
        },
        removeAllActiveClass: function() {
            t("[data-app-ability-list]").removeClass(i.ACTIVE_CLASS_NAME)
        },
        removeAllOtherActiveClass: function(e) {
            t("[data-app-ability-list]").removeClass(i.ACTIVE_CLASS_NAME), e.addClass(i.ACTIVE_CLASS_NAME)
        },
        addCheckedClass: function(e) {
            e.addClass(i.CHECKED_CLASS_NAME)
        },
        removeCheckedClass: function(e) {
            e.removeClass(i.CHECKED_CLASS_NAME)
        },
        hasCheckedClass: function(e) {
            return e.hasClass(i.CHECKED_CLASS_NAME)
        },
        hasEquipedClass: function(e) {
            return e.hasClass(i.EQUIPED_CLASS_NAME)
        },
        hasLockedClass: function(e) {
            return e.hasClass(i.LOCKED_CLASS_NAME)
        },
        isElemSelected: function(e) {
            return this.hasActiveClass(e) || this.hasCheckedClass(e)
        },
        isElemSelectable: function(e) {
            return !this.hasSortieClass(e) && !this.hasEquipedClass(e) && !this.hasLockedClass(e)
        },
        hasSortieClass: function(e) {
            return e.hasClass(i.SORTIE_CLASS_NAME)
        },
        removeDisableClass: function() {
            t("[data-app-ability-list]").removeClass(i.DISABLE_CLASS_NAME)
        },
        disableRemainingAbilities: function() {
            t("[data-app-ability-list]:not(." + i.CHECKED_CLASS_NAME + ")").addClass(i.DISABLE_CLASS_NAME)
        },
        enableRemainingAbilities: function() {
            t("[data-app-ability-list]:not(." + i.EQUIPED_CLASS_NAME + "):not(." + i.LOCKED_CLASS_NAME + "):not(." + i.CHECKED_CLASS_NAME + ")").removeClass(i.DISABLE_CLASS_NAME)
        },
        hasSelectedAbilities: function() {
            return this.selectedIds.length > 0
        },
        areSelectableRemainingAbilities: function() {
            return this.selectedIds.length < i.LIMIT_SELECT_NUM
        },
        addNumberingClass: function(e) {
            var t = this.selectedIds.length + 1;
            e.addClass(i.NUMBERLING_CLASS_NAME + t)
        },
        setupNumberingClass: function(e) {
            var n = this.selectedIds.length,
                r = this.getNumberingClass(e);
            e.removeClass(r);
            var s = +r.split(i.NUMBERLING_CLASS_NAME)[1],
                o = n - s;
            for (var u = 1; u <= o; u++) {
                var a = i.NUMBERLING_CLASS_NAME + (s + u),
                    f = t("[class*=" + a + "]");
                f.removeClass(a), f.addClass(i.NUMBERLING_CLASS_NAME + (s + u - 1))
            }
        },
        getNumberingClass: function(n) {
            var r = t(n).attr("class").split(" "),
                s = e.find(r, function(e) {
                    return e.indexOf(i.NUMBERLING_CLASS_NAME) >= 0
                });
            return s
        },
        showDecomposeBtn: function() {
            t("[data-app-clear]").removeClass(i.DISABLE_CLASS_NAME), t("[data-app-decompose]").removeClass(i.DISABLE_CLASS_NAME)
        },
        hideDecomposeBtn: function() {
            t("[data-app-decompose]").addClass(i.DISABLE_CLASS_NAME), t("[data-app-clear]").addClass(i.DISABLE_CLASS_NAME)
        },
        addSelectedId: function(e) {
            this.selectedIds.push(e), this.selectedAbilityMap[e] = this.abilityCollection.get(e)
        },
        removeSelectedIds: function(t) {
            var n = this;
            e.each(t, function(t) {
                n.selectedIds = e.without(n.selectedIds, +t), delete n.selectedAbilityMap[t]
            })
        },
        onLongTapAbilityDetail: function(e) {
            if (!FF.router.loading.lock()) return;
            this.overScrollView.cancelScroll();
            var n = t(e.target);
            if (this.isElemSelected(n)) {
                FF.router.loading.unlock();
                return
            }
            if (!this.areSelectableRemainingAbilities()) {
                FF.router.loading.unlock();
                return
            }
            if (this._transitionMutex.isLocked()) return;
            FF.SoundMgr.playChooseEffect(), this._transitionMutex.lock(), this.hasLongTap = !0, this.blurSelectorOrder();
            var r = this,
                i = n.closest("[data-app-ability-id]"),
                s = i.attr("data-app-ability-id"),
                o = this.abilityCollection.get(s);
            FF.modalStack.push(h, {
                renderer: function(e) {
                    e.render(o)
                },
                onPop: function(e) {
                    r._onDetailModalClose(o, i), r.hasLongTap = !1, r._transitionMutex.unlock()
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.get("is_locked");
            v.updateLockableItemElem(n, t, !0)
        },
        onClickClear: function() {
            if (this._transitionMutex.isLocked()) return;
            this._transitionMutex.lock(), this.blurSelectorOrder();
            var n = this;
            t("[data-app-ability-list]." + i.CHECKED_CLASS_NAME).removeClass(i.CHECKED_CLASS_NAME), t("[data-app-ability-list]." + i.ACTIVE_CLASS_NAME).removeClass(i.ACTIVE_CLASS_NAME), this.updateListItemEnabled();
            var r = t("[data-app-ability-list][class*=" + i.NUMBERLING_CLASS_NAME + "]");
            e.each(r, function(e) {
                var r = n.getNumberingClass(e);
                t(e).removeClass(r)
            }), this.removeSelectedIds(this.selectedIds), this.selectedIds.length = 0, this._calcDecomposeResult(), this.updateDisplay(), this._transitionMutex.unlock()
        },
        updateListItemEnabled: function() {
            var e = t("[data-app-ability-list]:not(." + i.CHECKED_CLASS_NAME + ", ." + i.LOCKED_CLASS_NAME + ", ." + i.SORTIE_CLASS_NAME + ", ." + i.EQUIPED_CLASS_NAME + ")");
            e.removeClass(i.DISABLE_CLASS_NAME)
        },
        onClickBack: function() {
            var e = this.context.getBackFragment() || "#party/enhancement_top";
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickDecompose: function() {
            if (!FF.router.loading.lock()) return;
            this._transitionMutex.lock(), this._callConfirmApiDeferred().then(this._openConfirmModalDeferred.bind(this)).then(this._callCompleteApiDeferred.bind(this)).then(this._openCompleteModalDeferred.bind(this)).done(this.updatePage.bind(this)).fail(function() {
                this._transitionMutex.unlock(), FF.router.loading.unlock()
            }.bind(this))
        },
        _callConfirmApiDeferred: function() {
            var e = t.Deferred();
            return r.AbilityDecomposeDeferred({
                user_ability_ids: this.selectedIds,
                displayed_ability_material_id_2_num: this.abilityMaterialId2Num,
                displayed_required_gil: this.requiredTotalGil,
                exec: 0
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        _openConfirmModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render({
                        selectedIds: n.selectedIds,
                        abilityMaterialId2Num: n.abilityMaterialId2Num,
                        requiredGil: n.requiredTotalGil,
                        isConfirm: !0
                    }), n.listenToOnce(e, "onCancel", function() {
                        n.stopListening(e, "onDecide"), r.reject()
                    }), n.listenToOnce(e, "onDecide", function() {
                        n.stopListening(e, "onCancel"), n.listenToOnce(e, "closeAnimationEnd", function() {
                            r.resolve()
                        }), FF.modalStack.pop()
                    })
                }
            }), r.promise()
        },
        _callCompleteApiDeferred: function() {
            var e = t.Deferred();
            return r.AbilityDecomposeDeferred({
                user_ability_ids: this.selectedIds,
                displayed_ability_material_id_2_num: this.abilityMaterialId2Num,
                displayed_required_gil: this.requiredTotalGil,
                exec: 1
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        _openCompleteModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.push(p, {
                renderer: function(t) {
                    t.render({
                        selectedIds: n.selectedIds,
                        abilityMaterialId2Num: n.abilityMaterialId2Num,
                        requiredGil: n.requiredTotalGil,
                        isConfirm: !1
                    }), n.listenToOnce(t, "onClose", function() {
                        n.listenToOnce(t, "closeAnimationEnd", function() {
                            r.resolve(e)
                        }), FF.modalStack.pop()
                    })
                }
            }), r.promise()
        },
        updatePage: function(e) {
            this.updateGil(e.current_gil), this.updateMaterialCollection(e.current_user_ability_material_id_2_num), this.updateAbilityCollection(e.user_ability_ids), this.updateItemPossessionLimitCollection(e.item_possession_limits), this.removeSelectedIds(this.selectedIds), this.selectedIds.length = 0, this._calcDecomposeResult(), this.updateDisplay(), this.renderCollectionList(this._sortOptions), this._transitionMutex.unlock(), FF.router.loading.hide()
        },
        updateGil: function(e) {
            t("[data-app-user-gil]").text(e), this.userGil = e, FF.datastore.userModel.set("gil", e)
        },
        updateMaterialCollection: function(e) {
            for (var t in e) {
                var n = this.materialCollection.get(Number(t));
                n.set("num", e[t])
            }
        },
        updateAbilityCollection: function(t) {
            var n = this,
                r = [];
            e.each(t, function(e) {
                r.push(n.abilityCollection.get(e))
            }), this.abilityCollection.remove(r)
        },
        updateItemPossessionLimitCollection: function(e) {
            FF.datastore.itemPossessionLimitCollection.update(e)
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        onClickOpenSortModal: function() {
            a.openModalDeferred(i.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, FF.router.loading.lock(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), FF.router.loading.unlock()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this._statusDisplayToggleHelper && this._statusDisplayToggleHelper.dispose(), this.cookieMania && this.cookieMania.dispose(), c.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/AbilityMaterialConvertSrcSelect", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/ui_module/SortModuleFacade", "scenes/common/views/OverScrollView", "scenes/party/pages/Page", "scenes/party/views/ModalAbilityMaterialDetail", "templates/party/AbilityMaterialConvertSrcSelect", "templates/party/views/AbilityMaterialConvertList", "scenes/party/helper/StatusDisplayToggle", "lib/TemplateRenderer"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = e.extend({}, i, {
        SORT_MODULE_KEY: "ability_material_convert"
    });
    return u.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump [data-app-ability-material-list]": "onClickAbilityMaterialList",
            "anchorslongtap    [data-app-ability-material-list]": "onLongTapAbilityMaterialDetail",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function(e) {
            u.prototype.initialize.call(this, e), this.userGil = FF.datastore.userModel.get("gil"), this.materialCollection = FF.datastore.materialCollection, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), s.resetSceneScopeStatus(p.SORT_MODULE_KEY), this._sortOptions = s.getDefaultSortOptions(p.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = t.Deferred(),
                r = FF.datastore.userModel;
            return r.hasProceededFuncTutorial("ABILITY_MATERIAL_CONVERT") ? e.resolve().promise() : (n.history.navigate("#func_tutorial/ability_material_convert", {
                trigger: !0
            }), e.reject().promise())
        },
        render: function(e) {
            u.prototype.render.call(this, f, {
                userGil: this.userGil
            }), this._initStatusDisplayToggleHelper(), this.renderOverScrollView(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _initStatusDisplayToggleHelper: function() {
            this._statusDisplayToggleHelper = new c({
                toggleListParentElem: t("#abilityMaterialList"),
                maxNum: 1
            })
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-list-items]")
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderCollectionList: function(e) {
            e = e || {}, this.overScrollView.cleanup(), this.materialCollection.changeComparator(e), this._availableModelList = this.materialCollection.sort().getConvertibleModels(), this.overScrollView.updateCollectionSize(this._availableModelList.length), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = h.process(l, {
                    models: this._availableModelList.slice(e, n)
                }),
                i = t("[data-app-list-items]");
            this.overScrollView.render({
                html: r,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this._statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickAbilityMaterialList: function(e) {
            FF.router.loading.lock(), this.overScrollView.cancelScroll();
            var n = t(e.target),
                r = +n.attr("data-app-ability-material-id");
            this.decide(r)
        },
        decide: function(e) {
            var t = "#party/ability_material_convert_dst_select/" + e;
            n.history.navigate(t, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("party/enhancement_top", {
                trigger: !0
            })
        },
        onLongTapAbilityMaterialDetail: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = this;
            this.overScrollView.cancelScroll(), this.hasLongTap = !0;
            var r = t(e.target),
                i = +r.attr("data-app-ability-material-id"),
                s = this.materialCollection.get(i);
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render(s)
                },
                onPop: function(e) {
                    n.hasLongTap = !1
                }
            }), FF.SoundMgr.playChooseEffect()
        },
        onClickDisplayToggle: function() {
            this._statusDisplayToggleHelper.toggleStatus()
        },
        onClickOpenSortModal: function() {
            s.openModalDeferred(p.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, FF.router.loading.lock(), this.renderCollectionList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions), FF.router.loading.unlock()
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), u.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/party/views/ModalAbilityMaterialConvert", ["underscore", "jquery", "backbone", "lib/ModalBase", "templates/party/views/ModalAbilityMaterialConvert"], function(e, t, n, r, i) {
    return r.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-btn-cancel]": "onClickBtnCancel",
            "anchorsbeforejump [data-app-btn-decide]": "onClickBtnDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-btn-back]": "onClickModalBack"
        },
        render: function(t) {
            var n = t.srcModel,
                r = t.requiredSrcNum,
                s = t.id2DstNum,
                o = t.requiredGil,
                u = t.isConfirm,
                a = FF.datastore.userModel.get("gil"),
                f = FF.datastore.materialCollection;
            f.changeComparator();
            var l = f.sort().getModelsFromIdMap(s),
                c = {};
            e.each(l, function(e) {
                var t = e.get("id");
                c[t] = e.get("num") + s[t]
            });
            var h = !FF.env.isIOS6_x() && !FF.env.isAndroid2_x();
            this.putContent(i({
                srcModel: n,
                afterSrcNum: n.get("num") - r,
                dstModelList: l,
                dstId2AfterNum: c,
                userGil: a,
                requiredGil: o,
                afterGil: a - o,
                isConfirm: u,
                isAnimationAvailable: h
            })), u || FF.SoundMgr.playPayGilEffect(), h && this.activateAnimate()
        },
        activateAnimate: function() {
            this.listenTo(this, "openAnimationEnd", function() {
                window.setTimeout(function() {
                    t(".is-ready-for-animate").addClass("is-animate"), t(".s-anim-result").on("webkitAnimationEnd animationend", function() {
                        t(this).fastCss("overflow", "hidden")
                    })
                }, 250)
            })
        },
        onClickModalClose: function() {
            FF.modalStack.pop(), this.trigger("onClose")
        },
        onClickBtnCancel: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickModalBack: function() {
            FF.modalStack.pop(), this.trigger("onCancel")
        },
        onClickBtnDecide: function() {
            this.trigger("onDecide")
        }
    })
}), define("scenes/party/pages/AbilityMaterialConvertDstSelect", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/party/pages/Page", "templates/party/AbilityMaterialConvertDstSelect", "templates/party/views/AbilityMaterialConvertDstSelectList", "templates/party/views/AbilityMaterialSelected", "scenes/party/views/ModalAbilityMaterialConvert", "components/FreeScroll", "components/Scrollbar", "components/QuantitySelector"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = e.extend({}, i, {
        HIDE_CLASS_NAME: "di-n",
        DISABLE_CLASS_NAME: "is-disable"
    });
    return s.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-clear]": "onClickClear",
            "anchorsbeforejump [data-app-confirm]": "onClickConfirm"
        },
        initialize: function(e) {
            s.prototype.initialize.call(this, e), this._initializeVariables(), this._userGil = FF.datastore.userModel.get("gil"), this._materialCollection = FF.datastore.materialCollection, this._materialCollection.changeComparator({
                sortType: FF.datastore.materialCollection.SORT_TYPE_OF.RARITY,
                orderType: FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC
            })
        },
        _initializeVariables: function() {
            this._userGil = 0, this._materialCollection = void 0, this._srcId = 0, this._srcModel = void 0, this._dstCollection = void 0, this._dstMap = {}, this._freescroll = void 0, this._scrollbar = void 0, this._quantitySelectors = [], this._id2QuantitySelector = {}, this._id2DstNum = {}, this._id2DstMaxNum = {}, this._requiredSrcTotalNum = 0, this._requiredTotalGil = 0
        },
        render: function(t) {
            this._srcId = Number(t[0]), this._srcModel = this._materialCollection.findWhere({
                id: this._srcId
            }), this._dstCollection = this._materialCollection.sort().getConvertibleAndSameTypeWithoutSameIdModels(this._srcModel);
            var n = this._dstMap;
            e.each(this._dstCollection, function(e) {
                n[e.get("id")] = e
            }), s.prototype.render.call(this, o, {
                baseAbilityMaterial: this._srcModel,
                userGil: this._userGil
            }), this._renderSelectedItem(), this._renderDstItemList(), this._renderListScroller(), this._renderQuantitySelector(), this._update(), this.processAfterRender()
        },
        _renderSelectedItem: function() {
            t("[data-app-selected-ability-material]").html(a({
                model: this._srcModel,
                afterNum: this._srcModel.get("num")
            }))
        },
        _renderDstItemList: function() {
            t("[data-app-sp-material-list-items]").html(u({
                abilityMaterialModels: this._dstCollection,
                target: this._srcModel
            }))
        },
        _renderListScroller: function() {
            this._freescroll = new l({
                el: t("[data-ui-freescroll]")
            }), this._scrollbar = new c({
                el: t("[data-ui-scrollbar]"),
                watch: this._freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        _renderQuantitySelector: function() {
            e.each(t("[data-ui-fluctuator]"), this._constructQuantitySelector.bind(this))
        },
        _constructQuantitySelector: function(e) {
            var n = this,
                r = +t(e).attr("data-app-fluctuator-ability-material-id"),
                i = this._srcModel,
                s = this._dstMap[r],
                o = i.getConvertRate(s),
                u = new h({
                    el: e,
                    incrementPerStep: o,
                    decrementPerStep: -o,
                    onIncrease: function(e) {
                        n._onQuantityUpdate(r, e)
                    },
                    onDecrease: function(e) {
                        n._onQuantityUpdate(r, e)
                    },
                    onMaximize: function(e) {
                        e.setMax(), n._onQuantityUpdate(r, e)
                    }
                });
            this._id2QuantitySelector[r] = u, this._quantitySelectors.push(u)
        },
        _onQuantityUpdate: function(e, t) {
            FF.SoundMgr.playChooseEffect(), this._id2DstNum[e] = t.getValue(), this._update()
        },
        _update: function() {
            this._calcRequiredSrcTotalNum(), this._calcRequiredTotalGil(), this._calcDstItemMaxNum(), t("[data-app-user-gil]").text(this._userGil), t("[data-app-costGil]").text(this._requiredTotalGil), t("[data-app-src-ability-material-num]").text(this._srcModel.get("num")), t("[data-app-src-ability-material-num-after]").text(this._remainingSrcNum), this._srcModel.get("num") !== this._remainingSrcNum ? t("[data-app-src-ability-material-num-after]").addClass("fc-down") : t("[data-app-src-ability-material-num-after]").removeClass("fc-down");
            for (var e in this._id2QuantitySelector) {
                var n = this._id2QuantitySelector[e],
                    r = this._id2DstMaxNum[e];
                n.changeMax(r), n.updateFluctuatorView();
                var i = this._dstMap[e],
                    s = this._id2DstNum[e] || 0;
                t('[data-app-dst-ability-material-base-num="' + e + '"]').text(i.get("num")), t('[data-app-dst-ability-material-num="' + e + '"]').text(i.get("num") + s), s ? t('[data-app-dst-ability-material-num="' + e + '"]').addClass("fc-positive") : t('[data-app-dst-ability-material-num="' + e + '"]').removeClass("fc-positive")
            }
            var o = this.canPay(),
                u = this.hasUserSelected();
            o ? this.hideGilAlert() : this.showGilAlert(), u ? this.showClearBtn() : this.hideClearBtn(), u && o ? this.showConfirmBtn() : this.hideConfirmBtn()
        },
        _calcConvertOutputNum: function(e, t, n) {
            return Math.floor(t * Math.pow(10, e - n))
        },
        _calcRequiredSrcTotalNum: function() {
            var e = 0,
                t = this._srcModel.get("rarity");
            for (var n in this._id2DstNum) {
                var r = this._id2DstNum[n],
                    i = this._dstMap[n].get("rarity"),
                    s = this._calcConvertOutputNum(i, r, t);
                e += s
            }
            this._requiredSrcTotalNum = e, this._remainingSrcNum = this._srcModel.get("num") - e
        },
        _getRequiredGil: function(e, t) {
            var n = FF.CONST.SERVER.ABILITY_MATERIAL.RARITY_TO_REQUIRED_GIL,
                r = e.get("rarity"),
                i = t.get("rarity");
            return r < i ? n[i] : t.get("sale_gil")
        },
        _calcRequiredTotalGil: function() {
            var e = 0;
            for (var t in this._id2DstNum) {
                var n = this._getRequiredGil(this._srcModel, this._dstMap[t]),
                    r = this._id2DstNum[t];
                e += n * r
            }
            this._requiredTotalGil = e
        },
        _calcDstItemMaxNum: function() {
            var e = this._srcModel,
                t = e.get("rarity"),
                n = this._userGil - this._requiredTotalGil;
            for (var r in this._dstMap) {
                var i = this._dstMap[r],
                    s = this._id2DstNum[r] || 0,
                    o = i.get("rarity"),
                    u = this._getRequiredGil(e, i),
                    a = Math.floor(n / u);
                a -= a % e.getConvertRate(i);
                var f = this._calcConvertOutputNum(t, this._remainingSrcNum, o),
                    l = s + Math.min(a, f);
                this._id2DstMaxNum[r] = l
            }
        },
        canPay: function() {
            return this._userGil >= this._requiredTotalGil
        },
        hasUserSelected: function() {
            return this._requiredSrcTotalNum > 0
        },
        showGilAlert: function() {
            t("[data-app-no-gil]").removeClass(p.HIDE_CLASS_NAME)
        },
        hideGilAlert: function() {
            t("[data-app-no-gil]").addClass(p.HIDE_CLASS_NAME)
        },
        showConfirmBtn: function() {
            t("[data-app-confirm]").removeClass(p.DISABLE_CLASS_NAME)
        },
        hideConfirmBtn: function() {
            t("[data-app-confirm]").addClass(p.DISABLE_CLASS_NAME)
        },
        showClearBtn: function() {
            t("[data-app-clear]").removeClass(p.DISABLE_CLASS_NAME)
        },
        hideClearBtn: function() {
            t("[data-app-clear]").addClass(p.DISABLE_CLASS_NAME)
        },
        _resetProperties: function() {
            this._id2DstNum = {}, this._id2DstMaxNum = {}, this._requiredSrcTotalNum = 0, this._requiredTotalGil = 0
        },
        onClickClear: function() {
            FF.router.loading.lock(), this.blurSelectorOrder(), this._resetProperties(), e.each(this._quantitySelectors, function(e) {
                e.resetValue()
            }), this._update(), FF.router.loading.unlock()
        },
        onClickConfirm: function() {
            var t = this;
            this.blurSelectorOrder(), this._callConfirmApiDeferred().then(this._openConfirmModalDeferred.bind(this)).then(this._callExecApiDeferred.bind(this)).then(this._openCompleteModalDeferred.bind(this)).done(function(n) {
                t._updateModel(n), t._resetProperties(), e.each(t._quantitySelectors, function(e) {
                    e.resetValue()
                }), t._update()
            })
        },
        _trimId2DstNum: function() {
            var t = {};
            e.map(this._id2DstNum, function(e, n) {
                e && (t[n] = e)
            }), this._id2DstNum = t
        },
        _callConfirmApiDeferred: function() {
            var e = t.Deferred();
            return this._trimId2DstNum(), r.AbilityMaterialConvertDeferred({
                src_ability_material_id: this._srcId,
                src_ability_material_num: this._requiredSrcTotalNum,
                dst_ability_material_id_2_num: this._id2DstNum,
                displayed_required_gil: this._requiredTotalGil,
                exec: 0
            }).done(function(t) {
                e.resolve(t)
            }), e.promise()
        },
        _openConfirmModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.push(f, {
                renderer: function(t) {
                    t.render({
                        srcModel: n._srcModel,
                        requiredSrcNum: n._requiredSrcTotalNum,
                        id2DstNum: n._id2DstNum,
                        requiredGil: n._requiredTotalGil,
                        isConfirm: !0
                    }), n.listenToOnce(t, "onCancel", function() {
                        n.stopListening(t, "onDecide"), r.reject()
                    }), n.listenToOnce(t, "onDecide", function() {
                        n.stopListening(t, "onCancel"), n.listenToOnce(t, "closeAnimationEnd", function() {
                            r.resolve(e)
                        }), FF.modalStack.pop()
                    })
                }
            }), r.promise()
        },
        _callExecApiDeferred: function(e) {
            var n = t.Deferred();
            return r.AbilityMaterialConvertDeferred({
                src_ability_material_id: this._srcId,
                src_ability_material_num: this._requiredSrcTotalNum,
                dst_ability_material_id_2_num: this._id2DstNum,
                displayed_required_gil: this._requiredTotalGil,
                exec: 1
            }).done(function(e) {
                n.resolve(e)
            }), n.promise()
        },
        _openCompleteModalDeferred: function(e) {
            var n = this,
                r = t.Deferred();
            return FF.modalStack.pop(), FF.modalStack.push(f, {
                renderer: function(t) {
                    t.render({
                        srcModel: n._srcModel,
                        requiredSrcNum: n._requiredSrcTotalNum,
                        id2DstNum: n._id2DstNum,
                        requiredGil: n._requiredTotalGil,
                        isConfirm: !1
                    }), n.listenToOnce(t, "onClose", function() {
                        r.resolve(e)
                    })
                }
            }), r.promise()
        },
        _updateModel: function(e) {
            FF.datastore.userModel.set("gil", e.current_gil), this._userGil = FF.datastore.userModel.get("gil");
            var t = e.current_user_ability_material_id_2_num;
            for (var n in t) {
                var r = t[n],
                    i;
                this._dstMap.hasOwnProperty(n) ? i = this._dstMap[n] : this._srcId === Number(n) && (i = this._srcModel), i && i.set("num", r)
            }
        },
        onClickBack: function() {
            n.history.navigate("party/ability_material_convert_src_select", {
                trigger: !0
            })
        },
        dispose: function() {
            this._resetProperties(), e.each(this._quantitySelectors, function(e) {
                e.dispose()
            }), this._quantitySelectors.length = 0, this._id2QuantitySelector = {}, this._freescroll && this._freescroll.dispose(), this._scrollbar && this._scrollbar.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalRecordMateriaDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalRecordMateriaDetail"], function(e, t, n, r, i, s) {
    var o = {
        BTN_ELEM_ATTR: "#modalFavoriteIcon",
        BTN_FAVORITE_CLASS_NAME: "p-favorite-locked",
        BTN_UNFAVORITE_CLASS_NAME: "p-favorite-unlocked"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump #toggleFavorite": "onClickToggleFavorite"
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        render: function(e) {
            this._recordMateria = e, this.renderContent(s, {
                recordMateria: this._recordMateria,
                equippedBuddy: this._recordMateria.getEquippedBuddy()
            })
        },
        onClickToggleFavorite: function() {
            var e = this,
                t = this._recordMateria.get("record_materia_id"),
                n = this._recordMateria.get("is_favorite");
            if (n === undefined) return;
            r.toggleOneRecordMateriaFavoriteDeferred(t, !n).done(function() {
                e._recordMateria.set("is_favorite", !n), e.updateFavoriteButtonView(!n), FF.modalStack.isHidden() && (e.render(e._recordMateria), e.open()), FF.router.loading.hide(!0)
            })
        },
        updateFavoriteButtonView: function(e) {
            var n = t(o.BTN_ELEM_ATTR),
                r = e ? o.BTN_FAVORITE_CLASS_NAME : o.BTN_UNFAVORITE_CLASS_NAME,
                i = e ? o.BTN_UNFAVORITE_CLASS_NAME : o.BTN_FAVORITE_CLASS_NAME;
            n.removeClass(i), n.addClass(r)
        }
    })
}), define("scenes/party/pages/RecordMateriaChange", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/helper/LockFlagManager", "scenes/common/views/OverScrollView", "scenes/common/ui_module/SortModuleFacade", "scenes/party/helper/CollectionsFilteringHelper", "scenes/party/helper/StatusDisplayToggle", "scenes/party/views/ModalRecordMateriaDetail", "scenes/party/views/ModalEquipmentRemoveConfirm", "scenes/party/pages/Page", "templates/party/RecordMateriaChange", "templates/party/views/RecordMateriaChangeInfo", "templates/party/views/RecordMateriaChangeList"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    var g = e.extend({}, s, {
        ITEM_ELEM_ATTR: "data-app-record-materia-id",
        FAVORITE_CLASS_NAME: "is-favorite",
        SORT_MODULE_KEY: "record_materia_change",
        CATEGORY: {
            RECORD_MATERIA: 4
        }
    });
    return p.extend({
        orderType: undefined,
        contentType: "ONLY_BTN",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-record-materia-id]": "onClickRecordMateriaListItem",
            "anchorsbeforejump #dismissBtn": "onClickDismissRecordMateria",
            "anchorsbeforejump #decideBtn": "onClickDecideBtn",
            "anchorsbeforejump #toggleStatus": "onClickDisplayToggle",
            "anchorsbeforejump #favoriteBtn": "onClickToggleFavorite",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-can-show-detail]": "onLongTapRecordMateriaDetailView"
        },
        initialize: function(e) {
            this.selectedRecordMateriaId = void 0, this._initSortOptions(), this.lockFlagManager = new o(["hasItemTapped", "hasLongTap", "isClickedDecide", "hasTappedFavorite"]), p.prototype.initialize.call(this, e)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), a.resetSceneScopeStatus(g.SORT_MODULE_KEY), this._sortOptions = a.getDefaultSortOptions(g.SORT_MODULE_KEY)
        },
        render: function(e) {
            var t = +e[0];
            this.slot = +e[1], this.buddyModel = FF.datastore.buddyCollection.get(t), this.equippedRecordMateriaModel = this.buddyModel.getRecordMateriaBySlot(this.slot), p.prototype.render.call(this, d, {
                buddy: this.buddyModel
            }), this.renderSelectedRecordMateria(this.equippedRecordMateriaModel), this.renderOverScrollView(), this.initStatusDisplayToggleHelper(), this.renderRecordMateriaList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        onClickOpenSortModal: function() {
            a.openModalDeferred(g.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderRecordMateriaList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        renderSelectedRecordMateria: function(e) {
            var n = r.process(v, {
                    model: e
                }),
                i = t("#recordMateriaChangeInfo");
            i.html(n)
        },
        renderOverScrollView: function() {
            this._overScrollView && this._overScrollView.dispose(), this._overScrollView = new u({
                displayType: "BUTTON",
                listElement: t("#recordMateriaList")
            }), this.listenTo(this._overScrollView, "requestRender", this._renderItems)
        },
        initStatusDisplayToggleHelper: function() {
            this.statusDisplayToggleHelper = new l({
                toggleListParentElem: t("#recordMateriaList"),
                maxNum: 1
            })
        },
        onLongTapRecordMateriaDetailView: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasTappedFavorite", "hasLongTap", "hasItemTapped"])) return;
            this.lockFlagManager.lock("hasLongTap"), this.blurSelectorOrder(), this._overScrollView.cancelScroll();
            var n = t(e.target).closest("[" + g.ITEM_ELEM_ATTR + "]"),
                r = n.attr(g.ITEM_ELEM_ATTR);
            this.openRecordMateriaDetail(r, n), FF.SoundMgr.playChooseEffect()
        },
        openRecordMateriaDetail: function(e, t) {
            var n = this,
                r = FF.datastore.recordMateriaCollection.get(e);
            FF.modalStack.push(c, {
                renderer: function(e) {
                    e.render(r)
                },
                onPop: function() {
                    n._onDetailModalClose(r, t), n.lockFlagManager.unlock("hasLongTap")
                }
            })
        },
        _onDetailModalClose: function(e, t) {
            var n = e.isFavorite(),
                r = e.get("record_materia_id") === this._getSelectedRecordMateriaId();
            r && this.renderSelectedRecordMateria(e), this._updateFavoriteItemElem(n, t, !1)
        },
        _updateFavoriteItemElem: function(e, t) {
            if (e === undefined) return;
            e ? t.addClass(g.FAVORITE_CLASS_NAME) : t.removeClass(g.FAVORITE_CLASS_NAME)
        },
        renderRecordMateriaList: function(e) {
            e = e || {};
            var t = FF.datastore.recordMateriaCollection;
            t.changeComparator(e), t.sort(), this.recordMaterias = t.getModelsThatExcludesModels([this.equippedRecordMateriaModel]), this._overScrollView.cleanup(), this._overScrollView.updateCollectionSize(this.recordMaterias.length), this._overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = f.getFilteringModels({
                    start: this._overScrollView.getStartNum(),
                    end: this._overScrollView.getEndNum(),
                    collection: this.recordMaterias
                }),
                n = r.process(m, {
                    buddyModelId: this.buddyModel.get("buddy_id"),
                    isInDungeon: this.isInDungeon(),
                    renderIndex: this._overScrollView.getCurrentPage(),
                    recordMaterias: e,
                    selectedRecordMateriaId: this._getSelectedRecordMateriaId()
                }),
                i = t("#recordMateriaList");
            this._overScrollView.render({
                html: n,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this.statusDisplayToggleHelper.applyToggleStatus(), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickRecordMateriaListItem: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasTappedFavorite", "hasLongTap", "hasItemTapped"])) return;
            this.lockFlagManager.lock("hasItemTapped"), FF.router.loading.lock(), this.blurSelectorOrder();
            var n = t(e.target),
                r = n.attr(g.ITEM_ELEM_ATTR);
            if (!r || n.hasClass("is-sortie")) {
                FF.router.loading.unlock(), FF.SoundMgr.playNgEffect(), this.lockFlagManager.unlock("hasItemTapped");
                return
            }
            r = parseInt(r, 10);
            var i = FF.datastore.recordMateriaCollection.get(r),
                s = this.switchFocus(+r),
                o;
            s ? (this._setSelectedRecordMateriaId(i ? r : null), this.renderSelectedRecordMateria(i), this.showDecideBtn()) : (this._setSelectedRecordMateriaId(void 0), this.renderSelectedRecordMateria(this.equippedRecordMateriaModel), this.hideDecideBtn()), this.lockFlagManager.unlock("hasItemTapped"), FF.router.loading.unlock(), FF.SoundMgr.playChooseEffect()
        },
        onClickDismissRecordMateria: function() {
            if (!this.equippedRecordMateriaModel) return;
            FF.router.loading.lock(), this.blurSelectorOrder();
            var e = 0,
                t = this.switchFocus(null);
            t ? (this._setSelectedRecordMateriaId(null), this.renderSelectedRecordMateria(), this.showDecideBtn()) : (this._setSelectedRecordMateriaId(void 0), this.renderSelectedRecordMateria(this.equippedRecordMateriaModel), this.hideDecideBtn()), FF.router.loading.unlock()
        },
        _setSelectedRecordMateriaId: function(e) {
            this.selectedRecordMateriaId = e
        },
        _getSelectedRecordMateriaId: function() {
            return this.selectedRecordMateriaId
        },
        _hasSelectedRecordMateria: function() {
            return !!this._getSelectedRecordMateriaId()
        },
        switchFocus: function(n) {
            var r = !1;
            return n !== null ? (t("#dismissBtn").removeClass("is-active"), e.each(t("[" + g.ITEM_ELEM_ATTR + "]"), function(e) {
                var i = +t(e).attr(g.ITEM_ELEM_ATTR);
                n !== i || t(e).hasClass("is-active") ? t(e).removeClass("is-active") : (t(e).addClass("is-active"), r = !0)
            })) : (e.each(t("[" + g.ITEM_ELEM_ATTR + "]"), function(e) {
                t(e).removeClass("is-active")
            }), t("#dismissBtn").hasClass("is-active") ? t("#dismissBtn").removeClass("is-active") : (t("#dismissBtn").addClass("is-active"), r = !0)), r
        },
        showDecideBtn: function() {
            t("#decideBtn").removeClass("is-disable")
        },
        hideDecideBtn: function() {
            t("#decideBtn").addClass("is-disable")
        },
        onClickDecideBtn: function() {
            if (this.lockFlagManager.isLocked("isClickedDecide")) return;
            this.lockFlagManager.lock("isClickedDecide"), FF.router.loading.lock(), this.blurSelectorOrder(), this.decide()
        },
        decide: function() {
            FF.router.loading.lock();
            var e = this,
                t = this._getSelectedRecordMateriaId() ? this._getSelectedRecordMateriaId() : 0,
                n = this.buddyModel.setTmpRecordMateriaId({
                    slot: this.slot,
                    recordMateriaId: t,
                    dryrun: !0
                }),
                r = n.equippingBuddy;
            r ? this.generateConfirmModal({
                slot: this.slot,
                recordMateriaId: t,
                equippingBuddyModel: r
            }) : (this.buddyModel.setTmpRecordMateriaId({
                slot: this.slot,
                recordMateriaId: t
            }), this.saveRecordMateriaDeferred().done(function() {
                FF.router.loading.hide(), e._back()
            }))
        },
        generateConfirmModal: function(e) {
            var t = this,
                n = e.equippingBuddyModel,
                r = e.slot,
                i = e.recordMateriaId;
            FF.modalStack.push(h, {
                renderer: function(e) {
                    e.render({
                        equippingBuddyModel: n
                    })
                },
                onPop: function(e, n) {
                    n ? (t.buddyModel.setTmpRecordMateriaId({
                        slot: r,
                        recordMateriaId: i
                    }), t.saveRecordMateriaDeferred().done(function() {
                        t._back()
                    })) : t.lockFlagManager.unlock("isClickedDecide")
                }
            })
        },
        saveRecordMateriaDeferred: function() {
            var e = t.Deferred();
            if (!this.buddyModel.hasChangedRecordMateriaId()) return e.resolve().promise();
            var n = FF.datastore.buddyCollection.getChangedRecordMateriaInfo();
            return i.buddySaveRecordMateriaDeferred(n).done(function() {
                FF.datastore.fixTmpRecordMaterias(), e.resolve()
            }), e.promise()
        },
        _back: function() {
            var e = "#party/equipment/" + this.buddyModel.get("id") + "/" + g.CATEGORY.RECORD_MATERIA;
            n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickBack: function() {
            this._back()
        },
        _addFooterEvent: function(e) {
            FF.router.globalcontrol.offAnchorsEventInGlobalNavigation(), t(".g-navigation [data-mbgaui-anchors]").on("anchorsbeforejump", e)
        },
        onClickDisplayToggle: function() {
            this.statusDisplayToggleHelper.toggleStatus()
        },
        onClickToggleFavorite: function(e) {
            if (this.lockFlagManager.isLockedAnyOf(["hasTappedFavorite", "hasLongTap", "hasItemTapped"])) return;
            this.lockFlagManager.lock("hasTappedFavorite");
            var n = this,
                r = t(e.target).attr("data-app-favorite-model-id");
            if (r === undefined) return;
            var s = FF.datastore.recordMateriaCollection.get(r),
                o = s.isFavorite();
            if (o === undefined) return;
            i.toggleOneRecordMateriaFavoriteDeferred(r, !o).done(function() {
                s.set("is_favorite", !o), n.renderSelectedRecordMateria(s), n._hasSelectedRecordMateria() && t("[" + g.ITEM_ELEM_ATTR + '="' + r + '"]').toggleClass(g.FAVORITE_CLASS_NAME), n.lockFlagManager.unlock("hasTappedFavorite"), FF.router.loading.hide()
            })
        },
        dispose: function() {
            this.lockFlagManager && this.lockFlagManager.dispose(), this._overScrollView && this._overScrollView.dispose(), this.statusDisplayToggleHelper && this.statusDisplayToggleHelper.dispose();
            var e = FF.datastore.recordMateriaCollection;
            e.changeComparator("default"), e.sort(), p.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/BuddyEvolutionViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/CommonAssetsManager", "lib/EventBase", "util"], function(e, t, n, r, i, s, o, u) {
    var a = {
        DESTORY_TIMER_MSEC: 5e3
    };
    return o.extend({
        initialize: function(e) {
            FF.logger.debug("init buddy evolution view controller"), this.assetsManager = void 0, this.mainLayerName = void 0, this.buddyEvolutionNode = void 0, this.evolvedData = e, this.memoryCrystalId = e.user_memory_crystal.memory_crystal_id
        },
        loadAssetsDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.env.isNative() ? (this.assetsManager = new s, this.assetsManager.populateAssetsDeferred(this.evolvedData.assets).then(function() {
                var t = sprintf("memory-crystal-evolve-%d", e.memoryCrystalId),
                    n = e.assetsManager.getAssetInfo(t);
                e.mainLayerName = "layer_buddy_evolve", e.buddyEvolutionNode = (new i({
                    name: "buddy_evolution_nul",
                    layer: e.mainLayerName
                })).loadBundle(n.bundle).setImage("crystal_img", n.assetPath).process()
            }).then(function() {
                n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        applyEffect: function() {
            var e = this.evolvedData.buddy.evolution_num;
            (new i({
                name: sprintf("front_effect_%02d", e),
                layer: this.mainLayerName
            })).setVisible(!0).process(), (new i({
                name: sprintf("back_effect_%02d", e),
                layer: this.mainLayerName
            })).setVisible(!0).process()
        },
        loadAndPlayAllDeffered: function(e) {
            var n = this,
                r = t.Deferred();
            return this.loadAssetsDeferred(e).then(function() {
                return n.applyEffect(), n.playBuddyEvolutionInDeferred()
            }).then(function() {
                return n.playBuddyEvolutionLoop()
            }).then(function() {
                return n.playBuddyEvolutionOutDeferred()
            }).then(function() {
                r.resolve()
            }), r.promise()
        },
        playBuddyEvolutionInDeferred: function() {
            return this.buddyEvolutionNode ? this.buddyEvolutionNode.setVisible(!0).play("in").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        playBuddyEvolutionLoop: function() {
            var e = this;
            if (!this.buddyEvolutionNode) return;
            return this.buddyEvolutionNode.setVisible(!0).play("loop").process()
        },
        playBuddyEvolutionOutDeferred: function() {
            return this.buddyEvolutionNode ? this.buddyEvolutionNode.setVisible(!0).play("out").processDeferred("action_stop") : t.Deferred().resolve().promise()
        },
        dispose: function() {
            this.assetsManager && this.assetsManager.destroyAllLayer(), this.assetsManager = null, this.mainLayerName = null, this.buddyEvolutionNode = null
        }
    })
}), define("scenes/party/views/ModalBuddyEvolution", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalBuddyEvolution"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-decide]": "onClickDecide"
        },
        initialize: function() {
            i.prototype.initialize.call(this)
        },
        render: function(e) {
            var t = e.evolvedData.memoryCrystalIds,
                n = s({
                    isConfirm: e.isConfirm,
                    isOpenOnly: e.isOpenOnly,
                    buddyModel: e.buddyModel,
                    isMaxLv: e.buddyModel.isMaxLv(),
                    canEvolveByRecipes: e.buddyModel.canEvolveByRecipes(e.recipe),
                    evolvedData: e.evolvedData.buddy,
                    nextRecordMateriaObj: e.nextRecordMateriaObj,
                    recipe: e.recipe,
                    isAnimationAvailable: !FF.env.isIOS6_x() && !FF.env.isAndroid2_x()
                });
            this.putContent(n)
        },
        onClickDecide: function() {
            this.trigger("decide")
        },
        onClickModalClose: function() {
            this.end(), this.trigger("buddyEvolutionModalClose")
        },
        dispose: function() {
            i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/BuddyEvolution", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/party/Api", "scenes/common/Constant", "scenes/common/collections/Buddy", "scenes/common/views/OverScrollView", "scenes/party/BuddyEvolutionViewController", "templates/party/BuddyEvolution", "templates/party/views/BuddyEvolutionList", "./Page", "../views/ModalBuddyEvolution", "../views/ModalCharacterDetail", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        SORT_MODULE_KEY: "buddy_evolution",
        FIRST_OPENED_SLOT: 1
    };
    return c.extend({
        categoryType: "enhancement",
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-buddyList]": "onClickBuddyList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorsbeforejump [data-app-memory-crystal-list]": "onClickMemoryCrystal",
            "anchorslongtap [data-app-buddyList]": "onLongTapBuddyDetail"
        },
        initialize: function(e) {
            c.prototype.initialize.call(this, e), this.isLocked = !1, this.hasLongTap = !1, this.selectedBuddyModel = void 0, this.memoryCrystalCollection = FF.datastore.memoryCrystalCollection, this.evolvedData = void 0, this._initSortOptions()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), d.resetSceneScopeStatus(v.SORT_MODULE_KEY), this._sortOptions = d.getDefaultSortOptions(v.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.datastore.stash.buddyEvolutionRecipesMap ? n.resolve().promise() : (i.getBuddyEvolutionRecipesDeferred().then(function(e) {
                FF.datastore.stash.buddyEvolutionRecipesMap = e.evolution_recipe, FF.datastore.stash.buddyIdToNextRecordMateriaMap = e.buddy_id_to_record_materia_map, n.resolve()
            }), n.promise())
        },
        render: function() {
            c.prototype.render.call(this, f), this.setupBuddyModelsList(), this.renderOverScrollView(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "TILE",
                listElement: t("[data-app-buddyList-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this.renderItems)
        },
        renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = l({
                    buddies: this.evolvableBuddyCollection.sort().slice(e, n)
                }),
                i = t("[data-app-buddyList-container]");
            this.overScrollView.render({
                html: r,
                parentElement: i,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickOpenSortModal: function() {
            d.openModalDeferred(v.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        onClickMemoryCrystal: function() {
            FF.router.navigate("#achievement_room/memory_crystal", {
                trigger: !0,
                params: {
                    backFragment: location.hash
                }
            })
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        getMemoryCrystalIds: function() {
            var t = this,
                n = this.selectedBuddyModel.get("buddy_id"),
                r = this.selectedBuddyModel.get("evolution_num"),
                i = FF.datastore.stash.buddyEvolutionRecipesMap[n][r + 1];
            return e.map(i, function(e) {
                return e.memory_crystal_id
            })
        },
        setupBuddyModelsList: function() {
            var t = this;
            this.evolvableBuddyCollection || (this.evolvableBuddyCollection = new o), this.evolvableBuddyCollection.reset();
            var n = [];
            e.each(FF.datastore.stash.buddyEvolutionRecipesMap, function(t, r) {
                var i = FF.datastore.buddyCollection.findWhere({
                    buddy_id: +r
                });
                if (!i || e.isEmpty(t)) return;
                var s = i.get("evolution_num");
                if (!t[s + 1]) return;
                n.push(i)
            }), t.evolvableBuddyCollection.add(n)
        },
        renderBuddyList: function(e) {
            e = e || {}, this.evolvableBuddyCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this.evolvableBuddyCollection.length), this.overScrollView.setMaxPageText();
            var t = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > t && this.overScrollView.setCurrentPage(t), this.renderItems()
        },
        getBuddyEvolveDataDeferred: function(e) {
            var n = this,
                r = e.exec,
                s = t.Deferred(),
                o = this.selectedBuddyModel.id,
                u = this.getMemoryCrystalIds();
            return i.BuddyEvolveDeferred({
                user_buddy_id: o,
                user_memory_crystal_ids: u,
                exec: r
            }).done(function(e) {
                e.memoryCrystalIds = u, n.evolvedData = e, s.resolve()
            }), s.promise()
        },
        updateData: function() {
            var e = this.evolvedData,
                t = this.selectedBuddyModel.get("buddy_id"),
                n = this.selectedBuddyModel.get("evolution_num");
            delete FF.datastore.stash.buddyEvolutionRecipesMap[t][n + 1], this.memoryCrystalCollection.remove(e.memoryCrystalIds), this.setupBuddyModelsList(), this.selectedBuddyModel.set(e.buddy), FF.datastore.stash.buddyIdToNextRecordMateriaMap[t] = e.next_record_materia
        },
        onLongTapBuddyDetail: function(e) {
            this.hasLongTap = !0, this.blurSelectorOrder();
            var n = t(e.target).closest("[data-app-buddyList]"),
                r = n.attr("data-app-buddyList-id");
            this.overScrollView.cancelScroll(), this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = this;
            this.selectedBuddyModel = this.evolvableBuddyCollection.get(e), FF.modalStack.push(p, {
                renderer: function(e) {
                    e.render(t.selectedBuddyModel)
                },
                onPop: function(e) {
                    t.hasLongTap = !1
                }
            })
        },
        openEvolutionModal: function(e) {
            var t = this,
                n = this.evolvedData,
                r = this.selectedBuddyModel.get("buddy_id"),
                i = this.selectedBuddyModel.get("evolution_num"),
                s = FF.datastore.stash.buddyEvolutionRecipesMap[r][i + 1],
                o = e.nextRecordMateriaObj,
                u = e.isConfirm,
                a = e.isOpenOnly;
            this.modalBuddyEvolution = new h, this.modalBuddyEvolution.render({
                buddyModel: this.selectedBuddyModel,
                evolvedData: n,
                recipe: s,
                nextRecordMateriaObj: o,
                canEvolveByRecipes: this.selectedBuddyModel.canEvolveByRecipes(s),
                isConfirm: u,
                isOpenOnly: a
            }), FF.router.overlay.registerChildren(this.modalBuddyEvolution), this.modalBuddyEvolution.open(), this.listenToOnce(this.modalBuddyEvolution, "buddyEvolutionModalClose", function() {
                t.isLocked = !1, t.hasLongTap = !1
            })
        },
        openEvolutionResultModal: function() {
            var e = this.evolvedData,
                t = this.selectedBuddyModel.get("buddy_id"),
                n = void 0,
                r = !1;
            e.record_materia ? n = e.record_materia : e.new_record_materia && (n = e.new_record_materia, r = !0), this.openEvolutionModal({
                isConfirm: !1,
                nextRecordMateriaObj: n,
                isOpenOnly: r
            }), this.listenToOnce(this.modalBuddyEvolution, "openAnimationEnd", this.onOpenAnimationEnd).listenToOnce(this.modalBuddyEvolution, "closeNotify", this.onCloseNotify)
        },
        onOpenAnimationEnd: function() {
            !FF.env.isIOS6_x() && !FF.env.isAndroid2_x() && t("[data-app-animation-wrap]").addClass("is-animate")
        },
        onCloseNotify: function() {
            this.updateData(), this.overScrollView.cleanup(), this.renderBuddyList(this._sortOptions), this.selectedBuddyModel = void 0
        },
        playBuddyEvolutionEffectDeferred: function() {
            var e = this,
                n = t.Deferred(),
                r = this.evolvedData,
                i = this.selectedBuddyModel.get("buddy_id");
            return e.buddyEvolutionViewController = new a(r), e.buddyEvolutionViewController.loadAndPlayAllDeffered().then(function() {
                e.buddyEvolutionViewController.dispose(), n.resolve()
            }), n.promise()
        },
        onClickBuddyList: function(e) {
            if (this.hasLongTap) return;
            var n = this,
                r = t(e.target),
                i = +r.attr("data-app-buddyList-id");
            if (r.hasClass("is-sortie")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            FF.router.loading.lock(), FF.SoundMgr.playChooseEffect(), this.blurSelectorOrder(), this.selectedBuddyModel = this.evolvableBuddyCollection.get(i), this.getBuddyEvolveDataDeferred({
                exec: 0
            }).done(function() {
                n.openEvolutionModal({
                    isConfirm: !0
                }), n.listenToOnce(n.modalBuddyEvolution, "decide", n.onClickDecide), n.listenToOnce(n.modalBuddyEvolution, "closeNotify", function() {
                    n.selectedBuddyModel = void 0
                })
            })
        },
        onClickDecide: function() {
            if (this.isLocked) return;
            this.isLocked = !0, FF.router.loading.lock();
            var e = this;
            this.getBuddyEvolveDataDeferred({
                exec: 1
            }).done(function() {
                var t = e.evolvedData;
                FF.datastore.recordMateriaCollection.add(t.record_materia), t.record_materia && (e.selectedBuddyModel.setTmpRecordMateriaId({
                    slot: v.FIRST_OPENED_SLOT,
                    recordMateriaId: t.record_materia.record_materia_id
                }), FF.datastore.fixTmpRecordMaterias()), e.playBuddyEvolutionEffectDeferred().then(function() {
                    e.listenToOnce(e.modalBuddyEvolution, "closeAnimationEnd", e.openEvolutionResultModal), e.modalBuddyEvolution.end(!0), e.isLocked = !1, FF.router.loading.unlock()
                })
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.evolvableBuddyCollection && this.evolvableBuddyCollection.reset(), this.modalBuddyEvolution && this.modalBuddyEvolution.dispose(), c.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/DressRecord", ["underscore", "jquery", "backbone", "scenes/party/Api", "scenes/common/Constant", "scenes/common/collections/Buddy", "scenes/common/views/OverScrollView", "templates/party/DressRecordPartyList", "templates/party/views/DressRecordPartyListItem", "scenes/party/pages/Page", "scenes/party/views/ModalCharacterDetail", "scenes/common/ui_module/SortModuleFacade", "scenes/common/helper/DressRecordTutorial"], function(e, t, n, r, i, s, o, u, a, f, l, c, h) {
    var p = {
        SORT_MODULE_KEY: "dress_record_buddy",
        FIRST_OPENED_SLOT: 1
    };
    return f.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        categoryType: "enhancement",
        events: {
            "anchorsbeforejump [data-app-buddylist]": "onClickBuddyList",
            "anchorsbeforejump [data-app-sortie-limitation]": "onClickSortieLimitation",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal",
            "anchorslongtap [data-app-buddylist]": "onLongTapBuddyDetail"
        },
        initialize: function(e) {
            f.prototype.initialize.call(this, e), this.isLocked = !1, this.hasLongTap = !1, this.selectedBuddyModel = void 0, this._initSortOptions()
        },
        processAfterContentLoad: function() {
            f.prototype.processAfterContentLoad.call(this), h.navigateIfNeedDeferred()
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), c.resetSceneScopeStatus(p.SORT_MODULE_KEY), this._sortOptions = c.getDefaultSortOptions(p.SORT_MODULE_KEY)
        },
        render: function() {
            f.prototype.render.call(this, u), this.setupBuddyModelsList(), this.renderOverScrollView(), this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new o({
                displayType: "TILE",
                listElement: t("[data-app-buddylist-container]")
            }), this.listenTo(this.overScrollView, "requestRender", this.renderItems)
        },
        renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum();
            t("[data-app-buddylist-container]").html(a({
                buddies: this.hasDressRecordBuddyCollection.sort().slice(e, n)
            })), this.processAfterRender({
                notShowDeshi: !0
            }), this.overScrollView.setAroundPageText(), this.overScrollView.afterRender({
                imagewatcher: this.imagewatcher
            })
        },
        onClickOpenSortModal: function() {
            c.openModalDeferred(p.SORT_MODULE_KEY, !1).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.renderBuddyList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        setupBuddyModelsList: function() {
            var e = this,
                t = FF.datastore.dressRecordCollection;
            this.hasDressRecordBuddyCollection || (this.hasDressRecordBuddyCollection = new s), this.hasDressRecordBuddyCollection.reset(), t.each(function(t) {
                var n = t.get("buddy_id"),
                    r = FF.datastore.buddyCollection.findWhere({
                        buddy_id: +n
                    });
                e.hasDressRecordBuddyCollection.add(r)
            })
        },
        renderBuddyList: function(e) {
            e = e || {}, this.hasDressRecordBuddyCollection.changeComparator(e), this.overScrollView.updateCollectionSize(this.hasDressRecordBuddyCollection.length), this.overScrollView.setMaxPageText();
            var t = this.overScrollView.getMaxPage();
            this.overScrollView.getCurrentPage() > t && this.overScrollView.setCurrentPage(t), this.renderItems()
        },
        onLongTapBuddyDetail: function(e) {
            this.hasLongTap = !0, this.blurSelectorOrder();
            var n = t(e.target).closest("[data-app-buddylist]"),
                r = n.attr("data-app-buddylist-id");
            this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = this;
            this.selectedBuddyModel = this.hasDressRecordBuddyCollection.get(e), FF.modalStack.push(l, {
                renderer: function(e) {
                    e.render(t.selectedBuddyModel)
                },
                onPop: function(e) {
                    t.hasLongTap = !1
                }
            })
        },
        onOpenAnimationEnd: function() {
            !FF.env.isIOS6_x() && !FF.env.isAndroid2_x() && t("[data-app-animation-wrap]").addClass("is-animate")
        },
        onClickBuddyList: function(e) {
            if (this.hasLongTap) return;
            var r = this,
                i = t(e.target),
                s = +i.attr("data-app-buddylist-id");
            n.history.navigate("party/dress_record_change/" + s, {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate("#party/enhancement_top", {
                trigger: !0
            })
        },
        dispose: function() {
            this.overScrollView && this.overScrollView.dispose(), this.hasDressRecordBuddyCollection && this.hasDressRecordBuddyCollection.reset(), f.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalPossessionLimitExpandConfirm", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalPossessionLimitExpandConfirm"], function(e, t, n, r, i, s) {
    var o = {
        TYPE_EQUIPMENT: "equipment"
    };
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-decide]": "onClickDecide",
            "anchorsbeforejump [data-app-modal-close]": "onClickCancel"
        },
        initialize: function(e) {
            this.type = e.type, i.prototype.initialize.call(this)
        },
        render: function() {
            var e = s({
                userModel: FF.datastore.userModel,
                type: this.type,
                CONST: o,
                itemPossessionLimitNum: this.getItemPossessionLimitNum()
            });
            this.putContent(e)
        },
        getItemPossessionLimitNum: function() {
            var t = this,
                n = e.find(FF.datastore.itemPossessionLimitCollection.models, function(e) {
                    return e.get("item_type_name") === t.type
                });
            return n.get("max_num")
        },
        getAddMaxLimitDeferredFunc: {
            equipment: r.addEquipmentMaxLimitDeferred.bind(r),
            ability: r.addAbilityMaxLimitDeferred.bind(r)
        },
        onClickDecide: function() {
            FF.router.loading.lock();
            var e = this;
            this.getAddMaxLimitDeferredFunc[this.type]().done(function(t) {
                FF.datastore.userModel.set(t.user);
                var n = FF.datastore.itemPossessionLimitCollection.findWhere({
                    item_type_name: e.type
                });
                n.set(t.item_possession_limits[0]), e.trigger("onClickDecide"), e.end(!0)
            }).fail(function() {
                e.end()
            })
        },
        onClickCancel: function() {
            FF.router.loading.lock(), this.trigger("onClickCancel"), this.end()
        },
        dispose: function() {
            this.type = null, i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/views/ModalPossessionLimitExpandComplete", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/party/views/ModalPossessionLimitExpandComplete"], function(e, t, n, r, i, s) {
    var o = {
        TYPE_EQUIPMENT: "equipment"
    };
    return i.extend({
        el: "[data-app-modal]",
        initialize: function(e) {
            this.type = e.type, i.prototype.initialize.call(this)
        },
        render: function() {
            var e = s({
                type: this.type,
                CONST: o
            });
            this.putContent(e)
        },
        dispose: function() {
            this.type = null, i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/pages/PossessionLimitExpand", ["underscore", "jquery", "backbone", "scenes/party/Api", "./Page", "../views/ModalPossessionLimitExpandConfirm", "../views/ModalPossessionLimitExpandComplete", "ww/scenes/common/views/ModalUseGemConfirm", "templates/party/PossessionLimitExpand", "components/Toast"], function(e, t, n, r, i, s, o, u, a, f) {
    var l = {
        TYPE_EQUIPMENT: "equipment"
    };
    return i.extend({
        contentType: "NO_STATUS",
        designType: "MODERN",
        events: {
            "anchorsbeforejump [data-app-expand-items]": "onClickExpandItems",
            "anchorsbeforejump [data-app-expand-coin]": "onClickExpandCoin",
            "anchorsbeforejump [data-app-legal]": "onClickMobageLegal"
        },
        _coinNum: 0,
        setupDeferred: function() {
            this.addBalanceListener(), FF.SoundMgr.playCidBlacksmithBgm();
            var e = t.Deferred();
            return e.resolve().promise()
        },
        addBalanceListener: function() {
            var e = this;
            t(document).on("getBalanceForPossessionLimit", this.updateCoinNum.bind(this)), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                r.getAndTriggerBalance()
            }, function() {})
        },
        updateCoinNum: function(e, n) {
            t("[data-app-coin-num]").text(n)
        },
        render: function(e) {
            this.type = e[0];
            var t = FF.datastore.itemPossessionLimitCollection.findByTypeName(this.type);
            i.prototype.render.call(this, a, {
                userModel: FF.datastore.userModel,
                coinNum: this._coinNum,
                type: this.type,
                itemPossessionLimitModel: t,
                CONST: l,
                showMobageLegal: FF.env.isShowingMobageLegal()
            }), r.getAndTriggerBalance(), this.processAfterRender()
        },
        openCompleteModal: function() {
            var e = new o({
                type: this.type
            });
            e.render(), FF.router.overlay.registerChildren(e), e.open()
        },
        onClickExpandItems: function() {
            FF.router.loading.lock();
            var e = this,
                t = FF.datastore.itemPossessionLimitCollection.findByTypeName(this.type);
            if (t.isItemPossessionLimitMax()) {
                this.bakeAlreadyMaxToast();
                return
            }
            this.modalPossessionLimitExpandConfirmView = new s({
                type: this.type
            }), this.modalPossessionLimitExpandConfirmView.render(), FF.router.overlay.registerChildren(this.modalPossessionLimitExpandConfirmView), this.modalPossessionLimitExpandConfirmView.open(), this.listenToOnce(this.modalPossessionLimitExpandConfirmView, "onClickDecide", function() {
                e.updateViewMithrilNum(), e.listenToOnce(e.modalPossessionLimitExpandConfirmView, "closeAnimationEnd", e.openCompleteModal), e.stopListening(e.modalPossessionLimitExpandConfirmView, "onClickCancel")
            }), this.listenToOnce(this.modalPossessionLimitExpandConfirmView, "onClickCancel", function() {
                e.stopListening(e.modalPossessionLimitExpandConfirmView, "onClickDecide")
            })
        },
        updateViewMithrilNum: function() {
            var e = FF.datastore.userModel.get("soul_piece");
            t("[data-app-mithril-num]").text(e), e === 0 && t("[data-app-expand-items]").addClass("is-disable")
        },
        onClickExpandCoin: function() {
            FF.router.loading.lock();
            var e = this,
                n = t.Deferred(),
                i = this._getPaymentProductId(),
                s = FF.datastore.itemPossessionLimitCollection.findByTypeName(this.type);
            if (s.isItemPossessionLimitMax()) {
                this.bakeAlreadyMaxToast();
                return
            }
            return r.purchaseItemDeferred({
                id: i,
                quantity: 1
            }).done(function(r) {
                var i = JSON.parse(r);
                if (!i.success || !i.payment_result.success) throw new Error("faild_payment");
                s.set(i.payment_result.item_possession_limits[0]);
                var o = FF.Config.server.itemPossessionLimit[e.type].payment.payCost,
                    u = +t("[data-app-coin-num]").text() - o;
                t("[data-app-coin-num]").text(u), e.openCompleteModal(), FF.router.loading.unlock(), n.resolve()
            }).fail(function(e) {
                FF.router.loading.unlock(), n.resolve()
            }).always(function() {
                FF.env.isWWRegion() && (r.getAndTriggerBalance(), FF.router.loading.unlock())
            }), n.promise()
        },
        _getPaymentProductId: function() {
            var e = FF.Config.server.itemPossessionLimit[this.type];
            if (!e) throw new Error("invalid type: " + this.type);
            var t = e.payment.paymentProductId;
            return FF.env.isWWRegion() ? {
                entryPointId: t,
                price: e.payment.payCost,
                modalOptions: {
                    confirmType: "possession",
                    possessionType: this.type
                }
            } : t
        },
        bakeAlreadyMaxToast: function() {
            FF.router.toast.topping(t("#toast-message-already-max").text()).bake(), FF.router.loading.unlock()
        },
        onClickBack: function() {
            FF.router.loading.lock(), window.history.back()
        },
        onClickMobageLegal: function() {
            kickmotor.platform.mobageLegal()
        },
        dispose: function() {
            kickmotor.platform.resetMobageDashboardListener(), this.modalPossessionLimitExpandConfirmView && this.modalPossessionLimitExpandConfirmView.dispose(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/party/PartyScene", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/Scene", "scenes/party/UserContext", "scenes/party/pages/Party", "scenes/party/pages/PartyEdit", "scenes/party/pages/BuddyList", "scenes/party/pages/EnhancementTop", "scenes/party/pages/EnhancementBaseSelect", "scenes/party/pages/EnhancementMaterialSelect", "scenes/party/pages/EvolutionBaseSelect", "scenes/party/pages/EvolutionSelected", "scenes/party/pages/GrowEgg", "scenes/party/pages/GrowEggSelected", "scenes/party/pages/Equipment", "scenes/party/pages/Inventory", "scenes/party/pages/EquipmentChange", "scenes/party/pages/SoulStrikeChange", "scenes/party/pages/AbilityChange", "scenes/party/pages/AbilityGeneration", "scenes/party/pages/AbilityUpgrade", "scenes/party/pages/AbilityDecompose", "scenes/party/pages/AbilityMaterialConvertSrcSelect", "scenes/party/pages/AbilityMaterialConvertDstSelect", "scenes/party/pages/RecordMateriaChange", "scenes/party/pages/BuddyEvolution", "./pages/DressRecord", "./pages/DressRecordChange", "scenes/party/pages/PossessionLimitExpand"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O) {
    return i.extend({
        pages: {
            party: o,
            party_edit: u,
            buddy_list: a,
            enhancement_top: f,
            enhancement_base_select: l,
            enhancement_material_select: c,
            evolution: h,
            evolution_selected: p,
            grow_egg: d,
            grow_egg_selected: v,
            equipment: m,
            inventory: g,
            equipment_change: y,
            soul_strike_change: b,
            ability_change: w,
            ability_generate: E,
            ability_upgrade: S,
            ability_decompose: x,
            ability_material_convert_src_select: T,
            ability_material_convert_dst_select: N,
            record_materia_change: C,
            buddy_evolution: k,
            dress_record: L,
            dress_record_change: A,
            possession_limit_expand: O
        },
        initialize: function() {
            i.prototype.initialize.call(this), this._userContext = new s, FF.resonator.setUserContext(this._userContext)
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = FF.datastore;
            return i.hasPartyAllData() ? n.resolve().promise() : (r.partyListDeferred().done(function(t) {
                e.data = t, i.addPartyAllData(t), n.resolve()
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function(r) {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this,
                r = e || "party";
            FF.logger.debug("PartyScene: showPage : " + r, t), this.layoutView && this.layoutView.dispose();
            if (this.pages[r] === undefined) throw new Error("invalid page invoked in PartyScene. pageName: " + r);
            this.layoutView = new this.pages[r]({
                scene: this,
                args: t,
                context: this._userContext
            }), this.layoutView.setupDeferred().done(function() {
                n.layoutView.render(t)
            })
        }
    })
}), define("scenes/dungeon/pages/Page", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "lib/LayoutBase", "scenes/common/views/ModalBattleEscape", "scenes/common/helper/DungeonBackground", "scenes/common/helper/TermCheck", "scenes/common/helper/DailyLogin", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/Relation"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return i.extend({
        contentType: "ONLY_BTN",
        designType: "MODERN",
        setupDetailDeferred: function() {
            return !this.worldId || !this.dungeonId ? (n.history.navigate("#home", {
                trigger: !0
            }), t.Deferred().reject().promise()) : (this.worldModel = FF.datastore.worldCollection.get(this.worldId), this.dungeonModel = FF.datastore.dungeonCollection.get(this.dungeonId), FF.router.header.updatePartyStatusViewInDungeon({
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
            }), FF.SoundMgr.playMusic(this.worldModel.get("bgm")), this.checkDeferred({
                onlyTermCheck: !0
            }))
        },
        checkDeferred: function(e) {
            var n = this;
            return e = e || {}, u.showModalIfExpireDeferred(this.worldModel).then(a.showModalIfNeedDeferred).then(function() {
                return e.onlyTermCheck ? t.Deferred().resolve().promise() : f.showModalIfOverLimitDeferred().then(n.resumeDungeonIfNeedDeferred)
            })
        },
        resumeDungeonIfNeedDeferred: function() {
            if (!FF.datastore.dungeonSessionModel.isInDungeon()) return t.Deferred().resolve().promise();
            var e = FF.datastore.dungeonSessionModel.get("dungeon_id");
            if (this.dungeonModel.get("id") === e) {
                var r = this.worldModel.getBattleListFragment(e);
                n.history.navigate(r, {
                    trigger: !0
                })
            } else this.modalBattleEscape = new s({
                isNotNavigateFailScene: !0
            }), this.modalBattleEscape.render(), FF.router.overlay.registerChildren(this.modalBattleEscape), this.modalBattleEscape.open();
            return t.Deferred().reject().promise()
        },
        updateBackground: function(e) {
            e = e || {};
            var t = e.isForce ? !0 : !1,
                n = o.getPathByWorldId(this.worldModel.get("id"), {
                    isForce: t
                });
            this.setBackgroundImage(pUrl(n))
        },
        dispose: function() {
            FF.router.header.updatePartyStatusViewInDungeon(), i.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/views/ModalInBattleAlert", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "templates/common/ModalInBattleAlert", "lib/ModalBase"], function(e, t, n, r, i, s) {
    return s.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickClose",
            "anchorsbeforejump [data-app-exit]": "onClickExit"
        },
        initialize: function() {},
        render: function() {
            this.renderContent(i, {})
        },
        onClickExit: function() {
            var e = this,
                t = FF.datastore.dungeonSessionModel.get("dungeon_id"),
                n = FF.datastore.dungeonSessionModel.getWorldModel().getApiOptions();
            r.dungeonLeaveDeferred(t, n).done(function(e) {
                FF.datastore.userModel.set(e.user), FF.datastore.clearDungeonSession(), FF.router.loading.hide(!0), FF.modalStack.popToTotem(1, !0)
            })
        },
        onClickClose: function() {
            FF.SoundMgr.playChooseEffect(), FF.modalStack.popToTotem(1, !1)
        }
    })
}), define("scenes/dungeon/pages/List", ["underscore", "jquery", "backbone", "./Page", "templates/dungeon/List", "components/FreeScroll", "components/Scrollbar", "scenes/common/collections/Dungeon", "scenes/common/views/ModalDungeonInfo", "scenes/common/views/ModalInBattleAlert", "scenes/common/helper/FuncTutorial", "scenes/common/helper/DungeonInfo", "scenes/common/helper/ItemPossessionLimit", "scenes/common/helper/PopupNotification", "scenes/common/helper/LastClearedDungeon", "scenes/common/helper/LeadToSecondDungeon", "scenes/common/helper/MissionHelper"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m) {
    return r.extend({
        contentType: "BASE",
        tmpl: i,
        dungeonListType: undefined,
        lastClearedDungeonId: undefined,
        events: {
            "anchorsbeforejump [data-app-flag-unlock]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-btn-force]": "onClickForce",
            "anchorsbeforejump [data-app-btn-normal]": "onClickNormal"
        },
        initialize: function(e) {
            r.prototype.initialize.call(this), this.worldId = +e.args.shift(), this.dungeonListType = +e.args.shift() || +FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL
        },
        setupDeferred: function() {
            var e = this;
            this.worldModel = FF.datastore.worldCollection.get(this.worldId);
            var t = FF.datastore.dungeonCollection.where({
                world_id: +this.worldId
            });
            return this.dungeonCollection = new u(t), FF.SoundMgr.playMusic(this.worldModel.get("bgm")), d.getDeferred(this.worldId, this.dungeonListType).then(function(t) {
                e.lastClearedDungeonId = t
            })
        },
        render: function(t) {
            var n = {
                worldModel: this.worldModel,
                dungeonModels: this.getDungeonModels(),
                isForce: this.isForce()
            };
            r.prototype.render.call(this, this.tmpl, e.extend(n, t)), FF.router.header.updatePartyStatusViewInDungeon({
                statusBonusOpt: {
                    seriesId: this.worldModel.get("series_id")
                }
            }), this.setupComponents(), this.updateBackground({
                isForce: this.isForce()
            }), this.scrollByDungeonId(this.lastClearedDungeonId), this.processAfterRender()
        },
        shouldShowForceDungeonTutorial: function() {
            return this.isForce()
        },
        processAfterContentLoad: function() {
            var e = this;
            v.shouldShowSecondDungeonTutorial(this.worldId) ? (v.clearLeadToSecondDungeon(), l.showNavigationDeferred({
                key: "LEAD_TO_SECOND_DUNGEON"
            }).done(function() {
                r.prototype.processAfterContentLoad.call(e)
            })) : l.hasSeen("DUNGEON_LIST") ? this.shouldShowForceDungeonTutorial() ? l.showNavigationDeferred({
                key: "FORCE_DUNGEON"
            }).done(function() {
                r.prototype.processAfterContentLoad.call(e)
            }) : m.shouldShowModalMissionClear() ? m.openModalMissionClearIfNeedDeferred().done(function() {
                r.prototype.processAfterContentLoad.call(e)
            }) : (r.prototype.processAfterContentLoad.call(this), p.showModalIfNeedPopupNotificationDeferred("DUNGEON_LIST", this.worldModel.get("id"))) : l.showNavigationDeferred({
                key: "DUNGEON_LIST",
                isTutorialIllustMultiOnly: !0,
                maxNum: 2
            })
        },
        setupComponents: function() {
            this.freescroll = new s({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new o({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            })
        },
        getDungeonModels: function(e) {
            e = e || this.dungeonListType;
            var t = FF.CONST.SERVER.DUNGEON.TYPE_OF;
            if (e === t.NORMAL) return this.getNormalDungeonModels();
            if (e === t.FORCE) return this.getForceDungeonModels();
            throw new Error("Invalid dungeonListType : " + e)
        },
        getNormalDungeonModels: function() {
            var t = this.dungeonCollection.where({
                type: FF.CONST.SERVER.DUNGEON.TYPE_OF.NORMAL,
                is_unlocked: !0
            });
            return e.filter(t, function(e) {
                return e.isOpened()
            })
        },
        getForceDungeonModels: function() {
            var t = this,
                n = this.dungeonCollection.where({
                    type: FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE
                });
            return e.filter(n, function(t) {
                var n = t.getUnlockConditionDungeonModels(),
                    r = e.all(n, function(e) {
                        return e.model.get("is_unlocked")
                    });
                return r && t.isOpened()
            })
        },
        confirmQuitDungeonDeferred: function() {
            var e = t.Deferred();
            return FF.modalStack.push(f, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(e) {
                    return e.render()
                },
                onPop: function(t, n) {
                    n ? e.resolve() : e.reject()
                }
            }), e.promise()
        },
        onClickDungeonInfo: function(e) {
            if (!FF.router.loading.lock()) return;
            var n = this,
                r = t(e.target).attr("data-dungeon-id"),
                i = this.dungeonCollection.get(+r);
            c.openDeferred(r, {
                dungeonModel: i,
                selectedType: a.SELECTED_TYPE_OF.PROLOGUE,
                enableChallengeButton: !0,
                onChallenge: function() {
                    FF.modalStack.popAll(), n.navigateByDungeonId(r)
                }
            })
        },
        navigateByDungeonId: function(e) {
            var t = this,
                r = FF.datastore.dungeonSessionModel;
            if (r.isInDungeon()) {
                if (r.get("dungeonId") === e) {
                    var i = r.getWorldModel().getBattleListFragment(e);
                    return n.history.navigate(i, {
                        trigger: !0
                    })
                }
                this.confirmQuitDungeonDeferred().then(function() {
                    t._navigateByDungeonId(e)
                })
            } else this._navigateByDungeonId(e)
        },
        _navigateByDungeonId: function(e) {
            var t = this.worldModel.getDungeonDetailFragment(e, "party");
            n.history.navigate(t, {
                trigger: !0
            })
        },
        requireShowFellowTutorial: function() {
            return FF.datastore.userModel.isRequireShowFellowTutorial()
        },
        requireShowFellowPlusTutorial: function() {
            return FF.datastore.userModel.isRequireShowFellowPlusTutorial()
        },
        isForce: function() {
            return this.dungeonListType === FF.CONST.SERVER.DUNGEON.TYPE_OF.FORCE
        },
        onClickBack: function() {
            n.history.navigate(this.worldModel.getWorldListFragment(), {
                trigger: !0
            })
        },
        onClickForce: function() {
            n.history.navigate(this.worldModel.getDungeonListFragment({
                isForce: !0
            }), {
                trigger: !0
            })
        },
        onClickNormal: function() {
            n.history.navigate(this.worldModel.getDungeonListFragment({
                isForce: !1
            }), {
                trigger: !0
            })
        },
        scrollByDungeonId: function(e) {
            if (!e) return;
            var t = sprintf("[data-dungeon-id=%s]", e);
            this.freescroll.scrollBySelector(t)
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.resetBackgroundImage(), FF.router.header.updatePartyStatusViewInDungeon(), r.prototype.dispose.call(this)
        }
    })
}), define("scenes/dungeon/pages/Info", ["underscore", "jquery", "backbone", "util", "scenes/dungeon/Api", "templates/dungeon/Info", "./Page", "components/FreeScroll", "components/Scrollbar", "components/Tab"], function(e, t, n, r, i, s, o, u, a, f) {
    return o.extend({
        contentType: "NO_NAVI",
        tmpl: s,
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        initialize: function(e) {
            this.worldId = e.args[0], this.dungeonId = e.args[1], this.selectedType = e.args[2] || "story", o.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            return this.setupDetailDeferred()
        },
        render: function() {
            o.prototype.render.call(this, this.tmpl, {
                util: r,
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                seriesId: this.dungeonModel.get("series_id"),
                selectedType: this.selectedType
            }), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {
            this.freescroll = new u({
                el: t("[data-ui-freescroll]")
            }), this.scrollbar = new a({
                el: t("[data-ui-scrollbar]"),
                watch: this.freescroll,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.panes = t('[data-ui-group="pane"]'), this.tab = new f({
                tabs: t('[data-ui-group="tab"]'),
                panes: this.panes,
                className: "is-current",
                defaultPage: 0
            }), this.tabOnChangedState(), this.listenTo(this.tab, "changedState", this.tabOnChangedState)
        },
        tabOnChangedState: function() {
            e.each(this.panes, function(e) {
                var n = t(e);
                n.hasClass("is-current") ? n.removeClass("di-n") : n.addClass("di-n")
            }), this.freescroll.reset(), this.freescroll.updateContent(), this.scrollbar.updateContentWithScrollReset()
        },
        onClickNext: function() {
            n.history.navigate(this.worldModel.getDungeonDetailFragment(this.dungeonModel.get("id"), "party"), {
                trigger: !0
            })
        },
        onClickBack: function() {
            n.history.navigate(this.worldModel.getDungeonListFragment({
                isForce: this.dungeonModel.isForce()
            }), {
                trigger: !0
            })
        },
        dispose: function() {
            this.freescroll && this.freescroll.dispose(), this.scrollbar && this.scrollbar.dispose(), this.tab && this.tab.dispose(), o.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/SeriesResonanceTutorial", ["scenes/common/helper/FuncTutorial"], function(e) {
    return {
        navigateIfNeedDeferred: function(t) {
            var n = $.Deferred();
            return e.hasSeen("SERIES") ? n.resolve().promise() : this._shouldShow(t) ? (Backbone.history.navigate("#func_tutorial/series", {
                trigger: !0
            }), n.reject().promise()) : n.resolve().promise()
        },
        _shouldShow: function(e) {
            var t = FF.datastore.partyModel.getBuddyModels(),
                n = _.find(t, function(t) {
                    return t && t.isSameSeries(e)
                });
            if (n) return !0;
            var r = [];
            _.each(t, function(e) {
                if (!e) return;
                _.each(FF.CONST.SERVER.EQUIPMENT.TYPE_NAMES, function(t) {
                    var n = e.getEquipmentModelByTypeName(t);
                    r.push(n)
                })
            });
            var i = _.find(r, function(t) {
                return t && t.isSameSeries(e)
            });
            return i ? !0 : !1
        }
    }
}), define("scenes/debug/helper/Tips", ["jquery", "underscore", "lib/debugApi"], function(e, t, n) {
    var r = function(e) {
        window.alert(e.join("\n"))
    };
    return {
        showUserStrength: function(e) {
            if (!FF.env.isDevelop()) return;
            e = e || {};
            var i = FF.datastore,
                s = e.dungeonModel || i.currentDungeonModel,
                o = s.get("id");
            n.debugGetUserStrengthDeferred(o).then(function(e) {
                var n = e.strength_map || {},
                    s = 0,
                    o = 0,
                    u = 0,
                    a = [],
                    f = " %-2s  %8d  %8d  %8d";
                a.push("", "user strength", ""), a.push(sprintf("       %8s  %8s  %8s", "(plain)", "(series)", "(series2)")), a.push("----------------------------");
                var l = i.partyModel.getBuddyModels();
                t.each(l, function(e, t) {
                    if (!e) return;
                    var r = t + 1,
                        i = e.get("id"),
                        l = n[i] || {},
                        c = l.anl_strength,
                        h = l.anl_strength_with_series,
                        p = l.anl_strength_with_series2;
                    s += c, o += h, u += p, a.push(sprintf(f, r, c, h, p))
                }), a.push("----------------------------"), a.push(sprintf(f, "", s, o, u)), r(a)
            })
        }
    }
}), define("scenes/dungeon/pages/Party", ["underscore", "jquery", "backbone", "scenes/dungeon/Api", "templates/dungeon/Party", "./Page", "scenes/common/helper/LockFlagManager", "scenes/party/views/InParty", "scenes/party/views/ModalCharacterDetail", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/DungeonInfo", "scenes/common/helper/SeriesResonanceTutorial", "scenes/debug/helper/Tips", "scenes/progress_map/LatestProgressData"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    return s.extend({
        contentType: "FOOTER_ON_BTN",
        tmpl: i,
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNextButton",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "click .hdr-content": "onClickDebugUserStrength"
        },
        initialize: function(e) {
            this.worldId = e.args[0], this.dungeonId = e.args[1], this.lockFlagManager = new o, this.lockFlagManager.initialize("isLocked"), s.prototype.initialize.call(this, e)
        },
        setupDeferred: function() {
            return this.setupDetailDeferred()
        },
        render: function() {
            s.prototype.render.call(this, this.tmpl, {
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                seriesId: this.dungeonModel.get("series_id")
            }), this.renderInParty(), this.setupComponents(), this.updateBackground({
                isForce: this.dungeonModel.isForce()
            }), this.processAfterRender()
        },
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this);
            var e = this.dungeonModel.get("series_id");
            c.navigateIfNeedDeferred(e)
        },
        renderInParty: function() {
            this.inPartyView = new u({
                el: t("#inPartyView"),
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt(),
                lockFlagManager: this.lockFlagManager,
                partyNavigateParams: this._getPartyNavigateParams()
            }), this.listenTo(this.inPartyView, u.EVENTS.RENDER, this.onRenderInParty.bind(this)), this.listenTo(this.inPartyView, u.EVENTS.CANCEL, this.enableNextButton), this.listenTo(this.inPartyView, u.EVENTS.ALIGN, this.onAlignEdit), this.inPartyView.render()
        },
        onRenderInParty: function() {
            this.inPartyView.getIsPushingRecommend() ? this.disableNextButton() : this.enableNextButton()
        },
        onAlignEdit: function() {
            this.lockFlagManager.isLocked("isEditingAlign") ? this.disableNextButton() : this.enableNextButton()
        },
        setupComponents: function() {},
        onClickNextButton: function() {
            var e = this;
            this.checkDeferred().done(function() {
                n.history.navigate(e.worldModel.getDungeonDetailFragment(e.dungeonModel.get("id"), "supporter"), {
                    trigger: !0
                })
            })
        },
        onClickDungeonInfo: function() {
            l.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                selectedType: f.SELECTED_TYPE_OF.BOSS
            })
        },
        _getPartyNavigateParams: function() {
            return {
                isPreDungeon: !0,
                seriesId: this.dungeonModel.get("series_id"),
                dungeonId: this.dungeonModel.get("id"),
                abilityCategoryBonusMap: this.dungeonModel.get("ability_category_bonus_map"),
                backFragment: location.hash
            }
        },
        onClickDebugUserStrength: function() {
            if (!FF.env.isDevelop()) return;
            h.showUserStrength({
                dungeonModel: this.dungeonModel
            })
        },
        onClickBack: function() {
            var e = this;
            p.getCanReturnDeferred().then(function(t) {
                var r;
                t.canReturn && e.worldModel.isNormalWorld() ? r = "progress_map" : r = e.worldModel.getDungeonListFragment({
                    isForce: e.dungeonModel.isForce()
                }), n.history.navigate(r, {
                    trigger: !0
                })
            })
        },
        disableNextButton: function() {
            t("[data-app-next]").addClass("is-disable mbgaui-disabled")
        },
        enableNextButton: function() {
            t("[data-app-next]").removeClass("is-disable mbgaui-disabled")
        },
        dispose: function() {
            this.inPartyView && this.inPartyView.dispose(), this.lockFlagManager && this.lockFlagManager.dispose(), s.prototype.dispose.call(this)
        }
    })
}), define("scenes/common/helper/ABAnimationHelper", ["underscore", "jquery"], function(e, t) {
    return {
        useSyncAnimationIfNeededDeferred: function() {
            var e = t.Deferred();
            return FF.env.isIOS6_x() || FF.env.isIOS7_x() ? kickmotor.nativefn.setPumpASyncMode(!1, function() {
                e.resolve(!0)
            }) : e.resolve(!1), e.promise()
        }
    }
}), define("scenes/dungeon/pages/Supporter", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "lib/Download", "lib/Storage", "scenes/dungeon/Api", "scenes/relation/Api", "scenes/common/helper/Relation", "scenes/common/collections/Profile", "scenes/common/helper/DungeonInfo", "scenes/common/views/ModalDungeonInfo", "scenes/common/helper/ABAnimationHelper", "scenes/progress_map/LatestProgressData", "templates/dungeon/Supporter", "templates/dungeon/views/SupporterList", "templates/common/relation/ModalProfileDetail", "components/OverScrollable", "components/Scrollbar", "./Page"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b) {
    var w = {
        ACTIVE_CLASS_NAME: "is-active",
        HIDE_CLASS_NAME: "di-n",
        SUPPORTER_IMG_WIDTH: "50",
        SUPPORTER_IMG_HEIGHT: "50"
    };
    return b.extend({
        contentType: "FOOTER_ON_BTN",
        tmpl: d,
        events: {
            "anchorsbeforejump [data-app-set]": "onClickSet",
            "anchorsbeforejump [data-app-unset]": "onClickUnset",
            "anchorsbeforejump [data-app-back]": "onClickBack",
            "anchorsbeforejump [data-app-next]": "onClickNext",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-profile-detail]": "onClickCharaDetailView",
            "anchorslongtap [data-app-supporter-item]": "openProfileDetail"
        },
        initialize: function(e) {
            this.worldId = e.args[0], this.dungeonId = e.args[1], b.prototype.initialize.call(this, e), this.buddyModels = FF.datastore.partyModel.getBuddyModels(), this.selectionId = void 0, this.startUpNum = void 0, this.isUpdatedByOverscroll = !1
        },
        setupDeferred: function() {
            var e = this;
            return this.setupDetailDeferred().then(function() {
                return a.detailedFellowListingDeferred({
                    dungeonId: e.dungeonModel.get("id")
                })
            }).then(function(t) {
                e.fellowListingUserIds = t.fellow_listing_user_ids, e.profileCollection = new f(t.detailed_fellows), e.profileCollection.setRelationStatusComparator(), e.profileCollection.sort()
            })
        },
        render: function(e) {
            e = e || {}, b.prototype.render.call(this, this.tmpl, {
                worldModel: this.worldModel,
                dungeonModel: this.dungeonModel,
                buddyModels: this.buddyModels,
                profileCollection: this.profileCollection,
                maxSssGauge: FF.datastore.userModel.get("supporter_ss_gauge"),
                sssGauge: FF.datastore.userModel.get("supporter_ss_gauge"),
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt(),
                seriesId: this.dungeonModel.get("series_id")
            }), this.renderCollectionList(), this.setSupporterInDefault(e), this.removeLoadingLowerIfNeed(), this.setupComponents(), this.updateBackground({
                isForce: this.dungeonModel.isForce()
            }), this.processAfterRender()
        },
        removeLoadingLowerIfNeed: function() {
            this.isUpdatedByOverscroll && t("[data-ui-loading-lower]").remove()
        },
        setupComponents: function() {
            this.overscrollable = new g({
                el: t("[data-ui-freescroll]"),
                contentSelector: "[data-ui-freescroll-content]",
                startUp: this.startUpNum || 0,
                loading: t("[data-ui-loading]"),
                useNativeScroll: !1
            }), this.scrollbar = new y({
                el: t("[data-ui-scrollbar]"),
                watch: this.overscrollable,
                faceHeight: 31,
                disableOverscroll: !0
            }), this.listenToOnce(this.overscrollable, "overscroll:changeAnimation", this.updateByOverscroll)
        },
        updateByOverscroll: function() {
            var e = this;
            if (this.isUpdatedByOverscroll) return;
            this.isUpdatedByOverscroll = !0, FF.router.loading.lock();
            var n = this.getAddtionalSupporterData();
            if (!n.length) {
                FF.router.loading.unlock();
                return
            }
            t("[data-ui-loading-lower]").css("opacity", 1).addClass("is-animate"), this.findByUserIdsDeferred(n).done(function(r) {
                t("[data-ui-loading-lower]").remove(), e.profileCollection.add(r.target_profiles), e.renderAdditionalSupporterData(n), e.scrollbar.updateContent()
            })
        },
        getAddtionalSupporterData: function() {
            var t = this.profileCollection.getUserIds(),
                n = e.map(this.fellowListingUserIds, function(t) {
                    return e.values(t)[0]
                });
            return e.difference(n, t)
        },
        renderAdditionalSupporterData: function(n) {
            var i = this,
                s = e.map(n, function(e) {
                    return i.profileCollection.get(e)
                }),
                o = r.process(v, {
                    models: s,
                    statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
                });
            t("[data-app-supporter-list-items]").append(o), this.overscrollable.getScrollableWithCalculation(), FF.router.loading.hide()
        },
        findByUserIdsDeferred: function(e) {
            return u.findByUserIdsDeferred(e, {
                dungeonId: this.dungeonModel.get("id"),
                disableLoading: !0
            })
        },
        renderCollectionList: function(e) {
            e = e || {};
            var n = r.process(v, {
                models: this.profileCollection.models,
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
            });
            t("[data-app-supporter-list-items]").html(n)
        },
        stashCurrentOverScrollViewPos: function() {
            this.startUpNum = this.overscrollable.getCurrentScroll()
        },
        openProfileDetail: function(e) {
            FF.SoundMgr.playChooseEffect();
            var n = t(e.target).attr("data-app-supporter-item"),
                r = this.profileCollection.get(n);
            this.profileDetailModalView = a.showModal(r, {
                template: m,
                hideButton: !0,
                statusBonusOpt: this.dungeonModel.getStatusBonusOpt()
            })
        },
        setSupporterInDefault: function(e) {
            var n = e.selectedId ? t('[data-app-supporter-id="' + e.selectedId + '"]') : t("[data-app-supporter-id]");
            if (n.length === 0) return;
            t(n[0]).find("[data-app-set]").removeAttr("data-app-sound"), t(n[0]).find("[data-app-set]").trigger("anchorsbeforejump"), t(n[0]).find("[data-app-set]").attr("data-app-sound", "choose")
        },
        onClickSet: function(e) {
            var n = t(e.target).parent().attr("data-app-supporter-id"),
                r = t("[data-app-supporter-item=" + n + "]"),
                i = t("[data-app-supporter-item]." + w.ACTIVE_CLASS_NAME),
                s = i.attr("data-app-supporter-item");
            this.showSetButton(s), this.hideSetButton(n), t(i).removeClass(w.ACTIVE_CLASS_NAME), t(r).addClass(w.ACTIVE_CLASS_NAME), this.selectionId = n;
            var o = this.getSupporterImgElem(this.selectionId);
            this.renderSelectedSupporter({
                elem: o
            }), this.showSupporterAuraIfNeed(this.selectionId), t("[data-app-warning-text]").addClass("di-n")
        },
        onClickUnset: function(e) {
            var n = t(e.target).parent().attr("data-app-supporter-id"),
                r = t("[data-app-supporter-item=" + n + "]");
            this.showSetButton(n), t(r).removeClass(w.ACTIVE_CLASS_NAME), this.selectionId = void 0, this.hideSupporterAura(), this.renderSelectedSupporter({
                elem: ""
            }), t("[data-app-warning-text]").removeClass("di-n")
        },
        showSetButton: function(e) {
            var n = t("[data-app-supporter-id=" + e + "]");
            n.find("[data-app-unset]").addClass(w.HIDE_CLASS_NAME), n.find("[data-app-set]").removeClass(w.HIDE_CLASS_NAME)
        },
        hideSetButton: function(e) {
            var n = t("[data-app-supporter-id=" + e + "]");
            n.find("[data-app-unset]").removeClass(w.HIDE_CLASS_NAME), n.find("[data-app-set]").addClass(w.HIDE_CLASS_NAME)
        },
        getSupporterImgElem: function(e) {
            var t = this.profileCollection.get(e),
                n = t.getSupporterBuddyImagePath(),
                r = document.createElement("img");
            return r.width = w.SUPPORTER_IMG_WIDTH, r.height = w.SUPPORTER_IMG_HEIGHT, r.src = pUrl(n), r
        },
        showSupporterAuraIfNeed: function(e) {
            var n = this.profileCollection.get(e),
                r = this.dungeonModel.getStatusBonusOpt(),
                i = n.getStatusBonusOpt(r);
            i.hasSeriesBonus ? t("[data-app-selected-supporter-aura]").removeClass("di-n") : i.hasRoleBonus ? t("[data-app-selected-supporter-role-aura]").removeClass("di-n") : this.hideSupporterAura()
        },
        hideSupporterAura: function() {
            t("[data-app-selected-supporter-aura]").addClass("di-n"), t("[data-app-selected-supporter-role-aura]").addClass("di-n")
        },
        renderSelectedSupporter: function(e) {
            var n = e.elem || "";
            t("[data-app-selected-supporter]").html(n)
        },
        onClickBack: function() {
            window.history.back()
        },
        onClickNext: function() {
            FF.router.loading.lock(), this.dungeonEnterDeferred({
                selectionId: this.selectionId
            })
        },
        dungeonEnterDeferred: function(e) {
            e = e || {};
            var t = this,
                n = this.dungeonModel.get("id"),
                r = this.worldModel.getApiOptions();
            return r.fellowUserId = e.selectionId || void 0, this.checkDeferred().then(function() {
                return o.dungeonEnterDeferred(n, r)
            }).then(function(e) {
                t.processAfterEnterResponse(e)
            }).then(function() {
                return s.removeItemDeferred("LATEST_UNLOCK_DUNGEONS")
            }).then(function(e) {
                return p.saveDungeonDataByModelsDeferred(t.worldModel, t.dungeonModel)
            })
        },
        processAfterEnterResponse: function(e) {
            FF.datastore.userModel.set(e.user), this.dungeonModel.set("is_new", !1);
            var t = this.worldModel.getBattleListFragment(this.dungeonModel.get("id"));
            this.playDungeonWarp(e, t)
        },
        playDungeonWarp: function(e, t) {
            var r = this;
            FF.router.dungeonWarpViewController.loadAssetsDeferred(e.assets).then(function() {
                return FF.router.dungeonWarpViewController.playWarpInDeferred()
            }, function() {
                FF.logger.debug("Retrying dungeon warp animation.."), setTimeout(function() {
                    r.playDungeonWarp(e, t)
                }, 1e3)
            }).then(function() {
                return FF.router.dungeonWarpViewController.playWarpLoop(), h.useSyncAnimationIfNeededDeferred()
            }).then(function() {
                return i.hasFileNeededToDownloadDeferred(e.precache_list, {
                    url: t,
                    forceDownload: !0
                })
            }).then(function(e) {
                e.needDownload ? n.history.navigate("download", {
                    trigger: !0
                }) : n.history.navigate(t, {
                    trigger: !0
                })
            })
        },
        onClickDungeonInfo: function() {
            l.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel,
                selectedType: c.SELECTED_TYPE_OF.BOSS
            })
        },
        dispose: function() {
            this.overscrollable && this.overscrollable.dispose(), this.scrollbar && this.scrollbar.dispose(), this.profileDetailModalView && this.profileDetailModalView.dispose(), b.prototype.dispose.call(this)
        }
    })
}), define("scenes/dungeon/DungeonScene", ["underscore", "jquery", "backbone", "lib/Scene", "lib/Download", "scenes/dungeon/Api", "scenes/progress_map/LatestProgressData", "./pages/List", "./pages/Info", "./pages/Party", "./pages/Supporter"], function(e, t, n, r, i, s, o, u, a, f, l) {
    return r.extend({
        pages: {
            list: u,
            info: a,
            party: f,
            supporter: l
        },
        setupDeferred: function(e, r) {
            var o = t.Deferred();
            r = r || {};
            var u = FF.datastore.worldCollection.get(+e);
            return !u || !u.canBeginBattleTerm() ? (n.history.navigate("#home", {
                trigger: !0
            }), o.reject().promise()) : this.hasFetchedDungeonData(e) && !r.forceFetchDungeonData ? o.resolve().promise() : (s.dungeonListDeferred(e, r).done(function(t) {
                FF.datastore.dungeonCollection.addByWorldId(e, t.dungeons), i.hasFileNeededToDownloadDeferred(t.assets, {
                    url: location.hash
                }).then(function(e) {
                    e.needDownload ? (n.history.navigate("download", {
                        trigger: !0
                    }), o.reject()) : o.resolve(t)
                })
            }), o.promise())
        },
        hasFetchedDungeonData: function(e) {
            return FF.datastore.dungeonCollection.isAddedByWorldId(e)
        },
        start: function(e, t) {
            var n = this,
                r = t[0];
            this.redirectToProgressMapDeferred(e).then(function() {
                return n.setupDeferred(r)
            }).then(function() {
                n.showPage(e, t)
            })
        },
        redirectToProgressMapDeferred: function(e) {
            var r = t.Deferred();
            return e !== "list" ? r.resolve().promise() : (o.getCanReturnDeferred().then(function(e) {
                e.canReturn ? (n.history.navigate("#progress_map", {
                    trigger: !0
                }), r.reject()) : r.resolve()
            }), r.promise())
        },
        showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose();
            if (!this.pages[e]) throw new Error("invalid page invoked in DungeonDetail. pageName: " + e);
            this.layoutView = new this.pages[e]({
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.render(e)
            })
        }
    })
}), define("scenes/operation/pages/Page", ["underscore", "jquery", "backbone", "lib/LayoutBase", "scenes/common/helper/DungeonBackground"], function(e, t, n, r, i) {
    return r.extend({
        contentType: "NO_BASE",
        designType: "CLASSIC",
        setupDeferred: function() {
            return t.Deferred().resolve().promise()
        },
        updateBackground: function() {
            var e = FF.datastore.currentDungeonModel,
                t = i.getPathByDungeonId(e.get("id"), {
                    isForce: e.isForce()
                });
            this.setBackgroundImage(pUrl(t))
        }
    })
}), define("scenes/operation/views/TentAnimation", ["underscore", "jquery", "backbone"], function(e, t, n) {
    return n.View.extend({
        showTentMessage: function() {
            FF.router.toast.topping(t("#tent-message-template").text()).bake()
        },
        play: function() {
            var e = this,
                n, r = "pe-n",
                i = "di-n",
                s = t("#tentOverlay"),
                o = t("body"),
                u = "webkitAnimationEnd animationend";
            kickmotor.sound.getBackgroundMusicVolume(function(e) {
                e.volume !== undefined && (n = e.volume)
            }), o.addClass(r), s.removeClass(i), kickmotor.sound.setBackgroundMusicVolume(0), s.addClass("animate-on").one(u, function() {
                kickmotor.sound.playEffect("se_common_100024", !1), e.trigger("onAnimationPlayed"), s.addClass("animate-off").one(u, function() {
                    e.trigger("onAnimationEnd"), o.removeClass(r), kickmotor.sound.setBackgroundMusicVolume(n), e.showTentMessage(), s.removeClass("animate-on animate-off").addClass(i)
                })
            })
        }
    })
}), define("scenes/operation/views/ModalTentRecovery", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "scenes/common/helper/TermCheck", "scenes/common/views/ModalRetry", "lib/ModalBase", "templates/operation/ModalTentRecovery", "templates/operation/ModalTentRecoveryConfirm"], function(e, t, n, r, i, s, o, u, a) {
    return o.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose",
            "anchorsbeforejump [data-app-recover-items]": "onClickRecoverItems",
            "anchorsbeforejump [data-app-recover-coin]": "onClickRecoverCoin",
            "anchorsbeforejump [data-app-items-confirm]": "onClickItemsConfirm",
            "anchorsbeforejump [data-app-guide]": "onClickGuide"
        },
        _coinNum: 0,
        initialize: function() {
            var e = this;
            o.prototype.initialize.apply(this, arguments), kickmotor.platform.setMobageDashboardListener(function() {}, function() {
                FF.router.loading.show(), e.setBalanceDeferred().done(function() {
                    e.render()
                })
            }, function() {})
        },
        setBalanceDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = {};
            return FF.env.isWWRegion() && (i.handleRetry = !0, i.ModalRetry = s), r.getBalanceDeferred(i).done(function(t) {
                e._coinNum = t, n.resolve()
            }), n.promise()
        },
        render: function() {
            this.renderContent(u, {
                userModel: FF.datastore.userModel,
                coinNum: this._coinNum,
                config: FF.Config.server.recover.tent,
                showMobageLegal: FF.env.isShowingMobageLegal()
            }), FF.router.loading.hide(!0)
        },
        onClickModalClose: function() {
            this.end()
        },
        onClickRecoverItems: function() {
            this.$el.empty(), this.$el.html(a({
                config: FF.Config.server.recover.tent
            }))
        },
        onClickItemsConfirm: function() {
            FF.router.loading.lock();
            var e = this;
            i.showModalIfClosedDeferred().then(function() {
                var n = t.Deferred();
                return r.useTentDeferred().done(function(t) {
                    FF.datastore.userModel.set(t.user), FF.datastore.dungeonSessionModel.set(t.dungeon_session), FF.datastore.partyStatusModel.set(t.dungeon_session.party_status), e.trigger("startTentAnimation"), n.resolve()
                }), n.promise()
            })
        },
        onClickRecoverCoin: function() {
            FF.router.loading.lock();
            var e = this;
            i.showModalIfClosedDeferred().then(function() {
                var n = t.Deferred();
                return r.purchaseItemDeferred({
                    id: e._getPaymentProductId(),
                    quantity: 1
                }).done(function(t) {
                    var r = JSON.parse(t);
                    if (!r.success) throw new Error("faild_payment");
                    var i = r.payment_result;
                    FF.datastore.dungeonSessionModel.set(i.dungeon_session), FF.datastore.partyStatusModel.set(i.dungeon_session.party_status), e.trigger("startTentAnimation"), n.resolve()
                }).fail(function(e) {
                    FF.router.loading.unlock(), n.reject()
                }), n.promise()
            })
        },
        _getPaymentProductId: function() {
            return FF.env.isWWRegion() ? {
                entryPointId: FF.Config.server.recover.tent.payment.paymentProductId,
                price: FF.Config.server.recover.tent.payment.payCost,
                modalOptions: {
                    confirmType: "strategy"
                }
            } : FF.Config.server.recover.tent.payment.paymentProductId
        },
        onClickGuide: function() {
            kickmotor.nativefn.call("mobageLegal")
        },
        dispose: function() {
            kickmotor.platform.resetMobageDashboardListener(), o.prototype.dispose.apply(this, arguments)
        }
    })
}), define("scenes/operation/pages/Party", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "scenes/common/Constant", "scenes/battle_list/Api", "scenes/party/Api", "scenes/common/helper/Align", "scenes/common/helper/LockFlagManager", "scenes/party/views/ModalCharacterDetail", "./Page", "scenes/operation/views/TentAnimation", "scenes/operation/views/ModalTentRecovery", "scenes/common/views/ModalBattleEscape", "scenes/common/helper/DungeonInfo", "templates/operation/Party"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v) {
    var m = e.extend({}, i, {
        DISPLAY_CLASS_NAME: "di-n",
        DISABLE_CLASS_NAME: "is-disable",
        ENABLE_CLASS_NAME: "is-enable",
        TOGGLE_CLASS_NAME: "is-toggle",
        BACKGROUND_CLASS_NAME: "is-bg-n"
    });
    return l.extend({
        events: {
            "anchorsbeforejump [data-app-full-recovery]": "onClickFullRecovery",
            "anchorsbeforejump [data-app-escape]": "onClickEscape",
            "anchorsbeforejump [data-app-soul-strike-btn]": "onClickSoulStrikeChange",
            "anchorsbeforejump [data-app-dungeon-info]": "onClickDungeonInfo",
            "anchorsbeforejump [data-app-party-member-img]": "onClickBuddyImg",
            "anchorsbeforejump #alignEdit": "onClickAlignEdit",
            "anchorsbeforejump #alignEditDecide": "onClickAlignEdit",
            "anchorslongtap [data-app-party-member-img]": "onLongTapCharaDetailView"
        },
        initialize: function() {
            var e = FF.datastore;
            this.buddyModels = e.partyModel.getBuddyModels(), this.partyStatusModel = e.partyStatusModel, this.dungeonModel = e.currentDungeonModel, this.dungeonSessionModel = e.dungeonSessionModel, this.worldModel = this.dungeonSessionModel.getWorldModel(), this.lockFlagManager = new a, this.lockFlagManager.initialize(["isEditingAlign"]), this.ailmentIntervalTimers = [], u.initialize(), l.prototype.initialize.call(this)
        },
        render: function(e) {
            this._renderTmpl(), this.updateBackground(), this.setupAilmentsInterval(), this.partyStatusModel.isFullRecovery() && this.hideFullRecoveryButton(), this.processAfterRender()
        },
        _renderTmpl: function() {
            var e = FF.datastore.fellowSessionModel;
            this._fellowProfileModel || (this._fellowProfileModel = e.createFellowProfileModel()), l.prototype.render.call(this, v, {
                statusBonusOpt: this.dungeonSessionModel.getStatusBonusOpt(),
                buddyModels: this.buddyModels,
                partyStatusMap: this.partyStatusModel.getIdToDataMap(),
                fellowProfileModel: this._fellowProfileModel,
                userSssGauge: this.dungeonSessionModel.get("supporter_ss_gauge"),
                userMaxSssGauge: this.dungeonSessionModel.get("max_supporter_ss_gauge"),
                maxSssGauge: FF.datastore.userModel.get("supporter_ss_gauge")
            })
        },
        onLongTapCharaDetailView: function(e) {
            if (this.lockFlagManager.isLocked("isEditingAlign")) return;
            var n = t(e.target).closest("[data-app-buddy-id]"),
                r = n.attr("data-app-buddy-id");
            this.openCharacterDetail(r), FF.SoundMgr.playChooseEffect()
        },
        openCharacterDetail: function(e) {
            var t = FF.datastore.buddyCollection.get(e);
            FF.modalStack.push(f, {
                renderer: function(e) {
                    e.render(t)
                }
            })
        },
        setupAilmentsInterval: function() {
            var n = t("[data-app-ailment-type]").not('[data-app-ailment-type=""]');
            e.each(n, this.startAilmentsInterval.bind(this))
        },
        startAilmentsInterval: function(e, n) {
            var r = this,
                i = t(e).attr("data-app-ailment-type"),
                s = i.split(" ");
            s.length === 1 ? this.setAilmentsClass(e, n) : this.ailmentIntervalTimers[n] = setInterval(function() {
                r.setAilmentsClass(e, n)
            }, 1e3)
        },
        setAilmentsClass: function(n, r) {
            var i = t(n).attr("data-app-ailment-type"),
                s = i.split(" "),
                o = s.shift(),
                u = t(n).attr("class").split(" "),
                a = e.find(u, function(e) {
                    return e.indexOf("is-") > -1
                });
            a && (t(n).removeClass(a), s.push(a)), t(n).addClass(o), t(n).attr("data-app-ailment-type", s.join(" "))
        },
        clearAilmentsInterval: function() {
            var t = this;
            e.each(this.ailmentIntervalTimers, function(e, n) {
                clearInterval(t.ailmentIntervalTimers[n])
            })
        },
        hideFullRecoveryButton: function() {
            t("[data-app-full-recovery]").addClass("is-disable")
        },
        afterRecover: function() {
            this._renderTmpl(), this.updateBackground(), this.hideFullRecoveryButton()
        },
        startTentAnimation: function() {
            this.animation = new c, this.listenToOnce(this.animation, "onAnimationPlayed", function() {
                this.modalTentRecoveryView.$el.hide(), this.afterRecover()
            }.bind(this)), this.listenToOnce(this.animation, "onAnimationEnd", function() {
                this.modalTentRecoveryView.end(), this.modalTentRecoveryView.$el.show(), FF.router.loading.hide()
            }.bind(this)), this.animation.play()
        },
        onClickBack: function() {
            FF.router.loading.lock();
            var e = this.worldModel.getBattleListFragment(this.dungeonSessionModel.get("dungeon_id"));
            return n.history.navigate(e, {
                trigger: !0
            })
        },
        onClickEscape: function() {
            FF.router.loading.lock(), this.modalBattleEscape = new p({
                isDisposingBattleListViewRequired: !0
            }), this.modalBattleEscape.render(), FF.router.overlay.registerChildren(this.modalBattleEscape), this.modalBattleEscape.open()
        },
        onClickDungeonInfo: function() {
            d.openDeferred(this.dungeonModel.get("dungeon_id"), {
                dungeonModel: this.dungeonModel
            })
        },
        onClickFullRecovery: function() {
            FF.router.loading.show();
            var e = this;
            this.modalTentRecoveryView = new h, this.modalTentRecoveryView.setBalanceDeferred().done(function() {
                e.modalTentRecoveryView.render(), FF.router.overlay.registerChildren(e.modalTentRecoveryView), e.modalTentRecoveryView.open(), e.listenToOnce(e.modalTentRecoveryView, "onClickRecoverItems", e.onClickRecoverItems), e.listenToOnce(e.modalTentRecoveryView, "startTentAnimation", e.startTentAnimation)
            })
        },
        onClickSoulStrikeChange: function(e) {
            var n = t(e.target).closest("[data-app-buddy-id]").attr("data-app-buddy-id"),
                r = sprintf("#party/soul_strike_change/%s", n);
            FF.router.navigate(r, {
                trigger: !0,
                params: {
                    isInOperation: !0,
                    backFragment: "#operation/party"
                }
            })
        },
        onClickAlignEdit: function() {
            FF.router.loading.show();
            var e = this;
            this.lockFlagManager.isLocked("isEditingAlign") ? u.onCompleteChangeAlignDeferred().done(function() {
                e._toggleEnableAlignEdit(), e.lockFlagManager.unlock("isEditingAlign"), FF.router.loading.hide()
            }) : (this._toggleEnableAlignEdit(), this.lockFlagManager.lock("isEditingAlign"), FF.router.loading.hide())
        },
        _toggleEnableAlignEdit: function() {
            t("#alignEdit").toggleClass(m.DISPLAY_CLASS_NAME), t("#alignEditDecide").toggleClass(m.DISPLAY_CLASS_NAME).toggleClass(m.ENABLE_CLASS_NAME), t("[data-app-party-member-img]").toggleClass(m.TOGGLE_CLASS_NAME), t("[data-app-buddy-align-list]").toggleClass(m.ENABLE_CLASS_NAME), t("#operationOverlay").toggleClass(m.DISPLAY_CLASS_NAME), t("[data-app-toggle-align]").toggleClass(m.BACKGROUND_CLASS_NAME)
        },
        onClickBuddyImg: function(e) {
            if (!this.lockFlagManager.isLocked("isEditingAlign")) {
                FF.SoundMgr.playNgEffect();
                return
            }
            this.toggleAlign(e)
        },
        toggleAlign: function(e) {
            var n = t(e.originalEvent.srcElement).find("[data-app-toggle-align]"),
                r = n.toggleClass("is-back"),
                i = t(n).closest("[data-app-buddy-id]").attr("data-app-buddy-id");
            u.setPartyAlign(r, i)
        },
        dispose: function() {
            this.clearAilmentsInterval(), this.lockFlagManager && this.lockFlagManager.dispose(), this.modalBattleEscape && this.modalBattleEscape.dispose(), this.modalTentRecoveryView && this.modalTentRecoveryView.dispose(), this.resetBackgroundImage(), l.prototype.dispose.call(this)
        }
    })
}), define("scenes/operation/OperationScene", ["underscore", "jquery", "backbone", "scenes/battle_list/Api", "lib/Scene", "./pages/Party"], function(e, t, n, r, i, s) {
    return i.extend({
        pages: {
            party: s
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred(),
                i = FF.datastore;
            return i.hasDungeonSession() ? n.resolve().promise() : (r.dungeonSessionDeferred().then(function(e) {
                i.setDungeonSession(e), n.resolve(e)
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e, t)
            })
        },
        showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose();
            if (!this.pages[e]) throw new Error("invalid page invoked in Operations. pageName: " + e);
            this.layoutView = new this.pages[e]({
                args: t || []
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.render(e), FF.SoundMgr.playMusic(FF.datastore.currentDungeonModel.get("bgm"))
            })
        }
    })
}), define("scenes/achievement_room/pages/Page", ["underscore", "jquery", "backbone", "../Api", "lib/LayoutBase"], function(e, t, n, r, i) {
    return i.extend({
        categoryType: "home",
        contentType: "BASE",
        designType: "MODERN",
        setupDeferred: function() {
            var e = t.Deferred();
            return e.resolve(), e.promise()
        }
    })
}), define("scenes/achievement_room/pages/Top", ["underscore", "jquery", "backbone", "util", "../Api", "./Page", "templates/achievement_room/Top", "scenes/common/helper/FuncTutorial"], function(e, t, n, r, i, s, o, u) {
    return s.extend({
        events: {
            "anchorsbeforejump [data-app-next]": "onClickNext"
        },
        render: function() {
            s.prototype.render.call(this, o, {}), this.setupComponents(), this.processAfterRender()
        },
        setupComponents: function() {},
        processAfterContentLoad: function() {
            s.prototype.processAfterContentLoad.call(this);
            var e = this;
            u.showNavigationDeferred({
                key: "ACHIEVEMENT_ROOM",
                isTutorialIllustOnly: !0
            }).then(function() {
                e.startUpSlideInAnimation()
            })
        },
        onClickBack: function() {
            n.history.navigate("#home", {
                trigger: !0
            })
        }
    })
}), define("scenes/common/collections/BuddyAchievementInfo", ["lib/Collection", "../models/BuddyAchievementInfo", "scenes/common/helper/SortAdviser"], function(e, t, n) {
    return e.extend({
        model: t,
        initialize: function() {
            this.SORT_TYPE_OF = FF.datastore.buddyCollection.SORT_TYPE_OF, this._initSortAdviser()
        },
        _initSortAdviser: function() {
            this._sortAdviser = new n({
                defaultComparator: this._defaultComparator.bind(this)
            })
        },
        _defaultComparator: function(e, t) {
            return e.get("series_id") < t.get("series_id") ? -1 : e.get("series_id") > t.get("series_id") ? 1 : e.get("buddy_id") < t.get("buddy_id") ? -1 : e.get("buddy_id") > t.get("buddy_id") ? 1 : 0
        },
        changeComparator: function(e, t) {
            if (!e || !e.sortType) {
                this.comparator = this._defaultComparator;
                return
            }
            var n = this.SORT_TYPE_OF,
                r = e.sortType;
            (r === n.IS_ACQUIRED || r === n.IS_NOT_ACQUIRED) && this._appendNum(t);
            var i = this,
                s = function(t, n) {
                    i.comparator = i._sortAdviser.getComparator(e, t, n)
                };
            switch (r) {
                case n.IS_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.DESC, s("num");
                    break;
                case n.IS_NOT_ACQUIRED:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("num");
                    break;
                case n.SERIES_ID:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("series_id");
                    break;
                case n.CHARA_ROLE:
                    e.orderType = FF.CONST.CLIENT.GENERAL_ORDER_TYPE_OF.ASC, s("role_type");
                    break;
                default:
                    this.comparator = this._defaultComparator
            }
        },
        _appendNum: function(e) {
            var t = this;
            this.each(function(t) {
                var n = t.get("buddy_id"),
                    r = e.findWhere({
                        buddy_id: n
                    }),
                    i = r ? 1 : 0;
                t.set("num", i)
            })
        }
    })
}), define("scenes/achievement_room/pages/Buddy", ["underscore", "jquery", "backbone", "util", "lib/TemplateRenderer", "../Api", "./Page", "scenes/common/views/OverScrollView", "templates/achievement_room/Buddy", "templates/achievement_room/views/BuddyList", "scenes/common/views/ModalCharacterAchievementInfo", "scenes/common/collections/Buddy", "scenes/common/collections/BuddyAchievementInfo", "scenes/common/collections/ItemAchievementInfo", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        SORT_MODULE_KEY: "achievement_buddy"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-buddylist-buddy-id]": "onClickBuddyListItem",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function() {
            this.releasedBuddyCollection = new h, this.itemAchievementInfoCollection = new p, this.achievedMemoryCrystalMap = void 0, this.achievedIdMap = void 0, this._initSortOptions(), o.prototype.initialize.call(this)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), d.resetSceneScopeStatus(v.SORT_MODULE_KEY), this._sortOptions = d.getDefaultSortOptions(v.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var t = this;
            return s.getReleasedBuddyListDeferred().then(function(n) {
                t.releasedBuddyCollection.add(n.buddies), t.itemAchievementInfoCollection.add(n.item_achievement_infos), t.achievedIdMap = n.achieved_buddy_map, t.itemAchievementInfoMap = t.itemAchievementInfoCollection.getAvailableMap(), t.achievedBuddyMap = e.indexBy(FF.datastore.buddyCollection.models, function(e) {
                    return e.get("buddy_id")
                })
            })
        },
        render: function() {
            o.prototype.render.call(this, a), this.renderOverScrollView(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "BUDDY_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderOverScrollList: function(e) {
            this.releasedBuddyCollection.changeComparator(e, FF.datastore.buddyCollection), this.releasedBuddyCollection.sort();
            var t = this.releasedBuddyCollection.length;
            this.overScrollView.updateCollectionSize(t), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = i.process(f, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    releasedBuddyModels: this.releasedBuddyCollection.slice(e, n),
                    itemAchievementInfoMap: this.itemAchievementInfoMap,
                    achievedBuddyMap: this.achievedBuddyMap
                }),
                s = t("[data-app-list-items]");
            this.overScrollView.render({
                html: r,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickBuddyListItem: function(e) {
            if (FF.router.loading.isLocked()) return;
            FF.router.loading.lock();
            var t = e.currentTarget,
                n = t.attributes["data-app-buddylist-buddy-id"].value;
            this.openCharacterAchievementInfoModal(n), FF.SoundMgr.playChooseEffect()
        },
        openCharacterAchievementInfoModal: function(e) {
            var t = this.releasedBuddyCollection.get(e),
                n = this.itemAchievementInfoCollection.getAvailableListByItemId(e),
                r = this.achievedBuddyMap[e] || null,
                i = {
                    buddy: t,
                    itemAchievementInfos: n,
                    achievedBuddy: r
                };
            FF.modalStack.push(l, {
                initDeferred: function(e) {
                    return e.setupDeferred({
                        achievementInfo: i
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onClickBack: function() {
            if (FF.router.loading.isLocked()) return;
            FF.router.loading.lock(), n.history.navigate("#achievement_room/top", {
                trigger: !0
            })
        },
        onClickOpenSortModal: function() {
            d.openModalDeferred(v.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        dispose: function() {
            o.prototype.dispose.call(this), this.overScrollView && this.overScrollView.dispose()
        }
    })
}), define("scenes/achievement_room/pages/MemoryCrystal", ["underscore", "jquery", "backbone", "util", "lib/TemplateRenderer", "../Api", "./Page", "scenes/common/views/OverScrollView", "scenes/achievement_room/views/ModalTransferConfirm", "templates/achievement_room/MemoryCrystal", "templates/achievement_room/views/MemoryCrystalList", "scenes/common/collections/MemoryCrystal", "scenes/common/collections/ItemAchievementInfo", "scenes/common/helper/DungeonInfo", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d) {
    var v = {
        SORT_MODULE_KEY: "achievement_memory_crystal"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-transfer]": "onClickTransfer",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function() {
            this.releasedMemoryCrystalCollection = new c, this.itemAchievementInfoCollection = new h, this.achievedMemoryCrystalMap = void 0, this._initSortOptions(), o.prototype.initialize.call(this)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), d.resetSceneScopeStatus(v.SORT_MODULE_KEY), this._sortOptions = d.getDefaultSortOptions(v.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var e = this;
            return s.getReleasedMemoryCrystalListDeferred().then(function(t) {
                e.releasedMemoryCrystalCollection.add(t.memory_crystals), e.itemAchievementInfoCollection.add(t.item_achievement_infos), e.itemAchievementInfoMap = e.itemAchievementInfoCollection.getAvailableMap(), e.achievedMemoryCrystalMap = t.achieved_memory_crystal_map
            })
        },
        render: function() {
            o.prototype.render.call(this, f), this.renderOverScrollView(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "RECORD_MATERIA_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderOverScrollList: function(e) {
            this.releasedMemoryCrystalCollection.changeComparatorForAchievementRoom(e, this.achievedMemoryCrystalMap), this.releasedMemoryCrystalCollection.sort();
            var t = this.releasedMemoryCrystalCollection.length;
            this.overScrollView.updateCollectionSize(t), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                r = i.process(l, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    releasedMemoryCrystalModels: this.releasedMemoryCrystalCollection.slice(e, n),
                    itemAchievementInfoMap: this.itemAchievementInfoMap,
                    achievedMemoryCrystalMap: this.achievedMemoryCrystalMap
                }),
                s = t("[data-app-list-items]");
            this.overScrollView.render({
                html: r,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickTransfer: function(e) {
            var n = this,
                r = t(e.target).attr("data-app-type"),
                i = t(e.target).attr("data-app-item-id"),
                s = this.releasedMemoryCrystalCollection.get(+i),
                o = this.itemAchievementInfoMap[i];
            o.isTypeDungeon() ? p.openDeferred(o.get("dungeon_id"), {
                enableChallengeButton: !0
            }) : FF.modalStack.push(a, {
                initializer: function(e) {
                    return new e({
                        itemModel: s,
                        itemAchievementInfoModel: o
                    })
                },
                renderer: function(e) {
                    e.render()
                }
            })
        },
        onClickOpenSortModal: function() {
            d.openModalDeferred(v.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickBack: function() {
            var e = FF.router.flash().backFragment || "#achievement_room/top";
            n.history.navigate(e, {
                trigger: !0
            })
        }
    })
}), define("scenes/achievement_room/views/ModalRecordMateriaDetail", ["underscore", "jquery", "backbone", "scenes/party/Api", "lib/ModalBase", "templates/achievement_room/views/ModalRecordMateriaDetail"], function(e, t, n, r, i, s) {
    return i.extend({
        el: "[data-app-modal]",
        events: {
            "anchorsbeforejump [data-app-modal-close]": "onClickModalClose"
        },
        onClickModalClose: function() {
            FF.modalStack.popToTotem()
        },
        render: function(e) {
            this.renderContent(s, {
                recordMateria: e,
                equippedBuddy: e.getEquippedBuddy()
            })
        }
    })
}), define("scenes/achievement_room/pages/RecordMateria", ["underscore", "jquery", "backbone", "lib/TemplateRenderer", "util", "../Api", "./Page", "scenes/common/views/OverScrollView", "scenes/achievement_room/views/ModalRecordMateriaDetail", "templates/achievement_room/RecordMateria", "templates/achievement_room/views/RecordMateriaList", "scenes/common/collections/RecordMateria", "scenes/common/collections/ItemAchievementInfo", "scenes/common/ui_module/SortModuleFacade"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p) {
    var d = {
        SORT_MODULE_KEY: "achievement_record_materia"
    };
    return o.extend({
        events: {
            "anchorsbeforejump [data-app-item-id]": "onClickDetail",
            "anchorsbeforejump [data-app-open-sort-modal]": "onClickOpenSortModal"
        },
        initialize: function() {
            this.releasedRecordMateriaCollection = new c, this.itemAchievementInfoCollection = new h, this.achievedRecordMateriaMap = void 0, this.achievedIdMap = void 0, this._initSortOptions(), o.prototype.initialize.call(this)
        },
        _initSortOptions: function() {
            FF.resonator.resetSimulation(), p.resetSceneScopeStatus(d.SORT_MODULE_KEY), this._sortOptions = p.getDefaultSortOptions(d.SORT_MODULE_KEY)
        },
        setupDeferred: function() {
            var t = this;
            return s.getReleasedRecordMateriaListDeferred().then(function(n) {
                t.releasedRecordMateriaCollection.add(n.record_materias), t.itemAchievementInfoCollection.add(n.item_achievement_infos), t.achievedIdMap = n.achieved_record_materia_map, t.itemAchievementInfoMap = t.itemAchievementInfoCollection.getAvailableMap(), t.achievedRecordMateriaMap = e.indexBy(FF.datastore.recordMateriaCollection.models, "id")
            })
        },
        render: function() {
            o.prototype.render.call(this, f), this.renderOverScrollView(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        renderOverScrollView: function() {
            this.overScrollView = new u({
                displayType: "RECORD_MATERIA_TILE",
                listElement: t("[data-app-list-items]"),
                useNativeScroll: !1
            }), this.listenTo(this.overScrollView, "requestRender", this._renderItems)
        },
        renderOverScrollList: function(e) {
            this.releasedRecordMateriaCollection.changeComparatorForAchievementRoom(e, this.achievedIdMap), this.releasedRecordMateriaCollection.sort();
            var t = this.releasedRecordMateriaCollection.length;
            this.overScrollView.updateCollectionSize(t), this.overScrollView.setMaxPageText(), this._renderItems()
        },
        _renderItems: function() {
            var e = this.overScrollView.getStartNum(),
                n = this.overScrollView.getEndNum(),
                i = r.process(l, {
                    renderIndex: this.overScrollView.getCurrentPage(),
                    releasedRecordMateriaModels: this.releasedRecordMateriaCollection.slice(e, n),
                    itemAchievementInfoMap: this.itemAchievementInfoMap,
                    achievedRecordMateriaMap: this.achievedRecordMateriaMap
                }),
                s = t("[data-app-list-items]");
            this.overScrollView.render({
                html: i,
                parentElement: s,
                imageWatcher: this.imageWatcher
            }), this.processAfterRender({
                notShowDeshi: !0
            })
        },
        onClickDetail: function(e) {
            var n = t(e.target).attr("data-app-item-id"),
                r = this.releasedRecordMateriaCollection.get(+n);
            FF.modalStack.push(a, {
                renderer: function(e) {
                    e.render(r)
                }
            })
        },
        onClickOpenSortModal: function() {
            p.openModalDeferred(d.SORT_MODULE_KEY).done(this._onChangeSort.bind(this))
        },
        _onChangeSort: function(e) {
            this._sortOptions = e, this.overScrollView.cleanup(), this.renderOverScrollList(this._sortOptions), this._updateSortOptionButtonFace(this._sortOptions)
        },
        _updateSortOptionButtonFace: function(e) {
            t("#sort-modal-btn").html(e.buttonFace)
        },
        onClickBack: function() {
            var e = FF.router.flash().backFragmentForRecordMateriaList || "#achievement_room/top";
            FF.router.navigate(e, {
                trigger: !0,
                params: FF.router.flash()
            })
        }
    })
}), define("scenes/achievement_room/AchievementRoomScene", ["underscore", "jquery", "backbone", "lib/Scene", "./Api", "scenes/party/Api", "./pages/Top", "./pages/Buddy", "./pages/MemoryCrystal", "./pages/RecordMateria"], function(e, t, n, r, i, s, o, u, a, f) {
    return window.API = i, r.extend({
        pages: {
            top: o,
            buddy: u,
            memory_crystal: a,
            record_materia: f
        },
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.datastore.hasPartyAllData() ? n.resolve().promise() : (s.partyListDeferred().done(function(e) {
                FF.datastore.addPartyAllData(e), n.resolve(e)
            }), n.promise())
        },
        start: function(e, t) {
            var n = this;
            this.setupDeferred().then(function() {
                n.showPage(e || "top", t);
                var r = FF.router.flash();
                r.backFragmentForRecordMateriaList || FF.SoundMgr.playMusic("bgm_09_040")
            })
        },
        showPage: function(e, t) {
            var n = this;
            this.layoutView && this.layoutView.dispose();
            if (!this.pages[e]) throw new Error("invalid page invoked in AchievementRoom. pageName: " + e);
            this.layoutView = new this.pages[e]({
                args: t
            }), this.layoutView.setupDeferred().done(function(e) {
                n.layoutView.render(e)
            })
        }
    })
}), define("scenes/progress_map/Api", ["jquery", "underscore", "scenes/common/util/Api"], function(e, t, n) {
    return t.extend({}, n, {
        getDungeonPrologueAssetDeferred: function(e, t) {
            return t = t || {}, this.requestDeferred("/dff/progress_map/get_dungeon_prologue_asset", {
                dungeon_id: e
            }, t)
        },
        getProgressMapBySegmentDeferred: function(e, n, r, i) {
            return r = r || {}, i = i || {}, this.requestDeferred("/dff/progress_map/get_progress_map_by_segment", t.extend({
                start_level: e,
                end_level: n
            }, r), i)
        }
    })
}), define("scenes/progress_map/ProgressMapViewController", ["underscore", "jquery", "backbone", "lib/ab/ABLayer", "lib/ab/ABNode", "lib/ab/ABNodeButton", "lib/ab/CommonAssetsManager", "lib/EventBase", "lib/Storage", "./Api", "./LatestProgressData", "util"], function(e, t, n, r, i, s, o, u, a, f, l, c) {
    var h = kickmotor.nativefn.getLogicalScreenHeight(),
        p = {
            MASK_MARGIN_TOP: 58,
            MASK_MARGIN_BOTTOM: 0,
            BG_IMAGE_WIDTH: 320,
            BG_IMAGE_HEIGHT: 568,
            SCREEN_WIDTH: 320,
            DUNGEON_ICON_OFFSET_X: 44,
            DUNGEON_ICON_OFFSET_Y: 100,
            DUNGEON_ICON_WIDTH: 58,
            DUNGEON_ICON_HEIGHT: 60,
            DUNGEON_NUM_IN_PAGE: 30,
            MAX_PAGE_NUM: 2,
            DRAG_MARGIN: 100,
            PULL_THRESHOLD: 80,
            FLOATING_BUTTON_MSEC: 1200,
            FLOATING_BUTTON_THRESHOLD: 30,
            OFFSET_BAR_TOP: 100,
            OFFSET_BAR_BOTTOM: 71,
            DEAULT_DUNGEON_ID: 207001,
            LATEST_UNLOCK_DUNGEONS_DATA_KEY: "LATEST_UNLOCK_DUNGEONS",
            BAR_DESHI_POS_X: 314
        };
    p.BAR_BG_HEIGHT = h - p.OFFSET_BAR_TOP - p.OFFSET_BAR_BOTTOM, p.OFFSET_BAR_TOP_FOR_DESHI = p.OFFSET_BAR_TOP, p.BAR_BG_HEIGHT_FOR_DESHI = p.BAR_BG_HEIGHT + 10;
    var d = {
            BTN_BACK_CLICKED: "btn_back_clicked",
            BTN_DUNGEON_SELECT: "btn_dungeon_select",
            BTN_DUNGEON_DETAIL: "btn_dungeon_detail",
            BTN_WORLD_BACK: "btn_world_back"
        },
        v = {
            MODAL: "progressmap_modal",
            MAP_UI: "progressmap_map_ui",
            DUNGEON: "progressmap_dungeon"
        },
        m = {
            CLEAR: 1,
            FIRST_CLEAR: 2,
            FIRST_MASTER: 3
        },
        g = {
            NEW: 1,
            ENTERED: 2,
            CLEARED: 3,
            MASTERED: 4
        },
        y = {
            TOP: 1,
            BOTTOM: 2
        };
    return u.extend({
        initialize: function(t) {
            FF.logger.debug("init progress map view controller"), kickmotor.nativefn.call("setIsEnableTouchEvent", {
                isEnable: !1
            }), this._assetId = "progress_map", this._assetsManager = void 0;
            var n = this,
                r = this._validateData(t.data);
            this._assets = r.assets, this._progressMap = r.progressMap.normal, this._forceProgressMap = r.progressMap.force, this._userData = r.userData.dungeon, this._newestLevel = r.userData.newestLevel, this._startLevel = r.startLevel, this._endLevel = r.endLevel, this._maxLevel = r.maxLevel + 1, this._hasComingSoon = r.hasComingSoon, this._hasLevelOf = {};
            var i = e.range(this._startLevel, this._endLevel + 1);
            e.each(i, function(e) {
                n._hasLevelOf[e] = !0
            }), this._ab = {}, this._ab.dungeons = {}, this._ab.dungeonEffects = {}, this._ab.routes = {}, this._minDungeonNodeY = 0, this._maxDungeonNodeY = 0, this._btns = [], this._dungeonButtons = {}, this._routeInfo = {}, this._isForceShown = !1, this._pageNum = 1, this._latestProgressData = this._createLatestProgressData(t.latest), this._isForceShown = this._latestProgressData.isForce ? !0 : !1, this._dungeonEffectsData = {}, this._clearDungeonId = void 0, this._clearDungeonRank = void 0, this._unlockDungeons = [], this._viewDidLoad = !1, this._endLevel = Math.min(this._maxLevel, this._endLevel), this._startLevel = this._latestProgressData.level - 3, this._startLevel < 0 && (this._startLevel = 0)
        },
        getLayerName: function() {
            return this._layerName
        },
        loadAssetsDeferred: function() {
            var e = this,
                n = t.Deferred();
            return FF.env.isNative() ? (this._assetsManager = new o, this._assetsManager.populateAssetsDeferred(this._assets, {
                retryDialog: !0
            }).then(function() {
                e.loadView(), n.resolve()
            }), n.promise()) : n.resolve().promise()
        },
        loadView: function() {
            var e = this,
                t = this._assetsManager.getAssetInfo(this._assetId);
            this._layerName = t.layerName, this._ab.stage = new i({
                name: "stage",
                layer: this.getLayerName()
            }), this._ab.visibleNode = new i({
                name: "visible_nul",
                layer: this.getLayerName()
            }), this._ab.uiContainer = this._ab.stage.createChildNode("ui_container"), this._ab.mapContainer = this._ab.stage.createChildNode("map_container"), this._ab.mapContainer.addCallback("action_touch_began", function(e) {
                FF.eventNotifier.trigger("ab:onTapScreen", e)
            }).process(), this._ab.mapForceContainer = this._ab.stage.createChildNode("map_force_container"), this._ab.mapForceContainer.addCallback("action_touch_began", function(e) {
                FF.eventNotifier.trigger("ab:onTapScreen", e)
            }).process(), this._ab.bgContainer = this._ab.stage.createChildNode("bg_container"), this._ab.modal = this._ab.stage.createChildNode("modal"), this._ab.loadingIcon = (new i({
                name: "loading_icon_new",
                layer: this.getLayerName(),
                duplicateFrom: "loading_icon",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentNode: "loading_pos"
                }
            })).process(), this._ab.loadingAll = (new i({
                name: "loading_all_new",
                layer: this.getLayerName(),
                duplicateFrom: "loading_all",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentNode: "loading_pos"
                }
            })).process(), this._ab.comingSoonIcon = (new i({
                name: "coming_soon_icon_new",
                layer: this.getLayerName(),
                duplicateFrom: "coming_soon_icon",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentNode: this._ab.mapContainer.name
                }
            })).setVisible(!1).process(), this._ab.charaAnim = void 0, this._isForceShown ? (this._ab.stage.play("force_after_opening").process(), this._ab.mapForceContainer.setVisible(!0).process()) : this._ab.mapForceContainer.setVisible(!1).process(), this._ab.scrollBar = this._ab.uiContainer.createChildNode("scrollbar"), this._ab.scrollBgImg = this._ab.scrollBar.createChildNode("scroll_bg_img"), this._ab.scrollBgImg.play("scrollbar_568", {
                autoRemove: !1
            }).process(), this._ab.scrollNobImg = this._ab.scrollBar.createChildNode("scroll_nob_img"), this._ab.scrollCurrentImg = this._ab.scrollBar.createChildNode("scroll_current_img"), this._prepareDrawInfo(), this._setUpButtons(), this._setUpModal(), this._initScroll(), a.getItemDeferred(p.LATEST_UNLOCK_DUNGEONS_DATA_KEY).then(function(t) {
                e._setClearDungeonDataFromResult(t), e._drawRoutes(), e._drawDungeonIcons(), e._progressMapDidLoad()
            })
        },
        _setClearDungeonDataFromResult: function(t) {
            var n = t.value ? JSON.parse(t.value) : {};
            FF.logger.debug("unlock dungeon Data : ", n);
            if (n.clearDungeonId) {
                this._clearDungeonId = n.clearDungeonId;
                if (n.isFirstClear || n.isFirstMaster) this._clearDungeonRank = n.clearDungeonRank
            }
            e.isArray(n.unlockDungeons) && (this._unlockDungeons = n.unlockDungeons)
        },
        _progressMapDidLoad: function() {
            var e = this;
            this._showDungeonClearEffectDeferred(this._clearDungeonId, this._clearDungeonRank).then(function() {
                return e._showDungeonOpenEffectDeferred(e._unlockDungeons)
            }).then(function() {
                return e._latestProgressData && e._latestProgressData.dungeonId ? e._drawCharaOnDungeonIcon(e._latestProgressData.dungeonId) : e._drawCharaOnDungeonIcon(p.DEAULT_DUNGEON_ID), a.removeItemDeferred(p.LATEST_UNLOCK_DUNGEONS_DATA_KEY)
            }).then(function() {
                e._updateScrollPos(), e._viewDidLoad = !0, kickmotor.nativefn.call("setIsEnableTouchEvent", {
                    isEnable: !0
                })
            })
        },
        isScrolling: function() {
            return this._isScrolling
        },
        hide: function() {
            this._ab && this._ab.stage && this._ab.stage.setVisible(!1).process()
        },
        show: function() {
            this._ab && this._ab.stage && this._ab.stage.setVisible(!0).process()
        },
        _createLatestProgressData: function(e) {
            if (!e) return {
                dungeonId: void 0,
                isForce: !1,
                level: 0
            };
            e.level === void 0 && (e.level = 0);
            if (e.isForce) {
                var t = this._forceProgressMap[e.forceDungeonId];
                e.dungeonId = t ? t.normal : void 0
            } else e.dungeonId = e.normalDungeonId;
            return e
        },
        _validateData: function(e) {
            var t = c.camelizeDeep(e);
            return t.assets = c.cloneDeep(e.assets), t
        },
        _prepareDrawInfo: function() {
            var t = this;
            e.each(this._progressMap, function(e) {
                var t = p.DUNGEON_ICON_OFFSET_X + e.line * p.DUNGEON_ICON_WIDTH,
                    n = p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y + e.level * p.DUNGEON_ICON_HEIGHT;
                e.position = {
                    x: t,
                    y: n
                }
            }), this._minDungeonNodeY = p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y, this._maxDungeonNodeY = this._minDungeonNodeY + this._maxLevel * p.DUNGEON_ICON_HEIGHT, e.each(this._progressMap, function(e) {
                e.prizeIconList = t._calcPrizeIconListByDungeonData(e)
            }), e.each(this._forceProgressMap, function(e) {
                e.prizeIconList = t._calcPrizeIconListByDungeonData(e)
            }), e.each(this._progressMap, function(n) {
                e.each(n.children, function(e) {
                    var r = void 0,
                        i = 0,
                        s = t._progressMap[e];
                    if (!s) return;
                    var o = t._userData[e],
                        u = o && o.status > 0,
                        a = n.position,
                        f = Math.abs(n.position.y - s.position.y);
                    if (f > p.DUNGEON_ICON_HEIGHT && n.position.x !== s.position.x) {
                        r = sprintf("%d_%d_%d", n.dungeonId, e, i), t._routeInfo[r] = {
                            distance: f - p.DUNGEON_ICON_HEIGHT,
                            rotation: 0,
                            position: n.position,
                            isOpened: u,
                            dungeonId: n.dungeonId,
                            childId: e,
                            routeIndex: i,
                            routeId: r
                        };
                        var l = n.position.x,
                            c = n.position.y + f - p.DUNGEON_ICON_HEIGHT;
                        a = {
                            x: l,
                            y: c
                        }, i++
                    }
                    var h = t._distance(a, s.position),
                        d = t._rotation(a, s.position);
                    r = sprintf("%d_%d_%d", n.dungeonId, e, i), t._routeInfo[r] = {
                        distance: h,
                        rotation: d,
                        position: a,
                        isOpened: u,
                        dungeonId: n.dungeonId,
                        childId: e,
                        routeIndex: i,
                        routeId: r
                    }
                })
            })
        },
        _calcPrizeIconListByDungeonData: function(t) {
            var n = t.contents.prizes,
                r = [];
            return e.each(n, function(t, n) {
                var i = e.filter(t, function(e) {
                    return e.typeName === "BUDDY" || e.typeName === "MEMORY_CRYSTAL"
                });
                r = r.concat(i)
            }), e.sortBy(r, function(e) {
                return e.itemId
            })
        },
        _setUpButtons: function() {
            var e = this;
            this._ab.worldButton = this._ab.uiContainer.createChildNode("btn_world"), this._worldButton = new s(this._ab.worldButton, void 0, v.MAP_UI, "btn_world_visible_touch"), this._worldButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e._setDragEnabled(!1), e._movingScene = !0, e._updateButtonLocks()
            }).setTouchHandlerAfterAnimation(function(t, n) {
                e.trigger(d.BTN_WORLD_BACK)
            }), this._worldButton.ignoreTouchEnter(), this._btns.push(this._worldButton), this._ab.backButton = this._ab.stage.createChildNode("btn_back"), this._backButton = new s(this._ab.backButton, void 0, v.MAP_UI, "btn_back_visible_touch"), this._backButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                e._setDragEnabled(!1), e._movingScene = !0, e._updateButtonLocks()
            }).setTouchHandlerAfterAnimation(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e.trigger(d.BTN_BACK_CLICKED)
            }), this._backButton.ignoreTouchEnter(), this._btns.push(this._backButton), this._ab.normalButton = this._ab.stage.createChildNode("btn_normal"), this._ab.forceButton = this._ab.stage.createChildNode("btn_force").play("btn_loop", {
                autoRemove: !1
            }, "btn_force_sprite").play("btn_loop", {
                autoRemove: !1
            }, "btn_force_particle"), this._normalButton = new s(this._ab.normalButton, void 0, v.MAP_UI, "btn_normal_visible_touch"), this._normalButton.setButtonStateTags(void 0, void 0, void 0).setTouchHandler(function(t, n) {
                if (e._isLoadingPage) return;
                FF.SoundMgr.playChooseEffect(), e._toggleForceDeferred(!1)
            }), this._normalButton.ignoreTouchEnter(), this._btns.push(this._normalButton), this._forceButton = new s(this._ab.forceButton, void 0, v.MAP_UI, "btn_force_visible_touch"), this._forceButton.setButtonStateTags(void 0, void 0, void 0).setTouchHandler(function(t, n) {
                if (e._isLoadingPage) return;
                FF.SoundMgr.playChooseEffect(), e._toggleForceDeferred(!0)
            }), this._forceButton.ignoreTouchEnter(), this._btns.push(this._forceButton), this._ab.prevButton = this._ab.uiContainer.createChildNode("btn_prev").setVisible(!1).process(), this._prevButton = new s(this._ab.prevButton, void 0, v.MAP_UI, "btn_prev_visible_touch"), this._prevButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e._jumpPrevArea()
            }), this._prevButton.ignoreTouchEnter(), this._btns.push(this._prevButton), this._ab.nextButton = this._ab.uiContainer.createChildNode("btn_next").setVisible(!1).process(), this._nextButton = new s(this._ab.nextButton, void 0, v.MAP_UI, "btn_next_visible_touch"), this._nextButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playChooseEffect(), e._jumpNextArea()
            }), this._nextButton.ignoreTouchEnter(), this._btns.push(this._nextButton), this._ab.currentButton = this._ab.uiContainer.createChildNode("btn_current"), this._currentButton = new s(this._ab.currentButton, void 0, v.MAP_UI, "btn_current_visible_touch"), this._currentButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                if (e._isLoadingPage) return;
                FF.SoundMgr.playChooseEffect(), e._jumpCurrentArea()
            }), this._currentButton.ignoreTouchEnter().ignoreFrequentlyTouch(1e3), this._btns.push(this._currentButton)
        },
        _setProgressMapDataIfNeedDeferred: function(n, r) {
            var i = this,
                s = t.Deferred(),
                o = e.range(n, r + 1),
                u = e.every(o, function(e) {
                    return i._hasLevelOf[e]
                });
            return u ? s.resolve().promise() : (this._setProgressMapDataDeferred(n, r).then(function() {
                e.each(o, function(e) {
                    i._hasLevelOf[e] = !0
                }), s.resolve()
            }, function() {
                s.reject()
            }), s.promise())
        },
        _setProgressMapDataDeferred: function(n, r) {
            var i = this,
                s = t.Deferred();
            return f.getProgressMapBySegmentDeferred(n, r, {}, {
                useLoadingLock: !0,
                doNotStayRetryDialog: !0
            }).done(function(t) {
                var n = i._validateData(t);
                i._assetsManager.populateAssetsDeferred(n.assets).then(function() {
                    var t = n.progressMap.normal,
                        r = n.progressMap.force,
                        o = n.userData.dungeon;
                    i._progressMap = e.extend(i._progressMap, t), i._forceProgressMap = e.extend(i._forceProgressMap, r), i._userData = e.extend(i._userData, o), i._prepareDrawInfo(), FF.router.loading.hide(), s.resolve()
                }, function() {
                    FF.router.loading.hide(), s.reject()
                })
            }).fail(function() {}), s.promise()
        },
        _drawDungeonIcons: function() {
            var t = this;
            e.each(this._progressMap, function(e) {
                var n = e.dungeonId;
                if (t._dungeonButtons[n] && t._ab.dungeons[n]) {
                    t._isInScrollArea(e.position) || (t._ab.dungeons[n].deleteNode().process(), delete t._ab.dungeons[n], t._dungeonButtons[n].dispose(), delete t._dungeonButtons[n], t._latestProgressData.dungeonId === e.dungeonId && t._ab.charaAnim && (t._ab.charaAnim.deleteNode().process(), t._ab.charaAnim = null), t._ab.dungeonEffects[n] && (t._ab.dungeonEffects[n].deleteNode().process(), delete t._ab.dungeonEffects[n], delete t._dungeonEffectsData[n]));
                    return
                }
                t._isInScrollArea(e.position) && t._drawDungeonIcon(e)
            })
        },
        _drawDungeonIcon: function(e) {
            var t = e.dungeonId;
            if (this._ab.dungeons[t]) return;
            var n = this,
                r = Math.floor((e.contents.series - 1e5) / 1e3),
                o = e.contents.index || 0,
                u = (new i({
                    name: sprintf("dungeon_%s", t),
                    layer: this.getLayerName(),
                    duplicateFrom: "dungeon",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._isForceShown ? this._ab.mapForceContainer.name : this._ab.mapContainer.name
                    }
                })).setSpriteActionByNode("dungeon_icon_sprite", sprintf("icon_%d", r)).setSpriteActionByNode("title_num_sprite", sprintf("num_%d", r)).setText("dungeon_num_txt", sprintf("%d", o)).setPosition([e.position.x, e.position.y]).process();
            this._ab.dungeons[t] = u;
            var a = new s(u, void 0, v.DUNGEON, "dungeon_visible_touch"),
                f = function(e, t) {
                    return Math.abs(t.beganSY - t.screenY) > 10 ? !1 : !0
                };
            a.setButtonStateTags(void 0, "dungeon_touch", void 0).setCheckEnabledFunction(f).setTouchHandler(function(e, r) {
                FF.SoundMgr.playDecideEffect(), n._drawCharaOnDungeonIcon(t), n._waitingModalClose = !0, n._updateButtonLocks()
            }).setTouchHandlerAfterAnimation(function(t, r) {
                n.trigger(d.BTN_DUNGEON_SELECT, e)
            }), a.ignoreTouchEnter(), this._dungeonButtons[t] = a, this._drawDungeonData(t)
        },
        _drawDungeonData: function(t) {
            var n = this,
                r = this._ab.dungeons[t],
                i = this._dungeonButtons[t],
                s = this._progressMap[t],
                o = this._isForceShown ? s.force : t,
                u = this._isForceShown ? this._forceProgressMap[o] : s,
                a = this._isForceShown ? this._ab.mapForceContainer : this._ab.mapContainer,
                f = this._userData[o],
                l = 0;
            f && f.rank > 0 && (l = f.rank), r.setSpriteActionByNode("dungeon_prize_sprite", sprintf("prize_%d", l)).setVisibleByNode("dungeon_prize_sprite", !0);
            var c = !1,
                h = "dungeon_close",
                d = e.map(this._unlockDungeons, function(e) {
                    return +e.dungeonId
                });
            f && f.status > 0 ? (c = !0, h = "dungeon_normal", f.status === g.NEW ? e.contains(d, o) && !this._viewDidLoad ? (r.setVisibleByNode("dungeon_new_img", !1).setVisibleByNode("dungeon_master_sprite", !1).setVisibleByNode("dungeon_bg_eff_particle", !1), h = "dungeon_close") : (r.setVisibleByNode("dungeon_new_img", !0).setVisibleByNode("dungeon_bg_eff_particle", !0).setVisibleByNode("dungeon_prize_sprite", !1), h = "dungeon_loop") : r.setVisibleByNode("dungeon_new_img", !1).setVisibleByNode("dungeon_bg_eff_particle", !1), f.status === g.MASTERED ? r.setVisibleByNode("dungeon_master_sprite", !0).setVisibleByNode("dungeon_prize_sprite", !1) : r.setVisibleByNode("dungeon_master_sprite", !1)) : r.setVisibleByNode("dungeon_new_img", !1).setVisibleByNode("dungeon_master_sprite", !1).setVisibleByNode("dungeon_bg_eff_particle", !1), r.play(h, {
                autoRemove: !1
            }, "dungeon_anm");
            var v = u.prizeIconList;
            e.each([0, 1], function(e) {
                var t = void 0;
                v[e] ? t = sprintf("icon-badge-%d", v[e].itemId) : t = "icon-badge-empty";
                var i = n._assetsManager.getAssetInfo(t);
                r.loadBundle(i.bundle).setImage(sprintf("dungeon_chara_img_%02d", e + 1), i.assetPath)
            }), r.setVisualParent(r.layer, a.name).process(), this._hasDungeonEffect(t) || !this._viewDidLoad ? r.setVisibleByNode("dungeon_front_eff_pos", !0) : r.setVisibleByNode("dungeon_front_eff_pos", !1), r.process(), this._drawCharaOnDungeonIconWithNoAnim(t), i.setEnabled(c), s.level === this._maxLevel - 1 && this._hasComingSoon && this._ab.comingSoonIcon.setVisible(!0).setPosition([p.SCREEN_WIDTH / 2, p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y + this._maxLevel * p.DUNGEON_ICON_HEIGHT]).setVisualParent(this.getLayerName(), a.name).process()
        },
        _hasDungeonEffect: function(e) {
            var t = this._dungeonEffectsData[e];
            if (t) {
                if (t.isForce && this._isForceShown) return !0;
                if (t.isNormal && !this._isForceShown) return !0
            }
            return !1
        },
        _drawCharaOnDungeonIcon: function(e) {
            var t = this;
            if (!this._latestProgressData) return;
            var n = this._latestProgressData.dungeonId,
                r = this._latestProgressData.isForce;
            if (this._ab.charaAnim && n === e && r === this._isForceShown) return;
            if (this._ab.charaAnim) {
                var s = this._ab.charaAnim;
                r === this._isForceShown ? s.play("chara_close", {
                    autoRemove: !1
                }).processDeferred("action_stop").then(function() {
                    s.deleteNode().process()
                }) : s.deleteNode().process(), this._ab.charaAnim = null
            }
            this._latestProgressData.dungeonId = e, this._latestProgressData.isForce = this._isForceShown;
            var o = this._ab.dungeons[e];
            if (!o) return;
            this._ab.charaAnim || (this._ab.charaAnim = new i({
                name: sprintf("chara_anim_%s", e),
                layer: this.getLayerName(),
                duplicateFrom: "deshi_anm",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentTopNode: o.name,
                    visualParentNode: "deshi_pos"
                }
            })), this._ab.charaAnim.play("chara_open", {
                autoRemove: !1
            }).process(), this._updateScrollBarDeshiPosition(e, !1)
        },
        _drawCharaOnDungeonIconWithNoAnim: function(e) {
            var t = this;
            if (!this._latestProgressData || !this._viewDidLoad) return;
            if (this._latestProgressData.dungeonId === e)
                if (this._latestProgressData.isForce === this._isForceShown) {
                    if (!this._ab.charaAnim) {
                        var n = this._ab.dungeons[e];
                        this._ab.charaAnim = new i({
                            name: sprintf("chara_anim_%s", e),
                            layer: this.getLayerName(),
                            duplicateFrom: "deshi_anm",
                            duplicateFromOptions: {
                                visualParentLayer: this.getLayerName(),
                                visualParentTopNode: n.name,
                                visualParentNode: "deshi_pos"
                            }
                        })
                    }
                    this._ab.charaAnim.play("chara_open_noanim", {
                        autoRemove: !1
                    }).process(), this._updateScrollBarDeshiPosition(e, !1)
                } else this._ab.charaAnim && this._ab.charaAnim.play("chara_close_noanim", {
                    autoRemove: !1
                }).process()
        },
        _showDungeonClearEffectDeferred: function(e, n) {
            FF.logger.debug("show dungeon clear effect");
            var r = this,
                s = t.Deferred();
            if (!e) return s.resolve().promise();
            var o = this._isForceShown ? this._forceProgressMap[e] : this._progressMap[e];
            if (!o) return s.resolve().promise();
            var u = this._isForceShown ? o.normal : o.dungeonId,
                f = this._ab.dungeons[u];
            if (!f) return a.removeItemDeferred(p.LATEST_UNLOCK_DUNGEONS_DATA_KEY).then(function() {
                throw new Error("dungeonNode does not exist. dungeon ID:" + e)
            }), s.reject().promise();
            var l = this._ab.dungeonEffects[u];
            l || (l = (new i({
                name: sprintf("dungeon_front_eff_%s", u),
                layer: this.getLayerName(),
                duplicateFrom: "dungeon_front_eff",
                duplicateFromOptions: {
                    visualParentLayer: this.getLayerName(),
                    visualParentTopNode: f.name,
                    visualParentNode: "dungeon_front_eff_pos"
                }
            })).process());
            var c = this._dungeonEffectsData[u];
            c || (c = {
                isForce: this._isForceShown ? !0 : !1,
                isNormal: this._isForceShown ? !1 : !0
            });
            var h = void 0;
            switch (n) {
                case 1:
                    h = "dungeon_clear_01";
                    break;
                case 2:
                    h = "dungeon_clear_02";
                    break;
                case 3:
                    h = "dungeon_clear_03", f.setVisibleByNode("dungeon_master_sprite", !0).setVisibleByNode("dungeon_prize_sprite", !1);
                    break;
                default:
                    h = "dungeon_clear_01"
            }
            f.process();
            var d = [],
                v = f.createChildNode("dungeon_anm");
            return d.push(l.play(h, {
                autoRemove: !1
            }).processDeferred("action_stop")), d.push(v.play(h, {
                autoRemove: !1
            }).processDeferred("action_stop", {
                tag: h
            })), t.when.apply(t, d).then(function() {
                f.play("dungeon_loop", {
                    autoRemove: !1
                }, "dungeon_anm").process(), l.play("dungeon_loop", {
                    autoRemove: !1
                }).process(), r._ab.dungeonEffects[u] = l, r._dungeonEffectsData[u] = c
            })
        },
        _showDungeonOpenEffectDeferred: function(n) {
            FF.logger.debug("show dungeon open effect");
            if (n.length === 0) return t.Deferred().resolve().promise();
            var r = this,
                i = [],
                s = [];
            e.each(n, function(e) {
                e.isForce ? s.push(e) : i.push(e)
            });
            var o = [],
                u = !1;
            return i.length > 0 && (o = e.map(i, function(e) {
                return e.dungeonId
            })), this._dungeonOpenEffectDeferred(o, u)
        },
        _dungeonOpenEffectDeferred: function(n, r) {
            var s = this,
                o = [],
                u = [];
            return e.each(n, function(e) {
                var t = s._ab.dungeons[e];
                if (!t) return;
                var n = s._ab.dungeonEffects[e];
                n || (n = (new i({
                    name: sprintf("dungeon_front_eff_%s", e),
                    layer: s.getLayerName(),
                    duplicateFrom: "dungeon_front_eff",
                    duplicateFromOptions: {
                        visualParentLayer: s.getLayerName(),
                        visualParentTopNode: t.name,
                        visualParentNode: "dungeon_front_eff_pos"
                    }
                })).process());
                var a = s._dungeonEffectsData[e];
                a ? (a.isForce = a.isForce || r, a.isNormal = a.isNormal || !r) : a = {
                    isForce: r,
                    isNormal: !r
                }, t.setVisibleByNode("dungeon_new_img", !0).setVisibleByNode("dungeon_bg_eff_particle", !0).setVisibleByNode("dungeon_prize_sprite", !1).process();
                var f = t.createChildNode("dungeon_anm");
                o.push(n.play("dungeon_open", {
                    autoRemove: !1
                }).processDeferred("action_stop")), o.push(f.play("dungeon_open", {
                    autoRemove: !1
                }).processDeferred("action_stop")), s._dungeonButtons[e].setEnabled(!0), s._ab.dungeonEffects[e] = n, s._dungeonEffectsData[e] = a, u.push(f), u.push(n)
            }), t.when.apply(t, o).then(function() {
                e.each(u, function(e) {
                    e.play("dungeon_loop", {
                        autoRemove: !0
                    }).process()
                })
            })
        },
        _setUpModal: function() {
            var e = this;
            this._ab.modalCancel = this._ab.modal.createChildNode("btn_cancel"), this._ab.modalChallenge = this._ab.modal.createChildNode("btn_challenge"), this._ab.modalDetail = this._ab.modal.createChildNode("btn_detail").setVisible(!1).process(), this._modalCancelButton = new s(this._ab.modalCancel, void 0, v.MODAL, "btn_cancel_visible_touch"), this._modalCancelButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(t, n) {
                FF.SoundMgr.playCancelEffect(), e._modalClose()
            }), this._btns.push(this._modalCancelButton), this._modalChallengeButton = new s(this._ab.modalChallenge, void 0, v.MODAL, "btn_challenge_visible_touch"), this._modalChallengeButton.setButtonStateTags(void 0, "btn_touch", void 0).setTouchHandler(function(e, t) {
                FF.SoundMgr.playChooseEffect()
            }).ignoreTouchDuringTouchEndAnimation().ignoreFrequentlyTouch(1e3), this._btns.push(this._modalChallengeButton)
        },
        openDungeonModal: function(e) {
            this._modalOpen(e)
        },
        cancelDungeonSelect: function() {
            this._waitingModalClose = !1, this._updateButtonLocks()
        },
        _modalOpen: function(t) {
            var n = this;
            this._canScroll = !1;
            var r = this._isForceShown ? t.force : t.dungeonId,
                i = this._isForceShown ? this._forceProgressMap[t.force] : t,
                s = i.contents.name,
                o = i.contents.totalStamina,
                u = i.contents.challengeLevel,
                a = this._userData[r],
                c = a.status === g.MASTERED ? !0 : !1,
                h = a.status >= g.CLEARED ? !0 : !1,
                p = a.rank,
                v = h ? m.FIRST_MASTER : m.FIRST_CLEAR,
                y = i.contents.prizes[v];
            this._setDragEnabled(!1);
            var b = this._isForceShown ? "modal_force" : "modal_history";
            this._ab.modal.setText("modal_ttl_txt", s).setText("modal_stamina_txt", o).setText("modal_lv_txt", u).setVisibleByNode("modal_dungeon_story_img", !1).setSpriteActionByNode("modal_prize_sprite", sprintf("prize_%d", p)).play(b, {
                autoRemove: !1
            }, "modal_win").play("modal_open", {
                autoRemove: !1
            }), h ? (this._ab.modal.setVisibleByNode("reward_clear_txt_img", !1).setVisibleByNode("reward_master_txt_img", !0).setVisibleByNode("dungeon_mist_img", !1), c ? this._ab.modal.setVisibleByNode("reward_get_txt_img_01", !0).setVisibleByNode("reward_get_txt_img_02", !0).setVisibleByNode("modal_txt_clear_img", !1).setVisibleByNode("modal_txt_master_img", !0) : this._ab.modal.setVisibleByNode("reward_get_txt_img_01", !1).setVisibleByNode("reward_get_txt_img_02", !1).setVisibleByNode("modal_txt_clear_img", !0).setVisibleByNode("modal_txt_master_img", !1)) : this._ab.modal.setVisibleByNode("reward_get_txt_img_01", !1).setVisibleByNode("reward_get_txt_img_02", !1).setVisibleByNode("modal_txt_master_img", !1).setVisibleByNode("modal_txt_clear_img", !1).setVisibleByNode("reward_clear_txt_img", !0).setVisibleByNode("reward_master_txt_img", !1).setVisibleByNode("dungeon_mist_img", !0);
            var w = 0;
            e.each(y, function(e, t) {
                var r = sprintf("item-%s", t),
                    i = n._assetsManager.getAssetInfo(r);
                n._ab.modal.loadBundle(i.bundle).setImage(sprintf("modal_reward_img_%02d", ++w), i.assetPath)
            }), this._ab.modal.process(), this._modalChallengeButton.setTouchHandlerAfterAnimation(function(e, t) {
                n.trigger(d.BTN_DUNGEON_DETAIL, i)
            }), l.saveDungeonDataDeferred(t.dungeonId, t.force, t.level, this._isForceShown), f.getDungeonPrologueAssetDeferred(r, {
                disableLoading: !0,
                doNotHandleError: !0,
                doNotStayRetryDialog: !0
            }).done(function(e) {
                return n._assetsManager.populateAssetsDeferred(e.assets).then(function() {
                    var e = sprintf("prologue-%d", r),
                        t = n._assetsManager.getAssetInfo(e);
                    n._ab.modal.loadBundle(t.bundle).setImage("modal_dungeon_story_img", t.assetPath).setVisibleByNode("modal_dungeon_story_img", !0).process()
                })
            })
        },
        _modalClose: function() {
            this._ab.modal.play("modal_close", {
                autoRemove: !1
            }).process(), this._setDragEnabled(!0), this._canScroll = !0, this._waitingModalClose = !1, this._updateButtonLocks()
        },
        _updateButtonLocks: function() {
            this._btns ? this._loadingIconShown || this._loadingAllShown || this._togglingForceAndNormal || this._movingScene ? (s.lockByGroupName(v.MODAL), s.lockByGroupName(v.DUNGEON), s.lockByGroupName(v.MAP_UI)) : this._waitingModalClose ? (s.unlockByGroupName(v.MODAL), s.lockByGroupName(v.DUNGEON), s.lockByGroupName(v.MAP_UI)) : (s.lockByGroupName(v.MODAL), s.unlockByGroupName(v.DUNGEON), s.unlockByGroupName(v.MAP_UI)) : (s.unlockByGroupName(v.MODAL), s.unlockByGroupName(v.DUNGEON), s.unlockByGroupName(v.MAP_UI))
        },
        _isInScrollArea: function(e) {
            var t = this._scrollTouchRect[0],
                n = this._scrollTouchRect[1] - p.DUNGEON_ICON_HEIGHT * 2,
                r = this._scrollTouchRect[2],
                i = this._scrollTouchRect[3] + p.DUNGEON_ICON_HEIGHT * 4;
            return t < e.x && e.x < t + r && n < e.y && e.y < n + i ? !0 : !1
        },
        _drawRoutes: function() {
            var t = this;
            e.each(this._routeInfo, function(e, n) {
                var r = [e.position.x, e.position.y + p.DUNGEON_ICON_HEIGHT];
                if (t._ab.routes[n]) {
                    !t._isInScrollArea(e.position) && !t._isInScrollArea(r) && (t._ab.routes[n].deleteNode().process(), delete t._ab.routes[n]);
                    return
                }(t._isInScrollArea(e.position) || t._isInScrollArea(r)) && t._drawRoute(e, n)
            })
        },
        _drawRoute: function(e, t) {
            if (this._ab.routes[t]) return;
            var n = e.isOpened ? "route_open" : "route_close",
                r = (new i({
                    name: sprintf("route_%s", t),
                    layer: this.getLayerName(),
                    duplicateFrom: "route",
                    duplicateFromOptions: {
                        visualParentLayer: this.getLayerName(),
                        visualParentNode: this._ab.mapContainer.name
                    }
                })).play(n, {
                    autoRemove: !1
                }).setScale([1, e.distance / 25]).setPosition([e.position.x, e.position.y]).setRot(e.rotation).setZOrder(-1).process();
            this._ab.routes[t] = r
        },
        _distance: function(e, t) {
            var n = t.x - e.x,
                r = t.y - e.y;
            return Math.sqrt(Math.pow(n, 2) + Math.pow(r, 2))
        },
        _rotation: function(e, t) {
            var n = t.x - e.x,
                r = t.y - e.y,
                i = -Math.atan(n / r);
            return i * 180 / Math.PI
        },
        _reloadView: function() {
            var t = this;
            this._isForceShown ? this._ab.mapForceContainer.setVisible(!0).process() : this._ab.mapForceContainer.setVisible(!1).process(), e.each(this._ab.dungeons, function(e, n) {
                t._drawDungeonData(+n)
            })
        },
        _initScroll: function() {
            kickmotor.animation.processAnimation([{
                exec: "setScissor",
                layer: this.getLayerName(),
                rect: [0, p.MASK_MARGIN_TOP, p.SCREEN_WIDTH, h - p.MASK_MARGIN_TOP]
            }]), this._updateScroll(), this._lastScrollY = this._scrollLimitTop, this._setDragEnabled(!0), this._canScroll = !0
        },
        _updateDragArea: function() {
            var e = p.DUNGEON_ICON_HEIGHT * this._startLevel,
                t = this._endLevel - this._startLevel;
            this._endLevel === this._maxLevel && t++;
            var n = p.DUNGEON_ICON_OFFSET_Y + p.DUNGEON_ICON_HEIGHT * t;
            this._dragArea = [0, -n - p.MASK_MARGIN_TOP - e + h, 0, n - h + p.MASK_MARGIN_TOP], this._dragMargin = [0, p.DRAG_MARGIN, 0, p.DRAG_MARGIN]
        },
        _updateScrollRect: function() {
            var e = p.DUNGEON_ICON_HEIGHT * this._startLevel,
                t = this._endLevel - this._startLevel,
                n = p.DUNGEON_ICON_OFFSET_Y + p.DUNGEON_ICON_HEIGHT * t;
            this._scrollTouchRect = [0, p.MASK_MARGIN_TOP + e, p.SCREEN_WIDTH, n], this._scrollLimitTop = -e, this._scrollLimitBottom = -n - p.MASK_MARGIN_TOP - e + h, FF.logger.debug("start , end", this._startLevel, this._endLevel), FF.logger.debug("num of row : ", t), FF.logger.debug("contentHeight : ", n), FF.logger.debug("scrollTop : ", this._scrollLimitTop), FF.logger.debug("scrollBottom : ", this._scrollLimitBottom)
        },
        _updateScroll: function() {
            this._updateScrollRect(), this._updateDragArea(), this._ab.mapContainer.clearTouchRect().addTouchRect(this._scrollTouchRect).process(), this._ab.mapForceContainer.clearTouchRect().addTouchRect(this._scrollTouchRect).process()
        },
        _toggleForceDeferred: function(e) {
            FF.logger.debug("toggleForce", e);
            var n = this,
                r = t.Deferred();
            return e === this._isForceShown ? r.resolve().promise() : (this._isLoadingPage = !0, this._togglingForceAndNormal = !0, this._updateButtonLocks(), this._setDragEnabled(!1), this._syncNodePosY(this._lastScrollY), this._updateScrollBarDeshiPosition(void 0), e ? (this._isForceShown = e, this._ab.stage.play("force_open_1").processDeferred("action_stop").then(function() {
                return n._reloadView(), n._ab.mapForceContainer.setVisible(!0).process(), n._ab.stage.play("force_open_2").processDeferred("action_stop")
            }).then(function() {
                n._setDragEnabled(!0), n._isLoadingPage = !1, n._togglingForceAndNormal = !1, n._updateButtonLocks(), r.resolve()
            })) : (this._isForceShown = e, this._ab.stage.play("force_close_1").processDeferred("action_stop").then(function() {
                return n._reloadView(), n._ab.mapForceContainer.setVisible(!1).process(), n._ab.stage.play("force_close_2").processDeferred("action_stop")
            }).then(function() {
                n._setDragEnabled(!0), n._isLoadingPage = !1, n._togglingForceAndNormal = !1, n._updateButtonLocks(), r.resolve()
            })), r.promise())
        },
        _setDragEnabled: function(e, t, n) {
            t === void 0 && (t = this._dragArea), n === void 0 && (n = {
                dragMargin: this._dragMargin
            }), t = t.slice(), t[3] < 0 && (t[3] = 0), this._dragEnabled = e, FF.logger.debug("##_setDragEnabled", this._dragEnabled, t), this._ab.mapContainer.setDragEnable(t, this._dragEnabled, n).process(), this._ab.mapForceContainer.setDragEnable(t, this._dragEnabled, n).process()
        },
        _loadPrevPage: function() {
            var e = this;
            if (this._startLevel === 0 || this._isLoadingPage) return;
            this._isLoadingPage = !0, this._pageNum++;
            var t = this._startLevel;
            this._startLevel - p.DUNGEON_NUM_IN_PAGE <= 0 ? this._startLevel = 0 : this._startLevel -= p.DUNGEON_NUM_IN_PAGE, this._pageNum > p.MAX_PAGE_NUM && (this._endLevel -= p.DUNGEON_NUM_IN_PAGE, this._pageNum--);
            var n = this._startLevel,
                r = [0, this._dragArea[1] + p.PULL_THRESHOLD, 0, this._dragArea[3] - p.PULL_THRESHOLD];
            this._showLoadingIconWithDirection(y.TOP), this._setDragEnabled(!1, r, {}), this._appendPage(n, t, y.TOP)
        },
        _loadNextPage: function() {
            var e = this;
            if (this._endLevel === this._maxLevel || this._isLoadingPage) return;
            this._isLoadingPage = !0;
            var t = this._endLevel;
            this._pageNum++, this._endLevel + p.DUNGEON_NUM_IN_PAGE > this._maxLevel ? this._endLevel = this._maxLevel : this._endLevel += p.DUNGEON_NUM_IN_PAGE, this._pageNum > p.MAX_PAGE_NUM && (this._startLevel += p.DUNGEON_NUM_IN_PAGE, this._pageNum--);
            var n = this._endLevel,
                r = [0, this._dragArea[1] - p.PULL_THRESHOLD, 0, this._dragArea[3] + p.PULL_THRESHOLD];
            this._showLoadingIconWithDirection(y.BOTTOM), this._setDragEnabled(!1, r, {}), this._appendPage(t, n, y.BOTTOM)
        },
        _appendPage: function(e, t, n) {
            var r = this;
            FF.logger.debug(this._startLevel, this._endLevel, this._pageNum), this._setProgressMapDataIfNeedDeferred(e, t).then(function() {
                return r._updateScrollRect(), r._drawRoutes(), r._drawDungeonIcons(), r._hideLoadingIconWithDirectionDeferred(n)
            }, function() {
                r._hideLoadingIconWithDirectionDeferred(n), r._setDragEnabled(!0), r._isLoadingPage = !1
            }).then(function() {
                r._syncNodePosY(r._lastScrollY), r._updateScroll(), r._setDragEnabled(!0), r._isLoadingPage = !1
            })
        },
        _setStartAndEndLevel: function(e, t) {
            t === void 0 && (t = 5), this._endLevel = e - t + p.DUNGEON_NUM_IN_PAGE, this._endLevel > this._maxLevel && (this._endLevel = this._maxLevel), this._startLevel = this._endLevel - p.DUNGEON_NUM_IN_PAGE, this._startLevel < 0 && (this._startLevel = 0, this._endLevel = p.DUNGEON_NUM_IN_PAGE)
        },
        _jumpPrevArea: function() {
            if (this._isLoadingPage) return;
            this._isLoadingPage = !0, this._pageNum = 1, this._setStartAndEndLevel(0), this._jumpPage(this._startLevel, this._endLevel, 0)
        },
        _jumpNextArea: function() {
            if (this._isLoadingPage) return;
            this._isLoadingPage = !0, this._pageNum = 1;
            var e;
            this._isForceShown ? e = this._newestLevel.force : e = this._newestLevel.normal, this._setStartAndEndLevel(e), this._jumpPage(this._startLevel, this._endLevel, e)
        },
        _jumpCurrentArea: function() {
            if (this._isLoadingPage) return;
            var e = this;
            this._isLoadingPage = !0, this._pageNum = 1;
            var t = 0;
            this._startLevel = 0, this._endLevel = p.DUNGEON_NUM_IN_PAGE;
            if (this._latestProgressData && this._latestProgressData.dungeonId) {
                var n = 3;
                t = this._progressMap[this._latestProgressData.dungeonId].level, this._setStartAndEndLevel(t), this._latestProgressData.isForce !== this._isForceShown ? this._toggleForceDeferred(this._latestProgressData.isForce).then(function() {
                    e._jumpPage(e._startLevel, e._endLevel, t - n)
                }) : this._jumpPage(this._startLevel, this._endLevel, t - n)
            } else this._jumpPage(this._startLevel, this._endLevel, t)
        },
        _jumpPage: function(e, t, n) {
            var r = this;
            this._jumpingPage = !0, this._showLoadingAll(), this._setDragEnabled(!1), this._setProgressMapDataIfNeedDeferred(e, t).then(function() {
                return r._updateScrollRect(), r._drawRoutes(), r._drawDungeonIcons(), r._hideLoadingAllDeferred()
            }, function() {
                r._hideLoadingAllDeferred(), r._setDragEnabled(!0), r._isLoadingPage = !1, r._jumpingPage = !1
            }).then(function() {
                var e = n === void 0 ? r._scrollLimitTop : -p.DUNGEON_ICON_HEIGHT * n;
                r._syncNodePosY(e), r._updateScroll(), r._setDragEnabled(!0), r._isLoadingPage = !1, r._jumpingPage = !1
            })
        },
        _showLoadingIconAtPosition: function(e) {
            this._ab.loadingIcon.play("open").setPosition([e.x, e.y]).process(), this._loadingIconShown = !0, this._updateButtonLocks()
        },
        _showLoadingIconWithDirection: function(e) {
            var t = {
                x: 0,
                y: 0
            };
            e === y.TOP ? t = {
                x: 0,
                y: p.MASK_MARGIN_TOP + p.DUNGEON_ICON_OFFSET_Y
            } : e === y.BOTTOM && (t = {
                x: 0,
                y: h - p.MASK_MARGIN_TOP
            }), this._showLoadingIconAtPosition(t)
        },
        _hideLoadingIconWithDirectionDeferred: function(e) {
            var t = this,
                n = "close";
            return e === y.TOP ? n = "close_up" : e === y.BOTTOM && (n = "close_down"), this._ab.loadingIcon.play(n).processDeferred("action_stop", {
                tag: n
            }).then(function() {
                t._loadingIconShown = !1, t._updateButtonLocks()
            })
        },
        _showLoadingAll: function() {
            this._loadingAllShown = !0, this._updateButtonLocks(), this._ab.loadingAll.play("open").process()
        },
        _hideLoadingAllDeferred: function() {
            var e = this;
            return this._ab.loadingAll.play("close").processDeferred("action_stop", {
                tag: "close"
            }).then(function() {
                e._loadingAllShown = !1, e._updateButtonLocks()
            })
        },
        _showNextButton: function() {
            var e = this;
            clearTimeout(this._hideNextTimer), this._hideNextTimer = setTimeout(function() {
                e._hideNextTimer = void 0, e._nextButton.setEnabled(!1), e._ab.nextButton.play("btn_close", {
                    autoRemove: !1
                }).processDeferred("action_stop").then(function() {
                    FF.logger.debug("hide next button"), e._isShowNextButton = !1
                })
            }, p.FLOATING_BUTTON_MSEC);
            if (this._isShowNextButton) return;
            FF.logger.debug("show next button"), this._isShowNextButton = !0, this._ab.nextButton.setVisible(!0).play("btn_open", {
                autoRemove: !1
            }).process(), this._nextButton.setEnabled(!0)
        },
        _showPrevButton: function() {
            var e = this;
            clearTimeout(this._hidePrevTimer), this._hidePrevTimer = setTimeout(function() {
                e._hidePrevTimer = void 0, e._prevButton.setEnabled(!1), e._ab.prevButton.play("btn_close", {
                    autoRemove: !1
                }).processDeferred("action_stop").then(function() {
                    FF.logger.debug("hide prev button"), e._isShowPrevButton = !1
                })
            }, p.FLOATING_BUTTON_MSEC);
            if (this._isShowPrevButton) return;
            FF.logger.debug("show prev button"), this._isShowPrevButton = !0, this._ab.prevButton.setVisible(!0).play("btn_open", {
                autoRemove: !1
            }).process(), this._prevButton.setEnabled(!0)
        },
        _updateScrollBar: function() {
            var e = p.DUNGEON_ICON_OFFSET_Y + p.DUNGEON_ICON_HEIGHT * this._maxLevel - h,
                t = p.OFFSET_BAR_TOP + Math.floor(-this._lastScrollY * p.BAR_BG_HEIGHT / e);
            this._ab.scrollNobImg.setPosition(void 0, {
                y: t
            }).process()
        },
        _updateScrollBarDeshiPosition: function(e, t) {
            if (e === void 0 || !this._progressMap[e]) {
                this._ab.scrollCurrentImg.setVisible(!1).process();
                return
            }
            var n = this._progressMap[e].position.y,
                r = (n - this._minDungeonNodeY) / (this._maxDungeonNodeY - this._minDungeonNodeY),
                i = p.OFFSET_BAR_TOP_FOR_DESHI + p.BAR_BG_HEIGHT_FOR_DESHI * r;
            t ? this._ab.scrollCurrentImg.setPosition(void 0, {
                y: i
            }).setVisible(!0).process() : this._ab.scrollCurrentImg.sequence([{
                action: "moveTo",
                duration: .3,
                pos: [p.BAR_DESHI_POS_X, i],
                ease: "EaseOut"
            }]).setVisible(!0).process()
        },
        _updateScrollPos: function() {
            var e = this,
                t = this._isForceShown ? this._ab.mapForceContainer : this._ab.mapContainer;
            !this._isLoadingPage && this._canScroll && !this._jumpingPage && t.getNodePos(function(t) {
                var n = t.pos[0][1],
                    r = n < e._scrollLimitBottom - p.PULL_THRESHOLD,
                    i = n > e._scrollLimitTop + p.PULL_THRESHOLD;
                r || i ? (r && e._loadNextPage(), i && e._loadPrevPage()) : e._lastScrollY !== n && Math.abs(e._lastScrollY - n) > p.FLOATING_BUTTON_THRESHOLD && (e._lastScrollY > n ? e._showNextButton() : e._lastScrollY < n && e._showPrevButton()), e._lastScrollY !== n ? (e._isScrolling = !0, e._lastScrollY = n, e._updateScrollBar()) : e._isScrolling = !1
            }), this._timer = setTimeout(function() {
                e._updateScrollPos()
            }, 200)
        },
        _syncNodePosY: function(e) {
            this._ab.mapContainer.setPosition([0, e]).process(), this._ab.mapForceContainer.setPosition([0, e]).process()
        },
        isClickBackAllowed: function() {
            return this._viewDidLoad ? this._btns ? this._loadingIconShown || this._loadingAllShown ? !1 : this._togglingForceAndNormal || this._movingScene ? !1 : this._waitingModalClose ? !1 : !0 : !1 : !1
        },
        dispose: function() {
            FF.logger.debug("dispose ProgressMapViewController"), this._hideNextTimer !== void 0 && clearTimeout(this._hideNextTimer), this._hidePrevTimer !== void 0 && clearTimeout(this._hidePrevTimer), e.each(this._ab.dungeons, function(e) {
                e.deleteNode().process()
            }), e.each(this._ab.routes, function(e) {
                e.deleteNode().process()
            }), e.each(this._ab.dungeonEffects, function(e) {
                e.deleteNode().process()
            }), e.each(this._dungeonButtons, function(e) {
                e.dispose()
            }), e.each(this._btns, function(e) {
                e.dispose()
            }), this._assetsManager && this._assetsManager.destroyAllLayer(), this._btns = void 0, this._ab.dungeons = void 0, this._ab.routes = void 0, this._ab = void 0, this._dungeonButtons = void 0, this._assetsManager = void 0, this._progressMap = void 0, this._forceProgressMap = void 0, this._userData = void 0, this._assets = void 0, this._routeInfo = void 0, clearTimeout(this._timer), this._updateButtonLocks(), kickmotor.nativefn.call("showNativeInfo", {
                isShow: !1
            })
        }
    }, {
        EVENTS: d
    })
}), define("scenes/progress_map/views/Layout", ["lib/LayoutBase", "scenes/common/helper/DungeonInfo", "templates/progress_map/Layout", "scenes/progress_map/ProgressMapViewController", "scenes/common/views/ModalDungeonInfo", "scenes/common/views/ModalInBattleAlert"], function(e, t, n, r, i, s) {
    return e.extend({
        contentType: "WORLD",
        designType: "MODERN",
        initialize: function(t) {
            e.prototype.initialize.call(this), this.arg = t, this.listenTo(FF.eventNotifier, "modal:openNotify", this.onModalOpen.bind(this)), this.listenTo(FF.eventNotifier, "modal:closeNotify", this.onModalClose.bind(this))
        },
        loadABViewDeferred: function() {
            var e = this;
            return this.viewController = new r(this.arg), this.listenTo(this.viewController, r.EVENTS.BTN_BACK_CLICKED, this.onBackBtnClick.bind(this)), this.listenTo(this.viewController, r.EVENTS.BTN_WORLD_BACK, this.onWorldBack.bind(this)), this.listenTo(this.viewController, r.EVENTS.BTN_DUNGEON_SELECT, this.onDungeonSelect.bind(this)), this.listenTo(this.viewController, r.EVENTS.BTN_DUNGEON_DETAIL, this.onDungeonDetail.bind(this)), this.viewController.loadAssetsDeferred()
        },
        onBackBtnClick: function() {
            Backbone.history.navigate("#home", {
                trigger: !0
            })
        },
        onWorldBack: function() {
            Backbone.history.navigate("#world", {
                trigger: !0
            })
        },
        onDungeonChallenge: function(e) {
            this._dungeonChallenging = !0, t.challengeDungeon(e)
        },
        onDungeonDetail: function(e) {
            FF.logger.warn(e);
            var n = this;
            this.viewController.hide(), t.openDeferred(e.dungeonId, {
                selectedType: i.SELECTED_TYPE_OF.PROLOGUE,
                enableChallengeButton: !0,
                onChallenge: this.onDungeonChallenge.bind(this)
            })
        },
        onDungeonSelect: function(e) {
            FF.logger.debug(e);
            var t = this;
            this._confirmQuitDungeonDeferred().then(function() {
                t.viewController.openDungeonModal(e)
            }, function() {
                t.viewController.cancelDungeonSelect()
            })
        },
        _confirmQuitDungeonDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.dungeonSessionModel;
            return t.isInDungeon() ? (FF.modalStack.push(s, {
                initializer: function(e) {
                    return new e({})
                },
                renderer: function(e) {
                    return e.render()
                },
                onPop: function(t, n) {
                    n ? e.resolve() : e.reject()
                }
            }), e.promise()) : e.resolve().promise()
        },
        render: function() {
            e.prototype.render.call(this, n), this._disableWorldListNavigation(), this._disableGlobalNavigation()
        },
        _disableWorldListNavigation: function() {
            $("#worldCurrentBtn").removeClass("is-current")
        },
        _enableWorldListNavigation: function() {
            $("#worldCurrentBtn").addClass("is-current")
        },
        _disableGlobalNavigation: function() {
            $("[data-app-globalnavi]").addClass("is-disable"), FF.router.globalcontrol.offAnchorsEventInGlobalNavigation()
        },
        _enableGlobalNavigation: function() {
            $("[data-app-globalnavi]").removeClass("is-disable"), FF.router.globalcontrol.onAnchorsEventInGlobalNavigation()
        },
        _hideProgressAB: function() {
            this.viewController && this.viewController.hide()
        },
        _showProgressAB: function() {
            this.viewController && this.viewController.show()
        },
        onClickBack: function() {
            if (!this.viewController || !this.viewController.isClickBackAllowed()) return;
            FF.SoundMgr.playChooseEffect(), FF.router.loading.lock(), Backbone.history.navigate("#home", {
                trigger: !0
            })
        },
        onModalOpen: function(e) {
            FF.logger.debug("recieved modal:openNotify", e), this._hideProgressAB()
        },
        onModalClose: function(e) {
            FF.logger.debug("recieved modal:closeNotify || modal:onClickRetry", e);
            if (this._dungeonChallenging) return;
            this._showProgressAB()
        },
        dispose: function() {
            e.prototype.dispose.call(this), this.viewController && this.viewController.dispose(), this.viewController = null, this._enableWorldListNavigation(), this._enableGlobalNavigation()
        }
    })
}), define("scenes/progress_map/ProgressMapScene", ["underscore", "jquery", "backbone", "./Api", "lib/Scene", "./LatestProgressData", "./views/Layout", "scenes/battle_list/views/BattleListViewController"], function(e, t, n, r, i, s, o, u) {
    var a = {
        LEVEL_RANGE_WIDTH_BEFORE: 10,
        LEVEL_RANGE_WIDTH_AFTER: 30
    };
    return i.extend({
        setupDeferred: function() {
            var e = this,
                n = t.Deferred();
            return s.getDungeonDataDeferred().then(function(t) {
                var i = 0,
                    s = a.LEVEL_RANGE_WIDTH_AFTER;
                t && (t.level && (i = t.level - a.LEVEL_RANGE_WIDTH_BEFORE, s = t.level + a.LEVEL_RANGE_WIDTH_AFTER, i < 0 && (i = 0, s = a.LEVEL_RANGE_WIDTH_AFTER)), e._latestProgressData = t), r.getProgressMapBySegmentDeferred(i, s, {
                    need_default_assets: 1
                }).done(function(e) {
                    n.resolve(e)
                })
            }), n.promise()
        },
        start: function() {
            u.getInstance().disposeView();
            var e = this;
            this._latestProgressData = {}, s.saveCanReturnDeferred(!0).then(function() {
                return e.setupDeferred()
            }).done(function(t) {
                e.playBgm(), e.layoutView = new o({
                    data: t,
                    latest: e._latestProgressData
                }), e.layoutView.render(), e.layoutView.loadABViewDeferred().then(function() {
                    FF.router.loading.hide()
                })
            })
        },
        playBgm: function() {
            var e = FF.datastore.limitedTimeServiceCollection.getWorldListBgm();
            e ? FF.SoundMgr.playMusic(e) : FF.SoundMgr.playDefaultBgm()
        }
    })
}), define("routers/App", ["underscore", "backbone", "sprintf", "util", "components/GlobalControl", "components/Loading", "components/Toast", "components/Overlay", "lib/Battle", "lib/Ticker", "lib/ModalStack", "lib/PartialTemplate", "lib/RemoteLogger", "lib/ab/kickmotor/LayerFactory", "scenes/common/ab/Ripple", "scenes/common/ab/consts/ABLayerDepths", "scenes/common/util/Api", "scenes/common/views/Header", "scenes/common/Datastore", "scenes/common/Constant", "scenes/common/Config", "scenes/common/GoogleAnalytics", "scenes/common/util/ErrorHandler", "scenes/common/helper/MobageLogin", "scenes/common/helper/TermCheck", "scenes/common/helper/DailyLogin", "scenes/common/helper/ExternalUserAuth", "scenes/common/helper/RootData", "scenes/common/helper/Resonator", "scenes/common/helper/LeadToSecondDungeon", "scenes/common/helper/FirstAnniversaryTutorial", "scenes/common/helper/TenMillionDownloadTutorial", "scenes/common/helper/MissionHelper", "scenes/common/views/ModalBattleResume", "scenes/title/TitleScene", "scenes/home/HomeScene", "scenes/world_list/WorldListScene", "scenes/global_menu/GlobalMenuScene", "scenes/serial_code/SerialCodeScene", "scenes/friend/FriendScene", "scenes/event_list/EventListScene", "scenes/event_intro/EventIntroScene", "scenes/battle_fail/BattleFailScene", "scenes/battle_list/BattleListScene", "scenes/battle_epilogue/BattleEpilogueScene", "scenes/gacha/GachaScene", "scenes/friend_invite/FriendInviteScene", "scenes/profile/ProfileScene", "scenes/relation/RelationScene", "scenes/gift_box/GiftBoxScene", "scenes/login_bonus/LoginBonusScene", "scenes/fellow_bonus/FellowBonusScene", "scenes/serial_campaign/SerialCampaignScene", "scenes/serial_outside/SerialOutsideScene", "scenes/external_collabo/ExternalCollabo", "scenes/watchward_campaign/WatchwardCampaignScene", "scenes/sq_portal_campaign/SqPortalCampaignScene", "scenes/sq_portal_campaign_log/SqPortalCampaignLogScene", "scenes/emsaga_campaign/EmsagaCampaignScene", "scenes/emsaga_campaign_log/EmsagaCampaignLogScene", "scenes/information/InformationScene", "scenes/notification/NotificationScene", "scenes/help/HelpScene", "scenes/beginnersHelp/BeginnersHelpScene", "scenes/config/ConfigScene", "scenes/html/HtmlScene", "scenes/download/DownloadScene", "scenes/update_nickname/UpdateNicknameScene", "scenes/configure_profile_message/ConfigureProfileMessageScene", "scenes/tutorial/battle_operations/BattleOperationsScene", "scenes/func_tutorial/FuncTutorialScene", "scenes/logout/MobageLogoutScene", "scenes/logout/MobageLogoutConfirmScene", "scenes/dungeon/DungeonWarpViewController", "scenes/copyright/CopyrightScene", "scenes/staff_roll/StaffRollScene", "scenes/character_profile/CharacterProfileScene", "ww/scenes/common/util/BackKeyHandler", "ww/scenes/real_incentive_mission/RealIncentiveMissionScene", "ww/scenes/migration_info/MigrationInfoScene", "scenes/migration_info/MigrationInfoScene", "scenes/quest/QuestScene", "scenes/mission/MissionScene", "scenes/movie_replay/menu/MovieReplayMenuScene", "scenes/movie_replay/player/MovieReplayScene", "scenes/member_upgrade_bonus/MemberUpgradeBonusScene", "scenes/movie_play/MoviePlayScene", "scenes/music_room/MusicRoomScene", "scenes/exchange_shop/ExchangeShopScene", "scenes/ritual_room/RitualRoomScene", "scenes/application_campaign/ApplicationCampaignScene", "scenes/party/PartyScene", "scenes/dungeon/DungeonScene", "scenes/operation/OperationScene", "scenes/achievement_room/AchievementRoomScene", "scenes/progress_map/ProgressMapScene"], function(e, t, n, r, i, s, o, u, a, f, l, c, h, p, d, v, m, g, y, b, w, E, S, x, T, N, C, k, L, A, O, M, _, D, P, H, B, j, F, I, q, R, U, z, W, X, V, J, K, Q, G, Y, Z, ba, bb, bc, bd, be, bf, bg, bh, bi, bj, bk, bl, bm, bn, bo, bp, bq, br, bs, bu, bv, bw, bx, by, bz, bA, bB, bC, bD, bE, bF, bG, bH, bI, bJ, bK, bL, bM, bN, bO, bP, bQ, bR) {
    return t.Router.extend({
        initialize: function() {
            this.currentScene = void 0, this.initData = void 0, this._flash = {}, this.setupErrorHandler(), this.setupInitData(), this.setupDatastore(), this.generateComponents(), this.setupOnBackKey(), this.setupOnApplicationForeground(), this.setupModalStack(), this.setupPartialTemplate(), this.setupResonator(), this.setupMissionHelper()
        },
        routes: {
            title: "createTitleScene",
            notification: "createNotificationScene",
            global_menu: "createGlobalMenuScene",
            serial_code: "createSerialCodeScene",
            friend: "createFriendScene",
            home: "createHomeScene",
            "world(/:world_id)": "createWorldListScene",
            "world/:world_id/dungeon/:page(/*args)": "createDungeonScene",
            "world/battles/:dungeon_id": "createBattleListScene",
            "world/battles/:dungeon_id/clear": "createBattleEpilogueScene",
            events: "createEventListScene",
            "event/:event_id/intro": "createEventIntroScene",
            "battle/fail/:dungeon_id/:kind/(:tip_id)": "createBattleFailScene",
            "operation/:page(/*args)": "createOperationScene",
            "party(/:page)(/*args)": "createPartyScene",
            "gacha(/:page)(/*args)": "createGachaScene",
            gift_box: "createGiftBoxScene",
            login_bonus: "createLoginBonusScene",
            fellow_bonus: "createFellowBonusScene",
            "member_upgrade_bonus(/:type)": "createMemberUpgradeBonusScene",
            "serial_campaign(/:id)": "createSerialCampaignScene",
            "serial_outside/:id": "createSerialOutsideScene",
            "external_collabo/:id": "createExternalCollaboScene",
            "watchward_campaign/:id": "createWatchwardCampaignScene",
            sq_portal_campaign: "createSqPortalCampaignScene",
            sq_portal_campaign_log: "createSqPortalCampaignLogScene",
            emsaga_campaign: "createEmsagaCampaignScene",
            emsaga_campaign_log: "createEmsagaCampaignLogScene",
            information: "createInformationScene",
            "help/:type(/*args)": "createHelpScene",
            "beginners_help(/*args)": "createBeginnersHelpScene",
            config: "createConfigScene",
            "html(/*path)": "createHtmlScene",
            "friend_invite(/:page)": "createFriendInviteScene",
            "profile(/:page)(/*args)": "createProfileScene",
            "relation(/:page)": "createRelationScene",
            update_nickname: "updateNicknameScene",
            configure_profile_message: "ConfigureProfileMessageScene",
            download: "createDownloadScene",
            "tutorial/operations": "createTutorialBattleOperationsScene",
            "func_tutorial(/:page)(/*args)": "createFuncTutorialScene",
            mobage_logout: "createMobageLogoutScene",
            mobage_logout_confirm: "createMobageLogoutConfirmScene",
            copyright: "createCopyrightScene",
            staff_roll: "createStaffRollScene",
            migration_info: "createMigrationInfoScene",
            "quest(/:page)(/*args)": "createQuestScene",
            "mission(/:page)(/*args)": "createMissionScene",
            "real_incentive_mission(/:page)(/*args)": "createRealIncentiveMissionScene",
            "movie_replay(/:movieType)": "createMovieReplayMenuScene",
            "movie_replay_detail(/:movieIndex)": "createMovieReplayDetail",
            "music_room/:type/:id(/:content_id)": "createMusicRoomScene",
            "achievement_room(/:page)(/*args)": "createAchievementRoomScene",
            progress_map: "createProgressMapScene",
            "exchange_shop/:id": "createExchangeShopScene",
            "ritual_room/:page": "createRitualRoomScene",
            "application_campaign/:id": "createApplicationCampaignScene",
            "*hash": "goResumedScene"
        },
        skipFilterRouteRegex: /^#(title|download|notification|login_bonus|update_nickname|configure_profile_message|member_upgrade_bonus|tutorial.*)$/,
        filterBeforeChangeSceneDeferred: function() {
            return this.rotateFlashData(), E.sendScreenNameIfNeed(), this.skipFilterRouteRegex.test(location.hash) ? $.Deferred().resolve().promise() : (this._updateRippleForSceneChange(), N.showModalIfNeedDeferred().then(T.showModalIfClosedDeferred))
        },
        changeScene: function(e, t) {
            t = t || [];
            var n = this;
            FF.eventNotifier.trigger("app:changeScene"), FF.router.loading.showDeferred().done(function() {
                t = t || [], n.filterBeforeChangeSceneDeferred().done(function() {
                    n.loading.lock(), n.disposeCurrentScene(), n.currentScene = new e, n.currentScene.start.apply(n.currentScene, t), n._updateRippleByScene(n.currentScene)
                })
            })
        },
        changeSceneByPages: function(t, n, r) {
            var i = this;
            FF.eventNotifier.trigger("app:changeSceneByPages"), FF.router.loading.showDeferred().done(function() {
                r && e.isFunction(r.toString) && (r = r.toString().split("/"));
                if (!i.isSameScene(t)) return i.changeScene(t, [n, r]);
                i.filterBeforeChangeSceneDeferred().done(function() {
                    i.loading.lock(), i.currentScene.showPage(n, r)
                })
            })
        },
        disposeCurrentScene: function() {
            this.currentScene && (this.currentScene.dispose(), this.currentScene = null), FF.modalStack && FF.modalStack.dispose(), p.getInstance().dump()
        },
        isSameScene: function(e) {
            return this.currentScene ? e.prototype === Object.getPrototypeOf(this.currentScene) : !1
        },
        navigate: function(e, n) {
            return n.params && this.flash(n.params), t.history.navigate(e, n), this
        },
        flash: function(t) {
            return t && (this._flash.current = e.extend(this._flash.current, t)), e.extend({}, this._flash.prev, this._flash.current)
        },
        rotateFlashData: function() {
            this._flash.prev = this._flash.current, this._flash.current = {}
        },
        createTitleScene: function() {
            return this.changeScene(P)
        },
        createHomeScene: function() {
            return this.changeScene(H)
        },
        createWorldListScene: function(e) {
            return this.changeScene(B, [e])
        },
        createGlobalMenuScene: function() {
            return this.changeScene(j)
        },
        createSerialCodeScene: function() {
            return this.changeScene(F)
        },
        createFriendScene: function() {
            return this.changeScene(I)
        },
        createDungeonScene: function(e, t, n) {
            var r = [e, n].join("/");
            return this.changeSceneByPages(bO, t, r)
        },
        createEventListScene: function() {
            return this.changeScene(q)
        },
        createEventIntroScene: function(e) {
            return this.changeScene(R, [e])
        },
        createBattleListScene: function(e) {
            return this.changeScene(z, [e])
        },
        createOperationScene: function(e, t) {
            return this.changeSceneByPages(bP, e, t)
        },
        createBattleEpilogueScene: function(e) {
            return this.changeScene(W, [e])
        },
        createBattleFailScene: function(e, t, n) {
            return this.changeScene(U, [e, t, n])
        },
        createPartyScene: function(e, t) {
            return this.changeSceneByPages(bN, e, t)
        },
        createGachaScene: function(t, n) {
            n && e.isFunction(n.toString) && (n = n.toString().split("/"));
            if (!this.isSameScene(X)) return this.changeScene(X, [t, n]);
            this.filterBeforeChangeSceneDeferred().done(function() {
                this.currentScene.start(t, n)
            }.bind(this))
        },
        createGiftBoxScene: function() {
            return this.changeScene(Q)
        },
        createLoginBonusScene: function() {
            return this.changeScene(G)
        },
        createFellowBonusScene: function() {
            return this.changeScene(Y)
        },
        createMemberUpgradeBonusScene: function(e) {
            return this.changeScene(bH, [e])
        },
        createHelpScene: function() {
            return this.changeScene(bj, arguments)
        },
        createBeginnersHelpScene: function() {
            return this.changeScene(bk, arguments)
        },
        createSerialCampaignScene: function(e) {
            return this.changeScene(Z, [e])
        },
        createSerialOutsideScene: function(e) {
            return this.changeScene(ba, [e])
        },
        createExternalCollaboScene: function(e) {
            return this.changeScene(bb, [e])
        },
        createWatchwardCampaignScene: function(e) {
            return this.changeScene(bc, [e])
        },
        createSqPortalCampaignScene: function() {
            return this.changeScene(bd)
        },
        createSqPortalCampaignLogScene: function() {
            return this.changeScene(be)
        },
        createEmsagaCampaignScene: function() {
            return this.changeScene(bf)
        },
        createEmsagaCampaignLogScene: function() {
            return this.changeScene(bg)
        },
        createInformationScene: function(e) {
            return this.changeScene(bh)
        },
        createConfigScene: function() {
            return this.changeScene(bl)
        },
        createCopyrightScene: function() {
            return this.changeScene(bw)
        },
        createStaffRollScene: function() {
            return this.changeScene(bx)
        },
        createMigrationInfoScene: function() {
            return FF.env.isWWRegion() ? this.changeScene(bB) : this.changeScene(bC)
        },
        createHtmlScene: function(e) {
            return this.changeScene(bm, [e])
        },
        createFriendInviteScene: function(e) {
            return this.changeSceneByPages(V, e)
        },
        createProfileScene: function(e, t) {
            return this.changeSceneByPages(J, e, t)
        },
        createRelationScene: function(e) {
            if (!this.isSameScene(K)) return this.changeScene(K, [e]);
            this.filterBeforeChangeSceneDeferred().done(function() {
                this.currentScene.showPage(e)
            }.bind(this))
        },
        createNotificationScene: function() {
            return this.changeScene(bi)
        },
        createDownloadScene: function() {
            return this.changeScene(bn)
        },
        updateNicknameScene: function() {
            return this.changeScene(bo)
        },
        ConfigureProfileMessageScene: function() {
            return this.changeScene(bp)
        },
        createTutorialBattleOperationsScene: function() {
            return this.changeScene(bq)
        },
        createFuncTutorialScene: function(e) {
            return this.changeSceneByPages(br, e)
        },
        createMobageLogoutScene: function() {
            return this.changeScene(bs)
        },
        createMobageLogoutConfirmScene: function() {
            return this.changeScene(bu)
        },
        createCharacterProfileScene: function(e) {
            return this.changeScene(by, [e])
        },
        createQuestScene: function(e, t) {
            return this.changeSceneByPages(bD, e, t)
        },
        createMissionScene: function(e, t) {
            return this.changeSceneByPages(bE, e, t)
        },
        createRealIncentiveMissionScene: function(e, t) {
            return this.changeSceneByPages(bA, e, t)
        },
        createMovieReplayMenuScene: function(e) {
            return this.changeScene(bF, [e])
        },
        createMovieReplayDetail: function(e) {
            return this.changeScene(bG, [e])
        },
        createMusicRoomScene: function(e, t, n) {
            return this.changeScene(bJ, [e, t, n])
        },
        createAchievementRoomScene: function(e, t) {
            return this.changeSceneByPages(bQ, e, t)
        },
        createProgressMapScene: function() {
            return this.changeScene(bR)
        },
        createExchangeShopScene: function(e) {
            return this.changeScene(bK, [e])
        },
        createRitualRoomScene: function(e) {
            return this.changeScene(bL, [e])
        },
        createApplicationCampaignScene: function(e) {
            return this.changeScene(bM, [e])
        },
        setupErrorHandler: function() {
            this.errorHandler = new S, this.errorHandler.setup(), f.reset()
        },
        setupInitData: function() {
            var e = $("[data-app-init-data]").html();
            this.initData = JSON.parse(e), FF.CONST = {
                SERVER: this.initData.constants,
                CLIENT: b
            }, FF.Config = {
                server: r.camelizeDeep(this.initData.config),
                client: w
            }
        },
        setupDatastore: function() {
            var e = this.initData,
                t = FF.datastore = new y;
            t.userModel.set(e.user), t.partyModel.update(e.party), t.abilityCollection.add(e.ability), t.equipmentCollection.add(e.equipment), t.recordMateriaCollection.add(e.record_materia), t.soulStrikeCollection.add(e.soul_strike), t.buddyCollection.add(e.buddy), t.itemPossessionLimitCollection.add(e.item_possesion_limits), t.notificationCollection.add(e.notification), t.tipDownloadCollection.add(e.tip_downloads), t.worldCollection.add(e.worlds), t.eventCollection.add(e.events), t.bannerCollection.add(e.banners), t.limitedTimeServiceCollection.add(e.limited_time_services), t.xpromoCustomEventCollection.add(e.xpromo_custom_events), t.missionCollection.add(e.missions), t.movieReplayCollection.add(e.movie_replay_list), t.equipmentCategoryCollection.add(e.equipment_categories), t.abilityCategoryCollection.add(e.ability_categories), t.abilityCollection.initializeInUseBy(), t.equipmentCollection.initializeInUseBy(), t.recordMateriaCollection.initializeInUseBy(), t.abilityDisplayCategoryModel.set(e.ability_display_category_tree), e.dungeon_session && (t.partyStatusModel.set(e.dungeon_session.party_status), t.dungeonSessionModel.set(e.dungeon_session), t.currentDungeonModel.set(e.user_dungeon)), t.fellowSessionModel.set(e.fellow_session), t.stash = {
                giftBoxNum: e.gift_box_num || 0,
                newRelationNum: e.new_relation_num || 0,
                hasNewMission: e.has_new_mission || !1,
                achievedMissions: e.achieved_missions || null,
                canReceiveLoginBonus: e.can_receive_login_bonus || !1,
                canReceiveFellowBonus: e.can_receive_fellow_bonus || !1,
                canReceiveMemberUpgradeBonus: e.can_receive_member_upgrade_bonus || !1,
                canReceiveInviterPrize: e.can_receive_inviter_prize || !1,
                assetsRequiredOnLaunch: this.initData.assets,
                paymentFallback: e.payment_fallback,
                isRestrictedUser: e.is_restricted_user || !1,
                leadToSecondDungeonInfo: e.lead_to_second_dungeon_info,
                requireShowSeriesTutorial: e.require_show_series_tutorial || !1,
                beginBattleToken: e.begin_battle_token,
                gotUnixTimeOfRootData: e.current_time,
                canReceiveExternalCollaboPrize: e.can_receive_external_collabo_prize || !1,
                homeAssets: e.home_assets,
                hasShownFirstTimeEventIntroPage: {},
                hasPlayedEventIntroMovie: {},
                user_grade: e.user_grade,
                releaseIdToReleasedAt: e.release_id_to_released_at,
                releaseKeyToReleasedAt: e.release_key_to_released_at,
                commonABAssets: e.common_ab_assets
            }, t.updatePartyAssets(e), FF.logger.debug("setupDatastore", t, e)
        },
        generateComponents: function() {
            this.dungeonWarpViewController = new bv, this.globalcontrol = new i({
                el: $("#container")
            }), this.header = new g({
                el: $("#fixed-top-status"),
                userModel: FF.datastore.userModel,
                partyModel: FF.datastore.partyModel
            }), this.header.listenTo(this, "onApplicationForeground", this.header.forceUpdate.bind(this.header)), this.overlay = new u({
                el: $(".overlay")
            }), this.loading = new s({
                el: $(".loading")
            }), this.overlay.registerChildren(this.loading), this.loading.hide(), window.loading = this.loading;
            var e = $("body").get(0);
            e.addEventListener("touchstart", function(e) {
                FF.eventNotifier.trigger("app:onTapScreen", e)
            }, !0), this._ripple = new d, this._ripple.setEnabled(!1), d.canShowRippleByUserDevice() && this._ripple.prepareDeferred(FF.datastore.stash.commonABAssets.ripple, !0), this.toast = new o({
                el: $("[data-toast-template]"),
                parent: $("#container")
            })
        },
        _updateRippleForSceneChange: function() {},
        _updateRippleByScene: function(e) {
            e && e.needsRipple ? (this._ripple.setEnabled(!0), this._ripple.setZOrder(v.RIPPLE_ENABLED)) : (this._ripple.setEnabled(!1), this._ripple.setZOrder(v.RIPPLE_DISABLED))
        },
        getCurrentScene: function() {
            return this.currentScene
        },
        goBootstrapNextScene: function() {
            if (M.canProceed()) return M.navigate();
            if (O.canProceed()) return O.navigate();
            if (FF.datastore.stash.canReceiveLoginBonus) return t.history.navigate("#login_bonus", {
                trigger: !0
            });
            if (A.isLeadToSecondDungeon()) return A.goDungeonListScene();
            if (FF.datastore.stash.canReceiveFellowBonus) return t.history.navigate("#fellow_bonus", {
                trigger: !0
            });
            if (FF.datastore.notificationCollection.uncheckedNum()) return t.history.navigate("#notification", {
                trigger: !0
            });
            if (FF.datastore.stash.canReceiveMemberUpgradeBonus) return t.history.navigate("#member_upgrade_bonus", {
                trigger: !0
            });
            this.goResumedScene()
        },
        goResumedScene: function() {
            var e = FF.datastore.dungeonSessionModel;
            if (!e.isInDungeon()) return t.history.navigate("#home", {
                trigger: !0
            });
            k.updateRootDataIfNeedDeferred().then(function() {
                return T.showModalIfClosedDeferred()
            }).done(function() {
                if (!e.isInBattle()) return t.history.navigate("#home", {
                    trigger: !0
                });
                a.checkSessionAndUpdateDeferred(e.get("session_key")).then(function() {
                    var e = new D;
                    FF.router.overlay.registerChildren(e), e.render(), e.open()
                }, function() {
                    t.history.navigate("#home", {
                        trigger: !0
                    })
                })
            })
        },
        setupOnBackKey: function() {
            var n = this;
            FF.env.isUsingWWBackKeyHandler() ? (kickmotor.nativefn.onBackKeyHandler = e.extend({
                hasModal: !1
            }, t.Events), kickmotor.nativefn.onBackKey = function() {
                kickmotor.nativefn.onBackKeyHandler.trigger("System::onBackKey"), bz.onBackKey()
            }) : kickmotor.nativefn.onBackKey = function() {
                var e = $("[data-app-btn-back]").hasClass("is-disable"),
                    t = $("body").css("pointer-events") === "none";
                if (e || t) return;
                var r = $("#overlay").hasClass("hide");
                r ? n._onBackKeyPressOutsideModal() : n._onBackKeyPressInsideModal()
            }
        },
        _onBackKeyPressOutsideModal: function() {
            $("[data-app-btn-back]").trigger("anchorsbeforejump")
        },
        _onBackKeyPressInsideModal: function() {
            var t = ["[data-app-modal-back]", "[data-app-modal-cancel]", "[data-app-modal-close]", "[data-app-decide-negative]"],
                n = e.find(t, function(e) {
                    return $(e).length > 0
                });
            if (!n) return;
            var r = $(n).attr("data-app-enable-back-key");
            if (!r) return;
            $(n).trigger("anchorsbeforejump")
        },
        setupOnApplicationForeground: function() {
            kickmotor.nativefn.onApplicationForeground = function() {
                kickmotor.nativefn.webViewInfo(function(e) {
                    e.callState && window.location.reload()
                }), this.trigger("onApplicationForeground"), x.showModalIfNeedDeferred().then(C.checkExternalUserAuthCallDeferred.bind(C)).then(N.showModalIfNeedDeferred).then(T.TermCheckHelper), kickmotor.nativefn.getRemoteNotificationLog(function(e) {
                    if (!e) return;
                    h.pushRemoteNotificationInfomation(e).logRemoteNotificationIfNeedDeferred()
                })
            }.bind(this)
        },
        setupModalStack: function() {
            FF.modalStack = new l
        },
        setupPartialTemplate: function() {
            FF.partialTemplate = new c, FF.partialTemplate.load(FF.Config.client.partialTemplate.paths)
        },
        setupResonator: function() {
            FF.resonator = new L
        },
        setupMissionHelper: function() {
            var e = FF.datastore.stash.achievedMissions;
            !!e && e.length > 0 ? (FF.datastore.stash.achievedMissions = null, _.saveAchievedMissionsDeferred(e)) : _.loadDataDeferred()
        }
    })
}), define("scenes/common/helper/ExtremeTutorial", [], function() {
    return {
        navigateIfNeedDeferred: function() {
            var e = $.Deferred(),
                t = FF.datastore.userModel,
                n = t.hasProceededFuncTutorial("EXTREME_MOVIE"),
                r = t.hasProceededFuncTutorial("EXTREME"),
                i = FF.datastore.stash.hasShownExtremeFuncTutorial,
                s = FF.datastore.stash.hasShownExtremeEventIntro;
            if (!n) Backbone.history.navigate("func_tutorial/extreme_movie", {
                trigger: !0
            });
            else if (!r) FF.datastore.stash.hasShownExtremeFuncTutorial = !0, Backbone.history.navigate("func_tutorial/extreme", {
                trigger: !0
            });
            else {
                if (!i || !!s) return e.resolve().promise();
                FF.datastore.stash.hasShownExtremeEventIntro = !0;
                var o = "#event/extreme/intro";
                Backbone.history.navigate(o, {
                    trigger: !0
                })
            }
            return e.reject().promise()
        }
    }
}), define("scenes/common/SalvageRequireForUnify", ["scenes/common/helper/ExtremeTutorial", "scenes/common/helper/MovieHelper"], function(e, t) {
    return {}
}), require(["namespace"], function() {
    require(["jquery", "underscore", "backbone", "kickmotor", "lib/SoundMgr", "lib/TextMaster", "lib/Storage", "lib/EventNotifier", "routers/App", "scenes/common/util/Api", "scenes/common/SalvageRequireForUnify"], function(e, t, n, r, i, s, o, u, a, f, l) {
        e(function() {
            e.nativefn = r.nativefn, r.animation.setAnimationInterval(1 / FF.env.framesPerSecond), r.view.showGameView(), r.animation.showNativeInfo(!1), FF.SoundMgr = new i, FF.SoundMgr.stopEffect(), FF.router = new a, FF.TextMaster = s.getInstance(), FF._recompileVer = 2, o.init(), FF.eventNotifier = new u, f.updateUserSessionKeyDeferred().done(function() {
                FF.onload()
            })
        })
    })
}), define("app", function() {});